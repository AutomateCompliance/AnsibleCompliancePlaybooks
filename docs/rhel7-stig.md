Guide to the Secure Configuration of Red Hat Enterprise Linux 7 | OpenSCAP Security Guide  /\*! \* Bootstrap v3.3.7 (http://getbootstrap.com) \* Copyright 2011-2016 Twitter, Inc. \* Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE) \*/ /\*! \* Generated using the Bootstrap Customizer (https://getbootstrap.com/customize/?id=8160adef040364fa8f688f6065765caf) \* Config saved to config.json and https://gist.github.com/8160adef040364fa8f688f6065765caf \*//\*! \* Bootstrap v3.3.7 (http://getbootstrap.com) \* Copyright 2011-2016 Twitter, Inc. \* Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE) \*//\*! normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css \*/html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not(\[controls\]){display:none;height:0}\[hidden\],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr\[title\]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{font-size:2em;margin:0.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input\[type="button"\],input\[type="reset"\],input\[type="submit"\]{-webkit-appearance:button;cursor:pointer}button\[disabled\],html input\[disabled\]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input\[type="checkbox"\],input\[type="radio"\]{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:0}input\[type="number"\]::-webkit-inner-spin-button,input\[type="number"\]::-webkit-outer-spin-button{height:auto}input\[type="search"\]{-webkit-appearance:textfield;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}input\[type="search"\]::-webkit-search-cancel-button,input\[type="search"\]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid #c0c0c0;margin:0 2px;padding:0.35em 0.625em 0.75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}/\*! Source: https://github.com/h5bp/html5-boilerplate/blob/master/src/css/main.css \*/@media print{\*,\*:before,\*:after{background:transparent !important;color:#000 !important;-webkit-box-shadow:none !important;box-shadow:none !important;text-shadow:none !important}a,a:visited{text-decoration:underline}a\[href\]:after{content:" (" attr(href) ")"}abbr\[title\]:after{content:" (" attr(title) ")"}a\[href^="#"\]:after,a\[href^="javascript:"\]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}p,h2,h3{orphans:3;widows:3}h2,h3{page-break-after:avoid}.navbar{display:none}.btn>.caret,.dropup>.btn>.caret{border-top-color:#000 !important}.label{border:1px solid #000}.table{border-collapse:collapse !important}.table td,.table th{background-color:#fff !important}.table-bordered th,.table-bordered td{border:1px solid #ddd !important}}\*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}\*:before,\*:after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html{font-size:10px;-webkit-tap-highlight-color:rgba(0,0,0,0)}body{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:14px;line-height:1.42857143;color:#333;background-color:#fff}input,button,select,textarea{font-family:inherit;font-size:inherit;line-height:inherit}a{color:#428bca;text-decoration:none}a:hover,a:focus{color:#2a6496;text-decoration:underline}a:focus{outline:5px auto -webkit-focus-ring-color;outline-offset:-2px}figure{margin:0}img{vertical-align:middle}.img-responsive{display:block;max-width:100%;height:auto}.img-rounded{border-radius:6px}.img-thumbnail{padding:4px;line-height:1.42857143;background-color:#fff;border:1px solid #ddd;border-radius:4px;-webkit-transition:all .2s ease-in-out;-o-transition:all .2s ease-in-out;transition:all .2s ease-in-out;display:inline-block;max-width:100%;height:auto}.img-circle{border-radius:50%}hr{margin-top:20px;margin-bottom:20px;border:0;border-top:1px solid #eee}.sr-only{position:absolute;width:1px;height:1px;margin:-1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);border:0}.sr-only-focusable:active,.sr-only-focusable:focus{position:static;width:auto;height:auto;margin:0;overflow:visible;clip:auto}\[role="button"\]{cursor:pointer}h1,h2,h3,h4,h5,h6,.h1,.h2,.h3,.h4,.h5,.h6{font-family:inherit;font-weight:500;line-height:1.1;color:inherit}h1 small,h2 small,h3 small,h4 small,h5 small,h6 small,.h1 small,.h2 small,.h3 small,.h4 small,.h5 small,.h6 small,h1 .small,h2 .small,h3 .small,h4 .small,h5 .small,h6 .small,.h1 .small,.h2 .small,.h3 .small,.h4 .small,.h5 .small,.h6 .small{font-weight:normal;line-height:1;color:#777}h1,.h1,h2,.h2,h3,.h3{margin-top:20px;margin-bottom:10px}h1 small,.h1 small,h2 small,.h2 small,h3 small,.h3 small,h1 .small,.h1 .small,h2 .small,.h2 .small,h3 .small,.h3 .small{font-size:65%}h4,.h4,h5,.h5,h6,.h6{margin-top:10px;margin-bottom:10px}h4 small,.h4 small,h5 small,.h5 small,h6 small,.h6 small,h4 .small,.h4 .small,h5 .small,.h5 .small,h6 .small,.h6 .small{font-size:75%}h1,.h1{font-size:36px}h2,.h2{font-size:30px}h3,.h3{font-size:24px}h4,.h4{font-size:18px}h5,.h5{font-size:14px}h6,.h6{font-size:12px}p{margin:0 0 10px}.lead{margin-bottom:20px;font-size:16px;font-weight:300;line-height:1.4}@media (min-width:768px){.lead{font-size:21px}}small,.small{font-size:85%}mark,.mark{background-color:#fcf8e3;padding:.2em}.text-left{text-align:left}.text-right{text-align:right}.text-center{text-align:center}.text-justify{text-align:justify}.text-nowrap{white-space:nowrap}.text-lowercase{text-transform:lowercase}.text-uppercase{text-transform:uppercase}.text-capitalize{text-transform:capitalize}.text-muted{color:#777}.text-primary{color:#428bca}a.text-primary:hover,a.text-primary:focus{color:#3071a9}.text-success{color:#3c763d}a.text-success:hover,a.text-success:focus{color:#2b542c}.text-info{color:#31708f}a.text-info:hover,a.text-info:focus{color:#245269}.text-warning{color:#8a6d3b}a.text-warning:hover,a.text-warning:focus{color:#66512c}.text-danger{color:#a94442}a.text-danger:hover,a.text-danger:focus{color:#843534}.bg-primary{color:#fff;background-color:#428bca}a.bg-primary:hover,a.bg-primary:focus{background-color:#3071a9}.bg-success{background-color:#dff0d8}a.bg-success:hover,a.bg-success:focus{background-color:#c1e2b3}.bg-info{background-color:#d9edf7}a.bg-info:hover,a.bg-info:focus{background-color:#afd9ee}.bg-warning{background-color:#fcf8e3}a.bg-warning:hover,a.bg-warning:focus{background-color:#f7ecb5}.bg-danger{background-color:#f2dede}a.bg-danger:hover,a.bg-danger:focus{background-color:#e4b9b9}.page-header{padding-bottom:9px;margin:40px 0 20px;border-bottom:1px solid #eee}ul,ol{margin-top:0;margin-bottom:10px}ul ul,ol ul,ul ol,ol ol{margin-bottom:0}.list-unstyled{padding-left:0;list-style:none}.list-inline{padding-left:0;list-style:none;margin-left:-5px}.list-inline>li{display:inline-block;padding-left:5px;padding-right:5px}dl{margin-top:0;margin-bottom:20px}dt,dd{line-height:1.42857143}dt{font-weight:bold}dd{margin-left:0}@media (min-width:768px){.dl-horizontal dt{float:left;width:160px;clear:left;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.dl-horizontal dd{margin-left:180px}}abbr\[title\],abbr\[data-original-title\]{cursor:help;border-bottom:1px dotted #777}.initialism{font-size:90%;text-transform:uppercase}blockquote{padding:10px 20px;margin:0 0 20px;font-size:17.5px;border-left:5px solid #eee}blockquote p:last-child,blockquote ul:last-child,blockquote ol:last-child{margin-bottom:0}blockquote footer,blockquote small,blockquote .small{display:block;font-size:80%;line-height:1.42857143;color:#777}blockquote footer:before,blockquote small:before,blockquote .small:before{content:'\\2014 \\00A0'}.blockquote-reverse,blockquote.pull-right{padding-right:15px;padding-left:0;border-right:5px solid #eee;border-left:0;text-align:right}.blockquote-reverse footer:before,blockquote.pull-right footer:before,.blockquote-reverse small:before,blockquote.pull-right small:before,.blockquote-reverse .small:before,blockquote.pull-right .small:before{content:''}.blockquote-reverse footer:after,blockquote.pull-right footer:after,.blockquote-reverse small:after,blockquote.pull-right small:after,.blockquote-reverse .small:after,blockquote.pull-right .small:after{content:'\\00A0 \\2014'}address{margin-bottom:20px;font-style:normal;line-height:1.42857143}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,"Courier New",monospace}code{padding:2px 4px;font-size:90%;color:#c7254e;background-color:#f9f2f4;border-radius:4px}kbd{padding:2px 4px;font-size:90%;color:#fff;background-color:#333;border-radius:3px;-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,0.25);box-shadow:inset 0 -1px 0 rgba(0,0,0,0.25)}kbd kbd{padding:0;font-size:100%;font-weight:bold;-webkit-box-shadow:none;box-shadow:none}pre{display:block;padding:9.5px;margin:0 0 10px;font-size:13px;line-height:1.42857143;word-break:break-all;word-wrap:break-word;color:#333;background-color:#f5f5f5;border:1px solid #ccc;border-radius:4px}pre code{padding:0;font-size:inherit;color:inherit;white-space:pre-wrap;background-color:transparent;border-radius:0}.pre-scrollable{max-height:340px;overflow-y:scroll}.container{margin-right:auto;margin-left:auto;padding-left:15px;padding-right:15px}@media (min-width:768px){.container{width:750px}}@media (min-width:992px){.container{width:970px}}@media (min-width:1200px){.container{width:1170px}}.container-fluid{margin-right:auto;margin-left:auto;padding-left:15px;padding-right:15px}.row{margin-left:-15px;margin-right:-15px}.col-xs-1, .col-sm-1, .col-md-1, .col-lg-1, .col-xs-2, .col-sm-2, .col-md-2, .col-lg-2, .col-xs-3, .col-sm-3, .col-md-3, .col-lg-3, .col-xs-4, .col-sm-4, .col-md-4, .col-lg-4, .col-xs-5, .col-sm-5, .col-md-5, .col-lg-5, .col-xs-6, .col-sm-6, .col-md-6, .col-lg-6, .col-xs-7, .col-sm-7, .col-md-7, .col-lg-7, .col-xs-8, .col-sm-8, .col-md-8, .col-lg-8, .col-xs-9, .col-sm-9, .col-md-9, .col-lg-9, .col-xs-10, .col-sm-10, .col-md-10, .col-lg-10, .col-xs-11, .col-sm-11, .col-md-11, .col-lg-11, .col-xs-12, .col-sm-12, .col-md-12, .col-lg-12{position:relative;min-height:1px;padding-left:15px;padding-right:15px}.col-xs-1, .col-xs-2, .col-xs-3, .col-xs-4, .col-xs-5, .col-xs-6, .col-xs-7, .col-xs-8, .col-xs-9, .col-xs-10, .col-xs-11, .col-xs-12{float:left}.col-xs-12{width:100%}.col-xs-11{width:91.66666667%}.col-xs-10{width:83.33333333%}.col-xs-9{width:75%}.col-xs-8{width:66.66666667%}.col-xs-7{width:58.33333333%}.col-xs-6{width:50%}.col-xs-5{width:41.66666667%}.col-xs-4{width:33.33333333%}.col-xs-3{width:25%}.col-xs-2{width:16.66666667%}.col-xs-1{width:8.33333333%}.col-xs-pull-12{right:100%}.col-xs-pull-11{right:91.66666667%}.col-xs-pull-10{right:83.33333333%}.col-xs-pull-9{right:75%}.col-xs-pull-8{right:66.66666667%}.col-xs-pull-7{right:58.33333333%}.col-xs-pull-6{right:50%}.col-xs-pull-5{right:41.66666667%}.col-xs-pull-4{right:33.33333333%}.col-xs-pull-3{right:25%}.col-xs-pull-2{right:16.66666667%}.col-xs-pull-1{right:8.33333333%}.col-xs-pull-0{right:auto}.col-xs-push-12{left:100%}.col-xs-push-11{left:91.66666667%}.col-xs-push-10{left:83.33333333%}.col-xs-push-9{left:75%}.col-xs-push-8{left:66.66666667%}.col-xs-push-7{left:58.33333333%}.col-xs-push-6{left:50%}.col-xs-push-5{left:41.66666667%}.col-xs-push-4{left:33.33333333%}.col-xs-push-3{left:25%}.col-xs-push-2{left:16.66666667%}.col-xs-push-1{left:8.33333333%}.col-xs-push-0{left:auto}.col-xs-offset-12{margin-left:100%}.col-xs-offset-11{margin-left:91.66666667%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-0{margin-left:0}@media (min-width:768px){.col-sm-1, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-10, .col-sm-11, .col-sm-12{float:left}.col-sm-12{width:100%}.col-sm-11{width:91.66666667%}.col-sm-10{width:83.33333333%}.col-sm-9{width:75%}.col-sm-8{width:66.66666667%}.col-sm-7{width:58.33333333%}.col-sm-6{width:50%}.col-sm-5{width:41.66666667%}.col-sm-4{width:33.33333333%}.col-sm-3{width:25%}.col-sm-2{width:16.66666667%}.col-sm-1{width:8.33333333%}.col-sm-pull-12{right:100%}.col-sm-pull-11{right:91.66666667%}.col-sm-pull-10{right:83.33333333%}.col-sm-pull-9{right:75%}.col-sm-pull-8{right:66.66666667%}.col-sm-pull-7{right:58.33333333%}.col-sm-pull-6{right:50%}.col-sm-pull-5{right:41.66666667%}.col-sm-pull-4{right:33.33333333%}.col-sm-pull-3{right:25%}.col-sm-pull-2{right:16.66666667%}.col-sm-pull-1{right:8.33333333%}.col-sm-pull-0{right:auto}.col-sm-push-12{left:100%}.col-sm-push-11{left:91.66666667%}.col-sm-push-10{left:83.33333333%}.col-sm-push-9{left:75%}.col-sm-push-8{left:66.66666667%}.col-sm-push-7{left:58.33333333%}.col-sm-push-6{left:50%}.col-sm-push-5{left:41.66666667%}.col-sm-push-4{left:33.33333333%}.col-sm-push-3{left:25%}.col-sm-push-2{left:16.66666667%}.col-sm-push-1{left:8.33333333%}.col-sm-push-0{left:auto}.col-sm-offset-12{margin-left:100%}.col-sm-offset-11{margin-left:91.66666667%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-0{margin-left:0}}@media (min-width:992px){.col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12{float:left}.col-md-12{width:100%}.col-md-11{width:91.66666667%}.col-md-10{width:83.33333333%}.col-md-9{width:75%}.col-md-8{width:66.66666667%}.col-md-7{width:58.33333333%}.col-md-6{width:50%}.col-md-5{width:41.66666667%}.col-md-4{width:33.33333333%}.col-md-3{width:25%}.col-md-2{width:16.66666667%}.col-md-1{width:8.33333333%}.col-md-pull-12{right:100%}.col-md-pull-11{right:91.66666667%}.col-md-pull-10{right:83.33333333%}.col-md-pull-9{right:75%}.col-md-pull-8{right:66.66666667%}.col-md-pull-7{right:58.33333333%}.col-md-pull-6{right:50%}.col-md-pull-5{right:41.66666667%}.col-md-pull-4{right:33.33333333%}.col-md-pull-3{right:25%}.col-md-pull-2{right:16.66666667%}.col-md-pull-1{right:8.33333333%}.col-md-pull-0{right:auto}.col-md-push-12{left:100%}.col-md-push-11{left:91.66666667%}.col-md-push-10{left:83.33333333%}.col-md-push-9{left:75%}.col-md-push-8{left:66.66666667%}.col-md-push-7{left:58.33333333%}.col-md-push-6{left:50%}.col-md-push-5{left:41.66666667%}.col-md-push-4{left:33.33333333%}.col-md-push-3{left:25%}.col-md-push-2{left:16.66666667%}.col-md-push-1{left:8.33333333%}.col-md-push-0{left:auto}.col-md-offset-12{margin-left:100%}.col-md-offset-11{margin-left:91.66666667%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-9{margin-left:75%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-6{margin-left:50%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-3{margin-left:25%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-0{margin-left:0}}@media (min-width:1200px){.col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12{float:left}.col-lg-12{width:100%}.col-lg-11{width:91.66666667%}.col-lg-10{width:83.33333333%}.col-lg-9{width:75%}.col-lg-8{width:66.66666667%}.col-lg-7{width:58.33333333%}.col-lg-6{width:50%}.col-lg-5{width:41.66666667%}.col-lg-4{width:33.33333333%}.col-lg-3{width:25%}.col-lg-2{width:16.66666667%}.col-lg-1{width:8.33333333%}.col-lg-pull-12{right:100%}.col-lg-pull-11{right:91.66666667%}.col-lg-pull-10{right:83.33333333%}.col-lg-pull-9{right:75%}.col-lg-pull-8{right:66.66666667%}.col-lg-pull-7{right:58.33333333%}.col-lg-pull-6{right:50%}.col-lg-pull-5{right:41.66666667%}.col-lg-pull-4{right:33.33333333%}.col-lg-pull-3{right:25%}.col-lg-pull-2{right:16.66666667%}.col-lg-pull-1{right:8.33333333%}.col-lg-pull-0{right:auto}.col-lg-push-12{left:100%}.col-lg-push-11{left:91.66666667%}.col-lg-push-10{left:83.33333333%}.col-lg-push-9{left:75%}.col-lg-push-8{left:66.66666667%}.col-lg-push-7{left:58.33333333%}.col-lg-push-6{left:50%}.col-lg-push-5{left:41.66666667%}.col-lg-push-4{left:33.33333333%}.col-lg-push-3{left:25%}.col-lg-push-2{left:16.66666667%}.col-lg-push-1{left:8.33333333%}.col-lg-push-0{left:auto}.col-lg-offset-12{margin-left:100%}.col-lg-offset-11{margin-left:91.66666667%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-0{margin-left:0}}table{background-color:transparent}caption{padding-top:8px;padding-bottom:8px;color:#777;text-align:left}th{text-align:left}.table{width:100%;max-width:100%;margin-bottom:20px}.table>thead>tr>th,.table>tbody>tr>th,.table>tfoot>tr>th,.table>thead>tr>td,.table>tbody>tr>td,.table>tfoot>tr>td{padding:8px;line-height:1.42857143;vertical-align:top;border-top:1px solid #ddd}.table>thead>tr>th{vertical-align:bottom;border-bottom:2px solid #ddd}.table>caption+thead>tr:first-child>th,.table>colgroup+thead>tr:first-child>th,.table>thead:first-child>tr:first-child>th,.table>caption+thead>tr:first-child>td,.table>colgroup+thead>tr:first-child>td,.table>thead:first-child>tr:first-child>td{border-top:0}.table>tbody+tbody{border-top:2px solid #ddd}.table .table{background-color:#fff}.table-condensed>thead>tr>th,.table-condensed>tbody>tr>th,.table-condensed>tfoot>tr>th,.table-condensed>thead>tr>td,.table-condensed>tbody>tr>td,.table-condensed>tfoot>tr>td{padding:5px}.table-bordered{border:1px solid #ddd}.table-bordered>thead>tr>th,.table-bordered>tbody>tr>th,.table-bordered>tfoot>tr>th,.table-bordered>thead>tr>td,.table-bordered>tbody>tr>td,.table-bordered>tfoot>tr>td{border:1px solid #ddd}.table-bordered>thead>tr>th,.table-bordered>thead>tr>td{border-bottom-width:2px}.table-striped>tbody>tr:nth-of-type(odd){background-color:#f9f9f9}.table-hover>tbody>tr:hover{background-color:#f5f5f5}table col\[class\*="col-"\]{position:static;float:none;display:table-column}table td\[class\*="col-"\],table th\[class\*="col-"\]{position:static;float:none;display:table-cell}.table>thead>tr>td.active,.table>tbody>tr>td.active,.table>tfoot>tr>td.active,.table>thead>tr>th.active,.table>tbody>tr>th.active,.table>tfoot>tr>th.active,.table>thead>tr.active>td,.table>tbody>tr.active>td,.table>tfoot>tr.active>td,.table>thead>tr.active>th,.table>tbody>tr.active>th,.table>tfoot>tr.active>th{background-color:#f5f5f5}.table-hover>tbody>tr>td.active:hover,.table-hover>tbody>tr>th.active:hover,.table-hover>tbody>tr.active:hover>td,.table-hover>tbody>tr:hover>.active,.table-hover>tbody>tr.active:hover>th{background-color:#e8e8e8}.table>thead>tr>td.success,.table>tbody>tr>td.success,.table>tfoot>tr>td.success,.table>thead>tr>th.success,.table>tbody>tr>th.success,.table>tfoot>tr>th.success,.table>thead>tr.success>td,.table>tbody>tr.success>td,.table>tfoot>tr.success>td,.table>thead>tr.success>th,.table>tbody>tr.success>th,.table>tfoot>tr.success>th{background-color:#dff0d8}.table-hover>tbody>tr>td.success:hover,.table-hover>tbody>tr>th.success:hover,.table-hover>tbody>tr.success:hover>td,.table-hover>tbody>tr:hover>.success,.table-hover>tbody>tr.success:hover>th{background-color:#d0e9c6}.table>thead>tr>td.info,.table>tbody>tr>td.info,.table>tfoot>tr>td.info,.table>thead>tr>th.info,.table>tbody>tr>th.info,.table>tfoot>tr>th.info,.table>thead>tr.info>td,.table>tbody>tr.info>td,.table>tfoot>tr.info>td,.table>thead>tr.info>th,.table>tbody>tr.info>th,.table>tfoot>tr.info>th{background-color:#d9edf7}.table-hover>tbody>tr>td.info:hover,.table-hover>tbody>tr>th.info:hover,.table-hover>tbody>tr.info:hover>td,.table-hover>tbody>tr:hover>.info,.table-hover>tbody>tr.info:hover>th{background-color:#c4e3f3}.table>thead>tr>td.warning,.table>tbody>tr>td.warning,.table>tfoot>tr>td.warning,.table>thead>tr>th.warning,.table>tbody>tr>th.warning,.table>tfoot>tr>th.warning,.table>thead>tr.warning>td,.table>tbody>tr.warning>td,.table>tfoot>tr.warning>td,.table>thead>tr.warning>th,.table>tbody>tr.warning>th,.table>tfoot>tr.warning>th{background-color:#fcf8e3}.table-hover>tbody>tr>td.warning:hover,.table-hover>tbody>tr>th.warning:hover,.table-hover>tbody>tr.warning:hover>td,.table-hover>tbody>tr:hover>.warning,.table-hover>tbody>tr.warning:hover>th{background-color:#faf2cc}.table>thead>tr>td.danger,.table>tbody>tr>td.danger,.table>tfoot>tr>td.danger,.table>thead>tr>th.danger,.table>tbody>tr>th.danger,.table>tfoot>tr>th.danger,.table>thead>tr.danger>td,.table>tbody>tr.danger>td,.table>tfoot>tr.danger>td,.table>thead>tr.danger>th,.table>tbody>tr.danger>th,.table>tfoot>tr.danger>th{background-color:#f2dede}.table-hover>tbody>tr>td.danger:hover,.table-hover>tbody>tr>th.danger:hover,.table-hover>tbody>tr.danger:hover>td,.table-hover>tbody>tr:hover>.danger,.table-hover>tbody>tr.danger:hover>th{background-color:#ebcccc}.table-responsive{overflow-x:auto;min-height:0.01%}@media screen and (max-width:767px){.table-responsive{width:100%;margin-bottom:15px;overflow-y:hidden;-ms-overflow-style:-ms-autohiding-scrollbar;border:1px solid #ddd}.table-responsive>.table{margin-bottom:0}.table-responsive>.table>thead>tr>th,.table-responsive>.table>tbody>tr>th,.table-responsive>.table>tfoot>tr>th,.table-responsive>.table>thead>tr>td,.table-responsive>.table>tbody>tr>td,.table-responsive>.table>tfoot>tr>td{white-space:nowrap}.table-responsive>.table-bordered{border:0}.table-responsive>.table-bordered>thead>tr>th:first-child,.table-responsive>.table-bordered>tbody>tr>th:first-child,.table-responsive>.table-bordered>tfoot>tr>th:first-child,.table-responsive>.table-bordered>thead>tr>td:first-child,.table-responsive>.table-bordered>tbody>tr>td:first-child,.table-responsive>.table-bordered>tfoot>tr>td:first-child{border-left:0}.table-responsive>.table-bordered>thead>tr>th:last-child,.table-responsive>.table-bordered>tbody>tr>th:last-child,.table-responsive>.table-bordered>tfoot>tr>th:last-child,.table-responsive>.table-bordered>thead>tr>td:last-child,.table-responsive>.table-bordered>tbody>tr>td:last-child,.table-responsive>.table-bordered>tfoot>tr>td:last-child{border-right:0}.table-responsive>.table-bordered>tbody>tr:last-child>th,.table-responsive>.table-bordered>tfoot>tr:last-child>th,.table-responsive>.table-bordered>tbody>tr:last-child>td,.table-responsive>.table-bordered>tfoot>tr:last-child>td{border-bottom:0}}fieldset{padding:0;margin:0;border:0;min-width:0}legend{display:block;width:100%;padding:0;margin-bottom:20px;font-size:21px;line-height:inherit;color:#333;border:0;border-bottom:1px solid #e5e5e5}label{display:inline-block;max-width:100%;margin-bottom:5px;font-weight:bold}input\[type="search"\]{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}input\[type="radio"\],input\[type="checkbox"\]{margin:4px 0 0;margin-top:1px \\9;line-height:normal}input\[type="file"\]{display:block}input\[type="range"\]{display:block;width:100%}select\[multiple\],select\[size\]{height:auto}input\[type="file"\]:focus,input\[type="radio"\]:focus,input\[type="checkbox"\]:focus{outline:5px auto -webkit-focus-ring-color;outline-offset:-2px}output{display:block;padding-top:7px;font-size:14px;line-height:1.42857143;color:#555}.form-control{display:block;width:100%;height:34px;padding:6px 12px;font-size:14px;line-height:1.42857143;color:#555;background-color:#fff;background-image:none;border:1px solid #ccc;border-radius:4px;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,0.075);box-shadow:inset 0 1px 1px rgba(0,0,0,0.075);-webkit-transition:border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;-o-transition:border-color ease-in-out .15s, box-shadow ease-in-out .15s;transition:border-color ease-in-out .15s, box-shadow ease-in-out .15s}.form-control:focus{border-color:#66afe9;outline:0;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102, 175, 233, 0.6);box-shadow:inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102, 175, 233, 0.6)}.form-control::-moz-placeholder{color:#777;opacity:1}.form-control:-ms-input-placeholder{color:#777}.form-control::-webkit-input-placeholder{color:#777}.form-control::-ms-expand{border:0;background-color:transparent}.form-control\[disabled\],.form-control\[readonly\],fieldset\[disabled\] .form-control{background-color:#eee;opacity:1}.form-control\[disabled\],fieldset\[disabled\] .form-control{cursor:not-allowed}textarea.form-control{height:auto}input\[type="search"\]{-webkit-appearance:none}@media screen and (-webkit-min-device-pixel-ratio:0){input\[type="date"\].form-control,input\[type="time"\].form-control,input\[type="datetime-local"\].form-control,input\[type="month"\].form-control{line-height:34px}input\[type="date"\].input-sm,input\[type="time"\].input-sm,input\[type="datetime-local"\].input-sm,input\[type="month"\].input-sm,.input-group-sm input\[type="date"\],.input-group-sm input\[type="time"\],.input-group-sm input\[type="datetime-local"\],.input-group-sm input\[type="month"\]{line-height:30px}input\[type="date"\].input-lg,input\[type="time"\].input-lg,input\[type="datetime-local"\].input-lg,input\[type="month"\].input-lg,.input-group-lg input\[type="date"\],.input-group-lg input\[type="time"\],.input-group-lg input\[type="datetime-local"\],.input-group-lg input\[type="month"\]{line-height:46px}}.form-group{margin-bottom:15px}.radio,.checkbox{position:relative;display:block;margin-top:10px;margin-bottom:10px}.radio label,.checkbox label{min-height:20px;padding-left:20px;margin-bottom:0;font-weight:normal;cursor:pointer}.radio input\[type="radio"\],.radio-inline input\[type="radio"\],.checkbox input\[type="checkbox"\],.checkbox-inline input\[type="checkbox"\]{position:absolute;margin-left:-20px;margin-top:4px \\9}.radio+.radio,.checkbox+.checkbox{margin-top:-5px}.radio-inline,.checkbox-inline{position:relative;display:inline-block;padding-left:20px;margin-bottom:0;vertical-align:middle;font-weight:normal;cursor:pointer}.radio-inline+.radio-inline,.checkbox-inline+.checkbox-inline{margin-top:0;margin-left:10px}input\[type="radio"\]\[disabled\],input\[type="checkbox"\]\[disabled\],input\[type="radio"\].disabled,input\[type="checkbox"\].disabled,fieldset\[disabled\] input\[type="radio"\],fieldset\[disabled\] input\[type="checkbox"\]{cursor:not-allowed}.radio-inline.disabled,.checkbox-inline.disabled,fieldset\[disabled\] .radio-inline,fieldset\[disabled\] .checkbox-inline{cursor:not-allowed}.radio.disabled label,.checkbox.disabled label,fieldset\[disabled\] .radio label,fieldset\[disabled\] .checkbox label{cursor:not-allowed}.form-control-static{padding-top:7px;padding-bottom:7px;margin-bottom:0;min-height:34px}.form-control-static.input-lg,.form-control-static.input-sm{padding-left:0;padding-right:0}.input-sm{height:30px;padding:5px 10px;font-size:12px;line-height:1.5;border-radius:3px}select.input-sm{height:30px;line-height:30px}textarea.input-sm,select\[multiple\].input-sm{height:auto}.form-group-sm .form-control{height:30px;padding:5px 10px;font-size:12px;line-height:1.5;border-radius:3px}.form-group-sm select.form-control{height:30px;line-height:30px}.form-group-sm textarea.form-control,.form-group-sm select\[multiple\].form-control{height:auto}.form-group-sm .form-control-static{height:30px;min-height:32px;padding:6px 10px;font-size:12px;line-height:1.5}.input-lg{height:46px;padding:10px 16px;font-size:18px;line-height:1.33;border-radius:6px}select.input-lg{height:46px;line-height:46px}textarea.input-lg,select\[multiple\].input-lg{height:auto}.form-group-lg .form-control{height:46px;padding:10px 16px;font-size:18px;line-height:1.33;border-radius:6px}.form-group-lg select.form-control{height:46px;line-height:46px}.form-group-lg textarea.form-control,.form-group-lg select\[multiple\].form-control{height:auto}.form-group-lg .form-control-static{height:46px;min-height:38px;padding:11px 16px;font-size:18px;line-height:1.33}.has-feedback{position:relative}.has-feedback .form-control{padding-right:42.5px}.form-control-feedback{position:absolute;top:0;right:0;z-index:2;display:block;width:34px;height:34px;line-height:34px;text-align:center;pointer-events:none}.input-lg+.form-control-feedback,.input-group-lg+.form-control-feedback,.form-group-lg .form-control+.form-control-feedback{width:46px;height:46px;line-height:46px}.input-sm+.form-control-feedback,.input-group-sm+.form-control-feedback,.form-group-sm .form-control+.form-control-feedback{width:30px;height:30px;line-height:30px}.has-success .help-block,.has-success .control-label,.has-success .radio,.has-success .checkbox,.has-success .radio-inline,.has-success .checkbox-inline,.has-success.radio label,.has-success.checkbox label,.has-success.radio-inline label,.has-success.checkbox-inline label{color:#3c763d}.has-success .form-control{border-color:#3c763d;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,0.075);box-shadow:inset 0 1px 1px rgba(0,0,0,0.075)}.has-success .form-control:focus{border-color:#2b542c;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,0.075),0 0 6px #67b168;box-shadow:inset 0 1px 1px rgba(0,0,0,0.075),0 0 6px #67b168}.has-success .input-group-addon{color:#3c763d;border-color:#3c763d;background-color:#dff0d8}.has-success .form-control-feedback{color:#3c763d}.has-warning .help-block,.has-warning .control-label,.has-warning .radio,.has-warning .checkbox,.has-warning .radio-inline,.has-warning .checkbox-inline,.has-warning.radio label,.has-warning.checkbox label,.has-warning.radio-inline label,.has-warning.checkbox-inline label{color:#8a6d3b}.has-warning .form-control{border-color:#8a6d3b;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,0.075);box-shadow:inset 0 1px 1px rgba(0,0,0,0.075)}.has-warning .form-control:focus{border-color:#66512c;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,0.075),0 0 6px #c0a16b;box-shadow:inset 0 1px 1px rgba(0,0,0,0.075),0 0 6px #c0a16b}.has-warning .input-group-addon{color:#8a6d3b;border-color:#8a6d3b;background-color:#fcf8e3}.has-warning .form-control-feedback{color:#8a6d3b}.has-error .help-block,.has-error .control-label,.has-error .radio,.has-error .checkbox,.has-error .radio-inline,.has-error .checkbox-inline,.has-error.radio label,.has-error.checkbox label,.has-error.radio-inline label,.has-error.checkbox-inline label{color:#a94442}.has-error .form-control{border-color:#a94442;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,0.075);box-shadow:inset 0 1px 1px rgba(0,0,0,0.075)}.has-error .form-control:focus{border-color:#843534;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,0.075),0 0 6px #ce8483;box-shadow:inset 0 1px 1px rgba(0,0,0,0.075),0 0 6px #ce8483}.has-error .input-group-addon{color:#a94442;border-color:#a94442;background-color:#f2dede}.has-error .form-control-feedback{color:#a94442}.has-feedback label~.form-control-feedback{top:25px}.has-feedback label.sr-only~.form-control-feedback{top:0}.help-block{display:block;margin-top:5px;margin-bottom:10px;color:#737373}@media (min-width:768px){.form-inline .form-group{display:inline-block;margin-bottom:0;vertical-align:middle}.form-inline .form-control{display:inline-block;width:auto;vertical-align:middle}.form-inline .form-control-static{display:inline-block}.form-inline .input-group{display:inline-table;vertical-align:middle}.form-inline .input-group .input-group-addon,.form-inline .input-group .input-group-btn,.form-inline .input-group .form-control{width:auto}.form-inline .input-group>.form-control{width:100%}.form-inline .control-label{margin-bottom:0;vertical-align:middle}.form-inline .radio,.form-inline .checkbox{display:inline-block;margin-top:0;margin-bottom:0;vertical-align:middle}.form-inline .radio label,.form-inline .checkbox label{padding-left:0}.form-inline .radio input\[type="radio"\],.form-inline .checkbox input\[type="checkbox"\]{position:relative;margin-left:0}.form-inline .has-feedback .form-control-feedback{top:0}}.form-horizontal .radio,.form-horizontal .checkbox,.form-horizontal .radio-inline,.form-horizontal .checkbox-inline{margin-top:0;margin-bottom:0;padding-top:7px}.form-horizontal .radio,.form-horizontal .checkbox{min-height:27px}.form-horizontal .form-group{margin-left:-15px;margin-right:-15px}@media (min-width:768px){.form-horizontal .control-label{text-align:right;margin-bottom:0;padding-top:7px}}.form-horizontal .has-feedback .form-control-feedback{right:15px}@media (min-width:768px){.form-horizontal .form-group-lg .control-label{padding-top:11px;font-size:18px}}@media (min-width:768px){.form-horizontal .form-group-sm .control-label{padding-top:6px;font-size:12px}}.btn{display:inline-block;margin-bottom:0;font-weight:normal;text-align:center;vertical-align:middle;-ms-touch-action:manipulation;touch-action:manipulation;cursor:pointer;background-image:none;border:1px solid transparent;white-space:nowrap;padding:6px 12px;font-size:14px;line-height:1.42857143;border-radius:4px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.btn:focus,.btn:active:focus,.btn.active:focus,.btn.focus,.btn:active.focus,.btn.active.focus{outline:5px auto -webkit-focus-ring-color;outline-offset:-2px}.btn:hover,.btn:focus,.btn.focus{color:#333;text-decoration:none}.btn:active,.btn.active{outline:0;background-image:none;-webkit-box-shadow:inset 0 3px 5px rgba(0,0,0,0.125);box-shadow:inset 0 3px 5px rgba(0,0,0,0.125)}.btn.disabled,.btn\[disabled\],fieldset\[disabled\] .btn{cursor:not-allowed;opacity:.65;filter:alpha(opacity=65);-webkit-box-shadow:none;box-shadow:none}a.btn.disabled,fieldset\[disabled\] a.btn{pointer-events:none}.btn-default{color:#333;background-color:#fff;border-color:#ccc}.btn-default:focus,.btn-default.focus{color:#333;background-color:#e6e6e6;border-color:#8c8c8c}.btn-default:hover{color:#333;background-color:#e6e6e6;border-color:#adadad}.btn-default:active,.btn-default.active,.open>.dropdown-toggle.btn-default{color:#333;background-color:#e6e6e6;border-color:#adadad}.btn-default:active:hover,.btn-default.active:hover,.open>.dropdown-toggle.btn-default:hover,.btn-default:active:focus,.btn-default.active:focus,.open>.dropdown-toggle.btn-default:focus,.btn-default:active.focus,.btn-default.active.focus,.open>.dropdown-toggle.btn-default.focus{color:#333;background-color:#d4d4d4;border-color:#8c8c8c}.btn-default:active,.btn-default.active,.open>.dropdown-toggle.btn-default{background-image:none}.btn-default.disabled:hover,.btn-default\[disabled\]:hover,fieldset\[disabled\] .btn-default:hover,.btn-default.disabled:focus,.btn-default\[disabled\]:focus,fieldset\[disabled\] .btn-default:focus,.btn-default.disabled.focus,.btn-default\[disabled\].focus,fieldset\[disabled\] .btn-default.focus{background-color:#fff;border-color:#ccc}.btn-default .badge{color:#fff;background-color:#333}.btn-primary{color:#fff;background-color:#428bca;border-color:#357ebd}.btn-primary:focus,.btn-primary.focus{color:#fff;background-color:#3071a9;border-color:#193c5a}.btn-primary:hover{color:#fff;background-color:#3071a9;border-color:#285e8e}.btn-primary:active,.btn-primary.active,.open>.dropdown-toggle.btn-primary{color:#fff;background-color:#3071a9;border-color:#285e8e}.btn-primary:active:hover,.btn-primary.active:hover,.open>.dropdown-toggle.btn-primary:hover,.btn-primary:active:focus,.btn-primary.active:focus,.open>.dropdown-toggle.btn-primary:focus,.btn-primary:active.focus,.btn-primary.active.focus,.open>.dropdown-toggle.btn-primary.focus{color:#fff;background-color:#285e8e;border-color:#193c5a}.btn-primary:active,.btn-primary.active,.open>.dropdown-toggle.btn-primary{background-image:none}.btn-primary.disabled:hover,.btn-primary\[disabled\]:hover,fieldset\[disabled\] .btn-primary:hover,.btn-primary.disabled:focus,.btn-primary\[disabled\]:focus,fieldset\[disabled\] .btn-primary:focus,.btn-primary.disabled.focus,.btn-primary\[disabled\].focus,fieldset\[disabled\] .btn-primary.focus{background-color:#428bca;border-color:#357ebd}.btn-primary .badge{color:#428bca;background-color:#fff}.btn-success{color:#fff;background-color:#5cb85c;border-color:#4cae4c}.btn-success:focus,.btn-success.focus{color:#fff;background-color:#449d44;border-color:#255625}.btn-success:hover{color:#fff;background-color:#449d44;border-color:#398439}.btn-success:active,.btn-success.active,.open>.dropdown-toggle.btn-success{color:#fff;background-color:#449d44;border-color:#398439}.btn-success:active:hover,.btn-success.active:hover,.open>.dropdown-toggle.btn-success:hover,.btn-success:active:focus,.btn-success.active:focus,.open>.dropdown-toggle.btn-success:focus,.btn-success:active.focus,.btn-success.active.focus,.open>.dropdown-toggle.btn-success.focus{color:#fff;background-color:#398439;border-color:#255625}.btn-success:active,.btn-success.active,.open>.dropdown-toggle.btn-success{background-image:none}.btn-success.disabled:hover,.btn-success\[disabled\]:hover,fieldset\[disabled\] .btn-success:hover,.btn-success.disabled:focus,.btn-success\[disabled\]:focus,fieldset\[disabled\] .btn-success:focus,.btn-success.disabled.focus,.btn-success\[disabled\].focus,fieldset\[disabled\] .btn-success.focus{background-color:#5cb85c;border-color:#4cae4c}.btn-success .badge{color:#5cb85c;background-color:#fff}.btn-info{color:#fff;background-color:#5bc0de;border-color:#46b8da}.btn-info:focus,.btn-info.focus{color:#fff;background-color:#31b0d5;border-color:#1b6d85}.btn-info:hover{color:#fff;background-color:#31b0d5;border-color:#269abc}.btn-info:active,.btn-info.active,.open>.dropdown-toggle.btn-info{color:#fff;background-color:#31b0d5;border-color:#269abc}.btn-info:active:hover,.btn-info.active:hover,.open>.dropdown-toggle.btn-info:hover,.btn-info:active:focus,.btn-info.active:focus,.open>.dropdown-toggle.btn-info:focus,.btn-info:active.focus,.btn-info.active.focus,.open>.dropdown-toggle.btn-info.focus{color:#fff;background-color:#269abc;border-color:#1b6d85}.btn-info:active,.btn-info.active,.open>.dropdown-toggle.btn-info{background-image:none}.btn-info.disabled:hover,.btn-info\[disabled\]:hover,fieldset\[disabled\] .btn-info:hover,.btn-info.disabled:focus,.btn-info\[disabled\]:focus,fieldset\[disabled\] .btn-info:focus,.btn-info.disabled.focus,.btn-info\[disabled\].focus,fieldset\[disabled\] .btn-info.focus{background-color:#5bc0de;border-color:#46b8da}.btn-info .badge{color:#5bc0de;background-color:#fff}.btn-warning{color:#fff;background-color:#f0ad4e;border-color:#eea236}.btn-warning:focus,.btn-warning.focus{color:#fff;background-color:#ec971f;border-color:#985f0d}.btn-warning:hover{color:#fff;background-color:#ec971f;border-color:#d58512}.btn-warning:active,.btn-warning.active,.open>.dropdown-toggle.btn-warning{color:#fff;background-color:#ec971f;border-color:#d58512}.btn-warning:active:hover,.btn-warning.active:hover,.open>.dropdown-toggle.btn-warning:hover,.btn-warning:active:focus,.btn-warning.active:focus,.open>.dropdown-toggle.btn-warning:focus,.btn-warning:active.focus,.btn-warning.active.focus,.open>.dropdown-toggle.btn-warning.focus{color:#fff;background-color:#d58512;border-color:#985f0d}.btn-warning:active,.btn-warning.active,.open>.dropdown-toggle.btn-warning{background-image:none}.btn-warning.disabled:hover,.btn-warning\[disabled\]:hover,fieldset\[disabled\] .btn-warning:hover,.btn-warning.disabled:focus,.btn-warning\[disabled\]:focus,fieldset\[disabled\] .btn-warning:focus,.btn-warning.disabled.focus,.btn-warning\[disabled\].focus,fieldset\[disabled\] .btn-warning.focus{background-color:#f0ad4e;border-color:#eea236}.btn-warning .badge{color:#f0ad4e;background-color:#fff}.btn-danger{color:#fff;background-color:#d9534f;border-color:#d43f3a}.btn-danger:focus,.btn-danger.focus{color:#fff;background-color:#c9302c;border-color:#761c19}.btn-danger:hover{color:#fff;background-color:#c9302c;border-color:#ac2925}.btn-danger:active,.btn-danger.active,.open>.dropdown-toggle.btn-danger{color:#fff;background-color:#c9302c;border-color:#ac2925}.btn-danger:active:hover,.btn-danger.active:hover,.open>.dropdown-toggle.btn-danger:hover,.btn-danger:active:focus,.btn-danger.active:focus,.open>.dropdown-toggle.btn-danger:focus,.btn-danger:active.focus,.btn-danger.active.focus,.open>.dropdown-toggle.btn-danger.focus{color:#fff;background-color:#ac2925;border-color:#761c19}.btn-danger:active,.btn-danger.active,.open>.dropdown-toggle.btn-danger{background-image:none}.btn-danger.disabled:hover,.btn-danger\[disabled\]:hover,fieldset\[disabled\] .btn-danger:hover,.btn-danger.disabled:focus,.btn-danger\[disabled\]:focus,fieldset\[disabled\] .btn-danger:focus,.btn-danger.disabled.focus,.btn-danger\[disabled\].focus,fieldset\[disabled\] .btn-danger.focus{background-color:#d9534f;border-color:#d43f3a}.btn-danger .badge{color:#d9534f;background-color:#fff}.btn-link{color:#428bca;font-weight:normal;border-radius:0}.btn-link,.btn-link:active,.btn-link.active,.btn-link\[disabled\],fieldset\[disabled\] .btn-link{background-color:transparent;-webkit-box-shadow:none;box-shadow:none}.btn-link,.btn-link:hover,.btn-link:focus,.btn-link:active{border-color:transparent}.btn-link:hover,.btn-link:focus{color:#2a6496;text-decoration:underline;background-color:transparent}.btn-link\[disabled\]:hover,fieldset\[disabled\] .btn-link:hover,.btn-link\[disabled\]:focus,fieldset\[disabled\] .btn-link:focus{color:#777;text-decoration:none}.btn-lg,.btn-group-lg>.btn{padding:10px 16px;font-size:18px;line-height:1.33;border-radius:6px}.btn-sm,.btn-group-sm>.btn{padding:5px 10px;font-size:12px;line-height:1.5;border-radius:3px}.btn-xs,.btn-group-xs>.btn{padding:1px 5px;font-size:12px;line-height:1.5;border-radius:3px}.btn-block{display:block;width:100%}.btn-block+.btn-block{margin-top:5px}input\[type="submit"\].btn-block,input\[type="reset"\].btn-block,input\[type="button"\].btn-block{width:100%}.fade{opacity:0;-webkit-transition:opacity .15s linear;-o-transition:opacity .15s linear;transition:opacity .15s linear}.fade.in{opacity:1}.collapse{display:none}.collapse.in{display:block}tr.collapse.in{display:table-row}tbody.collapse.in{display:table-row-group}.collapsing{position:relative;height:0;overflow:hidden;-webkit-transition-property:height, visibility;-o-transition-property:height, visibility;transition-property:height, visibility;-webkit-transition-duration:.35s;-o-transition-duration:.35s;transition-duration:.35s;-webkit-transition-timing-function:ease;-o-transition-timing-function:ease;transition-timing-function:ease}.btn-group,.btn-group-vertical{position:relative;display:inline-block;vertical-align:middle}.btn-group>.btn,.btn-group-vertical>.btn{position:relative;float:left}.btn-group>.btn:hover,.btn-group-vertical>.btn:hover,.btn-group>.btn:focus,.btn-group-vertical>.btn:focus,.btn-group>.btn:active,.btn-group-vertical>.btn:active,.btn-group>.btn.active,.btn-group-vertical>.btn.active{z-index:2}.btn-group .btn+.btn,.btn-group .btn+.btn-group,.btn-group .btn-group+.btn,.btn-group .btn-group+.btn-group{margin-left:-1px}.btn-toolbar{margin-left:-5px}.btn-toolbar .btn,.btn-toolbar .btn-group,.btn-toolbar .input-group{float:left}.btn-toolbar>.btn,.btn-toolbar>.btn-group,.btn-toolbar>.input-group{margin-left:5px}.btn-group>.btn:not(:first-child):not(:last-child):not(.dropdown-toggle){border-radius:0}.btn-group>.btn:first-child{margin-left:0}.btn-group>.btn:first-child:not(:last-child):not(.dropdown-toggle){border-bottom-right-radius:0;border-top-right-radius:0}.btn-group>.btn:last-child:not(:first-child),.btn-group>.dropdown-toggle:not(:first-child){border-bottom-left-radius:0;border-top-left-radius:0}.btn-group>.btn-group{float:left}.btn-group>.btn-group:not(:first-child):not(:last-child)>.btn{border-radius:0}.btn-group>.btn-group:first-child:not(:last-child)>.btn:last-child,.btn-group>.btn-group:first-child:not(:last-child)>.dropdown-toggle{border-bottom-right-radius:0;border-top-right-radius:0}.btn-group>.btn-group:last-child:not(:first-child)>.btn:first-child{border-bottom-left-radius:0;border-top-left-radius:0}.btn-group .dropdown-toggle:active,.btn-group.open .dropdown-toggle{outline:0}.btn-group>.btn+.dropdown-toggle{padding-left:8px;padding-right:8px}.btn-group>.btn-lg+.dropdown-toggle{padding-left:12px;padding-right:12px}.btn-group.open .dropdown-toggle{-webkit-box-shadow:inset 0 3px 5px rgba(0,0,0,0.125);box-shadow:inset 0 3px 5px rgba(0,0,0,0.125)}.btn-group.open .dropdown-toggle.btn-link{-webkit-box-shadow:none;box-shadow:none}.btn .caret{margin-left:0}.btn-lg .caret{border-width:5px 5px 0;border-bottom-width:0}.dropup .btn-lg .caret{border-width:0 5px 5px}.btn-group-vertical>.btn,.btn-group-vertical>.btn-group,.btn-group-vertical>.btn-group>.btn{display:block;float:none;width:100%;max-width:100%}.btn-group-vertical>.btn-group>.btn{float:none}.btn-group-vertical>.btn+.btn,.btn-group-vertical>.btn+.btn-group,.btn-group-vertical>.btn-group+.btn,.btn-group-vertical>.btn-group+.btn-group{margin-top:-1px;margin-left:0}.btn-group-vertical>.btn:not(:first-child):not(:last-child){border-radius:0}.btn-group-vertical>.btn:first-child:not(:last-child){border-top-right-radius:4px;border-top-left-radius:4px;border-bottom-right-radius:0;border-bottom-left-radius:0}.btn-group-vertical>.btn:last-child:not(:first-child){border-top-right-radius:0;border-top-left-radius:0;border-bottom-right-radius:4px;border-bottom-left-radius:4px}.btn-group-vertical>.btn-group:not(:first-child):not(:last-child)>.btn{border-radius:0}.btn-group-vertical>.btn-group:first-child:not(:last-child)>.btn:last-child,.btn-group-vertical>.btn-group:first-child:not(:last-child)>.dropdown-toggle{border-bottom-right-radius:0;border-bottom-left-radius:0}.btn-group-vertical>.btn-group:last-child:not(:first-child)>.btn:first-child{border-top-right-radius:0;border-top-left-radius:0}.btn-group-justified{display:table;width:100%;table-layout:fixed;border-collapse:separate}.btn-group-justified>.btn,.btn-group-justified>.btn-group{float:none;display:table-cell;width:1%}.btn-group-justified>.btn-group .btn{width:100%}.btn-group-justified>.btn-group .dropdown-menu{left:auto}\[data-toggle="buttons"\]>.btn input\[type="radio"\],\[data-toggle="buttons"\]>.btn-group>.btn input\[type="radio"\],\[data-toggle="buttons"\]>.btn input\[type="checkbox"\],\[data-toggle="buttons"\]>.btn-group>.btn input\[type="checkbox"\]{position:absolute;clip:rect(0, 0, 0, 0);pointer-events:none}.input-group{position:relative;display:table;border-collapse:separate}.input-group\[class\*="col-"\]{float:none;padding-left:0;padding-right:0}.input-group .form-control{position:relative;z-index:2;float:left;width:100%;margin-bottom:0}.input-group .form-control:focus{z-index:3}.input-group-lg>.form-control,.input-group-lg>.input-group-addon,.input-group-lg>.input-group-btn>.btn{height:46px;padding:10px 16px;font-size:18px;line-height:1.33;border-radius:6px}select.input-group-lg>.form-control,select.input-group-lg>.input-group-addon,select.input-group-lg>.input-group-btn>.btn{height:46px;line-height:46px}textarea.input-group-lg>.form-control,textarea.input-group-lg>.input-group-addon,textarea.input-group-lg>.input-group-btn>.btn,select\[multiple\].input-group-lg>.form-control,select\[multiple\].input-group-lg>.input-group-addon,select\[multiple\].input-group-lg>.input-group-btn>.btn{height:auto}.input-group-sm>.form-control,.input-group-sm>.input-group-addon,.input-group-sm>.input-group-btn>.btn{height:30px;padding:5px 10px;font-size:12px;line-height:1.5;border-radius:3px}select.input-group-sm>.form-control,select.input-group-sm>.input-group-addon,select.input-group-sm>.input-group-btn>.btn{height:30px;line-height:30px}textarea.input-group-sm>.form-control,textarea.input-group-sm>.input-group-addon,textarea.input-group-sm>.input-group-btn>.btn,select\[multiple\].input-group-sm>.form-control,select\[multiple\].input-group-sm>.input-group-addon,select\[multiple\].input-group-sm>.input-group-btn>.btn{height:auto}.input-group-addon,.input-group-btn,.input-group .form-control{display:table-cell}.input-group-addon:not(:first-child):not(:last-child),.input-group-btn:not(:first-child):not(:last-child),.input-group .form-control:not(:first-child):not(:last-child){border-radius:0}.input-group-addon,.input-group-btn{width:1%;white-space:nowrap;vertical-align:middle}.input-group-addon{padding:6px 12px;font-size:14px;font-weight:normal;line-height:1;color:#555;text-align:center;background-color:#eee;border:1px solid #ccc;border-radius:4px}.input-group-addon.input-sm{padding:5px 10px;font-size:12px;border-radius:3px}.input-group-addon.input-lg{padding:10px 16px;font-size:18px;border-radius:6px}.input-group-addon input\[type="radio"\],.input-group-addon input\[type="checkbox"\]{margin-top:0}.input-group .form-control:first-child,.input-group-addon:first-child,.input-group-btn:first-child>.btn,.input-group-btn:first-child>.btn-group>.btn,.input-group-btn:first-child>.dropdown-toggle,.input-group-btn:last-child>.btn:not(:last-child):not(.dropdown-toggle),.input-group-btn:last-child>.btn-group:not(:last-child)>.btn{border-bottom-right-radius:0;border-top-right-radius:0}.input-group-addon:first-child{border-right:0}.input-group .form-control:last-child,.input-group-addon:last-child,.input-group-btn:last-child>.btn,.input-group-btn:last-child>.btn-group>.btn,.input-group-btn:last-child>.dropdown-toggle,.input-group-btn:first-child>.btn:not(:first-child),.input-group-btn:first-child>.btn-group:not(:first-child)>.btn{border-bottom-left-radius:0;border-top-left-radius:0}.input-group-addon:last-child{border-left:0}.input-group-btn{position:relative;font-size:0;white-space:nowrap}.input-group-btn>.btn{position:relative}.input-group-btn>.btn+.btn{margin-left:-1px}.input-group-btn>.btn:hover,.input-group-btn>.btn:focus,.input-group-btn>.btn:active{z-index:2}.input-group-btn:first-child>.btn,.input-group-btn:first-child>.btn-group{margin-right:-1px}.input-group-btn:last-child>.btn,.input-group-btn:last-child>.btn-group{z-index:2;margin-left:-1px}.nav{margin-bottom:0;padding-left:0;list-style:none}.nav>li{position:relative;display:block}.nav>li>a{position:relative;display:block;padding:10px 15px}.nav>li>a:hover,.nav>li>a:focus{text-decoration:none;background-color:#eee}.nav>li.disabled>a{color:#777}.nav>li.disabled>a:hover,.nav>li.disabled>a:focus{color:#777;text-decoration:none;background-color:transparent;cursor:not-allowed}.nav .open>a,.nav .open>a:hover,.nav .open>a:focus{background-color:#eee;border-color:#428bca}.nav .nav-divider{height:1px;margin:9px 0;overflow:hidden;background-color:#e5e5e5}.nav>li>a>img{max-width:none}.nav-tabs{border-bottom:1px solid #ddd}.nav-tabs>li{float:left;margin-bottom:-1px}.nav-tabs>li>a{margin-right:2px;line-height:1.42857143;border:1px solid transparent;border-radius:4px 4px 0 0}.nav-tabs>li>a:hover{border-color:#eee #eee #ddd}.nav-tabs>li.active>a,.nav-tabs>li.active>a:hover,.nav-tabs>li.active>a:focus{color:#555;background-color:#fff;border:1px solid #ddd;border-bottom-color:transparent;cursor:default}.nav-tabs.nav-justified{width:100%;border-bottom:0}.nav-tabs.nav-justified>li{float:none}.nav-tabs.nav-justified>li>a{text-align:center;margin-bottom:5px}.nav-tabs.nav-justified>.dropdown .dropdown-menu{top:auto;left:auto}@media (min-width:768px){.nav-tabs.nav-justified>li{display:table-cell;width:1%}.nav-tabs.nav-justified>li>a{margin-bottom:0}}.nav-tabs.nav-justified>li>a{margin-right:0;border-radius:4px}.nav-tabs.nav-justified>.active>a,.nav-tabs.nav-justified>.active>a:hover,.nav-tabs.nav-justified>.active>a:focus{border:1px solid #ddd}@media (min-width:768px){.nav-tabs.nav-justified>li>a{border-bottom:1px solid #ddd;border-radius:4px 4px 0 0}.nav-tabs.nav-justified>.active>a,.nav-tabs.nav-justified>.active>a:hover,.nav-tabs.nav-justified>.active>a:focus{border-bottom-color:#fff}}.nav-pills>li{float:left}.nav-pills>li>a{border-radius:4px}.nav-pills>li+li{margin-left:2px}.nav-pills>li.active>a,.nav-pills>li.active>a:hover,.nav-pills>li.active>a:focus{color:#fff;background-color:#428bca}.nav-stacked>li{float:none}.nav-stacked>li+li{margin-top:2px;margin-left:0}.nav-justified{width:100%}.nav-justified>li{float:none}.nav-justified>li>a{text-align:center;margin-bottom:5px}.nav-justified>.dropdown .dropdown-menu{top:auto;left:auto}@media (min-width:768px){.nav-justified>li{display:table-cell;width:1%}.nav-justified>li>a{margin-bottom:0}}.nav-tabs-justified{border-bottom:0}.nav-tabs-justified>li>a{margin-right:0;border-radius:4px}.nav-tabs-justified>.active>a,.nav-tabs-justified>.active>a:hover,.nav-tabs-justified>.active>a:focus{border:1px solid #ddd}@media (min-width:768px){.nav-tabs-justified>li>a{border-bottom:1px solid #ddd;border-radius:4px 4px 0 0}.nav-tabs-justified>.active>a,.nav-tabs-justified>.active>a:hover,.nav-tabs-justified>.active>a:focus{border-bottom-color:#fff}}.tab-content>.tab-pane{display:none}.tab-content>.active{display:block}.nav-tabs .dropdown-menu{margin-top:-1px;border-top-right-radius:0;border-top-left-radius:0}.navbar{position:relative;min-height:50px;margin-bottom:20px;border:1px solid transparent}@media (min-width:768px){.navbar{border-radius:4px}}@media (min-width:768px){.navbar-header{float:left}}.navbar-collapse{overflow-x:visible;padding-right:15px;padding-left:15px;border-top:1px solid transparent;-webkit-box-shadow:inset 0 1px 0 rgba(255,255,255,0.1);box-shadow:inset 0 1px 0 rgba(255,255,255,0.1);-webkit-overflow-scrolling:touch}.navbar-collapse.in{overflow-y:auto}@media (min-width:768px){.navbar-collapse{width:auto;border-top:0;-webkit-box-shadow:none;box-shadow:none}.navbar-collapse.collapse{display:block !important;height:auto !important;padding-bottom:0;overflow:visible !important}.navbar-collapse.in{overflow-y:visible}.navbar-fixed-top .navbar-collapse,.navbar-static-top .navbar-collapse,.navbar-fixed-bottom .navbar-collapse{padding-left:0;padding-right:0}}.navbar-fixed-top .navbar-collapse,.navbar-fixed-bottom .navbar-collapse{max-height:340px}@media (max-device-width:480px) and (orientation:landscape){.navbar-fixed-top .navbar-collapse,.navbar-fixed-bottom .navbar-collapse{max-height:200px}}.container>.navbar-header,.container-fluid>.navbar-header,.container>.navbar-collapse,.container-fluid>.navbar-collapse{margin-right:-15px;margin-left:-15px}@media (min-width:768px){.container>.navbar-header,.container-fluid>.navbar-header,.container>.navbar-collapse,.container-fluid>.navbar-collapse{margin-right:0;margin-left:0}}.navbar-static-top{z-index:1000;border-width:0 0 1px}@media (min-width:768px){.navbar-static-top{border-radius:0}}.navbar-fixed-top,.navbar-fixed-bottom{position:fixed;right:0;left:0;z-index:1030}@media (min-width:768px){.navbar-fixed-top,.navbar-fixed-bottom{border-radius:0}}.navbar-fixed-top{top:0;border-width:0 0 1px}.navbar-fixed-bottom{bottom:0;margin-bottom:0;border-width:1px 0 0}.navbar-brand{float:left;padding:15px 15px;font-size:18px;line-height:20px;height:50px}.navbar-brand:hover,.navbar-brand:focus{text-decoration:none}.navbar-brand>img{display:block}@media (min-width:768px){.navbar>.container .navbar-brand,.navbar>.container-fluid .navbar-brand{margin-left:-15px}}.navbar-toggle{position:relative;float:right;margin-right:15px;padding:9px 10px;margin-top:8px;margin-bottom:8px;background-color:transparent;background-image:none;border:1px solid transparent;border-radius:4px}.navbar-toggle:focus{outline:0}.navbar-toggle .icon-bar{display:block;width:22px;height:2px;border-radius:1px}.navbar-toggle .icon-bar+.icon-bar{margin-top:4px}@media (min-width:768px){.navbar-toggle{display:none}}.navbar-nav{margin:7.5px -15px}.navbar-nav>li>a{padding-top:10px;padding-bottom:10px;line-height:20px}@media (max-width:767px){.navbar-nav .open .dropdown-menu{position:static;float:none;width:auto;margin-top:0;background-color:transparent;border:0;-webkit-box-shadow:none;box-shadow:none}.navbar-nav .open .dropdown-menu>li>a,.navbar-nav .open .dropdown-menu .dropdown-header{padding:5px 15px 5px 25px}.navbar-nav .open .dropdown-menu>li>a{line-height:20px}.navbar-nav .open .dropdown-menu>li>a:hover,.navbar-nav .open .dropdown-menu>li>a:focus{background-image:none}}@media (min-width:768px){.navbar-nav{float:left;margin:0}.navbar-nav>li{float:left}.navbar-nav>li>a{padding-top:15px;padding-bottom:15px}}.navbar-form{margin-left:-15px;margin-right:-15px;padding:10px 15px;border-top:1px solid transparent;border-bottom:1px solid transparent;-webkit-box-shadow:inset 0 1px 0 rgba(255,255,255,0.1),0 1px 0 rgba(255,255,255,0.1);box-shadow:inset 0 1px 0 rgba(255,255,255,0.1),0 1px 0 rgba(255,255,255,0.1);margin-top:8px;margin-bottom:8px}@media (min-width:768px){.navbar-form .form-group{display:inline-block;margin-bottom:0;vertical-align:middle}.navbar-form .form-control{display:inline-block;width:auto;vertical-align:middle}.navbar-form .form-control-static{display:inline-block}.navbar-form .input-group{display:inline-table;vertical-align:middle}.navbar-form .input-group .input-group-addon,.navbar-form .input-group .input-group-btn,.navbar-form .input-group .form-control{width:auto}.navbar-form .input-group>.form-control{width:100%}.navbar-form .control-label{margin-bottom:0;vertical-align:middle}.navbar-form .radio,.navbar-form .checkbox{display:inline-block;margin-top:0;margin-bottom:0;vertical-align:middle}.navbar-form .radio label,.navbar-form .checkbox label{padding-left:0}.navbar-form .radio input\[type="radio"\],.navbar-form .checkbox input\[type="checkbox"\]{position:relative;margin-left:0}.navbar-form .has-feedback .form-control-feedback{top:0}}@media (max-width:767px){.navbar-form .form-group{margin-bottom:5px}.navbar-form .form-group:last-child{margin-bottom:0}}@media (min-width:768px){.navbar-form{width:auto;border:0;margin-left:0;margin-right:0;padding-top:0;padding-bottom:0;-webkit-box-shadow:none;box-shadow:none}}.navbar-nav>li>.dropdown-menu{margin-top:0;border-top-right-radius:0;border-top-left-radius:0}.navbar-fixed-bottom .navbar-nav>li>.dropdown-menu{margin-bottom:0;border-top-right-radius:4px;border-top-left-radius:4px;border-bottom-right-radius:0;border-bottom-left-radius:0}.navbar-btn{margin-top:8px;margin-bottom:8px}.navbar-btn.btn-sm{margin-top:10px;margin-bottom:10px}.navbar-btn.btn-xs{margin-top:14px;margin-bottom:14px}.navbar-text{margin-top:15px;margin-bottom:15px}@media (min-width:768px){.navbar-text{float:left;margin-left:15px;margin-right:15px}}@media (min-width:768px){.navbar-left{float:left !important}.navbar-right{float:right !important;margin-right:-15px}.navbar-right~.navbar-right{margin-right:0}}.navbar-default{background-color:#f8f8f8;border-color:#e7e7e7}.navbar-default .navbar-brand{color:#777}.navbar-default .navbar-brand:hover,.navbar-default .navbar-brand:focus{color:#5e5e5e;background-color:transparent}.navbar-default .navbar-text{color:#777}.navbar-default .navbar-nav>li>a{color:#777}.navbar-default .navbar-nav>li>a:hover,.navbar-default .navbar-nav>li>a:focus{color:#333;background-color:transparent}.navbar-default .navbar-nav>.active>a,.navbar-default .navbar-nav>.active>a:hover,.navbar-default .navbar-nav>.active>a:focus{color:#555;background-color:#e7e7e7}.navbar-default .navbar-nav>.disabled>a,.navbar-default .navbar-nav>.disabled>a:hover,.navbar-default .navbar-nav>.disabled>a:focus{color:#ccc;background-color:transparent}.navbar-default .navbar-toggle{border-color:#ddd}.navbar-default .navbar-toggle:hover,.navbar-default .navbar-toggle:focus{background-color:#ddd}.navbar-default .navbar-toggle .icon-bar{background-color:#888}.navbar-default .navbar-collapse,.navbar-default .navbar-form{border-color:#e7e7e7}.navbar-default .navbar-nav>.open>a,.navbar-default .navbar-nav>.open>a:hover,.navbar-default .navbar-nav>.open>a:focus{background-color:#e7e7e7;color:#555}@media (max-width:767px){.navbar-default .navbar-nav .open .dropdown-menu>li>a{color:#777}.navbar-default .navbar-nav .open .dropdown-menu>li>a:hover,.navbar-default .navbar-nav .open .dropdown-menu>li>a:focus{color:#333;background-color:transparent}.navbar-default .navbar-nav .open .dropdown-menu>.active>a,.navbar-default .navbar-nav .open .dropdown-menu>.active>a:hover,.navbar-default .navbar-nav .open .dropdown-menu>.active>a:focus{color:#555;background-color:#e7e7e7}.navbar-default .navbar-nav .open .dropdown-menu>.disabled>a,.navbar-default .navbar-nav .open .dropdown-menu>.disabled>a:hover,.navbar-default .navbar-nav .open .dropdown-menu>.disabled>a:focus{color:#ccc;background-color:transparent}}.navbar-default .navbar-link{color:#777}.navbar-default .navbar-link:hover{color:#333}.navbar-default .btn-link{color:#777}.navbar-default .btn-link:hover,.navbar-default .btn-link:focus{color:#333}.navbar-default .btn-link\[disabled\]:hover,fieldset\[disabled\] .navbar-default .btn-link:hover,.navbar-default .btn-link\[disabled\]:focus,fieldset\[disabled\] .navbar-default .btn-link:focus{color:#ccc}.navbar-inverse{background-color:#222;border-color:#080808}.navbar-inverse .navbar-brand{color:#777}.navbar-inverse .navbar-brand:hover,.navbar-inverse .navbar-brand:focus{color:#fff;background-color:transparent}.navbar-inverse .navbar-text{color:#777}.navbar-inverse .navbar-nav>li>a{color:#777}.navbar-inverse .navbar-nav>li>a:hover,.navbar-inverse .navbar-nav>li>a:focus{color:#fff;background-color:transparent}.navbar-inverse .navbar-nav>.active>a,.navbar-inverse .navbar-nav>.active>a:hover,.navbar-inverse .navbar-nav>.active>a:focus{color:#fff;background-color:#080808}.navbar-inverse .navbar-nav>.disabled>a,.navbar-inverse .navbar-nav>.disabled>a:hover,.navbar-inverse .navbar-nav>.disabled>a:focus{color:#444;background-color:transparent}.navbar-inverse .navbar-toggle{border-color:#333}.navbar-inverse .navbar-toggle:hover,.navbar-inverse .navbar-toggle:focus{background-color:#333}.navbar-inverse .navbar-toggle .icon-bar{background-color:#fff}.navbar-inverse .navbar-collapse,.navbar-inverse .navbar-form{border-color:#101010}.navbar-inverse .navbar-nav>.open>a,.navbar-inverse .navbar-nav>.open>a:hover,.navbar-inverse .navbar-nav>.open>a:focus{background-color:#080808;color:#fff}@media (max-width:767px){.navbar-inverse .navbar-nav .open .dropdown-menu>.dropdown-header{border-color:#080808}.navbar-inverse .navbar-nav .open .dropdown-menu .divider{background-color:#080808}.navbar-inverse .navbar-nav .open .dropdown-menu>li>a{color:#777}.navbar-inverse .navbar-nav .open .dropdown-menu>li>a:hover,.navbar-inverse .navbar-nav .open .dropdown-menu>li>a:focus{color:#fff;background-color:transparent}.navbar-inverse .navbar-nav .open .dropdown-menu>.active>a,.navbar-inverse .navbar-nav .open .dropdown-menu>.active>a:hover,.navbar-inverse .navbar-nav .open .dropdown-menu>.active>a:focus{color:#fff;background-color:#080808}.navbar-inverse .navbar-nav .open .dropdown-menu>.disabled>a,.navbar-inverse .navbar-nav .open .dropdown-menu>.disabled>a:hover,.navbar-inverse .navbar-nav .open .dropdown-menu>.disabled>a:focus{color:#444;background-color:transparent}}.navbar-inverse .navbar-link{color:#777}.navbar-inverse .navbar-link:hover{color:#fff}.navbar-inverse .btn-link{color:#777}.navbar-inverse .btn-link:hover,.navbar-inverse .btn-link:focus{color:#fff}.navbar-inverse .btn-link\[disabled\]:hover,fieldset\[disabled\] .navbar-inverse .btn-link:hover,.navbar-inverse .btn-link\[disabled\]:focus,fieldset\[disabled\] .navbar-inverse .btn-link:focus{color:#444}.label{display:inline;padding:.2em .6em .3em;font-size:75%;font-weight:bold;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:baseline;border-radius:.25em}a.label:hover,a.label:focus{color:#fff;text-decoration:none;cursor:pointer}.label:empty{display:none}.btn .label{position:relative;top:-1px}.label-default{background-color:#777}.label-default\[href\]:hover,.label-default\[href\]:focus{background-color:#5e5e5e}.label-primary{background-color:#428bca}.label-primary\[href\]:hover,.label-primary\[href\]:focus{background-color:#3071a9}.label-success{background-color:#5cb85c}.label-success\[href\]:hover,.label-success\[href\]:focus{background-color:#449d44}.label-info{background-color:#5bc0de}.label-info\[href\]:hover,.label-info\[href\]:focus{background-color:#31b0d5}.label-warning{background-color:#f0ad4e}.label-warning\[href\]:hover,.label-warning\[href\]:focus{background-color:#ec971f}.label-danger{background-color:#d9534f}.label-danger\[href\]:hover,.label-danger\[href\]:focus{background-color:#c9302c}.badge{display:inline-block;min-width:10px;padding:3px 7px;font-size:12px;font-weight:bold;color:#fff;line-height:1;vertical-align:middle;white-space:nowrap;text-align:center;background-color:#777;border-radius:10px}.badge:empty{display:none}.btn .badge{position:relative;top:-1px}.btn-xs .badge,.btn-group-xs>.btn .badge{top:0;padding:1px 5px}a.badge:hover,a.badge:focus{color:#fff;text-decoration:none;cursor:pointer}.list-group-item.active>.badge,.nav-pills>.active>a>.badge{color:#428bca;background-color:#fff}.list-group-item>.badge{float:right}.list-group-item>.badge+.badge{margin-right:5px}.nav-pills>li>a>.badge{margin-left:3px}.alert{padding:15px;margin-bottom:20px;border:1px solid transparent;border-radius:4px}.alert h4{margin-top:0;color:inherit}.alert .alert-link{font-weight:bold}.alert>p,.alert>ul{margin-bottom:0}.alert>p+p{margin-top:5px}.alert-dismissable,.alert-dismissible{padding-right:35px}.alert-dismissable .close,.alert-dismissible .close{position:relative;top:-2px;right:-21px;color:inherit}.alert-success{background-color:#dff0d8;border-color:#d6e9c6;color:#3c763d}.alert-success hr{border-top-color:#c9e2b3}.alert-success .alert-link{color:#2b542c}.alert-info{background-color:#d9edf7;border-color:#bce8f1;color:#31708f}.alert-info hr{border-top-color:#a6e1ec}.alert-info .alert-link{color:#245269}.alert-warning{background-color:#fcf8e3;border-color:#faebcc;color:#8a6d3b}.alert-warning hr{border-top-color:#f7e1b5}.alert-warning .alert-link{color:#66512c}.alert-danger{background-color:#f2dede;border-color:#ebccd1;color:#a94442}.alert-danger hr{border-top-color:#e4b9c0}.alert-danger .alert-link{color:#843534}@-webkit-keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}@-o-keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}@keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}.progress{overflow:hidden;height:20px;margin-bottom:20px;background-color:#f5f5f5;border-radius:4px;-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1)}.progress-bar{float:left;width:0%;height:100%;font-size:12px;line-height:20px;color:#fff;text-align:center;background-color:#428bca;-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);-webkit-transition:width .6s ease;-o-transition:width .6s ease;transition:width .6s ease}.progress-striped .progress-bar,.progress-bar-striped{background-image:-webkit-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:-o-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);-webkit-background-size:40px 40px;background-size:40px 40px}.progress.active .progress-bar,.progress-bar.active{-webkit-animation:progress-bar-stripes 2s linear infinite;-o-animation:progress-bar-stripes 2s linear infinite;animation:progress-bar-stripes 2s linear infinite}.progress-bar-success{background-color:#5cb85c}.progress-striped .progress-bar-success{background-image:-webkit-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:-o-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent)}.progress-bar-info{background-color:#5bc0de}.progress-striped .progress-bar-info{background-image:-webkit-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:-o-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent)}.progress-bar-warning{background-color:#f0ad4e}.progress-striped .progress-bar-warning{background-image:-webkit-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:-o-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent)}.progress-bar-danger{background-color:#d9534f}.progress-striped .progress-bar-danger{background-image:-webkit-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:-o-linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);background-image:linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent)}.panel{margin-bottom:20px;background-color:#fff;border:1px solid transparent;border-radius:4px;-webkit-box-shadow:0 1px 1px rgba(0,0,0,0.05);box-shadow:0 1px 1px rgba(0,0,0,0.05)}.panel-body{padding:15px}.panel-heading{padding:10px 15px;border-bottom:1px solid transparent;border-top-right-radius:3px;border-top-left-radius:3px}.panel-heading>.dropdown .dropdown-toggle{color:inherit}.panel-title{margin-top:0;margin-bottom:0;font-size:16px;color:inherit}.panel-title>a,.panel-title>small,.panel-title>.small,.panel-title>small>a,.panel-title>.small>a{color:inherit}.panel-footer{padding:10px 15px;background-color:#f5f5f5;border-top:1px solid #ddd;border-bottom-right-radius:3px;border-bottom-left-radius:3px}.panel>.list-group,.panel>.panel-collapse>.list-group{margin-bottom:0}.panel>.list-group .list-group-item,.panel>.panel-collapse>.list-group .list-group-item{border-width:1px 0;border-radius:0}.panel>.list-group:first-child .list-group-item:first-child,.panel>.panel-collapse>.list-group:first-child .list-group-item:first-child{border-top:0;border-top-right-radius:3px;border-top-left-radius:3px}.panel>.list-group:last-child .list-group-item:last-child,.panel>.panel-collapse>.list-group:last-child .list-group-item:last-child{border-bottom:0;border-bottom-right-radius:3px;border-bottom-left-radius:3px}.panel>.panel-heading+.panel-collapse>.list-group .list-group-item:first-child{border-top-right-radius:0;border-top-left-radius:0}.panel-heading+.list-group .list-group-item:first-child{border-top-width:0}.list-group+.panel-footer{border-top-width:0}.panel>.table,.panel>.table-responsive>.table,.panel>.panel-collapse>.table{margin-bottom:0}.panel>.table caption,.panel>.table-responsive>.table caption,.panel>.panel-collapse>.table caption{padding-left:15px;padding-right:15px}.panel>.table:first-child,.panel>.table-responsive:first-child>.table:first-child{border-top-right-radius:3px;border-top-left-radius:3px}.panel>.table:first-child>thead:first-child>tr:first-child,.panel>.table-responsive:first-child>.table:first-child>thead:first-child>tr:first-child,.panel>.table:first-child>tbody:first-child>tr:first-child,.panel>.table-responsive:first-child>.table:first-child>tbody:first-child>tr:first-child{border-top-left-radius:3px;border-top-right-radius:3px}.panel>.table:first-child>thead:first-child>tr:first-child td:first-child,.panel>.table-responsive:first-child>.table:first-child>thead:first-child>tr:first-child td:first-child,.panel>.table:first-child>tbody:first-child>tr:first-child td:first-child,.panel>.table-responsive:first-child>.table:first-child>tbody:first-child>tr:first-child td:first-child,.panel>.table:first-child>thead:first-child>tr:first-child th:first-child,.panel>.table-responsive:first-child>.table:first-child>thead:first-child>tr:first-child th:first-child,.panel>.table:first-child>tbody:first-child>tr:first-child th:first-child,.panel>.table-responsive:first-child>.table:first-child>tbody:first-child>tr:first-child th:first-child{border-top-left-radius:3px}.panel>.table:first-child>thead:first-child>tr:first-child td:last-child,.panel>.table-responsive:first-child>.table:first-child>thead:first-child>tr:first-child td:last-child,.panel>.table:first-child>tbody:first-child>tr:first-child td:last-child,.panel>.table-responsive:first-child>.table:first-child>tbody:first-child>tr:first-child td:last-child,.panel>.table:first-child>thead:first-child>tr:first-child th:last-child,.panel>.table-responsive:first-child>.table:first-child>thead:first-child>tr:first-child th:last-child,.panel>.table:first-child>tbody:first-child>tr:first-child th:last-child,.panel>.table-responsive:first-child>.table:first-child>tbody:first-child>tr:first-child th:last-child{border-top-right-radius:3px}.panel>.table:last-child,.panel>.table-responsive:last-child>.table:last-child{border-bottom-right-radius:3px;border-bottom-left-radius:3px}.panel>.table:last-child>tbody:last-child>tr:last-child,.panel>.table-responsive:last-child>.table:last-child>tbody:last-child>tr:last-child,.panel>.table:last-child>tfoot:last-child>tr:last-child,.panel>.table-responsive:last-child>.table:last-child>tfoot:last-child>tr:last-child{border-bottom-left-radius:3px;border-bottom-right-radius:3px}.panel>.table:last-child>tbody:last-child>tr:last-child td:first-child,.panel>.table-responsive:last-child>.table:last-child>tbody:last-child>tr:last-child td:first-child,.panel>.table:last-child>tfoot:last-child>tr:last-child td:first-child,.panel>.table-responsive:last-child>.table:last-child>tfoot:last-child>tr:last-child td:first-child,.panel>.table:last-child>tbody:last-child>tr:last-child th:first-child,.panel>.table-responsive:last-child>.table:last-child>tbody:last-child>tr:last-child th:first-child,.panel>.table:last-child>tfoot:last-child>tr:last-child th:first-child,.panel>.table-responsive:last-child>.table:last-child>tfoot:last-child>tr:last-child th:first-child{border-bottom-left-radius:3px}.panel>.table:last-child>tbody:last-child>tr:last-child td:last-child,.panel>.table-responsive:last-child>.table:last-child>tbody:last-child>tr:last-child td:last-child,.panel>.table:last-child>tfoot:last-child>tr:last-child td:last-child,.panel>.table-responsive:last-child>.table:last-child>tfoot:last-child>tr:last-child td:last-child,.panel>.table:last-child>tbody:last-child>tr:last-child th:last-child,.panel>.table-responsive:last-child>.table:last-child>tbody:last-child>tr:last-child th:last-child,.panel>.table:last-child>tfoot:last-child>tr:last-child th:last-child,.panel>.table-responsive:last-child>.table:last-child>tfoot:last-child>tr:last-child th:last-child{border-bottom-right-radius:3px}.panel>.panel-body+.table,.panel>.panel-body+.table-responsive,.panel>.table+.panel-body,.panel>.table-responsive+.panel-body{border-top:1px solid #ddd}.panel>.table>tbody:first-child>tr:first-child th,.panel>.table>tbody:first-child>tr:first-child td{border-top:0}.panel>.table-bordered,.panel>.table-responsive>.table-bordered{border:0}.panel>.table-bordered>thead>tr>th:first-child,.panel>.table-responsive>.table-bordered>thead>tr>th:first-child,.panel>.table-bordered>tbody>tr>th:first-child,.panel>.table-responsive>.table-bordered>tbody>tr>th:first-child,.panel>.table-bordered>tfoot>tr>th:first-child,.panel>.table-responsive>.table-bordered>tfoot>tr>th:first-child,.panel>.table-bordered>thead>tr>td:first-child,.panel>.table-responsive>.table-bordered>thead>tr>td:first-child,.panel>.table-bordered>tbody>tr>td:first-child,.panel>.table-responsive>.table-bordered>tbody>tr>td:first-child,.panel>.table-bordered>tfoot>tr>td:first-child,.panel>.table-responsive>.table-bordered>tfoot>tr>td:first-child{border-left:0}.panel>.table-bordered>thead>tr>th:last-child,.panel>.table-responsive>.table-bordered>thead>tr>th:last-child,.panel>.table-bordered>tbody>tr>th:last-child,.panel>.table-responsive>.table-bordered>tbody>tr>th:last-child,.panel>.table-bordered>tfoot>tr>th:last-child,.panel>.table-responsive>.table-bordered>tfoot>tr>th:last-child,.panel>.table-bordered>thead>tr>td:last-child,.panel>.table-responsive>.table-bordered>thead>tr>td:last-child,.panel>.table-bordered>tbody>tr>td:last-child,.panel>.table-responsive>.table-bordered>tbody>tr>td:last-child,.panel>.table-bordered>tfoot>tr>td:last-child,.panel>.table-responsive>.table-bordered>tfoot>tr>td:last-child{border-right:0}.panel>.table-bordered>thead>tr:first-child>td,.panel>.table-responsive>.table-bordered>thead>tr:first-child>td,.panel>.table-bordered>tbody>tr:first-child>td,.panel>.table-responsive>.table-bordered>tbody>tr:first-child>td,.panel>.table-bordered>thead>tr:first-child>th,.panel>.table-responsive>.table-bordered>thead>tr:first-child>th,.panel>.table-bordered>tbody>tr:first-child>th,.panel>.table-responsive>.table-bordered>tbody>tr:first-child>th{border-bottom:0}.panel>.table-bordered>tbody>tr:last-child>td,.panel>.table-responsive>.table-bordered>tbody>tr:last-child>td,.panel>.table-bordered>tfoot>tr:last-child>td,.panel>.table-responsive>.table-bordered>tfoot>tr:last-child>td,.panel>.table-bordered>tbody>tr:last-child>th,.panel>.table-responsive>.table-bordered>tbody>tr:last-child>th,.panel>.table-bordered>tfoot>tr:last-child>th,.panel>.table-responsive>.table-bordered>tfoot>tr:last-child>th{border-bottom:0}.panel>.table-responsive{border:0;margin-bottom:0}.panel-group{margin-bottom:20px}.panel-group .panel{margin-bottom:0;border-radius:4px}.panel-group .panel+.panel{margin-top:5px}.panel-group .panel-heading{border-bottom:0}.panel-group .panel-heading+.panel-collapse>.panel-body,.panel-group .panel-heading+.panel-collapse>.list-group{border-top:1px solid #ddd}.panel-group .panel-footer{border-top:0}.panel-group .panel-footer+.panel-collapse .panel-body{border-bottom:1px solid #ddd}.panel-default{border-color:#ddd}.panel-default>.panel-heading{color:#333;background-color:#f5f5f5;border-color:#ddd}.panel-default>.panel-heading+.panel-collapse>.panel-body{border-top-color:#ddd}.panel-default>.panel-heading .badge{color:#f5f5f5;background-color:#333}.panel-default>.panel-footer+.panel-collapse>.panel-body{border-bottom-color:#ddd}.panel-primary{border-color:#428bca}.panel-primary>.panel-heading{color:#fff;background-color:#428bca;border-color:#428bca}.panel-primary>.panel-heading+.panel-collapse>.panel-body{border-top-color:#428bca}.panel-primary>.panel-heading .badge{color:#428bca;background-color:#fff}.panel-primary>.panel-footer+.panel-collapse>.panel-body{border-bottom-color:#428bca}.panel-success{border-color:#d6e9c6}.panel-success>.panel-heading{color:#3c763d;background-color:#dff0d8;border-color:#d6e9c6}.panel-success>.panel-heading+.panel-collapse>.panel-body{border-top-color:#d6e9c6}.panel-success>.panel-heading .badge{color:#dff0d8;background-color:#3c763d}.panel-success>.panel-footer+.panel-collapse>.panel-body{border-bottom-color:#d6e9c6}.panel-info{border-color:#bce8f1}.panel-info>.panel-heading{color:#31708f;background-color:#d9edf7;border-color:#bce8f1}.panel-info>.panel-heading+.panel-collapse>.panel-body{border-top-color:#bce8f1}.panel-info>.panel-heading .badge{color:#d9edf7;background-color:#31708f}.panel-info>.panel-footer+.panel-collapse>.panel-body{border-bottom-color:#bce8f1}.panel-warning{border-color:#faebcc}.panel-warning>.panel-heading{color:#8a6d3b;background-color:#fcf8e3;border-color:#faebcc}.panel-warning>.panel-heading+.panel-collapse>.panel-body{border-top-color:#faebcc}.panel-warning>.panel-heading .badge{color:#fcf8e3;background-color:#8a6d3b}.panel-warning>.panel-footer+.panel-collapse>.panel-body{border-bottom-color:#faebcc}.panel-danger{border-color:#ebccd1}.panel-danger>.panel-heading{color:#a94442;background-color:#f2dede;border-color:#ebccd1}.panel-danger>.panel-heading+.panel-collapse>.panel-body{border-top-color:#ebccd1}.panel-danger>.panel-heading .badge{color:#f2dede;background-color:#a94442}.panel-danger>.panel-footer+.panel-collapse>.panel-body{border-bottom-color:#ebccd1}.modal-open{overflow:hidden}.modal{display:none;overflow:hidden;position:fixed;top:0;right:0;bottom:0;left:0;z-index:1050;-webkit-overflow-scrolling:touch;outline:0}.modal.fade .modal-dialog{-webkit-transform:translate(0, -25%);-ms-transform:translate(0, -25%);-o-transform:translate(0, -25%);transform:translate(0, -25%);-webkit-transition:-webkit-transform 0.3s ease-out;-o-transition:-o-transform 0.3s ease-out;transition:transform 0.3s ease-out}.modal.in .modal-dialog{-webkit-transform:translate(0, 0);-ms-transform:translate(0, 0);-o-transform:translate(0, 0);transform:translate(0, 0)}.modal-open .modal{overflow-x:hidden;overflow-y:auto}.modal-dialog{position:relative;width:auto;margin:10px}.modal-content{position:relative;background-color:#fff;border:1px solid #999;border:1px solid rgba(0,0,0,0.2);border-radius:6px;-webkit-box-shadow:0 3px 9px rgba(0,0,0,0.5);box-shadow:0 3px 9px rgba(0,0,0,0.5);-webkit-background-clip:padding-box;background-clip:padding-box;outline:0}.modal-backdrop{position:fixed;top:0;right:0;bottom:0;left:0;z-index:1040;background-color:#000}.modal-backdrop.fade{opacity:0;filter:alpha(opacity=0)}.modal-backdrop.in{opacity:.5;filter:alpha(opacity=50)}.modal-header{padding:15px;border-bottom:1px solid #e5e5e5}.modal-header .close{margin-top:-2px}.modal-title{margin:0;line-height:1.42857143}.modal-body{position:relative;padding:15px}.modal-footer{padding:15px;text-align:right;border-top:1px solid #e5e5e5}.modal-footer .btn+.btn{margin-left:5px;margin-bottom:0}.modal-footer .btn-group .btn+.btn{margin-left:-1px}.modal-footer .btn-block+.btn-block{margin-left:0}.modal-scrollbar-measure{position:absolute;top:-9999px;width:50px;height:50px;overflow:scroll}@media (min-width:768px){.modal-dialog{width:600px;margin:30px auto}.modal-content{-webkit-box-shadow:0 5px 15px rgba(0,0,0,0.5);box-shadow:0 5px 15px rgba(0,0,0,0.5)}.modal-sm{width:300px}}@media (min-width:992px){.modal-lg{width:900px}}.clearfix:before,.clearfix:after,.dl-horizontal dd:before,.dl-horizontal dd:after,.container:before,.container:after,.container-fluid:before,.container-fluid:after,.row:before,.row:after,.form-horizontal .form-group:before,.form-horizontal .form-group:after,.btn-toolbar:before,.btn-toolbar:after,.btn-group-vertical>.btn-group:before,.btn-group-vertical>.btn-group:after,.nav:before,.nav:after,.navbar:before,.navbar:after,.navbar-header:before,.navbar-header:after,.navbar-collapse:before,.navbar-collapse:after,.panel-body:before,.panel-body:after,.modal-header:before,.modal-header:after,.modal-footer:before,.modal-footer:after{content:" ";display:table}.clearfix:after,.dl-horizontal dd:after,.container:after,.container-fluid:after,.row:after,.form-horizontal .form-group:after,.btn-toolbar:after,.btn-group-vertical>.btn-group:after,.nav:after,.navbar:after,.navbar-header:after,.navbar-collapse:after,.panel-body:after,.modal-header:after,.modal-footer:after{clear:both}.center-block{display:block;margin-left:auto;margin-right:auto}.pull-right{float:right !important}.pull-left{float:left !important}.hide{display:none !important}.show{display:block !important}.invisible{visibility:hidden}.text-hide{font:0/0 a;color:transparent;text-shadow:none;background-color:transparent;border:0}.hidden{display:none !important}.affix{position:fixed}@-ms-viewport{width:device-width}.visible-xs,.visible-sm,.visible-md,.visible-lg{display:none !important}.visible-xs-block,.visible-xs-inline,.visible-xs-inline-block,.visible-sm-block,.visible-sm-inline,.visible-sm-inline-block,.visible-md-block,.visible-md-inline,.visible-md-inline-block,.visible-lg-block,.visible-lg-inline,.visible-lg-inline-block{display:none !important}@media (max-width:767px){.visible-xs{display:block !important}table.visible-xs{display:table !important}tr.visible-xs{display:table-row !important}th.visible-xs,td.visible-xs{display:table-cell !important}}@media (max-width:767px){.visible-xs-block{display:block !important}}@media (max-width:767px){.visible-xs-inline{display:inline !important}}@media (max-width:767px){.visible-xs-inline-block{display:inline-block !important}}@media (min-width:768px) and (max-width:991px){.visible-sm{display:block !important}table.visible-sm{display:table !important}tr.visible-sm{display:table-row !important}th.visible-sm,td.visible-sm{display:table-cell !important}}@media (min-width:768px) and (max-width:991px){.visible-sm-block{display:block !important}}@media (min-width:768px) and (max-width:991px){.visible-sm-inline{display:inline !important}}@media (min-width:768px) and (max-width:991px){.visible-sm-inline-block{display:inline-block !important}}@media (min-width:992px) and (max-width:1199px){.visible-md{display:block !important}table.visible-md{display:table !important}tr.visible-md{display:table-row !important}th.visible-md,td.visible-md{display:table-cell !important}}@media (min-width:992px) and (max-width:1199px){.visible-md-block{display:block !important}}@media (min-width:992px) and (max-width:1199px){.visible-md-inline{display:inline !important}}@media (min-width:992px) and (max-width:1199px){.visible-md-inline-block{display:inline-block !important}}@media (min-width:1200px){.visible-lg{display:block !important}table.visible-lg{display:table !important}tr.visible-lg{display:table-row !important}th.visible-lg,td.visible-lg{display:table-cell !important}}@media (min-width:1200px){.visible-lg-block{display:block !important}}@media (min-width:1200px){.visible-lg-inline{display:inline !important}}@media (min-width:1200px){.visible-lg-inline-block{display:inline-block !important}}@media (max-width:767px){.hidden-xs{display:none !important}}@media (min-width:768px) and (max-width:991px){.hidden-sm{display:none !important}}@media (min-width:992px) and (max-width:1199px){.hidden-md{display:none !important}}@media (min-width:1200px){.hidden-lg{display:none !important}}.visible-print{display:none !important}@media print{.visible-print{display:block !important}table.visible-print{display:table !important}tr.visible-print{display:table-row !important}th.visible-print,td.visible-print{display:table-cell !important}}.visible-print-block{display:none !important}@media print{.visible-print-block{display:block !important}}.visible-print-inline{display:none !important}@media print{.visible-print-inline{display:inline !important}}.visible-print-inline-block{display:none !important}@media print{.visible-print-inline-block{display:inline-block !important}}@media print{.hidden-print{display:none !important}}table.treetable span.indenter{display:inline-block;text-align:right;user-select:none;-khtml-user-select:none;-moz-user-select:none;-o-user-select:none;-webkit-user-select:none;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;width:19px;margin:0;padding:0;}table.treetable span.indenter a{background-position:left center;background-repeat:no-repeat;display:inline-block;text-decoration:none;width:19px;}table.treetable tr.collapsed span.indenter a{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAHlJREFUeNrcU1sNgDAQ6wgmcAM2MICGGlg1gJnNzWQcvwQGy1j4oUl/7tH0mpwzM7SgQyO+EZAUWh2MkkzSWhJwuRAlHYsJwEwyvs1gABDuzqoJcTw5qxaIJN0bgQRgIjnlmn1heSO5PE6Y2YXe+5Cr5+h++gs12AcAS6FS+7YOsj4AAAAASUVORK5CYII=);}table.treetable tr.expanded span.indenter a{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAHFJREFUeNpi/P//PwMlgImBQsA44C6gvhfa29v3MzAwOODRc6CystIRbxi0t7fjDJjKykpGYrwwi1hxnLHQ3t7+jIGBQRJJ6HllZaUUKYEYRYBPOB0gBShKwKGA////48VtbW3/8clTnBIH3gCKkzJgAGvBX0dDm0sCAAAAAElFTkSuQmCC);}table.treetable tr.branch{background-color:#f9f9f9;}table.treetable tr.selected{background-color:#3875d7;color:#fff;}table.treetable tr span.indenter a{outline:none;}tr.rule-overview-needs-attention td a{color:#d9534f;}td.rule-result div,span.rule-result{text-align:center;font-weight:700;color:#fff;background:gray;}td.rule-result-unknown div,span.rule-result-unknown{background:#f0ad4e;}.js-only{display:none;}.rule-detail-fail,.rule-detail-error,.rule-detail-unknown{border:2px solid #d9534f;}#footer{text-align:center;margin-top:50px;}pre{overflow:auto!important;word-wrap:normal!important;white-space:pre-wrap;}div.check-system-details,div.remediation,div.description{display:inline-block;width:0;min-width:100%;overflow-x:auto;}div.profile-description{white-space:pre-wrap;}div.modal-body{margin:50px;padding:0;}div.horizontal-scroll{overflow-x:auto;}div.top-spacer-10{margin-top:10px;}td.rule-result-fail div,span.rule-result-fail,td.rule-result-error div,span.rule-result-error{background:#d9534f;}td.rule-result-pass div,span.rule-result-pass,td.rule-result-fixed div,span.rule-result-fixed{background:#5cb85c;}.rule-result-filtered,.rule-result-filtered > \*,.search-no-match,.search-no-match > \*{display:none!important;}@media print{.container{width:100%;}.rule-result abbr\[title\]:after,.identifiers abbr\[title\]:after,.identifiers a\[href\]:after{content:"";}} /\*! jQuery v1.12.4 | (c) jQuery Foundation | jquery.org/license \*/ !function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=\[\],d=a.document,e=c.slice,f=c.concat,g=c.push,h=c.indexOf,i={},j=i.toString,k=i.hasOwnProperty,l={},m="1.12.4",n=function(a,b){return new n.fn.init(a,b)},o=/^\[\\s\\uFEFF\\xA0\]+|\[\\s\\uFEFF\\xA0\]+$/g,p=/^-ms-/,q=/-(\[\\da-z\])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return e.call(this)},get:function(a){return null!=a?0>a?this\[a+this.length\]:this\[a\]:e.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a){return n.each(this,a)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(e.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?\[this\[c\]\]:\[\])},end:function(){return this.prevObject||this.constructor()},push:g,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments\[0\]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments\[h\]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(e=arguments\[h\]))for(d in e)a=g\[d\],c=e\[d\],g!==c&&(j&&c&&(n.isPlainObject(c)||(b=n.isArray(c)))?(b?(b=!1,f=a&&n.isArray(a)?a:\[\]):f=a&&n.isPlainObject(a)?a:{},g\[d\]=n.extend(j,f,c)):void 0!==c&&(g\[d\]=c));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray||function(a){return"array"===n.type(a)},isWindow:function(a){return null!=a&&a==a.window},isNumeric:function(a){var b=a&&a.toString();return!n.isArray(a)&&b-parseFloat(b)+1>=0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==n.type(a)||a.nodeType||n.isWindow(a))return!1;try{if(a.constructor&&!k.call(a,"constructor")&&!k.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}if(!l.ownFirst)for(b in a)return k.call(a,b);for(b in a);return void 0===b||k.call(a,b)},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?i\[j.call(a)\]||"object":typeof a},globalEval:function(b){b&&n.trim(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b){var c,d=0;if(s(a)){for(c=a.length;c>d;d++)if(b.call(a\[d\],d,a\[d\])===!1)break}else for(d in a)if(b.call(a\[d\],d,a\[d\])===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||\[\];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?\[a\]:a):g.call(c,a)),c},inArray:function(a,b,c){var d;if(b){if(h)return h.call(b,a,c);for(d=b.length,c=c?0>c?Math.max(0,d+c):c:0;d>c;c++)if(c in b&&b\[c\]===a)return c}return-1},merge:function(a,b){var c=+b.length,d=0,e=a.length;while(c>d)a\[e++\]=b\[d++\];if(c!==c)while(void 0!==b\[d\])a\[e++\]=b\[d++\];return a.length=e,a},grep:function(a,b,c){for(var d,e=\[\],f=0,g=a.length,h=!c;g>f;f++)d=!b(a\[f\],f),d!==h&&e.push(a\[f\]);return e},map:function(a,b,c){var d,e,g=0,h=\[\];if(s(a))for(d=a.length;d>g;g++)e=b(a\[g\],g,c),null!=e&&h.push(e);else for(g in a)e=b(a\[g\],g,c),null!=e&&h.push(e);return f.apply(\[\],h)},guid:1,proxy:function(a,b){var c,d,f;return"string"==typeof b&&(f=a\[b\],b=a,a=f),n.isFunction(a)?(c=e.call(arguments,2),d=function(){return a.apply(b||this,c.concat(e.call(arguments)))},d.guid=a.guid=a.guid||n.guid++,d):void 0},now:function(){return+new Date},support:l}),"function"==typeof Symbol&&(n.fn\[Symbol.iterator\]=c\[Symbol.iterator\]),n.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(a,b){i\["\[object "+b+"\]"\]=b.toLowerCase()});function s(a){var b=!!a&&"length"in a&&a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u="sizzle"+1\*new Date,v=a.document,w=0,x=0,y=ga(),z=ga(),A=ga(),B=function(a,b){return a===b&&(l=!0),0},C=1<<31,D={}.hasOwnProperty,E=\[\],F=E.pop,G=E.push,H=E.push,I=E.slice,J=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a\[c\]===b)return c;return-1},K="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="\[\\\\x20\\\\t\\\\r\\\\n\\\\f\]",M="(?:\\\\\\\\.|\[\\\\w-\]|\[^\\\\x00-\\\\xa0\])+",N="\\\\\["+L+"\*("+M+")(?:"+L+"\*(\[\*^$|!~\]?=)"+L+"\*(?:'((?:\\\\\\\\.|\[^\\\\\\\\'\])\*)'|\\"((?:\\\\\\\\.|\[^\\\\\\\\\\"\])\*)\\"|("+M+"))|)"+L+"\*\\\\\]",O=":("+M+")(?:\\\\((('((?:\\\\\\\\.|\[^\\\\\\\\'\])\*)'|\\"((?:\\\\\\\\.|\[^\\\\\\\\\\"\])\*)\\")|((?:\\\\\\\\.|\[^\\\\\\\\()\[\\\\\]\]|"+N+")\*)|.\*)\\\\)|)",P=new RegExp(L+"+","g"),Q=new RegExp("^"+L+"+|((?:^|\[^\\\\\\\\\])(?:\\\\\\\\.)\*)"+L+"+$","g"),R=new RegExp("^"+L+"\*,"+L+"\*"),S=new RegExp("^"+L+"\*(\[>+~\]|"+L+")"+L+"\*"),T=new RegExp("="+L+"\*(\[^\\\\\]'\\"\]\*?)"+L+"\*\\\\\]","g"),U=new RegExp(O),V=new RegExp("^"+M+"$"),W={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\\\.("+M+")"),TAG:new RegExp("^("+M+"|\[\*\])"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\\\("+L+"\*(even|odd|((\[+-\]|)(\\\\d\*)n|)"+L+"\*(?:(\[+-\]|)"+L+"\*(\\\\d+)|))"+L+"\*\\\\)|)","i"),bool:new RegExp("^(?:"+K+")$","i"),needsContext:new RegExp("^"+L+"\*\[>+~\]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\\\("+L+"\*((?:-\\\\d)?\\\\d\*)"+L+"\*\\\\)|)(?=\[^-\]|$)","i")},X=/^(?:input|select|textarea|button)$/i,Y=/^h\\d$/i,Z=/^\[^{\]+\\{\\s\*\\\[native \\w/,$=/^(?:#(\[\\w-\]+)|(\\w+)|\\.(\[\\w-\]+))$/,\_=/\[+~\]/,aa=/'|\\\\/g,ba=new RegExp("\\\\\\\\(\[\\\\da-f\]{1,6}"+L+"?|("+L+")|.)","ig"),ca=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},da=function(){m()};try{H.apply(E=I.call(v.childNodes),v.childNodes),E\[v.childNodes.length\].nodeType}catch(ea){H={apply:E.length?function(a,b){G.apply(a,I.call(b))}:function(a,b){var c=a.length,d=0;while(a\[c++\]=b\[d++\]);a.length=c-1}}}function fa(a,b,d,e){var f,h,j,k,l,o,r,s,w=b&&b.ownerDocument,x=b?b.nodeType:9;if(d=d||\[\],"string"!=typeof a||!a||1!==x&&9!==x&&11!==x)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==x&&(o=$.exec(a)))if(f=o\[1\]){if(9===x){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(w&&(j=w.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(o\[2\])return H.apply(d,b.getElementsByTagName(a)),d;if((f=o\[3\])&&c.getElementsByClassName&&b.getElementsByClassName)return H.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A\[a+" "\]&&(!q||!q.test(a))){if(1!==x)w=b,s=a;else if("object"!==b.nodeName.toLowerCase()){(k=b.getAttribute("id"))?k=k.replace(aa,"\\\\$&"):b.setAttribute("id",k=u),r=g(a),h=r.length,l=V.test(k)?"#"+k:"\[id='"+k+"'\]";while(h--)r\[h\]=l+" "+qa(r\[h\]);s=r.join(","),w=\_.test(a)&&oa(b.parentNode)||b}if(s)try{return H.apply(d,w.querySelectorAll(s)),d}catch(y){}finally{k===u&&b.removeAttribute("id")}}}return i(a.replace(Q,"$1"),b,d,e)}function ga(){var a=\[\];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b\[a.shift()\],b\[c+" "\]=e}return b}function ha(a){return a\[u\]=!0,a}function ia(a){var b=n.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ja(a,b){var c=a.split("|"),e=c.length;while(e--)d.attrHandle\[c\[e\]\]=b}function ka(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||C)-(~a.sourceIndex||C);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function la(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function na(a){return ha(function(b){return b=+b,ha(function(c,d){var e,f=a(\[\],c.length,b),g=f.length;while(g--)c\[e=f\[g\]\]&&(c\[e\]=!(d\[e\]=c\[e\]))})})}function oa(a){return a&&"undefined"!=typeof a.getElementsByTagName&&a}c=fa.support={},f=fa.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},m=fa.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener("unload",da,!1):e.attachEvent&&e.attachEvent("onunload",da)),c.attributes=ia(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=ia(function(a){return a.appendChild(n.createComment("")),!a.getElementsByTagName("\*").length}),c.getElementsByClassName=Z.test(n.getElementsByClassName),c.getById=ia(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if("undefined"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?\[c\]:\[\]}},d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){var c="undefined"!=typeof a.getAttributeNode&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return"undefined"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=\[\],e=0,f=b.getElementsByTagName(a);if("\*"===a){while(c=f\[e++\])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return"undefined"!=typeof b.getElementsByClassName&&p?b.getElementsByClassName(a):void 0},r=\[\],q=\[\],(c.qsa=Z.test(n.querySelectorAll))&&(ia(function(a){o.appendChild(a).innerHTML="<a id='"+u+"'></a><select id='"+u+"-\\r\\\\' msallowcapture=''><option selected=''></option></select>",a.querySelectorAll("\[msallowcapture^=''\]").length&&q.push("\[\*^$\]="+L+"\*(?:''|\\"\\")"),a.querySelectorAll("\[selected\]").length||q.push("\\\\\["+L+"\*(?:value|"+K+")"),a.querySelectorAll("\[id~="+u+"-\]").length||q.push("~="),a.querySelectorAll(":checked").length||q.push(":checked"),a.querySelectorAll("a#"+u+"+\*").length||q.push(".#.+\[+~\]")}),ia(function(a){var b=n.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("\[name=d\]").length&&q.push("name"+L+"\*\[\*^$|!~\]?="),a.querySelectorAll(":enabled").length||q.push(":enabled",":disabled"),a.querySelectorAll("\*,:x"),q.push(",.\*:")})),(c.matchesSelector=Z.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ia(function(a){c.disconnectedMatch=s.call(a,"div"),s.call(a,"\[s!=''\]:x"),r.push("!=",O)}),q=q.length&&new RegExp(q.join("|")),r=r.length&&new RegExp(r.join("|")),b=Z.test(o.compareDocumentPosition),t=b||Z.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?J(k,a)-J(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=\[a\],h=\[b\];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?J(k,a)-J(k,b):0;if(e===f)return ka(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g\[d\]===h\[d\])d++;return d?ka(g\[d\],h\[d\]):g\[d\]===v?-1:h\[d\]===v?1:0},n):n},fa.matches=function(a,b){return fa(a,null,null,b)},fa.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(T,"='$1'\]"),c.matchesSelector&&p&&!A\[b+" "\]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return fa(b,n,null,\[a\]).length>0},fa.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},fa.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle\[b.toLowerCase()\],f=e&&D.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},fa.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},fa.uniqueSort=function(a){var b,d=\[\],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a\[f++\])b===a\[f\]&&(e=d.push(f));while(e--)a.splice(d\[e\],1)}return k=null,a},e=fa.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a\[d++\])c+=e(b);return c},d=fa.selectors={cacheLength:50,createPseudo:ha,match:W,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a\[1\]=a\[1\].replace(ba,ca),a\[3\]=(a\[3\]||a\[4\]||a\[5\]||"").replace(ba,ca),"~="===a\[2\]&&(a\[3\]=" "+a\[3\]+" "),a.slice(0,4)},CHILD:function(a){return a\[1\]=a\[1\].toLowerCase(),"nth"===a\[1\].slice(0,3)?(a\[3\]||fa.error(a\[0\]),a\[4\]=+(a\[4\]?a\[5\]+(a\[6\]||1):2\*("even"===a\[3\]||"odd"===a\[3\])),a\[5\]=+(a\[7\]+a\[8\]||"odd"===a\[3\])):a\[3\]&&fa.error(a\[0\]),a},PSEUDO:function(a){var b,c=!a\[6\]&&a\[2\];return W.CHILD.test(a\[0\])?null:(a\[3\]?a\[2\]=a\[4\]||a\[5\]||"":c&&U.test(c)&&(b=g(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a\[0\]=a\[0\].slice(0,b),a\[2\]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ba,ca).toLowerCase();return"\*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y\[a+" "\];return b||(b=new RegExp("(^|"+L+")"+a+"("+L+"|$)"))&&y(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!=typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=fa.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"\*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e.replace(P," ")+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m\[p\])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=\[g?q.firstChild:q.lastChild\],g&&s){m=q,l=m\[u\]||(m\[u\]={}),k=l\[m.uniqueID\]||(l\[m.uniqueID\]={}),j=k\[a\]||\[\],n=j\[0\]===w&&j\[1\],t=n&&j\[2\],m=n&&q.childNodes\[n\];while(m=++n&&m&&m\[p\]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k\[a\]=\[w,n,t\];break}}else if(s&&(m=b,l=m\[u\]||(m\[u\]={}),k=l\[m.uniqueID\]||(l\[m.uniqueID\]={}),j=k\[a\]||\[\],n=j\[0\]===w&&j\[1\],t=n),t===!1)while(m=++n&&m&&m\[p\]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m\[u\]||(m\[u\]={}),k=l\[m.uniqueID\]||(l\[m.uniqueID\]={}),k\[a\]=\[w,t\]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos\[a\]||d.setFilters\[a.toLowerCase()\]||fa.error("unsupported pseudo: "+a);return e\[u\]?e(b):e.length>1?(c=\[a,a,"",b\],d.setFilters.hasOwnProperty(a.toLowerCase())?ha(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=J(a,f\[g\]),a\[d\]=!(c\[d\]=f\[g\])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ha(function(a){var b=\[\],c=\[\],d=h(a.replace(Q,"$1"));return d\[u\]?ha(function(a,b,c,e){var f,g=d(a,null,e,\[\]),h=a.length;while(h--)(f=g\[h\])&&(a\[h\]=!(b\[h\]=f))}):function(a,e,f){return b\[0\]=a,d(b,null,f,c),b\[0\]=null,!c.pop()}}),has:ha(function(a){return function(b){return fa(a,b).length>0}}),contains:ha(function(a){return a=a.replace(ba,ca),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ha(function(a){return V.test(a||"")||fa.error("unsupported lang: "+a),a=a.replace(ba,ca).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return Y.test(a.nodeName)},input:function(a){return X.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:na(function(){return\[0\]}),last:na(function(a,b){return\[b-1\]}),eq:na(function(a,b,c){return\[0>c?c+b:c\]}),even:na(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:na(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:na(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:na(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos\[b\]=la(b);for(b in{submit:!0,reset:!0})d.pseudos\[b\]=ma(b);function pa(){}pa.prototype=d.filters=d.pseudos,d.setFilters=new pa,g=fa.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z\[a+" "\];if(k)return b?0:k.slice(0);h=a,i=\[\],j=d.preFilter;while(h){c&&!(e=R.exec(h))||(e&&(h=h.slice(e\[0\].length)||h),i.push(f=\[\])),c=!1,(e=S.exec(h))&&(c=e.shift(),f.push({value:c,type:e\[0\].replace(Q," ")}),h=h.slice(c.length));for(g in d.filter)!(e=W\[g\].exec(h))||j\[g\]&&!(e=j\[g\](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?fa.error(a):z(a,i).slice(0)};function qa(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a\[b\].value;return d}function ra(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=x++;return b.first?function(b,c,f){while(b=b\[d\])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j,k=\[w,f\];if(g){while(b=b\[d\])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b\[d\])if(1===b.nodeType||e){if(j=b\[u\]||(b\[u\]={}),i=j\[b.uniqueID\]||(j\[b.uniqueID\]={}),(h=i\[d\])&&h\[0\]===w&&h\[1\]===f)return k\[2\]=h\[2\];if(i\[d\]=k,k\[2\]=a(b,c,g))return!0}}}function sa(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a\[e\](b,c,d))return!1;return!0}:a\[0\]}function ta(a,b,c){for(var d=0,e=b.length;e>d;d++)fa(a,b\[d\],c);return c}function ua(a,b,c,d,e){for(var f,g=\[\],h=0,i=a.length,j=null!=b;i>h;h++)(f=a\[h\])&&(c&&!c(f,d,e)||(g.push(f),j&&b.push(h)));return g}function va(a,b,c,d,e,f){return d&&!d\[u\]&&(d=va(d)),e&&!e\[u\]&&(e=va(e,f)),ha(function(f,g,h,i){var j,k,l,m=\[\],n=\[\],o=g.length,p=f||ta(b||"\*",h.nodeType?\[h\]:h,\[\]),q=!a||!f&&b?p:ua(p,m,a,h,i),r=c?e||(f?a:o||d)?\[\]:g:q;if(c&&c(q,r,h,i),d){j=ua(r,n),d(j,\[\],h,i),k=j.length;while(k--)(l=j\[k\])&&(r\[n\[k\]\]=!(q\[n\[k\]\]=l))}if(f){if(e||a){if(e){j=\[\],k=r.length;while(k--)(l=r\[k\])&&j.push(q\[k\]=l);e(null,r=\[\],j,i)}k=r.length;while(k--)(l=r\[k\])&&(j=e?J(f,l):m\[k\])>-1&&(f\[j\]=!(g\[j\]=l))}}else r=ua(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):H.apply(g,r)})}function wa(a){for(var b,c,e,f=a.length,g=d.relative\[a\[0\].type\],h=g||d.relative\[" "\],i=g?1:0,k=ra(function(a){return a===b},h,!0),l=ra(function(a){return J(b,a)>-1},h,!0),m=\[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}\];f>i;i++)if(c=d.relative\[a\[i\].type\])m=\[ra(sa(m),c)\];else{if(c=d.filter\[a\[i\].type\].apply(null,a\[i\].matches),c\[u\]){for(e=++i;f>e;e++)if(d.relative\[a\[e\].type\])break;return va(i>1&&sa(m),i>1&&qa(a.slice(0,i-1).concat({value:" "===a\[i-2\].type?"\*":""})).replace(Q,"$1"),c,e>i&&wa(a.slice(i,e)),f>e&&wa(a=a.slice(e)),f>e&&qa(a))}m.push(c)}return sa(m)}function xa(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s="0",t=f&&\[\],u=\[\],v=j,x=f||e&&d.find.TAG("\*",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x\[s\]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a\[o++\])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b\[o++\])q(t,u,g,h);if(f){if(r>0)while(s--)t\[s\]||u\[s\]||(u\[s\]=F.call(i));u=ua(u)}H.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&fa.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ha(f):f}return h=fa.compile=function(a,b){var c,d=\[\],e=\[\],f=A\[a+" "\];if(!f){b||(b=g(a)),c=b.length;while(c--)f=wa(b\[c\]),f\[u\]?d.push(f):e.push(f);f=A(a,xa(e,d)),f.selector=a}return f},i=fa.select=function(a,b,e,f){var i,j,k,l,m,n="function"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||\[\],1===o.length){if(j=o\[0\]=o\[0\].slice(0),j.length>2&&"ID"===(k=j\[0\]).type&&c.getById&&9===b.nodeType&&p&&d.relative\[j\[1\].type\]){if(b=(d.find.ID(k.matches\[0\].replace(ba,ca),b)||\[\])\[0\],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=W.needsContext.test(a)?0:j.length;while(i--){if(k=j\[i\],d.relative\[l=k.type\])break;if((m=d.find\[l\])&&(f=m(k.matches\[0\].replace(ba,ca),\_.test(j\[0\].type)&&oa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&qa(j),!a)return H.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||\_.test(a)&&oa(b.parentNode)||b),e},c.sortStable=u.split("").sort(B).join("")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ia(function(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),ia(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||ja("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&ia(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||ja("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),ia(function(a){return null==a.getAttribute("disabled")})||ja(K,function(a,b,c){var d;return c?void 0:a\[b\]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),fa}(a);n.find=t,n.expr=t.selectors,n.expr\[":"\]=n.expr.pseudos,n.uniqueSort=n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=function(a,b,c){var d=\[\],e=void 0!==c;while((a=a\[b\])&&9!==a.nodeType)if(1===a.nodeType){if(e&&n(a).is(c))break;d.push(a)}return d},v=function(a,b){for(var c=\[\];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},w=n.expr.match.needsContext,x=/^<(\[\\w-\]+)\\s\*\\/?>(?:<\\/\\1>|)$/,y=/^.\[^:#\\\[\\.,\]\*$/;function z(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(y.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return n.inArray(a,b)>-1!==c})}n.filter=function(a,b,c){var d=b\[0\];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?\[d\]:\[\]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a){var b,c=\[\],d=this,e=d.length;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;e>b;b++)if(n.contains(d\[b\],this))return!0}));for(b=0;e>b;b++)n.find(a,d\[b\],c);return c=this.pushStack(e>1?n.unique(c):c),c.selector=this.selector?this.selector+" "+a:a,c},filter:function(a){return this.pushStack(z(this,a||\[\],!1))},not:function(a){return this.pushStack(z(this,a||\[\],!0))},is:function(a){return!!z(this,"string"==typeof a&&w.test(a)?n(a):a||\[\],!1).length}});var A,B=/^(?:\\s\*(<\[\\w\\W\]+>)\[^>\]\*|#(\[\\w-\]\*))$/,C=n.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||A,"string"==typeof a){if(e="<"===a.charAt(0)&&">"===a.charAt(a.length-1)&&a.length>=3?\[null,a,null\]:B.exec(a),!e||!e\[1\]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e\[1\]){if(b=b instanceof n?b\[0\]:b,n.merge(this,n.parseHTML(e\[1\],b&&b.nodeType?b.ownerDocument||b:d,!0)),x.test(e\[1\])&&n.isPlainObject(b))for(e in b)n.isFunction(this\[e\])?this\[e\](b\[e\]):this.attr(e,b\[e\]);return this}if(f=d.getElementById(e\[2\]),f&&f.parentNode){if(f.id!==e\[2\])return A.find(a);this.length=1,this\[0\]=f}return this.context=d,this.selector=a,this}return a.nodeType?(this.context=this\[0\]=a,this.length=1,this):n.isFunction(a)?"undefined"!=typeof c.ready?c.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};C.prototype=n.fn,A=n(d);var D=/^(?:parents|prev(?:Until|All))/,E={children:!0,contents:!0,next:!0,prev:!0};n.fn.extend({has:function(a){var b,c=n(a,this),d=c.length;return this.filter(function(){for(b=0;d>b;b++)if(n.contains(this,c\[b\]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=\[\],g=w.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this\[d\];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.uniqueSort(f):f)},index:function(a){return a?"string"==typeof a?n.inArray(this\[0\],n(a)):n.inArray(a.jquery?a\[0\]:a,this):this\[0\]&&this\[0\].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.uniqueSort(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function F(a,b){do a=a\[b\];while(a&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return u(a,"parentNode")},parentsUntil:function(a,b,c){return u(a,"parentNode",c)},next:function(a){return F(a,"nextSibling")},prev:function(a){return F(a,"previousSibling")},nextAll:function(a){return u(a,"nextSibling")},prevAll:function(a){return u(a,"previousSibling")},nextUntil:function(a,b,c){return u(a,"nextSibling",c)},prevUntil:function(a,b,c){return u(a,"previousSibling",c)},siblings:function(a){return v((a.parentNode||{}).firstChild,a)},children:function(a){return v(a.firstChild)},contents:function(a){return n.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:n.merge(\[\],a.childNodes)}},function(a,b){n.fn\[a\]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(E\[a\]||(e=n.uniqueSort(e)),D.test(a)&&(e=e.reverse())),this.pushStack(e)}});var G=/\\S+/g;function H(a){var b={};return n.each(a.match(G)||\[\],function(a,c){b\[c\]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?H(a):n.extend({},a);var b,c,d,e,f=\[\],g=\[\],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f\[h\].apply(c\[0\],c\[1\])===!1&&a.stopOnFalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?\[\]:"")},j={add:function(){return f&&(c&&!b&&(h=f.length-1,g.push(c)),function d(b){n.each(b,function(b,c){n.isFunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&"string"!==n.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return n.each(arguments,function(a,b){var c;while((c=n.inArray(b,f,c))>-1)f.splice(c,1),h>=c&&h--}),this},has:function(a){return a?n.inArray(a,f)>-1:f.length>0},empty:function(){return f&&(f=\[\]),this},disable:function(){return e=g=\[\],f=c="",this},disabled:function(){return!f},lock:function(){return e=!0,c||j.disable(),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||\[\],c=\[a,c.slice?c.slice():c\],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j},n.extend({Deferred:function(a){var b=\[\["resolve","done",n.Callbacks("once memory"),"resolved"\],\["reject","fail",n.Callbacks("once memory"),"rejected"\],\["notify","progress",n.Callbacks("memory")\]\],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a\[b\])&&a\[b\];e\[f\[1\]\](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().progress(c.notify).done(c.resolve).fail(c.reject):c\[f\[0\]+"With"\](this===d?c.promise():this,g?\[a\]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f\[2\],h=f\[3\];d\[f\[1\]\]=g.add,h&&g.add(function(){c=h},b\[1^a\]\[2\].disable,b\[2\]\[2\].lock),e\[f\[0\]\]=function(){return e\[f\[0\]+"With"\](this===e?d:this,arguments),this},e\[f\[0\]+"With"\]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=e.call(arguments),d=c.length,f=1!==d||a&&n.isFunction(a.promise)?d:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(d){b\[a\]=this,c\[a\]=arguments.length>1?e.call(arguments):d,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(d>1)for(i=new Array(d),j=new Array(d),k=new Array(d);d>b;b++)c\[b\]&&n.isFunction(c\[b\].promise)?c\[b\].promise().progress(h(b,j,i)).done(h(b,k,c)).fail(g.reject):--f;return f||g.resolveWith(k,c),g.promise()}});var I;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){(a===!0?--n.readyWait:n.isReady)||(n.isReady=!0,a!==!0&&--n.readyWait>0||(I.resolveWith(d,\[n\]),n.fn.triggerHandler&&(n(d).triggerHandler("ready"),n(d).off("ready"))))}});function J(){d.addEventListener?(d.removeEventListener("DOMContentLoaded",K),a.removeEventListener("load",K)):(d.detachEvent("onreadystatechange",K),a.detachEvent("onload",K))}function K(){(d.addEventListener||"load"===a.event.type||"complete"===d.readyState)&&(J(),n.ready())}n.ready.promise=function(b){if(!I)if(I=n.Deferred(),"complete"===d.readyState||"loading"!==d.readyState&&!d.documentElement.doScroll)a.setTimeout(n.ready);else if(d.addEventListener)d.addEventListener("DOMContentLoaded",K),a.addEventListener("load",K);else{d.attachEvent("onreadystatechange",K),a.attachEvent("onload",K);var c=!1;try{c=null==a.frameElement&&d.documentElement}catch(e){}c&&c.doScroll&&!function f(){if(!n.isReady){try{c.doScroll("left")}catch(b){return a.setTimeout(f,50)}J(),n.ready()}}()}return I.promise(b)},n.ready.promise();var L;for(L in n(l))break;l.ownFirst="0"===L,l.inlineBlockNeedsLayout=!1,n(function(){var a,b,c,e;c=d.getElementsByTagName("body")\[0\],c&&c.style&&(b=d.createElement("div"),e=d.createElement("div"),e.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",c.appendChild(e).appendChild(b),"undefined"!=typeof b.style.zoom&&(b.style.cssText="display:inline;margin:0;border:0;padding:1px;width:1px;zoom:1",l.inlineBlockNeedsLayout=a=3===b.offsetWidth,a&&(c.style.zoom=1)),c.removeChild(e))}),function(){var a=d.createElement("div");l.deleteExpando=!0;try{delete a.test}catch(b){l.deleteExpando=!1}a=null}();var M=function(a){var b=n.noData\[(a.nodeName+" ").toLowerCase()\],c=+a.nodeType||1;return 1!==c&&9!==c?!1:!b||b!==!0&&a.getAttribute("classid")===b},N=/^(?:\\{\[\\w\\W\]\*\\}|\\\[\[\\w\\W\]\*\\\])$/,O=/(\[A-Z\])/g;function P(a,b,c){if(void 0===c&&1===a.nodeType){var d="data-"+b.replace(O,"-$1").toLowerCase();if(c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:N.test(c)?n.parseJSON(c):c}catch(e){}n.data(a,b,c)}else c=void 0; }return c}function Q(a){var b;for(b in a)if(("data"!==b||!n.isEmptyObject(a\[b\]))&&"toJSON"!==b)return!1;return!0}function R(a,b,d,e){if(M(a)){var f,g,h=n.expando,i=a.nodeType,j=i?n.cache:a,k=i?a\[h\]:a\[h\]&&h;if(k&&j\[k\]&&(e||j\[k\].data)||void 0!==d||"string"!=typeof b)return k||(k=i?a\[h\]=c.pop()||n.guid++:h),j\[k\]||(j\[k\]=i?{}:{toJSON:n.noop}),"object"!=typeof b&&"function"!=typeof b||(e?j\[k\]=n.extend(j\[k\],b):j\[k\].data=n.extend(j\[k\].data,b)),g=j\[k\],e||(g.data||(g.data={}),g=g.data),void 0!==d&&(g\[n.camelCase(b)\]=d),"string"==typeof b?(f=g\[b\],null==f&&(f=g\[n.camelCase(b)\])):f=g,f}}function S(a,b,c){if(M(a)){var d,e,f=a.nodeType,g=f?n.cache:a,h=f?a\[n.expando\]:n.expando;if(g\[h\]){if(b&&(d=c?g\[h\]:g\[h\].data)){n.isArray(b)?b=b.concat(n.map(b,n.camelCase)):b in d?b=\[b\]:(b=n.camelCase(b),b=b in d?\[b\]:b.split(" ")),e=b.length;while(e--)delete d\[b\[e\]\];if(c?!Q(d):!n.isEmptyObject(d))return}(c||(delete g\[h\].data,Q(g\[h\])))&&(f?n.cleanData(\[a\],!0):l.deleteExpando||g!=g.window?delete g\[h\]:g\[h\]=void 0)}}}n.extend({cache:{},noData:{"applet ":!0,"embed ":!0,"object ":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(a){return a=a.nodeType?n.cache\[a\[n.expando\]\]:a\[n.expando\],!!a&&!Q(a)},data:function(a,b,c){return R(a,b,c)},removeData:function(a,b){return S(a,b)},\_data:function(a,b,c){return R(a,b,c,!0)},\_removeData:function(a,b){return S(a,b,!0)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this\[0\],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=n.data(f),1===f.nodeType&&!n.\_data(f,"parsedAttrs"))){c=g.length;while(c--)g\[c\]&&(d=g\[c\].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),P(f,d,e\[d\])));n.\_data(f,"parsedAttrs",!0)}return e}return"object"==typeof a?this.each(function(){n.data(this,a)}):arguments.length>1?this.each(function(){n.data(this,a,b)}):f?P(f,a,n.data(f,a)):void 0},removeData:function(a){return this.each(function(){n.removeData(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=n.\_data(a,b),c&&(!d||n.isArray(c)?d=n.\_data(a,b,n.makeArray(c)):d.push(c)),d||\[\]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n.\_queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},\_queueHooks:function(a,b){var c=b+"queueHooks";return n.\_data(a,c)||n.\_data(a,c,{empty:n.Callbacks("once memory").add(function(){n.\_removeData(a,b+"queue"),n.\_removeData(a,c)})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this\[0\],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n.\_queueHooks(this,a),"fx"===a&&"inprogress"!==c\[0\]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",\[\])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,\[f\])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=n.\_data(f\[g\],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}}),function(){var a;l.shrinkWrapBlocks=function(){if(null!=a)return a;a=!1;var b,c,e;return c=d.getElementsByTagName("body")\[0\],c&&c.style?(b=d.createElement("div"),e=d.createElement("div"),e.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",c.appendChild(e).appendChild(b),"undefined"!=typeof b.style.zoom&&(b.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:1px;width:1px;zoom:1",b.appendChild(d.createElement("div")).style.width="5px",a=3!==b.offsetWidth),c.removeChild(e),a):void 0}}();var T=/\[+-\]?(?:\\d\*\\.|)\\d+(?:\[eE\]\[+-\]?\\d+|)/.source,U=new RegExp("^(?:(\[+-\])=|)("+T+")(\[a-z%\]\*)$","i"),V=\["Top","Right","Bottom","Left"\],W=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)};function X(a,b,c,d){var e,f=1,g=20,h=d?function(){return d.cur()}:function(){return n.css(a,b,"")},i=h(),j=c&&c\[3\]||(n.cssNumber\[b\]?"":"px"),k=(n.cssNumber\[b\]||"px"!==j&&+i)&&U.exec(n.css(a,b));if(k&&k\[3\]!==j){j=j||k\[3\],c=c||\[\],k=+i||1;do f=f||".5",k/=f,n.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return c&&(k=+k||+i||0,e=c\[1\]?k+(c\[1\]+1)\*c\[2\]:+c\[2\],d&&(d.unit=j,d.start=k,d.end=e)),e}var Y=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)Y(a,b,h,c\[h\],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a\[h\],c,g?d:d.call(a\[h\],h,b(a\[h\],c)));return e?a:j?b.call(a):i?b(a\[0\],c):f},Z=/^(?:checkbox|radio)$/i,$=/<(\[\\w:-\]+)/,\_=/^$|\\/(?:java|ecma)script/i,aa=/^\\s+/,ba="abbr|article|aside|audio|bdi|canvas|data|datalist|details|dialog|figcaption|figure|footer|header|hgroup|main|mark|meter|nav|output|picture|progress|section|summary|template|time|video";function ca(a){var b=ba.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}!function(){var a=d.createElement("div"),b=d.createDocumentFragment(),c=d.createElement("input");a.innerHTML=" <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",l.leadingWhitespace=3===a.firstChild.nodeType,l.tbody=!a.getElementsByTagName("tbody").length,l.htmlSerialize=!!a.getElementsByTagName("link").length,l.html5Clone="<:nav></:nav>"!==d.createElement("nav").cloneNode(!0).outerHTML,c.type="checkbox",c.checked=!0,b.appendChild(c),l.appendChecked=c.checked,a.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!a.cloneNode(!0).lastChild.defaultValue,b.appendChild(a),c=d.createElement("input"),c.setAttribute("type","radio"),c.setAttribute("checked","checked"),c.setAttribute("name","t"),a.appendChild(c),l.checkClone=a.cloneNode(!0).cloneNode(!0).lastChild.checked,l.noCloneEvent=!!a.addEventListener,a\[n.expando\]=1,l.attributes=!a.getAttribute(n.expando)}();var da={option:\[1,"<select multiple='multiple'>","</select>"\],legend:\[1,"<fieldset>","</fieldset>"\],area:\[1,"<map>","</map>"\],param:\[1,"<object>","</object>"\],thead:\[1,"<table>","</table>"\],tr:\[2,"<table><tbody>","</tbody></table>"\],col:\[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"\],td:\[3,"<table><tbody><tr>","</tr></tbody></table>"\],\_default:l.htmlSerialize?\[0,"",""\]:\[1,"X<div>","</div>"\]};da.optgroup=da.option,da.tbody=da.tfoot=da.colgroup=da.caption=da.thead,da.th=da.td;function ea(a,b){var c,d,e=0,f="undefined"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||"\*"):"undefined"!=typeof a.querySelectorAll?a.querySelectorAll(b||"\*"):void 0;if(!f)for(f=\[\],c=a.childNodes||a;null!=(d=c\[e\]);e++)!b||n.nodeName(d,b)?f.push(d):n.merge(f,ea(d,b));return void 0===b||b&&n.nodeName(a,b)?n.merge(\[a\],f):f}function fa(a,b){for(var c,d=0;null!=(c=a\[d\]);d++)n.\_data(c,"globalEval",!b||n.\_data(b\[d\],"globalEval"))}var ga=/<|&#?\\w+;/,ha=/<tbody/i;function ia(a){Z.test(a.type)&&(a.defaultChecked=a.checked)}function ja(a,b,c,d,e){for(var f,g,h,i,j,k,m,o=a.length,p=ca(b),q=\[\],r=0;o>r;r++)if(g=a\[r\],g||0===g)if("object"===n.type(g))n.merge(q,g.nodeType?\[g\]:g);else if(ga.test(g)){i=i||p.appendChild(b.createElement("div")),j=($.exec(g)||\["",""\])\[1\].toLowerCase(),m=da\[j\]||da.\_default,i.innerHTML=m\[1\]+n.htmlPrefilter(g)+m\[2\],f=m\[0\];while(f--)i=i.lastChild;if(!l.leadingWhitespace&&aa.test(g)&&q.push(b.createTextNode(aa.exec(g)\[0\])),!l.tbody){g="table"!==j||ha.test(g)?"<table>"!==m\[1\]||ha.test(g)?0:i:i.firstChild,f=g&&g.childNodes.length;while(f--)n.nodeName(k=g.childNodes\[f\],"tbody")&&!k.childNodes.length&&g.removeChild(k)}n.merge(q,i.childNodes),i.textContent="";while(i.firstChild)i.removeChild(i.firstChild);i=p.lastChild}else q.push(b.createTextNode(g));i&&p.removeChild(i),l.appendChecked||n.grep(ea(q,"input"),ia),r=0;while(g=q\[r++\])if(d&&n.inArray(g,d)>-1)e&&e.push(g);else if(h=n.contains(g.ownerDocument,g),i=ea(p.appendChild(g),"script"),h&&fa(i),c){f=0;while(g=i\[f++\])\_.test(g.type||"")&&c.push(g)}return i=null,p}!function(){var b,c,e=d.createElement("div");for(b in{submit:!0,change:!0,focusin:!0})c="on"+b,(l\[b\]=c in a)||(e.setAttribute(c,"t"),l\[b\]=e.attributes\[c\].expando===!1);e=null}();var ka=/^(?:input|select|textarea)$/i,la=/^key/,ma=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,na=/^(?:focusinfocus|focusoutblur)$/,oa=/^(\[^.\]\*)(?:\\.(.+)|)/;function pa(){return!0}function qa(){return!1}function ra(){try{return d.activeElement}catch(a){}}function sa(a,b,c,d,e,f){var g,h;if("object"==typeof b){"string"!=typeof c&&(d=d||c,c=void 0);for(h in b)sa(a,h,c,d,b\[h\],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&("string"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=qa;else if(!e)return a;return 1===f&&(g=e,e=function(a){return n().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=n.guid++)),a.each(function(){n.event.add(this,b,e,d,c)})}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n.\_data(a);if(r){c.handler&&(i=c,c=i.handler,e=i.selector),c.guid||(c.guid=n.guid++),(g=r.events)||(g=r.events={}),(k=r.handle)||(k=r.handle=function(a){return"undefined"==typeof n||a&&n.event.triggered===a.type?void 0:n.event.dispatch.apply(k.elem,arguments)},k.elem=a),b=(b||"").match(G)||\[""\],h=b.length;while(h--)f=oa.exec(b\[h\])||\[\],o=q=f\[1\],p=(f\[2\]||"").split(".").sort(),o&&(j=n.event.special\[o\]||{},o=(e?j.delegateType:j.bindType)||o,j=n.event.special\[o\]||{},l=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},i),(m=g\[o\])||(m=g\[o\]=\[\],m.delegateCount=0,j.setup&&j.setup.call(a,d,p,k)!==!1||(a.addEventListener?a.addEventListener(o,k,!1):a.attachEvent&&a.attachEvent("on"+o,k))),j.add&&(j.add.call(a,l),l.handler.guid||(l.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,l):m.push(l),n.event.global\[o\]=!0);a=null}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n.hasData(a)&&n.\_data(a);if(r&&(k=r.events)){b=(b||"").match(G)||\[""\],j=b.length;while(j--)if(h=oa.exec(b\[j\])||\[\],o=q=h\[1\],p=(h\[2\]||"").split(".").sort(),o){l=n.event.special\[o\]||{},o=(d?l.delegateType:l.bindType)||o,m=k\[o\]||\[\],h=h\[2\]&&new RegExp("(^|\\\\.)"+p.join("\\\\.(?:.\*\\\\.|)")+"(\\\\.|$)"),i=f=m.length;while(f--)g=m\[f\],!e&&q!==g.origType||c&&c.guid!==g.guid||h&&!h.test(g.namespace)||d&&d!==g.selector&&("\*\*"!==d||!g.selector)||(m.splice(f,1),g.selector&&m.delegateCount--,l.remove&&l.remove.call(a,g));i&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete k\[o\])}else for(o in k)n.event.remove(a,o+b\[j\],c,d,!0);n.isEmptyObject(k)&&(delete r.handle,n.\_removeData(a,"events"))}},trigger:function(b,c,e,f){var g,h,i,j,l,m,o,p=\[e||d\],q=k.call(b,"type")?b.type:b,r=k.call(b,"namespace")?b.namespace.split("."):\[\];if(i=m=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!na.test(q+n.event.triggered)&&(q.indexOf(".")>-1&&(r=q.split("."),q=r.shift(),r.sort()),h=q.indexOf(":")<0&&"on"+q,b=b\[n.expando\]?b:new n.Event(q,"object"==typeof b&&b),b.isTrigger=f?2:3,b.namespace=r.join("."),b.rnamespace=b.namespace?new RegExp("(^|\\\\.)"+r.join("\\\\.(?:.\*\\\\.|)")+"(\\\\.|$)"):null,b.result=void 0,b.target||(b.target=e),c=null==c?\[b\]:n.makeArray(c,\[b\]),l=n.event.special\[q\]||{},f||!l.trigger||l.trigger.apply(e,c)!==!1)){if(!f&&!l.noBubble&&!n.isWindow(e)){for(j=l.delegateType||q,na.test(j+q)||(i=i.parentNode);i;i=i.parentNode)p.push(i),m=i;m===(e.ownerDocument||d)&&p.push(m.defaultView||m.parentWindow||a)}o=0;while((i=p\[o++\])&&!b.isPropagationStopped())b.type=o>1?j:l.bindType||q,g=(n.\_data(i,"events")||{})\[b.type\]&&n.\_data(i,"handle"),g&&g.apply(i,c),g=h&&i\[h\],g&&g.apply&&M(i)&&(b.result=g.apply(i,c),b.result===!1&&b.preventDefault());if(b.type=q,!f&&!b.isDefaultPrevented()&&(!l.\_default||l.\_default.apply(p.pop(),c)===!1)&&M(e)&&h&&e\[q\]&&!n.isWindow(e)){m=e\[h\],m&&(e\[h\]=null),n.event.triggered=q;try{e\[q\]()}catch(s){}n.event.triggered=void 0,m&&(e\[h\]=m)}return b.result}},dispatch:function(a){a=n.event.fix(a);var b,c,d,f,g,h=\[\],i=e.call(arguments),j=(n.\_data(this,"events")||{})\[a.type\]||\[\],k=n.event.special\[a.type\]||{};if(i\[0\]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h\[b++\])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers\[c++\])&&!a.isImmediatePropagationStopped())a.rnamespace&&!a.rnamespace.test(g.namespace)||(a.handleObj=g,a.data=g.data,d=((n.event.special\[g.origType\]||{}).handle||g.handler).apply(f.elem,i),void 0!==d&&(a.result=d)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=\[\],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&("click"!==a.type||isNaN(a.button)||a.button<1))for(;i!=this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||"click"!==a.type)){for(d=\[\],c=0;h>c;c++)f=b\[c\],e=f.selector+" ",void 0===d\[e\]&&(d\[e\]=f.needsContext?n(e,this).index(i)>-1:n.find(e,this,null,\[i\]).length),d\[e\]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},fix:function(a){if(a\[n.expando\])return a;var b,c,e,f=a.type,g=a,h=this.fixHooks\[f\];h||(this.fixHooks\[f\]=h=ma.test(f)?this.mouseHooks:la.test(f)?this.keyHooks:{}),e=h.props?this.props.concat(h.props):this.props,a=new n.Event(g),b=e.length;while(b--)c=e\[b\],a\[c\]=g\[c\];return a.target||(a.target=g.srcElement||d),3===a.target.nodeType&&(a.target=a.target.parentNode),a.metaKey=!!a.metaKey,h.filter?h.filter(a,g):a},props:"altKey bubbles cancelable ctrlKey currentTarget detail eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,e,f,g=b.button,h=b.fromElement;return null==a.pageX&&null!=b.clientX&&(e=a.target.ownerDocument||d,f=e.documentElement,c=e.body,a.pageX=b.clientX+(f&&f.scrollLeft||c&&c.scrollLeft||0)-(f&&f.clientLeft||c&&c.clientLeft||0),a.pageY=b.clientY+(f&&f.scrollTop||c&&c.scrollTop||0)-(f&&f.clientTop||c&&c.clientTop||0)),!a.relatedTarget&&h&&(a.relatedTarget=h===a.target?b.toElement:h),a.which||void 0===g||(a.which=1&g?1:2&g?3:4&g?2:0),a}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==ra()&&this.focus)try{return this.focus(),!1}catch(a){}},delegateType:"focusin"},blur:{trigger:function(){return this===ra()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return n.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):void 0},\_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c){var d=n.extend(new n.Event,c,{type:a,isSimulated:!0});n.event.trigger(d,null,b),d.isDefaultPrevented()&&c.preventDefault()}},n.removeEvent=d.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)}:function(a,b,c){var d="on"+b;a.detachEvent&&("undefined"==typeof a\[d\]&&(a\[d\]=null),a.detachEvent(d,c))},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?pa:qa):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this\[n.expando\]=!0)):new n.Event(a,b)},n.Event.prototype={constructor:n.Event,isDefaultPrevented:qa,isPropagationStopped:qa,isImmediatePropagationStopped:qa,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=pa,a&&(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=pa,a&&!this.isSimulated&&(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=pa,a&&a.stopImmediatePropagation&&a.stopImmediatePropagation(),this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){n.event.special\[a\]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return e&&(e===d||n.contains(d,e))||(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),l.submit||(n.event.special.submit={setup:function(){return n.nodeName(this,"form")?!1:void n.event.add(this,"click.\_submit keypress.\_submit",function(a){var b=a.target,c=n.nodeName(b,"input")||n.nodeName(b,"button")?n.prop(b,"form"):void 0;c&&!n.\_data(c,"submit")&&(n.event.add(c,"submit.\_submit",function(a){a.\_submitBubble=!0}),n.\_data(c,"submit",!0))})},postDispatch:function(a){a.\_submitBubble&&(delete a.\_submitBubble,this.parentNode&&!a.isTrigger&&n.event.simulate("submit",this.parentNode,a))},teardown:function(){return n.nodeName(this,"form")?!1:void n.event.remove(this,".\_submit")}}),l.change||(n.event.special.change={setup:function(){return ka.test(this.nodeName)?("checkbox"!==this.type&&"radio"!==this.type||(n.event.add(this,"propertychange.\_change",function(a){"checked"===a.originalEvent.propertyName&&(this.\_justChanged=!0)}),n.event.add(this,"click.\_change",function(a){this.\_justChanged&&!a.isTrigger&&(this.\_justChanged=!1),n.event.simulate("change",this,a)})),!1):void n.event.add(this,"beforeactivate.\_change",function(a){var b=a.target;ka.test(b.nodeName)&&!n.\_data(b,"change")&&(n.event.add(b,"change.\_change",function(a){!this.parentNode||a.isSimulated||a.isTrigger||n.event.simulate("change",this.parentNode,a)}),n.\_data(b,"change",!0))})},handle:function(a){var b=a.target;return this!==b||a.isSimulated||a.isTrigger||"radio"!==b.type&&"checkbox"!==b.type?a.handleObj.handler.apply(this,arguments):void 0},teardown:function(){return n.event.remove(this,".\_change"),!ka.test(this.nodeName)}}),l.focusin||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a))};n.event.special\[b\]={setup:function(){var d=this.ownerDocument||this,e=n.\_data(d,b);e||d.addEventListener(a,c,!0),n.\_data(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=n.\_data(d,b)-1;e?n.\_data(d,b,e):(d.removeEventListener(a,c,!0),n.\_removeData(d,b))}}}),n.fn.extend({on:function(a,b,c,d){return sa(this,a,b,c,d)},one:function(a,b,c,d){return sa(this,a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a\[e\]);return this}return b!==!1&&"function"!=typeof b||(c=b,b=void 0),c===!1&&(c=qa),this.each(function(){n.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this\[0\];return c?n.event.trigger(a,b,c,!0):void 0}});var ta=/ jQuery\\d+="(?:null|\\d+)"/g,ua=new RegExp("<(?:"+ba+")\[\\\\s/>\]","i"),va=/<(?!area|br|col|embed|hr|img|input|link|meta|param)((\[\\w:-\]+)\[^>\]\*)\\/>/gi,wa=/<script|<style|<link/i,xa=/checked\\s\*(?:\[^=\]|=\\s\*.checked.)/i,ya=/^true\\/(.\*)/,za=/^\\s\*<!(?:\\\[CDATA\\\[|--)|(?:\\\]\\\]|--)>\\s\*$/g,Aa=ca(d),Ba=Aa.appendChild(d.createElement("div"));function Ca(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")\[0\]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function Da(a){return a.type=(null!==n.find.attr(a,"type"))+"/"+a.type,a}function Ea(a){var b=ya.exec(a.type);return b?a.type=b\[1\]:a.removeAttribute("type"),a}function Fa(a,b){if(1===b.nodeType&&n.hasData(a)){var c,d,e,f=n.\_data(a),g=n.\_data(b,f),h=f.events;if(h){delete g.handle,g.events={};for(c in h)for(d=0,e=h\[c\].length;e>d;d++)n.event.add(b,c,h\[c\]\[d\])}g.data&&(g.data=n.extend({},g.data))}}function Ga(a,b){var c,d,e;if(1===b.nodeType){if(c=b.nodeName.toLowerCase(),!l.noCloneEvent&&b\[n.expando\]){e=n.\_data(b);for(d in e.events)n.removeEvent(b,d,e.handle);b.removeAttribute(n.expando)}"script"===c&&b.text!==a.text?(Da(b).text=a.text,Ea(b)):"object"===c?(b.parentNode&&(b.outerHTML=a.outerHTML),l.html5Clone&&a.innerHTML&&!n.trim(b.innerHTML)&&(b.innerHTML=a.innerHTML)):"input"===c&&Z.test(a.type)?(b.defaultChecked=b.checked=a.checked,b.value!==a.value&&(b.value=a.value)):"option"===c?b.defaultSelected=b.selected=a.defaultSelected:"input"!==c&&"textarea"!==c||(b.defaultValue=a.defaultValue)}}function Ha(a,b,c,d){b=f.apply(\[\],b);var e,g,h,i,j,k,m=0,o=a.length,p=o-1,q=b\[0\],r=n.isFunction(q);if(r||o>1&&"string"==typeof q&&!l.checkClone&&xa.test(q))return a.each(function(e){var f=a.eq(e);r&&(b\[0\]=q.call(this,e,f.html())),Ha(f,b,c,d)});if(o&&(k=ja(b,a\[0\].ownerDocument,!1,a,d),e=k.firstChild,1===k.childNodes.length&&(k=e),e||d)){for(i=n.map(ea(k,"script"),Da),h=i.length;o>m;m++)g=k,m!==p&&(g=n.clone(g,!0,!0),h&&n.merge(i,ea(g,"script"))),c.call(a\[m\],g,m);if(h)for(j=i\[i.length-1\].ownerDocument,n.map(i,Ea),m=0;h>m;m++)g=i\[m\],\_.test(g.type||"")&&!n.\_data(g,"globalEval")&&n.contains(j,g)&&(g.src?n.\_evalUrl&&n.\_evalUrl(g.src):n.globalEval((g.text||g.textContent||g.innerHTML||"").replace(za,"")));k=e=null}return a}function Ia(a,b,c){for(var d,e=b?n.filter(b,a):a,f=0;null!=(d=e\[f\]);f++)c||1!==d.nodeType||n.cleanData(ea(d)),d.parentNode&&(c&&n.contains(d.ownerDocument,d)&&fa(ea(d,"script")),d.parentNode.removeChild(d));return a}n.extend({htmlPrefilter:function(a){return a.replace(va,"<$1></$2>")},clone:function(a,b,c){var d,e,f,g,h,i=n.contains(a.ownerDocument,a);if(l.html5Clone||n.isXMLDoc(a)||!ua.test("<"+a.nodeName+">")?f=a.cloneNode(!0):(Ba.innerHTML=a.outerHTML,Ba.removeChild(f=Ba.firstChild)),!(l.noCloneEvent&&l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(d=ea(f),h=ea(a),g=0;null!=(e=h\[g\]);++g)d\[g\]&&Ga(e,d\[g\]);if(b)if(c)for(h=h||ea(a),d=d||ea(f),g=0;null!=(e=h\[g\]);g++)Fa(e,d\[g\]);else Fa(a,f);return d=ea(f,"script"),d.length>0&&fa(d,!i&&ea(a,"script")),d=h=e=null,f},cleanData:function(a,b){for(var d,e,f,g,h=0,i=n.expando,j=n.cache,k=l.attributes,m=n.event.special;null!=(d=a\[h\]);h++)if((b||M(d))&&(f=d\[i\],g=f&&j\[f\])){if(g.events)for(e in g.events)m\[e\]?n.event.remove(d,e):n.removeEvent(d,e,g.handle);j\[f\]&&(delete j\[f\],k||"undefined"==typeof d.removeAttribute?d\[i\]=void 0:d.removeAttribute(i),c.push(f))}}}),n.fn.extend({domManip:Ha,detach:function(a){return Ia(this,a,!0)},remove:function(a){return Ia(this,a)},text:function(a){return Y(this,function(a){return void 0===a?n.text(this):this.empty().append((this\[0\]&&this\[0\].ownerDocument||d).createTextNode(a))},null,a,arguments.length)},append:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.appendChild(a)}})},prepend:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this\[b\]);b++){1===a.nodeType&&n.cleanData(ea(a,!1));while(a.firstChild)a.removeChild(a.firstChild);a.options&&n.nodeName(a,"select")&&(a.options.length=0)}return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return Y(this,function(a){var b=this\[0\]||{},c=0,d=this.length;if(void 0===a)return 1===b.nodeType?b.innerHTML.replace(ta,""):void 0;if("string"==typeof a&&!wa.test(a)&&(l.htmlSerialize||!ua.test(a))&&(l.leadingWhitespace||!aa.test(a))&&!da\[($.exec(a)||\["",""\])\[1\].toLowerCase()\]){a=n.htmlPrefilter(a);try{for(;d>c;c++)b=this\[c\]||{},1===b.nodeType&&(n.cleanData(ea(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=\[\];return Ha(this,arguments,function(b){var c=this.parentNode;n.inArray(this,a)<0&&(n.cleanData(ea(this)),c&&c.replaceChild(b,this))},a)}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn\[a\]=function(a){for(var c,d=0,e=\[\],f=n(a),h=f.length-1;h>=d;d++)c=d===h?this:this.clone(!0),n(f\[d\])\[b\](c),g.apply(e,c.get());return this.pushStack(e)}});var Ja,Ka={HTML:"block",BODY:"block"};function La(a,b){var c=n(b.createElement(a)).appendTo(b.body),d=n.css(c\[0\],"display");return c.detach(),d}function Ma(a){var b=d,c=Ka\[a\];return c||(c=La(a,b),"none"!==c&&c||(Ja=(Ja||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=(Ja\[0\].contentWindow||Ja\[0\].contentDocument).document,b.write(),b.close(),c=La(a,b),Ja.detach()),Ka\[a\]=c),c}var Na=/^margin/,Oa=new RegExp("^("+T+")(?!px)\[a-z%\]+$","i"),Pa=function(a,b,c,d){var e,f,g={};for(f in b)g\[f\]=a.style\[f\],a.style\[f\]=b\[f\];e=c.apply(a,d||\[\]);for(f in b)a.style\[f\]=g\[f\];return e},Qa=d.documentElement;!function(){var b,c,e,f,g,h,i=d.createElement("div"),j=d.createElement("div");if(j.style){j.style.cssText="float:left;opacity:.5",l.opacity="0.5"===j.style.opacity,l.cssFloat=!!j.style.cssFloat,j.style.backgroundClip="content-box",j.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===j.style.backgroundClip,i=d.createElement("div"),i.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",j.innerHTML="",i.appendChild(j),l.boxSizing=""===j.style.boxSizing||""===j.style.MozBoxSizing||""===j.style.WebkitBoxSizing,n.extend(l,{reliableHiddenOffsets:function(){return null==b&&k(),f},boxSizingReliable:function(){return null==b&&k(),e},pixelMarginRight:function(){return null==b&&k(),c},pixelPosition:function(){return null==b&&k(),b},reliableMarginRight:function(){return null==b&&k(),g},reliableMarginLeft:function(){return null==b&&k(),h}});function k(){var k,l,m=d.documentElement;m.appendChild(i),j.style.cssText="-webkit-box-sizing:border-box;box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",b=e=h=!1,c=g=!0,a.getComputedStyle&&(l=a.getComputedStyle(j),b="1%"!==(l||{}).top,h="2px"===(l||{}).marginLeft,e="4px"===(l||{width:"4px"}).width,j.style.marginRight="50%",c="4px"===(l||{marginRight:"4px"}).marginRight,k=j.appendChild(d.createElement("div")),k.style.cssText=j.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",k.style.marginRight=k.style.width="0",j.style.width="1px",g=!parseFloat((a.getComputedStyle(k)||{}).marginRight),j.removeChild(k)),j.style.display="none",f=0===j.getClientRects().length,f&&(j.style.display="",j.innerHTML="<table><tr><td></td><td>t</td></tr></table>",j.childNodes\[0\].style.borderCollapse="separate",k=j.getElementsByTagName("td"),k\[0\].style.cssText="margin:0;border:0;padding:0;display:none",f=0===k\[0\].offsetHeight,f&&(k\[0\].style.display="",k\[1\].style.display="none",f=0===k\[0\].offsetHeight)),m.removeChild(i)}}}();var Ra,Sa,Ta=/^(top|right|bottom|left)$/;a.getComputedStyle?(Ra=function(b){var c=b.ownerDocument.defaultView;return c&&c.opener||(c=a),c.getComputedStyle(b)},Sa=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Ra(a),g=c?c.getPropertyValue(b)||c\[b\]:void 0,""!==g&&void 0!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),c&&!l.pixelMarginRight()&&Oa.test(g)&&Na.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f),void 0===g?g:g+""}):Qa.currentStyle&&(Ra=function(a){return a.currentStyle},Sa=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Ra(a),g=c?c\[b\]:void 0,null==g&&h&&h\[b\]&&(g=h\[b\]),Oa.test(g)&&!Ta.test(b)&&(d=h.left,e=a.runtimeStyle,f=e&&e.left,f&&(e.left=a.currentStyle.left),h.left="fontSize"===b?"1em":g,g=h.pixelLeft+"px",h.left=d,f&&(e.left=f)),void 0===g?g:g+""||"auto"});function Ua(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}var Va=/alpha\\(\[^)\]\*\\)/i,Wa=/opacity\\s\*=\\s\*(\[^)\]\*)/i,Xa=/^(none|table(?!-c\[ea\]).+)/,Ya=new RegExp("^("+T+")(.\*)$","i"),Za={position:"absolute",visibility:"hidden",display:"block"},$a={letterSpacing:"0",fontWeight:"400"},\_a=\["Webkit","O","Moz","ms"\],ab=d.createElement("div").style;function bb(a){if(a in ab)return a;var b=a.charAt(0).toUpperCase()+a.slice(1),c=\_a.length;while(c--)if(a=\_a\[c\]+b,a in ab)return a}function cb(a,b){for(var c,d,e,f=\[\],g=0,h=a.length;h>g;g++)d=a\[g\],d.style&&(f\[g\]=n.\_data(d,"olddisplay"),c=d.style.display,b?(f\[g\]||"none"!==c||(d.style.display=""),""===d.style.display&&W(d)&&(f\[g\]=n.\_data(d,"olddisplay",Ma(d.nodeName)))):(e=W(d),(c&&"none"!==c||!e)&&n.\_data(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a\[g\],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f\[g\]||"":"none"));return a}function db(a,b,c){var d=Ya.exec(b);return d?Math.max(0,d\[1\]-(c||0))+(d\[2\]||"px"):b}function eb(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+V\[f\],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+V\[f\],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+V\[f\]+"Width",!0,e))):(g+=n.css(a,"padding"+V\[f\],!0,e),"padding"!==c&&(g+=n.css(a,"border"+V\[f\]+"Width",!0,e)));return g}function fb(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=Ra(a),g=l.boxSizing&&"border-box"===n.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=Sa(a,b,f),(0>e||null==e)&&(e=a.style\[b\]),Oa.test(e))return e;d=g&&(l.boxSizingReliable()||e===a.style\[b\]),e=parseFloat(e)||0}return e+eb(a,b,c||(g?"border":"content"),d,f)+"px"}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Sa(a,"opacity");return""===c?"1":c}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":l.cssFloat?"cssFloat":"styleFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;if(b=n.cssProps\[h\]||(n.cssProps\[h\]=bb(h)||h),g=n.cssHooks\[b\]||n.cssHooks\[h\],void 0===c)return g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i\[b\];if(f=typeof c,"string"===f&&(e=U.exec(c))&&e\[1\]&&(c=X(a,b,e),f="number"),null!=c&&c===c&&("number"===f&&(c+=e&&e\[3\]||(n.cssNumber\[h\]?"":"px")),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i\[b\]="inherit"),!(g&&"set"in g&&void 0===(c=g.set(a,c,d)))))try{i\[b\]=c}catch(j){}}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps\[h\]||(n.cssProps\[h\]=bb(h)||h),g=n.cssHooks\[b\]||n.cssHooks\[h\],g&&"get"in g&&(f=g.get(a,!0,c)),void 0===f&&(f=Sa(a,b,d)),"normal"===f&&b in $a&&(f=$a\[b\]),""===c||c?(e=parseFloat(f),c===!0||isFinite(e)?e||0:f):f}}),n.each(\["height","width"\],function(a,b){n.cssHooks\[b\]={get:function(a,c,d){return c?Xa.test(n.css(a,"display"))&&0===a.offsetWidth?Pa(a,Za,function(){return fb(a,b,d)}):fb(a,b,d):void 0},set:function(a,c,d){var e=d&&Ra(a);return db(a,c,d?eb(a,b,d,l.boxSizing&&"border-box"===n.css(a,"boxSizing",!1,e),e):0)}}}),l.opacity||(n.cssHooks.opacity={get:function(a,b){return Wa.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?.01\*parseFloat(RegExp.$1)+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=n.isNumeric(b)?"alpha(opacity="+100\*b+")":"",f=d&&d.filter||c.filter||"";c.zoom=1,(b>=1||""===b)&&""===n.trim(f.replace(Va,""))&&c.removeAttribute&&(c.removeAttribute("filter"),""===b||d&&!d.filter)||(c.filter=Va.test(f)?f.replace(Va,e):f+" "+e)}}),n.cssHooks.marginRight=Ua(l.reliableMarginRight,function(a,b){return b?Pa(a,{display:"inline-block"},Sa,\[a,"marginRight"\]):void 0}),n.cssHooks.marginLeft=Ua(l.reliableMarginLeft,function(a,b){return b?(parseFloat(Sa(a,"marginLeft"))||(n.contains(a.ownerDocument,a)?a.getBoundingClientRect().left-Pa(a,{ marginLeft:0},function(){return a.getBoundingClientRect().left}):0))+"px":void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks\[a+b\]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):\[c\];4>d;d++)e\[a+V\[d\]+b\]=f\[d\]||f\[d-2\]||f\[0\];return e}},Na.test(a)||(n.cssHooks\[a+b\].set=db)}),n.fn.extend({css:function(a,b){return Y(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=Ra(a),e=b.length;e>g;g++)f\[b\[g\]\]=n.css(a,b\[g\],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)},a,b,arguments.length>1)},show:function(){return cb(this,!0)},hide:function(){return cb(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){W(this)?n(this).show():n(this).hide()})}});function gb(a,b,c,d,e){return new gb.prototype.init(a,b,c,d,e)}n.Tween=gb,gb.prototype={constructor:gb,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||n.easing.\_default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber\[c\]?"":"px")},cur:function(){var a=gb.propHooks\[this.prop\];return a&&a.get?a.get(this):gb.propHooks.\_default.get(this)},run:function(a){var b,c=gb.propHooks\[this.prop\];return this.options.duration?this.pos=b=n.easing\[this.easing\](a,this.options.duration\*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)\*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):gb.propHooks.\_default.set(this),this}},gb.prototype.init.prototype=gb.prototype,gb.propHooks={\_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem\[a.prop\]&&null==a.elem.style\[a.prop\]?a.elem\[a.prop\]:(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0)},set:function(a){n.fx.step\[a.prop\]?n.fx.step\[a.prop\](a):1!==a.elem.nodeType||null==a.elem.style\[n.cssProps\[a.prop\]\]&&!n.cssHooks\[a.prop\]?a.elem\[a.prop\]=a.now:n.style(a.elem,a.prop,a.now+a.unit)}}},gb.propHooks.scrollTop=gb.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem\[a.prop\]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a\*Math.PI)/2},\_default:"swing"},n.fx=gb.prototype.init,n.fx.step={};var hb,ib,jb=/^(?:toggle|show|hide)$/,kb=/queueHooks$/;function lb(){return a.setTimeout(function(){hb=void 0}),hb=n.now()}function mb(a,b){var c,d={height:a},e=0;for(b=b?1:0;4>e;e+=2-b)c=V\[e\],d\["margin"+c\]=d\["padding"+c\]=a;return b&&(d.opacity=d.width=a),d}function nb(a,b,c){for(var d,e=(qb.tweeners\[b\]||\[\]).concat(qb.tweeners\["\*"\]),f=0,g=e.length;g>f;f++)if(d=e\[f\].call(c,b,a))return d}function ob(a,b,c){var d,e,f,g,h,i,j,k,m=this,o={},p=a.style,q=a.nodeType&&W(a),r=n.\_data(a,"fxshow");c.queue||(h=n.\_queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,m.always(function(){m.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=\[p.overflow,p.overflowX,p.overflowY\],j=n.css(a,"display"),k="none"===j?n.\_data(a,"olddisplay")||Ma(a.nodeName):j,"inline"===k&&"none"===n.css(a,"float")&&(l.inlineBlockNeedsLayout&&"inline"!==Ma(a.nodeName)?p.zoom=1:p.display="inline-block")),c.overflow&&(p.overflow="hidden",l.shrinkWrapBlocks()||m.always(function(){p.overflow=c.overflow\[0\],p.overflowX=c.overflow\[1\],p.overflowY=c.overflow\[2\]}));for(d in b)if(e=b\[d\],jb.exec(e)){if(delete b\[d\],f=f||"toggle"===e,e===(q?"hide":"show")){if("show"!==e||!r||void 0===r\[d\])continue;q=!0}o\[d\]=r&&r\[d\]||n.style(a,d)}else j=void 0;if(n.isEmptyObject(o))"inline"===("none"===j?Ma(a.nodeName):j)&&(p.display=j);else{r?"hidden"in r&&(q=r.hidden):r=n.\_data(a,"fxshow",{}),f&&(r.hidden=!q),q?n(a).show():m.done(function(){n(a).hide()}),m.done(function(){var b;n.\_removeData(a,"fxshow");for(b in o)n.style(a,b,o\[b\])});for(d in o)g=nb(q?r\[d\]:0,d,m),d in r||(r\[d\]=g.start,q&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function pb(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b\[d\],f=a\[c\],n.isArray(f)&&(e=f\[1\],f=a\[c\]=f\[0\]),c!==d&&(a\[d\]=f,delete a\[c\]),g=n.cssHooks\[d\],g&&"expand"in g){f=g.expand(f),delete a\[d\];for(c in f)c in a||(a\[c\]=f\[c\],b\[c\]=e)}else b\[d\]=e}function qb(a,b,c){var d,e,f=0,g=qb.prefilters.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=hb||lb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens\[g\].run(f);return h.notifyWith(a,\[j,f,c\]),1>f&&i?c:(h.resolveWith(a,\[j\]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{},easing:n.easing.\_default},c),originalProperties:b,originalOptions:c,startTime:hb||lb(),duration:c.duration,tweens:\[\],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing\[b\]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens\[c\].run(1);return b?(h.notifyWith(a,\[j,1,0\]),h.resolveWith(a,\[j,b\])):h.rejectWith(a,\[j,b\]),this}}),k=j.props;for(pb(k,j.opts.specialEasing);g>f;f++)if(d=qb.prefilters\[f\].call(j,a,k,j.opts))return n.isFunction(d.stop)&&(n.\_queueHooks(j.elem,j.opts.queue).stop=n.proxy(d.stop,d)),d;return n.map(k,nb,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(qb,{tweeners:{"\*":\[function(a,b){var c=this.createTween(a,b);return X(c.elem,a,U.exec(b),c),c}\]},tweener:function(a,b){n.isFunction(a)?(b=a,a=\["\*"\]):a=a.match(G);for(var c,d=0,e=a.length;e>d;d++)c=a\[d\],qb.tweeners\[c\]=qb.tweeners\[c\]||\[\],qb.tweeners\[c\].unshift(b)},prefilters:\[ob\],prefilter:function(a,b){b?qb.prefilters.unshift(a):qb.prefilters.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds\[d.duration\]:n.fx.speeds.\_default,null!=d.queue&&d.queue!==!0||(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(W).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=qb(this,n.extend({},a),f);(e||n.\_data(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",\[\]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=n.\_data(this);if(e)g\[e\]&&g\[e\].stop&&d(g\[e\]);else for(e in g)g\[e\]&&g\[e\].stop&&kb.test(e)&&d(g\[e\]);for(e=f.length;e--;)f\[e\].elem!==this||null!=a&&f\[e\].queue!==a||(f\[e\].anim.stop(c),b=!1,f.splice(e,1));!b&&c||n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=n.\_data(this),d=c\[a+"queue"\],e=c\[a+"queueHooks"\],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,\[\]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f\[b\].elem===this&&f\[b\].queue===a&&(f\[b\].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d\[b\]&&d\[b\].finish&&d\[b\].finish.call(this);delete c.finish})}}),n.each(\["toggle","show","hide"\],function(a,b){var c=n.fn\[b\];n.fn\[b\]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(mb(b,!0),a,d,e)}}),n.each({slideDown:mb("show"),slideUp:mb("hide"),slideToggle:mb("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn\[a\]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=\[\],n.fx.tick=function(){var a,b=n.timers,c=0;for(hb=n.now();c<b.length;c++)a=b\[c\],a()||b\[c\]!==a||b.splice(c--,1);b.length||n.fx.stop(),hb=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){ib||(ib=a.setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){a.clearInterval(ib),ib=null},n.fx.speeds={slow:600,fast:200,\_default:400},n.fn.delay=function(b,c){return b=n.fx?n.fx.speeds\[b\]||b:b,c=c||"fx",this.queue(c,function(c,d){var e=a.setTimeout(c,b);d.stop=function(){a.clearTimeout(e)}})},function(){var a,b=d.createElement("input"),c=d.createElement("div"),e=d.createElement("select"),f=e.appendChild(d.createElement("option"));c=d.createElement("div"),c.setAttribute("className","t"),c.innerHTML=" <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",a=c.getElementsByTagName("a")\[0\],b.setAttribute("type","checkbox"),c.appendChild(b),a=c.getElementsByTagName("a")\[0\],a.style.cssText="top:1px",l.getSetAttribute="t"!==c.className,l.style=/top/.test(a.getAttribute("style")),l.hrefNormalized="/a"===a.getAttribute("href"),l.checkOn=!!b.value,l.optSelected=f.selected,l.enctype=!!d.createElement("form").enctype,e.disabled=!0,l.optDisabled=!f.disabled,b=d.createElement("input"),b.setAttribute("value",""),l.input=""===b.getAttribute("value"),b.value="t",b.setAttribute("type","radio"),l.radioValue="t"===b.value}();var rb=/\\r/g,sb=/\[\\x20\\t\\r\\n\\f\]+/g;n.fn.extend({val:function(a){var b,c,d,e=this\[0\];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks\[this.type\]||n.valHooks\[this.nodeName.toLowerCase()\],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks\[e.type\]||n.valHooks\[e.nodeName.toLowerCase()\],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(rb,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){var b=n.find.attr(a,"value");return null!=b?b:n.trim(n.text(a)).replace(sb," ")}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:\[\],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d\[i\],(c.selected||i===e)&&(l.optDisabled?!c.disabled:null===c.getAttribute("disabled"))&&(!c.parentNode.disabled||!n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)if(d=e\[g\],n.inArray(n.valHooks.option.get(d),f)>-1)try{d.selected=c=!0}catch(h){d.scrollHeight}else d.selected=!1;return c||(a.selectedIndex=-1),e}}}}),n.each(\["radio","checkbox"\],function(){n.valHooks\[this\]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>-1:void 0}},l.checkOn||(n.valHooks\[this\].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var tb,ub,vb=n.expr.attrHandle,wb=/^(?:checked|selected)$/i,xb=l.getSetAttribute,yb=l.input;n.fn.extend({attr:function(a,b){return Y(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return"undefined"==typeof a.getAttribute?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),e=n.attrHooks\[b\]||(n.expr.match.bool.test(b)?ub:tb)),void 0!==c?null===c?void n.removeAttr(a,b):e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+""),c):e&&"get"in e&&null!==(d=e.get(a,b))?d:(d=n.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(G);if(f&&1===a.nodeType)while(c=f\[e++\])d=n.propFix\[c\]||c,n.expr.match.bool.test(c)?yb&&xb||!wb.test(c)?a\[d\]=!1:a\[n.camelCase("default-"+c)\]=a\[d\]=!1:n.attr(a,c,""),a.removeAttribute(xb?c:d)}}),ub={set:function(a,b,c){return b===!1?n.removeAttr(a,c):yb&&xb||!wb.test(c)?a.setAttribute(!xb&&n.propFix\[c\]||c,c):a\[n.camelCase("default-"+c)\]=a\[c\]=!0,c}},n.each(n.expr.match.bool.source.match(/\\w+/g),function(a,b){var c=vb\[b\]||n.find.attr;yb&&xb||!wb.test(b)?vb\[b\]=function(a,b,d){var e,f;return d||(f=vb\[b\],vb\[b\]=e,e=null!=c(a,b,d)?b.toLowerCase():null,vb\[b\]=f),e}:vb\[b\]=function(a,b,c){return c?void 0:a\[n.camelCase("default-"+b)\]?b.toLowerCase():null}}),yb&&xb||(n.attrHooks.value={set:function(a,b,c){return n.nodeName(a,"input")?void(a.defaultValue=b):tb&&tb.set(a,b,c)}}),xb||(tb={set:function(a,b,c){var d=a.getAttributeNode(c);return d||a.setAttributeNode(d=a.ownerDocument.createAttribute(c)),d.value=b+="","value"===c||b===a.getAttribute(c)?b:void 0}},vb.id=vb.name=vb.coords=function(a,b,c){var d;return c?void 0:(d=a.getAttributeNode(b))&&""!==d.value?d.value:null},n.valHooks.button={get:function(a,b){var c=a.getAttributeNode(b);return c&&c.specified?c.value:void 0},set:tb.set},n.attrHooks.contenteditable={set:function(a,b,c){tb.set(a,""===b?!1:b,c)}},n.each(\["width","height"\],function(a,b){n.attrHooks\[b\]={set:function(a,c){return""===c?(a.setAttribute(b,"auto"),c):void 0}}})),l.style||(n.attrHooks.style={get:function(a){return a.style.cssText||void 0},set:function(a,b){return a.style.cssText=b+""}});var zb=/^(?:input|select|textarea|button|object)$/i,Ab=/^(?:a|area)$/i;n.fn.extend({prop:function(a,b){return Y(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return a=n.propFix\[a\]||a,this.each(function(){try{this\[a\]=void 0,delete this\[a\]}catch(b){}})}}),n.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&n.isXMLDoc(a)||(b=n.propFix\[b\]||b,e=n.propHooks\[b\]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a\[b\]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a\[b\]},propHooks:{tabIndex:{get:function(a){var b=n.find.attr(a,"tabindex");return b?parseInt(b,10):zb.test(a.nodeName)||Ab.test(a.nodeName)&&a.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),l.hrefNormalized||n.each(\["href","src"\],function(a,b){n.propHooks\[b\]={get:function(a){return a.getAttribute(b,4)}}}),l.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex),null},set:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex)}}),n.each(\["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"\],function(){n.propFix\[this.toLowerCase()\]=this}),l.enctype||(n.propFix.enctype="encoding");var Bb=/\[\\t\\r\\n\\f\]/g;function Cb(a){return n.attr(a,"class")||""}n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,Cb(this)))});if("string"==typeof a&&a){b=a.match(G)||\[\];while(c=this\[i++\])if(e=Cb(c),d=1===c.nodeType&&(" "+e+" ").replace(Bb," ")){g=0;while(f=b\[g++\])d.indexOf(" "+f+" ")<0&&(d+=f+" ");h=n.trim(d),e!==h&&n.attr(c,"class",h)}}return this},removeClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,Cb(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof a&&a){b=a.match(G)||\[\];while(c=this\[i++\])if(e=Cb(c),d=1===c.nodeType&&(" "+e+" ").replace(Bb," ")){g=0;while(f=b\[g++\])while(d.indexOf(" "+f+" ")>-1)d=d.replace(" "+f+" "," ");h=n.trim(d),e!==h&&n.attr(c,"class",h)}}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):n.isFunction(a)?this.each(function(c){n(this).toggleClass(a.call(this,c,Cb(this),b),b)}):this.each(function(){var b,d,e,f;if("string"===c){d=0,e=n(this),f=a.match(G)||\[\];while(b=f\[d++\])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else void 0!==a&&"boolean"!==c||(b=Cb(this),b&&n.\_data(this,"\_\_className\_\_",b),n.attr(this,"class",b||a===!1?"":n.\_data(this,"\_\_className\_\_")||""))})},hasClass:function(a){var b,c,d=0;b=" "+a+" ";while(c=this\[d++\])if(1===c.nodeType&&(" "+Cb(c)+" ").replace(Bb," ").indexOf(b)>-1)return!0;return!1}}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn\[b\]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}});var Db=a.location,Eb=n.now(),Fb=/\\?/,Gb=/(,)|(\\\[|{)|(}|\])|"(?:\[^"\\\\\\r\\n\]|\\\\\["\\\\\\/bfnrt\]|\\\\u\[\\da-fA-F\]{4})\*"\\s\*:?|true|false|null|-?(?!0\\d)\\d+(?:\\.\\d+|)(?:\[eE\]\[+-\]?\\d+|)/g;n.parseJSON=function(b){if(a.JSON&&a.JSON.parse)return a.JSON.parse(b+"");var c,d=null,e=n.trim(b+"");return e&&!n.trim(e.replace(Gb,function(a,b,e,f){return c&&b&&(d=0),0===d?a:(c=e||b,d+=!f-!e,"")}))?Function("return "+e)():n.error("Invalid JSON: "+b)},n.parseXML=function(b){var c,d;if(!b||"string"!=typeof b)return null;try{a.DOMParser?(d=new a.DOMParser,c=d.parseFromString(b,"text/xml")):(c=new a.ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(b))}catch(e){c=void 0}return c&&c.documentElement&&!c.getElementsByTagName("parsererror").length||n.error("Invalid XML: "+b),c};var Hb=/#.\*$/,Ib=/(\[?&\])\_=\[^&\]\*/,Jb=/^(.\*?):\[ \\t\]\*(\[^\\r\\n\]\*)\\r?$/gm,Kb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Lb=/^(?:GET|HEAD)$/,Mb=/^\\/\\//,Nb=/^(\[\\w.+-\]+:)(?:\\/\\/(?:\[^\\/?#\]\*@|)(\[^\\/?#:\]\*)(?::(\\d+)|)|)/,Ob={},Pb={},Qb="\*/".concat("\*"),Rb=Db.href,Sb=Nb.exec(Rb.toLowerCase())||\[\];function Tb(a){return function(b,c){"string"!=typeof b&&(c=b,b="\*");var d,e=0,f=b.toLowerCase().match(G)||\[\];if(n.isFunction(c))while(d=f\[e++\])"+"===d.charAt(0)?(d=d.slice(1)||"\*",(a\[d\]=a\[d\]||\[\]).unshift(c)):(a\[d\]=a\[d\]||\[\]).push(c)}}function Ub(a,b,c,d){var e={},f=a===Pb;function g(h){var i;return e\[h\]=!0,n.each(a\[h\]||\[\],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e\[j\]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes\[0\])||!e\["\*"\]&&g("\*")}function Vb(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(d in b)void 0!==b\[d\]&&((e\[d\]?a:c||(c={}))\[d\]=b\[d\]);return c&&n.extend(!0,a,c),a}function Wb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("\*"===i\[0\])i.shift(),void 0===e&&(e=a.mimeType||b.getResponseHeader("Content-Type"));if(e)for(g in h)if(h\[g\]&&h\[g\].test(e)){i.unshift(g);break}if(i\[0\]in c)f=i\[0\];else{for(g in c){if(!i\[0\]||a.converters\[g+" "+i\[0\]\]){f=g;break}d||(d=g)}f=f||d}return f?(f!==i\[0\]&&i.unshift(f),c\[f\]):void 0}function Xb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k\[1\])for(g in a.converters)j\[g.toLowerCase()\]=a.converters\[g\];f=k.shift();while(f)if(a.responseFields\[f\]&&(c\[a.responseFields\[f\]\]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("\*"===f)f=i;else if("\*"!==i&&i!==f){if(g=j\[i+" "+f\]||j\["\* "+f\],!g)for(e in j)if(h=e.split(" "),h\[1\]===f&&(g=j\[i+" "+h\[0\]\]||j\["\* "+h\[0\]\])){g===!0?g=j\[e\]:j\[e\]!==!0&&(f=h\[0\],k.unshift(h\[1\]));break}if(g!==!0)if(g&&a\["throws"\])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Rb,type:"GET",isLocal:Kb.test(Sb\[1\]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"\*":Qb,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\\bxml\\b/,html:/\\bhtml/,json:/\\bjson\\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"\* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Vb(Vb(a,n.ajaxSettings),b):Vb(n.ajaxSettings,a)},ajaxPrefilter:Tb(Ob),ajaxTransport:Tb(Pb),ajax:function(b,c){"object"==typeof b&&(c=b,b=void 0),c=c||{};var d,e,f,g,h,i,j,k,l=n.ajaxSetup({},c),m=l.context||l,o=l.context&&(m.nodeType||m.jquery)?n(m):n.event,p=n.Deferred(),q=n.Callbacks("once memory"),r=l.statusCode||{},s={},t={},u=0,v="canceled",w={readyState:0,getResponseHeader:function(a){var b;if(2===u){if(!k){k={};while(b=Jb.exec(g))k\[b\[1\].toLowerCase()\]=b\[2\]}b=k\[a.toLowerCase()\]}return null==b?null:b},getAllResponseHeaders:function(){return 2===u?g:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return u||(a=t\[c\]=t\[c\]||a,s\[a\]=b),this},overrideMimeType:function(a){return u||(l.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>u)for(b in a)r\[b\]=\[r\[b\],a\[b\]\];else w.always(a\[w.status\]);return this},abort:function(a){var b=a||v;return j&&j.abort(b),y(0,b),this}};if(p.promise(w).complete=q.add,w.success=w.done,w.error=w.fail,l.url=((b||l.url||Rb)+"").replace(Hb,"").replace(Mb,Sb\[1\]+"//"),l.type=c.method||c.type||l.method||l.type,l.dataTypes=n.trim(l.dataType||"\*").toLowerCase().match(G)||\[""\],null==l.crossDomain&&(d=Nb.exec(l.url.toLowerCase()),l.crossDomain=!(!d||d\[1\]===Sb\[1\]&&d\[2\]===Sb\[2\]&&(d\[3\]||("http:"===d\[1\]?"80":"443"))===(Sb\[3\]||("http:"===Sb\[1\]?"80":"443")))),l.data&&l.processData&&"string"!=typeof l.data&&(l.data=n.param(l.data,l.traditional)),Ub(Ob,l,c,w),2===u)return w;i=n.event&&l.global,i&&0===n.active++&&n.event.trigger("ajaxStart"),l.type=l.type.toUpperCase(),l.hasContent=!Lb.test(l.type),f=l.url,l.hasContent||(l.data&&(f=l.url+=(Fb.test(f)?"&":"?")+l.data,delete l.data),l.cache===!1&&(l.url=Ib.test(f)?f.replace(Ib,"$1\_="+Eb++):f+(Fb.test(f)?"&":"?")+"\_="+Eb++)),l.ifModified&&(n.lastModified\[f\]&&w.setRequestHeader("If-Modified-Since",n.lastModified\[f\]),n.etag\[f\]&&w.setRequestHeader("If-None-Match",n.etag\[f\])),(l.data&&l.hasContent&&l.contentType!==!1||c.contentType)&&w.setRequestHeader("Content-Type",l.contentType),w.setRequestHeader("Accept",l.dataTypes\[0\]&&l.accepts\[l.dataTypes\[0\]\]?l.accepts\[l.dataTypes\[0\]\]+("\*"!==l.dataTypes\[0\]?", "+Qb+"; q=0.01":""):l.accepts\["\*"\]);for(e in l.headers)w.setRequestHeader(e,l.headers\[e\]);if(l.beforeSend&&(l.beforeSend.call(m,w,l)===!1||2===u))return w.abort();v="abort";for(e in{success:1,error:1,complete:1})w\[e\](l\[e\]);if(j=Ub(Pb,l,c,w)){if(w.readyState=1,i&&o.trigger("ajaxSend",\[w,l\]),2===u)return w;l.async&&l.timeout>0&&(h=a.setTimeout(function(){w.abort("timeout")},l.timeout));try{u=1,j.send(s,y)}catch(x){if(!(2>u))throw x;y(-1,x)}}else y(-1,"No Transport");function y(b,c,d,e){var k,s,t,v,x,y=c;2!==u&&(u=2,h&&a.clearTimeout(h),j=void 0,g=e||"",w.readyState=b>0?4:0,k=b>=200&&300>b||304===b,d&&(v=Wb(l,w,d)),v=Xb(l,v,w,k),k?(l.ifModified&&(x=w.getResponseHeader("Last-Modified"),x&&(n.lastModified\[f\]=x),x=w.getResponseHeader("etag"),x&&(n.etag\[f\]=x)),204===b||"HEAD"===l.type?y="nocontent":304===b?y="notmodified":(y=v.state,s=v.data,t=v.error,k=!t)):(t=y,!b&&y||(y="error",0>b&&(b=0))),w.status=b,w.statusText=(c||y)+"",k?p.resolveWith(m,\[s,y,w\]):p.rejectWith(m,\[w,y,t\]),w.statusCode(r),r=void 0,i&&o.trigger(k?"ajaxSuccess":"ajaxError",\[w,l,k?s:t\]),q.fireWith(m,\[w,y\]),i&&(o.trigger("ajaxComplete",\[w,l\]),--n.active||n.event.trigger("ajaxStop")))}return w},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(\["get","post"\],function(a,b){n\[b\]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax(n.extend({url:a,type:b,dataType:e,data:c,success:d},n.isPlainObject(a)&&a))}}),n.\_evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){if(n.isFunction(a))return this.each(function(b){n(this).wrapAll(a.call(this,b))});if(this\[0\]){var b=n(a,this\[0\].ownerDocument).eq(0).clone(!0);this\[0\].parentNode&&b.insertBefore(this\[0\]),b.map(function(){var a=this;while(a.firstChild&&1===a.firstChild.nodeType)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){return n.isFunction(a)?this.each(function(b){n(this).wrapInner(a.call(this,b))}):this.each(function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}});function Yb(a){return a.style&&a.style.display||n.css(a,"display")}function Zb(a){if(!n.contains(a.ownerDocument||d,a))return!0;while(a&&1===a.nodeType){if("none"===Yb(a)||"hidden"===a.type)return!0;a=a.parentNode}return!1}n.expr.filters.hidden=function(a){return l.reliableHiddenOffsets()?a.offsetWidth<=0&&a.offsetHeight<=0&&!a.getClientRects().length:Zb(a)},n.expr.filters.visible=function(a){return!n.expr.filters.hidden(a)};var $b=/%20/g,\_b=/\\\[\\\]$/,ac=/\\r?\\n/g,bc=/^(?:submit|button|image|reset|file)$/i,cc=/^(?:input|select|textarea|keygen)/i;function dc(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||\_b.test(a)?d(a,e):dc(a+"\["+("object"==typeof e&&null!=e?b:"")+"\]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)dc(a+"\["+e+"\]",b\[e\],c,d)}n.param=function(a,b){var c,d=\[\],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d\[d.length\]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)dc(c,a\[c\],b,e);return d.join("&").replace($b,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&cc.test(this.nodeName)&&!bc.test(a)&&(this.checked||!Z.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(ac,"\\r\\n")}}):{name:b.name,value:c.replace(ac,"\\r\\n")}}).get()}}),n.ajaxSettings.xhr=void 0!==a.ActiveXObject?function(){return this.isLocal?ic():d.documentMode>8?hc():/^(get|post|head|put|delete|options)$/i.test(this.type)&&hc()||ic()}:hc;var ec=0,fc={},gc=n.ajaxSettings.xhr();a.attachEvent&&a.attachEvent("onunload",function(){for(var a in fc)fc\[a\](void 0,!0)}),l.cors=!!gc&&"withCredentials"in gc,gc=l.ajax=!!gc,gc&&n.ajaxTransport(function(b){if(!b.crossDomain||l.cors){var c;return{send:function(d,e){var f,g=b.xhr(),h=++ec;if(g.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(f in b.xhrFields)g\[f\]=b.xhrFields\[f\];b.mimeType&&g.overrideMimeType&&g.overrideMimeType(b.mimeType),b.crossDomain||d\["X-Requested-With"\]||(d\["X-Requested-With"\]="XMLHttpRequest");for(f in d)void 0!==d\[f\]&&g.setRequestHeader(f,d\[f\]+"");g.send(b.hasContent&&b.data||null),c=function(a,d){var f,i,j;if(c&&(d||4===g.readyState))if(delete fc\[h\],c=void 0,g.onreadystatechange=n.noop,d)4!==g.readyState&&g.abort();else{j={},f=g.status,"string"==typeof g.responseText&&(j.text=g.responseText);try{i=g.statusText}catch(k){i=""}f||!b.isLocal||b.crossDomain?1223===f&&(f=204):f=j.text?200:404}j&&e(f,i,j,g.getAllResponseHeaders())},b.async?4===g.readyState?a.setTimeout(c):g.onreadystatechange=fc\[h\]=c:c()},abort:function(){c&&c(void 0,!0)}}}});function hc(){try{return new a.XMLHttpRequest}catch(b){}}function ic(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\\b(?:java|ecma)script\\b/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c=d.head||n("head")\[0\]||d.documentElement;return{send:function(e,f){b=d.createElement("script"),b.async=!0,a.scriptCharset&&(b.charset=a.scriptCharset),b.src=a.url,b.onload=b.onreadystatechange=function(a,c){(c||!b.readyState||/loaded|complete/.test(b.readyState))&&(b.onload=b.onreadystatechange=null,b.parentNode&&b.parentNode.removeChild(b),b=null,c||f(200,"success"))},c.insertBefore(b,c.firstChild)},abort:function(){b&&b.onload(void 0,!0)}}}});var jc=\[\],kc=/(=)\\?(?=&|$)|\\?\\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=jc.pop()||n.expando+"\_"+Eb++;return this\[a\]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(kc.test(b.url)?"url":"string"==typeof b.data&&0===(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&kc.test(b.data)&&"data");return h||"jsonp"===b.dataTypes\[0\]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b\[h\]=b\[h\].replace(kc,"$1"+e):b.jsonp!==!1&&(b.url+=(Fb.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters\["script json"\]=function(){return g||n.error(e+" was not called"),g\[0\]},b.dataTypes\[0\]="json",f=a\[e\],a\[e\]=function(){g=arguments},d.always(function(){void 0===f?n(a).removeProp(e):a\[e\]=f,b\[e\]&&(b.jsonpCallback=c.jsonpCallback,jc.push(e)),g&&n.isFunction(f)&&f(g\[0\]),g=f=void 0}),"script"):void 0}),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||d;var e=x.exec(a),f=!c&&\[\];return e?\[b.createElement(e\[1\])\]:(e=ja(\[a\],b,f),f&&f.length&&n(f).remove(),n.merge(\[\],e.childNodes))};var lc=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&lc)return lc.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>-1&&(d=n.trim(a.slice(h,a.length)),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&n.ajax({url:a,type:e||"GET",dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(this,f||\[a.responseText,b,a\])})}),this},n.each(\["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"\],function(a,b){n.fn\[b\]=function(a){return this.on(b,a)}}),n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};function mc(a){return n.isWindow(a)?a:9===a.nodeType?a.defaultView||a.parentWindow:!1}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&n.inArray("auto",\[f,i\])>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,n.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d={top:0,left:0},e=this\[0\],f=e&&e.ownerDocument;if(f)return b=f.documentElement,n.contains(b,e)?("undefined"!=typeof e.getBoundingClientRect&&(d=e.getBoundingClientRect()),c=mc(f),{top:d.top+(c.pageYOffset||b.scrollTop)-(b.clientTop||0),left:d.left+(c.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}):d},position:function(){if(this\[0\]){var a,b,c={top:0,left:0},d=this\[0\];return"fixed"===n.css(d,"position")?b=d.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a\[0\],"html")||(c=a.offset()),c.top+=n.css(a\[0\],"borderTopWidth",!0),c.left+=n.css(a\[0\],"borderLeftWidth",!0)),{top:b.top-c.top-n.css(d,"marginTop",!0),left:b.left-c.left-n.css(d,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&!n.nodeName(a,"html")&&"static"===n.css(a,"position"))a=a.offsetParent;return a||Qa})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,b){var c=/Y/.test(b);n.fn\[a\]=function(d){return Y(this,function(a,d,e){var f=mc(a);return void 0===e?f?b in f?f\[b\]:f.document.documentElement\[d\]:a\[d\]:void(f?f.scrollTo(c?n(f).scrollLeft():e,c?e:n(f).scrollTop()):a\[d\]=e)},a,d,arguments.length,null)}}),n.each(\["top","left"\],function(a,b){n.cssHooks\[b\]=Ua(l.pixelPosition,function(a,c){return c?(c=Sa(a,b),Oa.test(c)?n(a).position()\[b\]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({ padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn\[d\]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return Y(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement\["client"+a\]:9===b.nodeType?(e=b.documentElement,Math.max(b.body\["scroll"+a\],e\["scroll"+a\],b.body\["offset"+a\],e\["offset"+a\],e\["client"+a\])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"\*\*"):this.off(b,a||"\*\*",c)}}),n.fn.size=function(){return this.length},n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",\[\],function(){return n});var nc=a.jQuery,oc=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=oc),b&&a.jQuery===n&&(a.jQuery=nc),n},b||(a.jQuery=a.$=n),n}); (function($){var Node,Tree,methods;Node=(function(){function Node(row,tree,settings){var parentId;this.row=row;this.tree=tree;this.settings=settings;this.id=this.row.data(this.settings.nodeIdAttr);parentId=this.row.data(this.settings.parentIdAttr);if(parentId!=null&&parentId!=="")this.parentId=parentId;this.treeCell=$(this.row.children(this.settings.columnElType)\[this.settings.column\]);this.expander=$(this.settings.expanderTemplate);this.indenter=$(this.settings.indenterTemplate);this.children=\[\];this.initialized=false;this.treeCell.prepend(this.indenter);}Node.prototype.addChild=function(child){return this.children.push(child);};Node.prototype.ancestors=function(){var ancestors,node;node=this;ancestors=\[\];while(node=node.parentNode())ancestors.push(node);return ancestors;};Node.prototype.collapse=function(){if(this.collapsed())return this;this.row.removeClass("expanded").addClass("collapsed");this.\_hideChildren();this.expander.attr("title",this.settings.stringExpand);if(this.initialized&&this.settings.onNodeCollapse!=null)this.settings.onNodeCollapse.apply(this);return this;};Node.prototype.collapsed=function(){return this.row.hasClass("collapsed");};Node.prototype.expand=function(){if(this.expanded())return this;this.row.removeClass("collapsed").addClass("expanded");if(this.initialized&&this.settings.onNodeExpand!=null)this.settings.onNodeExpand.apply(this);if($(this.row).is(":visible"))this.\_showChildren();this.expander.attr("title",this.settings.stringCollapse);return this;};Node.prototype.expanded=function(){return this.row.hasClass("expanded");};Node.prototype.hide=function(){this.\_hideChildren();this.row.hide();return this;};Node.prototype.isBranchNode=function(){if(this.children.length>0||this.row.data(this.settings.branchAttr)===true)return true;else return false;};Node.prototype.updateBranchLeafClass=function(){this.row.removeClass('branch');this.row.removeClass('leaf');this.row.addClass(this.isBranchNode()?'branch':'leaf');};Node.prototype.level=function(){return this.ancestors().length;};Node.prototype.parentNode=function(){if(this.parentId!=null)return this.tree\[this.parentId\];else return null;};Node.prototype.removeChild=function(child){var i=$.inArray(child,this.children);return this.children.splice(i,1);};Node.prototype.render=function(){var handler,settings=this.settings,target;if(settings.expandable===true&&this.isBranchNode()){handler=function(e){$(this).parents("table").treetable("node",$(this).parents("tr").data(settings.nodeIdAttr)).toggle();return e.preventDefault();};this.indenter.html(this.expander);target=settings.clickableNodeNames===true?this.treeCell:this.expander;target.off("click.treetable").on("click.treetable",handler);target.off("keydown.treetable").on("keydown.treetable",function(e){if(e.keyCode==13)handler.apply(this,\[e\]);});}this.indenter\[0\].style.paddingLeft=""+(this.level()\*settings.indent)+"px";return this;};Node.prototype.reveal=function(){if(this.parentId!=null)this.parentNode().reveal();return this.expand();};Node.prototype.setParent=function(node){if(this.parentId!=null)this.tree\[this.parentId\].removeChild(this);this.parentId=node.id;this.row.data(this.settings.parentIdAttr,node.id);return node.addChild(this);};Node.prototype.show=function(){if(!this.initialized)this.\_initialize();this.row.show();if(this.expanded())this.\_showChildren();return this;};Node.prototype.toggle=function(){if(this.expanded())this.collapse();else this.expand();return this;};Node.prototype.\_hideChildren=function(){var child,\_i,\_len,\_ref,\_results;\_ref=this.children;\_results=\[\];for(\_i=0,\_len=\_ref.length;\_i<\_len;\_i++){child=\_ref\[\_i\];\_results.push(child.hide());}return \_results;};Node.prototype.\_initialize=function(){var settings=this.settings;this.render();if(settings.expandable===true&&settings.initialState==="collapsed")this.collapse();else this.expand();if(settings.onNodeInitialized!=null)settings.onNodeInitialized.apply(this);return this.initialized=true;};Node.prototype.\_showChildren=function(){var child,\_i,\_len,\_ref,\_results;\_ref=this.children;\_results=\[\];for(\_i=0,\_len=\_ref.length;\_i<\_len;\_i++){child=\_ref\[\_i\];\_results.push(child.show());}return \_results;};return Node;})();Tree=(function(){function Tree(table,settings){this.table=table;this.settings=settings;this.tree={};this.nodes=\[\];this.roots=\[\];}Tree.prototype.collapseAll=function(){var node,\_i,\_len,\_ref,\_results;\_ref=this.nodes;\_results=\[\];for(\_i=0,\_len=\_ref.length;\_i<\_len;\_i++){node=\_ref\[\_i\];\_results.push(node.collapse());}return \_results;};Tree.prototype.expandAll=function(){var node,\_i,\_len,\_ref,\_results;\_ref=this.nodes;\_results=\[\];for(\_i=0,\_len=\_ref.length;\_i<\_len;\_i++){node=\_ref\[\_i\];\_results.push(node.expand());}return \_results;};Tree.prototype.findLastNode=function(node){if(node.children.length>0)return this.findLastNode(node.children\[node.children.length-1\]);else return node;};Tree.prototype.loadRows=function(rows){var node,row,i;if(rows!=null)for(i=0;i<rows.length;i++){row=$(rows\[i\]);if(row.data(this.settings.nodeIdAttr)!=null){node=new Node(row,this.tree,this.settings);this.nodes.push(node);this.tree\[node.id\]=node;if(node.parentId!=null&&this.tree\[node.parentId\])this.tree\[node.parentId\].addChild(node);else this.roots.push(node);}}for(i=0;i<this.nodes.length;i++)node=this.nodes\[i\].updateBranchLeafClass();return this;};Tree.prototype.move=function(node,destination){var nodeParent=node.parentNode();if(node!==destination&&destination.id!==node.parentId&&$.inArray(node,destination.ancestors())===-1){node.setParent(destination);this.\_moveRows(node,destination);if(node.parentNode().children.length===1)node.parentNode().render();}if(nodeParent)nodeParent.updateBranchLeafClass();if(node.parentNode())node.parentNode().updateBranchLeafClass();node.updateBranchLeafClass();return this;};Tree.prototype.removeNode=function(node){this.unloadBranch(node);node.row.remove();if(node.parentId!=null)node.parentNode().removeChild(node);delete this.tree\[node.id\];this.nodes.splice($.inArray(node,this.nodes),1);return this;};Tree.prototype.render=function(){var root,\_i,\_len,\_ref;\_ref=this.roots;for(\_i=0,\_len=\_ref.length;\_i<\_len;\_i++){root=\_ref\[\_i\];root.show();}return this;};Tree.prototype.sortBranch=function(node,sortFun){node.children.sort(sortFun);this.\_sortChildRows(node);return this;};Tree.prototype.unloadBranch=function(node){var children=node.children.slice(0),i;for(i=0;i<children.length;i++)this.removeNode(children\[i\]);node.children=\[\];node.updateBranchLeafClass();return this;};Tree.prototype.\_moveRows=function(node,destination){var children=node.children,i;node.row.insertAfter(destination.row);node.render();for(i=children.length-1;i>=0;i--)this.\_moveRows(children\[i\],node);};Tree.prototype.\_sortChildRows=function(parentNode){return this.\_moveRows(parentNode,parentNode);};return Tree;})();methods={init:function(options,force){var settings;settings=$.extend({branchAttr:"ttBranch",clickableNodeNames:false,column:0,columnElType:"td",expandable:false,expanderTemplate:"<a href='#'>&nbsp;</a>",indent:19,indenterTemplate:"<span class='indenter'></span>",initialState:"collapsed",nodeIdAttr:"ttId",parentIdAttr:"ttParentId",stringExpand:"Expand",stringCollapse:"Collapse",onInitialized:null,onNodeCollapse:null,onNodeExpand:null,onNodeInitialized:null},options);return this.each(function(){var el=$(this),tree;if(force||el.data("treetable")===undefined){tree=new Tree(this,settings);tree.loadRows(this.rows).render();el.addClass("treetable").data("treetable",tree);if(settings.onInitialized!=null)settings.onInitialized.apply(tree);}return el;});},destroy:function(){return this.each(function(){return $(this).removeData("treetable").removeClass("treetable");});},collapseAll:function(){this.data("treetable").collapseAll();return this;},collapseNode:function(id){var node=this.data("treetable").tree\[id\];if(node)node.collapse();else throw new Error("Unknown node '"+id+"'");return this;},expandAll:function(){this.data("treetable").expandAll();return this;},expandNode:function(id){var node=this.data("treetable").tree\[id\];if(node){if(!node.initialized)node.\_initialize();node.expand();}else throw new Error("Unknown node '"+id+"'");return this;},loadBranch:function(node,rows){var settings=this.data("treetable").settings,tree=this.data("treetable").tree;rows=$(rows);if(node==null)this.append(rows);else{var lastNode=this.data("treetable").findLastNode(node);rows.insertAfter(lastNode.row);}this.data("treetable").loadRows(rows);rows.filter("tr").each(function(){tree\[$(this).data(settings.nodeIdAttr)\].show();});if(node!=null)node.render().expand();return this;},move:function(nodeId,destinationId){var destination,node;node=this.data("treetable").tree\[nodeId\];destination=this.data("treetable").tree\[destinationId\];this.data("treetable").move(node,destination);return this;},node:function(id){return this.data("treetable").tree\[id\];},removeNode:function(id){var node=this.data("treetable").tree\[id\];if(node)this.data("treetable").removeNode(node);else throw new Error("Unknown node '"+id+"'");return this;},reveal:function(id){var node=this.data("treetable").tree\[id\];if(node)node.reveal();else throw new Error("Unknown node '"+id+"'");return this;},sortBranch:function(node,columnOrFunction){var settings=this.data("treetable").settings,prepValue,sortFun;columnOrFunction=columnOrFunction||settings.column;sortFun=columnOrFunction;if($.isNumeric(columnOrFunction))sortFun=function(a,b){var extractValue,valA,valB;extractValue=function(node){var val=node.row.find("td:eq("+columnOrFunction+")").text();return $.trim(val).toUpperCase();};valA=extractValue(a);valB=extractValue(b);if(valA<valB)return -1;if(valA>valB)return 1;return 0;};this.data("treetable").sortBranch(node,sortFun);return this;},unloadBranch:function(node){this.data("treetable").unloadBranch(node);return this;}};$.fn.treetable=function(method){if(methods\[method\])return methods\[method\].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof method==='object'||!method)return methods.init.apply(this,arguments);else return $.error("Method "+method+" does not exist on jQuery.treetable");};this.TreeTable||(this.TreeTable={});this.TreeTable.Node=Node;this.TreeTable.Tree=Tree;})(jQuery);if("undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");+function(t){"use strict";var e=t.fn.jquery.split(" ")\[0\].split(".");if(e\[0\]<2&&e\[1\]<9||1==e\[0\]&&9==e\[1\]&&e\[2\]<1||e\[0\]>3)throw new Error("Bootstrap's JavaScript requires jQuery version 1.9.1 or higher, but lower than version 4");}(jQuery),+function(t){"use strict";function e(e){return this.each(function(){var i=t(this),o=i.data("bs.alert");o||i.data("bs.alert",o=new n(this)),"string"==typeof e&&o\[e\].call(i);});}var i='\[data-dismiss="alert"\]',n=function(e){t(e).on("click",i,this.close);};n.VERSION="3.3.7",n.TRANSITION\_DURATION=150,n.prototype.close=function(e){function i(){a.detach().trigger("closed.bs.alert").remove();}var o=t(this),s=o.attr("data-target");s||(s=o.attr("href"),s=s&&s.replace(/.\*(?=#\[^\\s\]\*$)/,""));var a=t("#"===s?\[\]:s);e&&e.preventDefault(),a.length||(a=o.closest(".alert")),a.trigger(e=t.Event("close.bs.alert")),e.isDefaultPrevented()||(a.removeClass("in"),t.support.transition&&a.hasClass("fade")?a.one("bsTransitionEnd",i).emulateTransitionEnd(n.TRANSITION\_DURATION):i());};var o=t.fn.alert;t.fn.alert=e,t.fn.alert.Constructor=n,t.fn.alert.noConflict=function(){return t.fn.alert=o,this;},t(document).on("click.bs.alert.data-api",i,n.prototype.close);}(jQuery),+function(t){"use strict";function e(e){var i=e.attr("data-target");i||(i=e.attr("href"),i=i&&/#\[A-Za-z\]/.test(i)&&i.replace(/.\*(?=#\[^\\s\]\*$)/,""));var n=i&&t(i);return n&&n.length?n:e.parent();}function i(i){i&&3===i.which||(t(o).remove(),t(s).each(function(){var n=t(this),o=e(n),s={relatedTarget:this};o.hasClass("open")&&(i&&"click"==i.type&&/input|textarea/i.test(i.target.tagName)&&t.contains(o\[0\],i.target)||(o.trigger(i=t.Event("hide.bs.dropdown",s)),i.isDefaultPrevented()||(n.attr("aria-expanded","false"),o.removeClass("open").trigger(t.Event("hidden.bs.dropdown",s)))));}));}function n(e){return this.each(function(){var i=t(this),n=i.data("bs.dropdown");n||i.data("bs.dropdown",n=new a(this)),"string"==typeof e&&n\[e\].call(i);});}var o=".dropdown-backdrop",s='\[data-toggle="dropdown"\]',a=function(e){t(e).on("click.bs.dropdown",this.toggle);};a.VERSION="3.3.7",a.prototype.toggle=function(n){var o=t(this);if(!o.is(".disabled, :disabled")){var s=e(o),a=s.hasClass("open");if(i(),!a){"ontouchstart" in document.documentElement&&!s.closest(".navbar-nav").length&&t(document.createElement("div")).addClass("dropdown-backdrop").insertAfter(t(this)).on("click",i);var r={relatedTarget:this};if(s.trigger(n=t.Event("show.bs.dropdown",r)),n.isDefaultPrevented())return;o.trigger("focus").attr("aria-expanded","true"),s.toggleClass("open").trigger(t.Event("shown.bs.dropdown",r));}return !1;}},a.prototype.keydown=function(i){if(/(38|40|27|32)/.test(i.which)&&!/input|textarea/i.test(i.target.tagName)){var n=t(this);if(i.preventDefault(),i.stopPropagation(),!n.is(".disabled, :disabled")){var o=e(n),a=o.hasClass("open");if(!a&&27!=i.which||a&&27==i.which)return 27==i.which&&o.find(s).trigger("focus"),n.trigger("click");var r=" li:not(.disabled):visible a",d=o.find(".dropdown-menu"+r);if(d.length){var l=d.index(i.target);38==i.which&&l>0&&l--,40==i.which&&l<d.length-1&&l++,~l||(l=0),d.eq(l).trigger("focus");}}}};var r=t.fn.dropdown;t.fn.dropdown=n,t.fn.dropdown.Constructor=a,t.fn.dropdown.noConflict=function(){return t.fn.dropdown=r,this;},t(document).on("click.bs.dropdown.data-api",i).on("click.bs.dropdown.data-api",".dropdown form",function(t){t.stopPropagation();}).on("click.bs.dropdown.data-api",s,a.prototype.toggle).on("keydown.bs.dropdown.data-api",s,a.prototype.keydown).on("keydown.bs.dropdown.data-api",".dropdown-menu",a.prototype.keydown);}(jQuery),+function(t){"use strict";function e(e,n){return this.each(function(){var o=t(this),s=o.data("bs.modal"),a=t.extend({},i.DEFAULTS,o.data(),"object"==typeof e&&e);s||o.data("bs.modal",s=new i(this,a)),"string"==typeof e?s\[e\](n):a.show&&s.show(n);});}var i=function(e,i){this.options=i,this.$body=t(document.body),this.$element=t(e),this.$dialog=this.$element.find(".modal-dialog"),this.$backdrop=null,this.isShown=null,this.originalBodyPad=null,this.scrollbarWidth=0,this.ignoreBackdropClick=!1,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,t.proxy(function(){this.$element.trigger("loaded.bs.modal");},this));};i.VERSION="3.3.7",i.TRANSITION\_DURATION=300,i.BACKDROP\_TRANSITION\_DURATION=150,i.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},i.prototype.toggle=function(t){return this.isShown?this.hide():this.show(t);},i.prototype.show=function(e){var n=this,o=t.Event("show.bs.modal",{relatedTarget:e});this.$element.trigger(o),this.isShown||o.isDefaultPrevented()||(this.isShown=!0,this.checkScrollbar(),this.setScrollbar(),this.$body.addClass("modal-open"),this.escape(),this.resize(),this.$element.on("click.dismiss.bs.modal",'\[data-dismiss="modal"\]',t.proxy(this.hide,this)),this.$dialog.on("mousedown.dismiss.bs.modal",function(){n.$element.one("mouseup.dismiss.bs.modal",function(e){t(e.target).is(n.$element)&&(n.ignoreBackdropClick=!0);});}),this.backdrop(function(){var o=t.support.transition&&n.$element.hasClass("fade");n.$element.parent().length||n.$element.appendTo(n.$body),n.$element.show().scrollTop(0),n.adjustDialog(),o&&n.$element\[0\].offsetWidth,n.$element.addClass("in"),n.enforceFocus();var s=t.Event("shown.bs.modal",{relatedTarget:e});o?n.$dialog.one("bsTransitionEnd",function(){n.$element.trigger("focus").trigger(s);}).emulateTransitionEnd(i.TRANSITION\_DURATION):n.$element.trigger("focus").trigger(s);}));},i.prototype.hide=function(e){e&&e.preventDefault(),e=t.Event("hide.bs.modal"),this.$element.trigger(e),this.isShown&&!e.isDefaultPrevented()&&(this.isShown=!1,this.escape(),this.resize(),t(document).off("focusin.bs.modal"),this.$element.removeClass("in").off("click.dismiss.bs.modal").off("mouseup.dismiss.bs.modal"),this.$dialog.off("mousedown.dismiss.bs.modal"),t.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",t.proxy(this.hideModal,this)).emulateTransitionEnd(i.TRANSITION\_DURATION):this.hideModal());},i.prototype.enforceFocus=function(){t(document).off("focusin.bs.modal").on("focusin.bs.modal",t.proxy(function(t){document===t.target||this.$element\[0\]===t.target||this.$element.has(t.target).length||this.$element.trigger("focus");},this));},i.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keydown.dismiss.bs.modal",t.proxy(function(t){27==t.which&&this.hide();},this)):this.isShown||this.$element.off("keydown.dismiss.bs.modal");},i.prototype.resize=function(){this.isShown?t(window).on("resize.bs.modal",t.proxy(this.handleUpdate,this)):t(window).off("resize.bs.modal");},i.prototype.hideModal=function(){var t=this;this.$element.hide(),this.backdrop(function(){t.$body.removeClass("modal-open"),t.resetAdjustments(),t.resetScrollbar(),t.$element.trigger("hidden.bs.modal");});},i.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null;},i.prototype.backdrop=function(e){var n=this,o=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var s=t.support.transition&&o;if(this.$backdrop=t(document.createElement("div")).addClass("modal-backdrop "+o).appendTo(this.$body),this.$element.on("click.dismiss.bs.modal",t.proxy(function(t){return this.ignoreBackdropClick?void (this.ignoreBackdropClick=!1):void (t.target===t.currentTarget&&("static"==this.options.backdrop?this.$element\[0\].focus():this.hide()));},this)),s&&this.$backdrop\[0\].offsetWidth,this.$backdrop.addClass("in"),!e)return;s?this.$backdrop.one("bsTransitionEnd",e).emulateTransitionEnd(i.BACKDROP\_TRANSITION\_DURATION):e();}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var a=function(){n.removeBackdrop(),e&&e();};t.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",a).emulateTransitionEnd(i.BACKDROP\_TRANSITION\_DURATION):a();}else e&&e();},i.prototype.handleUpdate=function(){this.adjustDialog();},i.prototype.adjustDialog=function(){var t=this.$element\[0\].scrollHeight>document.documentElement.clientHeight;this.$element.css({paddingLeft:!this.bodyIsOverflowing&&t?this.scrollbarWidth:"",paddingRight:this.bodyIsOverflowing&&!t?this.scrollbarWidth:""});},i.prototype.resetAdjustments=function(){this.$element.css({paddingLeft:"",paddingRight:""});},i.prototype.checkScrollbar=function(){var t=window.innerWidth;if(!t){var e=document.documentElement.getBoundingClientRect();t=e.right-Math.abs(e.left);}this.bodyIsOverflowing=document.body.clientWidth<t,this.scrollbarWidth=this.measureScrollbar();},i.prototype.setScrollbar=function(){var t=parseInt(this.$body.css("padding-right")||0,10);this.originalBodyPad=document.body.style.paddingRight||"",this.bodyIsOverflowing&&this.$body.css("padding-right",t+this.scrollbarWidth);},i.prototype.resetScrollbar=function(){this.$body.css("padding-right",this.originalBodyPad);},i.prototype.measureScrollbar=function(){var t=document.createElement("div");t.className="modal-scrollbar-measure",this.$body.append(t);var e=t.offsetWidth-t.clientWidth;return this.$body\[0\].removeChild(t),e;};var n=t.fn.modal;t.fn.modal=e,t.fn.modal.Constructor=i,t.fn.modal.noConflict=function(){return t.fn.modal=n,this;},t(document).on("click.bs.modal.data-api",'\[data-toggle="modal"\]',function(i){var n=t(this),o=n.attr("href"),s=t(n.attr("data-target")||o&&o.replace(/.\*(?=#\[^\\s\]+$)/,"")),a=s.data("bs.modal")?"toggle":t.extend({remote:!/#/.test(o)&&o},s.data(),n.data());n.is("a")&&i.preventDefault(),s.one("show.bs.modal",function(t){t.isDefaultPrevented()||s.one("hidden.bs.modal",function(){n.is(":visible")&&n.trigger("focus");});}),e.call(s,a,this);});}(jQuery),+function(t){"use strict";function e(e){var i,n=e.attr("data-target")||(i=e.attr("href"))&&i.replace(/.\*(?=#\[^\\s\]+$)/,"");return t(n);}function i(e){return this.each(function(){var i=t(this),o=i.data("bs.collapse"),s=t.extend({},n.DEFAULTS,i.data(),"object"==typeof e&&e);!o&&s.toggle&&/show|hide/.test(e)&&(s.toggle=!1),o||i.data("bs.collapse",o=new n(this,s)),"string"==typeof e&&o\[e\]();});}var n=function(e,i){this.$element=t(e),this.options=t.extend({},n.DEFAULTS,i),this.$trigger=t('\[data-toggle="collapse"\]\[href="#'+e.id+'"\],\[data-toggle="collapse"\]\[data-target="#'+e.id+'"\]'),this.transitioning=null,this.options.parent?this.$parent=this.getParent():this.addAriaAndCollapsedClass(this.$element,this.$trigger),this.options.toggle&&this.toggle();};n.VERSION="3.3.7",n.TRANSITION\_DURATION=350,n.DEFAULTS={toggle:!0},n.prototype.dimension=function(){var t=this.$element.hasClass("width");return t?"width":"height";},n.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var e,o=this.$parent&&this.$parent.children(".panel").children(".in, .collapsing");if(!(o&&o.length&&(e=o.data("bs.collapse"),e&&e.transitioning))){var s=t.Event("show.bs.collapse");if(this.$element.trigger(s),!s.isDefaultPrevented()){o&&o.length&&(i.call(o,"hide"),e||o.data("bs.collapse",null));var a=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")\[a\](0).attr("aria-expanded",!0),this.$trigger.removeClass("collapsed").attr("aria-expanded",!0),this.transitioning=1;var r=function(){this.$element.removeClass("collapsing").addClass("collapse in")\[a\](""),this.transitioning=0,this.$element.trigger("shown.bs.collapse");};if(!t.support.transition)return r.call(this);var d=t.camelCase(\["scroll",a\].join("-"));this.$element.one("bsTransitionEnd",t.proxy(r,this)).emulateTransitionEnd(n.TRANSITION\_DURATION)\[a\](this.$element\[0\]\[d\]);}}}},n.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var e=t.Event("hide.bs.collapse");if(this.$element.trigger(e),!e.isDefaultPrevented()){var i=this.dimension();this.$element\[i\](this.$element\[i\]())\[0\].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse in").attr("aria-expanded",!1),this.$trigger.addClass("collapsed").attr("aria-expanded",!1),this.transitioning=1;var o=function(){this.transitioning=0,this.$element.removeClass("collapsing").addClass("collapse").trigger("hidden.bs.collapse");};return t.support.transition?void this.$element\[i\](0).one("bsTransitionEnd",t.proxy(o,this)).emulateTransitionEnd(n.TRANSITION\_DURATION):o.call(this);}}},n.prototype.toggle=function(){this\[this.$element.hasClass("in")?"hide":"show"\]();},n.prototype.getParent=function(){return t(this.options.parent).find('\[data-toggle="collapse"\]\[data-parent="'+this.options.parent+'"\]').each(t.proxy(function(i,n){var o=t(n);this.addAriaAndCollapsedClass(e(o),o);},this)).end();},n.prototype.addAriaAndCollapsedClass=function(t,e){var i=t.hasClass("in");t.attr("aria-expanded",i),e.toggleClass("collapsed",!i).attr("aria-expanded",i);};var o=t.fn.collapse;t.fn.collapse=i,t.fn.collapse.Constructor=n,t.fn.collapse.noConflict=function(){return t.fn.collapse=o,this;},t(document).on("click.bs.collapse.data-api",'\[data-toggle="collapse"\]',function(n){var o=t(this);o.attr("data-target")||n.preventDefault();var s=e(o),a=s.data("bs.collapse"),r=a?"toggle":o.data();i.call(s,r);});}(jQuery),+function(t){"use strict";function e(){var t=document.createElement("bootstrap"),e={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var i in e)if(void 0!==t.style\[i\])return{end:e\[i\]};return !1;}t.fn.emulateTransitionEnd=function(e){var i=!1,n=this;t(this).one("bsTransitionEnd",function(){i=!0;});var o=function(){i||t(n).trigger(t.support.transition.end);};return setTimeout(o,e),this;},t(function(){t.support.transition=e(),t.support.transition&&(t.event.special.bsTransitionEnd={bindType:t.support.transition.end,delegateType:t.support.transition.end,handle:function(e){return t(e.target).is(this)?e.handleObj.handler.apply(this,arguments):void 0;}});});}(jQuery);function openRuleDetailsDialog(rule\_result\_id){$("#detail-modal").remove();var closebutton=$('<button type="button" class="close btn btn-sm btn-default" data-dismiss="modal" aria-hidden="true" title="Close">&#x274c;</button>');var modal=$('<div id="detail-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"><div id="detail-modal-body" class="modal-body"></div></div>');$("body").prepend(modal);var clone=$("#rule-detail-"+rule\_result\_id).clone();clone.attr("id","");clone.children(".panel-heading").append(closebutton);closebutton.css({"float":"right"});closebutton.css({"margin-top":"-=23px"});$("#detail-modal-body").append(clone);$("#detail-modal").modal();return false;}function toggleRuleDisplay(checkbox){var result=checkbox.value;if(checkbox.checked){$(".rule-overview-leaf-"+result).removeClass("rule-result-filtered");$(".rule-detail-"+result).removeClass("rule-result-filtered");}else{$(".rule-overview-leaf-"+result).addClass("rule-result-filtered");$(".rule-detail-"+result).addClass("rule-result-filtered");}stripeTreeTable();}function toggleResultDetails(button){var result\_details=$("#result-details");if(result\_details.is(":visible")){result\_details.hide();$(button).html("Show all result details");}else{result\_details.show();$(button).html("Hide all result details");}return false;}function ruleSearchMatches(detail\_leaf,keywords){if(keywords.length==0)return true;var match=true;var checked\_keywords=detail\_leaf.children(".keywords").text().toLowerCase();var index;for(index=0;index<keywords.length;++index)if(checked\_keywords.indexOf(keywords\[index\].toLowerCase())<0){match=false;break;}return match;}function ruleSearch(){var search\_input=$("#search-input").val();var keywords=search\_input.split(/\[\\s,\\.;\]+/);var matches=0;$(".rule-detail").each(function(){var rrid=$(this).attr("id").substring(12);var overview\_leaf=$("#rule-overview-leaf-"+rrid);var detail\_leaf=$(this);if(ruleSearchMatches(detail\_leaf,keywords)){overview\_leaf.removeClass("search-no-match");detail\_leaf.removeClass("search-no-match");++matches;}else{overview\_leaf.addClass("search-no-match");detail\_leaf.addClass("search-no-match");}});if(!search\_input)$("#search-matches").html("");else if(matches>0)$("#search-matches").html(matches.toString()+" rules match.");else $("#search-matches").html("No rules match your search criteria!");}var is\_original=true;var original\_treetable=null;$(document).ready(function(){$("#result-details").hide();$(".js-only").show();$(".form-group select").val("default");$(".toggle-rule-display").each(function(){toggleRuleDisplay(this);});original\_treetable=$(".treetable").clone();$(".treetable").treetable({column:0,expandable:true,clickableNodeNames:true,initialState:"expanded",indent:0});is\_original=true;stripeTreeTable();});function resetTreetable(){if(!is\_original){$(".treetable").remove();$("#rule-overview").append(original\_treetable.clone());$(".treetable").treetable({column:0,expandable:true,clickableNodeNames:true,initialState:"expanded",indent:0});$(".toggle-rule-display").each(function(){toggleRuleDisplay(this);});is\_original=true;}}function newGroupLine(key,group\_name){var maxKeyLength=24;if(key.length>maxKeyLength)key=key.substring(0,maxKeyLength-1)+"…";return "<tr class=\\"rule-overview-inner-node\\" data-tt-id=\\""+group\_name+"\\">"+"<td colspan=\\"3\\"><small>"+key+"</small> = <strong>"+group\_name+"</strong></td></tr>";}var KeysEnum={DEFAULT:"default",SEVERITY:"severity",RESULT:"result",NIST:"NIST SP 800-53 ID",DISA\_CCI:"DISA CCI",DISA\_SRG:"DISA SRG",DISA\_STIG\_ID:"DISA STIG ID",PCI\_DSS:"PCI DSS Requirement",CIS:"CIS Recommendation"};function getTargetGroupsList(rule,key){switch(key){case KeysEnum.SEVERITY:var severity=rule.children(".rule-severity").text();return \[severity\];case KeysEnum.RESULT:var result=rule.children(".rule-result").text();return \[result\];default:try{var references=JSON.parse(rule.attr("data-references"));}catch(err){return \["unknown"\];}if(!references.hasOwnProperty(key))return \["unknown"\];return references\[key\];}}function sortGroups(groups,key){switch(key){case KeysEnum.SEVERITY:return \["high","medium","low"\];case KeysEnum.RESULT:return groups.sort();default:return groups.sort(function(a,b){var a\_parts=a.split(/\[.()-\]/);var b\_parts=b.split(/\[.()-\]/);var result=0;var min\_length=Math.min(a\_parts.length,b\_parts.length);var number=/^\[1-9\]\[0-9\]\*$/;for(i=0;i<min\_length&&result==0;i++)if(a\_parts\[i\].match(number)==null||a\_parts\[i\].match(number)==null)result=a\_parts\[i\].localeCompare(b\_parts\[i\]);else result=parseInt(a\_parts\[i\])-parseInt(b\_parts\[i\]);if(result==0)result=a\_parts.length-b\_parts.length;return result;});}}function groupRulesBy(key){resetTreetable();if(key==KeysEnum.DEFAULT)return;var lines={};$(".rule-overview-leaf").each(function(){$(this).children("td:first").css("padding-left","0px");var id=$(this).attr("data-tt-id");var target\_groups=getTargetGroupsList($(this),key);for(i=0;i<target\_groups.length;i++){var target\_group=target\_groups\[i\];if(!lines.hasOwnProperty(target\_group))lines\[target\_group\]=\[newGroupLine(key,target\_group)\];var clone=$(this).clone();clone.attr("data-tt-id",id+"copy"+i);clone.attr("data-tt-parent-id",target\_group);var new\_line=clone.wrap("<div>").parent().html();lines\[target\_group\].push(new\_line);}});$(".treetable").remove();var groups=sortGroups(Object.keys(lines),key);var html\_text="";for(i=0;i<groups.length;i++)html\_text+=lines\[groups\[i\]\].join("\\n");new\_table="<table class=\\"treetable table table-bordered\\"><thead><tr><th>Group</th> <th style=\\"width: 120px; text-align: center\\">Severity</th><th style=\\"width: 120px; text-align: center\\">Result</th></tr></thead><tbody>"+html\_text+"</tbody></table>";$("#rule-overview").append(new\_table);is\_original=false;$(".treetable").treetable({column:0,expandable:true,clickableNodeNames:true,initialState:"expanded",indent:0});stripeTreeTable();}function stripeTreeTable(){var rows=$(".rule-overview-leaf:not(.rule-result-filtered)");var even=false;$(rows).each(function(){$(this).css("background-color",even?"#F9F9F9":"inherit");even=!even;});}

[](#)

OpenSCAP Security Guide
=======================

Guide to the Secure Configuration of Red Hat Enterprise Linux 7
---------------------------------------------------------------

> with profile DISA STIG for Red Hat Enterprise Linux 7
> 
> This profile contains configuration checks that align to the DISA STIG for Red Hat Enterprise Linux V3R4. In addition to being applicable to Red Hat Enterprise Linux 7, DISA recognizes this configuration baseline as applicable to the operating system tier of Red Hat technologies that are based on Red Hat Enterprise Linux 7, such as: - Red Hat Enterprise Linux Server - Red Hat Enterprise Linux Workstation and Desktop - Red Hat Enterprise Linux for HPC - Red Hat Storage - Red Hat Containers with a Red Hat Enterprise Linux 7 image

The SCAP Security Guide Project  
[https://www.open-scap.org/security-policies/scap-security-guide](https://www.open-scap.org/security-policies/scap-security-guide)

This guide presents a catalog of security-relevant configuration settings for Red Hat Enterprise Linux 7. It is a rendering of content structured in the eXtensible Configuration Checklist Description Format (XCCDF) in order to support security automation. The SCAP content is is available in the `scap-security-guide` package which is developed at [https://www.open-scap.org/security-policies/scap-security-guide](https://www.open-scap.org/security-policies/scap-security-guide).  
  
Providing system administrators with such guidance informs them how to securely configure systems under their control in a variety of network roles. Policy makers and baseline creators can use this catalog of settings, with its associated references to higher-level security control catalogs, in order to assist them in security baseline creation. This guide is a _catalog, not a checklist_, and satisfaction of every item is not likely to be possible or sensible in many operational scenarios. However, the XCCDF format enables granular selection and adjustment of settings, and their association with OVAL and OCIL content provides an automated checking capability. Transformations of this document, and its associated automated checking content, are capable of providing baselines that meet a diverse set of policy objectives. Some example XCCDF _Profiles_, which are selections of items that form checklists and can be used as baselines, are available with this guide. They can be processed, in an automated fashion, with tools that support the Security Content Automation Protocol (SCAP). The DISA STIG, which provides required settings for US Department of Defense systems, is one example of a baseline created from this guidance.

Do not attempt to implement any of the settings in this guide without first testing them in a non-operational environment. The creators of this guidance assume no responsibility whatsoever for its use by other parties, and makes no guarantees, expressed or implied, about its quality, reliability, or any other characteristic.

Profile Title

DISA STIG for Red Hat Enterprise Linux 7

Profile ID

xccdf\_org.ssgproject.content\_profile\_stig

Revision History
----------------

Current version: **0.1.58**

*   **draft** (as of 2021-09-05)

Platforms
---------

*   cpe:/o:redhat:enterprise\_linux:7
*   cpe:/o:redhat:enterprise\_linux:7::server
*   cpe:/o:redhat:enterprise\_linux:7::client
*   cpe:/o:redhat:enterprise\_linux:7::computenode
*   cpe:/o:redhat:enterprise\_linux:7::workstation

Table of Contents
-----------------

1.  [System Settings](#xccdf_org.ssgproject.content_group_system)

1.  [Installing and Maintaining Software](#xccdf_org.ssgproject.content_group_software)
2.  [Account and Access Control](#xccdf_org.ssgproject.content_group_accounts)
3.  [System Accounting with auditd](#xccdf_org.ssgproject.content_group_auditing)
4.  [GRUB2 bootloader configuration](#xccdf_org.ssgproject.content_group_bootloader-grub2)
5.  [Configure Syslog](#xccdf_org.ssgproject.content_group_logging)
6.  [Network Configuration and Firewalls](#xccdf_org.ssgproject.content_group_network)
7.  [File Permissions and Masks](#xccdf_org.ssgproject.content_group_permissions)
8.  [SELinux](#xccdf_org.ssgproject.content_group_selinux)

3.  [Services](#xccdf_org.ssgproject.content_group_services)

1.  [Base Services](#xccdf_org.ssgproject.content_group_base)
2.  [Cron and At Daemons](#xccdf_org.ssgproject.content_group_cron_and_at)
3.  [FTP Server](#xccdf_org.ssgproject.content_group_ftp)
4.  [Mail Server Software](#xccdf_org.ssgproject.content_group_mail)
5.  [NFS and RPC](#xccdf_org.ssgproject.content_group_nfs_and_rpc)
6.  [Network Time Protocol](#xccdf_org.ssgproject.content_group_ntp)
7.  [Obsolete Services](#xccdf_org.ssgproject.content_group_obsolete)
8.  [SNMP Server](#xccdf_org.ssgproject.content_group_snmp)
9.  [SSH Server](#xccdf_org.ssgproject.content_group_ssh)
10.  [System Security Services Daemon](#xccdf_org.ssgproject.content_group_sssd)
11.  [X Window System](#xccdf_org.ssgproject.content_group_xwindows)

Checklist
---------

contains 260 rules

### System Settings   [\[ref\]](#xccdf_org.ssgproject.content_group_system)group

Contains rules that check correct system settings.

contains 212 rules

### Installing and Maintaining Software   [\[ref\]](#xccdf_org.ssgproject.content_group_software)group

The following sections contain information on security-relevant choices during the initial operating system installation process and the setup of software updates.

contains 44 rules

### System and Software Integrity   [\[ref\]](#xccdf_org.ssgproject.content_group_integrity)group

System and software integrity can be gained by installing antivirus, increasing system encryption strength with FIPS, verifying installed software, enabling SELinux, installing an Intrusion Prevention System, etc. However, installing or enabling integrity checking tools cannot _prevent_ intrusions, but they can detect that an intrusion may have occurred. Requirements for integrity checking may be highly dependent on the environment in which the system will be used. Snapshot-based approaches such as AIDE may induce considerable overhead in the presence of frequent software updates.

contains 15 rules

### Software Integrity Checking   [\[ref\]](#xccdf_org.ssgproject.content_group_software-integrity)group

Both the AIDE (Advanced Intrusion Detection Environment) software and the RPM package management system provide mechanisms for verifying the integrity of installed software. AIDE uses snapshots of file metadata (such as hashes) and compares these to current system files in order to detect changes.  
  
The RPM package management system can conduct integrity checks by comparing information in its metadata database with files installed on the system.

contains 9 rules

### Verify Integrity with RPM   [\[ref\]](#xccdf_org.ssgproject.content_group_rpm_verification)group

The RPM package management system includes the ability to verify the integrity of installed packages by comparing the installed files with information about the files taken from the package metadata stored in the RPM database. Although an attacker could corrupt the RPM database (analogous to attacking the AIDE database as described above), this check can still reveal modification of important files. To list which files on the system differ from what is expected by the RPM database:

$ rpm -qVa

See the man page for `rpm` to see a complete explanation of each column.

contains 3 rules

#### Verify File Hashes with RPM   [\[ref\]](#xccdf_org.ssgproject.content_rule_rpm_verify_hashes)rule

Without cryptographic integrity protections, system executables and files can be altered by unauthorized users without detection. The RPM package management system can check the hashes of installed software packages, including many that are important to system security. To verify that the cryptographic hash of system files and commands matches vendor values, run the following command to list which files on the system have hashes that differ from what is expected by the RPM database:

$ rpm -Va --noconfig | grep '^..5'

A "c" in the second column indicates that a file is a configuration file, which may appropriately be expected to change. If the file was not expected to change, investigate the cause of the change using audit logs or other means. The package can then be reinstalled to restore the file. Run the following command to determine which package owns the file:

$ rpm -qf _FILENAME_

The package can be reinstalled from a yum repository using the command:

$ sudo yum reinstall _PACKAGENAME_

Alternatively, the package can be reinstalled from trusted media using the command:

$ sudo rpm -Uvh _PACKAGENAME_

Rationale:

The hashes of important files like system executables should match the information given by the RPM database. Executables with erroneous hashes could be a sign of nefarious activity on the system.

Severity:  high

Identifiers:  CCE-27157-7

References:  [11](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.4.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.3.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.4.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001749](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(c)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(c)(2)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.2.1](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [CM-6(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(6)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-9(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.DS-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-8](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-11.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-214799r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [6.1.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    
    # Find which files have incorrect hash (not in /etc, because of the system related config files) and then get files names
    files_with_incorrect_hash="$(rpm -Va --noconfig | grep -E '^..5' | awk '{print $NF}' )"
    
    # From files names get package names and change newline to space, because rpm writes each package to new line
    packages_to_reinstall="$(rpm -qf $files_with_incorrect_hash | tr '\n' ' ')"
    
    yum reinstall -y $packages_to_reinstall
    

Remediation Ansible snippet:   (show)  
  

Complexity:

high

Disruption:

medium

Strategy:

restrict

    - name: 'Set fact: Package manager reinstall command (dnf)'
      set_fact:
        package_manager_reinstall_cmd: dnf reinstall -y
      when: ansible_distribution == "Fedora"
      tags:
        - CCE-27157-7
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010020
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_hashes
    
    - name: 'Set fact: Package manager reinstall command (yum)'
      set_fact:
        package_manager_reinstall_cmd: yum reinstall -y
      when: (ansible_distribution == "RedHat" or ansible_distribution == "OracleLinux")
      tags:
        - CCE-27157-7
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010020
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_hashes
    
    - name: Read files with incorrect hash
      command: rpm -Va --nodeps --nosize --nomtime --nordev --nocaps --nolinkto --nouser
        --nogroup --nomode --noghost --noconfig
      args:
        warn: false
      register: files_with_incorrect_hash
      changed_when: false
      failed_when: files_with_incorrect_hash.rc > 1
      check_mode: false
      when: (package_manager_reinstall_cmd is defined)
      tags:
        - CCE-27157-7
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010020
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_hashes
    
    - name: Create list of packages
      command: rpm -qf "{{ item }}"
      args:
        warn: false
      with_items: '{{ files_with_incorrect_hash.stdout_lines | map(''regex_findall'',
        ''^[.]+[5]+.* (\/.*)'', ''\1'') | map(''join'') | select(''match'', ''(\/.*)'')
        | list | unique }}'
      register: list_of_packages
      changed_when: false
      check_mode: false
      when:
        - files_with_incorrect_hash.stdout_lines is defined
        - (files_with_incorrect_hash.stdout_lines | length > 0)
      tags:
        - CCE-27157-7
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010020
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_hashes
    
    - name: Reinstall packages of files with incorrect hash
      command: '{{ package_manager_reinstall_cmd }} ''{{ item }}'''
      args:
        warn: false
      with_items: '{{ list_of_packages.results | map(attribute=''stdout_lines'') | list
        | unique }}'
      when:
        - files_with_incorrect_hash.stdout_lines is defined
        - (package_manager_reinstall_cmd is defined and (files_with_incorrect_hash.stdout_lines
          | length > 0))
      tags:
        - CCE-27157-7
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010020
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_hashes
    

#### Verify and Correct Ownership with RPM   [\[ref\]](#xccdf_org.ssgproject.content_rule_rpm_verify_ownership)rule

The RPM package management system can check file ownership permissions of installed software packages, including many that are important to system security. After locating a file with incorrect permissions, which can be found with

rpm -Va | awk '{ if (substr($0,6,1)=="U" || substr($0,7,1)=="G") print $NF }'

run the following command to determine which package owns it:

$ rpm -qf _FILENAME_

Next, run the following command to reset its permissions to the correct values:

$ sudo rpm --setugids _PACKAGENAME_

Warning:  Profiles may require that specific files be owned by root while the default owner defined by the vendor is different. Such files will be reported as a finding and need to be evaluated according to your policy and deployment environment.

Rationale:

Ownership of binaries and configuration files that is incorrect could allow an unauthorized user to gain privileges that they should not have. The ownership set by the vendor should be maintained. Any deviations from this baseline should be investigated.

Severity:  high

Identifiers:  CCE-80545-7

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.4.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.3.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.4.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-001494](https://public.cyber.mil/stigs/cci/), [CCI-001496](https://public.cyber.mil/stigs/cci/), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R6](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(6)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-9(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-11.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000256-GPOS-00097](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000257-GPOS-00098](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000278-GPOS-00108](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204392r646841\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.7.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/), [1.7.1.5](https://www.cisecurity.org/benchmark/red_hat_linux/), [1.7.1.6](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.1](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.2](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.3](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.5](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.6](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.7](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.8](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

high

Disruption:

medium

Strategy:

restrict

    
    # Declare array to hold set of RPM packages we need to correct permissions for
    declare -A SETPERMS_RPM_DICT
    
    # Create a list of files on the system having permissions different from what
    # is expected by the RPM database
    readarray -t FILES_WITH_INCORRECT_PERMS < <(rpm -Va --nofiledigest | awk '{ if (substr($0,6,1)=="U" || substr($0,7,1)=="G") print $NF }')
    
    for FILE_PATH in "${FILES_WITH_INCORRECT_PERMS[@]}"
    do
            RPM_PACKAGE=$(rpm -qf "$FILE_PATH")
    	# Use an associative array to store packages as it's keys, not having to care about duplicates.
    	SETPERMS_RPM_DICT["$RPM_PACKAGE"]=1
    done
    
    # For each of the RPM packages left in the list -- reset its permissions to the
    # correct values
    for RPM_PACKAGE in "${!SETPERMS_RPM_DICT[@]}"
    do
            rpm --setugids "${RPM_PACKAGE}"
    done
    

Remediation Ansible snippet:   (show)  
  

Complexity:

high

Disruption:

medium

Strategy:

restrict

    - name: Read list of files with incorrect ownership
      command: rpm -Va --nodeps --nosignature --nofiledigest --nosize --nomtime --nordev
        --nocaps --nolinkto --nomode
      args:
        warn: false
      register: files_with_incorrect_ownership
      failed_when: files_with_incorrect_ownership.rc > 1
      changed_when: false
      check_mode: false
      tags:
        - CCE-80545-7
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010010
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_ownership
    
    - name: Create list of packages
      command: rpm -qf "{{ item }}"
      args:
        warn: false
      with_items: '{{ files_with_incorrect_ownership.stdout_lines | map(''regex_findall'',
        ''^[.]+[U|G]+.* (\/.*)'', ''\1'') | map(''join'') | select(''match'', ''(\/.*)'')
        | list | unique }}'
      register: list_of_packages
      changed_when: false
      check_mode: false
      when: (files_with_incorrect_ownership.stdout_lines | length > 0)
      tags:
        - CCE-80545-7
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010010
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_ownership
    
    - name: Correct file ownership with RPM
      command: rpm --quiet --setugids '{{ item }}'
      args:
        warn: false
      with_items: '{{ list_of_packages.results | map(attribute=''stdout_lines'') | list
        | unique }}'
      when: (files_with_incorrect_ownership.stdout_lines | length > 0)
      tags:
        - CCE-80545-7
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010010
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_ownership
    

#### Verify and Correct File Permissions with RPM   [\[ref\]](#xccdf_org.ssgproject.content_rule_rpm_verify_permissions)rule

The RPM package management system can check file access permissions of installed software packages, including many that are important to system security. Verify that the file permissions of system files and commands match vendor values. Check the file permissions with the following command:

$ sudo rpm -Va | awk '{ if (substr($0,2,1)=="M") print $NF }'

Output indicates files that do not match vendor defaults. After locating a file with incorrect permissions, run the following command to determine which package owns it:

$ rpm -qf _FILENAME_

  
Next, run the following command to reset its permissions to the correct values:

$ sudo rpm --setperms _PACKAGENAME_

Warning:  Profiles may require that specific files have stricter file permissions than defined by the vendor. Such files will be reported as a finding and need to be evaluated according to your policy and deployment environment.

Rationale:

Permissions on system binaries and configuration files that are too generous could allow an unauthorized user to gain privileges that they should not have. The permissions set by the vendor should be maintained. Any deviations from this baseline should be investigated.

Severity:  high

Identifiers:  CCE-27209-6

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.4.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.3.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.4.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-001493](https://public.cyber.mil/stigs/cci/), [CCI-001494](https://public.cyber.mil/stigs/cci/), [CCI-001495](https://public.cyber.mil/stigs/cci/), [CCI-001496](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(c)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(c)(2)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R6](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(6)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-9(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-11.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000256-GPOS-00097](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000257-GPOS-00098](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000258-GPOS-00099](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000278-GPOS-00108](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204392r646841\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.7.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/), [1.7.1.5](https://www.cisecurity.org/benchmark/red_hat_linux/), [1.7.1.6](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.1](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.2](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.3](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.5](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.6](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.7](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.8](https://www.cisecurity.org/benchmark/red_hat_linux/), [6.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

high

Disruption:

medium

Strategy:

restrict

    
    # Declare array to hold set of RPM packages we need to correct permissions for
    declare -A SETPERMS_RPM_DICT
    
    # Create a list of files on the system having permissions different from what
    # is expected by the RPM database
    readarray -t FILES_WITH_INCORRECT_PERMS < <(rpm -Va --nofiledigest | awk '{ if (substr($0,2,1)=="M") print $NF }')
    
    for FILE_PATH in "${FILES_WITH_INCORRECT_PERMS[@]}"
    do
            # NOTE: some files maybe controlled by more then one package
            readarray -t RPM_PACKAGES < <(rpm -qf "${FILE_PATH}")
            for RPM_PACKAGE in "${RPM_PACKAGES[@]}"
            do
                    # Use an associative array to store packages as it's keys, not having to care about duplicates.
                    SETPERMS_RPM_DICT["$RPM_PACKAGE"]=1
            done
    done
    
    # For each of the RPM packages left in the list -- reset its permissions to the
    # correct values
    for RPM_PACKAGE in "${!SETPERMS_RPM_DICT[@]}"
    do
    	rpm --restore "${RPM_PACKAGE}"
    done
    

Remediation Ansible snippet:   (show)  
  

Complexity:

high

Disruption:

medium

Strategy:

restrict

    - name: Read list of files with incorrect permissions
      command: rpm -Va --nodeps --nosignature --nofiledigest --nosize --nomtime --nordev
        --nocaps --nolinkto --nouser --nogroup
      args:
        warn: false
      register: files_with_incorrect_permissions
      failed_when: files_with_incorrect_permissions.rc > 1
      changed_when: false
      check_mode: false
      tags:
        - CCE-27209-6
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010010
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_permissions
    
    - name: Create list of packages
      command: rpm -qf "{{ item }}"
      args:
        warn: false
      with_items: '{{ files_with_incorrect_permissions.stdout_lines | map(''regex_findall'',
        ''^[.]+[M]+.* (\/.*)'', ''\1'') | map(''join'') | select(''match'', ''(\/.*)'')
        | list | unique }}'
      register: list_of_packages
      changed_when: false
      check_mode: false
      when: (files_with_incorrect_permissions.stdout_lines | length > 0)
      tags:
        - CCE-27209-6
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010010
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_permissions
    
    - name: Correct file permissions with RPM
      command: rpm --setperms '{{ item }}'
      args:
        warn: false
      with_items: '{{ list_of_packages.results | map(attribute=''stdout_lines'') | list
        | unique }}'
      when: (files_with_incorrect_permissions.stdout_lines | length > 0)
      tags:
        - CCE-27209-6
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-010010
        - NIST-800-171-3.3.8
        - NIST-800-171-3.4.1
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-6(c)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - NIST-800-53-SI-7(6)
        - PCI-DSS-Req-11.5
        - high_complexity
        - high_severity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy
        - rpm_verify_permissions
    

### Verify Integrity with AIDE   [\[ref\]](#xccdf_org.ssgproject.content_group_aide)group

AIDE conducts integrity checks by comparing information about files with previously-gathered information. Ideally, the AIDE database is created immediately after initial system configuration, and then again after any software update. AIDE is highly configurable, with further configuration information located in `/usr/share/doc/aide-_VERSION_`.

contains 6 rules

#### Install AIDE   [\[ref\]](#xccdf_org.ssgproject.content_rule_package_aide_installed)rule

The `aide` package can be installed with the following command:

$ sudo yum install aide

Rationale:

The AIDE package must be installed if it is to be available for integrity checking.

Severity:  medium

Identifiers:  CCE-27096-7

References:  [BP28(R51)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1.3](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [BAI01.06](https://www.isaca.org/resources/cobit), [BAI02.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS04.07](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-002699](https://public.cyber.mil/stigs/cci/), [CCI-001744](https://public.cyber.mil/stigs/cci/), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 1034, 1288, 1341, 1417, [A.11.2.4](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.2.1](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-8](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-11.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000363-GPOS-00150](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [1.3.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if ! rpm -q --quiet "aide" ; then
        yum install -y "aide"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    - name: Ensure aide is installed
      package:
        name: aide
        state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27096-7
        - CJIS-5.10.1.3
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-11.5
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_aide_installed
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    include install_aide
    
    class install_aide {
      package { 'aide':
        ensure => 'installed',
      }
    }
    

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    
    package --add=aide
    

Remediation script:   (show)  
  

    
    [[packages]]
    name = "aide"
    version = "*"
    

#### Configure Periodic Execution of AIDE   [\[ref\]](#xccdf_org.ssgproject.content_rule_aide_periodic_cron_checking)rule

At a minimum, AIDE should be configured to run a weekly scan. To implement a daily execution of AIDE at 4:05am using cron, add the following line to `/etc/crontab`:

05 4 \* \* \* root /usr/sbin/aide --check

To implement a weekly execution of AIDE at 4:05am using cron, add the following line to `/etc/crontab`:

05 4 \* \* 0 root /usr/sbin/aide --check

AIDE can be executed periodically through other means; this is merely one example. The usage of cron's special time codes, such as `@daily` and `@weekly` is acceptable.

Rationale:

By default, AIDE does not install itself for periodic execution. Periodically running AIDE is necessary to reveal unexpected changes in installed files.  
  
Unauthorized changes to the baseline configuration could make the system vulnerable to various attacks or allow unauthorized access to the operating system. Changes to operating system configurations can have unintended side effects, some of which may be relevant to security.  
  
Detecting such changes and providing an automated response can help avoid unintended, negative consequences that could ultimately affect the security state of the operating system. The operating system's Information Management Officer (IMO)/Information System Security Officer (ISSO) and System Administrators (SAs) must be notified via email and/or monitoring system trap when there is an unauthorized modification of a configuration item.

Severity:  medium

Identifiers:  CCE-26952-2

References:  [BP28(R51)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1.3](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [BAI01.06](https://www.isaca.org/resources/cobit), [BAI02.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS04.07](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-001744](https://public.cyber.mil/stigs/cci/), [CCI-002699](https://public.cyber.mil/stigs/cci/), [CCI-002702](https://public.cyber.mil/stigs/cci/), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.2.1](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [SI-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-8](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-11.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000363-GPOS-00150](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000446-GPOS-00200](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000447-GPOS-00201](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020030](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204445r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.3.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if ! rpm -q --quiet "aide" ; then
        yum install -y "aide"
    fi
    
    if ! grep -q "/usr/sbin/aide --check" /etc/crontab ; then
        echo "05 4 * * * root /usr/sbin/aide --check" >> /etc/crontab
    else
        sed -i '/^.*\/usr\/sbin\/aide --check.*$/d' /etc/crontab
        echo "05 4 * * * root /usr/sbin/aide --check" >> /etc/crontab
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Ensure AIDE is installed
      package:
        name: '{{ item }}'
        state: present
      with_items:
        - aide
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-26952-2
        - CJIS-5.10.1.3
        - DISA-STIG-RHEL-07-020030
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - PCI-DSS-Req-11.5
        - aide_periodic_cron_checking
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Configure Periodic Execution of AIDE
      cron:
        name: run AIDE check
        minute: 5
        hour: 4
        weekday: 0
        user: root
        job: /usr/sbin/aide --check
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-26952-2
        - CJIS-5.10.1.3
        - DISA-STIG-RHEL-07-020030
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-7
        - NIST-800-53-SI-7(1)
        - PCI-DSS-Req-11.5
        - aide_periodic_cron_checking
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Configure Notification of Post-AIDE Scan Details   [\[ref\]](#xccdf_org.ssgproject.content_rule_aide_scan_notification)rule

AIDE should notify appropriate personnel of the details of a scan after the scan has been run. If AIDE has already been configured for periodic execution in `/etc/crontab`, append the following line to the existing AIDE line:

 | /bin/mail -s "$(hostname) - AIDE Integrity Check" root@localhost

Otherwise, add the following line to `/etc/crontab`:

05 4 \* \* \* root /usr/sbin/aide --check | /bin/mail -s "$(hostname) - AIDE Integrity Check" root@localhost

AIDE can be executed periodically through other means; this is merely one example.

Rationale:

Unauthorized changes to the baseline configuration could make the system vulnerable to various attacks or allow unauthorized access to the operating system. Changes to operating system configurations can have unintended side effects, some of which may be relevant to security.  
  
Detecting such changes and providing an automated response can help avoid unintended, negative consequences that could ultimately affect the security state of the operating system. The operating system's Information Management Officer (IMO)/Information System Security Officer (ISSO) and System Administrators (SAs) must be notified via email and/or monitoring system trap when there is an unauthorized modification of a configuration item.

Severity:  medium

Identifiers:  CCE-80374-2

References:  [BP28(R51)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI01.06](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [CCI-001744](https://public.cyber.mil/stigs/cci/), [CCI-002702](https://public.cyber.mil/stigs/cci/), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-3(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000363-GPOS-00150](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000447-GPOS-00201](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020040](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204446r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    
    if ! rpm -q --quiet "aide" ; then
        yum install -y "aide"
    fi
    var_aide_scan_notification_email="root@localhost"
    
    
    
        
    
    
    
    
    CRONTAB=/etc/crontab
    CRONDIRS='/etc/cron.d /etc/cron.daily /etc/cron.weekly /etc/cron.monthly'
    
    # NOTE: on some platforms, /etc/crontab may not exist
    if [ -f /etc/crontab ]; then
    	CRONTAB_EXIST=/etc/crontab
    fi
    
    if [ -f /var/spool/cron/root ]; then
    	VARSPOOL=/var/spool/cron/root
    fi
    
    if ! grep -qR '^.*/usr/sbin/aide\s*\-\-check.*|.*\/bin\/mail\s*-s\s*".*"\s*.*@.*$' $CRONTAB_EXIST $VARSPOOL $CRONDIRS; then
    	echo "0 5 * * * root /usr/sbin/aide  --check | /bin/mail -s \"\$(hostname) - AIDE Integrity Check\" $var_aide_scan_notification_email" >> $CRONTAB
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value var_aide_scan_notification_email # promote to variable
      set_fact:
        var_aide_scan_notification_email: !!str root@localhost
      tags:
        - always
    
    - name: Ensure AIDE is installed
      package:
        name: '{{ item }}'
        state: present
      with_items:
        - aide
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80374-2
        - DISA-STIG-RHEL-07-020040
        - NIST-800-53-CM-3(5)
        - NIST-800-53-CM-6(a)
        - aide_scan_notification
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Configure Notification of Post-AIDE Scan Details
      cron:
        name: run AIDE check
        minute: 5
        hour: 4
        weekday: 0
        user: root
        job: /usr/sbin/aide  --check | /bin/mail -s "$(hostname) - AIDE Integrity Check"
          {{ var_aide_scan_notification_email }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80374-2
        - DISA-STIG-RHEL-07-020040
        - NIST-800-53-CM-3(5)
        - NIST-800-53-CM-6(a)
        - aide_scan_notification
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Configure AIDE to Use FIPS 140-2 for Validating Hashes   [\[ref\]](#xccdf_org.ssgproject.content_rule_aide_use_fips_hashes)rule

By default, the `sha512` option is added to the `NORMAL` ruleset in AIDE. If using a custom ruleset or the `sha512` option is missing, add `sha512` to the appropriate ruleset. For example, add `sha512` to the following line in `/etc/aide.conf`:

NORMAL = FIPSR+sha512

AIDE rules can be configured in multiple ways; this is merely one example that is already configured by default.

Warning:  System Crypto Modules must be provided by a vendor that undergoes FIPS-140 certifications. FIPS-140 is applicable to all Federal agencies that use cryptographic-based security systems to protect sensitive information in computer and telecommunication systems (including voice systems) as defined in Section 5131 of the Information Technology Management Reform Act of 1996, Public Law 104-106. This standard shall be used in designing and implementing cryptographic modules that Federal departments and agencies operate or are operated for them under contract. See **[https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.140-2.pdf](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.140-2.pdf)** To meet this, the system has to have cryptographic software provided by a vendor that has undergone this certification. This means providing documentation, test results, design information, and independent third party review by an accredited lab. While open source software is capable of meeting this, it does not meet FIPS-140 unless the vendor submits to this process.

Rationale:

File integrity tools use cryptographic hashes for verifying file contents and directories have not been altered. These hashes must be FIPS 140-2 approved cryptographic hashes.

Severity:  medium

Identifiers:  CCE-80377-5

References:  [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.13.11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.4.4.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.12.2.1](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [SI-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.DS-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-8](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021620](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204500r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if ! rpm -q --quiet "aide" ; then
        yum install -y "aide"
    fi
    
    aide_conf="/etc/aide.conf"
    forbidden_hashes=(sha1 rmd160 sha256 whirlpool tiger haval gost crc32)
    
    groups=$(LC_ALL=C grep "^[A-Z][A-Za-z_]*" $aide_conf | cut -f1 -d ' ' | tr -d ' ' | sort -u)
    
    for group in $groups
    do
    	config=$(grep "^$group\s*=" $aide_conf | cut -f2 -d '=' | tr -d ' ')
    
    	if ! [[ $config = *sha512* ]]
    	then
    		config=$config"+sha512"
    	fi
    
    	for hash in "${forbidden_hashes[@]}"
    	do
    		config=$(echo $config | sed "s/$hash//")
    	done
    
    	config=$(echo $config | sed "s/^\+*//")
    	config=$(echo $config | sed "s/\+\++/+/")
    	config=$(echo $config | sed "s/\+$//")
    
    	sed -i "s/^$group\s*=.*/$group = $config/g" $aide_conf
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

#### Configure AIDE to Verify Access Control Lists (ACLs)   [\[ref\]](#xccdf_org.ssgproject.content_rule_aide_verify_acls)rule

By default, the `acl` option is added to the `FIPSR` ruleset in AIDE. If using a custom ruleset or the `acl` option is missing, add `acl` to the appropriate ruleset. For example, add `acl` to the following line in `/etc/aide.conf`:

FIPSR = p+i+n+u+g+s+m+c+acl+selinux+xattrs+sha256

AIDE rules can be configured in multiple ways; this is merely one example that is already configured by default. The remediation provided with this rule adds `acl` to all rule sets available in `/etc/aide.conf`

Rationale:

ACLs can provide permissions beyond those permitted through the file mode and must be verified by the file integrity tools.

Severity:  low

Identifiers:  CCE-80375-9

References:  [BP28(R51)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.4.4.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.12.2.1](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [SI-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.DS-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-8](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021600](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204498r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if ! rpm -q --quiet "aide" ; then
        yum install -y "aide"
    fi
    
    aide_conf="/etc/aide.conf"
    
    groups=$(LC_ALL=C grep "^[A-Z][A-Za-z_]*" $aide_conf | grep -v "^ALLXTRAHASHES" | cut -f1 -d '=' | tr -d ' ' | sort -u)
    
    for group in $groups
    do
    	config=$(grep "^$group\s*=" $aide_conf | cut -f2 -d '=' | tr -d ' ')
    
    	if ! [[ $config = *acl* ]]
    	then
    		if [[ -z $config ]]
    		then
    			config="acl"
    		else
    			config=$config"+acl"
    		fi
    	fi
    	sed -i "s/^$group\s*=.*/$group = $config/g" $aide_conf
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

#### Configure AIDE to Verify Extended Attributes   [\[ref\]](#xccdf_org.ssgproject.content_rule_aide_verify_ext_attributes)rule

By default, the `xattrs` option is added to the `FIPSR` ruleset in AIDE. If using a custom ruleset or the `xattrs` option is missing, add `xattrs` to the appropriate ruleset. For example, add `xattrs` to the following line in `/etc/aide.conf`:

FIPSR = p+i+n+u+g+s+m+c+acl+selinux+xattrs+sha256

AIDE rules can be configured in multiple ways; this is merely one example that is already configured by default. The remediation provided with this rule adds `xattrs` to all rule sets available in `/etc/aide.conf`

Rationale:

Extended attributes in file systems are used to contain arbitrary data and file metadata with security implications.

Severity:  low

Identifiers:  CCE-80376-7

References:  [BP28(R51)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.4.4.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.12.2.1](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [SI-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.DS-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-8](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021610](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204499r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if ! rpm -q --quiet "aide" ; then
        yum install -y "aide"
    fi
    
    aide_conf="/etc/aide.conf"
    
    groups=$(LC_ALL=C grep "^[A-Z][A-Za-z_]*" $aide_conf | grep -v "^ALLXTRAHASHES" | cut -f1 -d '=' | tr -d ' ' | sort -u)
    
    for group in $groups
    do
    	config=$(grep "^$group\s*=" $aide_conf | cut -f2 -d '=' | tr -d ' ')
    
    	if ! [[ $config = *xattrs* ]]
    	then
    		if [[ -z $config ]]
    		then
    			config="xattrs"
    		else
    			config=$config"+xattrs"
    		fi
    	fi
    	sed -i "s/^$group\s*=.*/$group = $config/g" $aide_conf
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

### Federal Information Processing Standard (FIPS)   [\[ref\]](#xccdf_org.ssgproject.content_group_fips)group

The Federal Information Processing Standard (FIPS) is a computer security standard which is developed by the U.S. Government and industry working groups to validate the quality of cryptographic modules. The FIPS standard provides four security levels to ensure adequate coverage of different industries, implementation of cryptographic modules, and organizational sizes and requirements.  
  
FIPS 140-2 is the current standard for validating that mechanisms used to access cryptographic modules utilize authentication that meets industry and government requirements. For government systems, this allows Security Levels 1, 2, 3, or 4 for use on Red Hat Enterprise Linux 7.  
  
See **[http://csrc.nist.gov/publications/PubsFIPS.html](http://csrc.nist.gov/publications/PubsFIPS.html)** for more information.

contains 1 rule

#### Enable FIPS Mode in GRUB2   [\[ref\]](#xccdf_org.ssgproject.content_rule_grub2_enable_fips_mode)rule

To ensure FIPS mode is enabled, install package `dracut-fips`, and rebuild `initramfs` by running the following commands:

$ sudo yum install dracut-fips
dracut -f

After the `dracut` command has been run, add the argument `fips=1` to the default GRUB 2 command line for the Linux operating system in `/etc/default/grub`, in the manner below:

GRUB\_CMDLINE\_LINUX="crashkernel=auto rd.lvm.lv=VolGroup/LogVol06 rd.lvm.lv=VolGroup/lv\_swap rhgb quiet rd.shell=0 fips=1"

Finally, rebuild the `grub.cfg` file by using the

grub2-mkconfig -o

command as follows:

*   On BIOS-based machines, issue the following command as `root`:
    
    ~\]# grub2-mkconfig -o /boot/grub2/grub.cfg
    
*   On UEFI-based machines, issue the following command as `root`:
    
    ~\]# grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg
    

Warning:  Running

dracut -f

will overwrite the existing initramfs file.

Warning:  The system needs to be rebooted for these changes to take effect.

Warning:  System Crypto Modules must be provided by a vendor that undergoes FIPS-140 certifications. FIPS-140 is applicable to all Federal agencies that use cryptographic-based security systems to protect sensitive information in computer and telecommunication systems (including voice systems) as defined in Section 5131 of the Information Technology Management Reform Act of 1996, Public Law 104-106. This standard shall be used in designing and implementing cryptographic modules that Federal departments and agencies operate or are operated for them under contract. See **[https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.140-2.pdf](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.140-2.pdf)** To meet this, the system has to have cryptographic software provided by a vendor that has undergone this certification. This means providing documentation, test results, design information, and independent third party review by an accredited lab. While open source software is capable of meeting this, it does not meet FIPS-140 unless the vendor submits to this process.

Rationale:

Use of weak or untested encryption algorithms undermines the purposes of utilizing encryption to protect data. The operating system must implement cryptographic modules adhering to the higher standards approved by the federal government since this provides assurance they have been tested and validated.

Severity:  high

Identifiers:  CCE-80359-3

References:  [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [5.10.1.2](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO13.01](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [3.13.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.13.11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000068](https://public.cyber.mil/stigs/cci/), [CCI-000803](https://public.cyber.mil/stigs/cci/), [CCI-001199](https://public.cyber.mil/stigs/cci/), [CCI-002450](https://public.cyber.mil/stigs/cci/), [CCI-002476](https://public.cyber.mil/stigs/cci/), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [CIP-003-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [SC-12(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-12(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-13](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000033-GPOS-00014](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000185-GPOS-00079](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000396-GPOS-00176](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000405-GPOS-00184](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000478-GPOS-00223](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000120-VMM-000600, SRG-OS-000478-VMM-001980, SRG-OS-000396-VMM-001590, [RHEL-07-021350](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204497r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # include remediation functions library
    
    
    # prelink not installed
    if test -e /etc/sysconfig/prelink -o -e /usr/sbin/prelink; then
        if grep -q ^PRELINKING /etc/sysconfig/prelink
        then
            sed -i 's/^PRELINKING[:blank:]*=[:blank:]*[:alpha:]*/PRELINKING=no/' /etc/sysconfig/prelink
        else
            printf '\n' >> /etc/sysconfig/prelink
            printf '%s\n' '# Set PRELINKING=no per security requirements' 'PRELINKING=no' >> /etc/sysconfig/prelink
        fi
    
        # Undo previous prelink changes to binaries if prelink is available.
        if test -x /usr/sbin/prelink; then
            /usr/sbin/prelink -ua
        fi
    fi
    
    if grep -q -m1 -o aes /proc/cpuinfo; then
    	if ! rpm -q --quiet "dracut-fips-aesni" ; then
        yum install -y "dracut-fips-aesni"
    fi
    fi
    if ! rpm -q --quiet "dracut-fips" ; then
        yum install -y "dracut-fips"
    fi
    
    dracut -f
    
    # Correct the form of default kernel command line in  grub
    if grep -q '^GRUB_CMDLINE_LINUX=.*fips=.*"'  /etc/default/grub; then
    	# modify the GRUB command-line if a fips= arg already exists
    	sed -i 's/\(^GRUB_CMDLINE_LINUX=".*\)fips=[^[:space:]]*\(.*"\)/\1 fips=1 \2/'  /etc/default/grub
    else
    	# no existing fips=arg is present, append it
    	sed -i 's/\(^GRUB_CMDLINE_LINUX=".*\)"/\1 fips=1"/'  /etc/default/grub
    fi
    
    # Get the UUID of the device mounted at root (/).
    ROOT_UUID=$(findmnt --noheadings --output uuid --target /)
    
    # Get the UUID of the device mounted at /boot.
    BOOT_UUID=$(findmnt --noheadings --output uuid --target /boot)
    
    if [ "${ROOT_UUID}" == "${BOOT_UUID}" ]; then
    	# root UUID same as boot UUID, so do not modify the GRUB command-line or add boot arg to kernel command line
    	# Correct the form of kernel command line for each installed kernel in the bootloader
    	/sbin/grubby --update-kernel=ALL --args="fips=1"
    else
    	# root UUID different from boot UUID, so modify the GRUB command-line and add boot arg to kernel command line
    	if grep -q '^GRUB_CMDLINE_LINUX=".*boot=.*"'  /etc/default/grub; then
    		# modify the GRUB command-line if a boot= arg already exists
    		sed -i 's/\(^GRUB_CMDLINE_LINUX=".*\)boot=[^[:space:]]*\(.*"\)/\1 boot=UUID='"${BOOT_UUID} \2/" /etc/default/grub
    	else
    		# no existing boot=arg is present, append it
    		sed -i 's/\(^GRUB_CMDLINE_LINUX=".*\)"/\1 boot=UUID='${BOOT_UUID}'"/'  /etc/default/grub
    	fi
    	# Correct the form of kernel command line for each installed kernel in the bootloader
    	/sbin/grubby --update-kernel=ALL --args="fips=1 boot=UUID=${BOOT_UUID}"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

high

Disruption:

medium

Reboot:

true

Strategy:

restrict

    - name: check prelink binary installed
      stat:
        path: /usr/sbin/prelink
      register: prelink_exists
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: disable prelink
      lineinfile:
        dest: /etc/sysconfig/prelink
        regexp: ^#?PRELINKING
        line: PRELINKING=no
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - prelink_exists.stat.exists
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: revert prelinking binaries
      command: /usr/sbin/prelink -ua
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - prelink_exists.stat.exists
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: Check if system supports AES-NI
      command: grep -q -m1 -o aes /proc/cpuinfo
      failed_when: aesni_supported.rc > 1
      register: aesni_supported
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: Ensure dracut-fips-aesni is installed
      package:
        name: dracut-fips-aesni
        state: present
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - aesni_supported.rc == 0
        - ansible_distribution == 'RedHat'
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: install dracut-fips
      package:
        name: dracut-fips
        state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: Rebuild initramfs
      command: dracut -f
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: check fips argument exists
      command: grep 'GRUB_CMDLINE_LINUX.*fips=' /etc/default/grub
      failed_when: false
      register: fipsargcheck
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: replace existing fips argument
      replace:
        path: /etc/default/grub
        regexp: fips=.
        replace: fips=1
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - fipsargcheck.rc == 0
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: add fips argument
      replace:
        path: /etc/default/grub
        regexp: (GRUB_CMDLINE_LINUX=.*)"
        replace: \1 fips=1"
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - fipsargcheck.rc != 0
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: get boot device uuid
      command: findmnt --noheadings --output uuid --target /boot
      register: bootuuid
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: check boot argument exists
      command: grep 'GRUB_CMDLINE_LINUX.*boot=' /etc/default/grub
      failed_when: false
      register: bootargcheck
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: replace existing boot argument
      replace:
        path: /etc/default/grub
        regexp: boot=\w*-\w*-\w*-\w*-\w*
        replace: boot={{ bootuuid.stdout }}
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - bootargcheck.rc == 0
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: add boot argument
      replace:
        path: /etc/default/grub
        regexp: (GRUB_CMDLINE_LINUX=.*)"
        replace: \1 boot=UUID={{ bootuuid.stdout }}"
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - bootargcheck.rc != 0
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    
    - name: update bootloader menu
      command: /sbin/grubby --update-kernel=ALL --args="fips=1 boot=UUID={{ bootuuid.stdout
        }}"
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80359-3
        - CJIS-5.10.1.2
        - DISA-STIG-RHEL-07-021350
        - NIST-800-171-3.13.11
        - NIST-800-171-3.13.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-7
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(2)
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SC-13
        - grub2_enable_fips_mode
        - high_complexity
        - high_severity
        - medium_disruption
        - reboot_required
        - restrict_strategy
    

Remediation Anaconda snippet:   (show)  
  

    
    package --add=dracut-fips --add=dracut-fips-aesni
    

### Operating System Vendor Support and Certification   [\[ref\]](#xccdf_org.ssgproject.content_group_certified-vendor)group

The assurance of a vendor to provide operating system support and maintenance for their product is an important criterion to ensure product stability and security over the life of the product. A certified product that follows the necessary standards and government certification requirements guarantees that known software vulnerabilities will be remediated, and proper guidance for protecting and securing the operating system will be given.

contains 1 rule

#### The Installed Operating System Is Vendor Supported   [\[ref\]](#xccdf_org.ssgproject.content_rule_installed_OS_is_vendor_supported)rule

The installed operating system must be maintained by a vendor. Red Hat Enterprise Linux is supported by Red Hat, Inc. As the Red Hat Enterprise Linux vendor, Red Hat, Inc. is responsible for providing security patches.

Warning:  There is no remediation besides switching to a different operating system.

Rationale:

An operating system is considered "supported" if the vendor continues to provide security patches for the product. With an unsupported release, it will not be possible to resolve any security issue discovered in the system software.

Severity:  high

Identifiers:  CCE-82371-6

References:  [18](https://www.cisecurity.org/controls/), [20](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [APO12.01](https://www.isaca.org/resources/cobit), [APO12.02](https://www.isaca.org/resources/cobit), [APO12.03](https://www.isaca.org/resources/cobit), [APO12.04](https://www.isaca.org/resources/cobit), [BAI03.10](https://www.isaca.org/resources/cobit), [DSS05.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [A.12.6.1](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.16.1.3](https://www.iso.org/standard/54534.html), [A.18.2.2](https://www.iso.org/standard/54534.html), [A.18.2.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MA-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SA-13(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [ID.RA-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-12](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020250](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204458r744100\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### Endpoint Protection Software   [\[ref\]](#xccdf_org.ssgproject.content_group_endpoint_security_software)group

Endpoint protection security software that is not provided or supported by Red Hat can be installed to provide complementary or duplicative security capabilities to those provided by the base platform. Add-on software may not be appropriate for some specialized systems.

contains 4 rules

### McAfee Endpoint Security Software   [\[ref\]](#xccdf_org.ssgproject.content_group_mcafee_security_software)group

In DoD environments, McAfee Host-based Security System (HBSS) and VirusScan Enterprise for Linux (VSEL) is required to be installed on all systems.

contains 3 rules

### McAfee Endpoint Security for Linux (ENSL)   [\[ref\]](#xccdf_org.ssgproject.content_group_mcafee_endpoint_security_software)group

McAfee Endpoint Security for Linux (ENSL) is a suite of software applications used to monitor, detect, and defend computer networks and systems.

contains 2 rules

#### Install McAfee Endpoint Security for Linux (ENSL)   [\[ref\]](#xccdf_org.ssgproject.content_rule_package_mcafeetp_installed)rule

Install McAfee Endpoint Security for Linux antivirus software which is provided for DoD systems and uses signatures to search for the presence of viruses on the filesystem. The `mcafeetp` package can be installed with the following command:

$ sudo yum install mcafeetp

Warning:  Due to McAfee Endpoint Security for Linux (ENSL) being 3rd party software, automated remediation is not available for this configuration check.

Rationale:

Virus scanning software can be used to detect if a system has been compromised by computer viruses, as well as to limit their spread to other systems.

Severity:  high

Identifiers:  CCE-86257-3

References:  [CCI-001233](https://public.cyber.mil/stigs/cci/), [SI-2(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000191-GPOS-00080](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020019](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-214800r754751\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Ensure McAfee Endpoint Security for Linux (ENSL) is running   [\[ref\]](#xccdf_org.ssgproject.content_rule_agent_mfetpd_running)rule

Install McAfee Endpoint Security for Linux antivirus software which is provided for DoD systems and uses signatures to search for the presence of viruses on the filesystem.

Warning:  Due to McAfee Endpoint Security for Linux (ENSL) being 3rd party software, automated remediation is not available for this configuration check.

Rationale:

Virus scanning software can be used to detect if a system has been compromised by computer viruses, as well as to limit their spread to other systems.

Severity:  high

Identifiers:  CCE-86262-3

References:  [CCI-001233](https://public.cyber.mil/stigs/cci/), [SI-2(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000191-GPOS-00080](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020019](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-214800r754751\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### McAfee Host-Based Intrusion Detection Software (HBSS)   [\[ref\]](#xccdf_org.ssgproject.content_group_mcafee_hbss_software)group

McAfee Host-based Security System (HBSS) is a suite of software applications used to monitor, detect, and defend computer networks and systems.

contains 1 rule

#### Install the Host Intrusion Prevention System (HIPS) Module   [\[ref\]](#xccdf_org.ssgproject.content_rule_package_MFEhiplsm_installed)rule

Install the McAfee Host Intrusion Prevention System (HIPS) Module if it is absolutely necessary. If SELinux is enabled, do not install or enable this module.

Warning:  Installing and enabling this module conflicts with SELinux. Per DoD/DISA guidance, SELinux takes precedence over this module.

Warning:  Due to McAfee HIPS being 3rd party software, automated remediation is not available for this configuration check.

Rationale:

Without a host-based intrusion detection tool, there is no system-level defense when an intruder gains access to a system or network. Additionally, a host-based intrusion prevention tool can provide methods to immediately lock out detected intrusion attempts.

Severity:  medium

Identifiers:  CCE-80368-4

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO07.06](https://www.isaca.org/resources/cobit), [APO08.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.06](https://www.isaca.org/resources/cobit), [APO12.01](https://www.isaca.org/resources/cobit), [APO12.02](https://www.isaca.org/resources/cobit), [APO12.03](https://www.isaca.org/resources/cobit), [APO12.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [APO13.02](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [BAI08.04](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.05](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.04](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS04.05](https://www.isaca.org/resources/cobit), [DSS05.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.01](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [MEA03.03](https://www.isaca.org/resources/cobit), [MEA03.04](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001233](https://public.cyber.mil/stigs/cci/), [CCI-001263](https://public.cyber.mil/stigs/cci/), [4.2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.14.2.8](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.16.1.1](https://www.iso.org/standard/54534.html), [A.16.1.2](https://www.iso.org/standard/54534.html), [A.16.1.3](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.6](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.18.2.2](https://www.iso.org/standard/54534.html), [A.18.2.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [Clause 16.1.2](https://www.iso.org/standard/54534.html), [Clause 7.4](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.DP-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.DP-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.DP-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.DP-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.RA-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-8](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.CO-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-11.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000191-GPOS-00080](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000196](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020019](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-214800r754751\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation script:   (show)  
  

    
    [[packages]]
    name = "MFEhiplsm"
    version = "*"
    

#### Install Virus Scanning Software   [\[ref\]](#xccdf_org.ssgproject.content_rule_install_antivirus)rule

Virus scanning software can be used to protect a system from penetration from computer viruses and to limit their spread through intermediate systems. The virus scanning software should be configured to perform scans dynamically on accessed files. If this capability is not available, the system must be configured to scan, at a minimum, all altered files on the system on a daily basis. If the system processes inbound SMTP mail, the virus scanner must be configured to scan all received mail.

Rationale:

Virus scanning software can be used to detect if a system has been compromised by computer viruses, as well as to limit their spread to other systems.

Severity:  high

Identifiers:  CCE-27140-3

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.02](https://www.isaca.org/resources/cobit), [BAI02.01](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [DSS04.07](https://www.isaca.org/resources/cobit), [DSS05.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001239](https://public.cyber.mil/stigs/cci/), [CCI-001668](https://public.cyber.mil/stigs/cci/), [4.3.4.3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.2.1](https://www.iso.org/standard/54534.html), [A.14.2.8](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.DP-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-032000](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-214801r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### Disk Partitioning   [\[ref\]](#xccdf_org.ssgproject.content_group_disk_partitioning)group

To ensure separation and protection of data, there are top-level system directories which should be placed on their own physical partition or logical volume. The installer's default partitioning scheme creates separate logical volumes for `/`, `/boot`, and `swap`.

*   If starting with any of the default layouts, check the box to \\"Review and modify partitioning.\\" This allows for the easy creation of additional logical volumes inside the volume group already created, though it may require making `/`'s logical volume smaller to create space. In general, using logical volumes is preferable to using partitions because they can be more easily adjusted later.
*   If creating a custom layout, create the partitions mentioned in the previous paragraph (which the installer will require anyway), as well as separate ones described in the following sections.

If a system has already been installed, and the default partitioning scheme was used, it is possible but nontrivial to modify it to create separate logical volumes for the directories listed above. The Logical Volume Manager (LVM) makes this possible. See the LVM HOWTO at [http://tldp.org/HOWTO/LVM-HOWTO/](http://tldp.org/HOWTO/LVM-HOWTO/) for more detailed information on LVM.

contains 4 rules

#### Ensure /home Located On Separate Partition   [\[ref\]](#xccdf_org.ssgproject.content_rule_partition_for_home)rule

If user home directories will be stored locally, create a separate partition for `/home` at installation time (or migrate it later using LVM). If `/home` will be mounted from another system such as an NFS server, then creating a separate partition is not necessary at installation time, and the mountpoint can instead be configured later.

Rationale:

Ensuring that `/home` is mounted on its own partition enables the setting of more restrictive mount options, and also helps ensure that users cannot trivially fill partitions used for log or audit data storage.

Severity:  low

Identifiers:  CCE-80144-9

References:  [BP28(R12)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001208](https://public.cyber.mil/stigs/cci/), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021310](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204493r603840\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.1.17](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

enable

    
    part /home
    

#### Ensure /tmp Located On Separate Partition   [\[ref\]](#xccdf_org.ssgproject.content_rule_partition_for_tmp)rule

The `/tmp` directory is a world-writable directory used for temporary file storage. Ensure it has its own partition or logical volume at installation time, or migrate it using LVM.

Rationale:

The `/tmp` partition is used as temporary storage by many programs. Placing `/tmp` in its own partition enables the setting of more restrictive mount options, which can help protect programs which use it.

Severity:  low

Identifiers:  CCE-82053-0

References:  [BP28(R12)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021340](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204496r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.1.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

enable

    
    part /tmp
    

#### Ensure /var Located On Separate Partition   [\[ref\]](#xccdf_org.ssgproject.content_rule_partition_for_var)rule

The `/var` directory is used by daemons and other system services to store frequently-changing data. Ensure that `/var` has its own partition or logical volume at installation time, or migrate it using LVM.

Rationale:

Ensuring that `/var` is mounted on its own partition enables the setting of more restrictive mount options. This helps protect system services such as daemons or other programs which use it. It is not uncommon for the `/var` directory to contain world-writable directories installed by other software packages.

Severity:  low

Identifiers:  CCE-82014-2

References:  [BP28(R12)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000341-VMM-001220, [RHEL-07-021320](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204494r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.1.10](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

enable

    
    part /var
    

#### Ensure /var/log/audit Located On Separate Partition   [\[ref\]](#xccdf_org.ssgproject.content_rule_partition_for_var_log_audit)rule

Audit logs are stored in the `/var/log/audit` directory. Ensure that `/var/log/audit` has its own partition or logical volume at installation time, or migrate it using LVM. Make absolutely certain that it is large enough to store all audit logs that will be created by the auditing daemon.

Rationale:

Placing `/var/log/audit` in its own partition enables better separation between audit files and other files, and helps ensure that auditing cannot be halted due to the partition running out of space.

Severity:  low

Identifiers:  CCE-82035-7

References:  [BP28(R43)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [APO11.04](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001849](https://public.cyber.mil/stigs/cci/), [164.312(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [CIP-007-3 R6.5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-4](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000341-GPOS-00132](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000341-VMM-001220, [RHEL-07-021330](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204495r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.1.16](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

enable

    
    part /var/log/audit
    

### GNOME Desktop Environment   [\[ref\]](#xccdf_org.ssgproject.content_group_gnome)group

GNOME is a graphical desktop environment bundled with many Linux distributions that allow users to easily interact with the operating system graphically rather than textually. The GNOME Graphical Display Manager (GDM) provides login, logout, and user switching contexts as well as display server management.  
  
GNOME is developed by the GNOME Project and is considered the default Red Hat Graphical environment.  
  
For more information on GNOME and the GNOME Project, see **[https://www.gnome.org](https://www.gnome.org)**.

contains 16 rules

### Configure GNOME Login Screen   [\[ref\]](#xccdf_org.ssgproject.content_group_gnome_login_screen)group

In the default GNOME desktop, the login is displayed after system boot and can display user accounts, allow users to reboot the system, and allow users to login automatically and/or with a guest account. The login screen should be configured to prevent such behavior.  
  
For more information about enforcing preferences in the GNOME3 environment using the DConf configuration system, see **[https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/7/html/desktop\_migration\_and\_administration\_guide](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/desktop_migration_and_administration_guide)/>** and the man page `dconf(1)`.

contains 3 rules

#### Enable the GNOME3 Login Smartcard Authentication   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_enable_smartcard_auth)rule

In the default graphical environment, smart card authentication can be enabled on the login screen by setting `enable-smartcard-authentication` to `true`.  
  
To enable, add or edit `enable-smartcard-authentication` to `/etc/dconf/db/gdm.d/00-security-settings`. For example:

\[org/gnome/login-screen\]
enable-smartcard-authentication=true

Once the setting has been added, add a lock to `/etc/dconf/db/gdm.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/login-screen/enable-smartcard-authentication

After the settings have been set, run `dconf update`.

Rationale:

Smart card login provides two-factor authentication stronger than that provided by a username and password combination. Smart cards leverage PKI (public key infrastructure) in order to provide and verify credentials.

Severity:  medium

Identifiers:  CCE-80108-4

References:  [CCI-000765](https://public.cyber.mil/stigs/cci/), [CCI-000766](https://public.cyber.mil/stigs/cci/), [CCI-000767](https://public.cyber.mil/stigs/cci/), [CCI-000768](https://public.cyber.mil/stigs/cci/), [CCI-000771](https://public.cyber.mil/stigs/cci/), [CCI-000772](https://public.cyber.mil/stigs/cci/), [CCI-000884](https://public.cyber.mil/stigs/cci/), [CCI-001948](https://public.cyber.mil/stigs/cci/), [CCI-001954](https://public.cyber.mil/stigs/cci/), [IA-2(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(8)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(11)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [Req-8.3](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000375-GPOS-00160](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000376-GPOS-00161](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000377-GPOS-00162](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010061](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204397r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/login-screen\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/gdm.d/00-security-settings"
    DBDIR="/etc/dconf/db/gdm.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/login-screen]" >> ${DCONFFILE}
        printf '%s=%s\n' "enable-smartcard-authentication" "true" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "true")"
        if grep -q "^\\s*enable-smartcard-authentication\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*enable-smartcard-authentication\\s*=\\s*.*/enable-smartcard-authentication=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/login-screen\\]|a\\enable-smartcard-authentication=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/login-screen/enable-smartcard-authentication$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/gdm.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/login-screen/enable-smartcard-authentication" >> "/etc/dconf/db/gdm.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80108-4
        - DISA-STIG-RHEL-07-010061
        - NIST-800-53-IA-2(11)
        - NIST-800-53-IA-2(3)
        - NIST-800-53-IA-2(4)
        - NIST-800-53-IA-2(8)
        - NIST-800-53-IA-2(9)
        - PCI-DSS-Req-8.3
        - dconf_gnome_enable_smartcard_auth
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Enable the GNOME3 Login Smartcard Authentication
      ini_file:
        dest: /etc/dconf/db/gdm.d/00-security-settings
        section: org/gnome/login-screen
        option: enable-smartcard-authentication
        value: 'true'
        create: true
        no_extra_spaces: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80108-4
        - DISA-STIG-RHEL-07-010061
        - NIST-800-53-IA-2(11)
        - NIST-800-53-IA-2(3)
        - NIST-800-53-IA-2(4)
        - NIST-800-53-IA-2(8)
        - NIST-800-53-IA-2(9)
        - PCI-DSS-Req-8.3
        - dconf_gnome_enable_smartcard_auth
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME3 disablement of Smartcard Authentication
      lineinfile:
        path: /etc/dconf/db/gdm.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/login-screen/enable-smartcard-authentication$
        line: /org/gnome/login-screen/enable-smartcard-authentication
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80108-4
        - DISA-STIG-RHEL-07-010061
        - NIST-800-53-IA-2(11)
        - NIST-800-53-IA-2(3)
        - NIST-800-53-IA-2(4)
        - NIST-800-53-IA-2(8)
        - NIST-800-53-IA-2(9)
        - PCI-DSS-Req-8.3
        - dconf_gnome_enable_smartcard_auth
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80108-4
        - DISA-STIG-RHEL-07-010061
        - NIST-800-53-IA-2(11)
        - NIST-800-53-IA-2(3)
        - NIST-800-53-IA-2(4)
        - NIST-800-53-IA-2(8)
        - NIST-800-53-IA-2(9)
        - PCI-DSS-Req-8.3
        - dconf_gnome_enable_smartcard_auth
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Disable GDM Automatic Login   [\[ref\]](#xccdf_org.ssgproject.content_rule_gnome_gdm_disable_automatic_login)rule

The GNOME Display Manager (GDM) can allow users to automatically login without user interaction or credentials. User should always be required to authenticate themselves to the system that they are authorized to use. To disable user ability to automatically login to the system, set the `AutomaticLoginEnable` to `false` in the `[daemon]` section in `/etc/gdm/custom.conf`. For example:

\[daemon\]
AutomaticLoginEnable=false

Rationale:

Failure to restrict system access to authenticated users negatively impacts operating system security.

Severity:  high

Identifiers:  CCE-80104-3

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.1.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00229](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010440](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204432r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    if rpm --quiet -q gdm
    then
    	if ! grep -q "^AutomaticLoginEnable=" /etc/gdm/custom.conf
    	then
    		sed -i "/^\[daemon\]/a \
    		AutomaticLoginEnable=False" /etc/gdm/custom.conf
    	else
    		sed -i "s/^AutomaticLoginEnable=.*/AutomaticLoginEnable=False/g" /etc/gdm/custom.conf
    	fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80104-3
        - DISA-STIG-RHEL-07-010440
        - NIST-800-171-3.1.1
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(b)
        - gnome_gdm_disable_automatic_login
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Disable GDM Automatic Login
      ini_file:
        dest: /etc/gdm/custom.conf
        section: daemon
        option: AutomaticLoginEnable
        value: 'false'
        no_extra_spaces: true
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80104-3
        - DISA-STIG-RHEL-07-010440
        - NIST-800-171-3.1.1
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(b)
        - gnome_gdm_disable_automatic_login
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    

#### Disable GDM Guest Login   [\[ref\]](#xccdf_org.ssgproject.content_rule_gnome_gdm_disable_guest_login)rule

The GNOME Display Manager (GDM) can allow users to login without credentials which can be useful for public kiosk scenarios. Allowing users to login without credentials or "guest" account access has inherent security risks and should be disabled. To do disable timed logins or guest account access, set the `TimedLoginEnable` to `false` in the `[daemon]` section in `/etc/gdm/custom.conf`. For example:

\[daemon\]
TimedLoginEnable=false

Rationale:

Failure to restrict system access to authenticated users negatively impacts operating system security.

Severity:  high

Identifiers:  CCE-80105-0

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.1.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00229](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010450](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204433r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    if rpm --quiet -q gdm
    then
    	if ! grep -q "^TimedLoginEnable=" /etc/gdm/custom.conf
    	then
    		sed -i "/^\[daemon\]/a \
    		TimedLoginEnable=False" /etc/gdm/custom.conf
    	else
    		sed -i "s/^TimedLoginEnable=.*/TimedLoginEnable=False/g" /etc/gdm/custom.conf
    	fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80105-0
        - DISA-STIG-RHEL-07-010450
        - NIST-800-171-3.1.1
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-2
        - gnome_gdm_disable_guest_login
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Disable GDM Guest Login
      ini_file:
        dest: /etc/gdm/custom.conf
        section: daemon
        option: TimedLoginEnable
        value: 'false'
        no_extra_spaces: true
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80105-0
        - DISA-STIG-RHEL-07-010450
        - NIST-800-171-3.1.1
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-2
        - gnome_gdm_disable_guest_login
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    

### GNOME Media Settings   [\[ref\]](#xccdf_org.ssgproject.content_group_gnome_media_settings)group

GNOME media settings that apply to the graphical interface.

contains 3 rules

#### Disable GNOME3 Automounting   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_disable_automount)rule

The system's default desktop environment, GNOME3, will mount devices and removable media (such as DVDs, CDs and USB flash drives) whenever they are inserted into the system. To disable automount within GNOME3, add or set `automount` to `false` in `/etc/dconf/db/local.d/00-security-settings`. For example:

\[org/gnome/desktop/media-handling\]
automount=false

Once the settings have been added, add a lock to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/desktop/media-handling/automount

After the settings have been set, run `dconf update`.

Rationale:

Disabling automatic mounting in GNOME3 can prevent the introduction of malware via removable media. It will, however, also prevent desktop users from legitimate use of removable media.

Severity:  unknown

Identifiers:  CCE-80122-5

References:  [12](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/desktop/media-handling\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/local.d/00-security-settings"
    DBDIR="/etc/dconf/db/local.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/desktop/media-handling]" >> ${DCONFFILE}
        printf '%s=%s\n' "automount" "false" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "false")"
        if grep -q "^\\s*automount\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*automount\\s*=\\s*.*/automount=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/desktop/media-handling\\]|a\\automount=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/media-handling/automount$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/media-handling/automount" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80122-5
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_automount
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_severity
        - unknown_strategy
    
    - name: Disable GNOME3 Automounting - automount
      ini_file:
        dest: /etc/dconf/db/local.d/00-security-settings
        section: org/gnome/desktop/media-handling
        option: automount
        value: 'false'
        create: true
        no_extra_spaces: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80122-5
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_automount
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_severity
        - unknown_strategy
    
    - name: Prevent user modification of GNOME3 Automounting - automount
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/media-handling/automount$
        line: /org/gnome/desktop/media-handling/automount
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80122-5
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_automount
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_severity
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80122-5
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_automount
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_severity
        - unknown_strategy
    

#### Disable GNOME3 Automount Opening   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_disable_automount_open)rule

The system's default desktop environment, GNOME3, will mount devices and removable media (such as DVDs, CDs and USB flash drives) whenever they are inserted into the system. To disable automount-open within GNOME3, add or set `automount-open` to `false` in `/etc/dconf/db/local.d/00-security-settings`. For example:

\[org/gnome/desktop/media-handling\]
automount-open=false

Once the settings have been added, add a lock to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/desktop/media-handling/automount-open

After the settings have been set, run `dconf update`.

Rationale:

Disabling automatic mounting in GNOME3 can prevent the introduction of malware via removable media. It will, however, also prevent desktop users from legitimate use of removable media.

Severity:  medium

Identifiers:  CCE-83692-4

References:  [12](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-001958](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000114-GPOS-00059](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000378-GPOS-00163](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/desktop/media-handling\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/local.d/00-security-settings"
    DBDIR="/etc/dconf/db/local.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/desktop/media-handling]" >> ${DCONFFILE}
        printf '%s=%s\n' "automount-open" "false" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "false")"
        if grep -q "^\\s*automount-open\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*automount-open\\s*=\\s*.*/automount-open=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/desktop/media-handling\\]|a\\automount-open=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/media-handling/automount-open$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/media-handling/automount-open" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-83692-4
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_automount_open
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Disable GNOME3 Automounting - automount-open
      ini_file:
        dest: /etc/dconf/db/local.d/00-security-settings
        section: org/gnome/desktop/media-handling
        option: automount-open
        value: 'false'
        create: true
        no_extra_spaces: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83692-4
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_automount_open
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME3 Automounting - automount-open
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/media-handling/automount-open$
        line: /org/gnome/desktop/media-handling/automount-open
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83692-4
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_automount_open
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83692-4
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_automount_open
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Disable GNOME3 Automount running   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_disable_autorun)rule

The system's default desktop environment, GNOME3, will mount devices and removable media (such as DVDs, CDs and USB flash drives) whenever they are inserted into the system. To disable autorun-never within GNOME3, add or set `autorun-never` to `true` in `/etc/dconf/db/local.d/00-security-settings`. For example:

\[org/gnome/desktop/media-handling\]
autorun-never=true

Once the settings have been added, add a lock to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/desktop/media-handling/autorun-never

After the settings have been set, run `dconf update`.

Rationale:

Disabling automatic mount running in GNOME3 can prevent the introduction of malware via removable media. It will, however, also prevent desktop users from legitimate use of removable media.

Severity:  medium

Identifiers:  CCE-83741-9

References:  [12](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-001958](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000114-GPOS-00059](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000378-GPOS-00163](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/desktop/media-handling\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/local.d/00-security-settings"
    DBDIR="/etc/dconf/db/local.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/desktop/media-handling]" >> ${DCONFFILE}
        printf '%s=%s\n' "autorun-never" "true" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "true")"
        if grep -q "^\\s*autorun-never\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*autorun-never\\s*=\\s*.*/autorun-never=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/desktop/media-handling\\]|a\\autorun-never=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/media-handling/autorun-never$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/media-handling/autorun-never" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-83741-9
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_autorun
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Disable GNOME3 Automounting - autorun-never
      ini_file:
        dest: /etc/dconf/db/local.d/00-security-settings
        section: org/gnome/desktop/media-handling
        option: autorun-never
        value: 'true'
        create: true
        no_extra_spaces: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83741-9
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_autorun
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME3 Automounting - autorun-never
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/media-handling/autorun-never$
        line: /org/gnome/desktop/media-handling/autorun-never
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83741-9
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_autorun
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83741-9
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_autorun
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

### Configure GNOME Screen Locking   [\[ref\]](#xccdf_org.ssgproject.content_group_gnome_screen_locking)group

In the default GNOME3 desktop, the screen can be locked by selecting the user name in the far right corner of the main panel and selecting **Lock**.  
  
The following sections detail commands to enforce idle activation of the screensaver, screen locking, a blank-screen screensaver, and an idle activation time.  
  
Because users should be trained to lock the screen when they step away from the computer, the automatic locking feature is only meant as a backup.  
  
The root account can be screen-locked; however, the root account should _never_ be used to log into an X Windows environment and should only be used to for direct login via console in emergency circumstances.  
  
For more information about enforcing preferences in the GNOME3 environment using the DConf configuration system, see **[http://wiki.gnome.org/dconf](http://wiki.gnome.org/dconf)** and the man page `dconf(1)`.

contains 8 rules

#### Enable GNOME3 Screensaver Idle Activation   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_screensaver_idle_activation_enabled)rule

To activate the screensaver in the GNOME3 desktop after a period of inactivity, add or set `idle-activation-enabled` to `true` in `/etc/dconf/db/local.d/00-security-settings`. For example:

\[org/gnome/desktop/screensaver\]
idle-activation-enabled=true

Once the setting has been added, add a lock to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/desktop/screensaver/idle-activation-enabled

After the settings have been set, run `dconf update`.

Rationale:

A session time-out lock is a temporary action taken when a user stops work and moves away from the immediate physical vicinity of the information system but does not logout because of the temporary nature of the absence. Rather than relying on the user to manually lock their operating system session prior to vacating the vicinity, GNOME desktops can be configured to identify when a user's session has idled and take action to initiate the session lock.  
  
Enabling idle activation of the screensaver ensures the screensaver will be activated after the idle delay. Applications requiring continuous, real-time screen display (such as network management products) require the login session does not have administrator rights and the display station is located in a controlled-access area.

Severity:  medium

Identifiers:  CCE-80111-8

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5.5.5](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000057](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-11(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.1.8](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000029-GPOS-00010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010100](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204402r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/desktop/screensaver\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/local.d/00-security-settings"
    DBDIR="/etc/dconf/db/local.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/desktop/screensaver]" >> ${DCONFFILE}
        printf '%s=%s\n' "idle-activation-enabled" "true" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "true")"
        if grep -q "^\\s*idle-activation-enabled\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*idle-activation-enabled\\s*=\\s*.*/idle-activation-enabled=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/desktop/screensaver\\]|a\\idle-activation-enabled=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/screensaver/idle-activation-enabled$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/screensaver/idle-activation-enabled" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80111-8
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010100
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_activation_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Enable GNOME3 Screensaver Idle Activation
      ini_file:
        dest: /etc/dconf/db/local.d/00-security-settings
        section: org/gnome/desktop/screensaver
        option: idle-activation-enabled
        value: 'true'
        create: true
        no_extra_spaces: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80111-8
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010100
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_activation_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME idle-activation-enabled
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/screensaver/idle-activation-enabled$
        line: /org/gnome/desktop/screensaver/idle-activation-enabled
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80111-8
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010100
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_activation_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80111-8
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010100
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_activation_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Ensure Users Cannot Change GNOME3 Screensaver Idle Activation   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_screensaver_idle_activation_locked)rule

If not already configured, ensure that users cannot change GNOME3 screensaver lock settings by adding

/org/gnome/desktop/screensaver/idle-activation-enabled

to `/etc/dconf/db/local.d/00-security-settings`. For example:

/org/gnome/desktop/screensaver/idle-activation-enabled

After the settings have been set, run `dconf update`.

Rationale:

A session lock is a temporary action taken when a user stops work and moves away from the immediate physical vicinity of the information system but does not want to logout because of the temporary nature of the absense.

Severity:  medium

Identifiers:  CCE-80564-8

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5.5.5](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000057](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.1.8](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000029-GPOS-00010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010101](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204403r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm; then
    
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/screensaver/idle-activation-enabled$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/screensaver/idle-activation-enabled" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80564-8
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010101
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_activation_locked
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME Screensaver idle-activation-enabled
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/screensaver/idle-activation-enabled$
        line: /org/gnome/desktop/screensaver/idle-activation-enabled
        create: true
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-80564-8
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010101
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_activation_locked
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-80564-8
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010101
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_activation_locked
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Set GNOME3 Screensaver Inactivity Timeout   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_screensaver_idle_delay)rule

The idle time-out value for inactivity in the GNOME3 desktop is configured via the `idle-delay` setting must be set under an appropriate configuration file(s) in the `/etc/dconf/db/local.d` directory and locked in `/etc/dconf/db/local.d/locks` directory to prevent user modification.  
  
For example, to configure the system for a 15 minute delay, add the following to `/etc/dconf/db/local.d/00-security-settings`:

\[org/gnome/desktop/session\]
idle-delay=uint32 900

Once the setting has been added, add a lock to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/desktop/session/idle-delay

After the settings have been set, run `dconf update`.

Rationale:

A session time-out lock is a temporary action taken when a user stops work and moves away from the immediate physical vicinity of the information system but does not logout because of the temporary nature of the absence. Rather than relying on the user to manually lock their operating system session prior to vacating the vicinity, GNOME3 can be configured to identify when a user's session has idled and take action to initiate a session lock.

Severity:  medium

Identifiers:  CCE-80110-0

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5.5.5](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000057](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [AC-11(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.1.8](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000029-GPOS-00010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010070](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204398r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    
    inactivity_timeout_value="900"
    
    
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/desktop/session\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/local.d/00-security-settings"
    DBDIR="/etc/dconf/db/local.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/desktop/session]" >> ${DCONFFILE}
        printf '%s=%s\n' "idle-delay" "uint32 ${inactivity_timeout_value}" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "uint32 ${inactivity_timeout_value}")"
        if grep -q "^\\s*idle-delay\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*idle-delay\\s*=\\s*.*/idle-delay=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/desktop/session\\]|a\\idle-delay=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/session/idle-delay$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/session/idle-delay" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80110-0
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010070
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_delay
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    - name: XCCDF Value inactivity_timeout_value # promote to variable
      set_fact:
        inactivity_timeout_value: !!str 900
      tags:
        - always
    
    - name: Set GNOME3 Screensaver Inactivity Timeout
      ini_file:
        dest: /etc/dconf/db/local.d/00-security-settings
        section: org/gnome/desktop/session
        option: idle-delay
        value: uint32 {{ inactivity_timeout_value }}
        create: true
        no_extra_spaces: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80110-0
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010070
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_delay
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME idle-delay
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/session/idle-delay$
        line: /org/gnome/desktop/session/idle-delay
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80110-0
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010070
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_delay
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80110-0
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010070
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_idle_delay
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Set GNOME3 Screensaver Lock Delay After Activation Period   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_screensaver_lock_delay)rule

To activate the locking delay of the screensaver in the GNOME3 desktop when the screensaver is activated, add or set `lock-delay` to `uint32 5` in `/etc/dconf/db/local.d/00-security-settings`. For example:

\[org/gnome/desktop/screensaver\]
lock-delay=uint32 5

Once the setting has been added, add a lock to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/desktop/screensaver/lock-delay

After the settings have been set, run `dconf update`.

Rationale:

A session lock is a temporary action taken when a user stops work and moves away from the immediate physical vicinity of the information system but does not want to logout because of the temporary nature of the absense.

Severity:  medium

Identifiers:  CCE-80370-0

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000056](https://public.cyber.mil/stigs/cci/), [CCI-000057](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [AC-11(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.1.8](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000029-GPOS-00010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010110](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204404r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    
    var_screensaver_lock_delay="5"
    
    
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/desktop/screensaver\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/local.d/00-security-settings"
    DBDIR="/etc/dconf/db/local.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/desktop/screensaver]" >> ${DCONFFILE}
        printf '%s=%s\n' "lock-delay" "uint32 ${var_screensaver_lock_delay}" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "uint32 ${var_screensaver_lock_delay}")"
        if grep -q "^\\s*lock-delay\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*lock-delay\\s*=\\s*.*/lock-delay=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/desktop/screensaver\\]|a\\lock-delay=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/screensaver/lock-delay$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/screensaver/lock-delay" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80370-0
        - DISA-STIG-RHEL-07-010110
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_delay
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Set GNOME3 Screensaver Lock Delay After Activation Period
      ini_file:
        dest: /etc/dconf/db/local.d/00-security-settings
        section: org/gnome/desktop/screensaver
        option: lock-delay
        value: uint32 5
        create: true
        no_extra_spaces: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80370-0
        - DISA-STIG-RHEL-07-010110
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_delay
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME lock-delay
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/screensaver/lock-delay$
        line: /org/gnome/desktop/screensaver/lock-delay
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80370-0
        - DISA-STIG-RHEL-07-010110
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_delay
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80370-0
        - DISA-STIG-RHEL-07-010110
        - NIST-800-171-3.1.10
        - NIST-800-53-AC-11(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_delay
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Enable GNOME3 Screensaver Lock After Idle Period   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_screensaver_lock_enabled)rule

To activate locking of the screensaver in the GNOME3 desktop when it is activated, add or set `lock-enabled` to `true` in `/etc/dconf/db/local.d/00-security-settings`. For example:

\[org/gnome/desktop/screensaver\]
lock-enabled=true

Once the settings have been added, add a lock to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/desktop/screensaver/lock-enabled

After the settings have been set, run `dconf update`.

Rationale:

A session lock is a temporary action taken when a user stops work and moves away from the immediate physical vicinity of the information system but does not want to logout because of the temporary nature of the absense.

Severity:  medium

Identifiers:  CCE-80112-6

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5.5.5](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000056](https://public.cyber.mil/stigs/cci/), [CCI-000058](https://public.cyber.mil/stigs/cci/), [CCI-000060](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.1.8](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000028-GPOS-00009](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000030-GPOS-00011](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010060](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204396r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/desktop/screensaver\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/local.d/00-security-settings"
    DBDIR="/etc/dconf/db/local.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/desktop/screensaver]" >> ${DCONFFILE}
        printf '%s=%s\n' "lock-enabled" "true" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "true")"
        if grep -q "^\\s*lock-enabled\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*lock-enabled\\s*=\\s*.*/lock-enabled=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/desktop/screensaver\\]|a\\lock-enabled=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/screensaver/lock-enabled$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/screensaver/lock-enabled" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80112-6
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010060
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - ansible_distribution == 'SLES'
      tags:
        - CCE-80112-6
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010060
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Enable GNOME3 Screensaver Lock After Idle Period
      ini_file:
        dest: /etc/dconf/db/local.d/00-security-settings
        section: org/gnome/desktop/screensaver
        option: lock-enabled
        value: 'true'
        create: true
        no_extra_spaces: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80112-6
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010060
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME lock-enabled
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/screensaver/lock-enabled$
        line: /org/gnome/desktop/screensaver/lock-enabled
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80112-6
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010060
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Check GNOME3 screenserver disable-lock-screen false
      command: gsettings get org.gnome.desktop.lockdown disable-lock-screen
      register: cmd_out
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - ansible_distribution == 'SLES'
      tags:
        - CCE-80112-6
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010060
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Update GNOME3 screenserver disable-lock-screen false
      command: gsettings set org.gnome.desktop.lockdown disable-lock-screen false
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - ansible_distribution == 'SLES'
      tags:
        - CCE-80112-6
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010060
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80112-6
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010060
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Ensure Users Cannot Change GNOME3 Screensaver Lock After Idle Period   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_screensaver_lock_locked)rule

If not already configured, ensure that users cannot change GNOME3 screensaver lock settings by adding

/org/gnome/desktop/screensaver/lock-enabled

to `/etc/dconf/db/local.d/00-security-settings`. For example:

/org/gnome/desktop/screensaver/lock-enabled

After the settings have been set, run `dconf update`.

Rationale:

A session lock is a temporary action taken when a user stops work and moves away from the immediate physical vicinity of the information system but does not want to logout because of the temporary nature of the absense.

Severity:  medium

Identifiers:  CCE-80563-0

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5.5.5](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000056](https://public.cyber.mil/stigs/cci/), [CCI-000057](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.1.8](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000029-GPOS-00010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010062](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-214937r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm; then
    
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/screensaver/lock-enabled$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/screensaver/lock-enabled" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80563-0
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010062
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_locked
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME Screensaver lock-enabled
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/screensaver/lock-enabled$
        line: /org/gnome/desktop/screensaver/lock-enabled
        create: true
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-80563-0
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010062
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_locked
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-80563-0
        - CJIS-5.5.5
        - DISA-STIG-RHEL-07-010062
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.8
        - dconf_gnome_screensaver_lock_locked
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Ensure Users Cannot Change GNOME3 Screensaver Settings   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_screensaver_user_locks)rule

If not already configured, ensure that users cannot change GNOME3 screensaver lock settings by adding `/org/gnome/desktop/screensaver/lock-delay` to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/desktop/screensaver/lock-delay

After the settings have been set, run `dconf update`.

Rationale:

A session time-out lock is a temporary action taken when a user stops work and moves away from the immediate physical vicinity of the information system but does not logout because of the temporary nature of the absence. Rather than relying on the user to manually lock their operating system session prior to vacating the vicinity, GNOME desktops can be configured to identify when a user's session has idled and take action to initiate the session lock. As such, users should not be allowed to change session settings.

Severity:  medium

Identifiers:  CCE-80371-8

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000057](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000029-GPOS-00010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010081](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204399r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/screensaver/lock-delay$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/screensaver/lock-delay" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80371-8
        - DISA-STIG-RHEL-07-010081
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - dconf_gnome_screensaver_user_locks
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME lock-delay
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/screensaver/lock-delay$
        line: /org/gnome/desktop/screensaver/lock-delay
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80371-8
        - DISA-STIG-RHEL-07-010081
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - dconf_gnome_screensaver_user_locks
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80371-8
        - DISA-STIG-RHEL-07-010081
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - dconf_gnome_screensaver_user_locks
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Ensure Users Cannot Change GNOME3 Session Idle Settings   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_session_idle_user_locks)rule

If not already configured, ensure that users cannot change GNOME3 session idle settings by adding `/org/gnome/desktop/session/idle-delay` to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/desktop/session/idle-delay

After the settings have been set, run `dconf update`.

Rationale:

A session time-out lock is a temporary action taken when a user stops work and moves away from the immediate physical vicinity of the information system but does not logout because of the temporary nature of the absence. Rather than relying on the user to manually lock their operating system session prior to vacating the vicinity, GNOME desktops can be configured to identify when a user's session has idled and take action to initiate the session lock. As such, users should not be allowed to change session settings.

Severity:  medium

Identifiers:  CCE-80544-0

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000057](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000029-GPOS-00010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010082](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204400r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/desktop/session/idle-delay$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/desktop/session/idle-delay" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80544-0
        - DISA-STIG-RHEL-07-010082
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - dconf_gnome_session_idle_user_locks
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME Session idle-delay
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/desktop/session/idle-delay$
        line: /org/gnome/desktop/session/idle-delay
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80544-0
        - DISA-STIG-RHEL-07-010082
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - dconf_gnome_session_idle_user_locks
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80544-0
        - DISA-STIG-RHEL-07-010082
        - NIST-800-171-3.1.10
        - NIST-800-53-CM-6(a)
        - dconf_gnome_session_idle_user_locks
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

### GNOME System Settings   [\[ref\]](#xccdf_org.ssgproject.content_group_gnome_system_settings)group

GNOME provides configuration and functionality to a graphical desktop environment that changes grahical configurations or allow a user to perform actions that users normally would not be able to do in non-graphical mode such as remote access configuration, power policies, Geo-location, etc. Configuring such settings in GNOME will prevent accidential graphical configuration changes by users from taking place.

contains 1 rule

#### Disable Ctrl-Alt-Del Reboot Key Sequence in GNOME3   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_disable_ctrlaltdel_reboot)rule

By default, `GNOME` will reboot the system if the `Ctrl-Alt-Del` key sequence is pressed.  
  
To configure the system to ignore the `Ctrl-Alt-Del` key sequence from the Graphical User Interface (GUI) instead of rebooting the system, add or set `logout` to `''` in `/etc/dconf/db/local.d/00-security-settings`. For example:

\[org/gnome/settings-daemon/plugins/media-keys\]
logout=''

Once the settings have been added, add a lock to `/etc/dconf/db/local.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/settings-daemon/plugins/media-keys/logout

After the settings have been set, run `dconf update`.

Rationale:

A locally logged-in user who presses Ctrl-Alt-Del, when at the console, can reboot the system. If accidentally pressed, as could happen in the case of mixed OS environment, this can create the risk of short-term loss of availability of systems due to unintentional reboot.

Severity:  high

Identifiers:  CCE-80124-1

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.1.2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020231](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204456r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/settings-daemon/plugins/media-keys\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/local.d/00-security-settings"
    DBDIR="/etc/dconf/db/local.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/settings-daemon/plugins/media-keys]" >> ${DCONFFILE}
        printf '%s=%s\n' "logout" "''" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "''")"
        if grep -q "^\\s*logout\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*logout\\s*=\\s*.*/logout=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/settings-daemon/plugins/media-keys\\]|a\\logout=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/settings-daemon/plugins/media-keys/logout$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/local.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/settings-daemon/plugins/media-keys/logout" >> "/etc/dconf/db/local.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80124-1
        - DISA-STIG-RHEL-07-020231
        - NIST-800-171-3.1.2
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_ctrlaltdel_reboot
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Disable Ctrl-Alt-Del Reboot Key Sequence in GNOME3
      ini_file:
        dest: /etc/dconf/db/local.d/00-security-settings
        section: org/gnome/settings-daemon/plugins/media-keys
        option: logout
        value: ''''''
        create: true
        no_extra_spaces: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80124-1
        - DISA-STIG-RHEL-07-020231
        - NIST-800-171-3.1.2
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_ctrlaltdel_reboot
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME disablement of Ctrl-Alt-Del
      lineinfile:
        path: /etc/dconf/db/local.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/settings-daemon/plugins/media-keys/logout$
        line: /org/gnome/settings-daemon/plugins/media-keys/logout
        create: true
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80124-1
        - DISA-STIG-RHEL-07-020231
        - NIST-800-171-3.1.2
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_ctrlaltdel_reboot
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when:
        - '"gdm" in ansible_facts.packages'
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80124-1
        - DISA-STIG-RHEL-07-020231
        - NIST-800-171-3.1.2
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(b)
        - dconf_gnome_disable_ctrlaltdel_reboot
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    

#### Make sure that the dconf databases are up-to-date with regards to respective keyfiles   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_db_up_to_date)rule

By default, DConf uses a binary database as a data backend. The system-level database is compiled from keyfiles in the /etc/dconf/db/ directory by the

dconf update

command.

Rationale:

Unlike text-based keyfiles, the binary database is impossible to check by OVAL. Therefore, in order to evaluate dconf configuration, both have to be true at the same time - configuration files have to be compliant, and the database needs to be more recent than those keyfiles, which gives confidence that it reflects them.

Severity:  high

Identifiers:  CCE-81004-4

References:  [164.308(a)(1)(ii)(B)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [1.7.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm && { [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; }; then
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

### Sudo   [\[ref\]](#xccdf_org.ssgproject.content_group_sudo)group

`Sudo`, which stands for "su 'do'", provides the ability to delegate authority to certain users, groups of users, or system administrators. When configured for system users and/or groups, `Sudo` can allow a user or group to execute privileged commands that normally only `root` is allowed to execute.  
  
For more information on `Sudo` and addition `Sudo` configuration options, see **[https://www.sudo.ws](https://www.sudo.ws)**.

contains 5 rules

#### Ensure Users Re-Authenticate for Privilege Escalation - sudo !authenticate   [\[ref\]](#xccdf_org.ssgproject.content_rule_sudo_remove_no_authenticate)rule

The sudo `!authenticate` option, when specified, allows a user to execute commands using sudo without having to authenticate. This should be disabled by making sure that the `!authenticate` option does not exist in `/etc/sudoers` configuration file or any sudo configuration snippets in `/etc/sudoers.d/`.

Rationale:

Without re-authentication, users may access resources or perform tasks for which they do not have authorization.  
  
When operating systems provide the capability to escalate a functional capability, it is critical that the user re-authenticate.

Severity:  medium

Identifiers:  CCE-80350-2

References:  [BP28(R5)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [BP28(R59)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-002038](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000373-GPOS-00156](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000373-GPOS-00157](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000373-GPOS-00158](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000373-VMM-001470, SRG-OS-000373-VMM-001480, SRG-OS-000373-VMM-001490, [RHEL-07-010350](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204430r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    
    for f in /etc/sudoers /etc/sudoers.d/* ; do
      if [ ! -e "$f" ] ; then
        continue
      fi
      matching_list=$(grep -P '^(?!#).*[\s]+\!authenticate.*$' $f | uniq )
      if ! test -z "$matching_list"; then
        while IFS= read -r entry; do
          # comment out "!authenticate" matches to preserve user data
          sed -i "s/^${entry}$/# &/g" $f
        done <<< "$matching_list"
    
        /usr/sbin/visudo -cf $f &> /dev/null || echo "Fail to validate $f with visudo"
      fi
    done
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Find /etc/sudoers.d/ files
      find:
        paths:
          - /etc/sudoers.d/
      register: sudoers
      tags:
        - CCE-80350-2
        - DISA-STIG-RHEL-07-010350
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_remove_no_authenticate
    
    - name: Remove lines containing !authenticate from sudoers files
      replace:
        regexp: (^(?!#).*[\s]+\!authenticate.*$)
        replace: '# \g<1>'
        path: '{{ item.path }}'
        validate: /usr/sbin/visudo -cf %s
      with_items:
        - path: /etc/sudoers
        - '{{ sudoers.files }}'
      tags:
        - CCE-80350-2
        - DISA-STIG-RHEL-07-010350
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_remove_no_authenticate
    

#### Ensure Users Re-Authenticate for Privilege Escalation - sudo NOPASSWD   [\[ref\]](#xccdf_org.ssgproject.content_rule_sudo_remove_nopasswd)rule

The sudo `NOPASSWD` tag, when specified, allows a user to execute commands using sudo without having to authenticate. This should be disabled by making sure that the `NOPASSWD` tag does not exist in `/etc/sudoers` configuration file or any sudo configuration snippets in `/etc/sudoers.d/`.

Rationale:

Without re-authentication, users may access resources or perform tasks for which they do not have authorization.  
  
When operating systems provide the capability to escalate a functional capability, it is critical that the user re-authenticate.

Severity:  medium

Identifiers:  CCE-80351-0

References:  [BP28(R5)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [BP28(R59)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-002038](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000373-GPOS-00156](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000373-GPOS-00157](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000373-GPOS-00158](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000373-VMM-001470, SRG-OS-000373-VMM-001480, SRG-OS-000373-VMM-001490, [RHEL-07-010340](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204429r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    
    for f in /etc/sudoers /etc/sudoers.d/* ; do
      if [ ! -e "$f" ] ; then
        continue
      fi
      matching_list=$(grep -P '^(?!#).*[\s]+NOPASSWD[\s]*\:.*$' $f | uniq )
      if ! test -z "$matching_list"; then
        while IFS= read -r entry; do
          # comment out "NOPASSWD" matches to preserve user data
          sed -i "s/^${entry}$/# &/g" $f
        done <<< "$matching_list"
    
        /usr/sbin/visudo -cf $f &> /dev/null || echo "Fail to validate $f with visudo"
      fi
    done
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Find /etc/sudoers.d/ files
      find:
        paths:
          - /etc/sudoers.d/
      register: sudoers
      tags:
        - CCE-80351-0
        - DISA-STIG-RHEL-07-010340
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_remove_nopasswd
    
    - name: Remove lines containing NOPASSWD from sudoers files
      replace:
        regexp: (^(?!#).*[\s]+NOPASSWD[\s]*\:.*$)
        replace: '# \g<1>'
        path: '{{ item.path }}'
        validate: /usr/sbin/visudo -cf %s
      with_items:
        - path: /etc/sudoers
        - '{{ sudoers.files }}'
      tags:
        - CCE-80351-0
        - DISA-STIG-RHEL-07-010340
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_remove_nopasswd
    

#### The operating system must require Re-Authentication when using the sudo command. Ensure sudo timestamp\_timeout is appropriate - sudo timestamp\_timeout   [\[ref\]](#xccdf_org.ssgproject.content_rule_sudo_require_reauthentication)rule

The sudo `timestamp_timeout` tag sets the amount of time sudo password prompt waits. The default `timestamp_timeout` value is 5 minutes. The timestamp\_timeout should be configured by making sure that the `timestamp_timeout` tag exists in `/etc/sudoers` configuration file or any sudo configuration snippets in `/etc/sudoers.d/`. If the value is set to an integer less than 0, the user's time stamp will not expire and the user will not have to re-authenticate for privileged actions until the user's session is terminated.

Rationale:

Without re-authentication, users may access resources or perform tasks for which they do not have authorization.  
  
When operating systems provide the capability to escalate a functional capability, it is critical that the user re-authenticate.

Severity:  medium

Identifiers:  CCE-85963-7

References:  [CCI-002038](https://public.cyber.mil/stigs/cci/), [IA-11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000373-GPOS-00156](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010343](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-237635r646856\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    
    
    var_sudo_timestamp_timeout="5"
    
    
    
    if /usr/sbin/visudo -qcf /etc/sudoers; then
        cp /etc/sudoers /etc/sudoers.bak
        if ! grep -P '^[\s]*Defaults.*\btimestamp_timeout=[-]?\w+\b\b.*$' /etc/sudoers; then
            # sudoers file doesn't define Option timestamp_timeout
            echo "Defaults timestamp_timeout=${var_sudo_timestamp_timeout}" >> /etc/sudoers
        else
            # sudoers file defines Option timestamp_timeout, remediate if appropriate value is not set
            if ! grep -P "^[\s]*Defaults.*\btimestamp_timeout=${var_sudo_timestamp_timeout}\b.*$" /etc/sudoers; then
                
                sed -Ei "s/(^[\s]*Defaults.*\btimestamp_timeout=)[-]?\w+(\b.*$)/\1${var_sudo_timestamp_timeout}\2/" /etc/sudoers
            fi
        fi
        
        # Check validity of sudoers and cleanup bak
        if /usr/sbin/visudo -qcf /etc/sudoers; then
            rm -f /etc/sudoers.bak
        else
            echo "Fail to validate remediated /etc/sudoers, reverting to original file."
            mv /etc/sudoers.bak /etc/sudoers
            false
        fi
    else
        echo "Skipping remediation, /etc/sudoers failed to validate"
        false
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value var_sudo_timestamp_timeout # promote to variable
      set_fact:
        var_sudo_timestamp_timeout: !!str 5
      tags:
        - always
    
    - name: Ensure timestamp_timeout is enabled with the appropriate value in /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        regexp: ^[\s]*Defaults\s(.*)\btimestamp_timeout=[-]?\w+\b(.*)$
        line: Defaults \1timestamp_timeout={{ var_sudo_timestamp_timeout }}\2
        validate: /usr/sbin/visudo -cf %s
        backrefs: true
      register: edit_sudoers_timestamp_timeout_option
      tags:
        - CCE-85963-7
        - DISA-STIG-RHEL-07-010343
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_require_reauthentication
    
    - name: Enable timestamp_timeout option with appropriate value in /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        line: Defaults timestamp_timeout={{ var_sudo_timestamp_timeout }}
        validate: /usr/sbin/visudo -cf %s
      when: edit_sudoers_timestamp_timeout_option is defined and not edit_sudoers_timestamp_timeout_option.changed
      tags:
        - CCE-85963-7
        - DISA-STIG-RHEL-07-010343
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_require_reauthentication
    

#### The operating system must restrict privilege elevation to authorized personnel   [\[ref\]](#xccdf_org.ssgproject.content_rule_sudo_restrict_privilege_elevation_to_authorized)rule

The sudo command allows a user to execute programs with elevated (administrator) privileges. It prompts the user for their password and confirms your request to execute a command by checking a file, called sudoers. Restrict privileged actions by removing the following entries from the sudoers file: `ALL ALL=(ALL) ALL` `ALL ALL=(ALL:ALL) ALL`

Warning:  This rule doesn't come with a remediation, as the exact requirement allows exceptions, and removing lines from the sudoers file can make the system non-administrable.

Rationale:

If the "sudoers" file is not configured correctly, any user defined on the system can initiate privileged actions on the target system.

Severity:  medium

Identifiers:  CCE-83423-4

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [CM-6(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(iv)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010341](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-237633r646850\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Ensure invoking users password for privilege escalation when using sudo   [\[ref\]](#xccdf_org.ssgproject.content_rule_sudoers_validate_passwd)rule

The sudoers security policy requires that users authenticate themselves before they can use sudo. When sudoers requires authentication, it validates the invoking user's credentials. The expected output for:

sudo egrep -i '(!rootpw|!targetpw|!runaspw)' /etc/sudoers /etc/sudoers.d/\* | grep -v '#'

 /etc/sudoers:Defaults !targetpw
      /etc/sudoers:Defaults !rootpw
      /etc/sudoers:Defaults !runaspw 

Rationale:

If the rootpw, targetpw, or runaspw flags are defined and not disabled, by default the operating system will prompt the invoking user for the "root" user password.

Severity:  medium

Identifiers:  CCE-83421-8

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-002227](https://public.cyber.mil/stigs/cci/), [CM-6(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6.1(iv)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010342](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-237634r646853\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    
    if [ -e "/etc/sudoers" ] ; then
        
        LC_ALL=C sed -i "/Defaults !targetpw/d" "/etc/sudoers"
    else
        touch "/etc/sudoers"
    fi
    cp "/etc/sudoers" "/etc/sudoers.bak"
    # Insert at the end of the file
    printf '%s\n' "Defaults !targetpw" >> "/etc/sudoers"
    # Clean up after ourselves.
    rm "/etc/sudoers.bak"
    if [ -e "/etc/sudoers" ] ; then
        
        LC_ALL=C sed -i "/Defaults !rootpw/d" "/etc/sudoers"
    else
        touch "/etc/sudoers"
    fi
    cp "/etc/sudoers" "/etc/sudoers.bak"
    # Insert at the end of the file
    printf '%s\n' "Defaults !rootpw" >> "/etc/sudoers"
    # Clean up after ourselves.
    rm "/etc/sudoers.bak"
    if [ -e "/etc/sudoers" ] ; then
        
        LC_ALL=C sed -i "/Defaults !runaspw/d" "/etc/sudoers"
    else
        touch "/etc/sudoers"
    fi
    cp "/etc/sudoers" "/etc/sudoers.bak"
    # Insert at the end of the file
    printf '%s\n' "Defaults !runaspw" >> "/etc/sudoers"
    # Clean up after ourselves.
    rm "/etc/sudoers.bak"
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Ensure that Defaults !targetpw is defined in sudoers
      lineinfile:
        path: /etc/sudoers
        create: true
        line: Defaults !targetpw
        state: present
      tags:
        - CCE-83421-8
        - DISA-STIG-RHEL-07-010342
        - NIST-800-53-CM-6(b)
        - NIST-800-53-CM-6.1(iv)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudoers_validate_passwd
    
    - name: Ensure that Defaults !rootpw is defined in sudoers
      lineinfile:
        path: /etc/sudoers
        create: true
        line: Defaults !rootpw
        state: present
      tags:
        - CCE-83421-8
        - DISA-STIG-RHEL-07-010342
        - NIST-800-53-CM-6(b)
        - NIST-800-53-CM-6.1(iv)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudoers_validate_passwd
    
    - name: Ensure that Defaults !runaspw is defined in sudoers
      lineinfile:
        path: /etc/sudoers
        create: true
        line: Defaults !runaspw
        state: present
      tags:
        - CCE-83421-8
        - DISA-STIG-RHEL-07-010342
        - NIST-800-53-CM-6(b)
        - NIST-800-53-CM-6.1(iv)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudoers_validate_passwd
    

### Updating Software   [\[ref\]](#xccdf_org.ssgproject.content_group_updating)group

The `yum` command line tool is used to install and update software packages. The system also provides a graphical software update tool in the **System** menu, in the **Administration** submenu, called **Software Update**.  
  
Red Hat Enterprise Linux 7 systems contain an installed software catalog called the RPM database, which records metadata of installed packages. Consistently using `yum` or the graphical **Software Update** for all software installation allows for insight into the current inventory of installed software on the system.  
  

contains 4 rules

#### Ensure yum Removes Previous Package Versions   [\[ref\]](#xccdf_org.ssgproject.content_rule_clean_components_post_updating)rule

`yum` should be configured to remove previous software components after new versions have been installed. To configure `yum` to remove the previous software components after updating, set the `clean_requirements_on_remove` to `1` in `/etc/yum.conf`.

Rationale:

Previous versions of software components that are not removed from the information system after updates have been installed may be exploited by some adversaries.

Severity:  low

Identifiers:  CCE-80346-0

References:  [18](https://www.cisecurity.org/controls/), [20](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [APO12.01](https://www.isaca.org/resources/cobit), [APO12.02](https://www.isaca.org/resources/cobit), [APO12.03](https://www.isaca.org/resources/cobit), [APO12.04](https://www.isaca.org/resources/cobit), [BAI03.10](https://www.isaca.org/resources/cobit), [DSS05.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [3.4.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-002617](https://public.cyber.mil/stigs/cci/), [4.2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [A.12.6.1](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.16.1.3](https://www.iso.org/standard/54534.html), [A.18.2.2](https://www.iso.org/standard/54534.html), [A.18.2.3](https://www.iso.org/standard/54534.html), [SI-2(6)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-11(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-11(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [ID.RA-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-12](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000437-GPOS-00194](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000437-VMM-001760, [RHEL-07-020200](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204452r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q yum; then
    
    if grep --silent ^clean_requirements_on_remove /etc/yum.conf ; then
            sed -i "s/^clean_requirements_on_remove.*/clean_requirements_on_remove=1/g" /etc/yum.conf
    else
            echo -e "\n# Set clean_requirements_on_remove to 1 per security requirements" >> /etc/yum.conf
            echo "clean_requirements_on_remove=1" >> /etc/yum.conf
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80346-0
        - DISA-STIG-RHEL-07-020200
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-2(6)
        - clean_components_post_updating
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Ensure YUM Removes Previous Package Versions
      lineinfile:
        dest: /etc/yum.conf
        regexp: ^#?clean_requirements_on_remove
        line: clean_requirements_on_remove=1
        insertafter: \[main\]
        create: true
      when: '"yum" in ansible_facts.packages'
      tags:
        - CCE-80346-0
        - DISA-STIG-RHEL-07-020200
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-2(6)
        - clean_components_post_updating
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure gpgcheck Enabled In Main yum Configuration   [\[ref\]](#xccdf_org.ssgproject.content_rule_ensure_gpgcheck_globally_activated)rule

The `gpgcheck` option controls whether RPM packages' signatures are always checked prior to installation. To configure yum to check package signatures before installing them, ensure the following line appears in `/etc/yum.conf` in the `[main]` section:

gpgcheck=1

Rationale:

Changes to any software components can have significant effects on the overall security of the operating system. This requirement ensures the software has not been tampered with and that it has been provided by a trusted vendor.  
Accordingly, patches, service packs, device drivers, or operating system components must be signed with a certificate recognized and approved by the organization.  
Verifying the authenticity of the software prior to installation validates the integrity of the patch or upgrade received from a vendor. This ensures the software has not been tampered with and that it has been provided by a trusted vendor. Self-signed certificates are disallowed by this requirement. Certificates used to verify the software must be from an approved Certificate Authority (CA).

Severity:  high

Identifiers:  CCE-26989-4

References:  [BP28(R15)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.4.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.4.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-001749](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(c)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(c)(2)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.2.1](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [CM-5(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-12(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SA-12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SA-12(10)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-11(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-11(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.DS-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-8](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FPT\_TUD\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [FPT\_TUD\_EXT.2](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-6.2](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000366-GPOS-00153](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000366-VMM-001430, SRG-OS-000370-VMM-001460, SRG-OS-000404-VMM-001650, [RHEL-07-020050](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204447r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.2.3](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q yum; then
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/yum.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-26989-4" ]; then
        cce="CCE"
    else
        cce="CCE-26989-4"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^gpgcheck")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "1"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^gpgcheck\\>" "/etc/yum.conf"; then
        "${sed_command[@]}" "s/^gpgcheck\\>.*/$formatted_output/gi" "/etc/yum.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/yum.conf" >> "/etc/yum.conf"
        printf '%s\n' "$formatted_output" >> "/etc/yum.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-26989-4
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-020050
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - ensure_gpgcheck_globally_activated
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Check existence of yum on Fedora
      stat:
        path: /etc/yum.conf
      register: yum_config_file
      check_mode: false
      when:
        - '"yum" in ansible_facts.packages'
        - ansible_distribution == "Fedora"
      tags:
        - CCE-26989-4
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-020050
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - ensure_gpgcheck_globally_activated
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Ensure GPG check is globally activated (yum)
      ini_file:
        dest: /etc/yum.conf
        section: main
        option: gpgcheck
        value: 1
        no_extra_spaces: true
        create: false
      when:
        - '"yum" in ansible_facts.packages'
        - (ansible_distribution == "RedHat" or ansible_distribution == "CentOS" or ansible_distribution
          == "Scientific" or yum_config_file.stat.exists)
      tags:
        - CCE-26989-4
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-020050
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - ensure_gpgcheck_globally_activated
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Ensure GPG check is globally activated (dnf)
      ini_file:
        dest: /etc/dnf/dnf.conf
        section: main
        option: gpgcheck
        value: 1
        no_extra_spaces: true
        create: false
      when:
        - '"yum" in ansible_facts.packages'
        - ansible_distribution == "Fedora"
      tags:
        - CCE-26989-4
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-020050
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - ensure_gpgcheck_globally_activated
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    

#### Ensure gpgcheck Enabled for Local Packages   [\[ref\]](#xccdf_org.ssgproject.content_rule_ensure_gpgcheck_local_packages)rule

`yum` should be configured to verify the signature(s) of local packages prior to installation. To configure `yum` to verify signatures of local packages, set the `localpkg_gpgcheck` to `1` in `/etc/yum.conf`.

Rationale:

Changes to any software components can have significant effects to the overall security of the operating system. This requirement ensures the software has not been tampered and has been provided by a trusted vendor.  
  
Accordingly, patches, service packs, device drivers, or operating system components must be signed with a certificate recognized and approved by the organization.

Severity:  high

Identifiers:  CCE-80347-8

References:  [BP28(R15)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.4.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-001749](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(c)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(c)(2)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [CM-11(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-11(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-5(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SA-12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SA-12(10)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FPT\_TUD\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [FPT\_TUD\_EXT.2](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000366-GPOS-00153](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000366-VMM-001430, SRG-OS-000370-VMM-001460, SRG-OS-000404-VMM-001650, [RHEL-07-020060](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204448r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q yum; then
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/yum.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80347-8" ]; then
        cce="CCE"
    else
        cce="CCE-80347-8"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^localpkg_gpgcheck")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "1"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^localpkg_gpgcheck\\>" "/etc/yum.conf"; then
        "${sed_command[@]}" "s/^localpkg_gpgcheck\\>.*/$formatted_output/gi" "/etc/yum.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/yum.conf" >> "/etc/yum.conf"
        printf '%s\n' "$formatted_output" >> "/etc/yum.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80347-8
        - DISA-STIG-RHEL-07-020060
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - ensure_gpgcheck_local_packages
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Check existence of yum on Fedora
      stat:
        path: /etc/yum.conf
      register: yum_config_file
      check_mode: false
      when:
        - '"yum" in ansible_facts.packages'
        - ansible_distribution == "Fedora"
      tags:
        - CCE-80347-8
        - DISA-STIG-RHEL-07-020060
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - ensure_gpgcheck_local_packages
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Ensure GPG check Enabled for Local Packages (Yum)
      ini_file:
        dest: /etc/yum.conf
        section: main
        option: localpkg_gpgcheck
        value: 1
        create: true
      when:
        - '"yum" in ansible_facts.packages'
        - (ansible_distribution == "RedHat" or ansible_distribution == "CentOS" or ansible_distribution
          == "Scientific" or yum_config_file.stat.exists)
      tags:
        - CCE-80347-8
        - DISA-STIG-RHEL-07-020060
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - ensure_gpgcheck_local_packages
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    
    - name: Ensure GPG check Enabled for Local Packages (DNF)
      ini_file:
        dest: /etc/dnf/dnf.conf
        section: main
        option: localpkg_gpgcheck
        value: 1
        create: true
      when:
        - '"yum" in ansible_facts.packages'
        - ansible_distribution == "Fedora"
      tags:
        - CCE-80347-8
        - DISA-STIG-RHEL-07-020060
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - ensure_gpgcheck_local_packages
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy
    

#### Ensure Software Patches Installed   [\[ref\]](#xccdf_org.ssgproject.content_rule_security_patches_up_to_date)rule

If the system is joined to the Red Hat Network, a Red Hat Satellite Server, or a yum server, run the following command to install updates:

$ sudo yum update

If the system is not configured to use one of these sources, updates (in the form of RPM packages) can be manually downloaded from the Red Hat Network and installed using `rpm`.  
  
NOTE: U.S. Defense systems are required to be patched within 30 days or sooner as local policy dictates.

Rationale:

Installing software updates is a fundamental mitigation against the exploitation of publicly-known vulnerabilities. If the most recent security patches and updates are not installed, unauthorized users may take advantage of weaknesses in the unpatched software. The lack of prompt attention to patching could result in a system compromise.

Severity:  high

Identifiers:  CCE-26895-3

References:  [BP28(R08)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [18](https://www.cisecurity.org/controls/), [20](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5.10.4.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO12.01](https://www.isaca.org/resources/cobit), [APO12.02](https://www.isaca.org/resources/cobit), [APO12.03](https://www.isaca.org/resources/cobit), [APO12.04](https://www.isaca.org/resources/cobit), [BAI03.10](https://www.isaca.org/resources/cobit), [DSS05.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001227](https://public.cyber.mil/stigs/cci/), [4.2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.2.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [A.12.6.1](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.16.1.3](https://www.iso.org/standard/54534.html), [A.18.2.2](https://www.iso.org/standard/54534.html), [A.18.2.3](https://www.iso.org/standard/54534.html), [SI-2(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SI-2(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [ID.RA-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-12](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-6.2](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-020260](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204459r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.8](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

high

Reboot:

true

Strategy:

patch

    
    
    yum -y update
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

high

Reboot:

true

Strategy:

patch

    - name: Security patches are up to date
      package:
        name: '*'
        state: latest
      tags:
        - CCE-26895-3
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-07-020260
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-2(5)
        - NIST-800-53-SI-2(c)
        - PCI-DSS-Req-6.2
        - high_disruption
        - high_severity
        - low_complexity
        - patch_strategy
        - reboot_required
        - security_patches_up_to_date
        - skip_ansible_lint
    

### Account and Access Control   [\[ref\]](#xccdf_org.ssgproject.content_group_accounts)group

In traditional Unix security, if an attacker gains shell access to a certain login account, they can perform any action or access any file to which that account has access. Therefore, making it more difficult for unauthorized people to gain shell access to accounts, particularly to privileged accounts, is a necessary part of securing a system. This section introduces mechanisms for restricting access to accounts under Red Hat Enterprise Linux 7.

contains 54 rules

### Warning Banners for System Accesses   [\[ref\]](#xccdf_org.ssgproject.content_group_accounts-banners)group

Each system should expose as little information about itself as possible.  
  
System banners, which are typically displayed just before a login prompt, give out information about the service or the host's operating system. This might include the distribution name and the system kernel version, and the particular version of a network service. This information can assist intruders in gaining access to the system as it can reveal whether the system is running vulnerable software. Most network services can be configured to limit what information is displayed.  
  
Many organizations implement security policies that require a system banner provide notice of the system's ownership, provide warning to unauthorized users, and remind authorized users of their consent to monitoring.

contains 3 rules

### Implement a GUI Warning Banner   [\[ref\]](#xccdf_org.ssgproject.content_group_gui_login_banner)group

In the default graphical environment, users logging directly into the system are greeted with a login screen provided by the GNOME Display Manager (GDM). The warning banner should be displayed in this graphical environment for these users. The following sections describe how to configure the GDM login banner.

contains 2 rules

#### Enable GNOME3 Login Warning Banner   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_banner_enabled)rule

In the default graphical environment, displaying a login warning banner in the GNOME Display Manager's login screen can be enabled on the login screen by setting `banner-message-enable` to `true`.  
  
To enable, add or edit `banner-message-enable` to `/etc/dconf/db/gdm.d/00-security-settings`. For example:

\[org/gnome/login-screen\]
banner-message-enable=true

Once the setting has been added, add a lock to `/etc/dconf/db/gdm.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/login-screen/banner-message-enable

After the settings have been set, run `dconf update`. The banner text must also be set.

Rationale:

Display of a standardized and approved use notification before granting access to the operating system ensures privacy and security notification verbiage used is consistent with applicable federal laws, Executive Orders, directives, policies, regulations, standards, and guidance.  
  
For U.S. Government systems, system use notifications are required only for access via login interfaces with human users and are not required when such human interfaces do not exist.

Severity:  medium

Identifiers:  CCE-26970-4

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.9](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000048](https://public.cyber.mil/stigs/cci/), [CCI-000050](https://public.cyber.mil/stigs/cci/), [CCI-001384](https://public.cyber.mil/stigs/cci/), [CCI-001385](https://public.cyber.mil/stigs/cci/), [CCI-001386](https://public.cyber.mil/stigs/cci/), [CCI-001387](https://public.cyber.mil/stigs/cci/), [CCI-001388](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [AC-8(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-8(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-8(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000023-GPOS-00006](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000024-GPOS-00007](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000228-GPOS-00088](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010030](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204393r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.8.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm; then
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/login-screen\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/gdm.d/00-security-settings"
    DBDIR="/etc/dconf/db/gdm.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/login-screen]" >> ${DCONFFILE}
        printf '%s=%s\n' "banner-message-enable" "true" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "true")"
        if grep -q "^\\s*banner-message-enable\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*banner-message-enable\\s*=\\s*.*/banner-message-enable=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/login-screen\\]|a\\banner-message-enable=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/login-screen/banner-message-enable$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/gdm.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/login-screen/banner-message-enable" >> "/etc/dconf/db/gdm.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-26970-4
        - DISA-STIG-RHEL-07-010030
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(b)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_banner_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Enable GNOME3 Login Warning Banner
      ini_file:
        dest: /etc/dconf/db/gdm.d/00-security-settings
        section: org/gnome/login-screen
        option: banner-message-enable
        value: 'true'
        create: true
        no_extra_spaces: true
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-26970-4
        - DISA-STIG-RHEL-07-010030
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(b)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_banner_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of GNOME banner-message-enabled
      lineinfile:
        path: /etc/dconf/db/gdm.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/login-screen/banner-message-enable$
        line: /org/gnome/login-screen/banner-message-enable
        create: true
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-26970-4
        - DISA-STIG-RHEL-07-010030
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(b)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_banner_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-26970-4
        - DISA-STIG-RHEL-07-010030
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(b)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_banner_enabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Set the GNOME3 Login Warning Banner Text   [\[ref\]](#xccdf_org.ssgproject.content_rule_dconf_gnome_login_banner_text)rule

In the default graphical environment, configuring the login warning banner text in the GNOME Display Manager's login screen can be configured on the login screen by setting `banner-message-text` to `'_APPROVED_BANNER_'` where _APPROVED\_BANNER_ is the approved banner for your environment.  
  
To enable, add or edit `banner-message-text` to `/etc/dconf/db/gdm.d/00-security-settings`. For example:

\[org/gnome/login-screen\]
banner-message-text='_APPROVED\_BANNER_'

Once the setting has been added, add a lock to `/etc/dconf/db/gdm.d/locks/00-security-settings-lock` to prevent user modification. For example:

/org/gnome/login-screen/banner-message-text

After the settings have been set, run `dconf update`. When entering a warning banner that spans several lines, remember to begin and end the string with `'` and use `\n` for new lines.

Rationale:

An appropriate warning message reinforces policy awareness during the logon process and facilitates possible legal action against attackers.

Severity:  medium

Identifiers:  CCE-26892-0

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.9](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000048](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [AC-8(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-8(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000023-GPOS-00006](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000024-GPOS-00007](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000228-GPOS-00088](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010040](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204394r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.8.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q gdm; then
    
    
    login_banner_text="^(You[\s\n]+are[\s\n]+accessing[\s\n]+a[\s\n]+U\.S\.[\s\n]+Government[\s\n]+\(USG\)[\s\n]+Information[\s\n]+System[\s\n]+\(IS\)[\s\n]+that[\s\n]+is[\s\n]+provided[\s\n]+for[\s\n]+USG\-authorized[\s\n]+use[\s\n]+only\.[\s\n]+By[\s\n]+using[\s\n]+this[\s\n]+IS[\s\n]+\(which[\s\n]+includes[\s\n]+any[\s\n]+device[\s\n]+attached[\s\n]+to[\s\n]+this[\s\n]+IS\)\,[\s\n]+you[\s\n]+consent[\s\n]+to[\s\n]+the[\s\n]+following[\s\n]+conditions\:(?:[\n]+|(?:\\n)+)\-The[\s\n]+USG[\s\n]+routinely[\s\n]+intercepts[\s\n]+and[\s\n]+monitors[\s\n]+communications[\s\n]+on[\s\n]+this[\s\n]+IS[\s\n]+for[\s\n]+purposes[\s\n]+including\,[\s\n]+but[\s\n]+not[\s\n]+limited[\s\n]+to\,[\s\n]+penetration[\s\n]+testing\,[\s\n]+COMSEC[\s\n]+monitoring\,[\s\n]+network[\s\n]+operations[\s\n]+and[\s\n]+defense\,[\s\n]+personnel[\s\n]+misconduct[\s\n]+\(PM\)\,[\s\n]+law[\s\n]+enforcement[\s\n]+\(LE\)\,[\s\n]+and[\s\n]+counterintelligence[\s\n]+\(CI\)[\s\n]+investigations\.(?:[\n]+|(?:\\n)+)\-At[\s\n]+any[\s\n]+time\,[\s\n]+the[\s\n]+USG[\s\n]+may[\s\n]+inspect[\s\n]+and[\s\n]+seize[\s\n]+data[\s\n]+stored[\s\n]+on[\s\n]+this[\s\n]+IS\.(?:[\n]+|(?:\\n)+)\-Communications[\s\n]+using\,[\s\n]+or[\s\n]+data[\s\n]+stored[\s\n]+on\,[\s\n]+this[\s\n]+IS[\s\n]+are[\s\n]+not[\s\n]+private\,[\s\n]+are[\s\n]+subject[\s\n]+to[\s\n]+routine[\s\n]+monitoring\,[\s\n]+interception\,[\s\n]+and[\s\n]+search\,[\s\n]+and[\s\n]+may[\s\n]+be[\s\n]+disclosed[\s\n]+or[\s\n]+used[\s\n]+for[\s\n]+any[\s\n]+USG\-authorized[\s\n]+purpose\.(?:[\n]+|(?:\\n)+)\-This[\s\n]+IS[\s\n]+includes[\s\n]+security[\s\n]+measures[\s\n]+\(e\.g\.\,[\s\n]+authentication[\s\n]+and[\s\n]+access[\s\n]+controls\)[\s\n]+to[\s\n]+protect[\s\n]+USG[\s\n]+interests\-\-not[\s\n]+for[\s\n]+your[\s\n]+personal[\s\n]+benefit[\s\n]+or[\s\n]+privacy\.(?:[\n]+|(?:\\n)+)\-Notwithstanding[\s\n]+the[\s\n]+above\,[\s\n]+using[\s\n]+this[\s\n]+IS[\s\n]+does[\s\n]+not[\s\n]+constitute[\s\n]+consent[\s\n]+to[\s\n]+PM\,[\s\n]+LE[\s\n]+or[\s\n]+CI[\s\n]+investigative[\s\n]+searching[\s\n]+or[\s\n]+monitoring[\s\n]+of[\s\n]+the[\s\n]+content[\s\n]+of[\s\n]+privileged[\s\n]+communications\,[\s\n]+or[\s\n]+work[\s\n]+product\,[\s\n]+related[\s\n]+to[\s\n]+personal[\s\n]+representation[\s\n]+or[\s\n]+services[\s\n]+by[\s\n]+attorneys\,[\s\n]+psychotherapists\,[\s\n]+or[\s\n]+clergy\,[\s\n]+and[\s\n]+their[\s\n]+assistants\.[\s\n]+Such[\s\n]+communications[\s\n]+and[\s\n]+work[\s\n]+product[\s\n]+are[\s\n]+private[\s\n]+and[\s\n]+confidential\.[\s\n]+See[\s\n]+User[\s\n]+Agreement[\s\n]+for[\s\n]+details\.|I've[\s\n]+read[\s\n]+\&[\s\n]+consent[\s\n]+to[\s\n]+terms[\s\n]+in[\s\n]+IS[\s\n]+user[\s\n]+agreem't\.)$"
    
    
    
    # Multiple regexes transform the banner regex into a usable banner
    # 0 - Remove anchors around the banner text
    login_banner_text=$(echo "$login_banner_text" | sed 's/^\^\(.*\)\$$/\1/g')
    # 1 - Keep only the first banners if there are multiple
    #    (dod_banners contains the long and short banner)
    login_banner_text=$(echo "$login_banner_text" | sed 's/^(\(.*\)|.*)$/\1/g')
    # 2 - Add spaces ' '. (Transforms regex for "space or newline" into a " ")
    login_banner_text=$(echo "$login_banner_text" | sed 's/\[\\s\\n\]+/ /g')
    # 3 - Adds newline "tokens". (Transforms "(?:\[\\n\]+|(?:\\n)+)" into "(n)*")
    login_banner_text=$(echo "$login_banner_text" | sed 's/(?:\[\\n\]+|(?:\\n)+)/(n)*/g')
    # 4 - Remove any leftover backslash. (From any parethesis in the banner, for example).
    login_banner_text=$(echo "$login_banner_text" | sed 's/\\//g')
    # 5 - Removes the newline "token." (Transforms them into newline escape sequences "\n").
    #    ( Needs to be done after 4, otherwise the escapce sequence will become just "n".
    login_banner_text=$(echo "$login_banner_text" | sed 's/(n)\*/\\n/g')
    
    # Check for setting in any of the DConf db directories
    # If files contain ibus or distro, ignore them.
    # The assignment assumes that individual filenames don't contain :
    readarray -t SETTINGSFILES < <(grep -r "\\[org/gnome/login-screen\\]" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    DCONFFILE="/etc/dconf/db/gdm.d/00-security-settings"
    DBDIR="/etc/dconf/db/gdm.d"
    
    mkdir -p "${DBDIR}"
    
    if [ "${#SETTINGSFILES[@]}" -eq 0 ]
    then
        [ ! -z ${DCONFFILE} ] || echo "" >> ${DCONFFILE}
        printf '%s\n' "[org/gnome/login-screen]" >> ${DCONFFILE}
        printf '%s=%s\n' "banner-message-text" "'${login_banner_text}'" >> ${DCONFFILE}
    else
        escaped_value="$(sed -e 's/\\/\\\\/g' <<< "'${login_banner_text}'")"
        if grep -q "^\\s*banner-message-text\\s*=" "${SETTINGSFILES[@]}"
        then
            
            sed -i "s/\\s*banner-message-text\\s*=\\s*.*/banner-message-text=${escaped_value}/g" "${SETTINGSFILES[@]}"
        else
            sed -i "\\|\\[org/gnome/login-screen\\]|a\\banner-message-text=${escaped_value}" "${SETTINGSFILES[@]}"
        fi
    fi
    
    dconf update
    # Check for setting in any of the DConf db directories
    LOCKFILES=$(grep -r "^/org/gnome/login-screen/banner-message-text$" "/etc/dconf/db/" | grep -v 'distro\|ibus' | cut -d":" -f1)
    LOCKSFOLDER="/etc/dconf/db/gdm.d/locks"
    
    mkdir -p "${LOCKSFOLDER}"
    
    if [[ -z "${LOCKFILES}" ]]
    then
        echo "/org/gnome/login-screen/banner-message-text" >> "/etc/dconf/db/gdm.d/locks/00-security-settings-lock"
    fi
    
    dconf update
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-26892-0
        - DISA-STIG-RHEL-07-010040
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_login_banner_text
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    - name: XCCDF Value login_banner_text # promote to variable
      set_fact:
        login_banner_text: !!str ^(You[\s\n]+are[\s\n]+accessing[\s\n]+a[\s\n]+U\.S\.[\s\n]+Government[\s\n]+\(USG\)[\s\n]+Information[\s\n]+System[\s\n]+\(IS\)[\s\n]+that[\s\n]+is[\s\n]+provided[\s\n]+for[\s\n]+USG\-authorized[\s\n]+use[\s\n]+only\.[\s\n]+By[\s\n]+using[\s\n]+this[\s\n]+IS[\s\n]+\(which[\s\n]+includes[\s\n]+any[\s\n]+device[\s\n]+attached[\s\n]+to[\s\n]+this[\s\n]+IS\)\,[\s\n]+you[\s\n]+consent[\s\n]+to[\s\n]+the[\s\n]+following[\s\n]+conditions\:(?:[\n]+|(?:\\n)+)\-The[\s\n]+USG[\s\n]+routinely[\s\n]+intercepts[\s\n]+and[\s\n]+monitors[\s\n]+communications[\s\n]+on[\s\n]+this[\s\n]+IS[\s\n]+for[\s\n]+purposes[\s\n]+including\,[\s\n]+but[\s\n]+not[\s\n]+limited[\s\n]+to\,[\s\n]+penetration[\s\n]+testing\,[\s\n]+COMSEC[\s\n]+monitoring\,[\s\n]+network[\s\n]+operations[\s\n]+and[\s\n]+defense\,[\s\n]+personnel[\s\n]+misconduct[\s\n]+\(PM\)\,[\s\n]+law[\s\n]+enforcement[\s\n]+\(LE\)\,[\s\n]+and[\s\n]+counterintelligence[\s\n]+\(CI\)[\s\n]+investigations\.(?:[\n]+|(?:\\n)+)\-At[\s\n]+any[\s\n]+time\,[\s\n]+the[\s\n]+USG[\s\n]+may[\s\n]+inspect[\s\n]+and[\s\n]+seize[\s\n]+data[\s\n]+stored[\s\n]+on[\s\n]+this[\s\n]+IS\.(?:[\n]+|(?:\\n)+)\-Communications[\s\n]+using\,[\s\n]+or[\s\n]+data[\s\n]+stored[\s\n]+on\,[\s\n]+this[\s\n]+IS[\s\n]+are[\s\n]+not[\s\n]+private\,[\s\n]+are[\s\n]+subject[\s\n]+to[\s\n]+routine[\s\n]+monitoring\,[\s\n]+interception\,[\s\n]+and[\s\n]+search\,[\s\n]+and[\s\n]+may[\s\n]+be[\s\n]+disclosed[\s\n]+or[\s\n]+used[\s\n]+for[\s\n]+any[\s\n]+USG\-authorized[\s\n]+purpose\.(?:[\n]+|(?:\\n)+)\-This[\s\n]+IS[\s\n]+includes[\s\n]+security[\s\n]+measures[\s\n]+\(e\.g\.\,[\s\n]+authentication[\s\n]+and[\s\n]+access[\s\n]+controls\)[\s\n]+to[\s\n]+protect[\s\n]+USG[\s\n]+interests\-\-not[\s\n]+for[\s\n]+your[\s\n]+personal[\s\n]+benefit[\s\n]+or[\s\n]+privacy\.(?:[\n]+|(?:\\n)+)\-Notwithstanding[\s\n]+the[\s\n]+above\,[\s\n]+using[\s\n]+this[\s\n]+IS[\s\n]+does[\s\n]+not[\s\n]+constitute[\s\n]+consent[\s\n]+to[\s\n]+PM\,[\s\n]+LE[\s\n]+or[\s\n]+CI[\s\n]+investigative[\s\n]+searching[\s\n]+or[\s\n]+monitoring[\s\n]+of[\s\n]+the[\s\n]+content[\s\n]+of[\s\n]+privileged[\s\n]+communications\,[\s\n]+or[\s\n]+work[\s\n]+product\,[\s\n]+related[\s\n]+to[\s\n]+personal[\s\n]+representation[\s\n]+or[\s\n]+services[\s\n]+by[\s\n]+attorneys\,[\s\n]+psychotherapists\,[\s\n]+or[\s\n]+clergy\,[\s\n]+and[\s\n]+their[\s\n]+assistants\.[\s\n]+Such[\s\n]+communications[\s\n]+and[\s\n]+work[\s\n]+product[\s\n]+are[\s\n]+private[\s\n]+and[\s\n]+confidential\.[\s\n]+See[\s\n]+User[\s\n]+Agreement[\s\n]+for[\s\n]+details\.|I've[\s\n]+read[\s\n]+\&[\s\n]+consent[\s\n]+to[\s\n]+terms[\s\n]+in[\s\n]+IS[\s\n]+user[\s\n]+agreem't\.)$
      tags:
        - always
    
    - name: Set the GNOME3 Login Warning Banner Text
      file:
        path: /etc/dconf/db/{{ item }}
        owner: root
        group: root
        mode: 493
        state: directory
      with_items:
        - gdm.d
        - gdm.d/locks
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-26892-0
        - DISA-STIG-RHEL-07-010040
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_login_banner_text
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Set the GNOME3 Login Warning Banner Text
      file:
        path: /etc/dconf/db/gdm.d/{{ item }}
        owner: root
        group: root
        mode: 420
        state: touch
      with_items:
        - 00-security-settings
        - locks/00-security-settings-lock
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-26892-0
        - DISA-STIG-RHEL-07-010040
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_login_banner_text
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Set the GNOME3 Login Warning Banner Text
      ini_file:
        dest: /etc/dconf/db/gdm.d/00-security-settings
        section: org/gnome/login-screen
        option: banner-message-text
        value: '''{{ login_banner_text | regex_replace("^\^(.*)\$$", "\1") | regex_replace("^\((.*)\|.*\)$",
          "\1") | regex_replace("\[\\s\\n\]\+"," ") | regex_replace("\(\?:\[\\n\]\+\|\(\?:\\\\n\)\+\)",
          "(n)*") | regex_replace("\\", "") | regex_replace("\(n\)\*", "\\n") }}'''
        create: true
        no_extra_spaces: true
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-26892-0
        - DISA-STIG-RHEL-07-010040
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_login_banner_text
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Prevent user modification of the GNOME3 Login Warning Banner Text
      lineinfile:
        path: /etc/dconf/db/gdm.d/locks/00-security-settings-lock
        regexp: ^/org/gnome/login-screen/banner-message-text$
        line: /org/gnome/login-screen/banner-message-text
        create: true
        state: present
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-26892-0
        - DISA-STIG-RHEL-07-010040
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_login_banner_text
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    
    - name: Dconf Update
      command: dconf update
      when: '"gdm" in ansible_facts.packages'
      tags:
        - CCE-26892-0
        - DISA-STIG-RHEL-07-010040
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(c)
        - dconf_gnome_login_banner_text
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

#### Modify the System Login Banner   [\[ref\]](#xccdf_org.ssgproject.content_rule_banner_etc_issue)rule

To configure the system login banner edit `/etc/issue`. Replace the default text with a message compliant with the local site policy or a legal disclaimer. The DoD required text is either:  
  
`You are accessing a U.S. Government (USG) Information System (IS) that is provided for USG-authorized use only. By using this IS (which includes any device attached to this IS), you consent to the following conditions:  
-The USG routinely intercepts and monitors communications on this IS for purposes including, but not limited to, penetration testing, COMSEC monitoring, network operations and defense, personnel misconduct (PM), law enforcement (LE), and counterintelligence (CI) investigations.  
-At any time, the USG may inspect and seize data stored on this IS.  
-Communications using, or data stored on, this IS are not private, are subject to routine monitoring, interception, and search, and may be disclosed or used for any USG-authorized purpose.  
-This IS includes security measures (e.g., authentication and access controls) to protect USG interests -- not for your personal benefit or privacy.  
-Notwithstanding the above, using this IS does not constitute consent to PM, LE or CI investigative searching or monitoring of the content of privileged communications, or work product, related to personal representation or services by attorneys, psychotherapists, or clergy, and their assistants. Such communications and work product are private and confidential. See User Agreement for details.`  
  
OR:  
  
`I've read & consent to terms in IS user agreem't.`

Rationale:

Display of a standardized and approved use notification before granting access to the operating system ensures privacy and security notification verbiage used is consistent with applicable federal laws, Executive Orders, directives, policies, regulations, standards, and guidance.  
  
System use notifications are required only for access via login interfaces with human users and are not required when such human interfaces do not exist.

Severity:  medium

Identifiers:  CCE-27303-7

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.9](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000048](https://public.cyber.mil/stigs/cci/), [CCI-000050](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [AC-8(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-8(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000023-GPOS-00006](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000024-GPOS-00007](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000023-VMM-000060, SRG-OS-000024-VMM-000070, [RHEL-07-010050](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204395r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.7.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    login_banner_text="^(You[\s\n]+are[\s\n]+accessing[\s\n]+a[\s\n]+U\.S\.[\s\n]+Government[\s\n]+\(USG\)[\s\n]+Information[\s\n]+System[\s\n]+\(IS\)[\s\n]+that[\s\n]+is[\s\n]+provided[\s\n]+for[\s\n]+USG\-authorized[\s\n]+use[\s\n]+only\.[\s\n]+By[\s\n]+using[\s\n]+this[\s\n]+IS[\s\n]+\(which[\s\n]+includes[\s\n]+any[\s\n]+device[\s\n]+attached[\s\n]+to[\s\n]+this[\s\n]+IS\)\,[\s\n]+you[\s\n]+consent[\s\n]+to[\s\n]+the[\s\n]+following[\s\n]+conditions\:(?:[\n]+|(?:\\n)+)\-The[\s\n]+USG[\s\n]+routinely[\s\n]+intercepts[\s\n]+and[\s\n]+monitors[\s\n]+communications[\s\n]+on[\s\n]+this[\s\n]+IS[\s\n]+for[\s\n]+purposes[\s\n]+including\,[\s\n]+but[\s\n]+not[\s\n]+limited[\s\n]+to\,[\s\n]+penetration[\s\n]+testing\,[\s\n]+COMSEC[\s\n]+monitoring\,[\s\n]+network[\s\n]+operations[\s\n]+and[\s\n]+defense\,[\s\n]+personnel[\s\n]+misconduct[\s\n]+\(PM\)\,[\s\n]+law[\s\n]+enforcement[\s\n]+\(LE\)\,[\s\n]+and[\s\n]+counterintelligence[\s\n]+\(CI\)[\s\n]+investigations\.(?:[\n]+|(?:\\n)+)\-At[\s\n]+any[\s\n]+time\,[\s\n]+the[\s\n]+USG[\s\n]+may[\s\n]+inspect[\s\n]+and[\s\n]+seize[\s\n]+data[\s\n]+stored[\s\n]+on[\s\n]+this[\s\n]+IS\.(?:[\n]+|(?:\\n)+)\-Communications[\s\n]+using\,[\s\n]+or[\s\n]+data[\s\n]+stored[\s\n]+on\,[\s\n]+this[\s\n]+IS[\s\n]+are[\s\n]+not[\s\n]+private\,[\s\n]+are[\s\n]+subject[\s\n]+to[\s\n]+routine[\s\n]+monitoring\,[\s\n]+interception\,[\s\n]+and[\s\n]+search\,[\s\n]+and[\s\n]+may[\s\n]+be[\s\n]+disclosed[\s\n]+or[\s\n]+used[\s\n]+for[\s\n]+any[\s\n]+USG\-authorized[\s\n]+purpose\.(?:[\n]+|(?:\\n)+)\-This[\s\n]+IS[\s\n]+includes[\s\n]+security[\s\n]+measures[\s\n]+\(e\.g\.\,[\s\n]+authentication[\s\n]+and[\s\n]+access[\s\n]+controls\)[\s\n]+to[\s\n]+protect[\s\n]+USG[\s\n]+interests\-\-not[\s\n]+for[\s\n]+your[\s\n]+personal[\s\n]+benefit[\s\n]+or[\s\n]+privacy\.(?:[\n]+|(?:\\n)+)\-Notwithstanding[\s\n]+the[\s\n]+above\,[\s\n]+using[\s\n]+this[\s\n]+IS[\s\n]+does[\s\n]+not[\s\n]+constitute[\s\n]+consent[\s\n]+to[\s\n]+PM\,[\s\n]+LE[\s\n]+or[\s\n]+CI[\s\n]+investigative[\s\n]+searching[\s\n]+or[\s\n]+monitoring[\s\n]+of[\s\n]+the[\s\n]+content[\s\n]+of[\s\n]+privileged[\s\n]+communications\,[\s\n]+or[\s\n]+work[\s\n]+product\,[\s\n]+related[\s\n]+to[\s\n]+personal[\s\n]+representation[\s\n]+or[\s\n]+services[\s\n]+by[\s\n]+attorneys\,[\s\n]+psychotherapists\,[\s\n]+or[\s\n]+clergy\,[\s\n]+and[\s\n]+their[\s\n]+assistants\.[\s\n]+Such[\s\n]+communications[\s\n]+and[\s\n]+work[\s\n]+product[\s\n]+are[\s\n]+private[\s\n]+and[\s\n]+confidential\.[\s\n]+See[\s\n]+User[\s\n]+Agreement[\s\n]+for[\s\n]+details\.|I've[\s\n]+read[\s\n]+\&[\s\n]+consent[\s\n]+to[\s\n]+terms[\s\n]+in[\s\n]+IS[\s\n]+user[\s\n]+agreem't\.)$"
    
    
    
    # Multiple regexes transform the banner regex into a usable banner
    # 0 - Remove anchors around the banner text
    login_banner_text=$(echo "$login_banner_text" | sed 's/^\^\(.*\)\$$/\1/g')
    # 1 - Keep only the first banners if there are multiple
    #    (dod_banners contains the long and short banner)
    login_banner_text=$(echo "$login_banner_text" | sed 's/^(\(.*\)|.*)$/\1/g')
    # 2 - Add spaces ' '. (Transforms regex for "space or newline" into a " ")
    login_banner_text=$(echo "$login_banner_text" | sed 's/\[\\s\\n\]+/ /g')
    # 3 - Adds newlines. (Transforms "(?:\[\\n\]+|(?:\\n)+)" into "\n")
    login_banner_text=$(echo "$login_banner_text" | sed 's/(?:\[\\n\]+|(?:\\n)+)/\n/g')
    # 4 - Remove any leftover backslash. (From any parethesis in the banner, for example).
    login_banner_text=$(echo "$login_banner_text" | sed 's/\\//g')
    formatted=$(echo "$login_banner_text" | fold -sw 80)
    
    cat <<EOF >/etc/issue
    $formatted
    EOF
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: XCCDF Value login_banner_text # promote to variable
      set_fact:
        login_banner_text: !!str ^(You[\s\n]+are[\s\n]+accessing[\s\n]+a[\s\n]+U\.S\.[\s\n]+Government[\s\n]+\(USG\)[\s\n]+Information[\s\n]+System[\s\n]+\(IS\)[\s\n]+that[\s\n]+is[\s\n]+provided[\s\n]+for[\s\n]+USG\-authorized[\s\n]+use[\s\n]+only\.[\s\n]+By[\s\n]+using[\s\n]+this[\s\n]+IS[\s\n]+\(which[\s\n]+includes[\s\n]+any[\s\n]+device[\s\n]+attached[\s\n]+to[\s\n]+this[\s\n]+IS\)\,[\s\n]+you[\s\n]+consent[\s\n]+to[\s\n]+the[\s\n]+following[\s\n]+conditions\:(?:[\n]+|(?:\\n)+)\-The[\s\n]+USG[\s\n]+routinely[\s\n]+intercepts[\s\n]+and[\s\n]+monitors[\s\n]+communications[\s\n]+on[\s\n]+this[\s\n]+IS[\s\n]+for[\s\n]+purposes[\s\n]+including\,[\s\n]+but[\s\n]+not[\s\n]+limited[\s\n]+to\,[\s\n]+penetration[\s\n]+testing\,[\s\n]+COMSEC[\s\n]+monitoring\,[\s\n]+network[\s\n]+operations[\s\n]+and[\s\n]+defense\,[\s\n]+personnel[\s\n]+misconduct[\s\n]+\(PM\)\,[\s\n]+law[\s\n]+enforcement[\s\n]+\(LE\)\,[\s\n]+and[\s\n]+counterintelligence[\s\n]+\(CI\)[\s\n]+investigations\.(?:[\n]+|(?:\\n)+)\-At[\s\n]+any[\s\n]+time\,[\s\n]+the[\s\n]+USG[\s\n]+may[\s\n]+inspect[\s\n]+and[\s\n]+seize[\s\n]+data[\s\n]+stored[\s\n]+on[\s\n]+this[\s\n]+IS\.(?:[\n]+|(?:\\n)+)\-Communications[\s\n]+using\,[\s\n]+or[\s\n]+data[\s\n]+stored[\s\n]+on\,[\s\n]+this[\s\n]+IS[\s\n]+are[\s\n]+not[\s\n]+private\,[\s\n]+are[\s\n]+subject[\s\n]+to[\s\n]+routine[\s\n]+monitoring\,[\s\n]+interception\,[\s\n]+and[\s\n]+search\,[\s\n]+and[\s\n]+may[\s\n]+be[\s\n]+disclosed[\s\n]+or[\s\n]+used[\s\n]+for[\s\n]+any[\s\n]+USG\-authorized[\s\n]+purpose\.(?:[\n]+|(?:\\n)+)\-This[\s\n]+IS[\s\n]+includes[\s\n]+security[\s\n]+measures[\s\n]+\(e\.g\.\,[\s\n]+authentication[\s\n]+and[\s\n]+access[\s\n]+controls\)[\s\n]+to[\s\n]+protect[\s\n]+USG[\s\n]+interests\-\-not[\s\n]+for[\s\n]+your[\s\n]+personal[\s\n]+benefit[\s\n]+or[\s\n]+privacy\.(?:[\n]+|(?:\\n)+)\-Notwithstanding[\s\n]+the[\s\n]+above\,[\s\n]+using[\s\n]+this[\s\n]+IS[\s\n]+does[\s\n]+not[\s\n]+constitute[\s\n]+consent[\s\n]+to[\s\n]+PM\,[\s\n]+LE[\s\n]+or[\s\n]+CI[\s\n]+investigative[\s\n]+searching[\s\n]+or[\s\n]+monitoring[\s\n]+of[\s\n]+the[\s\n]+content[\s\n]+of[\s\n]+privileged[\s\n]+communications\,[\s\n]+or[\s\n]+work[\s\n]+product\,[\s\n]+related[\s\n]+to[\s\n]+personal[\s\n]+representation[\s\n]+or[\s\n]+services[\s\n]+by[\s\n]+attorneys\,[\s\n]+psychotherapists\,[\s\n]+or[\s\n]+clergy\,[\s\n]+and[\s\n]+their[\s\n]+assistants\.[\s\n]+Such[\s\n]+communications[\s\n]+and[\s\n]+work[\s\n]+product[\s\n]+are[\s\n]+private[\s\n]+and[\s\n]+confidential\.[\s\n]+See[\s\n]+User[\s\n]+Agreement[\s\n]+for[\s\n]+details\.|I've[\s\n]+read[\s\n]+\&[\s\n]+consent[\s\n]+to[\s\n]+terms[\s\n]+in[\s\n]+IS[\s\n]+user[\s\n]+agreem't\.)$
      tags:
        - always
    
    - name: Modify the System Login Banner - ensure correct banner
      copy:
        dest: /etc/issue
        content: '{{ login_banner_text | regex_replace("^\^(.*)\$$", "\1") | regex_replace("^\((.*)\|.*\)$",
          "\1") | regex_replace("\[\\s\\n\]\+"," ") | regex_replace("\(\?:\[\\n\]\+\|\(\?:\\\\n\)\+\)",
          "\n") | regex_replace("\\", "") | wordwrap() }}'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27303-7
        - DISA-STIG-RHEL-07-010050
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(c)
        - banner_etc_issue
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
    

### Protect Accounts by Configuring PAM   [\[ref\]](#xccdf_org.ssgproject.content_group_accounts-pam)group

PAM, or Pluggable Authentication Modules, is a system which implements modular authentication for Linux programs. PAM provides a flexible and configurable architecture for authentication, and it should be configured to minimize exposure to unnecessary risk. This section contains guidance on how to accomplish that.  
  
PAM is implemented as a set of shared objects which are loaded and invoked whenever an application wishes to authenticate a user. Typically, the application must be running as root in order to take advantage of PAM, because PAM's modules often need to be able to access sensitive stores of account information, such as /etc/shadow. Traditional privileged network listeners (e.g. sshd) or SUID programs (e.g. sudo) already meet this requirement. An SUID root application, userhelper, is provided so that programs which are not SUID or privileged themselves can still take advantage of PAM.  
  
PAM looks in the directory `/etc/pam.d` for application-specific configuration information. For instance, if the program login attempts to authenticate a user, then PAM's libraries follow the instructions in the file `/etc/pam.d/login` to determine what actions should be taken.  
  
One very important file in `/etc/pam.d` is `/etc/pam.d/system-auth`. This file, which is included by many other PAM configuration files, defines 'default' system authentication measures. Modifying this file is a good way to make far-reaching authentication changes, for instance when implementing a centralized authentication service.

Warning:  Be careful when making changes to PAM's configuration files. The syntax for these files is complex, and modifications can have unexpected consequences. The default configurations shipped with applications should be sufficient for most users.

Warning:  Running `authconfig` or `system-config-authentication` will re-write the PAM configuration files, destroying any manually made changes and replacing them with a series of system defaults. One reference to the configuration file syntax can be found at [http://www.linux-pam.org/Linux-PAM-html/sag-configuration-file.html](http://www.linux-pam.org/Linux-PAM-html/sag-configuration-file.html).

contains 19 rules

### Set Lockouts for Failed Password Attempts   [\[ref\]](#xccdf_org.ssgproject.content_group_locking_out_password_attempts)group

The `pam_faillock` PAM module provides the capability to lock out user accounts after a number of failed login attempts. Its documentation is available in `/usr/share/doc/pam-VERSION/txts/README.pam_faillock`.  
  

Warning:  Locking out user accounts presents the risk of a denial-of-service attack. The lockout policy must weigh whether the risk of such a denial-of-service attack outweighs the benefits of thwarting password guessing attacks.

contains 5 rules

#### Limit Password Reuse   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_unix_remember)rule

Do not allow users to reuse recent passwords. This can be accomplished by using the `remember` option for the `pam_unix` or `pam_pwhistory` PAM modules.  
  
In the file `/etc/pam.d/system-auth`, append `remember=5` to the line which refers to the `pam_unix.so` or `pam_pwhistory.so`module, as shown below:

*   for the `pam_unix.so` case:
    
    password sufficient pam\_unix.so _...existing\_options..._ remember=5
    
*   for the `pam_pwhistory.so` case:
    
    password requisite pam\_pwhistory.so _...existing\_options..._ remember=5
    

The DoD STIG requirement is 5 passwords.

Rationale:

Preventing re-use of previous passwords helps ensure that a compromised password is not re-used by a user.

Severity:  medium

Identifiers:  CCE-82030-8

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.6.2.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.5.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000200](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(f)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(e)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.2.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000077-GPOS-00045](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000077-VMM-000440, [RHEL-07-010270](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204422r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.4.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_unix_remember="5"
    
    
    
    AUTH_FILES[0]="/etc/pam.d/system-auth"
    AUTH_FILES[1]="/etc/pam.d/password-auth"
    
    for pamFile in "${AUTH_FILES[@]}"
    do
    	if grep -q "remember=" $pamFile; then
    		sed -i --follow-symlinks "s/\(^password.*sufficient.*pam_unix.so.*\)\(\(remember *= *\)[^ $]*\)/\1remember=$var_password_pam_unix_remember/" $pamFile
    	else
    		sed -i --follow-symlinks "/^password[[:space:]]\+sufficient[[:space:]]\+pam_unix.so/ s/$/ remember=$var_password_pam_unix_remember/" $pamFile
    	fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Strategy:

configure

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82030-8
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010270
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
    - name: XCCDF Value var_password_pam_unix_remember # promote to variable
      set_fact:
        var_password_pam_unix_remember: !!str 5
      tags:
        - always
    
    - name: Do not allow users to reuse recent passwords - system-auth (change)
      replace:
        dest: /etc/pam.d/system-auth
        regexp: ^(password\s+sufficient\s+pam_unix\.so\s.*remember\s*=\s*)(\S+)(.*)$
        replace: \g<1>{{ var_password_pam_unix_remember }}\g<3>
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-82030-8
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010270
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Do not allow users to reuse recent passwords - system-auth (add)
      replace:
        dest: /etc/pam.d/system-auth
        regexp: ^password\s+sufficient\s+pam_unix\.so\s(?!.*remember\s*=\s*).*$
        replace: \g<0> remember={{ var_password_pam_unix_remember }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-82030-8
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010270
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
    

#### Set Deny For Failed Password Attempts   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_passwords_pam_faillock_deny)rule

To configure the system to lock out accounts after a number of incorrect login attempts using `pam_faillock.so`, modify the content of both `/etc/pam.d/system-auth` and `/etc/pam.d/password-auth` as follows:  
  

*   add the following line immediately `before` the `pam_unix.so` statement in the `AUTH` section:
    
    auth required pam\_faillock.so preauth silent deny=3 unlock\_time=0 fail\_interval=900
    
*   add the following line immediately `after` the `pam_unix.so` statement in the `AUTH` section:
    
    auth \[default=die\] pam\_faillock.so authfail deny=3 unlock\_time=0 fail\_interval=900
    
*   add the following line immediately `before` the `pam_unix.so` statement in the `ACCOUNT` section:
    
    account required pam\_faillock.so
    

Rationale:

Locking out user accounts after a number of incorrect attempts prevents direct password guessing attacks.

Severity:  medium

Identifiers:  CCE-27350-8

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5.5.3](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000044](https://public.cyber.mil/stigs/cci/), [CCI-002236](https://public.cyber.mil/stigs/cci/), [CCI-002237](https://public.cyber.mil/stigs/cci/), [CCI-002238](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_AFL.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.1.6](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000329-GPOS-00128](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000021-GPOS-00005](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000021-VMM-000050, [RHEL-07-010320](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204427r603824\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_accounts_passwords_pam_faillock_deny="3"
    
    
    
    AUTH_FILES=("/etc/pam.d/system-auth" "/etc/pam.d/password-auth")
    
    for pam_file in "${AUTH_FILES[@]}"
    do
        # is auth required pam_faillock.so preauth present?
        if grep -qE '^\s*auth\s+required\s+pam_faillock\.so\s+preauth.*$' "$pam_file" ; then
            # is the option set?
            if grep -qE '^\s*auth\s+required\s+pam_faillock\.so\s+preauth.*'"deny"'=([0-9]*).*$' "$pam_file" ; then
                # just change the value of option to a correct value
                sed -i --follow-symlinks 's/\(^auth.*required.*pam_faillock.so.*preauth.*silent.*\)\('"deny"' *= *\).*/\1\2'"$var_accounts_passwords_pam_faillock_deny"'/' "$pam_file"
            # the option is not set.
            else
                # append the option
                sed -i --follow-symlinks '/^auth.*required.*pam_faillock.so.*preauth.*silent.*/ s/$/ '"deny"'='"$var_accounts_passwords_pam_faillock_deny"'/' "$pam_file"
            fi
        # auth required pam_faillock.so preauth is not present, insert the whole line
        else
            sed -i --follow-symlinks '/^auth.*sufficient.*pam_unix.so.*/i auth        required      pam_faillock.so preauth silent '"deny"'='"$var_accounts_passwords_pam_faillock_deny" "$pam_file"
        fi
        # is auth default pam_faillock.so authfail present?
        if grep -qE '^\s*auth\s+(\[default=die\])\s+pam_faillock\.so\s+authfail.*$' "$pam_file" ; then
            # is the option set?
            if grep -qE '^\s*auth\s+(\[default=die\])\s+pam_faillock\.so\s+authfail.*'"deny"'=([0-9]*).*$' "$pam_file" ; then
                # just change the value of option to a correct value
                sed -i --follow-symlinks 's/\(^auth.*[default=die].*pam_faillock.so.*authfail.*\)\('"deny"' *= *\).*/\1\2'"$var_accounts_passwords_pam_faillock_deny"'/' "$pam_file"
            # the option is not set.
            else
                # append the option
                sed -i --follow-symlinks '/^auth.*[default=die].*pam_faillock.so.*authfail.*/ s/$/ '"deny"'='"$var_accounts_passwords_pam_faillock_deny"'/' "$pam_file"
            fi
        # auth default pam_faillock.so authfail is not present, insert the whole line
        else
            sed -i --follow-symlinks '/^auth.*sufficient.*pam_unix.so.*/a auth        [default=die] pam_faillock.so authfail '"deny"'='"$var_accounts_passwords_pam_faillock_deny" "$pam_file"
        fi
        if ! grep -qE '^\s*account\s+required\s+pam_faillock\.so.*$' "$pam_file" ; then
            sed -E -i --follow-symlinks '/^\s*account\s*required\s*pam_unix.so/i account     required      pam_faillock.so' "$pam_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27350-8
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_accounts_passwords_pam_faillock_deny # promote to variable
      set_fact:
        var_accounts_passwords_pam_faillock_deny: !!str 3
      tags:
        - always
    
    - name: Add auth pam_faillock preauth deny before pam_unix.so
      pamd:
        name: '{{ item }}'
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: required
        new_module_path: pam_faillock.so
        module_arguments: preauth silent deny={{ var_accounts_passwords_pam_faillock_deny
          }}
        state: before
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27350-8
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add deny argument to auth pam_faillock preauth
      pamd:
        name: '{{ item }}'
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: preauth silent deny={{ var_accounts_passwords_pam_faillock_deny
          }}
        state: args_present
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27350-8
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add auth pam_faillock authfail deny after pam_unix.so
      pamd:
        name: '{{ item }}'
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: '[default=die]'
        new_module_path: pam_faillock.so
        module_arguments: authfail deny={{ var_accounts_passwords_pam_faillock_deny }}
        state: after
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27350-8
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add deny argument to auth pam_faillock authfail
      pamd:
        name: '{{ item }}'
        type: auth
        new_type: auth
        control: '[default=die]'
        module_path: pam_faillock.so
        module_arguments: authfail deny={{ var_accounts_passwords_pam_faillock_deny }}
        state: args_present
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27350-8
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add account pam_faillock before pam_unix.so
      pamd:
        name: '{{ item }}'
        type: account
        control: required
        module_path: pam_unix.so
        new_type: account
        new_control: required
        new_module_path: pam_faillock.so
        state: before
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27350-8
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Configure the root Account for Failed Password Attempts   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_passwords_pam_faillock_deny_root)rule

To configure the system to lock out the `root` account after a number of incorrect login attempts using `pam_faillock.so`, modify the content of both `/etc/pam.d/system-auth` and `/etc/pam.d/password-auth` as follows:  
  

*   Modify the following line in the `AUTH` section to add `even_deny_root`:
    
    auth required pam\_faillock.so preauth silent **even\_deny\_root** deny=3 unlock\_time=0 fail\_interval=900
    
*   Modify the following line in the `AUTH` section to add `even_deny_root`:
    
    auth \[default=die\] pam\_faillock.so authfail **even\_deny\_root** deny=3 unlock\_time=0 fail\_interval=900
    

Rationale:

By limiting the number of failed logon attempts, the risk of unauthorized system access via user password guessing, otherwise known as brute-forcing, is reduced. Limits are imposed by locking the account.

Severity:  medium

Identifiers:  CCE-80353-6

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-002238](https://public.cyber.mil/stigs/cci/), [CCI-000044](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000329-GPOS-00128](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000021-GPOS-00005](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010330](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204428r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    AUTH_FILES[0]="/etc/pam.d/system-auth"
    AUTH_FILES[1]="/etc/pam.d/password-auth"
    
    # This script fixes absence of pam_faillock.so in PAM stack or the
    # absense of even_deny_root in pam_faillock.so arguments
    # When inserting auth pam_faillock.so entries,
    # the entry with preauth argument will be added before pam_unix.so module
    # and entry with authfail argument will be added before pam_deny.so module.
    
    # The placement of pam_faillock.so entries will not be changed
    # if they are already present
    
    for pamFile in "${AUTH_FILES[@]}"
    do
    	# if PAM file is missing, system is not using PAM or broken
    	if [ ! -f $pamFile ]; then
    		continue
    	fi
    
    	# is 'auth required' here?
    	if grep -q "^auth.*required.*pam_faillock.so.*" $pamFile; then
    		# has 'auth required' even_deny_root option?
    		if ! grep -q "^auth.*required.*pam_faillock.so.*preauth.*even_deny_root" $pamFile; then
    			# even_deny_root is not present
    			sed -i --follow-symlinks "s/\(^auth.*required.*pam_faillock.so.*preauth.*\).*/\1 even_deny_root/" $pamFile
    		fi
    	else
    		# no 'auth required', add it
    		sed -i --follow-symlinks "/^auth.*pam_unix.so.*/i auth required pam_faillock.so preauth silent even_deny_root" $pamFile
    	fi
    
    	# is 'auth [default=die]' here?
    	if grep -q "^auth.*\[default=die\].*pam_faillock.so.*" $pamFile; then
    		# has 'auth [default=die]' even_deny_root option?
    		if ! grep -q "^auth.*\[default=die\].*pam_faillock.so.*authfail.*even_deny_root" $pamFile; then
    			# even_deny_root is not present
    			sed -i --follow-symlinks "s/\(^auth.*\[default=die\].*pam_faillock.so.*authfail.*\).*/\1 even_deny_root/" $pamFile
    		fi
    	else
    		# no 'auth [default=die]', add it
    		sed -i --follow-symlinks "/^auth.*pam_unix.so.*/a auth [default=die] pam_faillock.so authfail silent even_deny_root" $pamFile
    	fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80353-6
        - DISA-STIG-RHEL-07-010330
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add auth pam_faillock preauth even_deny_root before pam_unix.so
      pamd:
        name: '{{ item }}'
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: required
        new_module_path: pam_faillock.so
        module_arguments: preauth silent even_deny_root
        state: before
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80353-6
        - DISA-STIG-RHEL-07-010330
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add even_deny_root argument to auth pam_faillock preauth
      pamd:
        name: '{{ item }}'
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: preauth silent even_deny_root
        state: args_present
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80353-6
        - DISA-STIG-RHEL-07-010330
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add auth pam_faillock authfail even_deny_root after pam_unix.so
      pamd:
        name: '{{ item }}'
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: '[default=die]'
        new_module_path: pam_faillock.so
        module_arguments: authfail even_deny_root
        state: after
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80353-6
        - DISA-STIG-RHEL-07-010330
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add even_deny_root argument to auth pam_faillock authfail
      pamd:
        name: '{{ item }}'
        type: auth
        control: '[default=die]'
        module_path: pam_faillock.so
        module_arguments: authfail even_deny_root
        state: args_present
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80353-6
        - DISA-STIG-RHEL-07-010330
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add account pam_faillock before pam_unix.so
      pamd:
        name: '{{ item }}'
        type: account
        control: required
        module_path: pam_unix.so
        new_type: account
        new_control: required
        new_module_path: pam_faillock.so
        state: before
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80353-6
        - DISA-STIG-RHEL-07-010330
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Set Interval For Counting Failed Password Attempts   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_passwords_pam_faillock_interval)rule

Utilizing `pam_faillock.so`, the `fail_interval` directive configures the system to lock out an account after a number of incorrect login attempts within a specified time period. Modify the content of both `/etc/pam.d/system-auth` and `/etc/pam.d/password-auth` as follows:  
  

*   Add the following line immediately `before` the `pam_unix.so` statement in the `AUTH` section:
    
    auth required pam\_faillock.so preauth silent deny=3 unlock\_time=0 fail\_interval=900
    
*   Add the following line immediately `after` the `pam_unix.so` statement in the `AUTH` section:
    
    auth \[default=die\] pam\_faillock.so authfail deny=3 unlock\_time=0 fail\_interval=900
    
*   Add the following line immediately `before` the `pam_unix.so` statement in the `ACCOUNT` section:
    
    account required pam\_faillock.so
    

Rationale:

By limiting the number of failed logon attempts the risk of unauthorized system access via user password guessing, otherwise known as brute-forcing, is reduced. Limits are imposed by locking the account.

Severity:  medium

Identifiers:  CCE-27297-1

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000044](https://public.cyber.mil/stigs/cci/), [CCI-002236](https://public.cyber.mil/stigs/cci/), [CCI-002237](https://public.cyber.mil/stigs/cci/), [CCI-002238](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_AFL.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000329-GPOS-00128](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000021-GPOS-00005](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000021-VMM-000050, [RHEL-07-010320](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204427r603824\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    # include our remediation functions library
    
    var_accounts_passwords_pam_faillock_fail_interval="900"
    
    
    
    AUTH_FILES=("/etc/pam.d/system-auth" "/etc/pam.d/password-auth")
    
    for pam_file in "${AUTH_FILES[@]}"
    do
        # is auth required pam_faillock.so preauth present?
        if grep -qE '^\s*auth\s+required\s+pam_faillock\.so\s+preauth.*$' "$pam_file" ; then
            # is the option set?
            if grep -qE '^\s*auth\s+required\s+pam_faillock\.so\s+preauth.*'"fail_interval"'=([0-9]*).*$' "$pam_file" ; then
                # just change the value of option to a correct value
                sed -i --follow-symlinks 's/\(^auth.*required.*pam_faillock.so.*preauth.*silent.*\)\('"fail_interval"' *= *\).*/\1\2'"$var_accounts_passwords_pam_faillock_fail_interval"'/' "$pam_file"
            # the option is not set.
            else
                # append the option
                sed -i --follow-symlinks '/^auth.*required.*pam_faillock.so.*preauth.*silent.*/ s/$/ '"fail_interval"'='"$var_accounts_passwords_pam_faillock_fail_interval"'/' "$pam_file"
            fi
        # auth required pam_faillock.so preauth is not present, insert the whole line
        else
            sed -i --follow-symlinks '/^auth.*sufficient.*pam_unix.so.*/i auth        required      pam_faillock.so preauth silent '"fail_interval"'='"$var_accounts_passwords_pam_faillock_fail_interval" "$pam_file"
        fi
        # is auth default pam_faillock.so authfail present?
        if grep -qE '^\s*auth\s+(\[default=die\])\s+pam_faillock\.so\s+authfail.*$' "$pam_file" ; then
            # is the option set?
            if grep -qE '^\s*auth\s+(\[default=die\])\s+pam_faillock\.so\s+authfail.*'"fail_interval"'=([0-9]*).*$' "$pam_file" ; then
                # just change the value of option to a correct value
                sed -i --follow-symlinks 's/\(^auth.*[default=die].*pam_faillock.so.*authfail.*\)\('"fail_interval"' *= *\).*/\1\2'"$var_accounts_passwords_pam_faillock_fail_interval"'/' "$pam_file"
            # the option is not set.
            else
                # append the option
                sed -i --follow-symlinks '/^auth.*[default=die].*pam_faillock.so.*authfail.*/ s/$/ '"fail_interval"'='"$var_accounts_passwords_pam_faillock_fail_interval"'/' "$pam_file"
            fi
        # auth default pam_faillock.so authfail is not present, insert the whole line
        else
            sed -i --follow-symlinks '/^auth.*sufficient.*pam_unix.so.*/a auth        [default=die] pam_faillock.so authfail '"fail_interval"'='"$var_accounts_passwords_pam_faillock_fail_interval" "$pam_file"
        fi
        if ! grep -qE '^\s*account\s+required\s+pam_faillock\.so.*$' "$pam_file" ; then
            sed -E -i --follow-symlinks '/^\s*account\s*required\s*pam_unix.so/i account     required      pam_faillock.so' "$pam_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27297-1
        - DISA-STIG-RHEL-07-010320
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_accounts_passwords_pam_faillock_fail_interval # promote to variable
      set_fact:
        var_accounts_passwords_pam_faillock_fail_interval: !!str 900
      tags:
        - always
    
    - name: Add auth pam_faillock preauth fail_interval before pam_unix.so
      pamd:
        name: '{{ item }}'
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: required
        new_module_path: pam_faillock.so
        module_arguments: preauth silent fail_interval={{ var_accounts_passwords_pam_faillock_fail_interval
          }}
        state: before
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27297-1
        - DISA-STIG-RHEL-07-010320
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add fail_interval argument to auth pam_faillock preauth
      pamd:
        name: '{{ item }}'
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: preauth silent fail_interval={{ var_accounts_passwords_pam_faillock_fail_interval
          }}
        state: args_present
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27297-1
        - DISA-STIG-RHEL-07-010320
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add auth pam_faillock aufthfail fail_interval after pam_unix.so
      pamd:
        name: '{{ item }}'
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: '[default=die]'
        new_module_path: pam_faillock.so
        module_arguments: authfail fail_interval={{ var_accounts_passwords_pam_faillock_fail_interval
          }}
        state: after
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27297-1
        - DISA-STIG-RHEL-07-010320
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add fail_interval argument to auth pam_faillock authfail
      pamd:
        name: '{{ item }}'
        type: auth
        control: '[default=die]'
        module_path: pam_faillock.so
        module_arguments: authfail fail_interval={{ var_accounts_passwords_pam_faillock_fail_interval
          }}
        state: args_present
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27297-1
        - DISA-STIG-RHEL-07-010320
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add account pam_faillock before pam_unix.so
      pamd:
        name: '{{ item }}'
        type: account
        control: required
        module_path: pam_unix.so
        new_type: account
        new_control: required
        new_module_path: pam_faillock.so
        state: before
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27297-1
        - DISA-STIG-RHEL-07-010320
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Set Lockout Time for Failed Password Attempts   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_passwords_pam_faillock_unlock_time)rule

To configure the system to lock out accounts after a number of incorrect login attempts and require an administrator to unlock the account using `pam_faillock.so`, modify the content of both `/etc/pam.d/system-auth` and `/etc/pam.d/password-auth` as follows:  
  

*   add the following line immediately `before` the `pam_unix.so` statement in the `AUTH` section:
    
    auth required pam\_faillock.so preauth silent deny=3 unlock\_time=0 fail\_interval=900
    
*   add the following line immediately `after` the `pam_unix.so` statement in the `AUTH` section:
    
    auth \[default=die\] pam\_faillock.so authfail deny=3 unlock\_time=0 fail\_interval=900
    
*   add the following line immediately `before` the `pam_unix.so` statement in the `ACCOUNT` section:
    
    account required pam\_faillock.so
    

If `unlock_time` is set to `0`, manual intervention by an administrator is required to unlock a user.

Rationale:

Locking out user accounts after a number of incorrect attempts prevents direct password guessing attacks. Ensuring that an administrator is involved in unlocking locked accounts draws appropriate attention to such situations.

Severity:  medium

Identifiers:  CCE-26884-7

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5.5.3](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000044](https://public.cyber.mil/stigs/cci/), [CCI-002236](https://public.cyber.mil/stigs/cci/), [CCI-002237](https://public.cyber.mil/stigs/cci/), [CCI-002238](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_AFL.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.1.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000329-GPOS-00128](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000021-GPOS-00005](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000329-VMM-001180, [RHEL-07-010320](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204427r603824\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_accounts_passwords_pam_faillock_unlock_time="0"
    
    
    
    AUTH_FILES=("/etc/pam.d/system-auth" "/etc/pam.d/password-auth")
    
    for pam_file in "${AUTH_FILES[@]}"
    do
        # is auth required pam_faillock.so preauth present?
        if grep -qE '^\s*auth\s+required\s+pam_faillock\.so\s+preauth.*$' "$pam_file" ; then
            # is the option set?
            if grep -qE '^\s*auth\s+required\s+pam_faillock\.so\s+preauth.*'"unlock_time"'=([0-9]*).*$' "$pam_file" ; then
                # just change the value of option to a correct value
                sed -i --follow-symlinks 's/\(^auth.*required.*pam_faillock.so.*preauth.*silent.*\)\('"unlock_time"' *= *\).*/\1\2'"$var_accounts_passwords_pam_faillock_unlock_time"'/' "$pam_file"
            # the option is not set.
            else
                # append the option
                sed -i --follow-symlinks '/^auth.*required.*pam_faillock.so.*preauth.*silent.*/ s/$/ '"unlock_time"'='"$var_accounts_passwords_pam_faillock_unlock_time"'/' "$pam_file"
            fi
        # auth required pam_faillock.so preauth is not present, insert the whole line
        else
            sed -i --follow-symlinks '/^auth.*sufficient.*pam_unix.so.*/i auth        required      pam_faillock.so preauth silent '"unlock_time"'='"$var_accounts_passwords_pam_faillock_unlock_time" "$pam_file"
        fi
        # is auth default pam_faillock.so authfail present?
        if grep -qE '^\s*auth\s+(\[default=die\])\s+pam_faillock\.so\s+authfail.*$' "$pam_file" ; then
            # is the option set?
            if grep -qE '^\s*auth\s+(\[default=die\])\s+pam_faillock\.so\s+authfail.*'"unlock_time"'=([0-9]*).*$' "$pam_file" ; then
                # just change the value of option to a correct value
                sed -i --follow-symlinks 's/\(^auth.*[default=die].*pam_faillock.so.*authfail.*\)\('"unlock_time"' *= *\).*/\1\2'"$var_accounts_passwords_pam_faillock_unlock_time"'/' "$pam_file"
            # the option is not set.
            else
                # append the option
                sed -i --follow-symlinks '/^auth.*[default=die].*pam_faillock.so.*authfail.*/ s/$/ '"unlock_time"'='"$var_accounts_passwords_pam_faillock_unlock_time"'/' "$pam_file"
            fi
        # auth default pam_faillock.so authfail is not present, insert the whole line
        else
            sed -i --follow-symlinks '/^auth.*sufficient.*pam_unix.so.*/a auth        [default=die] pam_faillock.so authfail '"unlock_time"'='"$var_accounts_passwords_pam_faillock_unlock_time" "$pam_file"
        fi
        if ! grep -qE '^\s*account\s+required\s+pam_faillock\.so.*$' "$pam_file" ; then
            sed -E -i --follow-symlinks '/^\s*account\s*required\s*pam_unix.so/i account     required      pam_faillock.so' "$pam_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-26884-7
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_accounts_passwords_pam_faillock_unlock_time # promote to variable
      set_fact:
        var_accounts_passwords_pam_faillock_unlock_time: !!str 0
      tags:
        - always
    
    - name: Add auth pam_faillock preauth unlock_time before pam_unix.so
      pamd:
        name: '{{ item }}'
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: required
        new_module_path: pam_faillock.so
        module_arguments: preauth silent unlock_time={{ var_accounts_passwords_pam_faillock_unlock_time
          }}
        state: before
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-26884-7
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add unlock_time argument to pam_faillock preauth
      pamd:
        name: '{{ item }}'
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: preauth silent unlock_time={{ var_accounts_passwords_pam_faillock_unlock_time
          }}
        state: args_present
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-26884-7
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add auth pam_faillock authfail unlock_interval after pam_unix.so
      pamd:
        name: '{{ item }}'
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: '[default=die]'
        new_module_path: pam_faillock.so
        module_arguments: authfail unlock_time={{ var_accounts_passwords_pam_faillock_unlock_time
          }}
        state: after
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-26884-7
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add unlock_time argument to auth pam_faillock authfail
      pamd:
        name: '{{ item }}'
        type: auth
        control: '[default=die]'
        module_path: pam_faillock.so
        module_arguments: authfail unlock_time={{ var_accounts_passwords_pam_faillock_unlock_time
          }}
        state: args_present
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-26884-7
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Add account pam_faillock before pam_unix.so
      pamd:
        name: '{{ item }}'
        type: account
        control: required
        module_path: pam_unix.so
        new_type: account
        new_control: required
        new_module_path: pam_faillock.so
        state: before
      loop:
        - system-auth
        - password-auth
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-26884-7
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010320
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

### Set Password Quality Requirements   [\[ref\]](#xccdf_org.ssgproject.content_group_password_quality)group

The default `pam_pwquality` PAM module provides strength checking for passwords. It performs a number of checks, such as making sure passwords are not similar to dictionary words, are of at least a certain length, are not the previous password reversed, and are not simply a change of case from the previous password. It can also require passwords to be in certain character classes. The `pam_pwquality` module is the preferred way of configuring password requirements.  
  
The man pages `pam_pwquality(8)` provide information on the capabilities and configuration of each.

contains 10 rules

### Set Password Quality Requirements with pam\_pwquality   [\[ref\]](#xccdf_org.ssgproject.content_group_password_quality_pwquality)group

The `pam_pwquality` PAM module can be configured to meet requirements for a variety of policies.  
  
For example, to configure `pam_pwquality` to require at least one uppercase character, lowercase character, digit, and other (special) character, make sure that `pam_pwquality` exists in `/etc/pam.d/system-auth`:

password    requisite     pam\_pwquality.so try\_first\_pass local\_users\_only retry=3 authtok\_type=

If no such line exists, add one as the first line of the password section in `/etc/pam.d/system-auth`. Next, modify the settings in `/etc/security/pwquality.conf` to match the following:

difok = 4
minlen = 14
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
maxrepeat = 3

The arguments can be modified to ensure compliance with your organization's security policy. Discussion of each parameter follows.

contains 10 rules

#### Ensure PAM Enforces Password Requirements - Minimum Digit Characters   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_dcredit)rule

The pam\_pwquality module's `dcredit` parameter controls requirements for usage of digits in a password. When set to a negative number, any password will be required to contain that many digits. When set to a positive number, pam\_pwquality will grant +1 additional length credit for each digit. Modify the `dcredit` setting in `/etc/security/pwquality.conf` to require the use of a digit in passwords.

Rationale:

Use of a complex password helps to increase the time and resources required to compromise the password. Password complexity, or strength, is a measure of the effectiveness of a password in resisting attempts at guessing and brute-force attacks.  
  
Password complexity is one factor of several that determines how long it takes to crack a password. The more complex the password, the greater the number of possible combinations that need to be tested before the password is compromised. Requiring digits makes password guessing attacks more difficult by ensuring a larger search space.

Severity:  medium

Identifiers:  CCE-27214-6

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000194](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.2.3](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000071-GPOS-00039](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000071-VMM-000380, [RHEL-07-010140](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204409r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_dcredit="-1"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/security/pwquality.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27214-6" ]; then
        cce="CCE"
    else
        cce="CCE-27214-6"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^dcredit")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_password_pam_dcredit"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^dcredit\\>" "/etc/security/pwquality.conf"; then
        "${sed_command[@]}" "s/^dcredit\\>.*/$formatted_output/gi" "/etc/security/pwquality.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/security/pwquality.conf" >> "/etc/security/pwquality.conf"
        printf '%s\n' "$formatted_output" >> "/etc/security/pwquality.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27214-6
        - DISA-STIG-RHEL-07-010140
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_dcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_password_pam_dcredit # promote to variable
      set_fact:
        var_password_pam_dcredit: !!str -1
      tags:
        - always
    
    - name: Ensure PAM variable dcredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*dcredit
        line: dcredit = {{ var_password_pam_dcredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27214-6
        - DISA-STIG-RHEL-07-010140
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_dcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure PAM Enforces Password Requirements - Minimum Different Characters   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_difok)rule

The pam\_pwquality module's `difok` parameter sets the number of characters in a password that must not be present in and old password during a password change.  
  
Modify the `difok` setting in `/etc/security/pwquality.conf` to equal 8 to require differing characters when changing passwords.

Rationale:

Use of a complex password helps to increase the time and resources required to compromise the password. Password complexity, or strength, is a measure of the effectiveness of a password in resisting attempts at guessing and brute–force attacks.  
  
Password complexity is one factor of several that determines how long it takes to crack a password. The more complex the password, the greater the number of possible combinations that need to be tested before the password is compromised.  
  
Requiring a minimum number of different characters during password changes ensures that newly changed passwords should not resemble previously compromised ones. Note that passwords which are changed on compromised systems will still be compromised, however.

Severity:  medium

Identifiers:  CCE-82020-9

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.6.2.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000195](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000072-GPOS-00040](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000072-VMM-000390, [RHEL-07-010160](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204411r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_difok="8"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/security/pwquality.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-82020-9" ]; then
        cce="CCE"
    else
        cce="CCE-82020-9"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^difok")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_password_pam_difok"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^difok\\>" "/etc/security/pwquality.conf"; then
        "${sed_command[@]}" "s/^difok\\>.*/$formatted_output/gi" "/etc/security/pwquality.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/security/pwquality.conf" >> "/etc/security/pwquality.conf"
        printf '%s\n' "$formatted_output" >> "/etc/security/pwquality.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82020-9
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010160
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(b)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_difok
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_password_pam_difok # promote to variable
      set_fact:
        var_password_pam_difok: !!str 8
      tags:
        - always
    
    - name: Ensure PAM variable difok is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*difok
        line: difok = {{ var_password_pam_difok }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-82020-9
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010160
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(b)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_difok
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure PAM Enforces Password Requirements - Minimum Lowercase Characters   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_lcredit)rule

The pam\_pwquality module's `lcredit` parameter controls requirements for usage of lowercase letters in a password. When set to a negative number, any password will be required to contain that many lowercase characters. When set to a positive number, pam\_pwquality will grant +1 additional length credit for each lowercase character. Modify the `lcredit` setting in `/etc/security/pwquality.conf` to require the use of a lowercase character in passwords.

Rationale:

Use of a complex password helps to increase the time and resources required to compromise the password. Password complexity, or strength, is a measure of the effectiveness of a password in resisting attempts at guessing and brute-force attacks.  
  
Password complexity is one factor of several that determines how long it takes to crack a password. The more complex the password, the greater the number of possble combinations that need to be tested before the password is compromised. Requiring a minimum number of lowercase characters makes password guessing attacks more difficult by ensuring a larger search space.

Severity:  medium

Identifiers:  CCE-27345-8

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000193](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.2.3](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000070-GPOS-00038](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000070-VMM-000370, [RHEL-07-010130](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204408r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_lcredit="-1"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/security/pwquality.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27345-8" ]; then
        cce="CCE"
    else
        cce="CCE-27345-8"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^lcredit")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_password_pam_lcredit"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^lcredit\\>" "/etc/security/pwquality.conf"; then
        "${sed_command[@]}" "s/^lcredit\\>.*/$formatted_output/gi" "/etc/security/pwquality.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/security/pwquality.conf" >> "/etc/security/pwquality.conf"
        printf '%s\n' "$formatted_output" >> "/etc/security/pwquality.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27345-8
        - DISA-STIG-RHEL-07-010130
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_lcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_password_pam_lcredit # promote to variable
      set_fact:
        var_password_pam_lcredit: !!str -1
      tags:
        - always
    
    - name: Ensure PAM variable lcredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*lcredit
        line: lcredit = {{ var_password_pam_lcredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27345-8
        - DISA-STIG-RHEL-07-010130
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_lcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure PAM Enforces Password Requirements - Maximum Consecutive Repeating Characters from Same Character Class   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_maxclassrepeat)rule

The pam\_pwquality module's `maxclassrepeat` parameter controls requirements for consecutive repeating characters from the same character class. When set to a positive number, it will reject passwords which contain more than that number of consecutive characters from the same character class. Modify the `maxclassrepeat` setting in `/etc/security/pwquality.conf` to equal 4 to prevent a run of (4 + 1) or more identical characters.

Rationale:

Use of a complex password helps to increase the time and resources required to comrpomise the password. Password complexity, or strength, is a measure of the effectiveness of a password in resisting attempts at guessing and brute-force attacks.  
Password complexity is one factor of several that determines how long it takes to crack a password. The more complex a password, the greater the number of possible combinations that need to be tested before the password is compromised.

Severity:  medium

Identifiers:  CCE-27512-3

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000195](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000072-GPOS-00040](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010190](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204414r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_maxclassrepeat="4"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/security/pwquality.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27512-3" ]; then
        cce="CCE"
    else
        cce="CCE-27512-3"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^maxclassrepeat")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_password_pam_maxclassrepeat"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^maxclassrepeat\\>" "/etc/security/pwquality.conf"; then
        "${sed_command[@]}" "s/^maxclassrepeat\\>.*/$formatted_output/gi" "/etc/security/pwquality.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/security/pwquality.conf" >> "/etc/security/pwquality.conf"
        printf '%s\n' "$formatted_output" >> "/etc/security/pwquality.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27512-3
        - DISA-STIG-RHEL-07-010190
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_maxclassrepeat
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_password_pam_maxclassrepeat # promote to variable
      set_fact:
        var_password_pam_maxclassrepeat: !!str 4
      tags:
        - always
    
    - name: Ensure PAM variable maxclassrepeat is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*maxclassrepeat
        line: maxclassrepeat = {{ var_password_pam_maxclassrepeat }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27512-3
        - DISA-STIG-RHEL-07-010190
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_maxclassrepeat
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Set Password Maximum Consecutive Repeating Characters   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_maxrepeat)rule

The pam\_pwquality module's `maxrepeat` parameter controls requirements for consecutive repeating characters. When set to a positive number, it will reject passwords which contain more than that number of consecutive characters. Modify the `maxrepeat` setting in `/etc/security/pwquality.conf` to equal 3 to prevent a run of (3 + 1) or more identical characters.

Rationale:

Use of a complex password helps to increase the time and resources required to compromise the password. Password complexity, or strength, is a measure of the effectiveness of a password in resisting attempts at guessing and brute-force attacks.  
  
Password complexity is one factor of several that determines how long it takes to crack a password. The more complex the password, the greater the number of possible combinations that need to be tested before the password is compromised.  
  
Passwords with excessive repeating characters may be more vulnerable to password-guessing attacks.

Severity:  medium

Identifiers:  CCE-82055-5

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000195](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000072-GPOS-00040](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010180](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204413r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_maxrepeat="3"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/security/pwquality.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-82055-5" ]; then
        cce="CCE"
    else
        cce="CCE-82055-5"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^maxrepeat")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_password_pam_maxrepeat"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^maxrepeat\\>" "/etc/security/pwquality.conf"; then
        "${sed_command[@]}" "s/^maxrepeat\\>.*/$formatted_output/gi" "/etc/security/pwquality.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/security/pwquality.conf" >> "/etc/security/pwquality.conf"
        printf '%s\n' "$formatted_output" >> "/etc/security/pwquality.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82055-5
        - DISA-STIG-RHEL-07-010180
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_maxrepeat
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_password_pam_maxrepeat # promote to variable
      set_fact:
        var_password_pam_maxrepeat: !!str 3
      tags:
        - always
    
    - name: Ensure PAM variable maxrepeat is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*maxrepeat
        line: maxrepeat = {{ var_password_pam_maxrepeat }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-82055-5
        - DISA-STIG-RHEL-07-010180
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_maxrepeat
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure PAM Enforces Password Requirements - Minimum Different Categories   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_minclass)rule

The pam\_pwquality module's `minclass` parameter controls requirements for usage of different character classes, or types, of character that must exist in a password before it is considered valid. For example, setting this value to three (3) requires that any password must have characters from at least three different categories in order to be approved. The default value is zero (0), meaning there are no required classes. There are four categories available:

\* Upper-case characters
\* Lower-case characters
\* Digits
\* Special characters (for example, punctuation)

Modify the `minclass` setting in `/etc/security/pwquality.conf` entry to require 4 differing categories of characters when changing passwords.

Rationale:

Use of a complex password helps to increase the time and resources required to compromise the password. Password complexity, or strength, is a measure of the effectiveness of a password in resisting attempts at guessing and brute-force attacks.  
  
Password complexity is one factor of several that determines how long it takes to crack a password. The more complex the password, the greater the number of possible combinations that need to be tested before the password is compromised.  
  
Requiring a minimum number of character categories makes password guessing attacks more difficult by ensuring a larger search space.

Severity:  medium

Identifiers:  CCE-82045-6

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000195](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000072-GPOS-00040](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010170](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204412r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_minclass="4"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/security/pwquality.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-82045-6" ]; then
        cce="CCE"
    else
        cce="CCE-82045-6"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^minclass")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_password_pam_minclass"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^minclass\\>" "/etc/security/pwquality.conf"; then
        "${sed_command[@]}" "s/^minclass\\>.*/$formatted_output/gi" "/etc/security/pwquality.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/security/pwquality.conf" >> "/etc/security/pwquality.conf"
        printf '%s\n' "$formatted_output" >> "/etc/security/pwquality.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82045-6
        - DISA-STIG-RHEL-07-010170
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_minclass
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_password_pam_minclass # promote to variable
      set_fact:
        var_password_pam_minclass: !!str 4
      tags:
        - always
    
    - name: Ensure PAM variable minclass is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*minclass
        line: minclass = {{ var_password_pam_minclass }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-82045-6
        - DISA-STIG-RHEL-07-010170
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_minclass
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure PAM Enforces Password Requirements - Minimum Length   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_minlen)rule

The pam\_pwquality module's `minlen` parameter controls requirements for minimum characters required in a password. Add `minlen=15` after pam\_pwquality to set minimum password length requirements.

Rationale:

The shorter the password, the lower the number of possible combinations that need to be tested before the password is compromised.  
Password complexity, or strength, is a measure of the effectiveness of a password in resisting attempts at guessing and brute-force attacks. Password length is one factor of several that helps to determine strength and how long it takes to crack a password. Use of more characters in a password helps to exponentially increase the time and/or resources required to compromose the password.

Severity:  medium

Identifiers:  CCE-27293-0

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.6.2.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000205](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.2.3](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000078-GPOS-00046](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000072-VMM-000390, SRG-OS-000078-VMM-000450, [RHEL-07-010280](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204423r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_minlen="15"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/security/pwquality.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27293-0" ]; then
        cce="CCE"
    else
        cce="CCE-27293-0"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^minlen")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_password_pam_minlen"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^minlen\\>" "/etc/security/pwquality.conf"; then
        "${sed_command[@]}" "s/^minlen\\>.*/$formatted_output/gi" "/etc/security/pwquality.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/security/pwquality.conf" >> "/etc/security/pwquality.conf"
        printf '%s\n' "$formatted_output" >> "/etc/security/pwquality.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27293-0
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010280
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_minlen
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_password_pam_minlen # promote to variable
      set_fact:
        var_password_pam_minlen: !!str 15
      tags:
        - always
    
    - name: Ensure PAM variable minlen is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*minlen
        line: minlen = {{ var_password_pam_minlen }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27293-0
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010280
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_minlen
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure PAM Enforces Password Requirements - Minimum Special Characters   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_ocredit)rule

The pam\_pwquality module's `ocredit=` parameter controls requirements for usage of special (or "other") characters in a password. When set to a negative number, any password will be required to contain that many special characters. When set to a positive number, pam\_pwquality will grant +1 additional length credit for each special character. Modify the `ocredit` setting in `/etc/security/pwquality.conf` to equal \-1 to require use of a special character in passwords.

Rationale:

Use of a complex password helps to increase the time and resources required to compromise the password. Password complexity, or strength, is a measure of the effectiveness of a password in resisting attempts at guessing and brute-force attacks.  
  
Password complexity is one factor of several that determines how long it takes to crack a password. The more complex the password, the greater the number of possble combinations that need to be tested before the password is compromised. Requiring a minimum number of special characters makes password guessing attacks more difficult by ensuring a larger search space.

Severity:  medium

Identifiers:  CCE-27360-7

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-001619](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000266-GPOS-00101](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000266-VMM-000940, [RHEL-07-010150](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204410r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_ocredit="-1"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/security/pwquality.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27360-7" ]; then
        cce="CCE"
    else
        cce="CCE-27360-7"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^ocredit")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_password_pam_ocredit"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^ocredit\\>" "/etc/security/pwquality.conf"; then
        "${sed_command[@]}" "s/^ocredit\\>.*/$formatted_output/gi" "/etc/security/pwquality.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/security/pwquality.conf" >> "/etc/security/pwquality.conf"
        printf '%s\n' "$formatted_output" >> "/etc/security/pwquality.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27360-7
        - DISA-STIG-RHEL-07-010150
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_ocredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_password_pam_ocredit # promote to variable
      set_fact:
        var_password_pam_ocredit: !!str -1
      tags:
        - always
    
    - name: Ensure PAM variable ocredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*ocredit
        line: ocredit = {{ var_password_pam_ocredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27360-7
        - DISA-STIG-RHEL-07-010150
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_ocredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure PAM Enforces Password Requirements - Authentication Retry Prompts Permitted Per-Session   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_retry)rule

To configure the number of retry prompts that are permitted per-session: Edit the `pam_pwquality.so` statement in `/etc/pam.d/system-auth` to show `retry=3`, or a lower value if site policy is more restrictive. The DoD requirement is a maximum of 3 prompts per session.

Rationale:

Setting the password retry prompts that are permitted on a per-session basis to a low value requires some software, such as SSH, to re-connect. This can slow down and draw additional attention to some types of password-guessing attacks. Note that this is different from account lockout, which is provided by the pam\_faillock module.

Severity:  medium

Identifiers:  CCE-27160-1

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.5.3](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000192](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00225](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000069-GPOS-00037](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010119](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204406r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_retry="3"
    
    
    
    if grep -q "retry=" /etc/pam.d/system-auth ; then
    	sed -i --follow-symlinks "s/\(retry *= *\).*/\1$var_password_pam_retry/" /etc/pam.d/system-auth
    else
    	sed -i --follow-symlinks "/pam_pwquality.so/ s/$/ retry=$var_password_pam_retry/" /etc/pam.d/system-auth
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Strategy:

configure

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27160-1
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010119
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(4)
        - accounts_password_pam_retry
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
    - name: XCCDF Value var_password_pam_retry # promote to variable
      set_fact:
        var_password_pam_retry: !!str 3
      tags:
        - always
    
    - name: Set Password Retry Prompts Permitted Per-Session - system-auth (change)
      replace:
        dest: /etc/pam.d/system-auth
        regexp: (^.*\spam_pwquality.so\s.*retry\s*=\s*)(\S+)(.*$)
        replace: \g<1>{{ var_password_pam_retry }}\g<3>
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27160-1
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010119
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(4)
        - accounts_password_pam_retry
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Set Password Retry Prompts Permitted Per-Session - system-auth (add)
      replace:
        dest: /etc/pam.d/system-auth
        regexp: ^.*\spam_pwquality.so\s(?!.*retry\s*=\s*).*$
        replace: \g<0> retry={{ var_password_pam_retry }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27160-1
        - CJIS-5.5.3
        - DISA-STIG-RHEL-07-010119
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(4)
        - accounts_password_pam_retry
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
    

#### Ensure PAM Enforces Password Requirements - Minimum Uppercase Characters   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_pam_ucredit)rule

The pam\_pwquality module's `ucredit=` parameter controls requirements for usage of uppercase letters in a password. When set to a negative number, any password will be required to contain that many uppercase characters. When set to a positive number, pam\_pwquality will grant +1 additional length credit for each uppercase character. Modify the `ucredit` setting in `/etc/security/pwquality.conf` to require the use of an uppercase character in passwords.

Rationale:

Use of a complex password helps to increase the time and resources reuiqred to compromise the password. Password complexity, or strength, is a measure of the effectiveness of a password in resisting attempts at guessing and brute-force attacks.  
  
Password complexity is one factor of several that determines how long it takes to crack a password. The more complex the password, the greater the number of possible combinations that need to be tested before the password is compromised.

Severity:  medium

Identifiers:  CCE-27200-5

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000192](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.2.3](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000069-GPOS-00037](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000069-VMM-000360, [RHEL-07-010120](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204407r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_password_pam_ucredit="-1"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/security/pwquality.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27200-5" ]; then
        cce="CCE"
    else
        cce="CCE-27200-5"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^ucredit")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_password_pam_ucredit"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^ucredit\\>" "/etc/security/pwquality.conf"; then
        "${sed_command[@]}" "s/^ucredit\\>.*/$formatted_output/gi" "/etc/security/pwquality.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/security/pwquality.conf" >> "/etc/security/pwquality.conf"
        printf '%s\n' "$formatted_output" >> "/etc/security/pwquality.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27200-5
        - DISA-STIG-RHEL-07-010120
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_ucredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_password_pam_ucredit # promote to variable
      set_fact:
        var_password_pam_ucredit: !!str -1
      tags:
        - always
    
    - name: Ensure PAM variable ucredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*ucredit
        line: ucredit = {{ var_password_pam_ucredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27200-5
        - DISA-STIG-RHEL-07-010120
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_ucredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

### Set Password Hashing Algorithm   [\[ref\]](#xccdf_org.ssgproject.content_group_set_password_hashing_algorithm)group

The system's default algorithm for storing password hashes in `/etc/shadow` is SHA-512. This can be configured in several locations.

contains 3 rules

#### Set Password Hashing Algorithm in /etc/libuser.conf   [\[ref\]](#xccdf_org.ssgproject.content_rule_set_password_hashing_algorithm_libuserconf)rule

In `/etc/libuser.conf`, add or correct the following line in its `[defaults]` section to ensure the system will use the SHA-512 algorithm for password hashing:

crypt\_style = sha512

Rationale:

Passwords need to be protected at all times, and encryption is the standard method for protecting passwords. If passwords are not encrypted, they can be plainly read (i.e., clear text) and easily compromised. Passwords that are encrypted with a weak algorithm are no more protected than if they are kepy in plain text.  
  
This setting ensures user and group account administration utilities are configured to store only encrypted representations of passwords. Additionally, the `crypt_style` configuration option ensures the use of a strong hashing algorithm that makes password cracking attacks more difficult.

Severity:  medium

Identifiers:  CCE-82038-1

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.6.2.2](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.13.11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000196](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0418, 1055, 1402, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.2.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000073-GPOS-00041](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-010220](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204417r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q libuser; then
    
    LIBUSER_CONF="/etc/libuser.conf"
    CRYPT_STYLE_REGEX='[[:space:]]*\[defaults](.*(\n)+)+?[[:space:]]*crypt_style[[:space:]]*'
    
    # Try find crypt_style in [defaults] section. If it is here, then change algorithm to sha512.
    # If it isn't here, then add it to [defaults] section.
    if grep -qzosP $CRYPT_STYLE_REGEX $LIBUSER_CONF ; then
            sed -i "s/\(crypt_style[[:space:]]*=[[:space:]]*\).*/\1sha512/g" $LIBUSER_CONF
    elif grep -qs "\[defaults]" $LIBUSER_CONF ; then
            sed -i "/[[:space:]]*\[defaults]/a crypt_style = sha512" $LIBUSER_CONF
    else
            echo -e "[defaults]\ncrypt_style = sha512" >> $LIBUSER_CONF
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82038-1
        - CJIS-5.6.2.2
        - DISA-STIG-RHEL-07-010220
        - NIST-800-171-3.13.11
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(c)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.1
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - set_password_hashing_algorithm_libuserconf
    
    - name: Set Password Hashing Algorithm in /etc/libuser.conf
      lineinfile:
        dest: /etc/libuser.conf
        insertafter: ^\s*\[defaults]
        regexp: ^#?crypt_style
        line: crypt_style = sha512
        state: present
        create: true
      when: '"libuser" in ansible_facts.packages'
      tags:
        - CCE-82038-1
        - CJIS-5.6.2.2
        - DISA-STIG-RHEL-07-010220
        - NIST-800-171-3.13.11
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(c)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.1
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - set_password_hashing_algorithm_libuserconf
    

#### Set Password Hashing Algorithm in /etc/login.defs   [\[ref\]](#xccdf_org.ssgproject.content_rule_set_password_hashing_algorithm_logindefs)rule

In `/etc/login.defs`, add or correct the following line to ensure the system will use SHA-512 as the hashing algorithm:

ENCRYPT\_METHOD SHA512

Rationale:

Passwords need to be protected at all times, and encryption is the standard method for protecting passwords. If passwords are not encrypted, they can be plainly read (i.e., clear text) and easily compromised. Passwords that are encrypted with a weak algorithm are no more protected than if they are kept in plain text.  
  
Using a stronger hashing algorithm makes password cracking attacks more difficult.

Severity:  medium

Identifiers:  CCE-82050-6

References:  [BP28(R32)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.6.2.2](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.13.11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000196](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0418, 1055, 1402, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.2.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000073-GPOS-00041](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204416r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q shadow-utils; then
    
    
    var_password_hashing_algorithm="SHA512"
    
    
    
    if grep --silent ^ENCRYPT_METHOD /etc/login.defs ; then
    	sed -i "s/^ENCRYPT_METHOD .*/ENCRYPT_METHOD $var_password_hashing_algorithm/g" /etc/login.defs
    else
    	echo "" >> /etc/login.defs
    	echo "ENCRYPT_METHOD $var_password_hashing_algorithm" >> /etc/login.defs
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82050-6
        - CJIS-5.6.2.2
        - DISA-STIG-RHEL-07-010210
        - NIST-800-171-3.13.11
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(c)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.1
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - set_password_hashing_algorithm_logindefs
    - name: XCCDF Value var_password_hashing_algorithm # promote to variable
      set_fact:
        var_password_hashing_algorithm: !!str SHA512
      tags:
        - always
    
    - name: Set Password Hashing Algorithm in /etc/login.defs
      lineinfile:
        dest: /etc/login.defs
        regexp: ^#?ENCRYPT_METHOD
        line: ENCRYPT_METHOD {{ var_password_hashing_algorithm }}
        state: present
        create: true
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
        - CCE-82050-6
        - CJIS-5.6.2.2
        - DISA-STIG-RHEL-07-010210
        - NIST-800-171-3.13.11
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(c)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.1
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - set_password_hashing_algorithm_logindefs
    

#### Set PAM's Password Hashing Algorithm   [\[ref\]](#xccdf_org.ssgproject.content_rule_set_password_hashing_algorithm_systemauth)rule

The PAM system service can be configured to only store encrypted representations of passwords. In `/etc/pam.d/system-auth`, the `password` section of the file controls which PAM modules execute during a password change. Set the `pam_unix.so` module in the `password` section to include the argument `sha512`, as shown below:  

password    sufficient    pam\_unix.so sha512 _other arguments..._

  
This will help ensure when local users change their passwords, hashes for the new passwords will be generated using the SHA-512 algorithm. This is the default.

Rationale:

Passwords need to be protected at all times, and encryption is the standard method for protecting passwords. If passwords are not encrypted, they can be plainly read (i.e., clear text) and easily compromised. Passwords that are encrypted with a weak algorithm are no more protected than if they are kepy in plain text.  
  
This setting ensures user and group account administration utilities are configured to store only encrypted representations of passwords. Additionally, the `crypt_style` configuration option ensures the use of a strong hashing algorithm that makes password cracking attacks more difficult.

Severity:  medium

Identifiers:  CCE-82043-1

References:  [BP28(R32)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.6.2.2](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.13.11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000196](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0418, 1055, 1402, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.2.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000073-GPOS-00041](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-010200](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204415r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.4.3](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    AUTH_FILES[0]="/etc/pam.d/system-auth"
    AUTH_FILES[1]="/etc/pam.d/password-auth"
    
    for pamFile in "${AUTH_FILES[@]}"
    do
    	if ! grep -q "^password.*sufficient.*pam_unix.so.*sha512" $pamFile; then
    		sed -i --follow-symlinks "/^password.*sufficient.*pam_unix.so/ s/$/ sha512/" $pamFile
    	fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

#### Ensure PAM Displays Last Logon/Access Notification   [\[ref\]](#xccdf_org.ssgproject.content_rule_display_login_attempts)rule

To configure the system to notify users of last logon/access using `pam_lastlog`, add or correct the `pam_lastlog` settings in `/etc/pam.d/postlogin` to read as follows:

session     required pam\_lastlog.so showfailed

And make sure that the `silent` option is not set.

Rationale:

Users need to be aware of activity that occurs regarding their account. Providing users with information regarding the number of unsuccessful attempts that were made to login to their account allows the user to determine if any unauthorized activity has occurred and gives them an opportunity to notify administrators.

Severity:  low

Identifiers:  CCE-27275-7

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5.5.2](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0582, 0584, 05885, 0586, 0846, 0957, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [AC-9(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-10.2.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040530](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204605r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    if [ -e "/etc/pam.d/postlogin" ] ; then
        valueRegex="" defaultValue=""
        # non-empty values need to be preceded by an equals sign
        [ -n "${valueRegex}" ] && valueRegex="=${valueRegex}"
        # add an equals sign to non-empty values
        [ -n "${defaultValue}" ] && defaultValue="=${defaultValue}"
    
        # fix 'type' if it's wrong
        if grep -q -P "^\\s*(?"'!'"session\\s)[[:alnum:]]+\\s+[[:alnum:]]+\\s+pam_lastlog.so" < "/etc/pam.d/postlogin" ; then
            sed --follow-symlinks -i -E -e "s/^(\\s*)[[:alnum:]]+(\\s+[[:alnum:]]+\\s+pam_lastlog.so)/\\1session\\2/" "/etc/pam.d/postlogin"
        fi
    
        # fix 'control' if it's wrong
        if grep -q -P "^\\s*session\\s+(?"'!'"required)[[:alnum:]]+\\s+pam_lastlog.so" < "/etc/pam.d/postlogin" ; then
            sed --follow-symlinks -i -E -e "s/^(\\s*session\\s+)[[:alnum:]]+(\\s+pam_lastlog.so)/\\1required\\2/" "/etc/pam.d/postlogin"
        fi
    
        # fix the value for 'option' if one exists but does not match 'valueRegex'
        if grep -q -P "^\\s*session\\s+required\\s+pam_lastlog.so(\\s.+)?\\s+showfailed(?"'!'"${valueRegex}(\\s|\$))" < "/etc/pam.d/postlogin" ; then
            sed --follow-symlinks -i -E -e "s/^(\\s*session\\s+required\\s+pam_lastlog.so(\\s.+)?\\s)showfailed=[^[:space:]]*/\\1showfailed${defaultValue}/" "/etc/pam.d/postlogin"
    
        # add 'option=default' if option is not set
        elif grep -q -E "^\\s*session\\s+required\\s+pam_lastlog.so" < "/etc/pam.d/postlogin" &&
                grep    -E "^\\s*session\\s+required\\s+pam_lastlog.so" < "/etc/pam.d/postlogin" | grep -q -E -v "\\sshowfailed(=|\\s|\$)" ; then
    
            sed --follow-symlinks -i -E -e "s/^(\\s*session\\s+required\\s+pam_lastlog.so[^\\n]*)/\\1 showfailed${defaultValue}/" "/etc/pam.d/postlogin"
        # add a new entry if none exists
        elif ! grep -q -P "^\\s*session\\s+required\\s+pam_lastlog.so(\\s.+)?\\s+showfailed${valueRegex}(\\s|\$)" < "/etc/pam.d/postlogin" ; then
            echo "session required pam_lastlog.so showfailed${defaultValue}" >> "/etc/pam.d/postlogin"
        fi
    else
        echo "/etc/pam.d/postlogin doesn't exist" >&2
    fi
    
    # remove 'silent' option
    sed -i --follow-symlinks -E -e 's/^([^#]+pam_lastlog\.so[^#]*)\ssilent/\1/' '/etc/pam.d/postlogin'
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27275-7
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-040530
        - NIST-800-53-AC-9(1)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.4
        - configure_strategy
        - display_login_attempts
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
    
    - name: Check if pam_lastlog.so is set
      lineinfile:
        path: /etc/pam.d/postlogin
        regexp: ^\s*(session)(\s+)[^\s]+(\s+)(pam_lastlog\.so)(\s+)(.*)
        state: absent
      check_mode: true
      changed_when: false
      register: pam_lastlog_exists
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27275-7
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-040530
        - NIST-800-53-AC-9(1)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.4
        - configure_strategy
        - display_login_attempts
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
    
    - name: Make sure pam_lastlog.so control is required
      replace:
        path: /etc/pam.d/postlogin
        regexp: ^\s*(session)(\s+)[^\s]+(\s+)(pam_lastlog\.so)(\s+)(.*)
        replace: \1\2required\3\4\5\6
      register: control_update_result
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-27275-7
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-040530
        - NIST-800-53-AC-9(1)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.4
        - configure_strategy
        - display_login_attempts
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
    
    - name: Add control for pam_lastlog.so module
      lineinfile:
        path: /etc/pam.d/postlogin
        line: session required pam_lastlog.so showfailed
      when:
        - '"pam" in ansible_facts.packages'
        - not pam_lastlog_exists.found
      register: add_new_pam_lastlog_control_result
      tags:
        - CCE-27275-7
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-040530
        - NIST-800-53-AC-9(1)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.4
        - configure_strategy
        - display_login_attempts
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
    
    - name: Add 'showfailed' arg to pam_lastlog.so module
      pamd:
        name: postlogin
        type: session
        control: required
        module_path: pam_lastlog.so
        module_arguments: showfailed
        state: args_present
      when:
        - '"pam" in ansible_facts.packages'
        - not add_new_pam_lastlog_control_result.changed
      tags:
        - CCE-27275-7
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-040530
        - NIST-800-53-AC-9(1)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.4
        - configure_strategy
        - display_login_attempts
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
    
    - name: Remove 'silent' arg for pam_lastlog.so module
      pamd:
        name: postlogin
        type: session
        control: required
        module_path: pam_lastlog.so
        module_arguments: silent
        state: args_absent
      when:
        - '"pam" in ansible_facts.packages'
        - not add_new_pam_lastlog_control_result.changed
      tags:
        - CCE-27275-7
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-040530
        - NIST-800-53-AC-9(1)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.4
        - configure_strategy
        - display_login_attempts
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
    

### Protect Physical Console Access   [\[ref\]](#xccdf_org.ssgproject.content_group_accounts-physical)group

It is impossible to fully protect a system from an attacker with physical access, so securing the space in which the system is located should be considered a necessary step. However, there are some steps which, if taken, make it more difficult for an attacker to quickly or undetectably modify a system from its console.

contains 5 rules

### Configure Screen Locking   [\[ref\]](#xccdf_org.ssgproject.content_group_screen_locking)group

When a user must temporarily leave an account logged-in, screen locking should be employed to prevent passersby from abusing the account. User education and training is particularly important for screen locking to be effective, and policies can be implemented to reinforce this.  
  
Automatic screen locking is only meant as a safeguard for those cases where a user forgot to lock the screen.

contains 3 rules

### Hardware Tokens for Authentication   [\[ref\]](#xccdf_org.ssgproject.content_group_smart_card_login)group

The use of hardware tokens such as smart cards for system login provides stronger, two-factor authentication than using a username and password. In Red Hat Enterprise Linux servers and workstations, hardware token login is not enabled by default and must be enabled in the system settings.

contains 3 rules

#### Install Smart Card Packages For Multifactor Authentication   [\[ref\]](#xccdf_org.ssgproject.content_rule_install_smartcard_packages)rule

Configure the operating system to implement multifactor authentication by installing the required package with the following command: The `pam_pkcs11` package can be installed with the following command:

$ sudo yum install pam\_pkcs11

Rationale:

Using an authentication device, such as a CAC or token that is separate from the information system, ensures that even if the information system is compromised, that compromise will not affect credentials stored on the authentication device.  
  
Multifactor solutions that require devices separate from information systems gaining access include, for example, hardware tokens providing time-based or challenge-response authenticators and smart cards such as the U.S. Government Personal Identity Verification card and the DoD Common Access Card.

Severity:  medium

Identifiers:  CCE-80519-2

References:  [CCI-000765](https://public.cyber.mil/stigs/cci/), [CCI-001948](https://public.cyber.mil/stigs/cci/), [CCI-001953](https://public.cyber.mil/stigs/cci/), [CCI-001954](https://public.cyber.mil/stigs/cci/), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000105-GPOS-00052](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000375-GPOS-00160](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000375-GPOS-00161](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000377-GPOS-00162](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-041001](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204631r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if ! rpm -q --quiet "pam_pkcs11" ; then
        yum install -y "pam_pkcs11"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    include install_pam_pkcs11
    
    class install_pam_pkcs11 {
      package { 'pam_pkcs11':
        ensure => 'installed',
      }
    }
    

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    
    package --add=pam_pkcs11
    

Remediation script:   (show)  
  

    
    [[packages]]
    name = "pam_pkcs11"
    version = "*"
    

#### Enable Smart Card Login   [\[ref\]](#xccdf_org.ssgproject.content_rule_smartcard_auth)rule

To enable smart card authentication, consult the documentation at:

*   **[https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/7/html/system-level\_authentication\_guide/smartcards#authconfig-smartcards](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/smartcards#authconfig-smartcards)**

For guidance on enabling SSH to authenticate against a Common Access Card (CAC), consult documentation at:

*   **[https://access.redhat.com/solutions/82273](https://access.redhat.com/solutions/82273)**

Rationale:

Smart card login provides two-factor authentication stronger than that provided by a username and password combination. Smart cards leverage PKI (public key infrastructure) in order to provide and verify credentials.

Severity:  medium

Identifiers:  CCE-80207-4

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000764](https://public.cyber.mil/stigs/cci/), [CCI-000765](https://public.cyber.mil/stigs/cci/), [CCI-000766](https://public.cyber.mil/stigs/cci/), [CCI-000767](https://public.cyber.mil/stigs/cci/), [CCI-000768](https://public.cyber.mil/stigs/cci/), [CCI-000770](https://public.cyber.mil/stigs/cci/), [CCI-000771](https://public.cyber.mil/stigs/cci/), [CCI-000772](https://public.cyber.mil/stigs/cci/), [CCI-000884](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-2(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(6)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(7)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(11)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.3](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000104-GPOS-00051](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000106-GPOS-00053](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000107-GPOS-00054](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000108-GPOS-00055](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000108-GPOS-00057](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000108-GPOS-00058](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000109-GPOS-00056](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000376-GPOS-00161](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000377-GPOS-00162](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010500](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204441r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Install required packages
    if ! rpm -q --quiet "esc" ; then
        yum install -y "esc"
    fi
    if ! rpm -q --quiet "pam_pkcs11" ; then
        yum install -y "pam_pkcs11"
    fi
    
    # Enable pcscd.socket systemd activation socket
    /usr/bin/systemctl enable "pcscd.socket"
    /usr/bin/systemctl start "pcscd.socket"
    # The service may not be running because it has been started and failed,
    # so let's reset the state so OVAL checks pass.
    # Service should be 'inactive', not 'failed' after reboot though.
    /usr/bin/systemctl reset-failed "pcscd.socket"
    
    # Configure the expected /etc/pam.d/system-auth{,-ac} settings directly
    #
    # The code below will configure system authentication in the way smart card
    # logins will be enabled, but also user login(s) via other method to be allowed
    #
    # NOTE: It is not possible to use the 'authconfig' command to perform the
    #       remediation for us, because call of 'authconfig' would discard changes
    #       for other remediations (see RH BZ#1357019 for details)
    #
    #	Therefore we need to configure the necessary settings directly.
    #
    
    # Define system-auth config location
    SYSTEM_AUTH_CONF="/etc/pam.d/system-auth"
    # Define expected 'pam_env.so' row in $SYSTEM_AUTH_CONF
    PAM_ENV_SO="auth.*required.*pam_env.so"
    
    # Define 'pam_succeed_if.so' row to be appended past $PAM_ENV_SO row into $SYSTEM_AUTH_CONF
    SYSTEM_AUTH_PAM_SUCCEED="\
    auth        [success=1 default=ignore] pam_succeed_if.so service notin \
    login:gdm:xdm:kdm:xscreensaver:gnome-screensaver:kscreensaver quiet use_uid"
    # Define 'pam_pkcs11.so' row to be appended past $SYSTEM_AUTH_PAM_SUCCEED
    # row into SYSTEM_AUTH_CONF file
    SYSTEM_AUTH_PAM_PKCS11="\
    auth        [success=done authinfo_unavail=ignore ignore=ignore default=die] \
    pam_pkcs11.so nodebug"
    
    # Define smartcard-auth config location
    SMARTCARD_AUTH_CONF="/etc/pam.d/smartcard-auth"
    # Define 'pam_pkcs11.so' auth section to be appended past $PAM_ENV_SO into $SMARTCARD_AUTH_CONF
    SMARTCARD_AUTH_SECTION="\
    auth        [success=done ignore=ignore default=die] pam_pkcs11.so nodebug wait_for_card"
    # Define expected 'pam_permit.so' row in $SMARTCARD_AUTH_CONF
    PAM_PERMIT_SO="account.*required.*pam_permit.so"
    # Define 'pam_pkcs11.so' password section
    SMARTCARD_PASSWORD_SECTION="\
    password    required      pam_pkcs11.so"
    
    # First Correct the SYSTEM_AUTH_CONF configuration
    if ! grep -q 'pam_pkcs11.so' "$SYSTEM_AUTH_CONF"
    then
    	# Append (expected) pam_succeed_if.so row past the pam_env.so into SYSTEM_AUTH_CONF file
    	# and append (expected) pam_pkcs11.so row right after the pam_succeed_if.so we just added
    	# in SYSTEM_AUTH_CONF file
    	# This will preserve any other already existing row equal to "$SYSTEM_AUTH_PAM_SUCCEED"
    	echo "$(awk '/^'"$PAM_ENV_SO"'/{print $0 RS "'"$SYSTEM_AUTH_PAM_SUCCEED"'" RS "'"$SYSTEM_AUTH_PAM_PKCS11"'";next}1' "$SYSTEM_AUTH_CONF")" > "$SYSTEM_AUTH_CONF"
    fi
    
    # Then also correct the SMARTCARD_AUTH_CONF
    if ! grep -q 'pam_pkcs11.so' "$SMARTCARD_AUTH_CONF"
    then
    	# Append (expected) SMARTCARD_AUTH_SECTION row past the pam_env.so into SMARTCARD_AUTH_CONF file
    	sed -i --follow-symlinks -e '/^'"$PAM_ENV_SO"'/a '"$SMARTCARD_AUTH_SECTION" "$SMARTCARD_AUTH_CONF"
    	# Append (expected) SMARTCARD_PASSWORD_SECTION row past the pam_permit.so into SMARTCARD_AUTH_CONF file
    	sed -i --follow-symlinks -e '/^'"$PAM_PERMIT_SO"'/a '"$SMARTCARD_PASSWORD_SECTION" "$SMARTCARD_AUTH_CONF"
    fi
    
    # Perform /etc/pam_pkcs11/pam_pkcs11.conf settings below
    # Define selected constants for later reuse
    SP="[:space:]"
    PAM_PKCS11_CONF="/etc/pam_pkcs11/pam_pkcs11.conf"
    
    # Ensure OCSP is turned on in $PAM_PKCS11_CONF
    # 1) First replace any occurrence of 'none' value of 'cert_policy' key setting with the correct configuration
    sed -i "s/^[$SP]*cert_policy[$SP]\+=[$SP]\+none;/\t\tcert_policy = ca, ocsp_on, signature;/g" "$PAM_PKCS11_CONF"
    # 2) Then append 'ocsp_on' value setting to each 'cert_policy' key in $PAM_PKCS11_CONF configuration line,
    # which does not contain it yet
    sed -i "/ocsp_on/! s/^[$SP]*cert_policy[$SP]\+=[$SP]\+\(.*\);/\t\tcert_policy = \1, ocsp_on;/" "$PAM_PKCS11_CONF"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Anaconda snippet:   (show)  
  

    
    package --add=pam_pkcs11 --add=esc
    

#### Configure Smart Card Certificate Status Checking   [\[ref\]](#xccdf_org.ssgproject.content_rule_smartcard_configure_cert_checking)rule

Configure the operating system to do certificate status checking for PKI authentication. Modify all of the `cert_policy` lines in `/etc/pam_pkcs11/pam_pkcs11.conf` to include `ocsp_on` like so:

cert\_policy = ca, ocsp\_on, signature;

Rationale:

Using an authentication device, such as a CAC or token that is separate from the information system, ensures that even if the information system is compromised, that compromise will not affect credentials stored on the authentication device.  
  
Multifactor solutions that require devices separate from information systems gaining access include, for example, hardware tokens providing time-based or challenge-response authenticators and smart cards such as the U.S. Government Personal Identity Verification card and the DoD Common Access Card.

Severity:  medium

Identifiers:  CCE-80520-0

References:  [CCI-001948](https://public.cyber.mil/stigs/cci/), [CCI-001953](https://public.cyber.mil/stigs/cci/), [CCI-001954](https://public.cyber.mil/stigs/cci/), [SRG-OS-000375-GPOS-00160](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000376-GPOS-00161](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000377-GPOS-00162](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000384-GPOS-00167](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-041003](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204633r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Install required packages
    if ! rpm --quiet -q pam_pkcs11; then yum -y -d 1 install pam_pkcs11; fi
    
    if grep "^\s*cert_policy" /etc/pam_pkcs11/pam_pkcs11.conf | grep -qv "ocsp_on"; then
    	sed -i "/^\s*#/! s/cert_policy.*/cert_policy = ca, ocsp_on, signature;/g" /etc/pam_pkcs11/pam_pkcs11.conf
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

#### Disable Ctrl-Alt-Del Reboot Activation   [\[ref\]](#xccdf_org.ssgproject.content_rule_disable_ctrlaltdel_reboot)rule

By default, `SystemD` will reboot the system if the `Ctrl-Alt-Del` key sequence is pressed.  
  
To configure the system to ignore the `Ctrl-Alt-Del` key sequence from the command line instead of rebooting the system, do either of the following:

ln -sf /dev/null /etc/systemd/system/ctrl-alt-del.target

or

systemctl mask ctrl-alt-del.target

  
  
Do not simply delete the `/usr/lib/systemd/system/ctrl-alt-del.service` file, as this file may be restored during future system updates.

Rationale:

A locally logged-in user who presses Ctrl-Alt-Del, when at the console, can reboot the system. If accidentally pressed, as could happen in the case of mixed OS environment, this can create the risk of short-term loss of availability of systems due to unintentional reboot.

Severity:  high

Identifiers:  CCE-27511-5

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.4.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(B)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000324-GPOS-00125](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020230](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204455r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    systemctl disable --now ctrl-alt-del.target
    systemctl mask --now ctrl-alt-del.target
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    - name: Disable Ctrl-Alt-Del Reboot Activation
      systemd:
        name: ctrl-alt-del.target
        masked: true
        state: stopped
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27511-5
        - DISA-STIG-RHEL-07-020230
        - NIST-800-171-3.4.5
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - disable_ctrlaltdel_reboot
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
    

Remediation script:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        systemd:
          units:
          - name: ctrl-alt-del.target
            mask: true
    

#### Require Authentication for Single User Mode   [\[ref\]](#xccdf_org.ssgproject.content_rule_require_singleuser_auth)rule

Single-user mode is intended as a system recovery method, providing a single user root access to the system by providing a boot option at startup. By default, no authentication is performed if single-user mode is selected.  
  
By default, single-user mode is protected by requiring a password and is set in `/usr/lib/systemd/system/rescue.service`.

Rationale:

This prevents attackers with physical access from trivially bypassing security on the machine and gaining root access. Such accesses are further prevented by configuring the bootloader password.

Severity:  medium

Identifiers:  CCE-27287-2

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.4.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000213](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(B)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [IA-2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-3](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000080-GPOS-00048](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010481](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204437r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.4.3](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    service_file="/usr/lib/systemd/system/rescue.service"
    
    sulogin='/bin/sh -c "/sbin/sulogin; /usr/bin/systemctl --fail --no-block default"'
    
    if grep "^ExecStart=.*" "$service_file" ; then
        sed -i "s%^ExecStart=.*%ExecStart=-$sulogin%" "$service_file"
    else
        echo "ExecStart=-$sulogin" >> "$service_file"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: require single user mode password
      lineinfile:
        create: true
        dest: /usr/lib/systemd/system/rescue.service
        regexp: ^#?ExecStart=
        line: ExecStart=-/bin/sh -c "/sbin/sulogin; /usr/bin/systemctl --fail --no-block
          default"
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27287-2
        - DISA-STIG-RHEL-07-010481
        - NIST-800-171-3.1.1
        - NIST-800-171-3.4.5
        - NIST-800-53-AC-3
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-2
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - require_singleuser_auth
        - restrict_strategy
    

### Protect Accounts by Restricting Password-Based Login   [\[ref\]](#xccdf_org.ssgproject.content_group_accounts-restrictions)group

Conventionally, Unix shell accounts are accessed by providing a username and password to a login program, which tests these values for correctness using the `/etc/passwd` and `/etc/shadow` files. Password-based login is vulnerable to guessing of weak passwords, and to sniffing and man-in-the-middle attacks against passwords entered over a network or at an insecure console. Therefore, mechanisms for accessing accounts by entering usernames and passwords should be restricted to those which are operationally necessary.

contains 9 rules

### Set Account Expiration Parameters   [\[ref\]](#xccdf_org.ssgproject.content_group_account_expiration)group

Accounts can be configured to be automatically disabled after a certain time period, meaning that they will require administrator interaction to become usable again. Expiration of accounts after inactivity can be set for all accounts by default and also on a per-account basis, such as for accounts that are known to be temporary. To configure automatic expiration of an account following the expiration of its password (that is, after the password has expired and not been changed), run the following command, substituting `_NUM_DAYS_` and `_USER_` appropriately:

$ sudo chage -I _NUM\_DAYS USER_

Accounts, such as temporary accounts, can also be configured to expire on an explicitly-set date with the `-E` option. The file `/etc/default/useradd` controls default settings for all newly-created accounts created with the system's normal command line utilities.

Warning:  This will only apply to newly created accounts

contains 1 rule

#### Set Account Expiration Following Inactivity   [\[ref\]](#xccdf_org.ssgproject.content_rule_account_disable_post_pw_expiration)rule

To specify the number of days after a password expires (which signifies inactivity) until an account is permanently disabled, add or correct the following line in `/etc/default/useradd`:

INACTIVE=_0_

If a password is currently on the verge of expiration, then `0` day(s) remain(s) until the account is automatically disabled. However, if the password will not expire for another 60 days, then 60 days plus `0` day(s) could elapse until the account would be automatically disabled. See the `useradd` man page for more information.

Rationale:

Disabling inactive accounts ensures that accounts which may not have been responsibly removed are not available to attackers who may have compromised their credentials.

Severity:  medium

Identifiers:  CCE-27355-7

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [5.6.2.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.5.6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000017](https://public.cyber.mil/stigs/cci/), [CCI-000795](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [IA-4(e)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-2(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.1.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000118-GPOS-00060](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000003-VMM-000030, SRG-OS-000118-VMM-000590, [RHEL-07-010310](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204426r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.5.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q shadow-utils; then
    
    
    var_account_disable_post_pw_expiration="0"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/default/useradd"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27355-7" ]; then
        cce="CCE"
    else
        cce="CCE-27355-7"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^INACTIVE")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s=%s" "$stripped_key" "$var_account_disable_post_pw_expiration"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^INACTIVE\\>" "/etc/default/useradd"; then
        "${sed_command[@]}" "s/^INACTIVE\\>.*/$formatted_output/gi" "/etc/default/useradd"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/default/useradd" >> "/etc/default/useradd"
        printf '%s\n' "$formatted_output" >> "/etc/default/useradd"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27355-7
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010310
        - NIST-800-171-3.5.6
        - NIST-800-53-AC-2(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-4(e)
        - PCI-DSS-Req-8.1.4
        - account_disable_post_pw_expiration
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_account_disable_post_pw_expiration # promote to variable
      set_fact:
        var_account_disable_post_pw_expiration: !!str 0
      tags:
        - always
    
    - name: Set Account Expiration Following Inactivity
      lineinfile:
        create: true
        dest: /etc/default/useradd
        regexp: ^INACTIVE
        line: INACTIVE={{ var_account_disable_post_pw_expiration }}
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
        - CCE-27355-7
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010310
        - NIST-800-171-3.5.6
        - NIST-800-53-AC-2(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-4(e)
        - PCI-DSS-Req-8.1.4
        - account_disable_post_pw_expiration
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

### Set Password Expiration Parameters   [\[ref\]](#xccdf_org.ssgproject.content_group_password_expiration)group

The file `/etc/login.defs` controls several password-related settings. Programs such as `passwd`, `su`, and `login` consult `/etc/login.defs` to determine behavior with regard to password aging, expiration warnings, and length. See the man page `login.defs(5)` for more information.  
  
Users should be forced to change their passwords, in order to decrease the utility of compromised passwords. However, the need to change passwords often should be balanced against the risk that users will reuse or write down passwords if forced to change them too often. Forcing password changes every 90-360 days, depending on the environment, is recommended. Set the appropriate value as `PASS_MAX_DAYS` and apply it to existing accounts with the `-M` flag.  
  
The `PASS_MIN_DAYS` (`-m`) setting prevents password changes for 7 days after the first change, to discourage password cycling. If you use this setting, train users to contact an administrator for an emergency password change in case a new password becomes compromised. The `PASS_WARN_AGE` (`-W`) setting gives users 7 days of warnings at login time that their passwords are about to expire.  
  
For example, for each existing human user _USER_, expiration parameters could be adjusted to a 180 day maximum password age, 7 day minimum password age, and 7 day warning period with the following command:

$ sudo chage -M 180 -m 7 -W 7 USER

contains 4 rules

#### Set Password Maximum Age   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_maximum_age_login_defs)rule

To specify password maximum age for new accounts, edit the file `/etc/login.defs` and add or correct the following line:

PASS\_MAX\_DAYS 60

A value of 180 days is sufficient for many environments. The DoD requirement is 60. The profile requirement is `60`.

Rationale:

Any password, no matter how complex, can eventually be cracked. Therefore, passwords need to be changed periodically. If the operating system does not limit the lifetime of passwords and force users to change their passwords, there is the risk that the operating system passwords could be compromised.  
  
Setting the password maximum age ensures users are required to periodically change their passwords. Requiring shorter password lifetimes increases the risk of users writing down the password in a convenient location subject to physical compromise.

Severity:  medium

Identifiers:  CCE-27051-2

References:  [BP28(R18)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.6.2.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.5.6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000199](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0418, 1055, 1402, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(f)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.2.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000076-GPOS-00044](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010250](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204420r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.5.1.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q shadow-utils; then
    
    
    var_accounts_maximum_age_login_defs="60"
    
    
    
    grep -q ^PASS_MAX_DAYS /etc/login.defs && \
      sed -i "s/PASS_MAX_DAYS.*/PASS_MAX_DAYS     $var_accounts_maximum_age_login_defs/g" /etc/login.defs
    if ! [ $? -eq 0 ]; then
        echo "PASS_MAX_DAYS      $var_accounts_maximum_age_login_defs" >> /etc/login.defs
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27051-2
        - CJIS-5.6.2.1
        - DISA-STIG-RHEL-07-010250
        - NIST-800-171-3.5.6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(d)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.4
        - accounts_maximum_age_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_accounts_maximum_age_login_defs # promote to variable
      set_fact:
        var_accounts_maximum_age_login_defs: !!str 60
      tags:
        - always
    
    - name: Set Password Maximum Age
      lineinfile:
        create: true
        dest: /etc/login.defs
        regexp: ^#?PASS_MAX_DAYS
        line: PASS_MAX_DAYS {{ var_accounts_maximum_age_login_defs }}
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
        - CCE-27051-2
        - CJIS-5.6.2.1
        - DISA-STIG-RHEL-07-010250
        - NIST-800-171-3.5.6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(d)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.4
        - accounts_maximum_age_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Set Password Minimum Age   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_minimum_age_login_defs)rule

To specify password minimum age for new accounts, edit the file `/etc/login.defs` and add or correct the following line:

PASS\_MIN\_DAYS 1

A value of 1 day is considered sufficient for many environments. The DoD requirement is 1. The profile requirement is `1`.

Rationale:

Enforcing a minimum password lifetime helps to prevent repeated password changes to defeat the password reuse or history enforcement requirement. If users are allowed to immediately and continually change their password, then the password could be repeatedly changed in a short period of time to defeat the organization's policy regarding password reuse.  
  
Setting the minimum password age protects against users cycling back to a favorite password after satisfying the password reuse requirement.

Severity:  medium

Identifiers:  CCE-82036-5

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.6.2.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.5.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000198](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0418, 1055, 1402, [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(f)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000075-GPOS-00043](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010230](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204418r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.5.1.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q shadow-utils; then
    
    
    var_accounts_minimum_age_login_defs="1"
    
    
    
    grep -q ^PASS_MIN_DAYS /etc/login.defs && \
      sed -i "s/PASS_MIN_DAYS.*/PASS_MIN_DAYS     $var_accounts_minimum_age_login_defs/g" /etc/login.defs
    if ! [ $? -eq 0 ]; then
        echo "PASS_MIN_DAYS      $var_accounts_minimum_age_login_defs" >> /etc/login.defs
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82036-5
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010230
        - NIST-800-171-3.5.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(d)
        - NIST-800-53-IA-5(f)
        - accounts_minimum_age_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_accounts_minimum_age_login_defs # promote to variable
      set_fact:
        var_accounts_minimum_age_login_defs: !!str 1
      tags:
        - always
    
    - name: Set Password Minimum Age
      lineinfile:
        create: true
        dest: /etc/login.defs
        regexp: ^#?PASS_MIN_DAYS
        line: PASS_MIN_DAYS {{ var_accounts_minimum_age_login_defs }}
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
        - CCE-82036-5
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-07-010230
        - NIST-800-171-3.5.8
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(d)
        - NIST-800-53-IA-5(f)
        - accounts_minimum_age_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Set Existing Passwords Maximum Age   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_set_max_life_existing)rule

Configure non-compliant accounts to enforce a 60-day maximum password lifetime restriction by running the following command:

$ sudo chage -M 60 _USER_

Rationale:

Any password, no matter how complex, can eventually be cracked. Therefore, passwords need to be changed periodically. If the operating system does not limit the lifetime of passwords and force users to change their passwords, there is the risk that the operating system passwords could be compromised.

Severity:  medium

Identifiers:  CCE-80522-6

References:  [CCI-000199](https://public.cyber.mil/stigs/cci/), [IA-5(f)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000076-GPOS-00044](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000076-VMM-000430, [RHEL-07-010260](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204421r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Set Existing Passwords Minimum Age   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_password_set_min_life_existing)rule

Configure non-compliant accounts to enforce a 24 hours/1 day minimum password lifetime by running the following command:

$ sudo chage -m 1 _USER_

Rationale:

Enforcing a minimum password lifetime helps to prevent repeated password changes to defeat the password reuse or history enforcement requirement. If users are allowed to immediately and continually change their password, the password could be repeatedly changed in a short period of time to defeat the organization's policy regarding password reuse.

Severity:  medium

Identifiers:  CCE-80521-8

References:  [CCI-000198](https://public.cyber.mil/stigs/cci/), [IA-5(f)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000075-GPOS-00043](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000075-VMM000420, [RHEL-07-010240](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204419r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### Verify Proper Storage and Existence of Password Hashes   [\[ref\]](#xccdf_org.ssgproject.content_group_password_storage)group

By default, password hashes for local accounts are stored in the second field (colon-separated) in `/etc/shadow`. This file should be readable only by processes running with root credentials, preventing users from casually accessing others' password hashes and attempting to crack them. However, it remains possible to misconfigure the system and store password hashes in world-readable files such as `/etc/passwd`, or to even store passwords themselves in plaintext on the system. Using system-provided tools for password change/creation should allow administrators to avoid such misconfiguration.

contains 2 rules

#### All GIDs referenced in /etc/passwd must be defined in /etc/group   [\[ref\]](#xccdf_org.ssgproject.content_rule_gid_passwd_group_same)rule

Add a group to the system for each GID referenced without a corresponding group.

Rationale:

If a user is assigned the Group Identifier (GID) of a group not existing on the system, and a group with the Gruop Identifier (GID) is subsequently created, the user may have unintended rights to any files associated with the group.

Severity:  low

Identifiers:  CCE-27503-2

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.5.2](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000764](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [IA-2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.5.a](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000104-GPOS-00051](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020300](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204461r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [6.2.3](https://www.cisecurity.org/benchmark/red_hat_linux/)

#### Prevent Login to Accounts With Empty Password   [\[ref\]](#xccdf_org.ssgproject.content_rule_no_empty_passwords)rule

If an account is configured for password authentication but does not have an assigned password, it may be possible to log into the account without authentication. Remove any instances of the `nullok` in `/etc/pam.d/system-auth` to prevent logins with empty passwords. Note that this rule is not applicable for systems running within a container. Having user with empty password within a container is not considered a risk, because it should not be possible to directly login into a container anyway.

Rationale:

If an account has an empty password, anyone could log in and run commands with the privileges of that account. Accounts with empty passwords should never be used in operational environments.

Severity:  high

Identifiers:  CCE-27286-4

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.5.2](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.1.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(B)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [IA-5(1)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-8.2.3](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010290](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204424r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    sed --follow-symlinks -i 's/\<nullok\>//g' /etc/pam.d/system-auth
    sed --follow-symlinks -i 's/\<nullok\>//g' /etc/pam.d/password-auth
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Strategy:

configure

    - name: Prevent Log In to Accounts With Empty Password - system-auth
      replace:
        dest: /etc/pam.d/system-auth
        regexp: nullok
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27286-4
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-010290
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - configure_strategy
        - high_severity
        - low_complexity
        - medium_disruption
        - no_empty_passwords
        - no_reboot_needed
    
    - name: Prevent Log In to Accounts With Empty Password - password-auth
      replace:
        dest: /etc/pam.d/password-auth
        regexp: nullok
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27286-4
        - CJIS-5.5.2
        - DISA-STIG-RHEL-07-010290
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - configure_strategy
        - high_severity
        - low_complexity
        - medium_disruption
        - no_empty_passwords
        - no_reboot_needed
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,%23%20Generated%20by%20authselect%20on%20Sat%20Oct%2027%2014%3A59%3A36%202018%0A%23%20Do%20not%20modify%20this%20file%20manually.%0A%0Aauth%20%20%20%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_env.so%0Aauth%20%20%20%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_faildelay.so%20delay%3D2000000%0Aauth%20%20%20%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_fprintd.so%0Aauth%20%20%20%20%20%20%20%20%5Bdefault%3D1%20ignore%3Dignore%20success%3Dok%5D%20%20%20%20%20%20%20%20%20pam_succeed_if.so%20uid%20%3E%3D%201000%20quiet%0Aauth%20%20%20%20%20%20%20%20%5Bdefault%3D1%20ignore%3Dignore%20success%3Dok%5D%20%20%20%20%20%20%20%20%20pam_localuser.so%0Aauth%20%20%20%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_unix.so%20try_first_pass%0Aauth%20%20%20%20%20%20%20%20requisite%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_succeed_if.so%20uid%20%3E%3D%201000%20quiet_success%0Aauth%20%20%20%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_sss.so%20forward_pass%0Aauth%20%20%20%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_deny.so%0A%0Aaccount%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_unix.so%0Aaccount%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_localuser.so%0Aaccount%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_succeed_if.so%20uid%20%3C%201000%20quiet%0Aaccount%20%20%20%20%20%5Bdefault%3Dbad%20success%3Dok%20user_unknown%3Dignore%5D%20pam_sss.so%0Aaccount%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_permit.so%0A%0Apassword%20%20%20%20requisite%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_pwquality.so%20try_first_pass%20local_users_only%0Apassword%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_unix.so%20sha512%20shadow%20try_first_pass%20use_authtok%0Apassword%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_sss.so%20use_authtok%0Apassword%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_deny.so%0A%0Asession%20%20%20%20%20optional%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_keyinit.so%20revoke%0Asession%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_limits.so%0A-session%20%20%20%20optional%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_systemd.so%0Asession%20%20%20%20%20%5Bsuccess%3D1%20default%3Dignore%5D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_succeed_if.so%20service%20in%20crond%20quiet%20use_uid%0Asession%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_unix.so%0Asession%20%20%20%20%20optional%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_sss.so%0A
            mode: 0644
            path: /etc/pam.d/password-auth
            overwrite: true
          - contents:
              source: data:,%23%20Generated%20by%20authselect%20on%20Sat%20Oct%2027%2014%3A59%3A36%202018%0A%23%20Do%20not%20modify%20this%20file%20manually.%0A%0Aauth%20%20%20%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_env.so%0Aauth%20%20%20%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_faildelay.so%20delay%3D2000000%0Aauth%20%20%20%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_fprintd.so%0Aauth%20%20%20%20%20%20%20%20%5Bdefault%3D1%20ignore%3Dignore%20success%3Dok%5D%20%20%20%20%20%20%20%20%20pam_succeed_if.so%20uid%20%3E%3D%201000%20quiet%0Aauth%20%20%20%20%20%20%20%20%5Bdefault%3D1%20ignore%3Dignore%20success%3Dok%5D%20%20%20%20%20%20%20%20%20pam_localuser.so%0Aauth%20%20%20%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_unix.so%20try_first_pass%0Aauth%20%20%20%20%20%20%20%20requisite%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_succeed_if.so%20uid%20%3E%3D%201000%20quiet_success%0Aauth%20%20%20%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_sss.so%20forward_pass%0Aauth%20%20%20%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_deny.so%0A%0Aaccount%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_unix.so%0Aaccount%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_localuser.so%0Aaccount%20%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_succeed_if.so%20uid%20%3C%201000%20quiet%0Aaccount%20%20%20%20%20%5Bdefault%3Dbad%20success%3Dok%20user_unknown%3Dignore%5D%20pam_sss.so%0Aaccount%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_permit.so%0A%0Apassword%20%20%20%20requisite%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_pwquality.so%20try_first_pass%20local_users_only%0Apassword%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_unix.so%20sha512%20shadow%20try_first_pass%20use_authtok%0Apassword%20%20%20%20sufficient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_sss.so%20use_authtok%0Apassword%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_deny.so%0A%0Asession%20%20%20%20%20optional%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_keyinit.so%20revoke%0Asession%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_limits.so%0A-session%20%20%20%20optional%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_systemd.so%0Asession%20%20%20%20%20%5Bsuccess%3D1%20default%3Dignore%5D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_succeed_if.so%20service%20in%20crond%20quiet%20use_uid%0Asession%20%20%20%20%20required%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_unix.so%0Asession%20%20%20%20%20optional%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pam_sss.so%0A
            mode: 0644
            path: /etc/pam.d/system-auth
            overwrite: true
    

### Restrict Root Logins   [\[ref\]](#xccdf_org.ssgproject.content_group_root_logins)group

Direct root logins should be allowed only for emergency use. In normal situations, the administrator should access the system via a unique unprivileged account, and then use `su` or `sudo` to execute privileged commands. Discouraging administrators from accessing the root account directly ensures an audit trail in organizations with multiple administrators. Locking down the channels through which root can connect directly also reduces opportunities for password-guessing against the root account. The `login` program uses the file `/etc/securetty` to determine which interfaces should allow root logins. The virtual devices `/dev/console` and `/dev/tty*` represent the system consoles (accessible via the Ctrl-Alt-F1 through Ctrl-Alt-F6 keyboard sequences on a default installation). The default securetty file also contains `/dev/vc/*`. These are likely to be deprecated in most environments, but may be retained for compatibility. Root should also be prohibited from connecting via network protocols. Other sections of this document include guidance describing how to prevent root from logging in via SSH.

contains 1 rule

#### Verify Only Root Has UID 0   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_no_uid_except_zero)rule

If any account other than root has a UID of 0, this misconfiguration should be investigated and the accounts other than root should be removed or have their UID changed.  
If the account is associated with system commands or applications the UID should be changed to one greater than "0" but less than "1000." Otherwise assign a UID greater than "1000" that has not already been assigned.

Rationale:

An account has root authority if it has a UID of 0. Multiple accounts with a UID of 0 afford more opportunity for potential intruders to guess a password for a privileged account. Proper configuration of sudo is recommended to afford multiple system administrators access to root privileges in an accountable manner.

Severity:  high

Identifiers:  CCE-82054-8

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.1.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [IA-2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-4(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020310](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204462r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [6.2.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    awk -F: '$3 == 0 && $1 != "root" { print $1 }' /etc/passwd | xargs --max-lines=1 passwd -l
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: get all /etc/passwd file entries
      getent:
        database: passwd
        split: ':'
      tags:
        - CCE-82054-8
        - DISA-STIG-RHEL-07-020310
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - NIST-800-53-AC-6(5)
        - NIST-800-53-IA-2
        - NIST-800-53-IA-4(b)
        - accounts_no_uid_except_zero
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - restrict_strategy
    
    - name: lock the password of the user accounts other than root with uid 0
      command: passwd -l {{ item.key }}
      loop: '{{ getent_passwd | dict2items | rejectattr(''key'', ''search'', ''root'')
        | list }}'
      when: item.value.1  == '0'
      tags:
        - CCE-82054-8
        - DISA-STIG-RHEL-07-020310
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - NIST-800-53-AC-6(5)
        - NIST-800-53-IA-2
        - NIST-800-53-IA-4(b)
        - accounts_no_uid_except_zero
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - restrict_strategy
    

#### Only Authorized Local User Accounts Exist on Operating System   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_authorized_local_users)rule

Enterprise Application tends to use the server or virtual machine exclusively. Besides the default operating system user, there should be only authorized local users required by the installed softoware groups and applications that exist on the operating system. The authorized user list can be customized in the refine value variable `var_accounts_authorized_local_users_regex`. OVAL regular expression is used for the user list. Configure the system so all accounts on the system are assigned to an active system, application, or user account. Remove accounts that do not support approved system activities or that allow for a normal user to perform administrative-level actions. To remove unauthorized system accounts, use the following command:

$ sudo userdel _unauthorized\_user_

Warning:  Automatic remediation of this control is not available. Due the unique requirements of each system.

Rationale:

Accounts providing no operational purpose provide additional opportunities for system compromise. Unnecessary accounts include user accounts for individuals not requiring access to the system and application accounts for applications not installed on the system.

Severity:  medium

Identifiers:  CCE-88380-1

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020270](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204460r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### Secure Session Configuration Files for Login Accounts   [\[ref\]](#xccdf_org.ssgproject.content_group_accounts-session)group

When a user logs into a Unix account, the system configures the user's session by reading a number of files. Many of these files are located in the user's home directory, and may have weak permissions as a result of user error or misconfiguration. If an attacker can modify or even read certain types of account configuration information, they can often gain full access to the affected user's account. Therefore, it is important to test and correct configuration file permissions for interactive accounts, particularly those of privileged users such as root or system administrators.

contains 18 rules

### Ensure that Users Have Sensible Umask Values   [\[ref\]](#xccdf_org.ssgproject.content_group_user_umask)group

The umask setting controls the default permissions for the creation of new files. With a default `umask` setting of 077, files and directories created by users will not be readable by any other user on the system. Users who wish to make specific files group- or world-readable can accomplish this by using the chmod command. Additionally, users can make all their files readable to their group by default by setting a `umask` of 027 in their shell configuration files. If default per-user groups exist (that is, if every user has a default group whose name is the same as that user's username and whose only member is the user), then it may even be safe for users to select a `umask` of 007, making it very easy to intentionally share files with groups of which the user is a member.  
  

contains 2 rules

#### Ensure the Default Umask is Set Correctly in login.defs   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_umask_etc_login_defs)rule

To ensure the default umask controlled by `/etc/login.defs` is set properly, add or correct the `UMASK` setting in `/etc/login.defs` to read as follows:

UMASK 077

Rationale:

The umask value influences the permissions assigned to files when they are created. A misconfigured umask value could result in files with excessive permissions that can be read and written to by unauthorized users.

Severity:  medium

Identifiers:  CCE-80205-8

References:  [BP28(R35)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.01](https://www.isaca.org/resources/cobit), [BAI03.02](https://www.isaca.org/resources/cobit), [BAI03.03](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.1.1](https://www.iso.org/standard/54534.html), [A.14.2.1](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.14.2.5](https://www.iso.org/standard/54534.html), [A.6.1.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00228](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020240](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204457r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.5.5](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q shadow-utils; then
    
    
    var_accounts_user_umask="077"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/login.defs"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80205-8" ]; then
        cce="CCE"
    else
        cce="CCE-80205-8"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^UMASK")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s %s" "$stripped_key" "$var_accounts_user_umask"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^UMASK\\>" "/etc/login.defs"; then
        "${sed_command[@]}" "s/^UMASK\\>.*/$formatted_output/gi" "/etc/login.defs"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/login.defs" >> "/etc/login.defs"
        printf '%s\n' "$formatted_output" >> "/etc/login.defs"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80205-8
        - DISA-STIG-RHEL-07-020240
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - accounts_umask_etc_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_accounts_user_umask # promote to variable
      set_fact:
        var_accounts_user_umask: !!str 077
      tags:
        - always
    
    - name: Ensure the Default UMASK is Set Correctly
      lineinfile:
        create: true
        dest: /etc/login.defs
        regexp: ^UMASK
        line: UMASK {{ var_accounts_user_umask }}
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
        - CCE-80205-8
        - DISA-STIG-RHEL-07-020240
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - accounts_umask_etc_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure the Default Umask is Set Correctly For Interactive Users   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_umask_interactive_users)rule

Remove the `UMASK` environment variable from all interactive users initialization files.

Rationale:

The umask controls the default access mode assigned to newly created files. A umask of 077 limits new files to mode 700 or less permissive. Although umask can be represented as a four-digit number, the first digit representing special access modes is typically ignored or required to be 0. This requirement applies to the globally configured system defaults and the local interactive user defaults for each account on the system.

Severity:  medium

Identifiers:  CCE-80536-6

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001814](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021040](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204488r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Ensure Home Directories are Created for New Users   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_have_homedir_login_defs)rule

All local interactive user accounts, upon creation, should be assigned a home directory.  
  
Configure the operating system to assign home directories to all new local interactive users by setting the `CREATE_HOME` parameter in `/etc/login.defs` to `yes` as follows:  
  

CREATE\_HOME yes

Rationale:

If local interactive users are not assigned a valid home directory, there is no place for the storage and control of files they should own.

Severity:  medium

Identifiers:  CCE-80434-4

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020610](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204466r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q shadow-utils; then
    
    if [ -e "/etc/login.defs" ] ; then
        
        LC_ALL=C sed -i "/^\s*CREATE_HOME\s\+/Id" "/etc/login.defs"
    else
        touch "/etc/login.defs"
    fi
    cp "/etc/login.defs" "/etc/login.defs.bak"
    # Insert before the line matching the regex '^\s*CREATE_HOME'.
    line_number="$(LC_ALL=C grep -n "^\s*CREATE_HOME" "/etc/login.defs.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^\s*CREATE_HOME', insert at
        # the end of the file.
        printf '%s\n' "CREATE_HOME yes" >> "/etc/login.defs"
    else
        head -n "$(( line_number - 1 ))" "/etc/login.defs.bak" > "/etc/login.defs"
        printf '%s\n' "CREATE_HOME yes" >> "/etc/login.defs"
        tail -n "+$(( line_number ))" "/etc/login.defs.bak" >> "/etc/login.defs"
    fi
    # Clean up after ourselves.
    rm "/etc/login.defs.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80434-4
        - DISA-STIG-RHEL-07-020610
        - accounts_have_homedir_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Ensure new users receive home directories
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/login.defs
            create: false
            regexp: ^\s*CREATE_HOME\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/login.defs
          lineinfile:
            path: /etc/login.defs
            create: false
            regexp: ^\s*CREATE_HOME\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/login.defs
          lineinfile:
            path: /etc/login.defs
            create: true
            regexp: ^\s*CREATE_HOME\s+
            line: CREATE_HOME yes
            state: present
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
        - CCE-80434-4
        - DISA-STIG-RHEL-07-020610
        - accounts_have_homedir_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure the Logon Failure Delay is Set Correctly in login.defs   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_logon_fail_delay)rule

To ensure the logon failure delay controlled by `/etc/login.defs` is set properly, add or correct the `FAIL_DELAY` setting in `/etc/login.defs` to read as follows:

FAIL\_DELAY 4

Rationale:

Increasing the time between a failed authentication attempt and re-prompting to enter credentials helps to slow a single-threaded brute force attack.

Severity:  medium

Identifiers:  CCE-80352-8

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [AC-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00226](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010430](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204431r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q shadow-utils; then
    
    
    
    # Set variables
    var_accounts_fail_delay="4"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/login.defs"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80352-8" ]; then
        cce="CCE"
    else
        cce="CCE-80352-8"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^FAIL_DELAY")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s %s" "$stripped_key" "$var_accounts_fail_delay"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^FAIL_DELAY\\>" "/etc/login.defs"; then
        "${sed_command[@]}" "s/^FAIL_DELAY\\>.*/$formatted_output/gi" "/etc/login.defs"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/login.defs" >> "/etc/login.defs"
        printf '%s\n' "$formatted_output" >> "/etc/login.defs"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80352-8
        - DISA-STIG-RHEL-07-010430
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - accounts_logon_fail_delay
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    - name: XCCDF Value var_accounts_fail_delay # promote to variable
      set_fact:
        var_accounts_fail_delay: !!str 4
      tags:
        - always
    
    - name: Set accounts logon fail delay
      lineinfile:
        dest: /etc/login.defs
        regexp: ^FAIL_DELAY
        line: FAIL_DELAY {{ var_accounts_fail_delay }}
        create: true
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
        - CCE-80352-8
        - DISA-STIG-RHEL-07-010430
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - accounts_logon_fail_delay
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Limit the Number of Concurrent Login Sessions Allowed Per User   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_max_concurrent_login_sessions)rule

Limiting the number of allowed users and sessions per user can limit risks related to Denial of Service attacks. This addresses concurrent sessions for a single account and does not address concurrent sessions by a single user via multiple accounts. To set the number of concurrent sessions per user add the following line in `/etc/security/limits.conf` or a file under `/etc/security/limits.d/`:

\* hard maxlogins 10

Rationale:

Limiting simultaneous user logins can insulate the system from denial of service problems caused by excessive logins. Automated login processes operating improperly or maliciously may result in an exceptional number of simultaneous login sessions.

Severity:  low

Identifiers:  CCE-82041-5

References:  [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.5.2.2](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [CCI-000054](https://public.cyber.mil/stigs/cci/), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000027-GPOS-00008](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000027-VMM-000080, [RHEL-07-040000](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204576r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q pam; then
    
    
    var_accounts_max_concurrent_login_sessions="10"
    
    
    
    if grep -q '^[^#]*\<maxlogins\>' /etc/security/limits.d/*.conf; then
    	sed -i "/^[^#]*\<maxlogins\>/ s/maxlogins.*/maxlogins $var_accounts_max_concurrent_login_sessions/" /etc/security/limits.d/*.conf
    elif grep -q '^[^#]*\<maxlogins\>' /etc/security/limits.conf; then
    	sed -i "/^[^#]*\<maxlogins\>/ s/maxlogins.*/maxlogins $var_accounts_max_concurrent_login_sessions/" /etc/security/limits.conf
    else
    	echo "*	hard	maxlogins	$var_accounts_max_concurrent_login_sessions" >> /etc/security/limits.conf
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82041-5
        - CJIS-5.5.2.2
        - DISA-STIG-RHEL-07-040000
        - NIST-800-53-AC-10
        - NIST-800-53-CM-6(a)
        - accounts_max_concurrent_login_sessions
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
        - restrict_strategy
    - name: XCCDF Value var_accounts_max_concurrent_login_sessions # promote to variable
      set_fact:
        var_accounts_max_concurrent_login_sessions: !!str 10
      tags:
        - always
    
    - name: Find /etc/security/limits.d files containing maxlogins configuration
      find:
        paths: /etc/security/limits.d
        contains: ^[\s]*\*[\s]+(?:(?:hard)|(?:-))[\s]+maxlogins
        patterns: '*.conf'
      register: maxlogins
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-82041-5
        - CJIS-5.5.2.2
        - DISA-STIG-RHEL-07-040000
        - NIST-800-53-AC-10
        - NIST-800-53-CM-6(a)
        - accounts_max_concurrent_login_sessions
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Limit the Number of Concurrent Login Sessions Allowed Per User in files from
        limits.d
      replace:
        dest: '{{ item.path }}'
        regexp: ^#?\*.*maxlogins.*
        replace: '*          hard    maxlogins     {{ var_accounts_max_concurrent_login_sessions
          }}'
      with_items:
        - '{{ maxlogins.files }}'
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-82041-5
        - CJIS-5.5.2.2
        - DISA-STIG-RHEL-07-040000
        - NIST-800-53-AC-10
        - NIST-800-53-CM-6(a)
        - accounts_max_concurrent_login_sessions
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Limit the Number of Concurrent Login Sessions Allowed Per User
      lineinfile:
        state: present
        dest: /etc/security/limits.conf
        insertbefore: ^# End of file
        regexp: ^#?\*.*maxlogins
        line: '*          hard    maxlogins     {{ var_accounts_max_concurrent_login_sessions
          }}'
        create: true
      when:
        - '"pam" in ansible_facts.packages'
        - maxlogins.matched == 0
      tags:
        - CCE-82041-5
        - CJIS-5.5.2.2
        - DISA-STIG-RHEL-07-040000
        - NIST-800-53-AC-10
        - NIST-800-53-CM-6(a)
        - accounts_max_concurrent_login_sessions
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Set Interactive Session Timeout   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_tmout)rule

Setting the `TMOUT` option in `/etc/profile` ensures that all user sessions will terminate based on inactivity. The `TMOUT` setting in a file loaded by `/etc/profile`, e.g. `/etc/profile.d/tmout.sh` should read as follows:

TMOUT=900

Rationale:

Terminating an idle session within a short time period reduces the window of opportunity for unauthorized personnel to take control of a management session enabled on the console or console port that has been left unattended.

Severity:  medium

Identifiers:  CCE-27557-8

References:  [BP28(R29)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000057](https://public.cyber.mil/stigs/cci/), [CCI-001133](https://public.cyber.mil/stigs/cci/), [CCI-002361](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-2(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000163-GPOS-00072](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000029-GPOS-00010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000163-VMM-000700, SRG-OS-000279-VMM-001010, [RHEL-07-040160](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204579r646844\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.5.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_accounts_tmout="900"
    
    
    
    # if 0, no occurence of tmout found, if 1, occurence found
    tmout_found=0
    
    for f in /etc/profile /etc/profile.d/*.sh; do
        if grep --silent '^\s*TMOUT' $f; then
            sed -i -E "s/^(\s*)TMOUT\s*=\s*(\w|\$)*(.*)$/\1TMOUT=$var_accounts_tmout\3/g" $f
            tmout_found=1
        fi
    done
    
    if [ $tmout_found -eq 0 ]; then
            echo -e "\n# Set TMOUT to $var_accounts_tmout per security requirements" >> /etc/profile.d/tmout.sh
            echo "TMOUT=$var_accounts_tmout" >> /etc/profile.d/tmout.sh
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value var_accounts_tmout # promote to variable
      set_fact:
        var_accounts_tmout: !!str 900
      tags:
        - always
    
    - name: Set Interactive Session Timeout
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/profile.d/tmout.sh
            create: false
            regexp: ^\s*TMOUT=
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/profile.d/tmout.sh
          lineinfile:
            path: /etc/profile.d/tmout.sh
            create: false
            regexp: ^\s*TMOUT=
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/profile.d/tmout.sh
          lineinfile:
            path: /etc/profile.d/tmout.sh
            create: true
            regexp: ^\s*TMOUT=
            line: TMOUT={{ var_accounts_tmout }}
            state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27557-8
        - DISA-STIG-RHEL-07-040160
        - NIST-800-171-3.1.11
        - NIST-800-53-AC-12
        - NIST-800-53-AC-2(5)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-10
        - accounts_tmout
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### User Initialization Files Must Be Group-Owned By The Primary User   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_user_dot_group_ownership)rule

Change the group owner of interactive users files to the group found in

/etc/passwd

for the user. To change the group owner of a local interactive user home directory, use the following command:

$ sudo chgrp _USER\_GROUP_ /home/_USER_/._INIT\_FILE_

Rationale:

Local initialization files for interactive users are used to configure the user's shell environment upon logon. Malicious modification of these files could compromise accounts upon logon.

Severity:  medium

Identifiers:  CCE-80526-7

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020700](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204475r603836\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### User Initialization Files Must Not Run World-Writable Programs   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_user_dot_no_world_writable_programs)rule

Set the mode on files being executed by the user initialization files with the following command:

$ sudo chmod 0755 _FILE_

Rationale:

If user start-up files execute world-writable programs, especially in unprotected directories, they could be maliciously modified to destroy user files or otherwise compromise the system at the user level. If the system is compromised at the user level, it is easier to elevate privileges to eventually compromise the system at the root and network level.

Severity:  medium

Identifiers:  CCE-80523-4

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020730](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204478r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### User Initialization Files Must Be Owned By the Primary User   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_user_dot_user_ownership)rule

Set the owner of the user initialization files for interactive users to the primary owner with the following command:

$ sudo chown _USER_ /home/_USER_/.\*

Rationale:

Local initialization files are used to configure the user's shell environment upon logon. Malicious modification of these files could compromise accounts upon logon.

Severity:  medium

Identifiers:  CCE-80527-5

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020690](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204474r603834\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Ensure that Users Path Contains Only Local Directories   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_user_home_paths_only)rule

Ensure that all interactive user initialization files executable search path statements do not contain statements that will reference a working directory other than the users home directory.

Rationale:

The executable search path (typically the PATH environment variable) contains a list of directories for the shell to search to find executables. If this path includes the current working directory (other than the users home directory), executables in these directories may be executed instead of system commands. This variable is formatted as a colon-separated list of directories. If there is an empty entry, such as a leading or trailing colon or two consecutive colons, this is interpreted as the current working directory. If deviations from the default system search path for the local interactive user are required, they must be documented with the Information System Security Officer (ISSO).

Severity:  medium

Identifiers:  CCE-80524-2

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020720](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204477r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### All Interactive Users Home Directories Must Exist   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_user_interactive_home_directory_exists)rule

Create home directories to all interactive users that currently do not have a home directory assigned. Use the following commands to create the user home directory assigned in `/etc/passwd`:

$ sudo mkdir /home/_USER_

Rationale:

If a local interactive user has a home directory defined that does not exist, the user may be given access to the / directory as the current working directory upon logon. This could create a Denial of Service because the user would not be able to access their logon configuration files, and it may give them visibility to system files they normally would not be able to access.

Severity:  medium

Identifiers:  CCE-80529-1

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020620](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204467r603826\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### All User Files and Directories In The Home Directory Must Be Group-Owned By The Primary User   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_users_home_files_groupownership)rule

Change the group of a local interactive users files and directories to a group that the interactive user is a member of. To change the group owner of a local interactive users files and directories, use the following command:

$ sudo chgrp _USER\_GROUP_ /home/_USER_/_FILE\_DIR_

Rationale:

If a local interactive users files are group-owned by a group of which the user is not a member, unintended users may be able to access them.

Severity:  medium

Identifiers:  CCE-80534-1

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020670](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204472r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### All User Files and Directories In The Home Directory Must Have a Valid Owner   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_users_home_files_ownership)rule

Either remove all files and directories from the system that do not have a valid user, or assign a valid user to all unowned files and directories. To assign a valid owner to a local interactive user's files and directories, use the following command:

$ sudo chown -R _USER_ /home/_USER_

Rationale:

If local interactive users do not own the files in their directories, unauthorized users may be able to access them. Additionally, if files are not owned by the user, this could be an indication of system compromise.

Severity:  medium

Identifiers:  CCE-80533-3

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020660](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204471r744105\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### All User Files and Directories In The Home Directory Must Have Mode 0750 Or Less Permissive   [\[ref\]](#xccdf_org.ssgproject.content_rule_accounts_users_home_files_permissions)rule

Set the mode on files and directories in the local interactive user home directory with the following command:

$ sudo chmod 0750 /home/_USER_/_FILE\_DIR_

Rationale:

If a local interactive user files have excessive permissions, unintended users may be able to access or modify them.

Severity:  medium

Identifiers:  CCE-80535-8

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020680](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204473r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### All Interactive User Home Directories Must Be Group-Owned By The Primary User   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_groupownership_home_directories)rule

Change the group owner of interactive users home directory to the group found in `/etc/passwd`. To change the group owner of interactive users home directory, use the following command:

$ sudo chgrp _USER\_GROUP_ /home/_USER_

Rationale:

If the Group Identifier (GID) of a local interactive users home directory is not the same as the primary GID of the user, this would allow unauthorized access to the users files, and users that share the same group may not be able to access files that they legitimately should.

Severity:  medium

Identifiers:  CCE-80532-5

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020650](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204470r744102\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### All Interactive User Home Directories Must Be Owned By The Primary User   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_ownership_home_directories)rule

Change the owner of interactive users home directories to that correct owner. To change the owner of a interactive users home directory, use the following command:

$ sudo chown _USER_ /home/_USER_

Rationale:

If a local interactive user does not own their home directory, unauthorized users could access or modify the user's files, and the users may not be able to access their own files.

Severity:  medium

Identifiers:  CCE-80531-7

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020640](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204469r603830\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Ensure All User Initialization Files Have Mode 0740 Or Less Permissive   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_permission_user_init_files)rule

Set the mode of the user initialization files to `0740` with the following command:

$ sudo chmod 0740 /home/_USER_/._INIT\_FILE_

Rationale:

Local initialization files are used to configure the user's shell environment upon logon. Malicious modification of these files could compromise accounts upon logon.

Severity:  medium

Identifiers:  CCE-80525-9

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020710](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204476r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### All Interactive User Home Directories Must Have mode 0750 Or Less Permissive   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_permissions_home_directories)rule

Change the mode of interactive users home directories to `0750`. To change the mode of interactive users home directory, use the following command:

$ sudo chmod 0750 /home/_USER_

Rationale:

Excessive permissions on local interactive user home directories may allow unauthorized access to user files by other users.

Severity:  medium

Identifiers:  CCE-80530-9

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020630](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204468r603828\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### System Accounting with auditd   [\[ref\]](#xccdf_org.ssgproject.content_group_auditing)group

The audit service provides substantial capabilities for recording system activities. By default, the service audits about SELinux AVC denials and certain types of security-relevant events such as system logins, account modifications, and authentication events performed by programs such as sudo. Under its default configuration, `auditd` has modest disk space requirements, and should not noticeably impact system performance.  
  
NOTE: The Linux Audit daemon `auditd` can be configured to use the `augenrules` program to read audit rules files (`*.rules`) located in `/etc/audit/rules.d` location and compile them to create the resulting form of the `/etc/audit/audit.rules` configuration file during the daemon startup (default configuration). Alternatively, the `auditd` daemon can use the `auditctl` utility to read audit rules from the `/etc/audit/audit.rules` configuration file during daemon startup, and load them into the kernel. The expected behavior is configured via the appropriate `ExecStartPost` directive setting in the `/usr/lib/systemd/system/auditd.service` configuration file. To instruct the `auditd` daemon to use the `augenrules` program to read audit rules (default configuration), use the following setting:  

ExecStartPost=-/sbin/augenrules --load

in the `/usr/lib/systemd/system/auditd.service` configuration file. In order to instruct the `auditd` daemon to use the `auditctl` utility to read audit rules, use the following setting:  

ExecStartPost=-/sbin/auditctl -R /etc/audit/audit.rules

in the `/usr/lib/systemd/system/auditd.service` configuration file. Refer to `[Service]` section of the `/usr/lib/systemd/system/auditd.service` configuration file for further details.  
  
Government networks often have substantial auditing requirements and `auditd` can be configured to meet these requirements. Examining some example audit records demonstrates how the Linux audit system satisfies common requirements. The following example from Fedora Documentation available at `[https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/selinux_users_and_administrators_guide/index#sect-Security-Enhanced_Linux-Fixing_Problems-Raw_Audit_Messages](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/selinux_users_and_administrators_guide/index#sect-Security-Enhanced_Linux-Fixing_Problems-Raw_Audit_Messages)` shows the substantial amount of information captured in a two typical "raw" audit messages, followed by a breakdown of the most important fields. In this example the message is SELinux-related and reports an AVC denial (and the associated system call) that occurred when the Apache HTTP Server attempted to access the `/var/www/html/file1` file (labeled with the `samba_share_t` type):

type=AVC msg=audit(1226874073.147:96): avc:  denied  { getattr } for pid=2465 comm="httpd"
path="/var/www/html/file1" dev=dm-0 ino=284133 scontext=unconfined\_u:system\_r:httpd\_t:s0
tcontext=unconfined\_u:object\_r:samba\_share\_t:s0 tclass=file

type=SYSCALL msg=audit(1226874073.147:96): arch=40000003 syscall=196 success=no exit=-13
a0=b98df198 a1=bfec85dc a2=54dff4 a3=2008171 items=0 ppid=2463 pid=2465 auid=502 uid=48
gid=48 euid=48 suid=48 fsuid=48 egid=48 sgid=48 fsgid=48 tty=(none) ses=6 comm="httpd"
exe="/usr/sbin/httpd" subj=unconfined\_u:system\_r:httpd\_t:s0 key=(null)

*   `msg=audit(1226874073.147:96)`
    *   The number in parentheses is the unformatted time stamp (Epoch time) for the event, which can be converted to standard time by using the `date` command.
*   `{ getattr }`
    *   The item in braces indicates the permission that was denied. `getattr` indicates the source process was trying to read the target file's status information. This occurs before reading files. This action is denied due to the file being accessed having the wrong label. Commonly seen permissions include `getattr`, `read`, and `write`.
*   `comm="httpd"`
    *   The executable that launched the process. The full path of the executable is found in the `exe=` section of the system call (`SYSCALL`) message, which in this case, is `exe="/usr/sbin/httpd"`.
*   `path="/var/www/html/file1"`
    *   The path to the object (target) the process attempted to access.
*   `scontext="unconfined_u:system_r:httpd_t:s0"`
    *   The SELinux context of the process that attempted the denied action. In this case, it is the SELinux context of the Apache HTTP Server, which is running in the `httpd_t` domain.
*   `tcontext="unconfined_u:object_r:samba_share_t:s0"`
    *   The SELinux context of the object (target) the process attempted to access. In this case, it is the SELinux context of `file1`. Note: the `samba_share_t` type is not accessible to processes running in the `httpd_t` domain.
*   From the system call (`SYSCALL`) message, two items are of interest:
    *   `success=no`: indicates whether the denial (AVC) was enforced or not. `success=no` indicates the system call was not successful (SELinux denied access). `success=yes` indicates the system call was successful - this can be seen for permissive domains or unconfined domains, such as `initrc_t` and `kernel_t`.
    *   `exe="/usr/sbin/httpd"`: the full path to the executable that launched the process, which in this case, is `exe="/usr/sbin/httpd"`.

contains 70 rules

### Configure auditd Rules for Comprehensive Auditing   [\[ref\]](#xccdf_org.ssgproject.content_group_auditd_configure_rules)group

The `auditd` program can perform comprehensive monitoring of system activity. This section describes recommended configuration settings for comprehensive auditing, but a full description of the auditing system's capabilities is beyond the scope of this guide. The mailing list _linux-audit@redhat.com_ exists to facilitate community discussion of the auditing system.  
  
The audit subsystem supports extensive collection of events, including:  

*   Tracing of arbitrary system calls (identified by name or number) on entry or exit.
*   Filtering by PID, UID, call success, system call argument (with some limitations), etc.
*   Monitoring of specific files for modifications to the file's contents or metadata.

  
Auditing rules at startup are controlled by the file `/etc/audit/audit.rules`. Add rules to it to meet the auditing requirements for your organization. Each line in `/etc/audit/audit.rules` represents a series of arguments that can be passed to `auditctl` and can be individually tested during runtime. See documentation in `/usr/share/doc/audit-_VERSION_` and in the related man pages for more details.  
  
If copying any example audit rulesets from `/usr/share/doc/audit-VERSION`, be sure to comment out the lines containing `arch=` which are not appropriate for your system's architecture. Then review and understand the following rules, ensuring rules are activated as needed for the appropriate architecture.  
  
After reviewing all the rules, reading the following sections, and editing as needed, the new rules can be activated as follows:

$ sudo service auditd restart

contains 60 rules

### Record Events that Modify the System's Discretionary Access Controls   [\[ref\]](#xccdf_org.ssgproject.content_group_audit_dac_actions)group

At a minimum, the audit system should collect file permission changes for all users and root. Note that the "-F arch=b32" lines should be present even on a 64 bit system. These commands identify system calls for auditing. Even if the system is 64 bit it can still execute 32 bit system calls. Additionally, these rules can be configured in a number of ways while still achieving the desired effect. An example of this is that the "-S" calls could be split up and placed on separate lines, however, this is less efficient. Add the following to `/etc/audit/audit.rules`:

\-a always,exit -F arch=b32 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -F key=perm\_mod
    -a always,exit -F arch=b32 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=unset -F key=perm\_mod
    -a always,exit -F arch=b32 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If your system is 64 bit then these lines should be duplicated and the arch=b32 replaced with arch=b64 as follows:

\-a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -F key=perm\_mod
    -a always,exit -F arch=b64 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=unset -F key=perm\_mod
    -a always,exit -F arch=b64 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

contains 13 rules

#### Record Events that Modify the System's Discretionary Access Controls - chmod   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_chmod)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S chmod -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S chmod -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S chmod -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S chmod -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27339-1

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030410](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204521r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="chmod"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="chmod fchmod fchmodat"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit chmod tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27339-1
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030410
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_chmod
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for chmod for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - chmod
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of chmod in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - chmod
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of chmod in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27339-1
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030410
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_chmod
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for chmod for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - chmod
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of chmod in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - chmod
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of chmod in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27339-1
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030410
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_chmod
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - chown   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_chown)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S chown -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S chown -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S chown -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S chown -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27364-9

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000474-GPOS-00219](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030370](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204517r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="chown"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="chown fchown fchownat lchown"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit chown tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27364-9
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030370
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_chown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for chown for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - chown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of chown in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - chown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of chown in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27364-9
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030370
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_chown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for chown for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - chown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of chown in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - chown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of chown in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27364-9
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030370
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_chown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - fchmod   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_fchmod)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S fchmod -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fchmod -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S fchmod -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fchmod -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27393-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030420](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204522r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="fchmod"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="chmod fchmod fchmodat"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit fchmod tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27393-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030420
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchmod
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fchmod for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchmod
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of fchmod in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchmod
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of fchmod in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27393-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030420
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchmod
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fchmod for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchmod
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of fchmod in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchmod
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of fchmod in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27393-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030420
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchmod
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - fchmodat   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_fchmodat)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S fchmodat -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fchmodat -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S fchmodat -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fchmodat -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27388-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030430](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204523r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="fchmodat"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="chmod fchmod fchmodat"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit fchmodat tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27388-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030430
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchmodat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fchmodat for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchmodat
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of fchmodat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchmodat
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of fchmodat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27388-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030430
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchmodat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fchmodat for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchmodat
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of fchmodat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchmodat
            syscall_grouping:
              - chmod
              - fchmod
              - fchmodat
    
        - name: Check existence of fchmodat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27388-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030430
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchmodat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - fchown   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_fchown)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S fchown -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fchown -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S fchown -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fchown -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27356-5

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000474-GPOS-00219](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030380](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204518r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="fchown"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="chown fchown fchownat lchown"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit fchown tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27356-5
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030380
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fchown for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of fchown in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of fchown in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27356-5
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030380
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fchown for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of fchown in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of fchown in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27356-5
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030380
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - fchownat   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_fchownat)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S fchownat -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fchownat -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S fchownat -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fchownat -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27387-0

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000474-GPOS-00219](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030400](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204520r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="fchownat"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="chown fchown fchownat lchown"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit fchownat tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27387-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030400
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchownat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fchownat for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchownat
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of fchownat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchownat
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of fchownat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27387-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030400
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchownat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fchownat for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchownat
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of fchownat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fchownat
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of fchownat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27387-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030400
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fchownat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - fremovexattr   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_fremovexattr)rule

At a minimum, the audit system should collect file permission changes for all users and root.  
  
If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S fremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

  
  
If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

  
  
If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S fremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

  
  
If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27353-2

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000474-GPOS-00219](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030480](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204528r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="fremovexattr"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="fremovexattr lremovexattr removexattr fsetxattr lsetxattr setxattr"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit fremovexattr tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27353-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030480
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fremovexattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fremovexattr for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fremovexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of fremovexattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fremovexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of fremovexattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27353-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030480
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fremovexattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fremovexattr for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fremovexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of fremovexattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fremovexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of fremovexattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27353-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030480
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fremovexattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - fsetxattr   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_fsetxattr)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S fsetxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fsetxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S fsetxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S fsetxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27389-6

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000474-GPOS-00219](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030450](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204525r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="fsetxattr"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="fremovexattr lremovexattr removexattr fsetxattr lsetxattr setxattr"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit fsetxattr tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27389-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030450
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fsetxattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fsetxattr for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fsetxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of fsetxattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fsetxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of fsetxattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27389-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030450
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fsetxattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for fsetxattr for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fsetxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of fsetxattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - fsetxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of fsetxattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27389-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030450
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_fsetxattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - lchown   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_lchown)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S lchown -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S lchown -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S lchown -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S lchown -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27083-5

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000474-GPOS-00219](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030390](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204519r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="lchown"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="chown fchown fchownat lchown"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit lchown tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27083-5
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030390
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_lchown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for lchown for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lchown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of lchown in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lchown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of lchown in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27083-5
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030390
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_lchown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for lchown for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lchown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of lchown in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lchown
            syscall_grouping:
              - chown
              - fchown
              - fchownat
              - lchown
    
        - name: Check existence of lchown in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27083-5
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030390
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_lchown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - lremovexattr   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_lremovexattr)rule

At a minimum, the audit system should collect file permission changes for all users and root.  
  
If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S lremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

  
  
If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S lremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

  
  
If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S lremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

  
  
If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S lremovexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27410-0

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000474-GPOS-00219](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030490](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204529r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="lremovexattr"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="fremovexattr lremovexattr removexattr fsetxattr lsetxattr setxattr"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit lremovexattr tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27410-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030490
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_lremovexattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for lremovexattr for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lremovexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of lremovexattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lremovexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of lremovexattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27410-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030490
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_lremovexattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for lremovexattr for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lremovexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of lremovexattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lremovexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of lremovexattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27410-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030490
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_lremovexattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - lsetxattr   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_lsetxattr)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S lsetxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S lsetxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S lsetxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S lsetxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27280-7

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000474-GPOS-00219](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030460](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204526r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="lsetxattr"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="fremovexattr lremovexattr removexattr fsetxattr lsetxattr setxattr"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit lsetxattr tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27280-7
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030460
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_lsetxattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for lsetxattr for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lsetxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of lsetxattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lsetxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of lsetxattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27280-7
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030460
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_lsetxattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for lsetxattr for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lsetxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of lsetxattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - lsetxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of lsetxattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27280-7
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030460
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_lsetxattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - removexattr   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_removexattr)rule

At a minimum, the audit system should collect file permission changes for all users and root.  
  
If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S removexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

  
  
If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S removexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

  
  
If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S removexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

  
  
If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S removexattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27367-2

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000474-GPOS-00219](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030470](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204527r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="removexattr"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="fremovexattr lremovexattr removexattr fsetxattr lsetxattr setxattr"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit removexattr tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27367-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030470
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_removexattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for removexattr for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - removexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of removexattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - removexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of removexattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27367-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030470
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_removexattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for removexattr for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - removexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of removexattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - removexattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of removexattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27367-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030470
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_removexattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify the System's Discretionary Access Controls - setxattr   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_dac_modification_setxattr)rule

At a minimum, the audit system should collect file permission changes for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S setxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S setxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S setxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

If the system is 64 bit then also add the following line:

\-a always,exit -F arch=b64 -S setxattr -F auid>=1000 -F auid!=unset -F key=perm\_mod

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

The changing of file permissions could indicate that a user is attempting to gain access to information that would otherwise be disallowed. Auditing DAC modifications can facilitate the identification of patterns of abuse among both authorized and unauthorized users.

Severity:  medium

Identifiers:  CCE-27213-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.5.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000474-VMM-001940, [RHEL-07-030440](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204524r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="setxattr"
    	KEY="perm_mod"
    	SYSCALL_GROUPING="fremovexattr lremovexattr removexattr fsetxattr lsetxattr setxattr"
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit setxattr tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27213-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030440
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_setxattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for setxattr for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - setxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of setxattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - setxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of setxattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27213-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030440
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_setxattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for setxattr for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - setxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of setxattr in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - setxattr
            syscall_grouping:
              - fremovexattr
              - lremovexattr
              - removexattr
              - fsetxattr
              - lsetxattr
              - setxattr
    
        - name: Check existence of setxattr in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27213-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030440
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.5.5
        - audit_rules_dac_modification_setxattr
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

### Record Execution Attempts to Run SELinux Privileged Commands   [\[ref\]](#xccdf_org.ssgproject.content_group_audit_execution_selinux_commands)group

At a minimum, the audit system should collect the execution of SELinux privileged commands for all users and root.

contains 4 rules

#### Record Any Attempts to Run chcon   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_execution_chcon)rule

At a minimum, the audit system should collect any execution attempt of the `chcon` command for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/chcon -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F path=/usr/bin/chcon -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80393-2

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000465-GPOS-00209](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000463-VMM-001850, [RHEL-07-030580](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204538r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/chcon"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/chcon
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/chcon -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/chcon -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/chcon -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/chcon -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/chcon -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/chcon -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80393-2
        - DISA-STIG-RHEL-07-030580
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_execution_chcon
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Record Any Attempts to Run semanage   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_execution_semanage)rule

At a minimum, the audit system should collect any execution attempt of the `semanage` command for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/sbin/semanage -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F path=/usr/sbin/semanage -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80391-6

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000465-GPOS-00209](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000463-VMM-001850, [RHEL-07-030560](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204536r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/sbin/semanage"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/sbin/semanage
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/semanage -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/semanage -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/semanage
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/semanage -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/semanage -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/semanage
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80391-6
        - DISA-STIG-RHEL-07-030560
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_execution_semanage
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Record Any Attempts to Run setfiles   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_execution_setfiles)rule

At a minimum, the audit system should collect any execution attempt of the `setfiles` command for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/sbin/setfiles -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F path=/usr/sbin/setfiles -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80660-4

References:  [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000465-GPOS-00209](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000463-VMM-001850, [RHEL-07-030590](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204539r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/sbin/setfiles"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/sbin/setfiles
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/setfiles -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/setfiles -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/setfiles
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/setfiles -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/setfiles -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/setfiles
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80660-4
        - DISA-STIG-RHEL-07-030590
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_execution_setfiles
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Record Any Attempts to Run setsebool   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_execution_setsebool)rule

At a minimum, the audit system should collect any execution attempt of the `setsebool` command for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/sbin/setsebool -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F path=/usr/sbin/setsebool -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80392-4

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000465-GPOS-00209](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000463-VMM-001850, [RHEL-07-030570](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204537r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/sbin/setsebool"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/sbin/setsebool
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/setsebool -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/setsebool -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/setsebool
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/setsebool -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/setsebool -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/setsebool
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80392-4
        - DISA-STIG-RHEL-07-030570
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_execution_setsebool
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

### Record File Deletion Events by User   [\[ref\]](#xccdf_org.ssgproject.content_group_audit_file_deletion_events)group

At a minimum, the audit system should collect file deletion events for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S rmdir,unlink,unlinkat,rename,renameat -F auid>=1000 -F auid!=unset -F key=delete

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S rmdir,unlink,unlinkat,rename,renameat -F auid>=1000 -F auid!=unset -F key=delete

contains 5 rules

#### Ensure auditd Collects File Deletion Events by User - rename   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_file_deletion_events_rename)rule

At a minimum, the audit system should collect file deletion events for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S rename -F auid>=1000 -F auid!=unset -F key=delete

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S rename -F auid>=1000 -F auid!=unset -F key=delete

Rationale:

Auditing file deletions will create an audit trail for files that are removed from the system. The audit trail could aid in system troubleshooting, as well as, detecting malicious processes that attempt to delete log files to conceal their presence.

Severity:  medium

Identifiers:  CCE-80995-4

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.1.1](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.MA-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000467-GPOS-00211](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000466-VMM-001870, SRG-OS-000468-VMM-001890, [RHEL-07-030880](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204569r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.13](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="rename"
    	KEY="delete"
    	SYSCALL_GROUPING="unlink unlinkat rename renameat rmdir"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit rename tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80995-4
        - DISA-STIG-RHEL-07-030880
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_rename
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for rename for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - rename
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of rename in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - rename
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of rename in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80995-4
        - DISA-STIG-RHEL-07-030880
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_rename
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for rename for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - rename
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of rename in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - rename
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of rename in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80995-4
        - DISA-STIG-RHEL-07-030880
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_rename
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Ensure auditd Collects File Deletion Events by User - renameat   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_file_deletion_events_renameat)rule

At a minimum, the audit system should collect file deletion events for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S renameat -F auid>=1000 -F auid!=unset -F key=delete

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S renameat -F auid>=1000 -F auid!=unset -F key=delete

Rationale:

Auditing file deletions will create an audit trail for files that are removed from the system. The audit trail could aid in system troubleshooting, as well as, detecting malicious processes that attempt to delete log files to conceal their presence.

Severity:  medium

Identifiers:  CCE-80413-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.1.1](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.MA-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000467-GPOS-00211](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000466-VMM-001870, SRG-OS-000468-VMM-001890, [RHEL-07-030890](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204570r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.13](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="renameat"
    	KEY="delete"
    	SYSCALL_GROUPING="unlink unlinkat rename renameat rmdir"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit renameat tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80413-8
        - DISA-STIG-RHEL-07-030890
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_renameat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for renameat for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - renameat
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of renameat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - renameat
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of renameat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80413-8
        - DISA-STIG-RHEL-07-030890
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_renameat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for renameat for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - renameat
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of renameat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - renameat
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of renameat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80413-8
        - DISA-STIG-RHEL-07-030890
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_renameat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Ensure auditd Collects File Deletion Events by User - rmdir   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_file_deletion_events_rmdir)rule

At a minimum, the audit system should collect file deletion events for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S rmdir -F auid>=1000 -F auid!=unset -F key=delete

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S rmdir -F auid>=1000 -F auid!=unset -F key=delete

Rationale:

Auditing file deletions will create an audit trail for files that are removed from the system. The audit trail could aid in system troubleshooting, as well as, detecting malicious processes that attempt to delete log files to conceal their presence.

Severity:  medium

Identifiers:  CCE-80412-0

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.1.1](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.MA-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000467-GPOS-00211](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000466-VMM-001870, SRG-OS-000468-VMM-001890, [RHEL-07-030900](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204571r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.14](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="rmdir"
    	KEY="delete"
    	SYSCALL_GROUPING="unlink unlinkat rename renameat rmdir"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit rmdir tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80412-0
        - DISA-STIG-RHEL-07-030900
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_rmdir
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for rmdir for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - rmdir
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of rmdir in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - rmdir
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of rmdir in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80412-0
        - DISA-STIG-RHEL-07-030900
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_rmdir
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for rmdir for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - rmdir
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of rmdir in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - rmdir
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of rmdir in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80412-0
        - DISA-STIG-RHEL-07-030900
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_rmdir
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Ensure auditd Collects File Deletion Events by User - unlink   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_file_deletion_events_unlink)rule

At a minimum, the audit system should collect file deletion events for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S unlink -F auid>=1000 -F auid!=unset -F key=delete

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S unlink -F auid>=1000 -F auid!=unset -F key=delete

Rationale:

Auditing file deletions will create an audit trail for files that are removed from the system. The audit trail could aid in system troubleshooting, as well as, detecting malicious processes that attempt to delete log files to conceal their presence.

Severity:  medium

Identifiers:  CCE-80996-2

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.1.1](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.MA-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000467-GPOS-00211](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000466-VMM-001870, SRG-OS-000468-VMM-001890, [RHEL-07-030910](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204572r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.13](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="unlink"
    	KEY="delete"
    	SYSCALL_GROUPING="unlink unlinkat rename renameat rmdir"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit unlink tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80996-2
        - DISA-STIG-RHEL-07-030910
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_unlink
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for unlink for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - unlink
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of unlink in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - unlink
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of unlink in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80996-2
        - DISA-STIG-RHEL-07-030910
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_unlink
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for unlink for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - unlink
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of unlink in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - unlink
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of unlink in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80996-2
        - DISA-STIG-RHEL-07-030910
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_unlink
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Ensure auditd Collects File Deletion Events by User - unlinkat   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_file_deletion_events_unlinkat)rule

At a minimum, the audit system should collect file deletion events for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S unlinkat -F auid>=1000 -F auid!=unset -F key=delete

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S unlinkat -F auid>=1000 -F auid!=unset -F key=delete

Rationale:

Auditing file deletions will create an audit trail for files that are removed from the system. The audit trail could aid in system troubleshooting, as well as, detecting malicious processes that attempt to delete log files to conceal their presence.

Severity:  medium

Identifiers:  CCE-80662-0

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.1.1](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.MA-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000467-GPOS-00211](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000466-VMM-001870, SRG-OS-000468-VMM-001890, [RHEL-07-030920](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204573r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.13](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="unlinkat"
    	KEY="delete"
    	SYSCALL_GROUPING="unlink unlinkat rename renameat rmdir"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit unlinkat tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80662-0
        - DISA-STIG-RHEL-07-030920
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_unlinkat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for unlinkat for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - unlinkat
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of unlinkat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - unlinkat
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of unlinkat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80662-0
        - DISA-STIG-RHEL-07-030920
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_unlinkat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for unlinkat for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - unlinkat
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of unlinkat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/delete.rules
          set_fact: audit_file="/etc/audit/rules.d/delete.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - unlinkat
            syscall_grouping:
              - unlink
              - unlinkat
              - rename
              - renameat
              - rmdir
    
        - name: Check existence of unlinkat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=delete
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80662-0
        - DISA-STIG-RHEL-07-030920
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_file_deletion_events_unlinkat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

### Record Unauthorized Access Attempts Events to Files (unsuccessful)   [\[ref\]](#xccdf_org.ssgproject.content_group_audit_file_modification)group

At a minimum, the audit system should collect unauthorized file accesses for all users and root. Note that the "-F arch=b32" lines should be present even on a 64 bit system. These commands identify system calls for auditing. Even if the system is 64 bit it can still execute 32 bit system calls. Additionally, these rules can be configured in a number of ways while still achieving the desired effect. An example of this is that the "-S" calls could be split up and placed on separate lines, however, this is less efficient. Add the following to `/etc/audit/audit.rules`:

\-a always,exit -F arch=b32 -S creat,open,openat,open\_by\_handle\_at,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
    -a always,exit -F arch=b32 -S creat,open,openat,open\_by\_handle\_at,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If your system is 64 bit then these lines should be duplicated and the arch=b32 replaced with arch=b64 as follows:

\-a always,exit -F arch=b64 -S creat,open,openat,open\_by\_handle\_at,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
    -a always,exit -F arch=b64 -S creat,open,openat,open\_by\_handle\_at,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

contains 6 rules

#### Record Unsuccessful Access Attempts to Files - creat   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_unsuccessful_file_modification_creat)rule

At a minimum, the audit system should collect unauthorized file accesses for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S creat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S creat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S creat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S creat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S creat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S creat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S creat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S creat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

Unsuccessful attempts to access files could be an indicator of malicious activity on a system. Auditing these events could serve as evidence of potential system compromise.

Severity:  medium

Identifiers:  CCE-80385-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [Req-10.2.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000461-GPOS-00205](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000461-VMM-001830, [RHEL-07-030500](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204530r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.10](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL="creat"
    KEY="access"
    SYSCALL_GROUPING="creat ftruncate truncate open openat open_by_handle_at"
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EACCES"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EPERM"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit creat tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80385-8
        - DISA-STIG-RHEL-07-030500
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_creat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for creat EACCES for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - creat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of creat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - creat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of creat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80385-8
        - DISA-STIG-RHEL-07-030500
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_creat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for creat EACCES for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - creat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of creat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - creat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of creat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80385-8
        - DISA-STIG-RHEL-07-030500
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_creat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for creat EPERM for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - creat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of creat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - creat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of creat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80385-8
        - DISA-STIG-RHEL-07-030500
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_creat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for creat EPERM for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - creat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of creat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - creat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of creat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80385-8
        - DISA-STIG-RHEL-07-030500
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_creat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Unsuccessful Access Attempts to Files - ftruncate   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_unsuccessful_file_modification_ftruncate)rule

At a minimum, the audit system should collect unauthorized file accesses for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S ftruncate -F exiu=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

Unsuccessful attempts to access files could be an indicator of malicious activity on a system. Auditing these events could serve as evidence of potential system compromise.

Severity:  medium

Identifiers:  CCE-80390-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [Req-10.2.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000461-GPOS-00205](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000461-VMM-001830, [RHEL-07-030550](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204535r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.10](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL="ftruncate"
    KEY="access"
    SYSCALL_GROUPING="creat ftruncate truncate open openat open_by_handle_at"
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EACCES"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EPERM"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit ftruncate tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80390-8
        - DISA-STIG-RHEL-07-030550
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_ftruncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for ftruncate EACCES for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - ftruncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of ftruncate in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - ftruncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of ftruncate in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80390-8
        - DISA-STIG-RHEL-07-030550
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_ftruncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for ftruncate EACCES for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - ftruncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of ftruncate in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - ftruncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of ftruncate in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80390-8
        - DISA-STIG-RHEL-07-030550
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_ftruncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for ftruncate EPERM for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - ftruncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of ftruncate in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - ftruncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of ftruncate in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80390-8
        - DISA-STIG-RHEL-07-030550
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_ftruncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for ftruncate EPERM for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - ftruncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of ftruncate in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - ftruncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of ftruncate in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80390-8
        - DISA-STIG-RHEL-07-030550
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_ftruncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Unsuccessful Access Attempts to Files - open   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_unsuccessful_file_modification_open)rule

At a minimum, the audit system should collect unauthorized file accesses for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S open -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S open -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S open -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S open -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S open -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S open -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S open -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S open -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

Unsuccessful attempts to access files could be an indicator of malicious activity on a system. Auditing these events could serve as evidence of potential system compromise.

Severity:  medium

Identifiers:  CCE-80386-6

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [Req-10.2.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000461-GPOS-00205](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000461-VMM-001830, [RHEL-07-030510](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204531r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.10](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL="open"
    KEY="access"
    SYSCALL_GROUPING="creat ftruncate truncate open openat open_by_handle_at"
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EACCES"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EPERM"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit open tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80386-6
        - DISA-STIG-RHEL-07-030510
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for open EACCES for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80386-6
        - DISA-STIG-RHEL-07-030510
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for open EACCES for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80386-6
        - DISA-STIG-RHEL-07-030510
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for open EPERM for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80386-6
        - DISA-STIG-RHEL-07-030510
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for open EPERM for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80386-6
        - DISA-STIG-RHEL-07-030510
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Unsuccessful Access Attempts to Files - open\_by\_handle\_at   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_unsuccessful_file_modification_open_by_handle_at)rule

At a minimum, the audit system should collect unauthorized file accesses for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S open\_by\_handle\_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S open\_by\_handle\_at -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S open\_by\_handle\_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S open\_by\_handle\_at -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S open\_by\_handle\_at,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S open\_by\_handle\_at,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S open\_by\_handle\_at,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S open\_by\_handle\_at,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

Unsuccessful attempts to access files could be an indicator of malicious activity on a system. Auditing these events could serve as evidence of potential system compromise.

Severity:  medium

Identifiers:  CCE-80388-2

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [Req-10.2.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000461-GPOS-00205](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000461-VMM-001830, [RHEL-07-030530](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204533r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.11](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL="open_by_handle_at"
    KEY="access"
    SYSCALL_GROUPING="creat ftruncate truncate open openat open_by_handle_at"
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EACCES"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EPERM"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit open_by_handle_at tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80388-2
        - DISA-STIG-RHEL-07-030530
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open_by_handle_at
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for open_by_handle_at EACCES for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open_by_handle_at
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open_by_handle_at in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open_by_handle_at
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open_by_handle_at in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80388-2
        - DISA-STIG-RHEL-07-030530
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open_by_handle_at
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for open_by_handle_at EACCES for x86_64
        platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open_by_handle_at
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open_by_handle_at in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open_by_handle_at
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open_by_handle_at in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80388-2
        - DISA-STIG-RHEL-07-030530
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open_by_handle_at
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for open_by_handle_at EPERM for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open_by_handle_at
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open_by_handle_at in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open_by_handle_at
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open_by_handle_at in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80388-2
        - DISA-STIG-RHEL-07-030530
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open_by_handle_at
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for open_by_handle_at EPERM for x86_64
        platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open_by_handle_at
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open_by_handle_at in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - open_by_handle_at
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of open_by_handle_at in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80388-2
        - DISA-STIG-RHEL-07-030530
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_open_by_handle_at
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Unsuccessful Access Attempts to Files - openat   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_unsuccessful_file_modification_openat)rule

At a minimum, the audit system should collect unauthorized file accesses for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S openat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S openat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S openat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S openat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S openat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S openat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S openat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S openat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

Unsuccessful attempts to access files could be an indicator of malicious activity on a system. Auditing these events could serve as evidence of potential system compromise.

Severity:  medium

Identifiers:  CCE-80387-4

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [Req-10.2.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000461-GPOS-00205](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000461-VMM-001830, [RHEL-07-030520](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204532r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.10](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL="openat"
    KEY="access"
    SYSCALL_GROUPING="creat ftruncate truncate open openat open_by_handle_at"
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EACCES"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EPERM"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit openat tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80387-4
        - DISA-STIG-RHEL-07-030520
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_openat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for openat EACCES for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - openat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of openat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - openat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of openat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80387-4
        - DISA-STIG-RHEL-07-030520
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_openat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for openat EACCES for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - openat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of openat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - openat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of openat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80387-4
        - DISA-STIG-RHEL-07-030520
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_openat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for openat EPERM for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - openat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of openat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - openat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of openat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80387-4
        - DISA-STIG-RHEL-07-030520
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_openat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for openat EPERM for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - openat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of openat in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - openat
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of openat in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80387-4
        - DISA-STIG-RHEL-07-030520
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_openat
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Unsuccessful Access Attempts to Files - truncate   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_unsuccessful_file_modification_truncate)rule

At a minimum, the audit system should collect unauthorized file accesses for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F arch=b32 -S truncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S truncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S truncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S truncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file:

\-a always,exit -F arch=b32 -S truncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b32 -S truncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

If the system is 64 bit then also add the following lines:

\-a always,exit -F arch=b64 -S truncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=access
-a always,exit -F arch=b64 -S truncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=access

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect. Here the system calls have been placed independent of other system calls. Grouping these system calls with others as identifying earlier in this guide is more efficient.

Rationale:

Unsuccessful attempts to access files could be an indicator of malicious activity on a system. Auditing these events could serve as evidence of potential system compromise.

Severity:  medium

Identifiers:  CCE-80389-0

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.4](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [Req-10.2.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-00033](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000458-GPOS-00203](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000461-GPOS-00205](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000458-VMM-001810, SRG-OS-000461-VMM-001830, [RHEL-07-030540](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204534r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.10](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL="truncate"
    KEY="access"
    SYSCALL_GROUPING="creat ftruncate truncate open openat open_by_handle_at"
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EACCES"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-F exit=-EPERM"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit truncate tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80389-0
        - DISA-STIG-RHEL-07-030540
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_truncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for truncate EACCES for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - truncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of truncate in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - truncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of truncate in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80389-0
        - DISA-STIG-RHEL-07-030540
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_truncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for truncate EACCES for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - truncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of truncate in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - truncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of truncate in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EACCES -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EACCES -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EACCES
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80389-0
        - DISA-STIG-RHEL-07-030540
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_truncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for truncate EPERM for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - truncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of truncate in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - truncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of truncate in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80389-0
        - DISA-STIG-RHEL-07-030540
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_truncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for truncate EPERM for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - truncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of truncate in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/access.rules
          set_fact: audit_file="/etc/audit/rules.d/access.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - truncate
            syscall_grouping:
              - creat
              - ftruncate
              - truncate
              - open
              - openat
              - open_by_handle_at
    
        - name: Check existence of truncate in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F exit=-EPERM -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F exit=-EPERM -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F exit=-EPERM
              -F auid>=1000 -F auid!=unset -F key=access
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80389-0
        - DISA-STIG-RHEL-07-030540
        - NIST-800-171-3.1.7
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.1
        - PCI-DSS-Req-10.2.4
        - audit_rules_unsuccessful_file_modification_truncate
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

### Record Information on Kernel Modules Loading and Unloading   [\[ref\]](#xccdf_org.ssgproject.content_group_audit_kernel_module_loading)group

To capture kernel module loading and unloading events, use following lines, setting ARCH to either b32 for 32-bit system, or having two lines for both b32 and b64 in case your system is 64-bit:

\-a always,exit -F arch=_ARCH_ -S init\_module,delete\_module -F key=modules

Place to add the lines depends on a way `auditd` daemon is configured. If it is configured to use the `augenrules` program (the default), add the lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`. If the `auditd` daemon is configured to use the `auditctl` utility, add the lines to file `/etc/audit/audit.rules`.

contains 3 rules

#### Ensure auditd Collects Information on Kernel Module Unloading - delete\_module   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_kernel_module_loading_delete)rule

To capture kernel module unloading events, use following line, setting ARCH to either b32 for 32-bit system, or having two lines for both b32 and b64 in case your system is 64-bit:

\-a always,exit -F arch=_ARCH_ -S delete\_module -F key=modules

Place to add the line depends on a way `auditd` daemon is configured. If it is configured to use the `augenrules` program (the default), add the line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`. If the `auditd` daemon is configured to use the `auditctl` utility, add the line to file `/etc/audit/audit.rules`.

Rationale:

The removal of kernel modules can be used to alter the behavior of the kernel and potentially introduce malicious code into kernel space. It is important to have an audit trail of modules that have been introduced into the kernel.

Severity:  medium

Identifiers:  CCE-80415-3

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00216](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000477-GPOS-00222](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000477-VMM-001970, [RHEL-07-030830](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204562r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.16](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    # Note: 32-bit and 64-bit kernel syscall numbers not always line up =>
    #       it's required on a 64-bit system to check also for the presence
    #       of 32-bit's equivalent of the corresponding rule.
    #       (See `man 7 audit.rules` for details )
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS=""
    	SYSCALL="delete_module"
    	KEY="modules"
    	SYSCALL_GROUPING="delete_module"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: Set architecture for audit delete_module tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80415-3
        - DISA-STIG-RHEL-07-030830
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_kernel_module_loading_delete
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Perform remediation of Audit rules for delete_module for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - delete_module
            syscall_grouping: []
    
        - name: Check existence of delete_module in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/module-change.rules
          set_fact: audit_file="/etc/audit/rules.d/module-change.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - delete_module
            syscall_grouping: []
    
        - name: Check existence of delete_module in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80415-3
        - DISA-STIG-RHEL-07-030830
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_kernel_module_loading_delete
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Perform remediation of Audit rules for delete_module for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - delete_module
            syscall_grouping: []
    
        - name: Check existence of delete_module in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/module-change.rules
          set_fact: audit_file="/etc/audit/rules.d/module-change.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - delete_module
            syscall_grouping: []
    
        - name: Check existence of delete_module in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80415-3
        - DISA-STIG-RHEL-07-030830
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_kernel_module_loading_delete
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,-a%20always%2Cexit%20-F%20arch%3Db32%20-S%20delete_module%20-k%20module-change%0A-a%20always%2Cexit%20-F%20arch%3Db64%20-S%20delete_module%20-k%20module-change%0A
            mode: 0600
            path: /etc/audit/rules.d/75-kernel-module-loading-delete.rules
            overwrite: true
    

#### Ensure auditd Collects Information on Kernel Module Loading and Unloading - finit\_module   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_kernel_module_loading_finit)rule

If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d` to capture kernel module loading and unloading events, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=_ARCH_ -S finit\_module -F key=modules

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file in order to capture kernel module loading and unloading events, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=_ARCH_ -S finit\_module -F key=modules

Rationale:

The addition/removal of kernel modules can be used to alter the behavior of the kernel and potentially introduce malicious code into kernel space. It is important to have an audit trail of modules that have been introduced into the kernel.

Severity:  medium

Identifiers:  CCE-80547-3

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00216](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000477-GPOS-00222](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000477-VMM-001970, [RHEL-07-030821](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204561r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.17](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    # Note: 32-bit and 64-bit kernel syscall numbers not always line up =>
    #       it's required on a 64-bit system to check also for the presence
    #       of 32-bit's equivalent of the corresponding rule.
    #       (See `man 7 audit.rules` for details )
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS=""
    	SYSCALL="finit_module"
    	KEY="modules"
    	SYSCALL_GROUPING="init_module finit_module"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: Set architecture for audit finit_module tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80547-3
        - DISA-STIG-RHEL-07-030821
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_kernel_module_loading_finit
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Perform remediation of Audit rules for finit_module for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - finit_module
            syscall_grouping:
              - init_module
              - finit_module
    
        - name: Check existence of finit_module in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/module-change.rules
          set_fact: audit_file="/etc/audit/rules.d/module-change.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - finit_module
            syscall_grouping:
              - init_module
              - finit_module
    
        - name: Check existence of finit_module in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80547-3
        - DISA-STIG-RHEL-07-030821
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_kernel_module_loading_finit
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Perform remediation of Audit rules for finit_module for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - finit_module
            syscall_grouping:
              - init_module
              - finit_module
    
        - name: Check existence of finit_module in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/module-change.rules
          set_fact: audit_file="/etc/audit/rules.d/module-change.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - finit_module
            syscall_grouping:
              - init_module
              - finit_module
    
        - name: Check existence of finit_module in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80547-3
        - DISA-STIG-RHEL-07-030821
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_kernel_module_loading_finit
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,-a%20always%2Cexit%20-F%20arch%3Db32%20-S%20finit_module%20-k%20module-change%0A-a%20always%2Cexit%20-F%20arch%3Db64%20-S%20finit_module%20-k%20module-change%0A
            mode: 0600
            path: /etc/audit/rules.d/75-kernel-module-loading-finit.rules
            overwrite: true
    

#### Ensure auditd Collects Information on Kernel Module Loading - init\_module   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_kernel_module_loading_init)rule

To capture kernel module loading events, use following line, setting ARCH to either b32 for 32-bit system, or having two lines for both b32 and b64 in case your system is 64-bit:

\-a always,exit -F arch=_ARCH_ -S init\_module -F key=modules

Place to add the line depends on a way `auditd` daemon is configured. If it is configured to use the `augenrules` program (the default), add the line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`. If the `auditd` daemon is configured to use the `auditctl` utility, add the line to file `/etc/audit/audit.rules`.

Rationale:

The addition of kernel modules can be used to alter the behavior of the kernel and potentially introduce malicious code into kernel space. It is important to have an audit trail of modules that have been introduced into the kernel.

Severity:  medium

Identifiers:  CCE-80414-6

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00216](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000477-GPOS-00222](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000477-VMM-001970, [RHEL-07-030820](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204560r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.16](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    # Note: 32-bit and 64-bit kernel syscall numbers not always line up =>
    #       it's required on a 64-bit system to check also for the presence
    #       of 32-bit's equivalent of the corresponding rule.
    #       (See `man 7 audit.rules` for details )
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS=""
    	SYSCALL="init_module"
    	KEY="modules"
    	SYSCALL_GROUPING="init_module finit_module"
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: Set architecture for audit init_module tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80414-6
        - DISA-STIG-RHEL-07-030820
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_kernel_module_loading_init
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Perform remediation of Audit rules for init_module for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - init_module
            syscall_grouping:
              - init_module
              - finit_module
    
        - name: Check existence of init_module in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/module-change.rules
          set_fact: audit_file="/etc/audit/rules.d/module-change.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - init_module
            syscall_grouping:
              - init_module
              - finit_module
    
        - name: Check existence of init_module in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80414-6
        - DISA-STIG-RHEL-07-030820
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_kernel_module_loading_init
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Perform remediation of Audit rules for init_module for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - init_module
            syscall_grouping:
              - init_module
              - finit_module
    
        - name: Check existence of init_module in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/module-change.rules
          set_fact: audit_file="/etc/audit/rules.d/module-change.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - init_module
            syscall_grouping:
              - init_module
              - finit_module
    
        - name: Check existence of init_module in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F key=module-change
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-80414-6
        - DISA-STIG-RHEL-07-030820
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_kernel_module_loading_init
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,-a%20always%2Cexit%20-F%20arch%3Db32%20-S%20init_module%20-k%20module-change%0A-a%20always%2Cexit%20-F%20arch%3Db64%20-S%20init_module%20-k%20module-change%0A
            mode: 0600
            path: /etc/audit/rules.d/75-kernel-module-loading-init.rules
            overwrite: true
    

### Record Attempts to Alter Logon and Logout Events   [\[ref\]](#xccdf_org.ssgproject.content_group_audit_login_events)group

The audit system already collects login information for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d` in order to watch for attempted manual edits of files involved in storing logon events:

\-w /var/log/tallylog -p wa -k logins
-w /var/run/faillock/ -p wa -k logins
-w /var/log/lastlog -p wa -k logins

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file in order to watch for unattempted manual edits of files involved in storing logon events:

\-w /var/log/tallylog -p wa -k logins
-w /var/run/faillock/ -p wa -k logins
-w /var/log/lastlog -p wa -k logins

contains 2 rules

#### Record Attempts to Alter Logon and Logout Events - faillock   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_login_events_faillock)rule

The audit system already collects login information for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d` in order to watch for attempted manual edits of files involved in storing logon events:

\-w /var/run/faillock -p wa -k logins

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file in order to watch for unattempted manual edits of files involved in storing logon events:

\-w /var/run/faillock -p wa -k logins

Rationale:

Manual editing of these files may indicate nefarious activity, such as an attacker attempting to remove evidence of an intrusion.

Severity:  medium

Identifiers:  CCE-80383-3

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.3](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000470-GPOS-00214](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000473-GPOS-00218](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000473-VMM-001930, SRG-OS-000470-VMM-001900, [RHEL-07-030610](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204540r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.7](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    
    # If the audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # into the list of files to be inspected
    files_to_inspect+=('/etc/audit/audit.rules')
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/var/run/faillock" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /var/run/faillock -p wa -k logins" >> "$audit_rules_file"
        fi
    done
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    # If the audit is 'augenrules', then check if rule is already defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to list of files for inspection.
    # If rule isn't defined, add '/etc/audit/rules.d/logins.rules' to list of files for inspection.
    readarray -t matches < <(grep -P "[\s]*-w[\s]+/var/run/faillock" /etc/audit/rules.d/*.rules)
    
    # For each of the matched entries
    for match in "${matches[@]}"
    do
        # Extract filepath from the match
        rulesd_audit_file=$(echo $match | cut -f1 -d ':')
        # Append that path into list of files for inspection
        files_to_inspect+=("$rulesd_audit_file")
    done
    # Case when particular audit rule isn't defined yet
    if [ "${#files_to_inspect[@]}" -eq "0" ]
    then
        # Append '/etc/audit/rules.d/logins.rules' into list of files for inspection
        key_rule_file="/etc/audit/rules.d/logins.rules"
        # If the logins.rules file doesn't exist yet, create it with correct permissions
        if [ ! -e "$key_rule_file" ]
        then
            touch "$key_rule_file"
            chmod 0640 "$key_rule_file"
        fi
        files_to_inspect+=("$key_rule_file")
    fi
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/var/run/faillock" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /var/run/faillock -p wa -k logins" >> "$audit_rules_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Search /etc/audit/rules.d for other user/group modification audit rules
      find:
        paths: /etc/audit/rules.d
        recurse: false
        contains: -k logins$
        patterns: '*.rules'
      register: find_faillock
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80383-3
        - DISA-STIG-RHEL-07-030610
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_faillock
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: If existing user/group modification ruleset not found, use /etc/audit/rules.d/logins.rules
        as the recipient for the rule
      set_fact:
        all_files:
          - /etc/audit/rules.d/logins.rules
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_faillock.matched is defined and find_faillock.matched == 0
      tags:
        - CCE-80383-3
        - DISA-STIG-RHEL-07-030610
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_faillock
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Use matched file as the recipient for the rule
      set_fact:
        all_files:
          - '{{ find_faillock.files | map(attribute=''path'') | list | first }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_faillock.matched is defined and find_faillock.matched > 0
      tags:
        - CCE-80383-3
        - DISA-STIG-RHEL-07-030610
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_faillock
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the faillock rule in rules.d when on x86
      lineinfile:
        path: '{{ all_files[0] }}'
        line: -w /var/run/faillock -p wa -k logins
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80383-3
        - DISA-STIG-RHEL-07-030610
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_faillock
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the faillock rule in /etc/audit/audit.rules
      lineinfile:
        line: -w /var/run/faillock -p wa -k logins
        state: present
        dest: /etc/audit/audit.rules
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80383-3
        - DISA-STIG-RHEL-07-030610
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_faillock
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Attempts to Alter Logon and Logout Events - lastlog   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_login_events_lastlog)rule

The audit system already collects login information for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d` in order to watch for attempted manual edits of files involved in storing logon events:

\-w /var/log/lastlog -p wa -k logins

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file in order to watch for unattempted manual edits of files involved in storing logon events:

\-w /var/log/lastlog -p wa -k logins

Rationale:

Manual editing of these files may indicate nefarious activity, such as an attacker attempting to remove evidence of an intrusion.

Severity:  medium

Identifiers:  CCE-80384-1

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.3](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000473-GPOS-00218](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000470-GPOS-00214](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000473-VMM-001930, SRG-OS-000470-VMM-001900, [RHEL-07-030620](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204541r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.7](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    
    # If the audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # into the list of files to be inspected
    files_to_inspect+=('/etc/audit/audit.rules')
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/var/log/lastlog" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /var/log/lastlog -p wa -k logins" >> "$audit_rules_file"
        fi
    done
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    # If the audit is 'augenrules', then check if rule is already defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to list of files for inspection.
    # If rule isn't defined, add '/etc/audit/rules.d/logins.rules' to list of files for inspection.
    readarray -t matches < <(grep -P "[\s]*-w[\s]+/var/log/lastlog" /etc/audit/rules.d/*.rules)
    
    # For each of the matched entries
    for match in "${matches[@]}"
    do
        # Extract filepath from the match
        rulesd_audit_file=$(echo $match | cut -f1 -d ':')
        # Append that path into list of files for inspection
        files_to_inspect+=("$rulesd_audit_file")
    done
    # Case when particular audit rule isn't defined yet
    if [ "${#files_to_inspect[@]}" -eq "0" ]
    then
        # Append '/etc/audit/rules.d/logins.rules' into list of files for inspection
        key_rule_file="/etc/audit/rules.d/logins.rules"
        # If the logins.rules file doesn't exist yet, create it with correct permissions
        if [ ! -e "$key_rule_file" ]
        then
            touch "$key_rule_file"
            chmod 0640 "$key_rule_file"
        fi
        files_to_inspect+=("$key_rule_file")
    fi
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/var/log/lastlog" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /var/log/lastlog -p wa -k logins" >> "$audit_rules_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Search /etc/audit/rules.d for other user/group modification audit rules
      find:
        paths: /etc/audit/rules.d
        recurse: false
        contains: -k logins$
        patterns: '*.rules'
      register: find_lastlog
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80384-1
        - DISA-STIG-RHEL-07-030620
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_lastlog
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: If existing user/group modification ruleset not found, use /etc/audit/rules.d/logins.rules
        as the recipient for the rule
      set_fact:
        all_files:
          - /etc/audit/rules.d/logins.rules
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_lastlog.matched is defined and find_lastlog.matched == 0
      tags:
        - CCE-80384-1
        - DISA-STIG-RHEL-07-030620
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_lastlog
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Use matched file as the recipient for the rule
      set_fact:
        all_files:
          - '{{ find_lastlog.files | map(attribute=''path'') | list | first }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_lastlog.matched is defined and find_lastlog.matched > 0
      tags:
        - CCE-80384-1
        - DISA-STIG-RHEL-07-030620
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_lastlog
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the lastlog rule in rules.d when on x86
      lineinfile:
        path: '{{ all_files[0] }}'
        line: -w /var/log/lastlog -p wa -k logins
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80384-1
        - DISA-STIG-RHEL-07-030620
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_lastlog
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the lastlog rule in /etc/audit/audit.rules
      lineinfile:
        line: -w /var/log/lastlog -p wa -k logins
        state: present
        dest: /etc/audit/audit.rules
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80384-1
        - DISA-STIG-RHEL-07-030620
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.3
        - audit_rules_login_events_lastlog
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

### Record Information on the Use of Privileged Commands   [\[ref\]](#xccdf_org.ssgproject.content_group_audit_privileged_commands)group

At a minimum, the audit system should collect the execution of privileged commands for all users and root.

contains 16 rules

#### Ensure auditd Collects Information on the Use of Privileged Commands - chage   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_chage)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/chage -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/chage -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80398-1

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000468-GPOS-00212](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030660](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204545r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/chage"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/chage
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/chage -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/chage -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/chage -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/chage -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/chage -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/chage -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80398-1
        - DISA-STIG-RHEL-07-030660
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_chage
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - chsh   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_chsh)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/chsh -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/chsh -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80404-7

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030720](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204551r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/chsh"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/chsh
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/chsh -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/chsh -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/chsh -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/chsh -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/chsh -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/chsh -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80404-7
        - DISA-STIG-RHEL-07-030720
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_chsh
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - crontab   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_crontab)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/crontab -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/crontab -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80410-4

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030800](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204557r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/crontab"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/crontab
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/crontab -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/crontab -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/crontab -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/crontab -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/crontab -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/crontab -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80410-4
        - DISA-STIG-RHEL-07-030800
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_crontab
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - gpasswd   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_gpasswd)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/gpasswd -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/gpasswd -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80397-3

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030650](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204544r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/gpasswd"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/gpasswd
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/gpasswd -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/gpasswd -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/gpasswd -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/gpasswd -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/gpasswd -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/gpasswd -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80397-3
        - DISA-STIG-RHEL-07-030650
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_gpasswd
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - mount   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_mount)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/mount -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/mount -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-81064-8

References:  [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030740](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204552r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/mount"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/mount
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/mount -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/mount -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/mount -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/mount -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/mount -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/mount -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-81064-8
        - DISA-STIG-RHEL-07-030740
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_mount
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - newgrp   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_newgrp)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/newgrp -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/newgrp -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80403-9

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030710](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204550r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/newgrp"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/newgrp
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/newgrp -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/newgrp -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/newgrp -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/newgrp -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/newgrp -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/newgrp -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80403-9
        - DISA-STIG-RHEL-07-030710
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_newgrp
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - pam\_timestamp\_check   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_pam_timestamp_check)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/sbin/pam\_timestamp\_check
-F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/sbin/pam\_timestamp\_check
-F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80411-2

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030810](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204558r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/sbin/pam_timestamp_check"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/sbin/pam_timestamp_check
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/pam_timestamp_check -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/pam_timestamp_check
              -F auid>=1000 -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/pam_timestamp_check
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/pam_timestamp_check -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/pam_timestamp_check -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/pam_timestamp_check
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80411-2
        - DISA-STIG-RHEL-07-030810
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_pam_timestamp_check
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - passwd   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_passwd)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/passwd -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/passwd -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80395-7

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030630](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204542r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/passwd"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/passwd
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/passwd -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/passwd -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/passwd -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/passwd -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/passwd -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/passwd -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80395-7
        - DISA-STIG-RHEL-07-030630
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_passwd
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - postdrop   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_postdrop)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/sbin/postdrop -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/sbin/postdrop -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80406-2

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030760](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204554r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/sbin/postdrop"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/sbin/postdrop
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/postdrop -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/postdrop -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/postdrop
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/postdrop -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/postdrop -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/postdrop
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80406-2
        - DISA-STIG-RHEL-07-030760
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_postdrop
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - postqueue   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_postqueue)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/sbin/postqueue -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/sbin/postqueue -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80407-0

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030770](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204555r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/sbin/postqueue"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/sbin/postqueue
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/postqueue -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/postqueue -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/postqueue
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/postqueue -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/postqueue -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/postqueue
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80407-0
        - DISA-STIG-RHEL-07-030770
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_postqueue
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - ssh-keysign   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_ssh_keysign)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/libexec/openssh/ssh-keysign -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/libexec/openssh/ssh-keysign -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80408-8

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030780](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204556r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/libexec/openssh/ssh-keysign"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/libexec/openssh/ssh-keysign
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/libexec/openssh/ssh-keysign -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/libexec/openssh/ssh-keysign
              -F auid>=1000 -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/libexec/openssh/ssh-keysign
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/libexec/openssh/ssh-keysign -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/libexec/openssh/ssh-keysign -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/libexec/openssh/ssh-keysign
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80408-8
        - DISA-STIG-RHEL-07-030780
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_ssh_keysign
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - su   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_su)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/su -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/su -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80400-5

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000064-GPOS-0003](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030680](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204547r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/su"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/su
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/su -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/su -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/su -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/su -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/su -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/su -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80400-5
        - DISA-STIG-RHEL-07-030680
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_su
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - sudo   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_sudo)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/sudo -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/sudo -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80401-3

References:  [BP28(R19)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030690](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204548r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/sudo"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/sudo
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/sudo -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/sudo -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/sudo -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/sudo -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/sudo -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/sudo -F auid>=1000
              -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80401-3
        - DISA-STIG-RHEL-07-030690
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_sudo
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - umount   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_umount)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/bin/umount -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/bin/umount -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80405-4

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030750](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204553r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/bin/umount"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/bin/umount
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/umount -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/umount -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/umount -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/bin/umount -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/bin/umount -F auid>=1000 -F auid!=unset
              (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/bin/umount -F
              auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80405-4
        - DISA-STIG-RHEL-07-030750
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_umount
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - unix\_chkpwd   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_unix_chkpwd)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/sbin/unix\_chkpwd -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/sbin/unix\_chkpwd -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80396-5

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R6.5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-3](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-3.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12.1(ii)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12.1(iv)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MA-4(1)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030640](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204543r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/sbin/unix_chkpwd"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/sbin/unix_chkpwd
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/unix_chkpwd -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/unix_chkpwd -F
              auid>=1000 -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/unix_chkpwd
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/unix_chkpwd -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/unix_chkpwd -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/unix_chkpwd
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80396-5
        - DISA-STIG-RHEL-07-030640
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(a)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-12.1(ii)
        - NIST-800-53-AU-12.1(iv)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-AU-3
        - NIST-800-53-AU-3.1
        - NIST-800-53-CM-6(a)
        - NIST-800-53-MA-4(1)(a)
        - audit_rules_privileged_commands_unix_chkpwd
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on the Use of Privileged Commands - userhelper   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_privileged_commands_userhelper)rule

At a minimum, the audit system should collect the execution of privileged commands for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add a line of the following form to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-a always,exit -F path=/usr/sbin/userhelper -F auid>=1000 -F auid!=unset -F key=privileged

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add a line of the following form to `/etc/audit/audit.rules`:

\-a always,exit -F path=/usr/sbin/userhelper -F auid>=1000 -F auid!=unset -F key=privileged

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider and advanced persistent threats.  
  
Privileged programs are subject to escalation-of-privilege attacks, which attempt to subvert their normal role of providing some necessary but limited capability. As such, motivation exists to monitor these programs for unusual activity.

Severity:  medium

Identifiers:  CCE-80399-9

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000471-VMM-001910, [RHEL-07-030670](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204546r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    ACTION_ARCH_FILTERS="-a always,exit"
    OTHER_FILTERS="-F path=/usr/sbin/userhelper"
    AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    SYSCALL=""
    KEY="privileged"
    SYSCALL_GROUPING=""
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    # Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Perform remediation of Audit rules for /usr/sbin/userhelper
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/userhelper -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/privileged.rules
          set_fact: audit_file="/etc/audit/rules.d/privileged.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/userhelper -F auid>=1000
              -F auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/userhelper
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls: []
            syscall_grouping: []
    
        - name: Check existence of  in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit(( -S |,)\w+)*(( -S |,){{ item }})+(( -S |,)\w+)*
              -F path=/usr/sbin/userhelper -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit)(?=.*(?:(?:-S |,)(?:{{ syscalls_found | join("|")
              }}))\b)((?:( -S |,)\w+)+)( -F path=/usr/sbin/userhelper -F auid>=1000 -F
              auid!=unset (?:-k |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit{{ syscalls | join(',') }} -F path=/usr/sbin/userhelper
              -F auid>=1000 -F auid!=unset -F key=privileged
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80399-9
        - DISA-STIG-RHEL-07-030670
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - audit_rules_privileged_commands_userhelper
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects Information on Exporting to Media (successful)   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_media_export)rule

At a minimum, the audit system should collect media exportation events for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S mount -F auid>=1000 -F auid!=unset -F key=export

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file, setting ARCH to either b32 or b64 as appropriate for your system:

\-a always,exit -F arch=ARCH -S mount -F auid>=1000 -F auid!=unset -F key=export

Rationale:

The unauthorized exportation of data to external media could result in an information leak where classified information, Privacy Act information, and intellectual property could be lost. An audit trail should be created each time a filesystem is mounted to help identify and guard against information loss.

Severity:  medium

Identifiers:  CCE-27447-2

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-10.2.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-030740](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204552r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.12](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS=""
    	AUID_FILTERS="-F auid>=1000 -F auid!=unset"
    	SYSCALL="mount"
    	KEY="perm_mod"
    	SYSCALL_GROUPING=""
    
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit mount tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27447-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030740
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_media_export
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for mount for x86 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - mount
            syscall_grouping: []
    
        - name: Check existence of mount in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - mount
            syscall_grouping: []
    
        - name: Check existence of mount in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b32(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b32)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b32 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27447-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030740
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_media_export
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Perform remediation of Audit rules for mount for x86_64 platform
      block:
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - mount
            syscall_grouping: []
    
        - name: Check existence of mount in /etc/audit/rules.d/
          find:
            paths: /etc/audit/rules.d
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: '*.rules'
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Reset syscalls found per file
          set_fact:
            syscalls_per_file: {}
            found_paths_dict: {}
    
        - name: Declare syscalls found per file
          set_fact: syscalls_per_file="{{ syscalls_per_file | combine( {item.files[0].path
            :[item.item] + syscalls_per_file.get(item.files[0].path, []) } ) }}"
          loop: '{{ find_command.results | selectattr(''matched'') | list }}'
    
        - name: Declare files where syscalls were found
          set_fact: found_paths="{{ find_command.results | map(attribute='files') | flatten
            | map(attribute='path') | list }}"
    
        - name: Count occurrences of syscalls in paths
          set_fact: found_paths_dict="{{ found_paths_dict | combine({ item:1+found_paths_dict.get(item,
            0) }) }}"
          loop: '{{ find_command.results | map(attribute=''files'') | flatten | map(attribute=''path'')
            | list }}'
    
        - name: Get path with most syscalls
          set_fact: audit_file="{{ (found_paths_dict | dict2items() | sort(attribute='value')
            | last).key }}"
          when: found_paths | length >= 1
    
        - name: No file with syscall found, set path to /etc/audit/rules.d/perm_mod.rules
          set_fact: audit_file="/etc/audit/rules.d/perm_mod.rules"
          when: found_paths | length == 0
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_per_file[audit_file]
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
    
        - name: Declare list of syscalls
          set_fact:
            syscalls:
              - mount
            syscall_grouping: []
    
        - name: Check existence of mount in /etc/audit/audit.rules
          find:
            paths: /etc/audit
            contains: -a always,exit -F arch=b64(( -S |,)\w+)*(( -S |,){{ item }})+((
              -S |,)\w+)* -F auid>=1000 -F auid!=unset (-k\s+|-F\s+key=)\S+\s*$
            patterns: audit.rules
          register: find_command
          loop: '{{ (syscall_grouping + syscalls) | unique }}'
    
        - name: Set path to /etc/audit/audit.rules
          set_fact: audit_file="/etc/audit/audit.rules"
    
        - name: Declare found syscalls
          set_fact: syscalls_found="{{ find_command.results | selectattr('matched') |
            map(attribute='item') | list }}"
    
        - name: Declare missing syscalls
          set_fact: missing_syscalls="{{ syscalls | difference(syscalls_found) }}"
    
        - name: Replace the audit rule in {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            regexp: (-a always,exit -F arch=b64)(?=.*(?:(?:-S |,)(?:{{ syscalls_found
              | join("|") }}))\b)((?:( -S |,)\w+)+)( -F auid>=1000 -F auid!=unset (?:-k
              |-F key=)\w+)
            line: \1\2\3{{ missing_syscalls | join("\3") }}\4
            backrefs: true
            state: present
          when: syscalls_found | length > 0 and missing_syscalls | length > 0
    
        - name: Add the audit rule to {{ audit_file }}
          lineinfile:
            path: '{{ audit_file }}'
            line: -a always,exit -F arch=b64 -S {{ syscalls | join(',') }} -F auid>=1000
              -F auid!=unset -F key=perm_mod
            create: true
            mode: o-rwx
            state: present
          when: syscalls_found | length == 0
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - audit_arch == "b64"
      tags:
        - CCE-27447-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030740
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.7
        - audit_rules_media_export
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events When Privileged Executables Are Run   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_suid_privilege_function)rule

Verify the system generates an audit record when privileged functions are executed.

\# grep -iw execve `/etc/audit/audit.rules`

\-a always,exit -F arch=b32 -S execve -C uid!=euid -F euid=0 -k setuid

\-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -k setuid

\-a always,exit -F arch=b32 -S execve -C gid!=egid -F egid=0 -k setgid

\-a always,exit -F arch=b64 -S execve -C gid!=egid -F egid=0 -k setgid

If both the "b32" and "b64" audit rules for "SUID" files are not defined, this is a finding. If both the "b32" and "b64" audit rules for "SGID" files are not defined, this is a finding.

Warning:  Note that these rules can be configured in a number of ways while still achieving the desired effect.

Rationale:

Misuse of privileged functions, either intentionally or unintentionally by authorized users, or by unauthorized external entities that have compromised information system accounts, is a serious and ongoing concern and can have significant adverse impacts on organizations. Auditing the use of privileged functions is one way to detect such misuse and identify the risk from insider threats and the advanced persistent threat.

Severity:  medium

Identifiers:  CCE-83555-3

References:  [CCI-001814](https://public.cyber.mil/stigs/cci/), [CCI-001882](https://public.cyber.mil/stigs/cci/), [CCI-001889](https://public.cyber.mil/stigs/cci/), [CCI-001880](https://public.cyber.mil/stigs/cci/), [CCI-001881](https://public.cyber.mil/stigs/cci/), [CCI-001878](https://public.cyber.mil/stigs/cci/), [CCI-001879](https://public.cyber.mil/stigs/cci/), [CCI-001875](https://public.cyber.mil/stigs/cci/), [CCI-001877](https://public.cyber.mil/stigs/cci/), [CCI-001914](https://public.cyber.mil/stigs/cci/), [CCI-002234](https://public.cyber.mil/stigs/cci/), [CM-5(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-8(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000326-GPOS-00126](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000327-GPOS-00127](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000337-GPOS-00129](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000348-GPOS-00136](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000349-GPOS-00137](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000350-GPOS-00138](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000351-GPOS-00139](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000352-GPOS-00140](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000353-GPOS-00141](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000354-GPOS-00142](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000358-GPOS-00145](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000359-GPOS-00146](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000365-GPOS-00152](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-030360](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204516r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # First perform the remediation of the syscall rule
    # Retrieve hardware architecture of the underlying system
    [ "$(getconf LONG_BIT)" = "32" ] && RULE_ARCHS=("b32") || RULE_ARCHS=("b32" "b64")
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-C uid!=euid -F euid=0"
    	AUID_FILTERS=""
    	SYSCALL="execve"
    	KEY="setuid"
    	SYSCALL_GROUPING=""
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    for ARCH in "${RULE_ARCHS[@]}"
    do
    	ACTION_ARCH_FILTERS="-a always,exit -F arch=$ARCH"
    	OTHER_FILTERS="-C gid!=egid -F egid=0"
    	AUID_FILTERS=""
    	SYSCALL="execve"
    	KEY="setgid"
    	SYSCALL_GROUPING=""
    	# Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    # If audit tool is 'augenrules', then check if the audit rule is defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to the list for inspection
    # If rule isn't defined yet, add '/etc/audit/rules.d/$key.rules' to the list for inspection
    default_file="/etc/audit/rules.d/$KEY.rules"
    # As other_filters may include paths, lets use a different delimiter for it
    # The "F" script expression tells sed to print the filenames where the expressions matched
    readarray -t files_to_inspect < <(sed -s -n -e "/$ACTION_ARCH_FILTERS/!d" -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" -e "F" /etc/audit/rules.d/*.rules)
    # Case when particular rule isn't defined in /etc/audit/rules.d/*.rules yet
    if [ ${#files_to_inspect[@]} -eq "0" ]
    then
        file_to_inspect="/etc/audit/rules.d/$KEY.rules"
        files_to_inspect=("$file_to_inspect")
        if [ ! -e "$file_to_inspect" ]
        then
            touch "$file_to_inspect"
            chmod 0640 "$file_to_inspect"
        fi
    fi
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    	# Load macro arguments into arrays
    read -a syscall_a <<< $SYSCALL
    read -a syscall_grouping <<< $SYSCALL_GROUPING
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    # 
    # -----------------------------------------------------------------------------------------
    #  Tool used to load audit rules | Rule already defined  |  Audit rules file to inspect    |
    # -----------------------------------------------------------------------------------------
    #        auditctl                |     Doesn't matter    |  /etc/audit/audit.rules         |
    # -----------------------------------------------------------------------------------------
    #        augenrules              |          Yes          |  /etc/audit/rules.d/*.rules     |
    #        augenrules              |          No           |  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    #
    files_to_inspect=()
    
    
    # If audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # file to the list of files to be inspected
    default_file="/etc/audit/audit.rules"
    files_to_inspect+=('/etc/audit/audit.rules' )
    
    # Indicator that we want to append $full_rule into $audit_file or edit a rule in it
    append_expected_rule=0
    
    # After converting to jinja, we cannot return; therefore we skip the rest of the macro if needed instead
    skip=1
    
    for audit_file in "${files_to_inspect[@]}"
    do
        # Filter existing $audit_file rules' definitions to select those that satisfy the rule pattern,
        # i.e, collect rules that match:
        # * the action, list and arch, (2-nd argument)
        # * the other filters, (3-rd argument)
        # * the auid filters, (4-rd argument)
        readarray -t similar_rules < <(sed -e "/$ACTION_ARCH_FILTERS/!d"  -e "\#$OTHER_FILTERS#!d" -e "/$AUID_FILTERS/!d" "$audit_file")
    
        candidate_rules=()
        # Filter out rules that have more fields then required. This will remove rules more specific than the required scope
        for s_rule in "${similar_rules[@]}"
        do
            # Strip all the options and fields we know of,
            # than check if there was any field left over
            extra_fields=$(sed -E -e "s/$ACTION_ARCH_FILTERS//"  -e "s#$OTHER_FILTERS##" -e "s/$AUID_FILTERS//" -e "s/((:?-S [[:alnum:],]+)+)//g" -e "s/-F key=\w+|-k \w+//"<<< "$s_rule")
            grep -q -- "-F" <<< "$extra_fields"
            if [ $? -ne 0 ]
            then
                candidate_rules+=("$s_rule")
            fi
        done
    
        if [[ ${#syscall_a[@]} -ge 1 ]]
        then
            # Check if the syscall we want is present in any of the similar existing rules
            for rule in "${candidate_rules[@]}"
            do
                rule_syscalls=$(echo "$rule" | grep -o -P '(-S [\w,]+)+' | xargs)
                all_syscalls_found=0
                for syscall in "${syscall_a[@]}"
                do
                    grep -q -- "\b${syscall}\b" <<< "$rule_syscalls"
                    if [ $? -eq 1 ]
                    then
                        # A syscall was not found in the candidate rule
                        all_syscalls_found=1
                    fi
                done
                if [[ $all_syscalls_found -eq 0 ]]
                then
                    # We found a rule with all the syscall(s) we want; skip rest of macro
                    skip=0
                    break
                fi
    
                # Check if this rule can be grouped with our target syscall and keep track of it
                for syscall_g in "${syscall_grouping[@]}"
                do
                    if grep -q -- "\b${syscall_g}\b" <<< "$rule_syscalls"
                    then
                        file_to_edit=${audit_file}
                        rule_to_edit=${rule}
                        rule_syscalls_to_edit=${rule_syscalls}
                    fi
                done
            done
        else
            # If there is any candidate rule, it is compliant; skip rest of macro
            if [[ $candidate_rules ]]
            then
                skip=0
            fi
        fi
    
        if [ "$skip" -eq 0 ]; then
            break
        fi
    done
    
    if [ "$skip" -ne 0 ]; then
        # We checked all rules that matched the expected resemblance pattern (action, arch & auid)
        # At this point we know if we need to either append the $full_rule or group
        # the syscall together with an exsiting rule
    
        # Append the full_rule if it cannot be grouped to any other rule
        if [ -z ${rule_to_edit+x} ]
        then
            # Build full_rule while avoid adding double spaces when other_filters is empty
            if [[ ${syscall_a} ]]
            then
                syscall_string=""
                for syscall in "${syscall_a[@]}"
                do
                    syscall_string+=" -S $syscall"
                done
            fi
            other_string=$([[ $OTHER_FILTERS ]] && echo " $OTHER_FILTERS")
            auid_string=$([[ $AUID_FILTERS ]] && echo " $AUID_FILTERS")
            full_rule="$ACTION_ARCH_FILTERS${syscall_string}${other_string}${auid_string} -F key=$KEY"
            echo "$full_rule" >> "$default_file"
            chmod o-rwx ${default_file}
        else
            # Check if the syscalls are declared as a comma separated list or
            # as multiple -S parameters
            if grep -q -- "," <<< "${rule_syscalls_to_edit}"
            then
                delimiter=","
            else
                delimiter=" -S "
            fi
            new_grouped_syscalls="${rule_syscalls_to_edit}"
            for syscall in "${syscall_a[@]}"
            do
                grep -q -- "\b${syscall}\b" <<< "${rule_syscalls_to_edit}"
                if [ $? -eq 1 ]
                then
                    # A syscall was not found in the candidate rule
                    new_grouped_syscalls+="${delimiter}${syscall}"
                fi
            done
    
            # Group the syscall in the rule
            sed -i -e "\#${rule_to_edit}#s#${rule_syscalls_to_edit}#${new_grouped_syscalls}#" "$file_to_edit"
        fi
    fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Service facts
      service_facts: null
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83555-3
        - DISA-STIG-RHEL-07-030360
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(3)
        - NIST-800-53-AU-7(a)
        - NIST-800-53-AU-7(b)
        - NIST-800-53-AU-8(b)
        - NIST-800-53-CM-5(1)
        - audit_rules_suid_privilege_function
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Check the rules script being used
      command: grep '^ExecStartPost' /usr/lib/systemd/system/auditd.service
      register: check_rules_scripts_result
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83555-3
        - DISA-STIG-RHEL-07-030360
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(3)
        - NIST-800-53-AU-7(a)
        - NIST-800-53-AU-7(b)
        - NIST-800-53-AU-8(b)
        - NIST-800-53-CM-5(1)
        - audit_rules_suid_privilege_function
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Set suid_audit_rules fact
      set_fact:
        suid_audit_rules:
          - -a always,exit -F arch=b32 -S execve -C gid!=egid -F egid=0 -k setgid
          - -a always,exit -F arch=b64 -S execve -C gid!=egid -F egid=0 -k setgid
          - -a always,exit -F arch=b32 -S execve -C uid!=euid -F euid=0 -k setuid
          - -a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -k setuid
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83555-3
        - DISA-STIG-RHEL-07-030360
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(3)
        - NIST-800-53-AU-7(a)
        - NIST-800-53-AU-7(b)
        - NIST-800-53-AU-8(b)
        - NIST-800-53-CM-5(1)
        - audit_rules_suid_privilege_function
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Update /etc/audit/rules.d/privileged.rules to audit privileged functions
      lineinfile:
        path: /etc/audit/rules.d/privileged.rules
        line: '{{  item  }}'
        create: true
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - '"auditd.service" in ansible_facts.services'
        - '"augenrules" in check_rules_scripts_result.stdout'
      register: augenrules_audit_rules_privilege_function_update_result
      with_items: '{{ suid_audit_rules }}'
      tags:
        - CCE-83555-3
        - DISA-STIG-RHEL-07-030360
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(3)
        - NIST-800-53-AU-7(a)
        - NIST-800-53-AU-7(b)
        - NIST-800-53-AU-8(b)
        - NIST-800-53-CM-5(1)
        - audit_rules_suid_privilege_function
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Update Update /etc/audit/audit.rules to audit privileged functions
      lineinfile:
        path: /etc/audit/audit.rules
        line: '{{  item  }}'
        create: true
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - '"auditd.service" in ansible_facts.services'
        - '"auditctl" in check_rules_scripts_result.stdout'
      register: auditctl_audit_rules_privilege_function_update_result
      with_items: '{{ suid_audit_rules }}'
      tags:
        - CCE-83555-3
        - DISA-STIG-RHEL-07-030360
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(3)
        - NIST-800-53-AU-7(a)
        - NIST-800-53-AU-7(b)
        - NIST-800-53-AU-8(b)
        - NIST-800-53-CM-5(1)
        - audit_rules_suid_privilege_function
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Reload Auditd
      command: /usr/sbin/service auditd reload
      args:
        warn: false
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - (augenrules_audit_rules_privilege_function_update_result.changed or auditctl_audit_rules_privilege_function_update_result.changed)
        - ansible_facts.services["auditd.service"].state == "running"
      tags:
        - CCE-83555-3
        - DISA-STIG-RHEL-07-030360
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(3)
        - NIST-800-53-AU-7(a)
        - NIST-800-53-AU-7(b)
        - NIST-800-53-AU-8(b)
        - NIST-800-53-CM-5(1)
        - audit_rules_suid_privilege_function
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Ensure auditd Collects System Administrator Actions   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_sysadmin_actions)rule

At a minimum, the audit system should collect administrator actions for all users and root. If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-w /etc/sudoers -p wa -k actions
-w /etc/sudoers.d/ -p wa -k actions

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to `/etc/audit/audit.rules` file:

\-w /etc/sudoers -p wa -k actions
-w /etc/sudoers.d/ -p wa -k actions

Rationale:

The actions taken by system administrators should be audited to keep a record of what was executed on the system, as well as, for accountability purposes.

Severity:  medium

Identifiers:  CCE-27461-3

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [AC-2(7)(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.2](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [Req-10.2.5.b](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000004-GPOS-00004](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000470-GPOS-00214](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000239-GPOS-00089](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000240-GPOS-00090](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000241-GPOS-00091](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000303-GPOS-00120](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), CCI-002884, [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000476-GPOS-00221](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000462-VMM-001840, SRG-OS-000471-VMM-001910, [RHEL-07-030700](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204549r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.14](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    
    # If the audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # into the list of files to be inspected
    files_to_inspect+=('/etc/audit/audit.rules')
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/sudoers" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/sudoers -p wa -k actions" >> "$audit_rules_file"
        fi
    done
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    # If the audit is 'augenrules', then check if rule is already defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to list of files for inspection.
    # If rule isn't defined, add '/etc/audit/rules.d/actions.rules' to list of files for inspection.
    readarray -t matches < <(grep -P "[\s]*-w[\s]+/etc/sudoers" /etc/audit/rules.d/*.rules)
    
    # For each of the matched entries
    for match in "${matches[@]}"
    do
        # Extract filepath from the match
        rulesd_audit_file=$(echo $match | cut -f1 -d ':')
        # Append that path into list of files for inspection
        files_to_inspect+=("$rulesd_audit_file")
    done
    # Case when particular audit rule isn't defined yet
    if [ "${#files_to_inspect[@]}" -eq "0" ]
    then
        # Append '/etc/audit/rules.d/actions.rules' into list of files for inspection
        key_rule_file="/etc/audit/rules.d/actions.rules"
        # If the actions.rules file doesn't exist yet, create it with correct permissions
        if [ ! -e "$key_rule_file" ]
        then
            touch "$key_rule_file"
            chmod 0640 "$key_rule_file"
        fi
        files_to_inspect+=("$key_rule_file")
    fi
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/sudoers" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/sudoers -p wa -k actions" >> "$audit_rules_file"
        fi
    done
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    
    # If the audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # into the list of files to be inspected
    files_to_inspect+=('/etc/audit/audit.rules')
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/sudoers.d/" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/sudoers.d/ -p wa -k actions" >> "$audit_rules_file"
        fi
    done
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    # If the audit is 'augenrules', then check if rule is already defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to list of files for inspection.
    # If rule isn't defined, add '/etc/audit/rules.d/actions.rules' to list of files for inspection.
    readarray -t matches < <(grep -P "[\s]*-w[\s]+/etc/sudoers.d/" /etc/audit/rules.d/*.rules)
    
    # For each of the matched entries
    for match in "${matches[@]}"
    do
        # Extract filepath from the match
        rulesd_audit_file=$(echo $match | cut -f1 -d ':')
        # Append that path into list of files for inspection
        files_to_inspect+=("$rulesd_audit_file")
    done
    # Case when particular audit rule isn't defined yet
    if [ "${#files_to_inspect[@]}" -eq "0" ]
    then
        # Append '/etc/audit/rules.d/actions.rules' into list of files for inspection
        key_rule_file="/etc/audit/rules.d/actions.rules"
        # If the actions.rules file doesn't exist yet, create it with correct permissions
        if [ ! -e "$key_rule_file" ]
        then
            touch "$key_rule_file"
            chmod 0640 "$key_rule_file"
        fi
        files_to_inspect+=("$key_rule_file")
    fi
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/sudoers.d/" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/sudoers.d/ -p wa -k actions" >> "$audit_rules_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Search /etc/audit/rules.d for audit rule entries for sysadmin actions
      find:
        paths: /etc/audit/rules.d
        recurse: false
        contains: ^.*/etc/sudoers.*$
        patterns: '*.rules'
      register: find_audit_sysadmin_actions
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27461-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030700
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(7)(b)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.2
        - PCI-DSS-Req-10.2.5.b
        - audit_rules_sysadmin_actions
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Use /etc/audit/rules.d/actions.rules as the recipient for the rule
      set_fact:
        all_sysadmin_actions_files:
          - /etc/audit/rules.d/actions.rules
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_audit_sysadmin_actions.matched is defined and find_audit_sysadmin_actions.matched
          == 0
      tags:
        - CCE-27461-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030700
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(7)(b)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.2
        - PCI-DSS-Req-10.2.5.b
        - audit_rules_sysadmin_actions
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Use matched file as the recipient for the rule
      set_fact:
        all_sysadmin_actions_files:
          - '{{ find_audit_sysadmin_actions.files | map(attribute=''path'') | list | first
            }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_audit_sysadmin_actions.matched is defined and find_audit_sysadmin_actions.matched
          > 0
      tags:
        - CCE-27461-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030700
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(7)(b)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.2
        - PCI-DSS-Req-10.2.5.b
        - audit_rules_sysadmin_actions
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Inserts/replaces audit rule for /etc/sudoers rule in rules.d
      lineinfile:
        path: '{{ all_sysadmin_actions_files[0] }}'
        line: -w /etc/sudoers -p wa -k actions
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27461-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030700
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(7)(b)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.2
        - PCI-DSS-Req-10.2.5.b
        - audit_rules_sysadmin_actions
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Inserts/replaces audit rule for /etc/sudoers.d rule in rules.d
      lineinfile:
        path: '{{ all_sysadmin_actions_files[0] }}'
        line: -w /etc/sudoers.d/ -p wa -k actions
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27461-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030700
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(7)(b)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.2
        - PCI-DSS-Req-10.2.5.b
        - audit_rules_sysadmin_actions
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Inserts/replaces audit rule for /etc/sudoers in audit.rules
      lineinfile:
        path: /etc/audit/audit.rules
        line: -w /etc/sudoers -p wa -k actions
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27461-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030700
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(7)(b)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.2
        - PCI-DSS-Req-10.2.5.b
        - audit_rules_sysadmin_actions
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    
    - name: Inserts/replaces audit rule for /etc/sudoers.d in audit.rules
      lineinfile:
        path: /etc/audit/audit.rules
        line: -w /etc/sudoers.d/ -p wa -k actions
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27461-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030700
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(7)(b)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.2
        - PCI-DSS-Req-10.2.5.b
        - audit_rules_sysadmin_actions
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

Remediation script:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,-w%20/etc/sudoers.d/%20-p%20wa%20-k%20actions%0A-w%20/etc/sudoers%20-p%20wa%20-k%20actions%0A
            mode: 0600
            path: /etc/audit/rules.d/75-audit-sysadmin-actions.rules
            overwrite: true
    

#### Shutdown System When Auditing Failures Occur   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_system_shutdown)rule

If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following line to a file with suffix `.rules` in the directory `/etc/audit/rules.d`:

\-f 2

If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following line to the top of the `/etc/audit/audit.rules` file:

\-f 2

Rationale:

It is critical for the appropriate personnel to be aware if a system is at risk of failing to process audit logs as required. Without this notification, the security personnel may be unaware of an impending failure of the audit capability, and system operation may be adversely affected.  
  
Audit processing failures include software/hardware errors, failures in the audit capturing mechanisms, and audit storage capacity being reached or exceeded.

Severity:  medium

Identifiers:  CCE-80997-0

References:  [1](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.3.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.3.4](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000139](https://public.cyber.mil/stigs/cci/), [CCI-000140](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [AU-5(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-24](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000046-GPOS-00022](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000047-GPOS-00023](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000047-VMM-000220, [RHEL-07-030010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204504r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Traverse all of:
    #
    # /etc/audit/audit.rules,			(for auditctl case)
    # /etc/audit/rules.d/*.rules			(for augenrules case)
    find /etc/audit /etc/audit/rules.d -maxdepth 1 -type f -name '*.rules' -exec sed -i '/-f[[:space:]]\+.*/d' {} ';'
    
    for AUDIT_FILE in "/etc/audit/audit.rules" "/etc/audit/rules.d/immutable.rules"
    do
    	echo '' >> $AUDIT_FILE
    	echo '# Set the audit.rules configuration to halt system upon audit failure per security requirements' >> $AUDIT_FILE
    	echo '-f 2' >> $AUDIT_FILE
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Collect all files from /etc/audit/rules.d with .rules extension
      find:
        paths: /etc/audit/rules.d/
        patterns: '*.rules'
      register: find_rules_d
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80997-0
        - DISA-STIG-RHEL-07-030010
        - NIST-800-171-3.3.1
        - NIST-800-171-3.3.4
        - NIST-800-53-AU-5(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-24
        - audit_rules_system_shutdown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Remove the -f option from all Audit config files
      lineinfile:
        path: '{{ item }}'
        regexp: ^\s*(?:-f)\s+.*$
        state: absent
      loop: '{{ find_rules_d.files | map(attribute=''path'') | list + [''/etc/audit/audit.rules'']
        }}'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80997-0
        - DISA-STIG-RHEL-07-030010
        - NIST-800-171-3.3.1
        - NIST-800-171-3.3.4
        - NIST-800-53-AU-5(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-24
        - audit_rules_system_shutdown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Add Audit -f option into /etc/audit/rules.d/immutable.rules and /etc/audit/audit.rules
      lineinfile:
        path: '{{ item }}'
        create: true
        line: -f 2
      loop:
        - /etc/audit/audit.rules
        - /etc/audit/rules.d/immutable.rules
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80997-0
        - DISA-STIG-RHEL-07-030010
        - NIST-800-171-3.3.1
        - NIST-800-171-3.3.4
        - NIST-800-53-AU-5(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-24
        - audit_rules_system_shutdown
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify User/Group Information - /etc/group   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_usergroup_modification_group)rule

If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, in order to capture events that modify account changes:  
  

\-w /etc/group -p wa -k audit\_rules\_usergroup\_modification

  
  
If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file, in order to capture events that modify account changes:  
  

\-w /etc/group -p wa -k audit\_rules\_usergroup\_modification

Rationale:

In addition to auditing new user and group accounts, these watches will alert the system administrator(s) to any modifications. Any unexpected users, groups, or modifications should be investigated for legitimacy.

Severity:  medium

Identifiers:  CCE-80433-6

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000018](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-001403](https://public.cyber.mil/stigs/cci/), [CCI-001404](https://public.cyber.mil/stigs/cci/), [CCI-001405](https://public.cyber.mil/stigs/cci/), [CCI-001683](https://public.cyber.mil/stigs/cci/), [CCI-001684](https://public.cyber.mil/stigs/cci/), [CCI-001685](https://public.cyber.mil/stigs/cci/), [CCI-001686](https://public.cyber.mil/stigs/cci/), [CCI-002130](https://public.cyber.mil/stigs/cci/), [CCI-002132](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000004-GPOS-00004](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000470-GPOS-00214](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000239-GPOS-00089](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000240-GPOS-00090](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000241-GPOS-00091](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000303-GPOS-00120](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), CCI-002884, [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000476-GPOS-00221](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000004-VMM-000040, SRG-OS-000239-VMM-000810, SRG-OS-000240-VMM-000820, SRG-OS-000241-VMM-000830, SRG-OS-000274-VMM-000960, SRG-OS-000275-VMM-000970, SRG-OS-000276-VMM-000980, SRG-OS-000277-VMM-000990, SRG-OS-000303-VMM-001090, SRG-OS-000304-VMM-001100, SRG-OS-000476-VMM-001960, [RHEL-07-030871](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204565r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    
    # If the audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # into the list of files to be inspected
    files_to_inspect+=('/etc/audit/audit.rules')
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/group" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/group -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    # If the audit is 'augenrules', then check if rule is already defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to list of files for inspection.
    # If rule isn't defined, add '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' to list of files for inspection.
    readarray -t matches < <(grep -P "[\s]*-w[\s]+/etc/group" /etc/audit/rules.d/*.rules)
    
    # For each of the matched entries
    for match in "${matches[@]}"
    do
        # Extract filepath from the match
        rulesd_audit_file=$(echo $match | cut -f1 -d ':')
        # Append that path into list of files for inspection
        files_to_inspect+=("$rulesd_audit_file")
    done
    # Case when particular audit rule isn't defined yet
    if [ "${#files_to_inspect[@]}" -eq "0" ]
    then
        # Append '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' into list of files for inspection
        key_rule_file="/etc/audit/rules.d/audit_rules_usergroup_modification.rules"
        # If the audit_rules_usergroup_modification.rules file doesn't exist yet, create it with correct permissions
        if [ ! -e "$key_rule_file" ]
        then
            touch "$key_rule_file"
            chmod 0640 "$key_rule_file"
        fi
        files_to_inspect+=("$key_rule_file")
    fi
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/group" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/group -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit group tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80433-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030871
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_group
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Search /etc/audit/rules.d for other user/group modification audit rules
      find:
        paths: /etc/audit/rules.d
        recurse: false
        contains: -k audit_rules_usergroup_modification$
        patterns: '*.rules'
      register: find_group
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80433-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030871
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_group
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: If existing user/group modification ruleset not found, use /etc/audit/rules.d/privileged.rules
        as the recipient for the rule
      set_fact:
        all_files:
          - /etc/audit/rules.d/privileged.rules
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_group.matched is defined and find_group.matched == 0
      tags:
        - CCE-80433-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030871
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_group
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Use matched file as the recipient for the rule
      set_fact:
        all_files:
          - '{{ find_group.files | map(attribute=''path'') | list | first }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_group.matched is defined and find_group.matched > 0
      tags:
        - CCE-80433-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030871
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_group
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the group rule in rules.d when on x86
      lineinfile:
        path: '{{ all_files[0] }}'
        line: -w /etc/group -p wa -k audit_rules_usergroup_modification
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80433-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030871
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_group
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the group rule in /etc/audit/audit.rules
      lineinfile:
        line: -w /etc/group -p wa -k audit_rules_usergroup_modification
        state: present
        dest: /etc/audit/audit.rules
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80433-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030871
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_group
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify User/Group Information - /etc/gshadow   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_usergroup_modification_gshadow)rule

If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, in order to capture events that modify account changes:  
  

\-w /etc/gshadow -p wa -k audit\_rules\_usergroup\_modification

  
  
If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file, in order to capture events that modify account changes:  
  

\-w /etc/gshadow -p wa -k audit\_rules\_usergroup\_modification

Rationale:

In addition to auditing new user and group accounts, these watches will alert the system administrator(s) to any modifications. Any unexpected users, groups, or modifications should be investigated for legitimacy.

Severity:  medium

Identifiers:  CCE-80432-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000018](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-001403](https://public.cyber.mil/stigs/cci/), [CCI-001404](https://public.cyber.mil/stigs/cci/), [CCI-001405](https://public.cyber.mil/stigs/cci/), [CCI-001683](https://public.cyber.mil/stigs/cci/), [CCI-001684](https://public.cyber.mil/stigs/cci/), [CCI-001685](https://public.cyber.mil/stigs/cci/), [CCI-001686](https://public.cyber.mil/stigs/cci/), [CCI-002130](https://public.cyber.mil/stigs/cci/), [CCI-002132](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000004-GPOS-00004](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000470-GPOS-00214](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000239-GPOS-00089](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000240-GPOS-00090](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000241-GPOS-00091](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000303-GPOS-00120](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000476-GPOS-00221](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000004-VMM-000040, SRG-OS-000239-VMM-000810, SRG-OS-000240-VMM-000820, SRG-OS-000241-VMM-000830, SRG-OS-000274-VMM-000960, SRG-OS-000275-VMM-000970, SRG-OS-000276-VMM-000980, SRG-OS-000277-VMM-000990, SRG-OS-000303-VMM-001090, SRG-OS-000304-VMM-001100, SRG-OS-000476-VMM-001960, [RHEL-07-030872](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204566r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    
    # If the audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # into the list of files to be inspected
    files_to_inspect+=('/etc/audit/audit.rules')
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/gshadow" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/gshadow -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    # If the audit is 'augenrules', then check if rule is already defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to list of files for inspection.
    # If rule isn't defined, add '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' to list of files for inspection.
    readarray -t matches < <(grep -P "[\s]*-w[\s]+/etc/gshadow" /etc/audit/rules.d/*.rules)
    
    # For each of the matched entries
    for match in "${matches[@]}"
    do
        # Extract filepath from the match
        rulesd_audit_file=$(echo $match | cut -f1 -d ':')
        # Append that path into list of files for inspection
        files_to_inspect+=("$rulesd_audit_file")
    done
    # Case when particular audit rule isn't defined yet
    if [ "${#files_to_inspect[@]}" -eq "0" ]
    then
        # Append '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' into list of files for inspection
        key_rule_file="/etc/audit/rules.d/audit_rules_usergroup_modification.rules"
        # If the audit_rules_usergroup_modification.rules file doesn't exist yet, create it with correct permissions
        if [ ! -e "$key_rule_file" ]
        then
            touch "$key_rule_file"
            chmod 0640 "$key_rule_file"
        fi
        files_to_inspect+=("$key_rule_file")
    fi
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/gshadow" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/gshadow -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit gshadow tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80432-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030872
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_gshadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Search /etc/audit/rules.d for other user/group modification audit rules
      find:
        paths: /etc/audit/rules.d
        recurse: false
        contains: -k audit_rules_usergroup_modification$
        patterns: '*.rules'
      register: find_gshadow
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80432-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030872
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_gshadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: If existing user/group modification ruleset not found, use /etc/audit/rules.d/privileged.rules
        as the recipient for the rule
      set_fact:
        all_files:
          - /etc/audit/rules.d/privileged.rules
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_gshadow.matched is defined and find_gshadow.matched == 0
      tags:
        - CCE-80432-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030872
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_gshadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Use matched file as the recipient for the rule
      set_fact:
        all_files:
          - '{{ find_gshadow.files | map(attribute=''path'') | list | first }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_gshadow.matched is defined and find_gshadow.matched > 0
      tags:
        - CCE-80432-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030872
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_gshadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the gshadow rule in rules.d when on x86
      lineinfile:
        path: '{{ all_files[0] }}'
        line: -w /etc/gshadow -p wa -k audit_rules_usergroup_modification
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80432-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030872
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_gshadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the gshadow rule in /etc/audit/audit.rules
      lineinfile:
        line: -w /etc/gshadow -p wa -k audit_rules_usergroup_modification
        state: present
        dest: /etc/audit/audit.rules
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80432-8
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030872
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_gshadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify User/Group Information - /etc/security/opasswd   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_usergroup_modification_opasswd)rule

If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, in order to capture events that modify account changes:  
  

\-w /etc/security/opasswd -p wa -k audit\_rules\_usergroup\_modification

  
  
If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file, in order to capture events that modify account changes:  
  

\-w /etc/security/opasswd -p wa -k audit\_rules\_usergroup\_modification

Rationale:

In addition to auditing new user and group accounts, these watches will alert the system administrator(s) to any modifications. Any unexpected users, groups, or modifications should be investigated for legitimacy.

Severity:  medium

Identifiers:  CCE-80430-2

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000018](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-001403](https://public.cyber.mil/stigs/cci/), [CCI-001404](https://public.cyber.mil/stigs/cci/), [CCI-001405](https://public.cyber.mil/stigs/cci/), [CCI-001683](https://public.cyber.mil/stigs/cci/), [CCI-001684](https://public.cyber.mil/stigs/cci/), [CCI-001685](https://public.cyber.mil/stigs/cci/), [CCI-001686](https://public.cyber.mil/stigs/cci/), [CCI-002130](https://public.cyber.mil/stigs/cci/), [CCI-002132](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000004-GPOS-00004](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000470-GPOS-00214](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000239-GPOS-00089](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000240-GPOS-00090](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000241-GPOS-00091](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000303-GPOS-00120](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000476-GPOS-00221](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000463-GPOS-00207](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000004-VMM-000040, SRG-OS-000239-VMM-000810, SRG-OS-000240-VMM-000820, SRG-OS-000241-VMM-000830, SRG-OS-000274-VMM-000960, SRG-OS-000275-VMM-000970, SRG-OS-000276-VMM-000980, SRG-OS-000277-VMM-000990, SRG-OS-000303-VMM-001090, SRG-OS-000304-VMM-001100, SRG-OS-000476-VMM-001960, [RHEL-07-030874](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204568r744115\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    
    # If the audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # into the list of files to be inspected
    files_to_inspect+=('/etc/audit/audit.rules')
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/security/opasswd" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/security/opasswd -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    # If the audit is 'augenrules', then check if rule is already defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to list of files for inspection.
    # If rule isn't defined, add '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' to list of files for inspection.
    readarray -t matches < <(grep -P "[\s]*-w[\s]+/etc/security/opasswd" /etc/audit/rules.d/*.rules)
    
    # For each of the matched entries
    for match in "${matches[@]}"
    do
        # Extract filepath from the match
        rulesd_audit_file=$(echo $match | cut -f1 -d ':')
        # Append that path into list of files for inspection
        files_to_inspect+=("$rulesd_audit_file")
    done
    # Case when particular audit rule isn't defined yet
    if [ "${#files_to_inspect[@]}" -eq "0" ]
    then
        # Append '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' into list of files for inspection
        key_rule_file="/etc/audit/rules.d/audit_rules_usergroup_modification.rules"
        # If the audit_rules_usergroup_modification.rules file doesn't exist yet, create it with correct permissions
        if [ ! -e "$key_rule_file" ]
        then
            touch "$key_rule_file"
            chmod 0640 "$key_rule_file"
        fi
        files_to_inspect+=("$key_rule_file")
    fi
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/security/opasswd" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/security/opasswd -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit opasswd tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80430-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030874
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_opasswd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Search /etc/audit/rules.d for other user/group modification audit rules
      find:
        paths: /etc/audit/rules.d
        recurse: false
        contains: -k audit_rules_usergroup_modification$
        patterns: '*.rules'
      register: find_opasswd
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80430-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030874
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_opasswd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: If existing user/group modification ruleset not found, use /etc/audit/rules.d/privileged.rules
        as the recipient for the rule
      set_fact:
        all_files:
          - /etc/audit/rules.d/privileged.rules
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_opasswd.matched is defined and find_opasswd.matched == 0
      tags:
        - CCE-80430-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030874
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_opasswd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Use matched file as the recipient for the rule
      set_fact:
        all_files:
          - '{{ find_opasswd.files | map(attribute=''path'') | list | first }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_opasswd.matched is defined and find_opasswd.matched > 0
      tags:
        - CCE-80430-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030874
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_opasswd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the opasswd rule in rules.d when on x86
      lineinfile:
        path: '{{ all_files[0] }}'
        line: -w /etc/security/opasswd -p wa -k audit_rules_usergroup_modification
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80430-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030874
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_opasswd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the opasswd rule in /etc/audit/audit.rules
      lineinfile:
        line: -w /etc/security/opasswd -p wa -k audit_rules_usergroup_modification
        state: present
        dest: /etc/audit/audit.rules
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80430-2
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030874
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_opasswd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify User/Group Information - /etc/passwd   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_usergroup_modification_passwd)rule

If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, in order to capture events that modify account changes:  
  

\-w /etc/passwd -p wa -k audit\_rules\_usergroup\_modification

  
  
If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file, in order to capture events that modify account changes:  
  

\-w /etc/passwd -p wa -k audit\_rules\_usergroup\_modification

Rationale:

In addition to auditing new user and group accounts, these watches will alert the system administrator(s) to any modifications. Any unexpected users, groups, or modifications should be investigated for legitimacy.

Severity:  medium

Identifiers:  CCE-80435-1

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000018](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-001403](https://public.cyber.mil/stigs/cci/), [CCI-001404](https://public.cyber.mil/stigs/cci/), [CCI-001405](https://public.cyber.mil/stigs/cci/), [CCI-001683](https://public.cyber.mil/stigs/cci/), [CCI-001684](https://public.cyber.mil/stigs/cci/), [CCI-001685](https://public.cyber.mil/stigs/cci/), [CCI-001686](https://public.cyber.mil/stigs/cci/), [CCI-002130](https://public.cyber.mil/stigs/cci/), [CCI-002132](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000004-GPOS-00004](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000470-GPOS-00214](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000239-GPOS-00089](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000240-GPOS-00090](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000241-GPOS-00091](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000303-GPOS-00120](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000476-GPOS-00221](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000274-GPOS-00104](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000275-GPOS-00105](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000276-GPOS-00106](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000277-GPOS-00107](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000004-VMM-000040, SRG-OS-000239-VMM-000810, SRG-OS-000240-VMM-000820, SRG-OS-000241-VMM-000830, SRG-OS-000274-VMM-000960, SRG-OS-000275-VMM-000970, SRG-OS-000276-VMM-000980, SRG-OS-000277-VMM-000990, SRG-OS-000303-VMM-001090, SRG-OS-000304-VMM-001100, SRG-OS-000476-VMM-001960, [RHEL-07-030870](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204564r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    
    # If the audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # into the list of files to be inspected
    files_to_inspect+=('/etc/audit/audit.rules')
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/passwd" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/passwd -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    # If the audit is 'augenrules', then check if rule is already defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to list of files for inspection.
    # If rule isn't defined, add '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' to list of files for inspection.
    readarray -t matches < <(grep -P "[\s]*-w[\s]+/etc/passwd" /etc/audit/rules.d/*.rules)
    
    # For each of the matched entries
    for match in "${matches[@]}"
    do
        # Extract filepath from the match
        rulesd_audit_file=$(echo $match | cut -f1 -d ':')
        # Append that path into list of files for inspection
        files_to_inspect+=("$rulesd_audit_file")
    done
    # Case when particular audit rule isn't defined yet
    if [ "${#files_to_inspect[@]}" -eq "0" ]
    then
        # Append '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' into list of files for inspection
        key_rule_file="/etc/audit/rules.d/audit_rules_usergroup_modification.rules"
        # If the audit_rules_usergroup_modification.rules file doesn't exist yet, create it with correct permissions
        if [ ! -e "$key_rule_file" ]
        then
            touch "$key_rule_file"
            chmod 0640 "$key_rule_file"
        fi
        files_to_inspect+=("$key_rule_file")
    fi
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/passwd" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/passwd -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit passwd tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80435-1
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030870
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_passwd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Search /etc/audit/rules.d for other user/group modification audit rules
      find:
        paths: /etc/audit/rules.d
        recurse: false
        contains: -k audit_rules_usergroup_modification$
        patterns: '*.rules'
      register: find_passwd
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80435-1
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030870
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_passwd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: If existing user/group modification ruleset not found, use /etc/audit/rules.d/privileged.rules
        as the recipient for the rule
      set_fact:
        all_files:
          - /etc/audit/rules.d/privileged.rules
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_passwd.matched is defined and find_passwd.matched == 0
      tags:
        - CCE-80435-1
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030870
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_passwd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Use matched file as the recipient for the rule
      set_fact:
        all_files:
          - '{{ find_passwd.files | map(attribute=''path'') | list | first }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_passwd.matched is defined and find_passwd.matched > 0
      tags:
        - CCE-80435-1
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030870
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_passwd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the passwd rule in rules.d when on x86
      lineinfile:
        path: '{{ all_files[0] }}'
        line: -w /etc/passwd -p wa -k audit_rules_usergroup_modification
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80435-1
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030870
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_passwd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the passwd rule in /etc/audit/audit.rules
      lineinfile:
        line: -w /etc/passwd -p wa -k audit_rules_usergroup_modification
        state: present
        dest: /etc/audit/audit.rules
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80435-1
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030870
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_passwd
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### Record Events that Modify User/Group Information - /etc/shadow   [\[ref\]](#xccdf_org.ssgproject.content_rule_audit_rules_usergroup_modification_shadow)rule

If the `auditd` daemon is configured to use the `augenrules` program to read audit rules during daemon startup (the default), add the following lines to a file with suffix `.rules` in the directory `/etc/audit/rules.d`, in order to capture events that modify account changes:  
  

\-w /etc/shadow -p wa -k audit\_rules\_usergroup\_modification

  
  
If the `auditd` daemon is configured to use the `auditctl` utility to read audit rules during daemon startup, add the following lines to `/etc/audit/audit.rules` file, in order to capture events that modify account changes:  
  

\-w /etc/shadow -p wa -k audit\_rules\_usergroup\_modification

Rationale:

In addition to auditing new user and group accounts, these watches will alert the system administrator(s) to any modifications. Any unexpected users, groups, or modifications should be investigated for legitimacy.

Severity:  medium

Identifiers:  CCE-80431-0

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000018](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [CCI-000172](https://public.cyber.mil/stigs/cci/), [CCI-001403](https://public.cyber.mil/stigs/cci/), [CCI-001404](https://public.cyber.mil/stigs/cci/), [CCI-001405](https://public.cyber.mil/stigs/cci/), [CCI-001683](https://public.cyber.mil/stigs/cci/), [CCI-001684](https://public.cyber.mil/stigs/cci/), [CCI-001685](https://public.cyber.mil/stigs/cci/), [CCI-001686](https://public.cyber.mil/stigs/cci/), [CCI-002130](https://public.cyber.mil/stigs/cci/), [CCI-002132](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(d)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [Req-10.2.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000004-GPOS-00004](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000462-GPOS-00206](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000470-GPOS-00214](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000471-GPOS-00215](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000239-GPOS-00089](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000240-GPOS-00090](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000241-GPOS-00091](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000303-GPOS-00120](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000304-GPOS-00121](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000466-GPOS-00210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000476-GPOS-00221](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000004-VMM-000040, SRG-OS-000239-VMM-000810, SRG-OS-000240-VMM-000820, SRG-OS-000241-VMM-000830, SRG-OS-000274-VMM-000960, SRG-OS-000275-VMM-000970, SRG-OS-000276-VMM-000980, SRG-OS-000277-VMM-000990, SRG-OS-000303-VMM-001090, SRG-OS-000304-VMM-001100, SRG-OS-000476-VMM-001960, [RHEL-07-030873](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204567r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Perform the remediation for both possible tools: 'auditctl' and 'augenrules'
    
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    
    # If the audit tool is 'auditctl', then add '/etc/audit/audit.rules'
    # into the list of files to be inspected
    files_to_inspect+=('/etc/audit/audit.rules')
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/shadow" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/shadow -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    # Create a list of audit *.rules files that should be inspected for presence and correctness
    # of a particular audit rule. The scheme is as follows:
    #
    # -----------------------------------------------------------------------------------------
    # Tool used to load audit rules	| Rule already defined	|  Audit rules file to inspect	  |
    # -----------------------------------------------------------------------------------------
    #	auditctl		|     Doesn't matter	|  /etc/audit/audit.rules	  |
    # -----------------------------------------------------------------------------------------
    # 	augenrules		|          Yes		|  /etc/audit/rules.d/*.rules	  |
    # 	augenrules		|          No		|  /etc/audit/rules.d/$key.rules  |
    # -----------------------------------------------------------------------------------------
    files_to_inspect=()
    
    # If the audit is 'augenrules', then check if rule is already defined
    # If rule is defined, add '/etc/audit/rules.d/*.rules' to list of files for inspection.
    # If rule isn't defined, add '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' to list of files for inspection.
    readarray -t matches < <(grep -P "[\s]*-w[\s]+/etc/shadow" /etc/audit/rules.d/*.rules)
    
    # For each of the matched entries
    for match in "${matches[@]}"
    do
        # Extract filepath from the match
        rulesd_audit_file=$(echo $match | cut -f1 -d ':')
        # Append that path into list of files for inspection
        files_to_inspect+=("$rulesd_audit_file")
    done
    # Case when particular audit rule isn't defined yet
    if [ "${#files_to_inspect[@]}" -eq "0" ]
    then
        # Append '/etc/audit/rules.d/audit_rules_usergroup_modification.rules' into list of files for inspection
        key_rule_file="/etc/audit/rules.d/audit_rules_usergroup_modification.rules"
        # If the audit_rules_usergroup_modification.rules file doesn't exist yet, create it with correct permissions
        if [ ! -e "$key_rule_file" ]
        then
            touch "$key_rule_file"
            chmod 0640 "$key_rule_file"
        fi
        files_to_inspect+=("$key_rule_file")
    fi
    
    # Finally perform the inspection and possible subsequent audit rule
    # correction for each of the files previously identified for inspection
    for audit_rules_file in "${files_to_inspect[@]}"
    do
        # Check if audit watch file system object rule for given path already present
        if grep -q -P -- "[\s]*-w[\s]+/etc/shadow" "$audit_rules_file"
        then
            # Rule is found => verify yet if existing rule definition contains
            # all of the required access type bits
    
            # Escape slashes in path for use in sed pattern below
            esc_path=${path//$'/'/$'\/'}
            # Define BRE whitespace class shortcut
            sp="[[:space:]]"
            # Extract current permission access types (e.g. -p [r|w|x|a] values) from audit rule
            current_access_bits=$(sed -ne "s/$sp*-w$sp\+$esc_path$sp\+-p$sp\+\([rxwa]\{1,4\}\).*/\1/p" "$audit_rules_file")
            # Split required access bits string into characters array
            # (to check bit's presence for one bit at a time)
            for access_bit in $(echo "wa" | grep -o .)
            do
                # For each from the required access bits (e.g. 'w', 'a') check
                # if they are already present in current access bits for rule.
                # If not, append that bit at the end
                if ! grep -q "$access_bit" <<< "$current_access_bits"
                then
                    # Concatenate the existing mask with the missing bit
                    current_access_bits="$current_access_bits$access_bit"
                fi
            done
            # Propagate the updated rule's access bits (original + the required
            # ones) back into the /etc/audit/audit.rules file for that rule
            sed -i "s/\($sp*-w$sp\+$esc_path$sp\+-p$sp\+\)\([rxwa]\{1,4\}\)\(.*\)/\1$current_access_bits\3/" "$audit_rules_file"
        else
            # Rule isn't present yet. Append it at the end of $audit_rules_file file
            # with proper key
    
            echo "-w /etc/shadow -p wa -k audit_rules_usergroup_modification" >> "$audit_rules_file"
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Set architecture for audit shadow tasks
      set_fact:
        audit_arch: b{{ ansible_architecture | regex_replace('.*(\d\d$)','\1') }}
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80431-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030873
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_shadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Search /etc/audit/rules.d for other user/group modification audit rules
      find:
        paths: /etc/audit/rules.d
        recurse: false
        contains: -k audit_rules_usergroup_modification$
        patterns: '*.rules'
      register: find_shadow
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80431-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030873
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_shadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: If existing user/group modification ruleset not found, use /etc/audit/rules.d/privileged.rules
        as the recipient for the rule
      set_fact:
        all_files:
          - /etc/audit/rules.d/privileged.rules
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_shadow.matched is defined and find_shadow.matched == 0
      tags:
        - CCE-80431-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030873
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_shadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Use matched file as the recipient for the rule
      set_fact:
        all_files:
          - '{{ find_shadow.files | map(attribute=''path'') | list | first }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - find_shadow.matched is defined and find_shadow.matched > 0
      tags:
        - CCE-80431-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030873
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_shadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the shadow rule in rules.d when on x86
      lineinfile:
        path: '{{ all_files[0] }}'
        line: -w /etc/shadow -p wa -k audit_rules_usergroup_modification
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80431-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030873
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_shadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    
    - name: Inserts/replaces the shadow rule in /etc/audit/audit.rules
      lineinfile:
        line: -w /etc/shadow -p wa -k audit_rules_usergroup_modification
        state: present
        dest: /etc/audit/audit.rules
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80431-0
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030873
        - NIST-800-171-3.1.7
        - NIST-800-53-AC-2(4)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.2.5
        - audit_rules_usergroup_modification_shadow
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
    

#### System Audit Logs Must Be Owned By Root   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_ownership_var_log_audit)rule

All audit logs must be owned by root user and group. By default, the path for audit log is

/var/log/audit/

. To properly set the owner of `/var/log/audit`, run the command:

$ sudo chown root /var/log/audit 

To properly set the owner of `/var/log/audit/*`, run the command:

$ sudo chown root /var/log/audit/\* 

Rationale:

Unauthorized disclosure of audit records can reveal system and configuration data to attackers, thus compromising its confidentiality.

Severity:  medium

Identifiers:  CCE-80125-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.3.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000162](https://public.cyber.mil/stigs/cci/), [CCI-000163](https://public.cyber.mil/stigs/cci/), [CCI-000164](https://public.cyber.mil/stigs/cci/), [CCI-001314](https://public.cyber.mil/stigs/cci/), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-9(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-10.5.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000057-GPOS-00027](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000058-GPOS-00028](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000059-GPOS-00029](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000206-GPOS-00084](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-910055](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-228564r606407\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if LC_ALL=C grep -m 1 -q ^log_group /etc/audit/auditd.conf; then
      GROUP=$(awk -F "=" '/log_group/ {print $2}' /etc/audit/auditd.conf | tr -d ' ')
      if ! [ "${GROUP}" == 'root' ] ; then
        chown root.${GROUP} /var/log/audit
        chown root.${GROUP} /var/log/audit/audit.log*
      else
        chown root.root /var/log/audit
        chown root.root /var/log/audit/audit.log*
      fi
    else
      chown root.root /var/log/audit
      chown root.root /var/log/audit/audit.log*
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

#### System Audit Logs Must Have Mode 0640 or Less Permissive   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_permissions_var_log_audit)rule

If `log_group` in `/etc/audit/auditd.conf` is set to a group other than the `root` group account, change the mode of the audit log files with the following command:

$ sudo chmod 0640 _audit\_file_

  
Otherwise, change the mode of the audit log files with the following command:

$ sudo chmod 0600 _audit\_file_

Rationale:

If users can write to audit logs, audit trails can be modified or destroyed.

Severity:  medium

Identifiers:  CCE-27205-4

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.3.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000162](https://public.cyber.mil/stigs/cci/), [CCI-000163](https://public.cyber.mil/stigs/cci/), [CCI-000164](https://public.cyber.mil/stigs/cci/), [CCI-001314](https://public.cyber.mil/stigs/cci/), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-9(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-10.5](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000057-GPOS-00027](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000058-GPOS-00028](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000059-GPOS-00029](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000206-GPOS-00084](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-910055](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-228564r606407\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if LC_ALL=C grep -m 1 -q ^log_group /etc/audit/auditd.conf; then
      GROUP=$(awk -F "=" '/log_group/ {print $2}' /etc/audit/auditd.conf | tr -d ' ')
      if ! [ "${GROUP}" == 'root' ] ; then
        chmod 0640 /var/log/audit/audit.log
        chmod 0440 /var/log/audit/audit.log.*
      else
        chmod 0600 /var/log/audit/audit.log
        chmod 0400 /var/log/audit/audit.log.*
      fi
    else
      chmod 0600 /var/log/audit/audit.log
      chmod 0400 /var/log/audit/audit.log.*
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

### Configure auditd Data Retention   [\[ref\]](#xccdf_org.ssgproject.content_group_configure_auditd_data_retention)group

The audit system writes data to `/var/log/audit/audit.log`. By default, `auditd` rotates 5 logs by size (6MB), retaining a maximum of 30MB of data in total, and refuses to write entries when the disk is too full. This minimizes the risk of audit data filling its partition and impacting other services. This also minimizes the risk of the audit daemon temporarily disabling the system if it cannot write audit log (which it can be configured to do). For a busy system or a system which is thoroughly auditing system activity, the default settings for data retention may be insufficient. The log file size needed will depend heavily on what types of events are being audited. First configure auditing to log all the events of interest. Then monitor the log size manually for awhile to determine what file size will allow you to keep the required data for the correct time period.  
  
Using a dedicated partition for `/var/log/audit` prevents the `auditd` logs from disrupting system functionality if they fill, and, more importantly, prevents other activity in `/var` from filling the partition and stopping the audit trail. (The audit logs are size-limited and therefore unlikely to grow without bound unless configured to do so.) Some machines may have requirements that no actions occur which cannot be audited. If this is the case, then `auditd` can be configured to halt the machine if it runs out of space. **Note:** Since older logs are rotated, configuring `auditd` this way does not prevent older logs from being rotated away before they can be viewed. _If your system is configured to halt when logging cannot be performed, make sure this can never happen under normal circumstances! Ensure that `/var/log/audit` is on its own partition, and that this partition is larger than the maximum amount of data `auditd` will retain normally._

contains 9 rules

#### Configure audispd Plugin To Send Logs To Remote Server   [\[ref\]](#xccdf_org.ssgproject.content_rule_auditd_audispd_configure_remote_server)rule

Configure the audispd plugin to off-load audit records onto a different system or media from the system being audited. Set the `remote_server` option in

/etc/audisp/audisp-remote.conf

with an IP address or hostname of the system that the audispd plugin should send audit records to. For example

remote\_server = _logcollector_

Rationale:

Information stored in one location is vulnerable to accidental or incidental deletion or alteration.Off-loading is a common process in information systems with limited audit storage capacity.

Severity:  medium

Identifiers:  CCE-80541-6

References:  [CCI-001851](https://public.cyber.mil/stigs/cci/), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000342-GPOS-00133](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000479-GPOS-00224](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000051-VMM-000230, SRG-OS-000058-VMM-000270, SRG-OS-000059-VMM-000280, SRG-OS-000479-VMM-001990, SRG-OS-000479-VMM-001990, [RHEL-07-030300](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204509r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_audispd_remote_server="logcollector"
    
    
    
    
    AUDITCONFIG=/etc/audisp/audisp-remote.conf
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "$AUDITCONFIG"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80541-6" ]; then
        cce="CCE"
    else
        cce="CCE-80541-6"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^remote_server")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_audispd_remote_server"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^remote_server\\>" "$AUDITCONFIG"; then
        "${sed_command[@]}" "s/^remote_server\\>.*/$formatted_output/gi" "$AUDITCONFIG"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "$AUDITCONFIG" >> "$AUDITCONFIG"
        printf '%s\n' "$formatted_output" >> "$AUDITCONFIG"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: XCCDF Value var_audispd_remote_server # promote to variable
      set_fact:
        var_audispd_remote_server: !!str logcollector
      tags:
        - always
    
    - name: Make sure that a remote server is configured for Audispd
      lineinfile:
        path: /etc/audisp/audisp-remote.conf
        line: remote_server = {{ var_audispd_remote_server }}
        regexp: ^\s*remote_server\s*=.*$
        create: true
        state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80541-6
        - DISA-STIG-RHEL-07-030300
        - auditd_audispd_configure_remote_server
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    

#### Configure audispd's Plugin disk\_full\_action When Disk Is Full   [\[ref\]](#xccdf_org.ssgproject.content_rule_auditd_audispd_disk_full_action)rule

Configure the action the operating system takes if the disk the audit records are written to becomes full. Edit the file `/etc/audisp/audisp-remote.conf`. Add or modify the following line, substituting _ACTION_ appropriately:

disk\_full\_action = _ACTION_

Set this value to `single` to cause the system to switch to single user mode for corrective action. Acceptable values also include `syslog` and `halt`. For certain systems, the need for availability outweighs the need to log all actions, and a different setting should be determined.

Rationale:

Taking appropriate action in case of a filled audit storage volume will minimize the possibility of losing audit records.

Severity:  medium

Identifiers:  CCE-80539-0

References:  [CCI-001851](https://public.cyber.mil/stigs/cci/), [AU-5(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000342-GPOS-00133](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000479-GPOS-00224](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-030320](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204511r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Encrypt Audit Records Sent With audispd Plugin   [\[ref\]](#xccdf_org.ssgproject.content_rule_auditd_audispd_encrypt_sent_records)rule

Configure the operating system to encrypt the transfer of off-loaded audit records onto a different system or media from the system being audited. Uncomment the `enable_krb5` option in

/etc/audisp/audisp-remote.conf

, and set it with the following line:

enable\_krb5 = yes

Rationale:

Information stored in one location is vulnerable to accidental or incidental deletion or alteration. Off-loading is a common process in information systems with limited audit storage capacity.

Severity:  medium

Identifiers:  CCE-80540-8

References:  [CCI-001851](https://public.cyber.mil/stigs/cci/), [AU-9(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000342-GPOS-00133](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000479-GPOS-00224](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-030310](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204510r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    AUDISP_REMOTE_CONFIG="/etc/audisp/audisp-remote.conf"
    option="^enable_krb5"
    value="yes"
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "$AUDISP_REMOTE_CONFIG"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80540-8" ]; then
        cce="CCE"
    else
        cce="CCE-80540-8"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "$option")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$value"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "$option\\>" "$AUDISP_REMOTE_CONFIG"; then
        "${sed_command[@]}" "s/$option\\>.*/$formatted_output/gi" "$AUDISP_REMOTE_CONFIG"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "$AUDISP_REMOTE_CONFIG" >> "$AUDISP_REMOTE_CONFIG"
        printf '%s\n' "$formatted_output" >> "$AUDISP_REMOTE_CONFIG"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: Configure Kerberos 5 Encryption in Audit Event Multiplexor (audispd)
      lineinfile:
        dest: /etc/audisp/audisp-remote.conf
        line: enable_krb5 = yes
        regexp: ^\s*enable_krb5\s*=\s*.*$
        state: present
        mode: 416
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80540-8
        - DISA-STIG-RHEL-07-030310
        - NIST-800-53-AU-9(3)
        - NIST-800-53-CM-6(a)
        - auditd_audispd_encrypt_sent_records
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    

#### Configure audispd's Plugin network\_failure\_action On Network Failure   [\[ref\]](#xccdf_org.ssgproject.content_rule_auditd_audispd_network_failure_action)rule

Configure the action the operating system takes if there is an error sending audit records to a remote system. Edit the file `/etc/audisp/audisp-remote.conf`. Add or modify the following line, substituting _ACTION_ appropriately:

network\_failure\_action = _ACTION_

Set this value to `single` to cause the system to switch to single user mode for corrective action. Acceptable values also include `syslog` and `halt`. For certain systems, the need for availability outweighs the need to log all actions, and a different setting should be determined. This profile configures the _action_ to be `single`.

Rationale:

Taking appropriate action when there is an error sending audit records to a remote system will minimize the possibility of losing audit records.

Severity:  medium

Identifiers:  CCE-80538-2

References:  [CCI-001851](https://public.cyber.mil/stigs/cci/), [AU-5(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000342-GPOS-00133](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000479-GPOS-00224](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-030321](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204512r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Configure auditd mail\_acct Action on Low Disk Space   [\[ref\]](#xccdf_org.ssgproject.content_rule_auditd_data_retention_action_mail_acct)rule

The `auditd` service can be configured to send email to a designated account in certain situations. Add or correct the following line in `/etc/audit/auditd.conf` to ensure that administrators are notified via email for those situations:

action\_mail\_acct = root

Rationale:

Email sent to the root account is typically aliased to the administrators of the system, who can take appropriate action.

Severity:  medium

Identifiers:  CCE-27394-6

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.3.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000139](https://public.cyber.mil/stigs/cci/), [CCI-001855](https://public.cyber.mil/stigs/cci/), [164.312(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [CIP-003-3 R1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [IA-5(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-10.7.a](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000046-GPOS-00022](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000343-GPOS-00134](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000046-VMM-000210, SRG-OS-000343-VMM-001240, [RHEL-07-030350](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204515r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.2.3](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_auditd_action_mail_acct="root"
    
    
    
    AUDITCONFIG=/etc/audit/auditd.conf
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "$AUDITCONFIG"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27394-6" ]; then
        cce="CCE"
    else
        cce="CCE-27394-6"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^action_mail_acct")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_auditd_action_mail_acct"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^action_mail_acct\\>" "$AUDITCONFIG"; then
        "${sed_command[@]}" "s/^action_mail_acct\\>.*/$formatted_output/gi" "$AUDITCONFIG"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "$AUDITCONFIG" >> "$AUDITCONFIG"
        printf '%s\n' "$formatted_output" >> "$AUDITCONFIG"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value var_auditd_action_mail_acct # promote to variable
      set_fact:
        var_auditd_action_mail_acct: !!str root
      tags:
        - always
    
    - name: Configure auditd mail_acct Action on Low Disk Space
      lineinfile:
        dest: /etc/audit/auditd.conf
        line: action_mail_acct = {{ var_auditd_action_mail_acct }}
        state: present
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27394-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030350
        - NIST-800-171-3.3.1
        - NIST-800-53-AU-5(2)
        - NIST-800-53-AU-5(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)
        - PCI-DSS-Req-10.7.a
        - auditd_data_retention_action_mail_acct
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Configure auditd space\_left Action on Low Disk Space   [\[ref\]](#xccdf_org.ssgproject.content_rule_auditd_data_retention_space_left_action)rule

The `auditd` service can be configured to take an action when disk space _starts_ to run low. Edit the file `/etc/audit/auditd.conf`. Modify the following line, substituting _ACTION_ appropriately:

space\_left\_action = _ACTION_

Possible values for _ACTION_ are described in the `auditd.conf` man page. These include:

*   `syslog`
*   `email`
*   `exec`
*   `suspend`
*   `single`
*   `halt`

Set this to `email` (instead of the default, which is `suspend`) as it is more likely to get prompt attention. Acceptable values also include `suspend`, `single`, and `halt`.

Rationale:

Notifying administrators of an impending disk space problem may allow them to take corrective action prior to any disruption.

Severity:  medium

Identifiers:  CCE-27375-5

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.3.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-001855](https://public.cyber.mil/stigs/cci/), [164.312(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [AU-5(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-10.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000343-GPOS-00134](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000343-VMM-001240, [RHEL-07-030340](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204514r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.2.3](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_auditd_space_left_action="email"
    
    
    
    #
    # If space_left_action present in /etc/audit/auditd.conf, change value
    # to var_auditd_space_left_action, else
    # add "space_left_action = $var_auditd_space_left_action" to /etc/audit/auditd.conf
    #
    
    AUDITCONFIG=/etc/audit/auditd.conf
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "$AUDITCONFIG"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27375-5" ]; then
        cce="CCE"
    else
        cce="CCE-27375-5"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^space_left_action")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$var_auditd_space_left_action"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^space_left_action\\>" "$AUDITCONFIG"; then
        "${sed_command[@]}" "s/^space_left_action\\>.*/$formatted_output/gi" "$AUDITCONFIG"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "$AUDITCONFIG" >> "$AUDITCONFIG"
        printf '%s\n' "$formatted_output" >> "$AUDITCONFIG"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value var_auditd_space_left_action # promote to variable
      set_fact:
        var_auditd_space_left_action: !!str email
      tags:
        - always
    
    - name: Configure auditd space_left Action on Low Disk Space
      lineinfile:
        dest: /etc/audit/auditd.conf
        line: space_left_action = {{ var_auditd_space_left_action }}
        regexp: ^\s*space_left_action\s*=\s*.*$
        state: present
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27375-5
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030340
        - NIST-800-171-3.3.1
        - NIST-800-53-AU-5(1)
        - NIST-800-53-AU-5(2)
        - NIST-800-53-AU-5(4)
        - NIST-800-53-AU-5(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.7
        - auditd_data_retention_space_left_action
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

Remediation script:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,%23%0A%23%20This%20file%20controls%20the%20configuration%20of%20the%20audit%20daemon%0A%23%0A%0Alocal_events%20%3D%20yes%0Awrite_logs%20%3D%20yes%0Alog_file%20%3D%20/var/log/audit/audit.log%0Alog_group%20%3D%20root%0Alog_format%20%3D%20ENRICHED%0Aflush%20%3D%20incremental_async%0Afreq%20%3D%2050%0Amax_log_file%20%3D%208%0Anum_logs%20%3D%205%0Apriority_boost%20%3D%204%0Aname_format%20%3D%20hostname%0A%23%23name%20%3D%20mydomain%0Amax_log_file_action%20%3D%20rotate%0Aspace_left%20%3D%20100%0Aspace_left_action%20%3D%20syslog%0Averify_email%20%3D%20yes%0Aaction_mail_acct%20%3D%20root%0Aadmin_space_left%20%3D%2050%0Aadmin_space_left_action%20%3D%20syslog%0Adisk_full_action%20%3D%20syslog%0Adisk_error_action%20%3D%20syslog%0Ause_libwrap%20%3D%20yes%0A%23%23tcp_listen_port%20%3D%2060%0Atcp_listen_queue%20%3D%205%0Atcp_max_per_addr%20%3D%201%0A%23%23tcp_client_ports%20%3D%201024-65535%0Atcp_client_max_idle%20%3D%200%0Atransport%20%3D%20TCP%0Akrb5_principal%20%3D%20auditd%0A%23%23krb5_key_file%20%3D%20/etc/audit/audit.key%0Adistribute_network%20%3D%20no%0Aq_depth%20%3D%20400%0Aoverflow_action%20%3D%20syslog%0Amax_restarts%20%3D%2010%0Aplugin_dir%20%3D%20/etc/audit/plugins.d
            mode: 0640
            path: /etc/audit/auditd.conf
            overwrite: true
    

#### Configure auditd space\_left on Low Disk Space   [\[ref\]](#xccdf_org.ssgproject.content_rule_auditd_data_retention_space_left_percentage)rule

The `auditd` service can be configured to take an action when disk space is running low but prior to running out of space completely. Edit the file `/etc/audit/auditd.conf`. Add or modify the following line, substituting _PERCENTAGE_ appropriately:

space\_left = _PERCENTAGE_%

Set this value to at least 25 to cause the system to notify the user of an issue.

Rationale:

Notifying administrators of an impending disk space problem may allow them to take corrective action prior to any disruption.

Severity:  medium

Identifiers:  CCE-86056-9

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [CCI-001855](https://public.cyber.mil/stigs/cci/), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [AU-5(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-5(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-10.7](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000343-GPOS-00134](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000343-VMM-001240, [RHEL-07-030330](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204513r744112\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_auditd_space_left_percentage="25"
    
    
    
    grep -q "^space_left[[:space:]]*=.*$" /etc/audit/auditd.conf && \
      sed -i "s/^space_left[[:space:]]*=.*$/space_left = $var_auditd_space_left_percentage%/g" /etc/audit/auditd.conf || \
      echo "space_left = $var_auditd_space_left_percentage%" >> /etc/audit/auditd.conf
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value var_auditd_space_left_percentage # promote to variable
      set_fact:
        var_auditd_space_left_percentage: !!str 25
      tags:
        - always
    
    - name: Configure auditd space_left on Low Disk Space
      lineinfile:
        dest: /etc/audit/auditd.conf
        line: space_left = {{ var_auditd_space_left_percentage }}%
        regexp: ^\s*space_left\s*=\s*.*$
        state: present
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-86056-9
        - DISA-STIG-RHEL-07-030330
        - NIST-800-53-AU-5(1)
        - NIST-800-53-AU-5(2)
        - NIST-800-53-AU-5(4)
        - NIST-800-53-AU-5(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.7
        - auditd_data_retention_space_left_percentage
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Set hostname as computer node name in audit logs   [\[ref\]](#xccdf_org.ssgproject.content_rule_auditd_name_format)rule

To configure Audit daemon to use value returned by gethostname syscall as computer node name in the audit events, set `name_format` to `hostname` in `/etc/audit/auditd.conf`.

Rationale:

If option `name_format` is left at its default value of `none`, audit events from different computers may be hard to distinguish.

Severity:  medium

Identifiers:  CCE-82359-1

References:  [CCI-001851](https://public.cyber.mil/stigs/cci/), [FAU\_GEN.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000039-GPOS-00017](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000342-GPOS-00133](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000479-GPOS-00224](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-030211](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204508r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/audit/auditd.conf" ] ; then
        
        LC_ALL=C sed -i "/^\s*name_format\s*=\s*/Id" "/etc/audit/auditd.conf"
    else
        touch "/etc/audit/auditd.conf"
    fi
    cp "/etc/audit/auditd.conf" "/etc/audit/auditd.conf.bak"
    # Insert at the end of the file
    printf '%s\n' "name_format = hostname" >> "/etc/audit/auditd.conf"
    # Clean up after ourselves.
    rm "/etc/audit/auditd.conf.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Set hostname as computer node name in audit logs
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/audit/auditd.conf
            create: false
            regexp: (?i)^\s*name_format\s*=\s*
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/audit/auditd.conf
          lineinfile:
            path: /etc/audit/auditd.conf
            create: false
            regexp: (?i)^\s*name_format\s*=\s*
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/audit/auditd.conf
          lineinfile:
            path: /etc/audit/auditd.conf
            create: true
            regexp: (?i)^\s*name_format\s*=\s*
            line: name_format = hostname
            state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82359-1
        - DISA-STIG-RHEL-07-030211
        - auditd_name_format
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

Remediation script:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,%23%0A%23%20This%20file%20controls%20the%20configuration%20of%20the%20audit%20daemon%0A%23%0A%0Alocal_events%20%3D%20yes%0Awrite_logs%20%3D%20yes%0Alog_file%20%3D%20/var/log/audit/audit.log%0Alog_group%20%3D%20root%0Alog_format%20%3D%20ENRICHED%0Aflush%20%3D%20incremental_async%0Afreq%20%3D%2050%0Amax_log_file%20%3D%208%0Anum_logs%20%3D%205%0Apriority_boost%20%3D%204%0Aname_format%20%3D%20hostname%0A%23%23name%20%3D%20mydomain%0Amax_log_file_action%20%3D%20rotate%0Aspace_left%20%3D%20100%0Aspace_left_action%20%3D%20syslog%0Averify_email%20%3D%20yes%0Aaction_mail_acct%20%3D%20root%0Aadmin_space_left%20%3D%2050%0Aadmin_space_left_action%20%3D%20syslog%0Adisk_full_action%20%3D%20syslog%0Adisk_error_action%20%3D%20syslog%0Ause_libwrap%20%3D%20yes%0A%23%23tcp_listen_port%20%3D%2060%0Atcp_listen_queue%20%3D%205%0Atcp_max_per_addr%20%3D%201%0A%23%23tcp_client_ports%20%3D%201024-65535%0Atcp_client_max_idle%20%3D%200%0Atransport%20%3D%20TCP%0Akrb5_principal%20%3D%20auditd%0A%23%23krb5_key_file%20%3D%20/etc/audit/audit.key%0Adistribute_network%20%3D%20no%0Aq_depth%20%3D%20400%0Aoverflow_action%20%3D%20syslog%0Amax_restarts%20%3D%2010%0Aplugin_dir%20%3D%20/etc/audit/plugins.d
            mode: 0640
            path: /etc/audit/auditd.conf
            overwrite: true
    

#### Appropriate Action Must be Setup When the Internal Audit Event Queue is Full   [\[ref\]](#xccdf_org.ssgproject.content_rule_auditd_overflow_action)rule

The audit system should have an action setup in the event the internal event queue becomes full. To setup an overflow action edit `/etc/audit/auditd.conf`. Set `overflow_action` to one of the following values: `syslog`, `single`, `halt`.

Rationale:

The audit system should have an action setup in the event the internal event queue becomes full so that no data is lost.

Severity:  medium

Identifiers:  CCE-88073-2

References:  [CCI-001851](https://public.cyber.mil/stigs/cci/), [AU-4(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000342-GPOS-00133](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000479-GPOS-00224](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-030210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204507r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/audit/auditd.conf" ] ; then
        
        LC_ALL=C sed -i "/^\s*overflow_action\s*=\s*/Id" "/etc/audit/auditd.conf"
    else
        printf '%s\n' "Path '/etc/audit/auditd.conf' wasn't found on this system. Refusing to continue." >&2
        return 1
    fi
    cp "/etc/audit/auditd.conf" "/etc/audit/auditd.conf.bak"
    # Insert at the end of the file
    printf '%s\n' "overflow_action = syslog" >> "/etc/audit/auditd.conf"
    # Clean up after ourselves.
    rm "/etc/audit/auditd.conf.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Appropriate Action Must be Setup When the Internal Audit Event Queue is Full
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/audit/auditd.conf
            create: false
            regexp: (?i)^\s*overflow_action\s*=\s*
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/audit/auditd.conf
          lineinfile:
            path: /etc/audit/auditd.conf
            create: false
            regexp: (?i)^\s*overflow_action\s*=\s*
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/audit/auditd.conf
          lineinfile:
            path: /etc/audit/auditd.conf
            create: false
            regexp: (?i)^\s*overflow_action\s*=\s*
            line: overflow_action = syslog
            state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-88073-2
        - DISA-STIG-RHEL-07-030210
        - NIST-800-53-AU-4(1)
        - auditd_overflow_action
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

#### Enable auditd Service   [\[ref\]](#xccdf_org.ssgproject.content_rule_service_auditd_enabled)rule

The `auditd` service is an essential userspace component of the Linux Auditing System, as it is responsible for writing audit records to disk. The `auditd` service can be enabled with the following command:

$ sudo systemctl enable auditd.service

Rationale:

Without establishing what type of events occurred, it would be difficult to establish, correlate, and investigate the events leading up to an outage or attack. Ensuring the `auditd` service is active ensures audit records generated by the kernel are appropriately recorded.  
  
Additionally, a properly configured audit subsystem ensures that actions of individual system users can be uniquely traced to those users so they can be held accountable for their actions.

Severity:  medium

Identifiers:  CCE-27407-6

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [19](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.4.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI08.02](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS02.02](https://www.isaca.org/resources/cobit), [DSS02.04](https://www.isaca.org/resources/cobit), [DSS02.07](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.3.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.3.2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.3.6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000126](https://public.cyber.mil/stigs/cci/), [CCI-000130](https://public.cyber.mil/stigs/cci/), [CCI-000131](https://public.cyber.mil/stigs/cci/), [CCI-000132](https://public.cyber.mil/stigs/cci/), [CCI-000133](https://public.cyber.mil/stigs/cci/), [CCI-000134](https://public.cyber.mil/stigs/cci/), [CCI-000135](https://public.cyber.mil/stigs/cci/), [CCI-000154](https://public.cyber.mil/stigs/cci/), [CCI-000158](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001464](https://public.cyber.mil/stigs/cci/), [CCI-001487](https://public.cyber.mil/stigs/cci/), [CCI-001814](https://public.cyber.mil/stigs/cci/), [CCI-001876](https://public.cyber.mil/stigs/cci/), [CCI-002884](https://public.cyber.mil/stigs/cci/), [CCI-000169](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(iv)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [A.16.1.4](https://www.iso.org/standard/54534.html), [A.16.1.5](https://www.iso.org/standard/54534.html), [A.16.1.7](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [CIP-004-3 R3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R6.5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(g)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-3](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-2(d)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-12(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-14(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.AE-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [RS.AN-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-10.1](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000037-GPOS-00015](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000038-GPOS-00016](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000039-GPOS-00017](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000040-GPOS-00018](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000041-GPOS-00019](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000042-GPOS-00021](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000051-GPOS-00024](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000054-GPOS-00025](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000122-GPOS-00063](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000254-GPOS-00095](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000255-GPOS-00096](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000365-GPOS-00152](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000392-GPOS-00172](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000062-GPOS-00031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000037-VMM-000150, SRG-OS-000063-VMM-000310, SRG-OS-000038-VMM-000160, SRG-OS-000039-VMM-000170, SRG-OS-000040-VMM-000180, SRG-OS-000041-VMM-000190, [RHEL-07-030000](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204503r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.1.1.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    SYSTEMCTL_EXEC='/usr/bin/systemctl'
    "$SYSTEMCTL_EXEC" unmask 'auditd.service'
    "$SYSTEMCTL_EXEC" start 'auditd.service'
    "$SYSTEMCTL_EXEC" enable 'auditd.service'
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    - name: Enable service auditd
      block:
    
        - name: Gather the package facts
          package_facts:
            manager: auto
    
        - name: Enable service auditd
          service:
            name: auditd
            enabled: 'yes'
            state: started
            masked: 'no'
          when:
            - '"audit" in ansible_facts.packages'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27407-6
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-07-030000
        - NIST-800-171-3.3.1
        - NIST-800-171-3.3.2
        - NIST-800-171-3.3.6
        - NIST-800-53-AC-2(g)
        - NIST-800-53-AC-6(9)
        - NIST-800-53-AU-10
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-14(1)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-AU-3
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-10.1
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_auditd_enabled
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    include enable_auditd
    
    class enable_auditd {
      service {'auditd':
        enable => true,
        ensure => 'running',
      }
    }
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        systemd:
          units:
          - name: auditd.service
            enabled: true
    

### GRUB2 bootloader configuration   [\[ref\]](#xccdf_org.ssgproject.content_group_bootloader-grub2)group

During the boot process, the boot loader is responsible for starting the execution of the kernel and passing options to it. The boot loader allows for the selection of different kernels - possibly on different partitions or media. The default Red Hat Enterprise Linux 7 boot loader for x86 systems is called GRUB2. Options it can pass to the kernel include _single-user mode_, which provides root access without any authentication, and the ability to disable SELinux. To prevent local users from modifying the boot parameters and endangering security, protect the boot loader configuration with a password and ensure its configuration file's permissions are set properly.

contains 6 rules

### Non-UEFI GRUB2 bootloader configuration   [\[ref\]](#xccdf_org.ssgproject.content_group_non-uefi)group

Non-UEFI GRUB2 bootloader configuration

contains 3 rules

#### Set the Boot Loader Admin Username to a Non-Default Value   [\[ref\]](#xccdf_org.ssgproject.content_rule_grub2_admin_username)rule

The grub2 boot loader should have a superuser account and password protection enabled to protect boot-time settings.  
  
To maximize the protection, select a password-protected superuser account with unique name, and modify the `/etc/grub.d/01_users` configuration file to reflect the account name change.  
  
Do not to use common administrator account names like root, admin, or administrator for the grub2 superuser account.  
  
Change the superuser to a different username (The default is 'root').

$ sed -i 's/\\(set superuser=\\).\*/\\1"<unique user ID>"/g' /etc/grub.d/01\_users

  
  
Once the superuser account has been added, update the `grub.cfg` file by running:

grub2-mkconfig -o /boot/grub2/grub.cfg

Warning:  To prevent hard-coded admin usernames, automatic remediation of this control is not available. Remediation must be automated as a component of machine provisioning, or followed manually as outlined above. Also, do NOT manually add the superuser account and password to the `grub.cfg` file as the grub2-mkconfig command overwrites this file.

Rationale:

Having a non-default grub superuser username makes password-guessing attacks less effective.

Severity:  low

Identifiers:  CCE-83562-9

References:  [BP28(R17)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.4.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000213](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(B)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000080-GPOS-00048](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010483](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-244557r744063\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Boot Loader Is Not Installed On Removeable Media   [\[ref\]](#xccdf_org.ssgproject.content_rule_grub2_no_removeable_media)rule

The system must not allow removable media to be used as the boot loader. Remove alternate methods of booting the system from removable media. `usb0`, `cd`, `fd0`, etc. are some examples of removeable media which should not exist in the line:

set root='hd0,msdos1'

Rationale:

Malicious users with removable boot media can gain access to a system configured to use removable media as the boot loader.

Severity:  medium

Identifiers:  CCE-80517-6

References:  [CCI-001813](https://public.cyber.mil/stigs/cci/), [CCI-001814](https://public.cyber.mil/stigs/cci/), [SRG-OS-000364-GPOS-00151](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021700](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204501r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Set Boot Loader Password in grub2   [\[ref\]](#xccdf_org.ssgproject.content_rule_grub2_password)rule

The grub2 boot loader should have a superuser account and password protection enabled to protect boot-time settings.  
  
Since plaintext passwords are a security risk, generate a hash for the password by running the following command:

$ grub2-setpassword

When prompted, enter the password that was selected.  
  
  
  
Once the superuser password has been added, update the `grub.cfg` file by running:

grub2-mkconfig -o /boot/grub2/grub.cfg

Warning:  To prevent hard-coded passwords, automatic remediation of this control is not available. Remediation must be automated as a component of machine provisioning, or followed manually as outlined above. Also, do NOT manually add the superuser account and password to the `grub.cfg` file as the grub2-mkconfig command overwrites this file.

Rationale:

Password protection on the boot loader configuration ensures users with physical access cannot trivially alter important bootloader settings. These include which kernel to use, and whether to enter single-user mode.

Severity:  high

Identifiers:  CCE-27309-4

References:  [BP28(R17)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.4.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000213](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(B)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000080-GPOS-00048](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010482](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204438r744095\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

### UEFI GRUB2 bootloader configuration   [\[ref\]](#xccdf_org.ssgproject.content_group_uefi)group

UEFI GRUB2 bootloader configuration

contains 3 rules

#### Set the UEFI Boot Loader Admin Username to a Non-Default Value   [\[ref\]](#xccdf_org.ssgproject.content_rule_grub2_uefi_admin_username)rule

The grub2 boot loader should have a superuser account and password protection enabled to protect boot-time settings.  
  
To maximize the protection, select a password-protected superuser account with unique name, and modify the `/etc/grub.d/01_users` configuration file to reflect the account name change.  
  
It is highly suggested not to use common administrator account names like root, admin, or administrator for the grub2 superuser account.  
  
Change the superuser to a different username (The default is 'root').

$ sed -i 's/\\(set superuser=\\).\*/\\1"<unique user ID>"/g' /etc/grub.d/01\_users

  
  
Once the superuser account has been added, update the `grub.cfg` file by running:

grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg

Warning:  To prevent hard-coded admin usernames, automatic remediation of this control is not available. Remediation must be automated as a component of machine provisioning, or followed manually as outlined above. Also, do NOT manually add the superuser account and password to the `grub.cfg` file as the grub2-mkconfig command overwrites this file.

Rationale:

Having a non-default grub superuser username makes password-guessing attacks less effective. For more information on how to configure the grub2 superuser account and password, please refer to

*   [https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/7/html/system\_administrators\_guide/ch-working\_with\_the\_grub\_2\_boot\_loader#sec-Protecting\_GRUB\_2\_with\_a\_Password](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-working_with_the_grub_2_boot_loader#sec-Protecting_GRUB_2_with_a_Password)
.

Severity:  low

Identifiers:  CCE-83541-3

References:  [BP28(R17)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.4.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000213](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(B)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000080-GPOS-00048](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010492](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-244558r744066\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Set the UEFI Boot Loader Password   [\[ref\]](#xccdf_org.ssgproject.content_rule_grub2_uefi_password)rule

The grub2 boot loader should have a superuser account and password protection enabled to protect boot-time settings.  
  
Since plaintext passwords are a security risk, generate a hash for the password by running the following command:

$ grub2-setpassword

When prompted, enter the password that was selected.  
  
Once the superuser password has been added, update the `grub.cfg` file by running:

grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg

Warning:  To prevent hard-coded passwords, automatic remediation of this control is not available. Remediation must be automated as a component of machine provisioning, or followed manually as outlined above. Also, do NOT manually add the superuser account and password to the `grub.cfg` file as the grub2-mkconfig command overwrites this file.

Rationale:

Password protection on the boot loader configuration ensures users with physical access cannot trivially alter important bootloader settings. These include which kernel to use, and whether to enter single-user mode.

Severity:  high

Identifiers:  CCE-80354-4

References:  [BP28(R17)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.4.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000213](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(B)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(7)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(a)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000080-GPOS-00048](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-010491](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204440r744098\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

#### UEFI Boot Loader Is Not Installed On Removeable Media   [\[ref\]](#xccdf_org.ssgproject.content_rule_uefi_no_removeable_media)rule

The system must not allow removable media to be used as the boot loader. Remove alternate methods of booting the system from removable media. `usb0`, `cd`, `fd0`, etc. are some examples of removeable media which should not exist in the line:

set root='hd0,msdos1'

Rationale:

Malicious users with removable boot media can gain access to a system configured to use removable media as the boot loader.

Severity:  medium

Identifiers:  CCE-80518-4

References:  [CCI-001813](https://public.cyber.mil/stigs/cci/), [CCI-001814](https://public.cyber.mil/stigs/cci/), [SRG-OS-000364-GPOS-00151](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021700](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204501r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### Configure Syslog   [\[ref\]](#xccdf_org.ssgproject.content_group_logging)group

The syslog service has been the default Unix logging mechanism for many years. It has a number of downsides, including inconsistent log format, lack of authentication for received messages, and lack of authentication, encryption, or reliable transport for messages sent over a network. However, due to its long history, syslog is a de facto standard which is supported by almost all Unix applications.  
  
In Red Hat Enterprise Linux 7, rsyslog has replaced ksyslogd as the syslog daemon of choice, and it includes some additional security features such as reliable, connection-oriented (i.e. TCP) transmission of logs, the option to log to database formats, and the encryption of log data en route to a central logging server. This section discusses how to configure rsyslog for best effect, and how to use tools provided with the system to maintain and monitor logs.

contains 3 rules

### Ensure Proper Configuration of Log Files   [\[ref\]](#xccdf_org.ssgproject.content_group_ensure_rsyslog_log_file_configuration)group

The file `/etc/rsyslog.conf` controls where log message are written. These are controlled by lines called _rules_, which consist of a _selector_ and an _action_. These rules are often customized depending on the role of the system, the requirements of the environment, and whatever may enable the administrator to most effectively make use of log data. The default rules in Red Hat Enterprise Linux 7 are:

\*.info;mail.none;authpriv.none;cron.none                /var/log/messages
authpriv.\*                                              /var/log/secure
mail.\*                                                  -/var/log/maillog
cron.\*                                                  /var/log/cron
\*.emerg                                                 \*
uucp,news.crit                                          /var/log/spooler
local7.\*                                                /var/log/boot.log

See the man page `rsyslog.conf(5)` for more information. _Note that the `rsyslog` daemon can be configured to use a timestamp format that some log processing programs may not understand. If this occurs, edit the file `/etc/rsyslog.conf` and add or edit the following line:_

$ ActionFileDefaultTemplate RSYSLOG\_TraditionalFileFormat

contains 1 rule

#### Ensure cron Is Logging To Rsyslog   [\[ref\]](#xccdf_org.ssgproject.content_rule_rsyslog_cron_logging)rule

Cron logging must be implemented to spot intrusions or trace cron job status. If `cron` is not logging to `rsyslog`, it can be implemented by adding the following to the _RULES_ section of `/etc/rsyslog.conf`:

cron.\*                                                  /var/log/cron

Rationale:

Cron logging can be used to trace the successful or unsuccessful execution of cron jobs. It can also be used to spot intrusions into the use of the cron facility by unauthorized and malicious users.

Severity:  medium

Identifiers:  CCE-80380-9

References:  [1](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [APO10.01](https://www.isaca.org/resources/cobit), [APO10.03](https://www.isaca.org/resources/cobit), [APO10.04](https://www.isaca.org/resources/cobit), [APO10.05](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA01.01](https://www.isaca.org/resources/cobit), [MEA01.02](https://www.isaca.org/resources/cobit), [MEA01.03](https://www.isaca.org/resources/cobit), [MEA01.04](https://www.isaca.org/resources/cobit), [MEA01.05](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.2.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0988, 1405, [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.15.2.2](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [ID.SC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021100](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204489r744109\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if ! grep -s "^\s*cron\.\*\s*/var/log/cron$" /etc/rsyslog.conf /etc/rsyslog.d/*.conf; then
    	mkdir -p /etc/rsyslog.d
    	echo "cron.*	/var/log/cron" >> /etc/rsyslog.d/cron.conf
    fi
    
    
    systemctl restart rsyslog.service
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

### Configure rsyslogd to Accept Remote Messages If Acting as a Log Server   [\[ref\]](#xccdf_org.ssgproject.content_group_rsyslog_accepting_remote_messages)group

By default, `rsyslog` does not listen over the network for log messages. If needed, modules can be enabled to allow the rsyslog daemon to receive messages from other systems and for the system thus to act as a log server. If the system is not a log server, then lines concerning these modules should remain commented out.  
  

contains 1 rule

#### Ensure rsyslog Does Not Accept Remote Messages Unless Acting As Log Server   [\[ref\]](#xccdf_org.ssgproject.content_rule_rsyslog_nolisten)rule

The `rsyslog` daemon should not accept remote messages unless the system acts as a log server. To ensure that it is not listening on the network, ensure the following lines are _not_ found in `/etc/rsyslog.conf`:

$ModLoad imtcp
$InputTCPServerRun _port_
$ModLoad imudp
$UDPServerRun _port_
$ModLoad imrelp
$InputRELPServerRun _port_

Rationale:

Any process which receives messages from the network incurs some risk of receiving malicious messages. This risk can be eliminated for rsyslog by configuring it not to listen on the network.

Severity:  medium

Identifiers:  CCE-80192-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [CCI-000318](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000368](https://public.cyber.mil/stigs/cci/), [CCI-001812](https://public.cyber.mil/stigs/cci/), [CCI-001813](https://public.cyber.mil/stigs/cci/), [CCI-001814](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0988, 1405, [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-031010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204575r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.2.1.5](https://www.cisecurity.org/benchmark/red_hat_linux/)

### Rsyslog Logs Sent To Remote Host   [\[ref\]](#xccdf_org.ssgproject.content_group_rsyslog_sending_messages)group

If system logs are to be useful in detecting malicious activities, it is necessary to send logs to a remote server. An intruder who has compromised the root account on a system may delete the log entries which indicate that the system was attacked before they are seen by an administrator.  
  
However, it is recommended that logs be stored on the local host in addition to being sent to the loghost, especially if `rsyslog` has been configured to use the UDP protocol to send messages over a network. UDP does not guarantee reliable delivery, and moderately busy sites will lose log messages occasionally, especially in periods of high traffic which may be the result of an attack. In addition, remote `rsyslog` messages are not authenticated in any way by default, so it is easy for an attacker to introduce spurious messages to the central log server. Also, some problems cause loss of network connectivity, which will prevent the sending of messages to the central server. For all of these reasons, it is better to store log messages both centrally and on each host, so that they can be correlated if necessary.

contains 1 rule

#### Ensure Logs Sent To Remote Host   [\[ref\]](#xccdf_org.ssgproject.content_rule_rsyslog_remote_loghost)rule

To configure rsyslog to send logs to a remote log server, open `/etc/rsyslog.conf` and read and understand the last section of the file, which describes the multiple directives necessary to activate remote logging. Along with these other directives, the system can be configured to forward its logs to a particular log server by adding or correcting one of the following lines, substituting `_logcollector_` appropriately. The choice of protocol depends on the environment of the system; although TCP and RELP provide more reliable message delivery, they may not be supported in all environments.  
To use UDP for log message delivery:

\*.\* @_logcollector_

  
To use TCP for log message delivery:

\*.\* @@_logcollector_

  
To use RELP for log message delivery:

\*.\* :omrelp:_logcollector_

  
There must be a resolvable DNS CNAME or Alias record set to "logcollector" for logs to be sent correctly to the centralized logging utility.

Rationale:

A log server (loghost) receives syslog messages from one or more systems. This data can be used as an additional log source in the event a system is compromised and its local logs are suspect. Forwarding log messages to a remote loghost also provides system administrators with a centralized place to view the status of multiple hosts within the enterprise.

Severity:  medium

Identifiers:  CCE-27343-3

References:  [BP28(R7)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [NT28(R43)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [NT12(R5)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [APO11.04](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001348](https://public.cyber.mil/stigs/cci/), [CCI-000136](https://public.cyber.mil/stigs/cci/), [CCI-001851](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(B)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(5)(ii)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(6)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(8)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.314(a)(2)(i)(C)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.314(a)(2)(iii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0988, 1405, [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-4(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-9(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FAU\_GEN.1.1.c](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000479-GPOS-00224](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000342-GPOS-00133](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000032-VMM-000130, [RHEL-07-031000](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204574r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [4.2.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    rsyslog_remote_loghost_address="logcollector"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/rsyslog.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27343-3" ]; then
        cce="CCE"
    else
        cce="CCE-27343-3"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^\*\.\*")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s %s" "$stripped_key" "@@$rsyslog_remote_loghost_address"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^\*\.\*\\>" "/etc/rsyslog.conf"; then
        "${sed_command[@]}" "s/^\*\.\*\\>.*/$formatted_output/gi" "/etc/rsyslog.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/rsyslog.conf" >> "/etc/rsyslog.conf"
        printf '%s\n' "$formatted_output" >> "/etc/rsyslog.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value rsyslog_remote_loghost_address # promote to variable
      set_fact:
        rsyslog_remote_loghost_address: !!str logcollector
      tags:
        - always
    
    - name: Set rsyslog remote loghost
      lineinfile:
        dest: /etc/rsyslog.conf
        regexp: ^\*\.\*
        line: '*.* @@{{ rsyslog_remote_loghost_address }}'
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27343-3
        - DISA-STIG-RHEL-07-031000
        - NIST-800-53-AU-4(1)
        - NIST-800-53-AU-9(2)
        - NIST-800-53-CM-6(a)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - rsyslog_remote_loghost
    

### Network Configuration and Firewalls   [\[ref\]](#xccdf_org.ssgproject.content_group_network)group

Most systems must be connected to a network of some sort, and this brings with it the substantial risk of network attack. This section discusses the security impact of decisions about networking which must be made when configuring a system.  
  
This section also discusses firewalls, network access controls, and other network security frameworks, which allow system-level rules to be written that can limit an attackers' ability to connect to your system. These rules can specify that network traffic should be allowed or denied from certain IP addresses, hosts, and networks. The rules can also specify which of the system's network services are available to particular hosts or networks.

contains 19 rules

### firewalld   [\[ref\]](#xccdf_org.ssgproject.content_group_network-firewalld)group

The dynamic firewall daemon `firewalld` provides a dynamically managed firewall with support for network “zones” to assign a level of trust to a network and its associated connections and interfaces. It has support for IPv4 and IPv6 firewall settings. It supports Ethernet bridges and has a separation of runtime and permanent configuration options. It also has an interface for services or applications to add firewall rules directly.  
A graphical configuration tool, `firewall-config`, is used to configure `firewalld`, which in turn uses `iptables` tool to communicate with `Netfilter` in the kernel which implements packet filtering.  
The firewall service provided by `firewalld` is dynamic rather than static because changes to the configuration can be made at anytime and are immediately implemented. There is no need to save or apply the changes. No unintended disruption of existing network connections occurs as no part of the firewall has to be reloaded.

contains 3 rules

### Inspect and Activate Default firewalld Rules   [\[ref\]](#xccdf_org.ssgproject.content_group_firewalld_activation)group

Firewalls can be used to separate networks into different zones based on the level of trust the user has decided to place on the devices and traffic within that network. `NetworkManager` informs firewalld to which zone an interface belongs. An interface's assigned zone can be changed by `NetworkManager` or via the `firewall-config` tool.  
The zone settings in `/etc/firewalld/` are a range of preset settings which can be quickly applied to a network interface. These are the zones provided by firewalld sorted according to the default trust level of the zones from untrusted to trusted:

*   `drop`  
    
    Any incoming network packets are dropped, there is no reply. Only outgoing network connections are possible.
    
*   `block`  
    
    Any incoming network connections are rejected with an `icmp-host-prohibited` message for IPv4 and `icmp6-adm-prohibited` for IPv6. Only network connections initiated from within the system are possible.
    
*   `public`  
    
    For use in public areas. You do not trust the other computers on the network to not harm your computer. Only selected incoming connections are accepted.
    
*   `external`  
    
    For use on external networks with masquerading enabled especially for routers. You do not trust the other computers on the network to not harm your computer. Only selected incoming connections are accepted.
    
*   `dmz`  
    
    For computers in your demilitarized zone that are publicly-accessible with limited access to your internal network. Only selected incoming connections are accepted.
    
*   `work`  
    
    For use in work areas. You mostly trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.
    
*   `home`  
    
    For use in home areas. You mostly trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.
    
*   `internal`  
    
    For use on internal networks. You mostly trust the other computers on the networks to not harm your computer. Only selected incoming connections are accepted.
    
*   `trusted`  
    
    All network connections are accepted.
    

  
It is possible to designate one of these zones to be the default zone. When interface connections are added to `NetworkManager`, they are assigned to the default zone. On installation, the default zone in firewalld is set to be the public zone.  
To find out all the settings of a zone, for example the `public zone,` enter the following command as root:

\# firewall-cmd --zone=public --list-all

Example output of this command might look like the following:

\# firewall-cmd --zone=public --list-all
public
  interfaces:
  services: mdns dhcpv6-client ssh
  ports:
  forward-ports:
  icmp-blocks: source-quench

To view the network zones currently active, enter the following command as root:

\# firewall-cmd --get-service

The following listing displays the result of this command on common Red Hat Enterprise Linux 7 system:

\# firewall-cmd --get-service
amanda-client bacula bacula-client dhcp dhcpv6 dhcpv6-client dns ftp
high-availability http https imaps ipp ipp-client ipsec kerberos kpasswd
ldap ldaps libvirt libvirt-tls mdns mountd ms-wbt mysql nfs ntp openvpn
pmcd pmproxy pmwebapi pmwebapis pop3s postgresql proxy-dhcp radius rpc-bind
samba samba-client smtp ssh telnet tftp tftp-client transmission-client
vnc-server wbem-https

Finally to view the network zones that will be active after the next firewalld service reload, enter the following command as root:

\# firewall-cmd --get-service --permanent

contains 1 rule

#### Verify firewalld Enabled   [\[ref\]](#xccdf_org.ssgproject.content_rule_service_firewalld_enabled)rule

The `firewalld` service can be enabled with the following command:

$ sudo systemctl enable firewalld.service

Rationale:

Access control methods provide the ability to enhance system security posture by restricting services and known good IP addresses and address ranges. This prevents connections from unknown hosts and protocols.

Severity:  medium

Identifiers:  CCE-80998-8

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.1.3](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.4.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000382](https://public.cyber.mil/stigs/cci/), [CCI-002314](https://public.cyber.mil/stigs/cci/), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [CIP-003-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-4](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CA-3(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(21)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000096-GPOS-00050](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000297-GPOS-00115](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00231](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00232](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040520](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204604r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.5.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    SYSTEMCTL_EXEC='/usr/bin/systemctl'
    "$SYSTEMCTL_EXEC" unmask 'firewalld.service'
    "$SYSTEMCTL_EXEC" start 'firewalld.service'
    "$SYSTEMCTL_EXEC" enable 'firewalld.service'
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    - name: Enable service firewalld
      block:
    
        - name: Gather the package facts
          package_facts:
            manager: auto
    
        - name: Enable service firewalld
          service:
            name: firewalld
            enabled: 'yes'
            state: started
            masked: 'no'
          when:
            - '"firewalld" in ansible_facts.packages'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80998-8
        - DISA-STIG-RHEL-07-040520
        - NIST-800-171-3.1.3
        - NIST-800-171-3.4.7
        - NIST-800-53-AC-4
        - NIST-800-53-CA-3(5)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-7(21)
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_firewalld_enabled
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    include enable_firewalld
    
    class enable_firewalld {
      service {'firewalld':
        enable => true,
        ensure => 'running',
      }
    }
    

### Strengthen the Default Ruleset   [\[ref\]](#xccdf_org.ssgproject.content_group_ruleset_modifications)group

The default rules can be strengthened. The system scripts that activate the firewall rules expect them to be defined in configuration files under the `/etc/firewalld/services` and `/etc/firewalld/zones` directories.  
  
The following recommendations describe how to strengthen the default ruleset configuration file. An alternative to editing this configuration file is to create a shell script that makes calls to the `firewall-cmd` program to load in rules under the `/etc/firewalld/services` and `/etc/firewalld/zones` directories.  
  
Instructions apply to both unless otherwise noted. Language and address conventions for regular firewalld rules are used throughout this section.

Warning:  The program `firewall-config` allows additional services to penetrate the default firewall rules and automatically adjusts the `firewalld` ruleset(s).

contains 2 rules

#### Configure the Firewalld Ports   [\[ref\]](#xccdf_org.ssgproject.content_rule_configure_firewalld_ports)rule

Configure the `firewalld` ports to allow approved services to have access to the system. To configure `firewalld` to open ports, run the following command:

$ sudo firewall-cmd --permanent --add-port=_port\_number_/tcp

or

$ sudo firewall-cmd --permanent --add-port=_service\_name_

Run the command list above for each of the ports listed below: To configure `firewalld` to allow access, run the following command(s): `firewall-cmd --permanent --add-service=ssh`

Rationale:

In order to prevent unauthorized connection of devices, unauthorized transfer of information, or unauthorized tunneling (i.e., embedding of data types within data types), organizations must disable or restrict unused or unnecessary physical and logical ports/protocols on information systems.  
  
Operating systems are capable of providing a wide variety of functions and services. Some of the functions and services provided by default may not be necessary to support essential organizational operations. Additionally, it is sometimes convenient to provide multiple services from a single component (e.g., VPN and IPS); however, doing so increases risk over limiting the services provided by any one component.  
  
To support the requirements and principles of least functionality, the operating system must support the organizational requirements, providing only essential capabilities and limiting the use of ports, protocols, and/or services to only those required, authorized, and approved to conduct official business or to address authorized quality of life issues.

Severity:  medium

Identifiers:  CCE-80447-6

References:  [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000382](https://public.cyber.mil/stigs/cci/), [CCI-002314](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 1416, [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [AC-4](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CA-3(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(21)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000096-GPOS-00050](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000297-GPOS-00115](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000096-VMM-000490, SRG-OS-000480-VMM-002000, [RHEL-07-040100](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204577r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if ! rpm -q --quiet "firewalld" ; then
        yum install -y "firewalld"
    fi
    
    
    firewalld_sshd_zone="public"
    
    
    
    # This assumes that firewalld_sshd_zone is one of the pre-defined zones
    if [ ! -f /etc/firewalld/zones/${firewalld_sshd_zone}.xml ]; then
        cp /usr/lib/firewalld/zones/${firewalld_sshd_zone}.xml /etc/firewalld/zones/${firewalld_sshd_zone}.xml
    fi
    if ! grep -q 'service name="ssh"' /etc/firewalld/zones/${firewalld_sshd_zone}.xml; then
        sed -i '/<\/description>/a \
      <service name="ssh"/>' /etc/firewalld/zones/${firewalld_sshd_zone}.xml
    fi
    
    # Check if any eth interface is bounded to the zone with SSH service enabled
    nic_bound=false
    eth_interface_list=$(ip link show up | cut -d ' ' -f2 | cut -d ':' -s -f1 | grep -E '^(en|eth)')
    for interface in $eth_interface_list; do
        if grep -q "ZONE=$firewalld_sshd_zone" /etc/sysconfig/network-scripts/ifcfg-$interface; then
            nic_bound=true
            break;
        fi
    done
    
    if [ $nic_bound = false ];then
        # Add first NIC to SSH enabled zone
    
        if ! firewall-cmd --state -q; then
            # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
            # Otherwise, regular sed command will do.
            sed_command=('sed' '-i')
            if test -L "/etc/sysconfig/network-scripts/ifcfg-${eth_interface_list[0]}"; then
                sed_command+=('--follow-symlinks')
            fi
    
            # If the cce arg is empty, CCE is not assigned.
            if [ -z "CCE-80447-6" ]; then
                cce="CCE"
            else
                cce="CCE-80447-6"
            fi
    
            # Strip any search characters in the key arg so that the key can be replaced without
            # adding any search characters to the config file.
            stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^ZONE=")
    
            # shellcheck disable=SC2059
            printf -v formatted_output "%s=%s" "$stripped_key" "$firewalld_sshd_zone"
    
            # If the key exists, change it. Otherwise, add it to the config_file.
            # We search for the key string followed by a word boundary (matched by \>),
            # so if we search for 'setting', 'setting2' won't match.
            if LC_ALL=C grep -q -m 1 -i -e "^ZONE=\\>" "/etc/sysconfig/network-scripts/ifcfg-${eth_interface_list[0]}"; then
                "${sed_command[@]}" "s/^ZONE=\\>.*/$formatted_output/gi" "/etc/sysconfig/network-scripts/ifcfg-${eth_interface_list[0]}"
            else
                # \n is precaution for case where file ends without trailing newline
                printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysconfig/network-scripts/ifcfg-${eth_interface_list[0]}" >> "/etc/sysconfig/network-scripts/ifcfg-${eth_interface_list[0]}"
                printf '%s\n' "$formatted_output" >> "/etc/sysconfig/network-scripts/ifcfg-${eth_interface_list[0]}"
            fi
        else
            # If firewalld service is running, we need to do this step with firewall-cmd
            # Otherwise firewalld will comunicate with NetworkManage and will revert assigned zone
            # of NetworkManager managed interfaces upon reload
            firewall-cmd --permanent --zone=$firewalld_sshd_zone --add-interface=${eth_interface_list[0]}
            firewall-cmd --reload
        fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

#### Set Default firewalld Zone for Incoming Packets   [\[ref\]](#xccdf_org.ssgproject.content_rule_set_firewalld_default_zone)rule

To set the default zone to `drop` for the built-in default zone which processes incoming IPv4 and IPv6 packets, modify the following line in `/etc/firewalld/firewalld.conf` to be:

DefaultZone=drop

Warning:  To prevent denying any access to the system, automatic remediation of this control is not available. Remediation must be automated as a component of machine provisioning, or followed manually as outlined above.

Rationale:

In `firewalld` the default zone is applied only after all the applicable rules in the table are examined for a match. Setting the default zone to `drop` implements proper design for a firewall, i.e. any packets which are not explicitly permitted should not be accepted.

Severity:  medium

Identifiers:  CCE-27349-0

References:  [11](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.3](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.4.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.13.6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 1416, [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CA-3(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(23)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_MOF\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-040810](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204628r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.5.1.5](https://www.cisecurity.org/benchmark/red_hat_linux/)

### IPSec Support   [\[ref\]](#xccdf_org.ssgproject.content_group_network-ipsec)group

Support for Internet Protocol Security (IPsec) is provided with Libreswan.

contains 1 rule

#### Verify Any Configured IPSec Tunnel Connections   [\[ref\]](#xccdf_org.ssgproject.content_rule_libreswan_approved_tunnels)rule

Libreswan provides an implementation of IPsec and IKE, which permits the creation of secure tunnels over untrusted networks. As such, IPsec can be used to circumvent certain network requirements such as filtering. Verify that if any IPsec connection (`conn`) configured in `/etc/ipsec.conf` and `/etc/ipsec.d` exists is an approved organizational connection.

Rationale:

IP tunneling mechanisms can be used to bypass network filtering.

Severity:  medium

Identifiers:  CCE-80171-2

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [CCI-000336](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MA-4(6)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-4](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040820](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204629r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### IPv6   [\[ref\]](#xccdf_org.ssgproject.content_group_network-ipv6)group

The system includes support for Internet Protocol version 6. A major and often-mentioned improvement over IPv4 is its enormous increase in the number of available addresses. Another important feature is its support for automatic configuration of many network settings.

contains 1 rule

### Configure IPv6 Settings if Necessary   [\[ref\]](#xccdf_org.ssgproject.content_group_configuring_ipv6)group

A major feature of IPv6 is the extent to which systems implementing it can automatically configure their networking devices using information from the network. From a security perspective, manually configuring important configuration information is preferable to accepting it from the network in an unauthenticated fashion.

contains 1 rule

#### Disable Kernel Parameter for Accepting Source-Routed Packets on all IPv6 Interfaces   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv6_conf_all_accept_source_route)rule

To set the runtime status of the `net.ipv6.conf.all.accept_source_route` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv6.conf.all.accept\_source\_route=0

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv6.conf.all.accept\_source\_route = 0

Rationale:

Source-routed packets allow the source of the packet to suggest routers forward the packet along a different path than configured on the router, which can be used to bypass network security measures. This requirement applies only to the forwarding of source-routerd traffic, such as when IPv6 forwarding is enabled and the system is functioning as a router.  
  
Accepting source-routed packets in the IPv6 protocol has few legitimate uses. It should be disabled unless it is absolutely required.

Severity:  medium

Identifiers:  CCE-80179-5

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040830](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204630r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.3.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    sysctl_net_ipv6_conf_all_accept_source_route_value="0"
    
    
    
    #
    # Set runtime for net.ipv6.conf.all.accept_source_route
    #
    /sbin/sysctl -q -n -w net.ipv6.conf.all.accept_source_route="$sysctl_net_ipv6_conf_all_accept_source_route_value"
    
    #
    # If net.ipv6.conf.all.accept_source_route present in /etc/sysctl.conf, change value to appropriate value
    #	else, add "net.ipv6.conf.all.accept_source_route = value" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80179-5" ]; then
        cce="CCE"
    else
        cce="CCE-80179-5"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv6.conf.all.accept_source_route")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$sysctl_net_ipv6_conf_all_accept_source_route_value"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv6.conf.all.accept_source_route\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv6.conf.all.accept_source_route\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: XCCDF Value sysctl_net_ipv6_conf_all_accept_source_route_value # promote to variable
      set_fact:
        sysctl_net_ipv6_conf_all_accept_source_route_value: !!str 0
      tags:
        - always
    
    - name: Ensure sysctl net.ipv6.conf.all.accept_source_route is set
      sysctl:
        name: net.ipv6.conf.all.accept_source_route
        value: '{{ sysctl_net_ipv6_conf_all_accept_source_route_value }}'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80179-5
        - DISA-STIG-RHEL-07-040830
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv6_conf_all_accept_source_route
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv6.conf.all.accept_source_route%3D0%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv6_conf_all_accept_source_route.conf
            overwrite: true
    

### Kernel Parameters Which Affect Networking   [\[ref\]](#xccdf_org.ssgproject.content_group_network-kernel)group

The `sysctl` utility is used to set parameters which affect the operation of the Linux kernel. Kernel parameters which affect networking and have security implications are described here.

contains 10 rules

### Network Related Kernel Runtime Parameters for Hosts and Routers   [\[ref\]](#xccdf_org.ssgproject.content_group_network_host_and_router_parameters)group

Certain kernel parameters should be set for systems which are acting as either hosts or routers to improve the system's ability defend against certain types of IPv4 protocol attacks.

contains 7 rules

#### Disable Accepting ICMP Redirects for All IPv4 Interfaces   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_conf_all_accept_redirects)rule

To set the runtime status of the `net.ipv4.conf.all.accept_redirects` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.conf.all.accept\_redirects=0

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.conf.all.accept\_redirects = 0

Rationale:

ICMP redirect messages are used by routers to inform hosts that a more direct route exists for a particular destination. These messages modify the host's route table and are unauthenticated. An illicit ICMP redirect message could result in a man-in-the-middle attack.  
This feature of the IPv4 protocol has few legitimate uses. It should be disabled unless absolutely required."

Severity:  medium

Identifiers:  CCE-80158-9

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001503](https://public.cyber.mil/stigs/cci/), [CCI-001551](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040641](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204615r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.3.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    sysctl_net_ipv4_conf_all_accept_redirects_value="0"
    
    
    
    #
    # Set runtime for net.ipv4.conf.all.accept_redirects
    #
    /sbin/sysctl -q -n -w net.ipv4.conf.all.accept_redirects="$sysctl_net_ipv4_conf_all_accept_redirects_value"
    
    #
    # If net.ipv4.conf.all.accept_redirects present in /etc/sysctl.conf, change value to appropriate value
    #	else, add "net.ipv4.conf.all.accept_redirects = value" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80158-9" ]; then
        cce="CCE"
    else
        cce="CCE-80158-9"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.conf.all.accept_redirects")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$sysctl_net_ipv4_conf_all_accept_redirects_value"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.conf.all.accept_redirects\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.conf.all.accept_redirects\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: XCCDF Value sysctl_net_ipv4_conf_all_accept_redirects_value # promote to variable
      set_fact:
        sysctl_net_ipv4_conf_all_accept_redirects_value: !!str 0
      tags:
        - always
    
    - name: Ensure sysctl net.ipv4.conf.all.accept_redirects is set
      sysctl:
        name: net.ipv4.conf.all.accept_redirects
        value: '{{ sysctl_net_ipv4_conf_all_accept_redirects_value }}'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80158-9
        - CJIS-5.10.1.1
        - DISA-STIG-RHEL-07-040641
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-7(a)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_conf_all_accept_redirects
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv4.conf.all.accept_redirects%3D0%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv4_conf_all_accept_redirects.conf
            overwrite: true
    

#### Disable Kernel Parameter for Accepting Source-Routed Packets on all IPv4 Interfaces   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_conf_all_accept_source_route)rule

To set the runtime status of the `net.ipv4.conf.all.accept_source_route` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.conf.all.accept\_source\_route=0

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.conf.all.accept\_source\_route = 0

Rationale:

Source-routed packets allow the source of the packet to suggest routers forward the packet along a different path than configured on the router, which can be used to bypass network security measures. This requirement applies only to the forwarding of source-routerd traffic, such as when IPv4 forwarding is enabled and the system is functioning as a router.  
  
Accepting source-routed packets in the IPv4 protocol has few legitimate uses. It should be disabled unless it is absolutely required.

Severity:  medium

Identifiers:  CCE-27434-0

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-007-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040610](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204609r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.3.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    sysctl_net_ipv4_conf_all_accept_source_route_value="0"
    
    
    
    #
    # Set runtime for net.ipv4.conf.all.accept_source_route
    #
    /sbin/sysctl -q -n -w net.ipv4.conf.all.accept_source_route="$sysctl_net_ipv4_conf_all_accept_source_route_value"
    
    #
    # If net.ipv4.conf.all.accept_source_route present in /etc/sysctl.conf, change value to appropriate value
    #	else, add "net.ipv4.conf.all.accept_source_route = value" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27434-0" ]; then
        cce="CCE"
    else
        cce="CCE-27434-0"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.conf.all.accept_source_route")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$sysctl_net_ipv4_conf_all_accept_source_route_value"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.conf.all.accept_source_route\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.conf.all.accept_source_route\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: XCCDF Value sysctl_net_ipv4_conf_all_accept_source_route_value # promote to variable
      set_fact:
        sysctl_net_ipv4_conf_all_accept_source_route_value: !!str 0
      tags:
        - always
    
    - name: Ensure sysctl net.ipv4.conf.all.accept_source_route is set
      sysctl:
        name: net.ipv4.conf.all.accept_source_route
        value: '{{ sysctl_net_ipv4_conf_all_accept_source_route_value }}'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27434-0
        - DISA-STIG-RHEL-07-040610
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-5
        - NIST-800-53-SC-7(a)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_conf_all_accept_source_route
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv4.conf.all.accept_source_route%3D0%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv4_conf_all_accept_source_route.conf
            overwrite: true
    

#### Enable Kernel Parameter to Use Reverse Path Filtering on all IPv4 Interfaces   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_conf_all_rp_filter)rule

To set the runtime status of the `net.ipv4.conf.all.rp_filter` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.conf.all.rp\_filter=1

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.conf.all.rp\_filter = 1

Rationale:

Enabling reverse path filtering drops packets with source addresses that should not have been able to be received on the interface they were received on. It should not be used on systems which are routers for complicated networks, but is helpful for end hosts and routers serving small networks.

Severity:  medium

Identifiers:  CCE-80167-0

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001551](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040611](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204610r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.3.7](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    sysctl_net_ipv4_conf_all_rp_filter_value="1"
    
    
    
    #
    # Set runtime for net.ipv4.conf.all.rp_filter
    #
    /sbin/sysctl -q -n -w net.ipv4.conf.all.rp_filter="$sysctl_net_ipv4_conf_all_rp_filter_value"
    
    #
    # If net.ipv4.conf.all.rp_filter present in /etc/sysctl.conf, change value to appropriate value
    #	else, add "net.ipv4.conf.all.rp_filter = value" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80167-0" ]; then
        cce="CCE"
    else
        cce="CCE-80167-0"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.conf.all.rp_filter")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$sysctl_net_ipv4_conf_all_rp_filter_value"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.conf.all.rp_filter\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.conf.all.rp_filter\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: XCCDF Value sysctl_net_ipv4_conf_all_rp_filter_value # promote to variable
      set_fact:
        sysctl_net_ipv4_conf_all_rp_filter_value: !!str 1
      tags:
        - always
    
    - name: Ensure sysctl net.ipv4.conf.all.rp_filter is set
      sysctl:
        name: net.ipv4.conf.all.rp_filter
        value: '{{ sysctl_net_ipv4_conf_all_rp_filter_value }}'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80167-0
        - DISA-STIG-RHEL-07-040611
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-7(a)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_conf_all_rp_filter
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv4.conf.all.rp_filter%3D1%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv4_conf_all_rp_filter.conf
            overwrite: true
    

#### Disable Kernel Parameter for Accepting ICMP Redirects by Default on IPv4 Interfaces   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_conf_default_accept_redirects)rule

To set the runtime status of the `net.ipv4.conf.default.accept_redirects` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.conf.default.accept\_redirects=0

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.conf.default.accept\_redirects = 0

Rationale:

ICMP redirect messages are used by routers to inform hosts that a more direct route exists for a particular destination. These messages modify the host's route table and are unauthenticated. An illicit ICMP redirect message could result in a man-in-the-middle attack.  
This feature of the IPv4 protocol has few legitimate uses. It should be disabled unless absolutely required.

Severity:  medium

Identifiers:  CCE-80163-9

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001551](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040640](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204614r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.3.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    sysctl_net_ipv4_conf_default_accept_redirects_value="0"
    
    
    
    #
    # Set runtime for net.ipv4.conf.default.accept_redirects
    #
    /sbin/sysctl -q -n -w net.ipv4.conf.default.accept_redirects="$sysctl_net_ipv4_conf_default_accept_redirects_value"
    
    #
    # If net.ipv4.conf.default.accept_redirects present in /etc/sysctl.conf, change value to appropriate value
    #	else, add "net.ipv4.conf.default.accept_redirects = value" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80163-9" ]; then
        cce="CCE"
    else
        cce="CCE-80163-9"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.conf.default.accept_redirects")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$sysctl_net_ipv4_conf_default_accept_redirects_value"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.conf.default.accept_redirects\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.conf.default.accept_redirects\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: XCCDF Value sysctl_net_ipv4_conf_default_accept_redirects_value # promote to variable
      set_fact:
        sysctl_net_ipv4_conf_default_accept_redirects_value: !!str 0
      tags:
        - always
    
    - name: Ensure sysctl net.ipv4.conf.default.accept_redirects is set
      sysctl:
        name: net.ipv4.conf.default.accept_redirects
        value: '{{ sysctl_net_ipv4_conf_default_accept_redirects_value }}'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80163-9
        - CJIS-5.10.1.1
        - DISA-STIG-RHEL-07-040640
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-7(a)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_conf_default_accept_redirects
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv4.conf.default.accept_redirects%3D0%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv4_conf_default_accept_redirects.conf
            overwrite: true
    

#### Disable Kernel Parameter for Accepting Source-Routed Packets on IPv4 Interfaces by Default   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_conf_default_accept_source_route)rule

To set the runtime status of the `net.ipv4.conf.default.accept_source_route` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.conf.default.accept\_source\_route=0

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.conf.default.accept\_source\_route = 0

Rationale:

Source-routed packets allow the source of the packet to suggest routers forward the packet along a different path than configured on the router, which can be used to bypass network security measures.  
Accepting source-routed packets in the IPv4 protocol has few legitimate uses. It should be disabled unless it is absolutely required, such as when IPv4 forwarding is enabled and the system is legitimately functioning as a router.

Severity:  medium

Identifiers:  CCE-80162-1

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-001551](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-007-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040620](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204612r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.3.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    sysctl_net_ipv4_conf_default_accept_source_route_value="0"
    
    
    
    #
    # Set runtime for net.ipv4.conf.default.accept_source_route
    #
    /sbin/sysctl -q -n -w net.ipv4.conf.default.accept_source_route="$sysctl_net_ipv4_conf_default_accept_source_route_value"
    
    #
    # If net.ipv4.conf.default.accept_source_route present in /etc/sysctl.conf, change value to appropriate value
    #	else, add "net.ipv4.conf.default.accept_source_route = value" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80162-1" ]; then
        cce="CCE"
    else
        cce="CCE-80162-1"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.conf.default.accept_source_route")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$sysctl_net_ipv4_conf_default_accept_source_route_value"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.conf.default.accept_source_route\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.conf.default.accept_source_route\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: XCCDF Value sysctl_net_ipv4_conf_default_accept_source_route_value # promote to variable
      set_fact:
        sysctl_net_ipv4_conf_default_accept_source_route_value: !!str 0
      tags:
        - always
    
    - name: Ensure sysctl net.ipv4.conf.default.accept_source_route is set
      sysctl:
        name: net.ipv4.conf.default.accept_source_route
        value: '{{ sysctl_net_ipv4_conf_default_accept_source_route_value }}'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80162-1
        - CJIS-5.10.1.1
        - DISA-STIG-RHEL-07-040620
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-5
        - NIST-800-53-SC-7(a)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_conf_default_accept_source_route
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv4.conf.default.accept_source_route%3D0%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv4_conf_default_accept_source_route.conf
            overwrite: true
    

#### Enable Kernel Parameter to Use Reverse Path Filtering on all IPv4 Interfaces by Default   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_conf_default_rp_filter)rule

To set the runtime status of the `net.ipv4.conf.default.rp_filter` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.conf.default.rp\_filter=1

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.conf.default.rp\_filter = 1

Rationale:

Enabling reverse path filtering drops packets with source addresses that should not have been able to be received on the interface they were received on. It should not be used on systems which are routers for complicated networks, but is helpful for end hosts and routers serving small networks.

Severity:  medium

Identifiers:  CCE-80168-8

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040612](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204611r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.3.7](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    sysctl_net_ipv4_conf_default_rp_filter_value="1"
    
    
    
    #
    # Set runtime for net.ipv4.conf.default.rp_filter
    #
    /sbin/sysctl -q -n -w net.ipv4.conf.default.rp_filter="$sysctl_net_ipv4_conf_default_rp_filter_value"
    
    #
    # If net.ipv4.conf.default.rp_filter present in /etc/sysctl.conf, change value to appropriate value
    #	else, add "net.ipv4.conf.default.rp_filter = value" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80168-8" ]; then
        cce="CCE"
    else
        cce="CCE-80168-8"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.conf.default.rp_filter")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$sysctl_net_ipv4_conf_default_rp_filter_value"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.conf.default.rp_filter\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.conf.default.rp_filter\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: XCCDF Value sysctl_net_ipv4_conf_default_rp_filter_value # promote to variable
      set_fact:
        sysctl_net_ipv4_conf_default_rp_filter_value: !!str 1
      tags:
        - always
    
    - name: Ensure sysctl net.ipv4.conf.default.rp_filter is set
      sysctl:
        name: net.ipv4.conf.default.rp_filter
        value: '{{ sysctl_net_ipv4_conf_default_rp_filter_value }}'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80168-8
        - DISA-STIG-RHEL-07-040612
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-7(a)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_conf_default_rp_filter
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv4.conf.default.rp_filter%3D1%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv4_conf_default_rp_filter.conf
            overwrite: true
    

#### Enable Kernel Parameter to Ignore ICMP Broadcast Echo Requests on IPv4 Interfaces   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_icmp_echo_ignore_broadcasts)rule

To set the runtime status of the `net.ipv4.icmp_echo_ignore_broadcasts` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.icmp\_echo\_ignore\_broadcasts=1

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.icmp\_echo\_ignore\_broadcasts = 1

Rationale:

Responding to broadcast (ICMP) echoes facilitates network mapping and provides a vector for amplification attacks.  
Ignoring ICMP echo requests (pings) sent to broadcast or multicast addresses makes the system slightly more difficult to enumerate on the network.

Severity:  medium

Identifiers:  CCE-80165-4

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-007-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040630](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204613r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.3.5](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    sysctl_net_ipv4_icmp_echo_ignore_broadcasts_value="1"
    
    
    
    #
    # Set runtime for net.ipv4.icmp_echo_ignore_broadcasts
    #
    /sbin/sysctl -q -n -w net.ipv4.icmp_echo_ignore_broadcasts="$sysctl_net_ipv4_icmp_echo_ignore_broadcasts_value"
    
    #
    # If net.ipv4.icmp_echo_ignore_broadcasts present in /etc/sysctl.conf, change value to appropriate value
    #	else, add "net.ipv4.icmp_echo_ignore_broadcasts = value" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80165-4" ]; then
        cce="CCE"
    else
        cce="CCE-80165-4"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.icmp_echo_ignore_broadcasts")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "$sysctl_net_ipv4_icmp_echo_ignore_broadcasts_value"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.icmp_echo_ignore_broadcasts\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.icmp_echo_ignore_broadcasts\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: XCCDF Value sysctl_net_ipv4_icmp_echo_ignore_broadcasts_value # promote to variable
      set_fact:
        sysctl_net_ipv4_icmp_echo_ignore_broadcasts_value: !!str 1
      tags:
        - always
    
    - name: Ensure sysctl net.ipv4.icmp_echo_ignore_broadcasts is set
      sysctl:
        name: net.ipv4.icmp_echo_ignore_broadcasts
        value: '{{ sysctl_net_ipv4_icmp_echo_ignore_broadcasts_value }}'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80165-4
        - CJIS-5.10.1.1
        - DISA-STIG-RHEL-07-040630
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-5
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_icmp_echo_ignore_broadcasts
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv4.icmp_echo_ignore_broadcasts%3D1%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv4_icmp_echo_ignore_broadcasts.conf
            overwrite: true
    

### Network Parameters for Hosts Only   [\[ref\]](#xccdf_org.ssgproject.content_group_network_host_parameters)group

If the system is not going to be used as a router, then setting certain kernel parameters ensure that the host will not perform routing of network traffic.

contains 3 rules

#### Disable Kernel Parameter for Sending ICMP Redirects on all IPv4 Interfaces   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_conf_all_send_redirects)rule

To set the runtime status of the `net.ipv4.conf.all.send_redirects` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.conf.all.send\_redirects=0

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.conf.all.send\_redirects = 0

Rationale:

ICMP redirect messages are used by routers to inform hosts that a more direct route exists for a particular destination. These messages contain information from the system's route table possibly revealing portions of the network topology.  
The ability to send ICMP redirects is only appropriate for systems acting as routers.

Severity:  medium

Identifiers:  CCE-80156-3

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-007-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040660](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204617r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.2.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    
    #
    # Set runtime for net.ipv4.conf.all.send_redirects
    #
    /sbin/sysctl -q -n -w net.ipv4.conf.all.send_redirects="0"
    
    #
    # If net.ipv4.conf.all.send_redirects present in /etc/sysctl.conf, change value to "0"
    #	else, add "net.ipv4.conf.all.send_redirects = 0" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80156-3" ]; then
        cce="CCE"
    else
        cce="CCE-80156-3"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.conf.all.send_redirects")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "0"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.conf.all.send_redirects\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.conf.all.send_redirects\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: Ensure sysctl net.ipv4.conf.all.send_redirects is set to 0
      sysctl:
        name: net.ipv4.conf.all.send_redirects
        value: '0'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80156-3
        - CJIS-5.10.1.1
        - DISA-STIG-RHEL-07-040660
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-5
        - NIST-800-53-SC-7(a)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_conf_all_send_redirects
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv4.conf.all.send_redirects%3D0%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv4_conf_all_send_redirects.conf
            overwrite: true
    

#### Disable Kernel Parameter for Sending ICMP Redirects on all IPv4 Interfaces by Default   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_conf_default_send_redirects)rule

To set the runtime status of the `net.ipv4.conf.default.send_redirects` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.conf.default.send\_redirects=0

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.conf.default.send\_redirects = 0

Rationale:

ICMP redirect messages are used by routers to inform hosts that a more direct route exists for a particular destination. These messages contain information from the system's route table possibly revealing portions of the network topology.  
The ability to send ICMP redirects is only appropriate for systems acting as routers.

Severity:  medium

Identifiers:  CCE-80999-6

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-007-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040650](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204616r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.2.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    
    #
    # Set runtime for net.ipv4.conf.default.send_redirects
    #
    /sbin/sysctl -q -n -w net.ipv4.conf.default.send_redirects="0"
    
    #
    # If net.ipv4.conf.default.send_redirects present in /etc/sysctl.conf, change value to "0"
    #	else, add "net.ipv4.conf.default.send_redirects = 0" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80999-6" ]; then
        cce="CCE"
    else
        cce="CCE-80999-6"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.conf.default.send_redirects")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "0"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.conf.default.send_redirects\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.conf.default.send_redirects\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: Ensure sysctl net.ipv4.conf.default.send_redirects is set to 0
      sysctl:
        name: net.ipv4.conf.default.send_redirects
        value: '0'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80999-6
        - CJIS-5.10.1.1
        - DISA-STIG-RHEL-07-040650
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-5
        - NIST-800-53-SC-7(a)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_conf_default_send_redirects
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,net.ipv4.conf.default.send_redirects%3D0%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_net_ipv4_conf_default_send_redirects.conf
            overwrite: true
    

#### Disable Kernel Parameter for IP Forwarding on IPv4 Interfaces   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_ip_forward)rule

To set the runtime status of the `net.ipv4.ip_forward` kernel parameter, run the following command:

$ sudo sysctl -w net.ipv4.ip\_forward=0

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

net.ipv4.ip\_forward = 0

Warning:  Certain technologies such as virtual machines, containers, etc. rely on IPv4 forwarding to enable and use networking. Disabling IPv4 forwarding would cause those technologies to stop working. Therefore, this rule should not be used in profiles or benchmarks that target usage of IPv4 forwarding.

Rationale:

Routing protocol daemons are typically used on routers to exchange network topology information with other routers. If this capability is used when not required, system network information may be unnecessarily transmitted across the network.

Severity:  medium

Identifiers:  CCE-80157-1

References:  [BP28(R22)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI04.04](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.20](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.1.3](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.17.2.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CIP-007-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040740](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204625r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.2.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    
    #
    # Set runtime for net.ipv4.ip_forward
    #
    /sbin/sysctl -q -n -w net.ipv4.ip_forward="0"
    
    #
    # If net.ipv4.ip_forward present in /etc/sysctl.conf, change value to "0"
    #	else, add "net.ipv4.ip_forward = 0" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80157-1" ]; then
        cce="CCE"
    else
        cce="CCE-80157-1"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^net.ipv4.ip_forward")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "0"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^net.ipv4.ip_forward\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^net.ipv4.ip_forward\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: Ensure sysctl net.ipv4.ip_forward is set to 0
      sysctl:
        name: net.ipv4.ip_forward
        value: '0'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80157-1
        - DISA-STIG-RHEL-07-040740
        - NIST-800-171-3.1.20
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-SC-5
        - NIST-800-53-SC-7(a)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_net_ipv4_ip_forward
    

### Uncommon Network Protocols   [\[ref\]](#xccdf_org.ssgproject.content_group_network-uncommon)group

The system includes support for several network protocols which are not commonly used. Although security vulnerabilities in kernel networking code are not frequently discovered, the consequences can be dramatic. Ensuring uncommon network protocols are disabled reduces the system's risk to attacks targeted at its implementation of those protocols.

Warning:  Although these protocols are not commonly used, avoid disruption in your network environment by ensuring they are not needed prior to disabling them.

contains 1 rule

#### Disable DCCP Support   [\[ref\]](#xccdf_org.ssgproject.content_rule_kernel_module_dccp_disabled)rule

The Datagram Congestion Control Protocol (DCCP) is a relatively new transport layer protocol, designed to support streaming media and telephony. To configure the system to prevent the `dccp` kernel module from being loaded, add the following line to a file in the directory `/etc/modprobe.d`:

install dccp /bin/true

Rationale:

Disabling DCCP protects the system against exploitation of any flaws in its implementation.

Severity:  medium

Identifiers:  CCE-82024-1

References:  [11](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.10.1](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.4.6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-001958](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000096-GPOS-00050](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000378-GPOS-00163](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020101](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204450r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.4.1](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if LC_ALL=C grep -q -m 1 "^install dccp" /etc/modprobe.d/dccp.conf ; then
    	
    	sed -i 's#^install dccp.*#install dccp /bin/true#g' /etc/modprobe.d/dccp.conf
    else
    	echo -e "\n# Disable per security requirements" >> /etc/modprobe.d/dccp.conf
    	echo "install dccp /bin/true" >> /etc/modprobe.d/dccp.conf
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: Ensure kernel module 'dccp' is disabled
      lineinfile:
        create: true
        dest: /etc/modprobe.d/dccp.conf
        regexp: dccp
        line: install dccp /bin/true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82024-1
        - CJIS-5.10.1
        - DISA-STIG-RHEL-07-020101
        - NIST-800-171-3.4.6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - kernel_module_dccp_disabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
    

### Wireless Networking   [\[ref\]](#xccdf_org.ssgproject.content_group_network-wireless)group

Wireless networking, such as 802.11 (WiFi) and Bluetooth, can present a security risk to sensitive or classified systems and networks. Wireless networking hardware is much more likely to be included in laptop or portable systems than in desktops or servers.  
  
Removal of hardware provides the greatest assurance that the wireless capability remains disabled. Acquisition policies often include provisions to prevent the purchase of equipment that will be used in sensitive spaces and includes wireless capabilities. If it is impractical to remove the wireless hardware, and policy permits the device to enter sensitive spaces as long as wireless is disabled, efforts should instead focus on disabling wireless capability via software.

contains 1 rule

### Disable Wireless Through Software Configuration   [\[ref\]](#xccdf_org.ssgproject.content_group_wireless_software)group

If it is impossible to remove the wireless hardware from the device in question, disable as much of it as possible through software. The following methods can disable software support for wireless networking, but note that these methods do not prevent malicious software or careless users from re-activating the devices.

contains 1 rule

#### Deactivate Wireless Network Interfaces   [\[ref\]](#xccdf_org.ssgproject.content_rule_wireless_disable_interfaces)rule

Deactivating wireless network interfaces should prevent normal usage of the wireless capability.  
  
Configure the system to disable all wireless network interfaces with the following command:

$ sudo nmcli radio wifi off

Rationale:

The use of wireless networking can introduce many different attack vectors into the organization's network. Common attack vectors such as malicious association and ad hoc networks will allow an attacker to spoof a wireless access point (AP), allowing validated systems to connect to the malicious AP and enabling the attacker to monitor and record network traffic. These malicious APs can also serve to create a man-in-the-middle attack or be used to create a denial of service to valid network resources.

Severity:  medium

Identifiers:  CCE-27358-1

References:  [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.16](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000085](https://public.cyber.mil/stigs/cci/), [CCI-002418](https://public.cyber.mil/stigs/cci/), [CCI-002421](https://public.cyber.mil/stigs/cci/), [CCI-001444](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 1315, 1319, [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [AC-18(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-18(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MP-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000299-GPOS-00117](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000300-GPOS-00118](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000424-GPOS-00188](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000481-GPOS-000481](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-041010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204634r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [3.1.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    nmcli radio wifi off
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Deactivate Wireless Network Interfaces
      command: nmcli radio wifi off
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27358-1
        - DISA-STIG-RHEL-07-041010
        - NIST-800-171-3.1.16
        - NIST-800-53-AC-18(3)
        - NIST-800-53-AC-18(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy
        - wireless_disable_interfaces
    

#### Configure Multiple DNS Servers in /etc/resolv.conf   [\[ref\]](#xccdf_org.ssgproject.content_rule_network_configure_name_resolution)rule

Multiple Domain Name System (DNS) Servers should be configured in `/etc/resolv.conf`. This provides redundant name resolution services in the event that a domain server crashes. To configure the system to contain as least `2` DNS servers, add a corresponding `nameserver _ip_address_` entry in `/etc/resolv.conf` for each DNS server where _ip\_address_ is the IP address of a valid DNS server. For example:

search example.com
nameserver 192.168.0.1
nameserver 192.168.0.2

Rationale:

To provide availability for name resolution services, multiple redundant name servers are mandated. A failure in name resolution could lead to the failure of security functions requiring name resolution, which may include time synchronization, centralized authentication, and remote system logging.

Severity:  low

Identifiers:  CCE-80438-5

References:  [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [SC-20(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040600](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204608r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Ensure System is Not Acting as a Network Sniffer   [\[ref\]](#xccdf_org.ssgproject.content_rule_network_sniffer_disabled)rule

The system should not be acting as a network sniffer, which can capture all traffic on the network to which it is connected. Run the following to determine if any interface is running in promiscuous mode:

$ ip link | grep PROMISC

Promiscuous mode of an interface can be disabled with the following command:

$ sudo ip link set dev `device_name` multicast off promisc off

Rationale:

Network interfaces in promiscuous mode allow for the capture of all network traffic visible to the system. If unauthorized individuals can access these applications, it may allow them to collect information such as logon IDs, passwords, and key exchanges between systems.  
  
If the system is being used to perform a network troubleshooting function, the use of these tools must be documented with the Information Systems Security Manager (ISSM) and restricted to only authorized personnel.

Severity:  medium

Identifiers:  CCE-80174-6

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO11.06](https://www.isaca.org/resources/cobit), [APO12.06](https://www.isaca.org/resources/cobit), [BAI03.10](https://www.isaca.org/resources/cobit), [BAI09.01](https://www.isaca.org/resources/cobit), [BAI09.02](https://www.isaca.org/resources/cobit), [BAI09.03](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS04.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.1.2](https://www.iso.org/standard/54534.html), [A.11.2.4](https://www.iso.org/standard/54534.html), [A.11.2.5](https://www.iso.org/standard/54534.html), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.16.1.6](https://www.iso.org/standard/54534.html), [A.8.1.1](https://www.iso.org/standard/54534.html), [A.8.1.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MA-3](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.DP-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.MA-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040670](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204618r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### File Permissions and Masks   [\[ref\]](#xccdf_org.ssgproject.content_group_permissions)group

Traditional Unix security relies heavily on file and directory permissions to prevent unauthorized users from reading or modifying files to which they should not have access.  
  
Several of the commands in this section search filesystems for files or directories with certain characteristics, and are intended to be run on every local partition on a given system. When the variable _PART_ appears in one of the commands below, it means that the command is intended to be run repeatedly, with the name of each local partition substituted for _PART_ in turn.  
  
The following command prints a list of all xfs partitions on the local system, which is the default filesystem for Red Hat Enterprise Linux 7 installations:

$ mount -t xfs | awk '{print $3}'

For any systems that use a different local filesystem type, modify this command as appropriate.

contains 12 rules

### Verify Permissions on Important Files and Directories   [\[ref\]](#xccdf_org.ssgproject.content_group_files)group

Permissions for many files on a system must be set restrictively to ensure sensitive information is properly protected. This section discusses important permission restrictions which can be verified to ensure that no harmful discrepancies have arisen.

contains 4 rules

#### Ensure All World-Writable Directories Are Owned by a System Account   [\[ref\]](#xccdf_org.ssgproject.content_rule_dir_perms_world_writable_system_owned)rule

All directories in local partitions which are world-writable should be owned by root or another system account. If any world-writable directories are not owned by a system account, this should be investigated. Following this, the files should be deleted or assigned to an appropriate owner.

Rationale:

Allowing a user account to own a world-writable directory is undesirable because it allows the owner of that directory to remove or replace any files that may be placed in the directory by other users.

Severity:  medium

Identifiers:  CCE-80136-5

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021031](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-228563r744119\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Ensure All World-Writable Directories Are Group Owned by a System Account   [\[ref\]](#xccdf_org.ssgproject.content_rule_dir_perms_world_writable_system_owned_group)rule

All directories in local partitions which are world-writable should be group owned by root or another system account. If any world-writable directories are not group owned by a system account, this should be investigated. Following this, the files should be deleted or assigned to an appropriate group.

Rationale:

Allowing a user account to group own a world-writable directory is undesirable because it allows the owner of that directory to remove or replace any files that may be placed in the directory by other users.

Severity:  medium

Identifiers:  CCE-83923-3

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021030](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204487r744106\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Ensure All Files Are Owned by a Group   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_permissions_ungroupowned)rule

If any files are not owned by a group, then the cause of their lack of group-ownership should be investigated. Following this, the files should be deleted or assigned to an appropriate group. The following command will discover and print any files on local partitions which do not belong to a valid group:

$ df --local -P | awk '{if (NR!=1) print $6}' | sudo xargs -I '{}' find '{}' -xdev -nogroup

To search all filesystems on a system including network mounted filesystems the following command can be run manually for each partition:

$ sudo find PARTITION -xdev -nogroup

Warning:  This rule only considers local groups. If you have your groups defined outside `/etc/group`, the rule won't consider those.

Rationale:

Unowned files do not directly imply a security problem, but they are generally a sign that something is amiss. They may be caused by an intruder, by incorrect software installation or draft software removal, or by failure to remove all files belonging to a deleted account. The files should be repaired so they will not cause problems when accounts are created in the future, and the cause should be discovered and addressed.

Severity:  medium

Identifiers:  CCE-80135-7

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-002165](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020330](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204464r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [6.1.12](https://www.cisecurity.org/benchmark/red_hat_linux/)

#### Ensure All Files Are Owned by a User   [\[ref\]](#xccdf_org.ssgproject.content_rule_no_files_unowned_by_user)rule

If any files are not owned by a user, then the cause of their lack of ownership should be investigated. Following this, the files should be deleted or assigned to an appropriate user. The following command will discover and print any files on local partitions which do not belong to a valid user:

$ df --local -P | awk {'if (NR!=1) print $6'} | sudo xargs -I '{}' find '{}' -xdev -nouser

To search all filesystems on a system including network mounted filesystems the following command can be run manually for each partition:

$ sudo find PARTITION -xdev -nouser

Warning:  For this rule to evaluate centralized user accounts, `getent` must be working properly so that running the command

getent passwd

returns a list of all users in your organization. If using the System Security Services Daemon (SSSD),

enumerate = true

must be configured in your organization's domain to return a complete list of users

Warning:  Enabling this rule will result in slower scan times depending on the size of your organization and number of centralized users.

Rationale:

Unowned files do not directly imply a security problem, but they are generally a sign that something is amiss. They may be caused by an intruder, by incorrect software installation or draft software removal, or by failure to remove all files belonging to a deleted account. The files should be repaired so they will not cause problems when accounts are created in the future, and the cause should be discovered and addressed.

Severity:  medium

Identifiers:  CCE-80134-0

References:  [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-002165](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020320](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204463r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [6.1.11](https://www.cisecurity.org/benchmark/red_hat_linux/)

### Restrict Dynamic Mounting and Unmounting of Filesystems   [\[ref\]](#xccdf_org.ssgproject.content_group_mounting)group

Linux includes a number of facilities for the automated addition and removal of filesystems on a running system. These facilities may be necessary in many environments, but this capability also carries some risk -- whether direct risk from allowing users to introduce arbitrary filesystems, or risk that software flaws in the automated mount facility itself could allow an attacker to compromise the system.  
  
This command can be used to list the types of filesystems that are available to the currently executing kernel:

$ find /lib/modules/\`uname -r\`/kernel/fs -type f -name '\*.ko'

If these filesystems are not required then they can be explicitly disabled in a configuratio file in `/etc/modprobe.d`.

contains 2 rules

#### Disable the Automounter   [\[ref\]](#xccdf_org.ssgproject.content_rule_service_autofs_disabled)rule

The `autofs` daemon mounts and unmounts filesystems, such as user home directories shared via NFS, on demand. In addition, autofs can be used to handle removable media, and the default configuration provides the cdrom device as `/misc/cd`. However, this method of providing access to removable media is not common, so autofs can almost always be disabled if NFS is not in use. Even if NFS is required, it may be possible to configure filesystem mounts statically by editing `/etc/fstab` rather than relying on the automounter.  
  
The `autofs` service can be disabled with the following command:

$ sudo systemctl mask --now autofs.service

Rationale:

Disabling the automounter permits the administrator to statically control filesystem mounting through `/etc/fstab`.  
  
Additionally, automatically mounting filesystems permits easy introduction of unknown devices, thereby facilitating malicious activity.

Severity:  medium

Identifiers:  CCE-27498-5

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.4.6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000778](https://public.cyber.mil/stigs/cci/), [CCI-001958](https://public.cyber.mil/stigs/cci/), [164.308(a)(3)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(iv)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MP-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000114-GPOS-00059](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000378-GPOS-00163](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020110](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204451r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.1.23](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    SYSTEMCTL_EXEC='/usr/bin/systemctl'
    "$SYSTEMCTL_EXEC" stop 'autofs.service'
    "$SYSTEMCTL_EXEC" disable 'autofs.service'
    "$SYSTEMCTL_EXEC" mask 'autofs.service'
    # Disable socket activation if we have a unit file for it
    if "$SYSTEMCTL_EXEC" list-unit-files | grep -q '^autofs.socket'; then
        "$SYSTEMCTL_EXEC" stop 'autofs.socket'
        "$SYSTEMCTL_EXEC" mask 'autofs.socket'
    fi
    # The service may not be running because it has been started and failed,
    # so let's reset the state so OVAL checks pass.
    # Service should be 'inactive', not 'failed' after reboot though.
    "$SYSTEMCTL_EXEC" reset-failed 'autofs.service' || true
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    - name: Disable service autofs
      block:
    
        - name: Gather the service facts
          service_facts: null
    
        - name: Disable service autofs
          systemd:
            name: autofs.service
            enabled: 'no'
            state: stopped
            masked: 'yes'
          when: '"autofs.service" in ansible_facts.services'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27498-5
        - DISA-STIG-RHEL-07-020110
        - NIST-800-171-3.4.6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_autofs_disabled
    
    - name: Unit Socket Exists - autofs.socket
      command: systemctl list-unit-files autofs.socket
      args:
        warn: false
      register: socket_file_exists
      changed_when: false
      ignore_errors: true
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27498-5
        - DISA-STIG-RHEL-07-020110
        - NIST-800-171-3.4.6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_autofs_disabled
    
    - name: Disable socket autofs
      systemd:
        name: autofs.socket
        enabled: 'no'
        state: stopped
        masked: 'yes'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - '"autofs.socket" in socket_file_exists.stdout_lines[1]'
      tags:
        - CCE-27498-5
        - DISA-STIG-RHEL-07-020110
        - NIST-800-171-3.4.6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_autofs_disabled
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    include disable_autofs
    
    class disable_autofs {
      service {'autofs':
        enable => false,
        ensure => 'stopped',
      }
    }
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        systemd:
          units:
          - enabled: false
            name: autofs.service
    

#### Disable Modprobe Loading of USB Storage Driver   [\[ref\]](#xccdf_org.ssgproject.content_rule_kernel_module_usb-storage_disabled)rule

To prevent USB storage devices from being used, configure the kernel module loading system to prevent automatic loading of the USB storage driver. To configure the system to prevent the `usb-storage` kernel module from being loaded, add the following line to a file in the directory `/etc/modprobe.d`:

install usb-storage /bin/true

This will prevent the `modprobe` program from loading the `usb-storage` module, but will not prevent an administrator (or another program) from using the `insmod` program to load the module manually.

Rationale:

USB storage devices such as thumb drives can be used to introduce malicious software.

Severity:  medium

Identifiers:  CCE-27277-3

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.21](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000778](https://public.cyber.mil/stigs/cci/), [CCI-001958](https://public.cyber.mil/stigs/cci/), [164.308(a)(3)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)(ii)(A)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(d)(2)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)(2)(iv)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MP-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000114-GPOS-00059](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000378-GPOS-00163](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020100](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204449r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.1.24](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if LC_ALL=C grep -q -m 1 "^install usb-storage" /etc/modprobe.d/usb-storage.conf ; then
    	
    	sed -i 's#^install usb-storage.*#install usb-storage /bin/true#g' /etc/modprobe.d/usb-storage.conf
    else
    	echo -e "\n# Disable per security requirements" >> /etc/modprobe.d/usb-storage.conf
    	echo "install usb-storage /bin/true" >> /etc/modprobe.d/usb-storage.conf
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: Ensure kernel module 'usb-storage' is disabled
      lineinfile:
        create: true
        dest: /etc/modprobe.d/usb-storage.conf
        regexp: usb-storage
        line: install usb-storage /bin/true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27277-3
        - DISA-STIG-RHEL-07-020100
        - NIST-800-171-3.1.21
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - disable_strategy
        - kernel_module_usb-storage_disabled
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,install%20usb-storage%20/bin/true%0A
            mode: 0644
            path: /etc/modprobe.d/75-kernel_module_usb-storage_disabled.conf
            overwrite: true
    

### Restrict Partition Mount Options   [\[ref\]](#xccdf_org.ssgproject.content_group_partitions)group

System partitions can be mounted with certain options that limit what files on those partitions can do. These options are set in the `/etc/fstab` configuration file, and can be used to make certain types of malicious behavior more difficult.

contains 5 rules

#### Add nodev Option to /dev/shm   [\[ref\]](#xccdf_org.ssgproject.content_rule_mount_option_dev_shm_nodev)rule

The `nodev` mount option can be used to prevent creation of device files in `/dev/shm`. Legitimate character and block devices should not exist within temporary directories like `/dev/shm`. Add the `nodev` option to the fourth column of `/etc/fstab` for the line which controls mounting of `/dev/shm`.

Rationale:

The only legitimate location for device files is the `/dev` directory located on the root partition. The only exception to this is chroot jails.

Severity:  low

Identifiers:  CCE-80152-2

References:  [11](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.06](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-001764](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.9](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.8.2.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.8.3.1](https://www.iso.org/standard/54534.html), [A.8.3.3](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MP-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000368-GPOS-00154](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021022](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [1.1.8](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    function perform_remediation {
        
    
        mount_point_match_regexp="$(printf "[[:space:]]%s[[:space:]]" /dev/shm)"
    
        # If the mount point is not in /etc/fstab, get previous mount options from /etc/mtab
        if [ "$(grep -c "$mount_point_match_regexp" /etc/fstab)" -eq 0 ]; then
            # runtime opts without some automatic kernel/userspace-added defaults
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/mtab | head -1 |  awk '{print $4}' \
                        | sed -E "s/(rw|defaults|seclabel|nodev)(,|$)//g;s/,$//")
            [ "$previous_mount_opts" ] && previous_mount_opts+=","
            echo "tmpfs /dev/shm tmpfs defaults,${previous_mount_opts}nodev 0 0" >> /etc/fstab
        # If the mount_opt option is not already in the mount point's /etc/fstab entry, add it
        elif [ "$(grep "$mount_point_match_regexp" /etc/fstab | grep -c "nodev")" -eq 0 ]; then
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/fstab | awk '{print $4}')
            sed -i "s|\(${mount_point_match_regexp}.*${previous_mount_opts}\)|\1,nodev|" /etc/fstab
        fi
    
        if mkdir -p "/dev/shm"; then
            if mountpoint -q "/dev/shm"; then
                mount -o remount --target "/dev/shm"
            else
                mount --target "/dev/shm"
            fi
        fi
    }
    
    perform_remediation
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

configure

    - name: Check information associated to mountpoint
      command: findmnt  '/dev/shm'
      register: device_name
      failed_when: device_name.rc > 1
      changed_when: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80152-2
        - DISA-STIG-RHEL-07-021022
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nodev
        - no_reboot_needed
    
    - name: Create mount_info dictionary variable
      set_fact:
        mount_info: '{{ mount_info|default({})|combine({item.0: item.1}) }}'
      with_together:
        - '{{ device_name.stdout_lines[0].split() | list | lower }}'
        - '{{ device_name.stdout_lines[1].split() | list }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - device_name.stdout is defined and device_name.stdout_lines is defined
        - (device_name.stdout | length > 0)
      tags:
        - CCE-80152-2
        - DISA-STIG-RHEL-07-021022
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nodev
        - no_reboot_needed
    
    - name: If /dev/shm not mounted, craft mount_info manually
      set_fact:
        mount_info: '{{ mount_info|default({})|combine({item.0: item.1}) }}'
      with_together:
        - - target
          - source
          - fstype
          - options
        - - /dev/shm
          - tmpfs
          - tmpfs
          - defaults
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - ("" | length == 0)
        - (device_name.stdout | length == 0)
      tags:
        - CCE-80152-2
        - DISA-STIG-RHEL-07-021022
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nodev
        - no_reboot_needed
    
    - name: Make sure nodev option is part of the to /dev/shm options
      set_fact:
        mount_info: '{{ mount_info | combine( {''options'':''''~mount_info.options~'',nodev''
          }) }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - mount_info is defined and "nodev" not in mount_info.options
      tags:
        - CCE-80152-2
        - DISA-STIG-RHEL-07-021022
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nodev
        - no_reboot_needed
    
    - name: Ensure /dev/shm is mounted with nodev option
      mount:
        path: /dev/shm
        src: '{{ mount_info.source }}'
        opts: '{{ mount_info.options }}'
        state: mounted
        fstype: '{{ mount_info.fstype }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - (device_name.stdout is defined and (device_name.stdout | length > 0)) or (""
          | length == 0)
      tags:
        - CCE-80152-2
        - DISA-STIG-RHEL-07-021022
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nodev
        - no_reboot_needed
    

#### Add noexec Option to /dev/shm   [\[ref\]](#xccdf_org.ssgproject.content_rule_mount_option_dev_shm_noexec)rule

The `noexec` mount option can be used to prevent binaries from being executed out of `/dev/shm`. It can be dangerous to allow the execution of binaries from world-writable temporary storage directories such as `/dev/shm`. Add the `noexec` option to the fourth column of `/etc/fstab` for the line which controls mounting of `/dev/shm`.

Rationale:

Allowing users to execute binaries from world-writable directories such as `/dev/shm` can expose the system to potential compromise.

Severity:  low

Identifiers:  CCE-80153-0

References:  [11](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.06](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-001764](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.9](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.8.2.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.8.3.1](https://www.iso.org/standard/54534.html), [A.8.3.3](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MP-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000368-GPOS-00154](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021024](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204486r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.1.7](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    function perform_remediation {
        
    
        mount_point_match_regexp="$(printf "[[:space:]]%s[[:space:]]" /dev/shm)"
    
        # If the mount point is not in /etc/fstab, get previous mount options from /etc/mtab
        if [ "$(grep -c "$mount_point_match_regexp" /etc/fstab)" -eq 0 ]; then
            # runtime opts without some automatic kernel/userspace-added defaults
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/mtab | head -1 |  awk '{print $4}' \
                        | sed -E "s/(rw|defaults|seclabel|noexec)(,|$)//g;s/,$//")
            [ "$previous_mount_opts" ] && previous_mount_opts+=","
            echo "tmpfs /dev/shm tmpfs defaults,${previous_mount_opts}noexec 0 0" >> /etc/fstab
        # If the mount_opt option is not already in the mount point's /etc/fstab entry, add it
        elif [ "$(grep "$mount_point_match_regexp" /etc/fstab | grep -c "noexec")" -eq 0 ]; then
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/fstab | awk '{print $4}')
            sed -i "s|\(${mount_point_match_regexp}.*${previous_mount_opts}\)|\1,noexec|" /etc/fstab
        fi
    
        if mkdir -p "/dev/shm"; then
            if mountpoint -q "/dev/shm"; then
                mount -o remount --target "/dev/shm"
            else
                mount --target "/dev/shm"
            fi
        fi
    }
    
    perform_remediation
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

configure

    - name: Check information associated to mountpoint
      command: findmnt  '/dev/shm'
      register: device_name
      failed_when: device_name.rc > 1
      changed_when: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80153-0
        - DISA-STIG-RHEL-07-021024
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_noexec
        - no_reboot_needed
    
    - name: Create mount_info dictionary variable
      set_fact:
        mount_info: '{{ mount_info|default({})|combine({item.0: item.1}) }}'
      with_together:
        - '{{ device_name.stdout_lines[0].split() | list | lower }}'
        - '{{ device_name.stdout_lines[1].split() | list }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - device_name.stdout is defined and device_name.stdout_lines is defined
        - (device_name.stdout | length > 0)
      tags:
        - CCE-80153-0
        - DISA-STIG-RHEL-07-021024
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_noexec
        - no_reboot_needed
    
    - name: If /dev/shm not mounted, craft mount_info manually
      set_fact:
        mount_info: '{{ mount_info|default({})|combine({item.0: item.1}) }}'
      with_together:
        - - target
          - source
          - fstype
          - options
        - - /dev/shm
          - tmpfs
          - tmpfs
          - defaults
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - ("" | length == 0)
        - (device_name.stdout | length == 0)
      tags:
        - CCE-80153-0
        - DISA-STIG-RHEL-07-021024
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_noexec
        - no_reboot_needed
    
    - name: Make sure noexec option is part of the to /dev/shm options
      set_fact:
        mount_info: '{{ mount_info | combine( {''options'':''''~mount_info.options~'',noexec''
          }) }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - mount_info is defined and "noexec" not in mount_info.options
      tags:
        - CCE-80153-0
        - DISA-STIG-RHEL-07-021024
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_noexec
        - no_reboot_needed
    
    - name: Ensure /dev/shm is mounted with noexec option
      mount:
        path: /dev/shm
        src: '{{ mount_info.source }}'
        opts: '{{ mount_info.options }}'
        state: mounted
        fstype: '{{ mount_info.fstype }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - (device_name.stdout is defined and (device_name.stdout | length > 0)) or (""
          | length == 0)
      tags:
        - CCE-80153-0
        - DISA-STIG-RHEL-07-021024
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_noexec
        - no_reboot_needed
    

#### Add nosuid Option to /dev/shm   [\[ref\]](#xccdf_org.ssgproject.content_rule_mount_option_dev_shm_nosuid)rule

The `nosuid` mount option can be used to prevent execution of setuid programs in `/dev/shm`. The SUID and SGID permissions should not be required in these world-writable directories. Add the `nosuid` option to the fourth column of `/etc/fstab` for the line which controls mounting of `/dev/shm`.

Rationale:

The presence of SUID and SGID executables should be tightly controlled. Users should not be able to execute SUID or SGID binaries from temporary storage partitions.

Severity:  low

Identifiers:  CCE-80154-8

References:  [11](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.06](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-001764](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.9](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.8.2.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.8.3.1](https://www.iso.org/standard/54534.html), [A.8.3.3](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MP-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000368-GPOS-00154](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021023](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [1.1.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    function perform_remediation {
        
    
        mount_point_match_regexp="$(printf "[[:space:]]%s[[:space:]]" /dev/shm)"
    
        # If the mount point is not in /etc/fstab, get previous mount options from /etc/mtab
        if [ "$(grep -c "$mount_point_match_regexp" /etc/fstab)" -eq 0 ]; then
            # runtime opts without some automatic kernel/userspace-added defaults
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/mtab | head -1 |  awk '{print $4}' \
                        | sed -E "s/(rw|defaults|seclabel|nosuid)(,|$)//g;s/,$//")
            [ "$previous_mount_opts" ] && previous_mount_opts+=","
            echo "tmpfs /dev/shm tmpfs defaults,${previous_mount_opts}nosuid 0 0" >> /etc/fstab
        # If the mount_opt option is not already in the mount point's /etc/fstab entry, add it
        elif [ "$(grep "$mount_point_match_regexp" /etc/fstab | grep -c "nosuid")" -eq 0 ]; then
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/fstab | awk '{print $4}')
            sed -i "s|\(${mount_point_match_regexp}.*${previous_mount_opts}\)|\1,nosuid|" /etc/fstab
        fi
    
        if mkdir -p "/dev/shm"; then
            if mountpoint -q "/dev/shm"; then
                mount -o remount --target "/dev/shm"
            else
                mount --target "/dev/shm"
            fi
        fi
    }
    
    perform_remediation
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

configure

    - name: Check information associated to mountpoint
      command: findmnt  '/dev/shm'
      register: device_name
      failed_when: device_name.rc > 1
      changed_when: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80154-8
        - DISA-STIG-RHEL-07-021023
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nosuid
        - no_reboot_needed
    
    - name: Create mount_info dictionary variable
      set_fact:
        mount_info: '{{ mount_info|default({})|combine({item.0: item.1}) }}'
      with_together:
        - '{{ device_name.stdout_lines[0].split() | list | lower }}'
        - '{{ device_name.stdout_lines[1].split() | list }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - device_name.stdout is defined and device_name.stdout_lines is defined
        - (device_name.stdout | length > 0)
      tags:
        - CCE-80154-8
        - DISA-STIG-RHEL-07-021023
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nosuid
        - no_reboot_needed
    
    - name: If /dev/shm not mounted, craft mount_info manually
      set_fact:
        mount_info: '{{ mount_info|default({})|combine({item.0: item.1}) }}'
      with_together:
        - - target
          - source
          - fstype
          - options
        - - /dev/shm
          - tmpfs
          - tmpfs
          - defaults
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - ("" | length == 0)
        - (device_name.stdout | length == 0)
      tags:
        - CCE-80154-8
        - DISA-STIG-RHEL-07-021023
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nosuid
        - no_reboot_needed
    
    - name: Make sure nosuid option is part of the to /dev/shm options
      set_fact:
        mount_info: '{{ mount_info | combine( {''options'':''''~mount_info.options~'',nosuid''
          }) }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - mount_info is defined and "nosuid" not in mount_info.options
      tags:
        - CCE-80154-8
        - DISA-STIG-RHEL-07-021023
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nosuid
        - no_reboot_needed
    
    - name: Ensure /dev/shm is mounted with nosuid option
      mount:
        path: /dev/shm
        src: '{{ mount_info.source }}'
        opts: '{{ mount_info.options }}'
        state: mounted
        fstype: '{{ mount_info.fstype }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - (device_name.stdout is defined and (device_name.stdout | length > 0)) or (""
          | length == 0)
      tags:
        - CCE-80154-8
        - DISA-STIG-RHEL-07-021023
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - low_severity
        - mount_option_dev_shm_nosuid
        - no_reboot_needed
    

#### Add nosuid Option to /home   [\[ref\]](#xccdf_org.ssgproject.content_rule_mount_option_home_nosuid)rule

The `nosuid` mount option can be used to prevent execution of setuid programs in `/home`. The SUID and SGID permissions should not be required in these user data directories. Add the `nosuid` option to the fourth column of `/etc/fstab` for the line which controls mounting of `/home`.

Rationale:

The presence of SUID and SGID executables should be tightly controlled. Users should not be able to execute SUID or SGID binaries from user home directory partitions.

Severity:  medium

Identifiers:  CCE-81153-9

References:  [BP28(R12)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.06](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.9](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.8.2.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.8.3.1](https://www.iso.org/standard/54534.html), [A.8.3.3](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MP-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000368-GPOS-00154](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021000](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204480r603838\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    function perform_remediation {
        
            mount_point_match_regexp="$(printf "[[:space:]]%s[[:space:]]" "/home")"
    
        grep "$mount_point_match_regexp" -q /etc/fstab \
            || { echo "The mount point '/home' is not even in /etc/fstab, so we can't set up mount options" >&2; 
                    echo "Not remediating, because there is no record of /home in /etc/fstab" >&2; return 1; }
        
    
        mount_point_match_regexp="$(printf "[[:space:]]%s[[:space:]]" /home)"
    
        # If the mount point is not in /etc/fstab, get previous mount options from /etc/mtab
        if [ "$(grep -c "$mount_point_match_regexp" /etc/fstab)" -eq 0 ]; then
            # runtime opts without some automatic kernel/userspace-added defaults
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/mtab | head -1 |  awk '{print $4}' \
                        | sed -E "s/(rw|defaults|seclabel|nosuid)(,|$)//g;s/,$//")
            [ "$previous_mount_opts" ] && previous_mount_opts+=","
            echo " /home  defaults,${previous_mount_opts}nosuid 0 0" >> /etc/fstab
        # If the mount_opt option is not already in the mount point's /etc/fstab entry, add it
        elif [ "$(grep "$mount_point_match_regexp" /etc/fstab | grep -c "nosuid")" -eq 0 ]; then
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/fstab | awk '{print $4}')
            sed -i "s|\(${mount_point_match_regexp}.*${previous_mount_opts}\)|\1,nosuid|" /etc/fstab
        fi
    
        if mkdir -p "/home"; then
            if mountpoint -q "/home"; then
                mount -o remount --target "/home"
            else
                mount --target "/home"
            fi
        fi
    }
    
    perform_remediation
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

configure

    - name: Check information associated to mountpoint
      command: findmnt --fstab '/home'
      register: device_name
      failed_when: device_name.rc > 1
      changed_when: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-81153-9
        - DISA-STIG-RHEL-07-021000
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - medium_severity
        - mount_option_home_nosuid
        - no_reboot_needed
    
    - name: Create mount_info dictionary variable
      set_fact:
        mount_info: '{{ mount_info|default({})|combine({item.0: item.1}) }}'
      with_together:
        - '{{ device_name.stdout_lines[0].split() | list | lower }}'
        - '{{ device_name.stdout_lines[1].split() | list }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - device_name.stdout is defined and device_name.stdout_lines is defined
        - (device_name.stdout | length > 0)
      tags:
        - CCE-81153-9
        - DISA-STIG-RHEL-07-021000
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - medium_severity
        - mount_option_home_nosuid
        - no_reboot_needed
    
    - name: If /home not mounted, craft mount_info manually
      set_fact:
        mount_info: '{{ mount_info|default({})|combine({item.0: item.1}) }}'
      with_together:
        - - target
          - source
          - fstype
          - options
        - - /home
          - ''
          - ''
          - defaults
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - ("--fstab" | length == 0)
        - (device_name.stdout | length == 0)
      tags:
        - CCE-81153-9
        - DISA-STIG-RHEL-07-021000
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - medium_severity
        - mount_option_home_nosuid
        - no_reboot_needed
    
    - name: Make sure nosuid option is part of the to /home options
      set_fact:
        mount_info: '{{ mount_info | combine( {''options'':''''~mount_info.options~'',nosuid''
          }) }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - mount_info is defined and "nosuid" not in mount_info.options
      tags:
        - CCE-81153-9
        - DISA-STIG-RHEL-07-021000
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - medium_severity
        - mount_option_home_nosuid
        - no_reboot_needed
    
    - name: Ensure /home is mounted with nosuid option
      mount:
        path: /home
        src: '{{ mount_info.source }}'
        opts: '{{ mount_info.options }}'
        state: mounted
        fstype: '{{ mount_info.fstype }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - (device_name.stdout is defined and (device_name.stdout | length > 0)) or ("--fstab"
          | length == 0)
      tags:
        - CCE-81153-9
        - DISA-STIG-RHEL-07-021000
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - medium_severity
        - mount_option_home_nosuid
        - no_reboot_needed
    

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

enable

    
    part /home --mountoptions="nosuid"
    

#### Add nosuid Option to Removable Media Partitions   [\[ref\]](#xccdf_org.ssgproject.content_rule_mount_option_nosuid_removable_partitions)rule

The `nosuid` mount option prevents set-user-identifier (SUID) and set-group-identifier (SGID) permissions from taking effect. These permissions allow users to execute binaries with the same permissions as the owner and group of the file respectively. Users should not be allowed to introduce SUID and SGID files into the system via partitions mounted from removeable media. Add the `nosuid` option to the fourth column of `/etc/fstab` for the line which controls mounting of any removable media partitions.

Rationale:

The presence of SUID and SGID executables should be tightly controlled. Allowing users to introduce SUID or SGID binaries from partitions mounted off of removable media would allow them to introduce their own highly-privileged programs.

Severity:  medium

Identifiers:  CCE-80148-0

References:  [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.06](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.11.2.9](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.8.3.1](https://www.iso.org/standard/54534.html), [A.8.3.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MP-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204481r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.1.21](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_removable_partition="/dev/cdrom"
    
    
    
    device_regex="^\s*$var_removable_partition\s\+"
    mount_option="nosuid"
    
    if grep -q $device_regex /etc/fstab ; then
        previous_opts=$(grep $device_regex /etc/fstab | awk '{print $4}')
        sed -i "s|\($device_regex.*$previous_opts\)|\1,$mount_option|" /etc/fstab
    else
        echo "Not remediating, because there is no record of $var_removable_partition in /etc/fstab" >&2
        return 1
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

high

Strategy:

configure

    - name: XCCDF Value var_removable_partition # promote to variable
      set_fact:
        var_removable_partition: !!str /dev/cdrom
      tags:
        - always
    
    - name: Ensure permission nosuid are set on var_removable_partition
      lineinfile:
        path: /etc/fstab
        regexp: ^\s*({{ var_removable_partition }})\s+([^\s]*)\s+([^\s]*)\s+([^\s]*)(.*)$
        backrefs: true
        line: \1 \2 \3 \4,nosuid \5
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80148-0
        - DISA-STIG-RHEL-07-021010
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-MP-7
        - configure_strategy
        - high_disruption
        - low_complexity
        - medium_severity
        - mount_option_nosuid_removable_partitions
        - no_reboot_needed
    

### Restrict Programs from Dangerous Execution Patterns   [\[ref\]](#xccdf_org.ssgproject.content_group_restrictions)group

The recommendations in this section are designed to ensure that the system's features to protect against potentially dangerous program execution are activated. These protections are applied at the system initialization or kernel level, and defend against certain types of badly-configured or compromised programs.

contains 1 rule

### Enable ExecShield   [\[ref\]](#xccdf_org.ssgproject.content_group_enable_execshield_settings)group

ExecShield describes kernel features that provide protection against exploitation of memory corruption errors such as buffer overflows. These features include random placement of the stack and other memory regions, prevention of execution in memory that should only hold data, and special handling of text buffers. These protections are enabled by default on 32-bit systems and controlled through `sysctl` variables `kernel.exec-shield` and `kernel.randomize_va_space`. On the latest 64-bit systems, `kernel.exec-shield` cannot be enabled or disabled with `sysctl`.

contains 1 rule

#### Enable Randomized Layout of Virtual Address Space   [\[ref\]](#xccdf_org.ssgproject.content_rule_sysctl_kernel_randomize_va_space)rule

To set the runtime status of the `kernel.randomize_va_space` kernel parameter, run the following command:

$ sudo sysctl -w kernel.randomize\_va\_space=2

To make sure that the setting is persistent, add the following line to a file in the directory `/etc/sysctl.d`:

kernel.randomize\_va\_space = 2

Rationale:

Address space layout randomization (ASLR) makes it more difficult for an attacker to predict the location of attack code they have introduced into a process's address space during an attempt at exploitation. Additionally, ASLR makes it more difficult for an attacker to know the location of existing code in order to re-purpose it using return oriented programming (ROP) techniques.

Severity:  medium

Identifiers:  CCE-27127-0

References:  [BP28(R23)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [3.1.7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-002824](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(4)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [CIP-002-3 R1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-002-3 R1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 4.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-005-3a R1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-005-3a R1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-005-3a R1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R8.4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-009-3 R.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-009-3 R4](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [SC-30](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-30(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000433-GPOS-00193](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040201](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204584r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.5.3](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    
    #
    # Set runtime for kernel.randomize_va_space
    #
    /sbin/sysctl -q -n -w kernel.randomize_va_space="2"
    
    #
    # If kernel.randomize_va_space present in /etc/sysctl.conf, change value to "2"
    #	else, add "kernel.randomize_va_space = 2" to /etc/sysctl.conf
    #
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/sysctl.conf"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27127-0" ]; then
        cce="CCE"
    else
        cce="CCE-27127-0"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^kernel.randomize_va_space")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s = %s" "$stripped_key" "2"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^kernel.randomize_va_space\\>" "/etc/sysctl.conf"; then
        "${sed_command[@]}" "s/^kernel.randomize_va_space\\>.*/$formatted_output/gi" "/etc/sysctl.conf"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/sysctl.conf" >> "/etc/sysctl.conf"
        printf '%s\n' "$formatted_output" >> "/etc/sysctl.conf"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    - name: Ensure sysctl kernel.randomize_va_space is set to 2
      sysctl:
        name: kernel.randomize_va_space
        value: '2'
        state: present
        reload: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27127-0
        - DISA-STIG-RHEL-07-040201
        - NIST-800-171-3.1.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-30
        - NIST-800-53-SC-30(2)
        - disable_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - reboot_required
        - sysctl_kernel_randomize_va_space
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,kernel.randomize_va_space%3D2%0A
            mode: 0644
            path: /etc/sysctl.d/75-sysctl_kernel_randomize_va_space.conf
            overwrite: true
    

### SELinux   [\[ref\]](#xccdf_org.ssgproject.content_group_selinux)group

SELinux is a feature of the Linux kernel which can be used to guard against misconfigured or compromised programs. SELinux enforces the idea that programs should be limited in what files they can access and what actions they can take.  
  
The default SELinux policy, as configured on Red Hat Enterprise Linux 7, has been sufficiently developed and debugged that it should be usable on almost any system with minimal configuration and a small amount of system administrator training. This policy prevents system services - including most of the common network-visible services such as mail servers, FTP servers, and DNS servers - from accessing files which those services have no valid reason to access. This action alone prevents a huge amount of possible damage from network attacks against services, from trojaned software, and so forth.  
  
This guide recommends that SELinux be enabled using the default (targeted) policy on every Red Hat Enterprise Linux 7 system, unless that system has unusual requirements which make a stronger policy appropriate.  
  
For more information on SELinux, see **[https://access.redhat.com/documentation/en-US/Red\_Hat\_Enterprise\_Linux/7/html/SELinux\_Users\_and\_Administrators\_Guide](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide)**.

contains 4 rules

#### Ensure No Device Files are Unlabeled by SELinux   [\[ref\]](#xccdf_org.ssgproject.content_rule_selinux_all_devicefiles_labeled)rule

Device files, which are used for communication with important system resources, should be labeled with proper SELinux types. If any device files carry the SELinux type `device_t` or `unlabeled_t`, report the bug so that policy can be corrected. Supply information about what the device is and what programs use it.  
  
To check for incorrectly labeled device files, run following commands:

$ sudo find /dev -context \*:device\_t:\* \\( -type c -o -type b \\) -printf "%p %Z\\n"

$ sudo find /dev -context \*:unlabeled\_t:\* \\( -type c -o -type b \\) -printf "%p %Z\\n"

It should produce no output in a well-configured system.

Warning:  Automatic remediation of this control is not available. The remediation can be achieved by amending SELinux policy.

Rationale:

If a device file carries the SELinux type `device_t` or `unlabeled_t`, then SELinux cannot properly restrict access to the device file.

Severity:  medium

Identifiers:  CCE-27326-8

References:  [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [2](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [BAI01.06](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [BAI06.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.1.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.7.2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000022](https://public.cyber.mil/stigs/cci/), [CCI-000032](https://public.cyber.mil/stigs/cci/), [CCI-000318](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000368](https://public.cyber.mil/stigs/cci/), [CCI-001812](https://public.cyber.mil/stigs/cci/), [CCI-001813](https://public.cyber.mil/stigs/cci/), [CCI-001814](https://public.cyber.mil/stigs/cci/), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.14.2.7](https://www.iso.org/standard/54534.html), [A.15.2.1](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-3(3)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020900](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204479r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Configure SELinux Policy   [\[ref\]](#xccdf_org.ssgproject.content_rule_selinux_policytype)rule

The SELinux `targeted` policy is appropriate for general-purpose desktops and servers, as well as systems in many other roles. To configure the system to use this policy, add or correct the following line in `/etc/selinux/config`:

SELINUXTYPE=targeted

Other policies, such as `mls`, provide additional security labeling and greater confinement but are not compatible with many general-purpose use cases.

Rationale:

Setting the SELinux policy to `targeted` or a more specialized policy ensures the system will confine processes that are likely to be targeted for exploitation, such as network or system services.  
  
Note: During the development or debugging of SELinux modules, it is common to temporarily place non-production systems in `permissive` mode. In such temporary cases, SELinux policies should be developed, and once work is completed, the system should be reconfigured to `targeted`.

Severity:  medium

Identifiers:  CCE-27279-9

References:  [BP28(R66)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.7.2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-002165](https://public.cyber.mil/stigs/cci/), [CCI-002696](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(4)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R6.5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-3](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-3(3)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-9](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(21)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000445-GPOS-00199](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000445-VMM-001780, [RHEL-07-020220](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204454r754748\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.6.1.3](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_selinux_policy_name="targeted"
    
    
    
    if [ -e "/etc/selinux/config" ] ; then
        
        LC_ALL=C sed -i "/^SELINUXTYPE=/Id" "/etc/selinux/config"
    else
        touch "/etc/selinux/config"
    fi
    cp "/etc/selinux/config" "/etc/selinux/config.bak"
    # Insert at the end of the file
    printf '%s\n' "SELINUXTYPE=$var_selinux_policy_name" >> "/etc/selinux/config"
    # Clean up after ourselves.
    rm "/etc/selinux/config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: XCCDF Value var_selinux_policy_name # promote to variable
      set_fact:
        var_selinux_policy_name: !!str targeted
      tags:
        - always
    
    - name: Configure SELinux Policy
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/selinux/config
            create: false
            regexp: ^SELINUXTYPE=
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/selinux/config
          lineinfile:
            path: /etc/selinux/config
            create: false
            regexp: ^SELINUXTYPE=
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/selinux/config
          lineinfile:
            path: /etc/selinux/config
            create: true
            regexp: ^SELINUXTYPE=
            line: SELINUXTYPE={{ var_selinux_policy_name }}
            state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27279-9
        - DISA-STIG-RHEL-07-020220
        - NIST-800-171-3.1.2
        - NIST-800-171-3.7.2
        - NIST-800-53-AC-3
        - NIST-800-53-AC-3(3)(a)
        - NIST-800-53-AU-9
        - NIST-800-53-SC-7(21)
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
        - selinux_policytype
    

#### Ensure SELinux State is Enforcing   [\[ref\]](#xccdf_org.ssgproject.content_rule_selinux_state)rule

The SELinux state should be set to `enforcing` at system boot time. In the file `/etc/selinux/config`, add or correct the following line to configure the system to boot into enforcing mode:

SELINUX=enforcing

Rationale:

Setting the SELinux state to enforcing ensures SELinux is able to confine potentially compromised processes to the security policy, which is designed to prevent them from causing damage to the system or further elevating their privileges.

Severity:  medium

Identifiers:  CCE-27334-2

References:  [BP28(R4)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [BP28(R66)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [4](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO11.04](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS01.05](https://www.isaca.org/resources/cobit), [DSS03.01](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [3.1.2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.7.2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-002165](https://public.cyber.mil/stigs/cci/), [CCI-002696](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(4)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.2.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.2](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.2](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R6.5](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-3](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-3(3)(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-9](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-7(21)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.AE-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [ID.AM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000445-GPOS-00199](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000445-VMM-001780, [RHEL-07-020210](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204453r754746\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [1.6.1.4](https://www.cisecurity.org/benchmark/red_hat_linux/), [1.6.1.5](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_selinux_state="enforcing"
    
    
    
    if [ -e "/etc/selinux/config" ] ; then
        
        LC_ALL=C sed -i "/^SELINUX=/Id" "/etc/selinux/config"
    else
        touch "/etc/selinux/config"
    fi
    cp "/etc/selinux/config" "/etc/selinux/config.bak"
    # Insert at the end of the file
    printf '%s\n' "SELINUX=$var_selinux_state" >> "/etc/selinux/config"
    # Clean up after ourselves.
    rm "/etc/selinux/config.bak"
    
    fixfiles onboot
    fixfiles -f relabel
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value var_selinux_state # promote to variable
      set_fact:
        var_selinux_state: !!str enforcing
      tags:
        - always
    
    - name: Ensure SELinux State is Enforcing
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/selinux/config
            create: false
            regexp: ^SELINUX=
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/selinux/config
          lineinfile:
            path: /etc/selinux/config
            create: false
            regexp: ^SELINUX=
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/selinux/config
          lineinfile:
            path: /etc/selinux/config
            create: true
            regexp: ^SELINUX=
            line: SELINUX={{ var_selinux_state }}
            state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27334-2
        - DISA-STIG-RHEL-07-020210
        - NIST-800-171-3.1.2
        - NIST-800-171-3.7.2
        - NIST-800-53-AC-3
        - NIST-800-53-AC-3(3)(a)
        - NIST-800-53-AU-9
        - NIST-800-53-SC-7(21)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - selinux_state
    

#### Map System Users To The Appropriate SELinux Role   [\[ref\]](#xccdf_org.ssgproject.content_rule_selinux_user_login_roles)rule

Configure the operating system to prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures. All administrators must be mapped to the `sysadm_u` or `staff_u` users with the appropriate domains (`sysadm_t` and `staff_t`).

$ sudo semanage login -m -s sysadm\_u _USER_

or

$ sudo semanage login -m -s staff\_u _USER_

  
  
All authorized non-administrative users must be mapped to the `user_u` role or the appropriate domain (user\_t).

$ sudo semanage login -m -s user\_u _USER_

Rationale:

Preventing non-privileged users from executing privileged functions mitigates the risk that unauthorized individuals or processes may gain unnecessary access to information or privileges.  
  
Privileged functions include, for example, establishing accounts, performing system integrity checks, or administering cryptographic key management activities. Non-privileged users are individuals who do not possess appropriate authorizations. Circumventing intrusion detection and prevention mechanisms or malicious code protection mechanisms are examples of privileged functions that require protection from non-privileged users.

Severity:  medium

Identifiers:  CCE-80543-2

References:  [CCI-002165](https://public.cyber.mil/stigs/cci/), [CCI-002235](https://public.cyber.mil/stigs/cci/), [SRG-OS-000324-GPOS-00125](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204444r754744\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

### Services   [\[ref\]](#xccdf_org.ssgproject.content_group_services)group

The best protection against vulnerable software is running less software. This section describes how to review the software which Red Hat Enterprise Linux 7 installs on a system and disable software which is not needed. It then enumerates the software packages installed on a default Red Hat Enterprise Linux 7 system and provides guidance about which ones can be safely disabled.  
  
Red Hat Enterprise Linux 7 provides a convenient minimal install option that essentially installs the bare necessities for a functional system. When building Red Hat Enterprise Linux 7 systems, it is highly recommended to select the minimal packages and then build up the system from there.

contains 48 rules

### Base Services   [\[ref\]](#xccdf_org.ssgproject.content_group_base)group

This section addresses the base services that are installed on a Red Hat Enterprise Linux 7 default installation which are not covered in other sections. Some of these services listen on the network and should be treated with particular discretion. Other services are local system utilities that may or may not be extraneous. In general, system services should be disabled if not required.

contains 1 rule

#### Disable KDump Kernel Crash Analyzer (kdump)   [\[ref\]](#xccdf_org.ssgproject.content_rule_service_kdump_disabled)rule

The `kdump` service provides a kernel crash dump analyzer. It uses the `kexec` system call to boot a secondary kernel ("capture" kernel) following a system crash, which can load information from the crashed kernel for analysis. The `kdump` service can be disabled with the following command:

$ sudo systemctl mask --now kdump.service

Rationale:

Kernel core dumps may contain the full contents of system memory at the time of the crash. Kernel core dumps consume a considerable amount of disk space and may result in denial of service by exhausting the available space on the target file system partition. Unless the system is used for kernel development or testing, there is little need to run the kdump service.

Severity:  medium

Identifiers:  CCE-80258-7

References:  [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(1)(ii)(D)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(a)(4)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(c)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(a)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FMT\_SMF\_EXT.1.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021300](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204492r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    SYSTEMCTL_EXEC='/usr/bin/systemctl'
    "$SYSTEMCTL_EXEC" stop 'kdump.service'
    "$SYSTEMCTL_EXEC" disable 'kdump.service'
    "$SYSTEMCTL_EXEC" mask 'kdump.service'
    # Disable socket activation if we have a unit file for it
    if "$SYSTEMCTL_EXEC" list-unit-files | grep -q '^kdump.socket'; then
        "$SYSTEMCTL_EXEC" stop 'kdump.socket'
        "$SYSTEMCTL_EXEC" mask 'kdump.socket'
    fi
    # The service may not be running because it has been started and failed,
    # so let's reset the state so OVAL checks pass.
    # Service should be 'inactive', not 'failed' after reboot though.
    "$SYSTEMCTL_EXEC" reset-failed 'kdump.service' || true
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    - name: Disable service kdump
      block:
    
        - name: Gather the service facts
          service_facts: null
    
        - name: Disable service kdump
          systemd:
            name: kdump.service
            enabled: 'no'
            state: stopped
            masked: 'yes'
          when: '"kdump.service" in ansible_facts.services'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80258-7
        - DISA-STIG-RHEL-07-021300
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_kdump_disabled
    
    - name: Unit Socket Exists - kdump.socket
      command: systemctl list-unit-files kdump.socket
      args:
        warn: false
      register: socket_file_exists
      changed_when: false
      ignore_errors: true
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80258-7
        - DISA-STIG-RHEL-07-021300
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_kdump_disabled
    
    - name: Disable socket kdump
      systemd:
        name: kdump.socket
        enabled: 'no'
        state: stopped
        masked: 'yes'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - '"kdump.socket" in socket_file_exists.stdout_lines[1]'
      tags:
        - CCE-80258-7
        - DISA-STIG-RHEL-07-021300
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_kdump_disabled
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    include disable_kdump
    
    class disable_kdump {
      service {'kdump':
        enable => false,
        ensure => 'stopped',
      }
    }
    

Remediation Anaconda snippet:   (show)  
  

    
    kdump --disable
    

Remediation script:   (show)  
  

Complexity:

low

Disruption:

medium

Reboot:

true

Strategy:

disable

    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        systemd:
          units:
          - name: kdump.service
            enabled: false
            mask: true
          - name: kdump.socket
            enabled: false
            mask: true
    

### Cron and At Daemons   [\[ref\]](#xccdf_org.ssgproject.content_group_cron_and_at)group

The cron and at services are used to allow commands to be executed at a later time. The cron service is required by almost all systems to perform necessary maintenance tasks, while at may or may not be required on a given system. Both daemons should be configured defensively.

contains 2 rules

### Restrict at and cron to Authorized Users if Necessary   [\[ref\]](#xccdf_org.ssgproject.content_group_restrict_at_cron_users)group

The `/etc/cron.allow` and `/etc/at.allow` files contain lists of users who are allowed to use `cron` and at to delay execution of processes. If these files exist and if the corresponding files `/etc/cron.deny` and `/etc/at.deny` do not exist, then only users listed in the relevant allow files can run the crontab and `at` commands to submit jobs to be run at scheduled intervals. On many systems, only the system administrator needs the ability to schedule jobs. Note that even if a given user is not listed in `cron.allow`, cron jobs can still be run as that user. The `cron.allow` file controls only administrative access to the crontab command for scheduling and modifying cron jobs.  
  
To restrict `at` and `cron` to only authorized users:

*   Remove the `cron.deny` file:
    
    $ sudo rm /etc/cron.deny
    
*   Edit `/etc/cron.allow`, adding one line for each user allowed to use the crontab command to create cron jobs.
*   Remove the `at.deny` file:
    
    $ sudo rm /etc/at.deny
    
*   Edit `/etc/at.allow`, adding one line for each user allowed to use the at command to create at jobs.

contains 2 rules

#### Verify Group Who Owns /etc/cron.allow file   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_groupowner_cron_allow)rule

If `/etc/cron.allow` exists, it must be group-owned by `root`. To properly set the group owner of `/etc/cron.allow`, run the command:

$ sudo chgrp root /etc/cron.allow

Rationale:

If the owner of the cron.allow file is not set to root, the possibility exists for an unauthorized user to view or edit sensitive information.

Severity:  medium

Identifiers:  CCE-80379-1

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021120](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204491r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.1.8](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    chgrp 0 /etc/cron.allow
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: Test for existence /etc/cron.allow
      stat:
        path: /etc/cron.allow
      register: file_exists
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80379-1
        - DISA-STIG-RHEL-07-021120
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - file_groupowner_cron_allow
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Ensure group owner 0 on /etc/cron.allow
      file:
        path: /etc/cron.allow
        group: '0'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - file_exists.stat is defined and file_exists.stat.exists
      tags:
        - CCE-80379-1
        - DISA-STIG-RHEL-07-021120
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - file_groupowner_cron_allow
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    

#### Verify User Who Owns /etc/cron.allow file   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_owner_cron_allow)rule

If `/etc/cron.allow` exists, it must be owned by `root`. To properly set the owner of `/etc/cron.allow`, run the command:

$ sudo chown root /etc/cron.allow 

Rationale:

If the owner of the cron.allow file is not set to root, the possibility exists for an unauthorized user to view or edit sensitive information.

Severity:  medium

Identifiers:  CCE-80378-3

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021110](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204490r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.1.8](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    chown 0 /etc/cron.allow
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: Test for existence /etc/cron.allow
      stat:
        path: /etc/cron.allow
      register: file_exists
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80378-3
        - DISA-STIG-RHEL-07-021110
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - file_owner_cron_allow
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Ensure owner 0 on /etc/cron.allow
      file:
        path: /etc/cron.allow
        owner: '0'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - file_exists.stat is defined and file_exists.stat.exists
      tags:
        - CCE-80378-3
        - DISA-STIG-RHEL-07-021110
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - file_owner_cron_allow
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    

### FTP Server   [\[ref\]](#xccdf_org.ssgproject.content_group_ftp)group

FTP is a common method for allowing remote access to files. Like telnet, the FTP protocol is unencrypted, which means that passwords and other data transmitted during the session can be captured and that the session is vulnerable to hijacking. Therefore, running the FTP server software is not recommended.  
  
However, there are some FTP server configurations which may be appropriate for some environments, particularly those which allow only read-only anonymous access as a means of downloading data available to the public.

contains 1 rule

### Disable vsftpd if Possible   [\[ref\]](#xccdf_org.ssgproject.content_group_disabling_vsftpd)group

To minimize attack surface, disable vsftpd if at all possible.

contains 1 rule

#### Uninstall vsftpd Package   [\[ref\]](#xccdf_org.ssgproject.content_rule_package_vsftpd_removed)rule

The `vsftpd` package can be removed with the following command:

 $ sudo yum erase vsftpd

Rationale:

Removing the `vsftpd` package decreases the risk of its accidental activation.

Severity:  high

Identifiers:  CCE-80245-4

References:  [11](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000197](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000381](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1).1(v)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7.1(ii)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000074-GPOS-00042](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000095-GPOS-00049](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040690](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204620r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [2.2.8](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    # CAUTION: This remediation script will remove vsftpd
    #	   from the system, and may remove any packages
    #	   that depend on vsftpd. Execute this
    #	   remediation AFTER testing on a non-production
    #	   system!
    
    if rpm -q --quiet "vsftpd" ; then
        yum remove -y "vsftpd"
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    - name: Ensure vsftpd is removed
      package:
        name: vsftpd
        state: absent
      tags:
        - CCE-80245-4
        - DISA-STIG-RHEL-07-040690
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-CM-7.1(ii)
        - NIST-800-53-IA-5(1)(c)
        - NIST-800-53-IA-5(1).1(v)
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_vsftpd_removed
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    include remove_vsftpd
    
    class remove_vsftpd {
      package { 'vsftpd':
        ensure => 'purged',
      }
    }
    

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    package --remove=vsftpd
    

### Mail Server Software   [\[ref\]](#xccdf_org.ssgproject.content_group_mail)group

Mail servers are used to send and receive email over the network. Mail is a very common service, and Mail Transfer Agents (MTAs) are obvious targets of network attack. Ensure that systems are not running MTAs unnecessarily, and configure needed MTAs as defensively as possible.  
  
Very few systems at any site should be configured to directly receive email over the network. Users should instead use mail client programs to retrieve email from a central server that supports protocols such as IMAP or POP3. However, it is normal for most systems to be independently capable of sending email, for instance so that cron jobs can report output to an administrator. Most MTAs, including Postfix, support a submission-only mode in which mail can be sent from the local system to a central site MTA (or directly delivered to a local account), but the system still cannot receive mail directly over a network.  
  
The `alternatives` program in Red Hat Enterprise Linux 7 permits selection of other mail server software (such as Sendmail), but Postfix is the default and is preferred. Postfix was coded with security in mind and can also be more effectively contained by SELinux as its modular design has resulted in separate processes performing specific actions. More information is available on its website, [http://www.postfix.org](http://www.postfix.org).

contains 1 rule

### Configure Operating System to Protect Mail Server   [\[ref\]](#xccdf_org.ssgproject.content_group_postfix_harden_os)group

The guidance in this section is appropriate for any host which is operating as a site MTA, whether the mail server runs using Sendmail, Postfix, or some other software.

contains 1 rule

### Configure Postfix if Necessary   [\[ref\]](#xccdf_org.ssgproject.content_group_postfix_server_cfg)group

Postfix stores its configuration files in the directory /etc/postfix by default. The primary configuration file is `/etc/postfix/main.cf`.

contains 1 rule

### Control Mail Relaying   [\[ref\]](#xccdf_org.ssgproject.content_group_postfix_server_relay)group

Postfix's mail relay controls are implemented with the help of the smtpd recipient restrictions option, which controls the restrictions placed on the SMTP dialogue once the sender and recipient envelope addresses are known. The guidance in the following sections should be applied to all systems. If there are systems which must be allowed to relay mail, but which cannot be trusted to relay unconditionally, configure SMTP AUTH with SSL support.

contains 1 rule

#### Prevent Unrestricted Mail Relaying   [\[ref\]](#xccdf_org.ssgproject.content_rule_postfix_prevent_unrestricted_relay)rule

Modify the

/etc/postfix/main.cf

file to restrict client connections to the local network with the following command:

$ sudo postconf -e 'smtpd\_client\_restrictions = permit\_mynetworks,reject'

Rationale:

If unrestricted mail relaying is permitted, unauthorized senders could use this host as a mail relay for the purpose of sending spam or other unauthorized activity.

Severity:  medium

Identifiers:  CCE-80512-7

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040680](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204619r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q postfix; then
    
    if ! grep -q ^smtpd_client_restrictions /etc/postfix/main.cf; then
    	echo "smtpd_client_restrictions = permit_mynetworks,reject" >> /etc/postfix/main.cf
    else
    	sed -i "s/^smtpd_client_restrictions.*/smtpd_client_restrictions = permit_mynetworks,reject/g" /etc/postfix/main.cf
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

### NFS and RPC   [\[ref\]](#xccdf_org.ssgproject.content_group_nfs_and_rpc)group

The Network File System is a popular distributed filesystem for the Unix environment, and is very widely deployed. This section discusses the circumstances under which it is possible to disable NFS and its dependencies, and then details steps which should be taken to secure NFS's configuration. This section is relevant to systems operating as NFS clients, as well as to those operating as NFS servers.

contains 3 rules

### Configure NFS Clients   [\[ref\]](#xccdf_org.ssgproject.content_group_nfs_configuring_clients)group

The steps in this section are appropriate for systems which operate as NFS clients.

contains 3 rules

### Mount Remote Filesystems with Restrictive Options   [\[ref\]](#xccdf_org.ssgproject.content_group_mounting_remote_filesystems)group

Edit the file `/etc/fstab`. For each filesystem whose type (column 3) is `nfs` or `nfs4`, add the text `,nodev,nosuid` to the list of mount options in column 4. If appropriate, also add `,noexec`.  
  
See the section titled "Restrict Partition Mount Options" for a description of the effects of these options. In general, execution of files mounted via NFS should be considered risky because of the possibility that an adversary could intercept the request and substitute a malicious file. Allowing setuid files to be executed from remote servers is particularly risky, both for this reason and because it requires the clients to extend root-level trust to the NFS server.

contains 3 rules

#### Mount Remote Filesystems with Kerberos Security   [\[ref\]](#xccdf_org.ssgproject.content_rule_mount_option_krb_sec_remote_filesystems)rule

Add the `sec=krb5:krb5i:krb5p` option to the fourth column of `/etc/fstab` for the line which controls mounting of any NFS mounts.

Rationale:

When an NFS server is configured to use AUTH\_SYS a selected userid and groupid are used to handle requests from the remote user. The userid and groupid could mistakenly or maliciously be set incorrectly. The AUTH\_GSS method of authentication uses certificates on the server and client systems to more securely authenticate the remote mount request.

Severity:  medium

Identifiers:  CCE-27458-9

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(8)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(9)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040750](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204626r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    vfstype_points=()
    readarray -t vfstype_points < <(grep -E "[[:space:]]nfs[4]?[[:space:]]" /etc/fstab | awk '{print $2}')
    
    for vfstype_point in "${vfstype_points[@]}"
    do
        mount_point_match_regexp="$(printf "[[:space:]]%s[[:space:]]" $vfstype_point)"
    
        # If the mount point is not in /etc/fstab, get previous mount options from /etc/mtab
        if [ "$(grep -c "$mount_point_match_regexp" /etc/fstab)" -eq 0 ]; then
            # runtime opts without some automatic kernel/userspace-added defaults
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/mtab | head -1 |  awk '{print $4}' \
                        | sed -E "s/(rw|defaults|seclabel|sec=krb5:krb5i:krb5p)(,|$)//g;s/,$//")
            [ "$previous_mount_opts" ] && previous_mount_opts+=","
            echo " $vfstype_point nfs4 defaults,${previous_mount_opts}sec=krb5:krb5i:krb5p 0 0" >> /etc/fstab
        # If the mount_opt option is not already in the mount point's /etc/fstab entry, add it
        elif [ "$(grep "$mount_point_match_regexp" /etc/fstab | grep -c "sec=krb5:krb5i:krb5p")" -eq 0 ]; then
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/fstab | awk '{print $4}')
            sed -i "s|\(${mount_point_match_regexp}.*${previous_mount_opts}\)|\1,sec=krb5:krb5i:krb5p|" /etc/fstab
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Strategy:

configure

    - name: Get nfs and nfs4 mount points, that don't have sec=krb5:krb5i:krb5p
      command: findmnt --fstab --types nfs,nfs4 -O nosec=krb5:krb5i:krb5p -n
      register: points_register
      check_mode: false
      changed_when: false
      failed_when: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27458-9
        - DISA-STIG-RHEL-07-040750
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-2
        - NIST-800-53-IA-2(8)
        - NIST-800-53-IA-2(9)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - mount_option_krb_sec_remote_filesystems
        - no_reboot_needed
    
    - name: Add sec=krb5:krb5i:krb5p to nfs and nfs4 mount points
      mount:
        path: '{{ item.split()[0] }}'
        src: '{{ item.split()[1] }}'
        fstype: '{{ item.split()[2] }}'
        state: mounted
        opts: '{{ item.split()[3] }},sec=krb5:krb5i:krb5p'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - (points_register.stdout | length > 0)
      with_items: '{{ points_register.stdout_lines }}'
      tags:
        - CCE-27458-9
        - DISA-STIG-RHEL-07-040750
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-2
        - NIST-800-53-IA-2(8)
        - NIST-800-53-IA-2(9)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - mount_option_krb_sec_remote_filesystems
        - no_reboot_needed
    

#### Mount Remote Filesystems with noexec   [\[ref\]](#xccdf_org.ssgproject.content_rule_mount_option_noexec_remote_filesystems)rule

Add the `noexec` option to the fourth column of `/etc/fstab` for the line which controls mounting of any NFS mounts.

Rationale:

The noexec mount option causes the system not to execute binary files. This option must be used for mounting any file system not containing approved binary files as they may be incompatible. Executing files from untrusted file systems increases the opportunity for unprivileged users to attain unauthorized administrative access.

Severity:  medium

Identifiers:  CCE-80436-9

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(8)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(10)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021021](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204483r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    vfstype_points=()
    readarray -t vfstype_points < <(grep -E "[[:space:]]nfs[4]?[[:space:]]" /etc/fstab | awk '{print $2}')
    
    for vfstype_point in "${vfstype_points[@]}"
    do
        mount_point_match_regexp="$(printf "[[:space:]]%s[[:space:]]" $vfstype_point)"
    
        # If the mount point is not in /etc/fstab, get previous mount options from /etc/mtab
        if [ "$(grep -c "$mount_point_match_regexp" /etc/fstab)" -eq 0 ]; then
            # runtime opts without some automatic kernel/userspace-added defaults
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/mtab | head -1 |  awk '{print $4}' \
                        | sed -E "s/(rw|defaults|seclabel|noexec)(,|$)//g;s/,$//")
            [ "$previous_mount_opts" ] && previous_mount_opts+=","
            echo " $vfstype_point nfs4 defaults,${previous_mount_opts}noexec 0 0" >> /etc/fstab
        # If the mount_opt option is not already in the mount point's /etc/fstab entry, add it
        elif [ "$(grep "$mount_point_match_regexp" /etc/fstab | grep -c "noexec")" -eq 0 ]; then
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/fstab | awk '{print $4}')
            sed -i "s|\(${mount_point_match_regexp}.*${previous_mount_opts}\)|\1,noexec|" /etc/fstab
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Strategy:

configure

    - name: Get nfs and nfs4 mount points, that don't have noexec
      command: findmnt --fstab --types nfs,nfs4 -O nonoexec -n
      register: points_register
      check_mode: false
      changed_when: false
      failed_when: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80436-9
        - DISA-STIG-RHEL-07-021021
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(10)
        - NIST-800-53-AC-6(8)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - mount_option_noexec_remote_filesystems
        - no_reboot_needed
    
    - name: Add noexec to nfs and nfs4 mount points
      mount:
        path: '{{ item.split()[0] }}'
        src: '{{ item.split()[1] }}'
        fstype: '{{ item.split()[2] }}'
        state: mounted
        opts: '{{ item.split()[3] }},noexec'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - (points_register.stdout | length > 0)
      with_items: '{{ points_register.stdout_lines }}'
      tags:
        - CCE-80436-9
        - DISA-STIG-RHEL-07-021021
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(10)
        - NIST-800-53-AC-6(8)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - mount_option_noexec_remote_filesystems
        - no_reboot_needed
    

#### Mount Remote Filesystems with nosuid   [\[ref\]](#xccdf_org.ssgproject.content_rule_mount_option_nosuid_remote_filesystems)rule

Add the `nosuid` option to the fourth column of `/etc/fstab` for the line which controls mounting of any NFS mounts.

Rationale:

NFS mounts should not present suid binaries to users. Only vendor-supplied suid executables should be installed to their default location on the local filesystem.

Severity:  medium

Identifiers:  CCE-80240-5

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021020](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204482r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    vfstype_points=()
    readarray -t vfstype_points < <(grep -E "[[:space:]]nfs[4]?[[:space:]]" /etc/fstab | awk '{print $2}')
    
    for vfstype_point in "${vfstype_points[@]}"
    do
        mount_point_match_regexp="$(printf "[[:space:]]%s[[:space:]]" $vfstype_point)"
    
        # If the mount point is not in /etc/fstab, get previous mount options from /etc/mtab
        if [ "$(grep -c "$mount_point_match_regexp" /etc/fstab)" -eq 0 ]; then
            # runtime opts without some automatic kernel/userspace-added defaults
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/mtab | head -1 |  awk '{print $4}' \
                        | sed -E "s/(rw|defaults|seclabel|nosuid)(,|$)//g;s/,$//")
            [ "$previous_mount_opts" ] && previous_mount_opts+=","
            echo " $vfstype_point nfs4 defaults,${previous_mount_opts}nosuid 0 0" >> /etc/fstab
        # If the mount_opt option is not already in the mount point's /etc/fstab entry, add it
        elif [ "$(grep "$mount_point_match_regexp" /etc/fstab | grep -c "nosuid")" -eq 0 ]; then
            previous_mount_opts=$(grep "$mount_point_match_regexp" /etc/fstab | awk '{print $4}')
            sed -i "s|\(${mount_point_match_regexp}.*${previous_mount_opts}\)|\1,nosuid|" /etc/fstab
        fi
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Strategy:

configure

    - name: Get nfs and nfs4 mount points, that don't have nosuid
      command: findmnt --fstab --types nfs,nfs4 -O nonosuid -n
      register: points_register
      check_mode: false
      changed_when: false
      failed_when: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80240-5
        - DISA-STIG-RHEL-07-021020
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM6(a)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - mount_option_nosuid_remote_filesystems
        - no_reboot_needed
    
    - name: Add nosuid to nfs and nfs4 mount points
      mount:
        path: '{{ item.split()[0] }}'
        src: '{{ item.split()[1] }}'
        fstype: '{{ item.split()[2] }}'
        state: mounted
        opts: '{{ item.split()[3] }},nosuid'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - (points_register.stdout | length > 0)
      with_items: '{{ points_register.stdout_lines }}'
      tags:
        - CCE-80240-5
        - DISA-STIG-RHEL-07-021020
        - NIST-800-53-AC-6
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM6(a)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - mount_option_nosuid_remote_filesystems
        - no_reboot_needed
    

### Network Time Protocol   [\[ref\]](#xccdf_org.ssgproject.content_group_ntp)group

The Network Time Protocol is used to manage the system clock over a network. Computer clocks are not very accurate, so time will drift unpredictably on unmanaged systems. Central time protocols can be used both to ensure that time is consistent among a network of systems, and that their time is consistent with the outside world.  
  
If every system on a network reliably reports the same time, then it is much easier to correlate log messages in case of an attack. In addition, a number of cryptographic protocols (such as Kerberos) use timestamps to prevent certain types of attacks. If your network does not have synchronized time, these protocols may be unreliable or even unusable.  
  
Depending on the specifics of the network, global time accuracy may be just as important as local synchronization, or not very important at all. If your network is connected to the Internet, using a public timeserver (or one provided by your enterprise) provides globally accurate timestamps which may be essential in investigating or responding to an attack which originated outside of your network.  
  
A typical network setup involves a small number of internal systems operating as NTP servers, and the remainder obtaining time information from those internal servers.  
  
There is a choice between the daemons `ntpd` and `chronyd`, which are available from the repositories in the `ntp` and `chrony` packages respectively.  
  
The default `chronyd` daemon can work well when external time references are only intermittently accesible, can perform well even when the network is congested for longer periods of time, can usually synchronize the clock faster and with better time accuracy, and quickly adapts to sudden changes in the rate of the clock, for example, due to changes in the temperature of the crystal oscillator. `Chronyd` should be considered for all systems which are frequently suspended or otherwise intermittently disconnected and reconnected to a network. Mobile and virtual systems for example.  
  
The `ntpd` NTP daemon fully supports NTP protocol version 4 (RFC 5905), including broadcast, multicast, manycast clients and servers, and the orphan mode. It also supports extra authentication schemes based on public-key cryptography (RFC 5906). The NTP daemon (`ntpd`) should be considered for systems which are normally kept permanently on. Systems which are required to use broadcast or multicast IP, or to perform authentication of packets with the `Autokey` protocol, should consider using `ntpd`.  
  
Refer to [https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/7/html/system\_administrators\_guide/ch-configuring\_ntp\_using\_the\_chrony\_suite](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-configuring_ntp_using_the_chrony_suite) for more detailed comparison of features of `chronyd` and `ntpd` daemon features respectively, and for further guidance how to choose between the two NTP daemons.  
  
The upstream manual pages at [http://chrony.tuxfamily.org/manual.html](http://chrony.tuxfamily.org/manual.html) for `chronyd` and [http://www.ntp.org](http://www.ntp.org) for `ntpd` provide additional information on the capabilities and configuration of each of the NTP daemons.

contains 1 rule

#### Configure Time Service Maxpoll Interval   [\[ref\]](#xccdf_org.ssgproject.content_rule_chronyd_or_ntpd_set_maxpoll)rule

The `maxpoll` should be configured to 10 in `/etc/ntp.conf` or `/etc/chrony.conf` to continuously poll time servers. To configure `maxpoll` in `/etc/ntp.conf` or `/etc/chrony.conf` add the following:

maxpoll 10

Rationale:

Inaccurate time stamps make it more difficult to correlate events and can lead to an inaccurate analysis. Determining the correct time a particular event occurred on a system is critical when conducting forensic analysis and investigating system events. Sources outside the configured acceptable allowance (drift) may be inaccurate.

Severity:  medium

Identifiers:  CCE-80439-3

References:  [1](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [6](https://www.cisecurity.org/controls/), [APO11.04](https://www.isaca.org/resources/cobit), [BAI03.05](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [MEA02.01](https://www.isaca.org/resources/cobit), [CCI-001891](https://public.cyber.mil/stigs/cci/), [CCI-002046](https://public.cyber.mil/stigs/cci/), [4.3.3.3.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.4.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.4.2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.2](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.12.4.4](https://www.iso.org/standard/54534.html), [A.12.7.1](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AU-8(1)(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.PT-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000355-GPOS-00143](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000356-GPOS-00144](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000359-GPOS-00146](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040500](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204603r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ] && { rpm --quiet -q chrony || rpm --quiet -q ntp; }; then
    
    
    var_time_service_set_maxpoll="10"
    
    
    
    
    config_file="/etc/ntp.conf"
    /usr/sbin/pidof ntpd || config_file="/etc/chrony.conf"
    
    
    # Set maxpoll values to var_time_service_set_maxpoll
    sed -i "s/^\(server.*maxpoll\) [0-9][0-9]*\(.*\)$/\1 $var_time_service_set_maxpoll \2/" "$config_file"
    
    # Add maxpoll to server entries without maxpoll
    grep "^server" "$config_file" | grep -v maxpoll | while read -r line ; do
            sed -i "s/$line/& maxpoll $var_time_service_set_maxpoll/" "$config_file"
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation script:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,%23%20Allow%20for%20extra%20configuration%20files.%20This%20is%20useful%0A%23%20for%20admins%20specifying%20their%20own%20NTP%20servers%0Ainclude%20/etc/chrony.d/%2A.conf%0A%0A%23%20Set%20chronyd%20as%20client-only.%0Aport%200%0A%0A%23%20Disable%20chronyc%20from%20the%20network%0Acmdport%200%0A%0A%23%20Record%20the%20rate%20at%20which%20the%20system%20clock%20gains/losses%20time.%0Adriftfile%20/var/lib/chrony/drift%0A%0A%23%20Allow%20the%20system%20clock%20to%20be%20stepped%20in%20the%20first%20three%20updates%0A%23%20if%20its%20offset%20is%20larger%20than%201%20second.%0Amakestep%201.0%203%0A%0A%23%20Enable%20kernel%20synchronization%20of%20the%20real-time%20clock%20%28RTC%29.%0Artcsync%0A%0A%23%20Enable%20hardware%20timestamping%20on%20all%20interfaces%20that%20support%20it.%0A%23hwtimestamp%20%2A%0A%0A%23%20Increase%20the%20minimum%20number%20of%20selectable%20sources%20required%20to%20adjust%0A%23%20the%20system%20clock.%0A%23minsources%202%0A%0A%23%20Allow%20NTP%20client%20access%20from%20local%20network.%0A%23allow%20192.168.0.0/16%0A%0A%23%20Serve%20time%20even%20if%20not%20synchronized%20to%20a%20time%20source.%0A%23local%20stratum%2010%0A%0A%23%20Require%20authentication%20%28nts%20or%20key%20option%29%20for%20all%20NTP%20sources.%0A%23authselectmode%20require%0A%0A%23%20Specify%20file%20containing%20keys%20for%20NTP%20authentication.%0Akeyfile%20/etc/chrony.keys%0A%0A%23%20Insert/delete%20leap%20seconds%20by%20slewing%20instead%20of%20stepping.%0A%23leapsecmode%20slew%0A%0A%23%20Get%20TAI-UTC%20offset%20and%20leap%20seconds%20from%20the%20system%20tz%20database.%0Aleapsectz%20right/UTC%0A%0A%23%20Specify%20directory%20for%20log%20files.%0Alogdir%20/var/log/chrony%0A%0A%23%20Select%20which%20information%20is%20logged.%0A%23log%20measurements%20statistics%20tracking
            mode: 420
            overwrite: true
            path: /etc/chrony.conf
          - contents:
              source: data:,
            mode: 420
            overwrite: true
            path: /etc/chrony.d/.mco-keep
    

### Obsolete Services   [\[ref\]](#xccdf_org.ssgproject.content_group_obsolete)group

This section discusses a number of network-visible services which have historically caused problems for system security, and for which disabling or severely limiting the service has been the best available guidance for some time. As a result of this, many of these services are not installed as part of Red Hat Enterprise Linux 7 by default.  
  
Organizations which are running these services should switch to more secure equivalents as soon as possible. If it remains absolutely necessary to run one of these services for legacy reasons, care should be taken to restrict the service as much as possible, for instance by configuring host firewall software such as `firewalld` to restrict access to the vulnerable service to only those remote hosts which have a known need to use it.

contains 7 rules

### NIS   [\[ref\]](#xccdf_org.ssgproject.content_group_nis)group

The Network Information Service (NIS), also known as 'Yellow Pages' (YP), and its successor NIS+ have been made obsolete by Kerberos, LDAP, and other modern centralized authentication services. NIS should not be used because it suffers from security problems inherent in its design, such as inadequate protection of important authentication information.

contains 1 rule

#### Uninstall ypserv Package   [\[ref\]](#xccdf_org.ssgproject.content_rule_package_ypserv_removed)rule

The `ypserv` package can be removed with the following command:

$ sudo yum erase ypserv

Rationale:

The NIS service provides an unencrypted authentication service which does not provide for the confidentiality and integrity of user passwords or the remote session. Removing the `ypserv` package decreases the risk of the accidental (or intentional) activation of NIS or NIS+ services.

Severity:  high

Identifiers:  CCE-27399-5

References:  [BP28(R1)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000381](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000095-GPOS-00049](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020010](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204443r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [2.2.14](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    # CAUTION: This remediation script will remove ypserv
    #	   from the system, and may remove any packages
    #	   that depend on ypserv. Execute this
    #	   remediation AFTER testing on a non-production
    #	   system!
    
    if rpm -q --quiet "ypserv" ; then
        yum remove -y "ypserv"
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    - name: Ensure ypserv is removed
      package:
        name: ypserv
        state: absent
      tags:
        - CCE-27399-5
        - DISA-STIG-RHEL-07-020010
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-5(1)(c)
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_ypserv_removed
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    include remove_ypserv
    
    class remove_ypserv {
      package { 'ypserv':
        ensure => 'purged',
      }
    }
    

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    package --remove=ypserv
    

### Rlogin, Rsh, and Rexec   [\[ref\]](#xccdf_org.ssgproject.content_group_r_services)group

The Berkeley r-commands are legacy services which allow cleartext remote access and have an insecure trust model.

contains 3 rules

#### Uninstall rsh-server Package   [\[ref\]](#xccdf_org.ssgproject.content_rule_package_rsh-server_removed)rule

The `rsh-server` package can be removed with the following command:

$ sudo yum erase rsh-server

Rationale:

The `rsh-server` service provides unencrypted remote access service which does not provide for the confidentiality and integrity of user passwords or the remote session and has very weak authentication. If a privileged user were to login using this service, the privileged user password could be compromised. The `rsh-server` package provides several obsolete and insecure network services. Removing it decreases the risk of those services' accidental (or intentional) activation.

Severity:  high

Identifiers:  CCE-27342-5

References:  [BP28(R1)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000381](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000095-GPOS-00049](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-020000](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204442r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    # CAUTION: This remediation script will remove rsh-server
    #	   from the system, and may remove any packages
    #	   that depend on rsh-server. Execute this
    #	   remediation AFTER testing on a non-production
    #	   system!
    
    if rpm -q --quiet "rsh-server" ; then
        yum remove -y "rsh-server"
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    - name: Ensure rsh-server is removed
      package:
        name: rsh-server
        state: absent
      tags:
        - CCE-27342-5
        - DISA-STIG-RHEL-07-020000
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-5(1)(c)
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_rsh-server_removed
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    include remove_rsh-server
    
    class remove_rsh-server {
      package { 'rsh-server':
        ensure => 'purged',
      }
    }
    

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    package --remove=rsh-server
    

#### Remove Host-Based Authentication Files   [\[ref\]](#xccdf_org.ssgproject.content_rule_no_host_based_files)rule

The `shosts.equiv` file list remote hosts and users that are trusted by the local system. To remove these files, run the following command to delete them from any location:

$ sudo rm /\[path\]/\[to\]/\[file\]/shosts.equiv

Rationale:

The shosts.equiv files are used to configure host-based authentication for the system via SSH. Host-based authentication is not sufficient for preventing unauthorized access to the system, as it does not require interactive identification and authentication of a connection request, or for the use of two-factor authentication.

Severity:  high

Identifiers:  CCE-80513-5

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040550](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204607r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    
    # Identify local mounts
    MOUNT_LIST=$(df --local | awk '{ print $6 }')
    
    # Find file on each listed mount point
    for cur_mount in ${MOUNT_LIST}
    do
    	find ${cur_mount} -xdev -type f -name "shosts.equiv" -exec rm -f {} \;
    done
    

#### Remove User Host-Based Authentication Files   [\[ref\]](#xccdf_org.ssgproject.content_rule_no_user_host_based_files)rule

The `~/.shosts` (in each user's home directory) files list remote hosts and users that are trusted by the local system. To remove these files, run the following command to delete them from any location:

$ sudo find / -name '.shosts' -type f -delete

Rationale:

The .shosts files are used to configure host-based authentication for individual users or the system via SSH. Host-based authentication is not sufficient for preventing unauthorized access to the system, as it does not require interactive identification and authentication of a connection request, or for the use of two-factor authentication.

Severity:  high

Identifiers:  CCE-80514-3

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040540](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204606r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    
    # Identify local mounts
    MOUNT_LIST=$(df --local | awk '{ print $6 }')
    
    # Find file on each listed mount point
    for cur_mount in ${MOUNT_LIST}
    do
    	find ${cur_mount} -xdev -type f -name ".shosts" -exec rm -f {} \;
    done
    

### Telnet   [\[ref\]](#xccdf_org.ssgproject.content_group_telnet)group

The telnet protocol does not provide confidentiality or integrity for information transmitted on the network. This includes authentication information such as passwords. Organizations which use telnet should be actively working to migrate to a more secure protocol.

contains 1 rule

#### Uninstall telnet-server Package   [\[ref\]](#xccdf_org.ssgproject.content_rule_package_telnet-server_removed)rule

The `telnet-server` package can be removed with the following command:

$ sudo yum erase telnet-server

Rationale:

It is detrimental for operating systems to provide, or install by default, functionality exceeding requirements or mission objectives. These unnecessary capabilities are often overlooked and therefore may remain unsecure. They increase the risk to the platform by providing additional attack vectors.  
The telnet service provides an unencrypted remote access service which does not provide for the confidentiality and integrity of user passwords or the remote session. If a privileged user were to login using this service, the privileged user password could be compromised.  
Removing the `telnet-server` package decreases the risk of the telnet service's accidental (or intentional) activation.

Severity:  high

Identifiers:  CCE-27165-0

References:  [BP28(R1)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000381](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000095-GPOS-00049](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-021710](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204502r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [2.2.15](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    # CAUTION: This remediation script will remove telnet-server
    #	   from the system, and may remove any packages
    #	   that depend on telnet-server. Execute this
    #	   remediation AFTER testing on a non-production
    #	   system!
    
    if rpm -q --quiet "telnet-server" ; then
        yum remove -y "telnet-server"
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    - name: Ensure telnet-server is removed
      package:
        name: telnet-server
        state: absent
      tags:
        - CCE-27165-0
        - DISA-STIG-RHEL-07-021710
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_telnet-server_removed
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    include remove_telnet-server
    
    class remove_telnet-server {
      package { 'telnet-server':
        ensure => 'purged',
      }
    }
    

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    package --remove=telnet-server
    

### TFTP Server   [\[ref\]](#xccdf_org.ssgproject.content_group_tftp)group

TFTP is a lightweight version of the FTP protocol which has traditionally been used to configure networking equipment. However, TFTP provides little security, and modern versions of networking operating systems frequently support configuration via SSH or other more secure protocols. A TFTP server should be run only if no more secure method of supporting existing equipment can be found.

contains 2 rules

#### Uninstall tftp-server Package   [\[ref\]](#xccdf_org.ssgproject.content_rule_package_tftp-server_removed)rule

The `tftp-server` package can be removed with the following command:

 $ sudo yum erase tftp-server

Rationale:

Removing the `tftp-server` package decreases the risk of the accidental (or intentional) activation of tftp services.  
  
If TFTP is required for operational support (such as transmission of router configurations), its use must be documented with the Information Systems Securty Manager (ISSM), restricted to only authorized personnel, and have access control rules established.

Severity:  high

Identifiers:  CCE-80213-2

References:  [BP28(R1)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000318](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000368](https://public.cyber.mil/stigs/cci/), [CCI-001812](https://public.cyber.mil/stigs/cci/), [CCI-001813](https://public.cyber.mil/stigs/cci/), [CCI-001814](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040700](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204621r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    # CAUTION: This remediation script will remove tftp-server
    #	   from the system, and may remove any packages
    #	   that depend on tftp-server. Execute this
    #	   remediation AFTER testing on a non-production
    #	   system!
    
    if rpm -q --quiet "tftp-server" ; then
        yum remove -y "tftp-server"
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    - name: Ensure tftp-server is removed
      package:
        name: tftp-server
        state: absent
      tags:
        - CCE-80213-2
        - DISA-STIG-RHEL-07-040700
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_tftp-server_removed
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    include remove_tftp-server
    
    class remove_tftp-server {
      package { 'tftp-server':
        ensure => 'purged',
      }
    }
    

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

disable

    
    package --remove=tftp-server
    

#### Ensure tftp Daemon Uses Secure Mode   [\[ref\]](#xccdf_org.ssgproject.content_rule_tftpd_uses_secure_mode)rule

If running the `tftp` service is necessary, it should be configured to change its root directory at startup. To do so, ensure `/etc/xinetd.d/tftp` includes `-s` as a command line argument, as shown in the following example:

server\_args = -s /var/lib/tftpboot

Rationale:

Using the `-s` option causes the TFTP service to only serve files from the given directory. Serving files from an intentionally-specified directory reduces the risk of sharing files which should remain private.

Severity:  medium

Identifiers:  CCE-80214-0

References:  [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040720](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204623r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    #!/bin/bash
    
    
    var_tftpd_secure_directory="/var/lib/tftpboot"
    
    
    
    if grep -q 'server_args' /etc/xinetd.d/tftp; then
        sed -i -E "s;^([[:blank:]]*server_args[[:blank:]]+=[[:blank:]]+.*?)(-s[[:blank:]]+[[:graph:]]+)*(.*)$;\1 -s $var_tftpd_secure_directory \3;" /etc/xinetd.d/tftp
    else
        echo "server_args = -s $var_tftpd_secure_directory" >> /etc/xinetd.d/tftp
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: XCCDF Value var_tftpd_secure_directory # promote to variable
      set_fact:
        var_tftpd_secure_directory: !!str /var/lib/tftpboot
      tags:
        - always
    
    - name: Find out if the file exists and contains the line configuring server arguments
      find:
        path: /etc/xinetd.d
        patterns: tftp
        contains: ^[\s]+server_args.*$
      register: tftpd_secure_config_line
      tags:
        - CCE-80214-0
        - DISA-STIG-RHEL-07-040720
        - NIST-800-53-AC-6
        - NIST-800-53-CM-6(b)
        - NIST-800-53-CM-7(a)
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - tftpd_uses_secure_mode
    
    - name: Ensure that TFTP server is configured to start with secure directory
      lineinfile:
        path: /etc/xinetd.d/tftp
        regexp: ^[\s]*(server_args[\s]+=[\s]+.*?)(-s[\s]+[/\.\w]+)*(.*)$
        line: \1 -s {{ var_tftpd_secure_directory }} \3
        state: present
        backrefs: true
      when: tftpd_secure_config_line is defined and tftpd_secure_config_line.matched >
        0
      tags:
        - CCE-80214-0
        - DISA-STIG-RHEL-07-040720
        - NIST-800-53-AC-6
        - NIST-800-53-CM-6(b)
        - NIST-800-53-CM-7(a)
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - tftpd_uses_secure_mode
    
    - name: Insert correct config line to start TFTP server with secure directory
      lineinfile:
        path: /etc/xinetd.d/tftp
        line: server_args = -s {{ var_tftpd_secure_directory }}
        state: present
        create: true
      when: tftpd_secure_config_line is defined and tftpd_secure_config_line.matched ==
        0
      tags:
        - CCE-80214-0
        - DISA-STIG-RHEL-07-040720
        - NIST-800-53-AC-6
        - NIST-800-53-CM-6(b)
        - NIST-800-53-CM-7(a)
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - tftpd_uses_secure_mode
    

### SNMP Server   [\[ref\]](#xccdf_org.ssgproject.content_group_snmp)group

The Simple Network Management Protocol allows administrators to monitor the state of network devices, including computers. Older versions of SNMP were well-known for weak security, such as plaintext transmission of the community string (used for authentication) and usage of easily-guessable choices for the community string.

contains 1 rule

### Configure SNMP Server if Necessary   [\[ref\]](#xccdf_org.ssgproject.content_group_snmp_configure_server)group

If it is necessary to run the snmpd agent on the system, some best practices should be followed to minimize the security risk from the installation. The multiple security models implemented by SNMP cannot be fully covered here so only the following general configuration advice can be offered:

*   use only SNMP version 3 security models and enable the use of authentication and encryption
*   write access to the MIB (Management Information Base) should be allowed only if necessary
*   all access to the MIB should be restricted following a principle of least privilege
*   network access should be limited to the maximum extent possible including restricting to expected network addresses both in the configuration files and in the system firewall rules
*   ensure SNMP agents send traps only to, and accept SNMP queries only from, authorized management stations
*   ensure that permissions on the `snmpd.conf` configuration file (by default, in `/etc/snmp`) are 640 or more restrictive
*   ensure that any MIB files' permissions are also 640 or more restrictive

contains 1 rule

#### Ensure Default SNMP Password Is Not Used   [\[ref\]](#xccdf_org.ssgproject.content_rule_snmpd_not_default_password)rule

Edit `/etc/snmp/snmpd.conf`, remove or change the default community strings of `public` and `private`. This profile configures new read-only community string to `changemero` and read-write community string to `changemerw`. Once the default community strings have been changed, restart the SNMP service:

$ sudo service snmpd restart

Rationale:

Whether active or not, default simple network management protocol (SNMP) community strings must be changed to maintain security. If the service is running with the default authenticators, then anyone can gather data about the system and the network and use the information to potentially compromise the integrity of the system and network(s).

Severity:  high

Identifiers:  CCE-27386-2

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-5(e)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040800](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204627r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q net-snmp; then
    
    #!/bin/bash
    
    
    var_snmpd_ro_string="changemero"
    
    var_snmpd_rw_string="changemerw"
    
    
    
    # remediate read-only community string
    if grep -q 'public' /etc/snmp/snmpd.conf; then
        sed -i "s/public/$var_snmpd_ro_string/" /etc/snmp/snmpd.conf
    fi
    
    # remediate read-write community string
    if grep -q 'private' /etc/snmp/snmpd.conf; then
        sed -i "s/private/$var_snmpd_rw_string/" /etc/snmp/snmpd.conf
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

Strategy:

configure

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-27386-2
        - DISA-STIG-RHEL-07-040800
        - NIST-800-53-IA-5(e)
        - configure_strategy
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - snmpd_not_default_password
    - name: XCCDF Value var_snmpd_ro_string # promote to variable
      set_fact:
        var_snmpd_ro_string: !!str changemero
      tags:
        - always
    - name: XCCDF Value var_snmpd_rw_string # promote to variable
      set_fact:
        var_snmpd_rw_string: !!str changemerw
      tags:
        - always
    
    - name: Check if file /etc/snmp/snmpd.conf exists
      stat:
        path: /etc/snmp/snmpd.conf
      register: snmpd
      when: '"net-snmp" in ansible_facts.packages'
      tags:
        - CCE-27386-2
        - DISA-STIG-RHEL-07-040800
        - NIST-800-53-IA-5(e)
        - configure_strategy
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - snmpd_not_default_password
    
    - name: Replace all instances of SNMP RO strings
      replace:
        path: /etc/snmp/snmpd.conf
        regexp: public
        replace: '{{ var_snmpd_ro_string }}'
      when:
        - '"net-snmp" in ansible_facts.packages'
        - (snmpd.stat.exists is defined and snmpd.stat.exists)
      tags:
        - CCE-27386-2
        - DISA-STIG-RHEL-07-040800
        - NIST-800-53-IA-5(e)
        - configure_strategy
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - snmpd_not_default_password
    
    - name: Replace all instances of SNMP RW strings
      replace:
        path: /etc/snmp/snmpd.conf
        regexp: private
        replace: '{{ var_snmpd_rw_string }}'
      when:
        - '"net-snmp" in ansible_facts.packages'
        - (snmpd.stat.exists is defined and snmpd.stat.exists)
      tags:
        - CCE-27386-2
        - DISA-STIG-RHEL-07-040800
        - NIST-800-53-IA-5(e)
        - configure_strategy
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - snmpd_not_default_password
    

### SSH Server   [\[ref\]](#xccdf_org.ssgproject.content_group_ssh)group

The SSH protocol is recommended for remote login and remote file transfer. SSH provides confidentiality and integrity for data exchanged between two systems, as well as server authentication, through the use of public key cryptography. The implementation included with the system is called OpenSSH, and more detailed documentation is available from its website, [https://www.openssh.com](https://www.openssh.com). Its server program is called `sshd` and provided by the RPM package `openssh-server`.

contains 25 rules

### Configure OpenSSH Server if Necessary   [\[ref\]](#xccdf_org.ssgproject.content_group_ssh_server)group

If the system needs to act as an SSH server, then certain changes should be made to the OpenSSH daemon configuration file `/etc/ssh/sshd_config`. The following recommendations can be applied to this file. See the `sshd_config(5)` man page for more detailed information.

contains 21 rules

#### Disable Host-Based Authentication   [\[ref\]](#xccdf_org.ssgproject.content_rule_disable_host_auth)rule

SSH's cryptographic host-based authentication is more secure than `.rhosts` authentication. However, it is not recommended that hosts unilaterally trust one another, even within an organization.  
  
To disable host-based authentication, add or correct the following line in `/etc/ssh/sshd_config`:

HostbasedAuthentication no

Rationale:

SSH trust relationships mean a compromise on one host can allow an attacker to move trivially to other hosts.

Severity:  medium

Identifiers:  CCE-27413-4

References:  [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.5.6](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-3](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00229](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-010470](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204435r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.9](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*HostbasedAuthentication\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "HostbasedAuthentication no" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "HostbasedAuthentication no" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Disable Host-Based Authentication
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*HostbasedAuthentication\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*HostbasedAuthentication\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*HostbasedAuthentication\s+
            line: HostbasedAuthentication no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27413-4
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-010470
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-3
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_host_auth
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
    

Remediation script:   (show)  
  

    ---
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    spec:
      config:
        ignition:
          version: 3.1.0
        storage:
          files:
          - contents:
              source: data:,%23%09%24OpenBSD%3A%20sshd_config%2Cv%201.103%202018%2F04%2F09%2020%3A41%3A22%20tj%20Exp%20%24%0A%0A%23%20This%20is%20the%20sshd%20server%20system-wide%20configuration%20file.%20%20See%0A%23%20sshd_config%285%29%20for%20more%20information.%0A%0A%23%20This%20sshd%20was%20compiled%20with%20PATH%3D%2Fusr%2Flocal%2Fbin%3A%2Fusr%2Fbin%3A%2Fusr%2Flocal%2Fsbin%3A%2Fusr%2Fsbin%0A%0A%23%20The%20strategy%20used%20for%20options%20in%20the%20default%20sshd_config%20shipped%20with%0A%23%20OpenSSH%20is%20to%20specify%20options%20with%20their%20default%20value%20where%0A%23%20possible%2C%20but%20leave%20them%20commented.%20%20Uncommented%20options%20override%20the%0A%23%20default%20value.%0A%0A%23%20If%20you%20want%20to%20change%20the%20port%20on%20a%20SELinux%20system%2C%20you%20have%20to%20tell%0A%23%20SELinux%20about%20this%20change.%0A%23%20semanage%20port%20-a%20-t%20ssh_port_t%20-p%20tcp%20%23PORTNUMBER%0A%23%0A%23Port%2022%0A%23AddressFamily%20any%0A%23ListenAddress%200.0.0.0%0A%23ListenAddress%20%3A%3A%0A%0AHostKey%20%2Fetc%2Fssh%2Fssh_host_rsa_key%0AHostKey%20%2Fetc%2Fssh%2Fssh_host_ecdsa_key%0AHostKey%20%2Fetc%2Fssh%2Fssh_host_ed25519_key%0A%0A%23%20Ciphers%20and%20keying%0ARekeyLimit%20512M%201h%0A%0A%23%20System-wide%20Crypto%20policy%3A%0A%23%20This%20system%20is%20following%20system-wide%20crypto%20policy.%20The%20changes%20to%0A%23%20Ciphers%2C%20MACs%2C%20KexAlgoritms%20and%20GSSAPIKexAlgorithsm%20will%20not%20have%20any%0A%23%20effect%20here.%20They%20will%20be%20overridden%20by%20command-line%20options%20passed%20on%0A%23%20the%20server%20start%20up.%0A%23%20To%20opt%20out%2C%20uncomment%20a%20line%20with%20redefinition%20of%20%20CRYPTO_POLICY%3D%0A%23%20variable%20in%20%20%2Fetc%2Fsysconfig%2Fsshd%20%20to%20overwrite%20the%20policy.%0A%23%20For%20more%20information%2C%20see%20manual%20page%20for%20update-crypto-policies%288%29.%0A%0A%23%20Logging%0A%23SyslogFacility%20AUTH%0ASyslogFacility%20AUTHPRIV%0A%23LogLevel%20INFO%0A%0A%23%20Authentication%3A%0A%0A%23LoginGraceTime%202m%0APermitRootLogin%20no%0AStrictModes%20yes%0A%23MaxAuthTries%206%0A%23MaxSessions%2010%0A%0APubkeyAuthentication%20yes%0A%0A%23%20The%20default%20is%20to%20check%20both%20.ssh%2Fauthorized_keys%20and%20.ssh%2Fauthorized_keys2%0A%23%20but%20this%20is%20overridden%20so%20installations%20will%20only%20check%20.ssh%2Fauthorized_keys%0AAuthorizedKeysFile%09.ssh%2Fauthorized_keys%0A%0A%23AuthorizedPrincipalsFile%20none%0A%0A%23AuthorizedKeysCommand%20none%0A%23AuthorizedKeysCommandUser%20nobody%0A%0A%23%20For%20this%20to%20work%20you%20will%20also%20need%20host%20keys%20in%20%2Fetc%2Fssh%2Fssh_known_hosts%0AHostbasedAuthentication%20no%0A%23%20Change%20to%20yes%20if%20you%20don%27t%20trust%20~%2F.ssh%2Fknown_hosts%20for%0A%23%20HostbasedAuthentication%0AIgnoreUserKnownHosts%20yes%0A%23%20Don%27t%20read%20the%20user%27s%20~%2F.rhosts%20and%20~%2F.shosts%20files%0AIgnoreRhosts%20yes%0A%0A%23%20To%20disable%20tunneled%20clear%20text%20passwords%2C%20change%20to%20no%20here%21%0A%23PasswordAuthentication%20yes%0APermitEmptyPasswords%20no%0APasswordAuthentication%20no%0A%0A%23%20Change%20to%20no%20to%20disable%20s%2Fkey%20passwords%0A%23ChallengeResponseAuthentication%20yes%0AChallengeResponseAuthentication%20no%0A%0A%23%20Kerberos%20options%0AKerberosAuthentication%20no%0A%23KerberosOrLocalPasswd%20yes%0A%23KerberosTicketCleanup%20yes%0A%23KerberosGetAFSToken%20no%0A%23KerberosUseKuserok%20yes%0A%0A%23%20GSSAPI%20options%0AGSSAPIAuthentication%20no%0AGSSAPICleanupCredentials%20no%0A%23GSSAPIStrictAcceptorCheck%20yes%0A%23GSSAPIKeyExchange%20no%0A%23GSSAPIEnablek5users%20no%0A%0A%23%20Set%20this%20to%20%27yes%27%20to%20enable%20PAM%20authentication%2C%20account%20processing%2C%0A%23%20and%20session%20processing.%20If%20this%20is%20enabled%2C%20PAM%20authentication%20will%0A%23%20be%20allowed%20through%20the%20ChallengeResponseAuthentication%20and%0A%23%20PasswordAuthentication.%20%20Depending%20on%20your%20PAM%20configuration%2C%0A%23%20PAM%20authentication%20via%20ChallengeResponseAuthentication%20may%20bypass%0A%23%20the%20setting%20of%20%22PermitRootLogin%20without-password%22.%0A%23%20If%20you%20just%20want%20the%20PAM%20account%20and%20session%20checks%20to%20run%20without%0A%23%20PAM%20authentication%2C%20then%20enable%20this%20but%20set%20PasswordAuthentication%0A%23%20and%20ChallengeResponseAuthentication%20to%20%27no%27.%0A%23%20WARNING%3A%20%27UsePAM%20no%27%20is%20not%20supported%20in%20Fedora%20and%20may%20cause%20several%0A%23%20problems.%0AUsePAM%20yes%0A%0A%23AllowAgentForwarding%20yes%0A%23AllowTcpForwarding%20yes%0A%23GatewayPorts%20no%0AX11Forwarding%20yes%0A%23X11DisplayOffset%2010%0A%23X11UseLocalhost%20yes%0A%23PermitTTY%20yes%0A%0A%23%20It%20is%20recommended%20to%20use%20pam_motd%20in%20%2Fetc%2Fpam.d%2Fsshd%20instead%20of%20PrintMotd%2C%0A%23%20as%20it%20is%20more%20configurable%20and%20versatile%20than%20the%20built-in%20version.%0APrintMotd%20no%0A%0APrintLastLog%20yes%0A%23TCPKeepAlive%20yes%0APermitUserEnvironment%20no%0ACompression%20no%0AClientAliveInterval%20600%0AClientAliveCountMax%200%0A%23UseDNS%20no%0A%23PidFile%20%2Fvar%2Frun%2Fsshd.pid%0A%23MaxStartups%2010%3A30%3A100%0A%23PermitTunnel%20no%0A%23ChrootDirectory%20none%0A%23VersionAddendum%20none%0A%0A%23%20no%20default%20banner%20path%0ABanner%20%2Fetc%2Fissue%0A%0A%23%20Accept%20locale-related%20environment%20variables%0AAcceptEnv%20LANG%20LC_CTYPE%20LC_NUMERIC%20LC_TIME%20LC_COLLATE%20LC_MONETARY%20LC_MESSAGES%0AAcceptEnv%20LC_PAPER%20LC_NAME%20LC_ADDRESS%20LC_TELEPHONE%20LC_MEASUREMENT%0AAcceptEnv%20LC_IDENTIFICATION%20LC_ALL%20LANGUAGE%0AAcceptEnv%20XMODIFIERS%0A%0A%23%20override%20default%20of%20no%20subsystems%0ASubsystem%09sftp%09%2Fusr%2Flibexec%2Fopenssh%2Fsftp-server%0A%0A%23%20Example%20of%20overriding%20settings%20on%20a%20per-user%20basis%0A%23Match%20User%20anoncvs%0A%23%09X11Forwarding%20no%0A%23%09AllowTcpForwarding%20no%0A%23%09PermitTTY%20no%0A%23%09ForceCommand%20cvs%20server%0A%0AUsePrivilegeSeparation%20sandbox
            mode: 0600
            path: /etc/ssh/sshd_config
            overwrite: true
    

#### Allow Only SSH Protocol 2   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_allow_only_protocol2)rule

Only SSH protocol version 2 connections should be permitted. The default setting in `/etc/ssh/sshd_config` is correct, and can be verified by ensuring that the following line appears:

Protocol 2

Warning:  As of `openssh-server` version `7.4` and above, the only protocol supported is version 2, and line

Protocol 2

in `/etc/ssh/sshd_config` is not necessary.

Rationale:

SSH protocol version 1 is an insecure implementation of the SSH protocol and has many well-known vulnerability exploits. Exploits of the SSH daemon could provide immediate root access to the system.

Severity:  high

Identifiers:  CCE-27320-1

References:  [NT007(R1)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [5.5.6](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO13.01](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.13](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.5.4](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000197](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0487, 1449, 1506, [A.11.2.6](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [CIP-003-3 R4.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R7.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-5(1)(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-13](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [MA-4(6)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000074-GPOS-00042](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000033-VMM-000140, [RHEL-07-040390](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204594r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.2.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/ssh/sshd_config"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-27320-1" ]; then
        cce="CCE"
    else
        cce="CCE-27320-1"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^Protocol")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s %s" "$stripped_key" "2"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^Protocol\\>" "/etc/ssh/sshd_config"; then
        "${sed_command[@]}" "s/^Protocol\\>.*/$formatted_output/gi" "/etc/ssh/sshd_config"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/ssh/sshd_config" >> "/etc/ssh/sshd_config"
        printf '%s\n' "$formatted_output" >> "/etc/ssh/sshd_config"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Allow Only SSH Protocol 2
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*Protocol\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*Protocol\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*Protocol\s+
            line: Protocol 2
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27320-1
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-040390
        - NIST-800-171-3.1.13
        - NIST-800-171-3.5.4
        - NIST-800-53-AC-17(2)
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(c)
        - NIST-800-53-MA-4(6)
        - NIST-800-53-SC-13
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - restrict_strategy
        - sshd_allow_only_protocol2
    

#### Disable Compression Or Set Compression to delayed   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_disable_compression)rule

Compression is useful for slow network connections over long distances but can cause performance issues on local LANs. If use of compression is required, it should be enabled only after a user has authenticated; otherwise, it should be disabled. To disable compression or delay compression until after a user has successfully authenticated, add or correct the following line in the `/etc/ssh/sshd_config` file:

Compression no

Rationale:

If compression is allowed in an SSH connection prior to authentication, vulnerabilities in the compression software could result in compromise of the system from an unauthenticated connection, potentially with root privileges.

Severity:  medium

Identifiers:  CCE-80224-9

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-040470](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204602r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_sshd_disable_compression="no"
    
    
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/ssh/sshd_config"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80224-9" ]; then
        cce="CCE"
    else
        cce="CCE-80224-9"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^Compression")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s %s" "$stripped_key" "$var_sshd_disable_compression"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^Compression\\>" "/etc/ssh/sshd_config"; then
        "${sed_command[@]}" "s/^Compression\\>.*/$formatted_output/gi" "/etc/ssh/sshd_config"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/ssh/sshd_config" >> "/etc/ssh/sshd_config"
        printf '%s\n' "$formatted_output" >> "/etc/ssh/sshd_config"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value var_sshd_disable_compression # promote to variable
      set_fact:
        var_sshd_disable_compression: !!str no
      tags:
        - always
    
    - name: Disable Compression Or Set Compression to delayed
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*Compression\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*Compression\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*Compression\s+
            line: Compression {{ var_sshd_disable_compression }}
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80224-9
        - DISA-STIG-RHEL-07-040470
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_compression
    

#### Disable SSH Access via Empty Passwords   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_disable_empty_passwords)rule

To explicitly disallow SSH login from accounts with empty passwords, add or correct the following line in `/etc/ssh/sshd_config`:  

PermitEmptyPasswords no

  
Any accounts with empty passwords should be disabled immediately, and PAM configuration should prevent users from being able to assign themselves empty passwords.

Rationale:

Configuring this setting for the SSH daemon provides additional assurance that remote login via SSH will require a password, even in the event of misconfiguration elsewhere.

Severity:  high

Identifiers:  CCE-27471-2

References:  [NT007(R17)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.5.6](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.1.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000766](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000106-GPOS-00053](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00229](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-010300](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204425r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.11](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*PermitEmptyPasswords\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "PermitEmptyPasswords no" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "PermitEmptyPasswords no" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Disable SSH Access via Empty Passwords
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PermitEmptyPasswords\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PermitEmptyPasswords\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*PermitEmptyPasswords\s+
            line: PermitEmptyPasswords no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27471-2
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-010300
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_empty_passwords
    

#### Disable GSSAPI Authentication   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_disable_gssapi_auth)rule

Unless needed, SSH should not permit extraneous or unnecessary authentication mechanisms like GSSAPI. To disable GSSAPI authentication, add or correct the following line in the `/etc/ssh/sshd_config` file:

GSSAPIAuthentication no

Rationale:

GSSAPI authentication is used to provide additional authentication mechanisms to applications. Allowing GSSAPI authentication through SSH exposes the system's GSSAPI to remote hosts, increasing the attack surface of the system.

Severity:  medium

Identifiers:  CCE-80220-7

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000318](https://public.cyber.mil/stigs/cci/), [CCI-000368](https://public.cyber.mil/stigs/cci/), [CCI-001812](https://public.cyber.mil/stigs/cci/), [CCI-001813](https://public.cyber.mil/stigs/cci/), [CCI-001814](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0418, 1055, 1402, [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FTP\_ITC\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000364-GPOS-00151](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-040430](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204598r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*GSSAPIAuthentication\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "GSSAPIAuthentication no" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "GSSAPIAuthentication no" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Disable GSSAPI Authentication
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*GSSAPIAuthentication\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*GSSAPIAuthentication\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*GSSAPIAuthentication\s+
            line: GSSAPIAuthentication no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80220-7
        - DISA-STIG-RHEL-07-040430
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_gssapi_auth
    

#### Disable Kerberos Authentication   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_disable_kerb_auth)rule

Unless needed, SSH should not permit extraneous or unnecessary authentication mechanisms like Kerberos. To disable Kerberos authentication, add or correct the following line in the `/etc/ssh/sshd_config` file:

KerberosAuthentication no

Rationale:

Kerberos authentication for SSH is often implemented using GSSAPI. If Kerberos is enabled through SSH, the SSH daemon provides a means of access to the system's Kerberos implementation. Vulnerabilities in the system's Kerberos implementations may be subject to exploitation.

Severity:  medium

Identifiers:  CCE-80221-5

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000318](https://public.cyber.mil/stigs/cci/), [CCI-000368](https://public.cyber.mil/stigs/cci/), [CCI-001812](https://public.cyber.mil/stigs/cci/), [CCI-001813](https://public.cyber.mil/stigs/cci/), [CCI-001814](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), 0421, 0422, 0431, 0974, 1173, 1401, 1504, 1505, 1546, 1557, 1558, 1559, 1560, 1561, [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FTP\_ITC\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000364-GPOS-00151](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-040440](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204599r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*KerberosAuthentication\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "KerberosAuthentication no" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "KerberosAuthentication no" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Disable Kerberos Authentication
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*KerberosAuthentication\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*KerberosAuthentication\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*KerberosAuthentication\s+
            line: KerberosAuthentication no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80221-5
        - DISA-STIG-RHEL-07-040440
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_kerb_auth
    

#### Disable SSH Support for .rhosts Files   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_disable_rhosts)rule

SSH can emulate the behavior of the obsolete rsh command in allowing users to enable insecure access to their accounts via `.rhosts` files.  
  
To ensure this behavior is disabled, add or correct the following line in `/etc/ssh/sshd_config`:

IgnoreRhosts yes

Rationale:

SSH trust relationships mean a compromise on one host can allow an attacker to move trivially to other hosts.

Severity:  medium

Identifiers:  CCE-27377-1

References:  [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.5.6](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000107-VMM-000530, [RHEL-07-040350](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204590r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.8](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*IgnoreRhosts\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "IgnoreRhosts yes" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "IgnoreRhosts yes" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Disable SSH Support for .rhosts Files
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*IgnoreRhosts\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*IgnoreRhosts\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*IgnoreRhosts\s+
            line: IgnoreRhosts yes
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27377-1
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-040350
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_rhosts
    

#### Disable SSH Support for Rhosts RSA Authentication   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_disable_rhosts_rsa)rule

SSH can allow authentication through the obsolete rsh command through the use of the authenticating user's SSH keys. This should be disabled.  
  
To ensure this behavior is disabled, add or correct the following line in `/etc/ssh/sshd_config`:

RhostsRSAAuthentication no

Warning:  As of `openssh-server` version `7.4` and above, the `RhostsRSAAuthentication` option has been deprecated, and the line

RhostsRSAAuthentication no

in `/etc/ssh/sshd_config` is not necessary.

Rationale:

Configuring this setting for the SSH daemon provides additional assurance that remote login via SSH will require a password, even in the event of misconfiguration elsewhere.

Severity:  medium

Identifiers:  CCE-80373-4

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040330](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204588r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    # Test if the config_file is a symbolic link. If so, use --follow-symlinks with sed.
    # Otherwise, regular sed command will do.
    sed_command=('sed' '-i')
    if test -L "/etc/ssh/sshd_config"; then
        sed_command+=('--follow-symlinks')
    fi
    
    # If the cce arg is empty, CCE is not assigned.
    if [ -z "CCE-80373-4" ]; then
        cce="CCE"
    else
        cce="CCE-80373-4"
    fi
    
    # Strip any search characters in the key arg so that the key can be replaced without
    # adding any search characters to the config file.
    stripped_key=$(sed 's/[\^=\$,;+]*//g' <<< "^RhostsRSAAuthentication")
    
    # shellcheck disable=SC2059
    printf -v formatted_output "%s %s" "$stripped_key" "no"
    
    # If the key exists, change it. Otherwise, add it to the config_file.
    # We search for the key string followed by a word boundary (matched by \>),
    # so if we search for 'setting', 'setting2' won't match.
    if LC_ALL=C grep -q -m 1 -i -e "^RhostsRSAAuthentication\\>" "/etc/ssh/sshd_config"; then
        "${sed_command[@]}" "s/^RhostsRSAAuthentication\\>.*/$formatted_output/gi" "/etc/ssh/sshd_config"
    else
        # \n is precaution for case where file ends without trailing newline
        printf '\n# Per %s: Set %s in %s\n' "$cce" "$formatted_output" "/etc/ssh/sshd_config" >> "/etc/ssh/sshd_config"
        printf '%s\n' "$formatted_output" >> "/etc/ssh/sshd_config"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Disable SSH Support for Rhosts RSA Authentication
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*RhostsRSAAuthentication\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*RhostsRSAAuthentication\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*RhostsRSAAuthentication\s+
            line: RhostsRSAAuthentication no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80373-4
        - DISA-STIG-RHEL-07-040330
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_rhosts_rsa
    

#### Disable SSH Root Login   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_disable_root_login)rule

The root user should never be allowed to login to a system directly over a network. To disable root login via SSH, add or correct the following line in `/etc/ssh/sshd_config`:

PermitRootLogin no

Rationale:

Even though the communications channel may be encrypted, an additional layer of security is gained by extending the policy of not logging directly on as root. In addition, logging in with a user-specific account provides individual accountability of actions performed on the system and also helps to minimize direct attack attempts on root's password.

Severity:  medium

Identifiers:  CCE-27445-6

References:  [BP28(R19)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [NT007(R21)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [5.5.6](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.1](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.1.5](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000770](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-6(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [IA-2(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000109-GPOS-00056](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-040370](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204592r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.10](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*PermitRootLogin\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "PermitRootLogin no" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "PermitRootLogin no" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Disable SSH Root Login
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PermitRootLogin\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PermitRootLogin\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*PermitRootLogin\s+
            line: PermitRootLogin no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27445-6
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-040370
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - NIST-800-53-
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-6(2)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-2
        - NIST-800-53-IA-2(5)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_root_login
    

#### Disable SSH Support for User Known Hosts   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_disable_user_known_hosts)rule

SSH can allow system users to connect to systems if a cache of the remote systems public keys is available. This should be disabled.  
  
To ensure this behavior is disabled, add or correct the following line in `/etc/ssh/sshd_config`:

IgnoreUserKnownHosts yes

Rationale:

Configuring this setting for the SSH daemon provides additional assurance that remote login via SSH will require a password, even in the event of misconfiguration elsewhere.

Severity:  medium

Identifiers:  CCE-80372-6

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040380](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204593r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*IgnoreUserKnownHosts\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "IgnoreUserKnownHosts yes" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "IgnoreUserKnownHosts yes" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Disable SSH Support for User Known Hosts
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*IgnoreUserKnownHosts\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*IgnoreUserKnownHosts\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*IgnoreUserKnownHosts\s+
            line: IgnoreUserKnownHosts yes
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80372-6
        - DISA-STIG-RHEL-07-040380
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_user_known_hosts
    

#### Disable X11 Forwarding   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_disable_x11_forwarding)rule

The X11Forwarding parameter provides the ability to tunnel X11 traffic through the connection to enable remote graphic connections. SSH has the capability to encrypt remote X11 connections when SSH's `X11Forwarding` option is enabled.  
  
To disable X11 Forwarding, add or correct the following line in `/etc/ssh/sshd_config`:

X11Forwarding no

Rationale:

Disable X11 forwarding unless there is an operational requirement to use X11 applications directly. There is a small risk that the remote X11 servers of users who are logged in via SSH with X11 forwarding could be compromised by other users on the X11 server. Note that even if X11 forwarding is disabled, users can always install their own forwarders.

Severity:  medium

Identifiers:  CCE-83359-0

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [CM-6(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040710](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204622r603849\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.6](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*X11Forwarding\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "X11Forwarding no" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "X11Forwarding no" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Disable X11 Forwarding
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*X11Forwarding\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*X11Forwarding\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*X11Forwarding\s+
            line: X11Forwarding no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83359-0
        - DISA-STIG-RHEL-07-040710
        - NIST-800-53-CM-6(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_x11_forwarding
    

#### Do Not Allow SSH Environment Options   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_do_not_permit_user_env)rule

To ensure users are not able to override environment variables of the SSH daemon, add or correct the following line in `/etc/ssh/sshd_config`:

PermitUserEnvironment no

Rationale:

SSH environment options potentially allow users to bypass access restriction in some configurations.

Severity:  medium

Identifiers:  CCE-27363-1

References:  [11](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [5.5.6](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00229](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-010460](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204434r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.12](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*PermitUserEnvironment\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "PermitUserEnvironment no" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "PermitUserEnvironment no" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Do Not Allow SSH Environment Options
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PermitUserEnvironment\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PermitUserEnvironment\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*PermitUserEnvironment\s+
            line: PermitUserEnvironment no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27363-1
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-010460
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_do_not_permit_user_env
    

#### Enable Use of Strict Mode Checking   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_enable_strictmodes)rule

SSHs `StrictModes` option checks file and ownership permissions in the user's home directory `.ssh` folder before accepting login. If world- writable permissions are found, logon is rejected. To enable `StrictModes` in SSH, add or correct the following line in the `/etc/ssh/sshd_config` file:

StrictModes yes

Rationale:

If other users have access to modify user-specific SSH configuration files, they may be able to log into the system as another user.

Severity:  medium

Identifiers:  CCE-80222-3

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-040450](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204600r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*StrictModes\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "StrictModes yes" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "StrictModes yes" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Enable Use of Strict Mode Checking
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*StrictModes\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*StrictModes\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*StrictModes\s+
            line: StrictModes yes
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80222-3
        - DISA-STIG-RHEL-07-040450
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-6
        - NIST-800-53-CM-6(a)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_enable_strictmodes
    

#### Enable SSH Warning Banner   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_enable_warning_banner)rule

To enable the warning banner and ensure it is consistent across the system, add or correct the following line in `/etc/ssh/sshd_config`:

Banner /etc/issue

Another section contains information on how to create an appropriate system-wide warning banner.

Rationale:

The warning message reinforces policy awareness during the logon process and facilitates possible legal action against attackers. Alternatively, systems whose ownership should not be obvious should ensure usage of a banner that does not provide easy attribution.

Severity:  medium

Identifiers:  CCE-27314-4

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5.5.6](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.9](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000048](https://public.cyber.mil/stigs/cci/), [CCI-000050](https://public.cyber.mil/stigs/cci/), [CCI-001384](https://public.cyber.mil/stigs/cci/), [CCI-001385](https://public.cyber.mil/stigs/cci/), [CCI-001386](https://public.cyber.mil/stigs/cci/), [CCI-001387](https://public.cyber.mil/stigs/cci/), [CCI-001388](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [AC-8(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-8(c)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FTA\_TAB.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000023-GPOS-00006](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000024-GPOS-00007](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000228-GPOS-00088](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000023-VMM-000060, SRG-OS-000024-VMM-000070, [RHEL-07-040170](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204580r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.2.15](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*Banner\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "Banner /etc/issue" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "Banner /etc/issue" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Enable SSH Warning Banner
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*Banner\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*Banner\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*Banner\s+
            line: Banner /etc/issue
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27314-4
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-040170
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(c)
        - NIST-800-53-CM-6(a)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_enable_warning_banner
    

#### Enable SSH Print Last Log   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_print_last_log)rule

When enabled, SSH will display the date and time of the last successful account logon. To enable LastLog in SSH, add or correct the following line in the `/etc/ssh/sshd_config` file:

PrintLastLog yes

Rationale:

Providing users feedback on when account accesses last occurred facilitates user recognition and reporting of unauthorized account use.

Severity:  medium

Identifiers:  CCE-80225-6

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [AC-9](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040360](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204591r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*PrintLastLog\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "PrintLastLog yes" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "PrintLastLog yes" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Enable SSH Print Last Log
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PrintLastLog\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PrintLastLog\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*PrintLastLog\s+
            line: PrintLastLog yes
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80225-6
        - DISA-STIG-RHEL-07-040360
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-9
        - NIST-800-53-CM-6(a)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_print_last_log
    

#### Set SSH Idle Timeout Interval   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_set_idle_timeout)rule

SSH allows administrators to set an idle timeout interval. After this interval has passed, the idle user will be automatically logged out.  
  
To set an idle timeout interval, edit the following line in `/etc/ssh/sshd_config` as follows:

ClientAliveInterval **600**

  
  
The timeout **interval** is given in seconds. For example, have a timeout of 10 minutes, set **interval** to 600.  
  
If a shorter timeout has already been set for the login shell, that value will preempt any SSH setting made in `/etc/ssh/sshd_config`. Keep in mind that some processes may stop SSH from correctly detecting that the user is idle.

Warning:  SSH disconnecting idle clients will not have desired effect without also configuring ClientAliveCountMax in the SSH service configuration.

Warning:  Following conditions may prevent the SSH session to time out:

*   Remote processes on the remote machine generates output. As the output has to be transferred over the network to the client, the timeout is reset every time such transfer happens.
*   Any `scp` or `sftp` activity by the same user to the host resets the timeout.

Rationale:

Terminating an idle ssh session within a short time period reduces the window of opportunity for unauthorized personnel to take control of a management session enabled on the console or console port that has been let unattended.

Severity:  medium

Identifiers:  CCE-27433-2

References:  [BP28(R29)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [5.5.6](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.01](https://www.isaca.org/resources/cobit), [BAI03.02](https://www.isaca.org/resources/cobit), [BAI03.03](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000879](https://public.cyber.mil/stigs/cci/), [CCI-001133](https://public.cyber.mil/stigs/cci/), [CCI-002361](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.14.1.1](https://www.iso.org/standard/54534.html), [A.14.2.1](https://www.iso.org/standard/54534.html), [A.14.2.5](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.1.5](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-2(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.1.8](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000126-GPOS-00066](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000163-GPOS-00072](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000279-GPOS-00109](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000395-GPOS-00175](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-040320](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204587r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.16](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    sshd_idle_timeout_value="600"
    
    
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*ClientAliveInterval\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "ClientAliveInterval $sshd_idle_timeout_value" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "ClientAliveInterval $sshd_idle_timeout_value" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value sshd_idle_timeout_value # promote to variable
      set_fact:
        sshd_idle_timeout_value: !!str 600
      tags:
        - always
    
    - name: Set SSH Idle Timeout Interval
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*ClientAliveInterval\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*ClientAliveInterval\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*ClientAliveInterval\s+
            line: ClientAliveInterval {{ sshd_idle_timeout_value }}
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27433-2
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-040320
        - NIST-800-171-3.1.11
        - NIST-800-53-AC-12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-2(5)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-10
        - PCI-DSS-Req-8.1.8
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_set_idle_timeout
    

#### Set SSH Client Alive Count Max to zero   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_set_keepalive_0)rule

The SSH server sends at most `ClientAliveCountMax` messages during a SSH session and waits for a response from the SSH client. The option `ClientAliveInterval` configures timeout after each `ClientAliveCountMax` message. If the SSH server does not receive a response from the client, then the connection is considered idle and terminated. To ensure the SSH idle timeout occurs precisely when the `ClientAliveInterval` is set, set the `ClientAliveCountMax` to value of `0`.

Rationale:

This ensures a user login will be terminated as soon as the `ClientAliveInterval` is reached.

Severity:  medium

Identifiers:  CCE-83399-6

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [7](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [5.5.6](https://www.fbi.gov/file-repository/cjis-security-policy-v5_5_20160601-2-1.pdf), [APO13.01](https://www.isaca.org/resources/cobit), [BAI03.01](https://www.isaca.org/resources/cobit), [BAI03.02](https://www.isaca.org/resources/cobit), [BAI03.03](https://www.isaca.org/resources/cobit), [DSS01.03](https://www.isaca.org/resources/cobit), [DSS03.05](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [3.1.11](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000879](https://public.cyber.mil/stigs/cci/), [CCI-001133](https://public.cyber.mil/stigs/cci/), [CCI-002361](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.12.4.1](https://www.iso.org/standard/54534.html), [A.12.4.3](https://www.iso.org/standard/54534.html), [A.14.1.1](https://www.iso.org/standard/54534.html), [A.14.2.1](https://www.iso.org/standard/54534.html), [A.14.2.5](https://www.iso.org/standard/54534.html), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.6.1.5](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-004-3 R2.2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.3.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-2(5)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [DE.CM-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [DE.CM-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [Req-8.1.8](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-1.pdf), [SRG-OS-000163-GPOS-00072](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000279-GPOS-00109](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000480-VMM-002000, [RHEL-07-040340](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204589r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.2.12](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*ClientAliveCountMax\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "ClientAliveCountMax 0" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "ClientAliveCountMax 0" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Set SSH Client Alive Count Max to zero
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*ClientAliveCountMax\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*ClientAliveCountMax\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*ClientAliveCountMax\s+
            line: ClientAliveCountMax 0
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83399-6
        - CJIS-5.5.6
        - DISA-STIG-RHEL-07-040340
        - NIST-800-171-3.1.11
        - NIST-800-53-AC-12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-2(5)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-10
        - PCI-DSS-Req-8.1.8
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_set_keepalive_0
    

#### Use Only FIPS 140-2 Validated Ciphers   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_use_approved_ciphers_ordered_stig)rule

Limit the ciphers to those algorithms which are FIPS-approved. The following line in `/etc/ssh/sshd_config` demonstrates use of FIPS-approved ciphers:

Ciphers aes256-ctr,aes192-ctr,aes128-ctr

This rule ensures that there are configured ciphers mentioned above (or their subset), keeping the given order of algorithms.

Warning:  The system needs to be rebooted for these changes to take effect.

Warning:  System Crypto Modules must be provided by a vendor that undergoes FIPS-140 certifications. FIPS-140 is applicable to all Federal agencies that use cryptographic-based security systems to protect sensitive information in computer and telecommunication systems (including voice systems) as defined in Section 5131 of the Information Technology Management Reform Act of 1996, Public Law 104-106. This standard shall be used in designing and implementing cryptographic modules that Federal departments and agencies operate or are operated for them under contract. See **[https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.140-2.pdf](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.140-2.pdf)** To meet this, the system has to have cryptographic software provided by a vendor that has undergone this certification. This means providing documentation, test results, design information, and independent third party review by an accredited lab. While open source software is capable of meeting this, it does not meet FIPS-140 unless the vendor submits to this process.

Rationale:

Unapproved mechanisms that are used for authentication to the cryptographic module are not verified and therefore cannot be relied upon to provide confidentiality or integrity, and system data may be compromised.  
Operating systems utilizing encryption are required to use FIPS-compliant mechanisms for authenticating to cryptographic modules.  
FIPS 140-2 is the current standard for validating that mechanisms used to access cryptographic modules utilize authentication that meets industry and government requirements. For government systems, this allows Security Levels 1, 2, 3, or 4 for use on Red Hat Enterprise Linux 7.

Severity:  medium

Identifiers:  CCE-83398-8

References:  [CCI-000068](https://public.cyber.mil/stigs/cci/), [CCI-000366](https://public.cyber.mil/stigs/cci/), [CCI-000803](https://public.cyber.mil/stigs/cci/), [CCI-000877](https://public.cyber.mil/stigs/cci/), [CCI-002890](https://public.cyber.mil/stigs/cci/), [CCI-003123](https://public.cyber.mil/stigs/cci/), [SRG-OS-000033-GPOS-00014](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000120-GPOS-00061](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000125-GPOS-00065](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000250-GPOS-00093](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000393-GPOS-00173](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000394-GPOS-00174](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040110](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204578r744116\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if grep -q -P '^\s*[Cc]iphers\s+' /etc/ssh/sshd_config; then
      sed -i 's/^\s*[Cc]iphers.*/Ciphers aes256-ctr,aes192-ctr,aes128-ctr/' /etc/ssh/sshd_config
    else
      echo "Ciphers aes256-ctr,aes192-ctr,aes128-ctr" >> /etc/ssh/sshd_config
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Configure sshd to use approved ciphers
      lineinfile:
        path: /etc/ssh/sshd_config
        line: Ciphers aes256-ctr,aes192-ctr,aes128-ctr
        state: present
        regexp: ^[\s]*[Cc]iphers[\s]+(aes256-ctr(?=[\w,-@]+|$),?)?(aes192-ctr(?=[\w,-@]+|$),?)?(aes128-ctr(?=[\w,-@]+|$),?)?[\s]*(?:#.*)?$
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83398-8
        - DISA-STIG-RHEL-07-040110
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_use_approved_ciphers_ordered_stig
    

#### Use Only FIPS 140-2 Validated MACs   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_use_approved_macs_ordered_stig)rule

Limit the MACs to those hash algorithms which are FIPS-approved. The following line in `/etc/ssh/sshd_config` demonstrates use of FIPS-approved MACs:

MACs hmac-sha2-512,hmac-sha2-256

This rule ensures that there are configured MACs mentioned above (or their subset), keeping the given order of algorithms.

Warning:  The system needs to be rebooted for these changes to take effect.

Warning:  System Crypto Modules must be provided by a vendor that undergoes FIPS-140 certifications. FIPS-140 is applicable to all Federal agencies that use cryptographic-based security systems to protect sensitive information in computer and telecommunication systems (including voice systems) as defined in Section 5131 of the Information Technology Management Reform Act of 1996, Public Law 104-106. This standard shall be used in designing and implementing cryptographic modules that Federal departments and agencies operate or are operated for them under contract. See **[https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.140-2.pdf](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.140-2.pdf)** To meet this, the system has to have cryptographic software provided by a vendor that has undergone this certification. This means providing documentation, test results, design information, and independent third party review by an accredited lab. While open source software is capable of meeting this, it does not meet FIPS-140 unless the vendor submits to this process.

Rationale:

DoD Information Systems are required to use FIPS-approved cryptographic hash functions. The only SSHv2 hash algorithms meeting this requirement is SHA2.

Severity:  medium

Identifiers:  CCE-83636-1

References:  [CCI-000068](https://public.cyber.mil/stigs/cci/), [CCI-000803](https://public.cyber.mil/stigs/cci/), [CCI-000877](https://public.cyber.mil/stigs/cci/), [CCI-001453](https://public.cyber.mil/stigs/cci/), [CCI-003123](https://public.cyber.mil/stigs/cci/), [SRG-OS-000125-GPOS-00065](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000250-GPOS-00093](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000394-GPOS-00174](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040400](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204595r744117\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if grep -q -P '^\s*MACs\s+' /etc/ssh/sshd_config; then
      sed -i 's/^\s*MACs.*/MACs hmac-sha2-512,hmac-sha2-256/' /etc/ssh/sshd_config
    else
      echo "MACs hmac-sha2-512,hmac-sha2-256" >> /etc/ssh/sshd_config
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Configure sshd to use approved MACs
      lineinfile:
        path: /etc/ssh/sshd_config
        line: MACs hmac-sha2-512,hmac-sha2-256
        state: present
        regexp: ^[\s]*MACs[\s]+(hmac-sha2-512(?=[\w,-@]+|$),?)?(hmac-sha2-256(?=[\w,-@]+|$),?)?[\s]*(?:#.*)?$
        create: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83636-1
        - DISA-STIG-RHEL-07-040400
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_use_approved_macs_ordered_stig
    

#### Enable Use of Privilege Separation   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_use_priv_separation)rule

When enabled, SSH will create an unprivileged child process that has the privilege of the authenticated user. To enable privilege separation in SSH, add or correct the following line in the `/etc/ssh/sshd_config` file:

UsePrivilegeSeparation sandbox

Rationale:

SSH daemon privilege separation causes the SSH process to drop root privileges when not needed which would decrease the impact of software vulnerabilities in the unprivileged section.

Severity:  medium

Identifiers:  CCE-80223-1

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.1.12](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [164.308(a)(4)(i)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.308(b)(3)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.310(b)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(1)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [164.312(e)(2)(ii)](https://www.gpo.gov/fdsys/pkg/CFR-2007-title45-vol1/pdf/CFR-2007-title45-vol1-chapA-subchapC.pdf), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040460](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204601r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_sshd_priv_separation="sandbox"
    
    
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*UsePrivilegeSeparation\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "UsePrivilegeSeparation $var_sshd_priv_separation" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "UsePrivilegeSeparation $var_sshd_priv_separation" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: XCCDF Value var_sshd_priv_separation # promote to variable
      set_fact:
        var_sshd_priv_separation: !!str sandbox
      tags:
        - always
    
    - name: Enable Use of Privilege Separation
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*UsePrivilegeSeparation\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*UsePrivilegeSeparation\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*UsePrivilegeSeparation\s+
            line: UsePrivilegeSeparation {{ var_sshd_priv_separation }}
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80223-1
        - DISA-STIG-RHEL-07-040460
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-6
        - NIST-800-53-CM-6(a)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_use_priv_separation
    

#### Prevent remote hosts from connecting to the proxy display   [\[ref\]](#xccdf_org.ssgproject.content_rule_sshd_x11_use_localhost)rule

The SSH daemon should prevent remote hosts from connecting to the proxy display. Make sure that the option `X11UseLocalhost` is set to `yes` within the SSH server configuration file.

Rationale:

When X11 forwarding is enabled, there may be additional exposure to the server and client displays if the sshd proxy display is configured to listen on the wildcard address. By default, sshd binds the forwarding server to the loopback address and sets the hostname part of the `DISPLAY` environment variable to localhost. This prevents remote hosts from connecting to the proxy display.

Severity:  medium

Identifiers:  CCE-83404-4

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [CM-6(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040711](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-233307r603301\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if [ -e "/etc/ssh/sshd_config" ] ; then
        
        LC_ALL=C sed -i "/^\s*X11UseLocalhost\s\+/Id" "/etc/ssh/sshd_config"
    else
        touch "/etc/ssh/sshd_config"
    fi
    cp "/etc/ssh/sshd_config" "/etc/ssh/sshd_config.bak"
    # Insert before the line matching the regex '^Match'.
    line_number="$(LC_ALL=C grep -n "^Match" "/etc/ssh/sshd_config.bak" | LC_ALL=C sed 's/:.*//g')"
    if [ -z "$line_number" ]; then
        # There was no match of '^Match', insert at
        # the end of the file.
        printf '%s\n' "X11UseLocalhost yes" >> "/etc/ssh/sshd_config"
    else
        head -n "$(( line_number - 1 ))" "/etc/ssh/sshd_config.bak" > "/etc/ssh/sshd_config"
        printf '%s\n' "X11UseLocalhost yes" >> "/etc/ssh/sshd_config"
        tail -n "+$(( line_number ))" "/etc/ssh/sshd_config.bak" >> "/etc/ssh/sshd_config"
    fi
    # Clean up after ourselves.
    rm "/etc/ssh/sshd_config.bak"
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

restrict

    - name: Prevent remote hosts from connecting to the proxy display
      block:
    
        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*X11UseLocalhost\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes
    
        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*X11UseLocalhost\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1
    
        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*X11UseLocalhost\s+
            line: X11UseLocalhost yes
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83404-4
        - DISA-STIG-RHEL-07-040711
        - NIST-800-53-CM-6(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_x11_use_localhost
    

#### Install the OpenSSH Server Package   [\[ref\]](#xccdf_org.ssgproject.content_rule_package_openssh-server_installed)rule

The `openssh-server` package should be installed. The `openssh-server` package can be installed with the following command:

$ sudo yum install openssh-server

Rationale:

Without protection of the transmitted information, confidentiality, and integrity may be compromised because unprotected communications can be intercepted and either read or altered.

Severity:  medium

Identifiers:  CCE-80215-7

References:  [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-002418](https://public.cyber.mil/stigs/cci/), [CCI-002420](https://public.cyber.mil/stigs/cci/), [CCI-002421](https://public.cyber.mil/stigs/cci/), [CCI-002422](https://public.cyber.mil/stigs/cci/), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.DS-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [FIA\_UAU.5](https://www.niap-ccevs.org/Profile/PP.cfm), [FTP\_ITC\_EXT.1](https://www.niap-ccevs.org/Profile/PP.cfm), [SRG-OS-000423-GPOS-00187](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000424-GPOS-00188](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000425-GPOS-00189](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000426-GPOS-00190](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040300](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204585r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    if ! rpm -q --quiet "openssh-server" ; then
        yum install -y "openssh-server"
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    - name: Ensure openssh-server is installed
      package:
        name: openssh-server
        state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80215-7
        - DISA-STIG-RHEL-07-040300
        - NIST-800-53-CM-6(a)
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_openssh-server_installed
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    include install_openssh-server
    
    class install_openssh-server {
      package { 'openssh-server':
        ensure => 'installed',
      }
    }
    

Remediation Anaconda snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    
    package --add=openssh-server
    

Remediation script:   (show)  
  

    
    [[packages]]
    name = "openssh-server"
    version = "*"
    

#### Enable the OpenSSH Service   [\[ref\]](#xccdf_org.ssgproject.content_rule_service_sshd_enabled)rule

The SSH server service, sshd, is commonly needed. The `sshd` service can be enabled with the following command:

$ sudo systemctl enable sshd.service

Rationale:

Without protection of the transmitted information, confidentiality, and integrity may be compromised because unprotected communications can be intercepted and either read or altered.  
  
This checklist item applies to both internal and external networks and all types of information system components from which information can be transmitted (e.g., servers, mobile devices, notebook computers, printers, copiers, scanners, etc). Communication paths outside the physical protection of a controlled boundary are exposed to the possibility of interception and modification.

Severity:  medium

Identifiers:  CCE-80216-5

References:  [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [3.1.13](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.5.4](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.13.8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-002418](https://public.cyber.mil/stigs/cci/), [CCI-002420](https://public.cyber.mil/stigs/cci/), [CCI-002421](https://public.cyber.mil/stigs/cci/), [CCI-002422](https://public.cyber.mil/stigs/cci/), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-8](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-8(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-8(2)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-8(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SC-8(4)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.DS-2](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000423-GPOS-00187](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000423-GPOS-00188](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000423-GPOS-00189](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000423-GPOS-00190](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040310](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204586r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    SYSTEMCTL_EXEC='/usr/bin/systemctl'
    "$SYSTEMCTL_EXEC" unmask 'sshd.service'
    "$SYSTEMCTL_EXEC" start 'sshd.service'
    "$SYSTEMCTL_EXEC" enable 'sshd.service'
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    - name: Enable service sshd
      block:
    
        - name: Gather the package facts
          package_facts:
            manager: auto
    
        - name: Enable service sshd
          service:
            name: sshd
            enabled: 'yes'
            state: started
            masked: 'no'
          when:
            - '"openssh-server" in ansible_facts.packages'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80216-5
        - DISA-STIG-RHEL-07-040310
        - NIST-800-171-3.1.13
        - NIST-800-171-3.13.8
        - NIST-800-171-3.5.4
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-8
        - NIST-800-53-SC-8(1)
        - NIST-800-53-SC-8(2)
        - NIST-800-53-SC-8(3)
        - NIST-800-53-SC-8(4)
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_sshd_enabled
    

Remediation Puppet snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

enable

    include enable_sshd
    
    class enable_sshd {
      service {'sshd':
        enable => true,
        ensure => 'running',
      }
    }
    

#### Verify Permissions on SSH Server Private \*\_key Key Files   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_permissions_sshd_private_key)rule

To properly set the permissions of `/etc/ssh/*_key`, run the command:

$ sudo chmod 0640 /etc/ssh/\*\_key

Rationale:

If an unauthorized user obtains the private SSH host key file, the host could be impersonated.

Severity:  medium

Identifiers:  CCE-27485-2

References:  [BP28(R36)](http://www.ssi.gouv.fr/administration/bonnes-pratiques/), [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.1.13](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.13.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040420](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204597r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    readarray -t files < <(find /etc/ssh/)
    for file in "${files[@]}"; do
        if basename $file | grep -q '^.*_key$'; then
            chmod 0640 $file
        fi    
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: Find /etc/ssh/ file(s)
      find:
        paths: /etc/ssh/
        patterns: ^.*_key$
        use_regex: true
      register: files_found
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27485-2
        - DISA-STIG-RHEL-07-040420
        - NIST-800-171-3.1.13
        - NIST-800-171-3.13.10
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - file_permissions_sshd_private_key
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Set permissions for /etc/ssh/ file(s)
      file:
        path: '{{ item.path }}'
        mode: '0640'
      with_items:
        - '{{ files_found.files }}'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27485-2
        - DISA-STIG-RHEL-07-040420
        - NIST-800-171-3.1.13
        - NIST-800-171-3.13.10
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - file_permissions_sshd_private_key
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    

Remediation Puppet snippet:   (show)  
  

    include ssh_private_key_perms
    
    class ssh_private_key_perms {
      exec { 'sshd_priv_key':
        command => "chmod 0640 /etc/ssh/*_key",
        path    => '/bin:/usr/bin'
      }
    }
    

#### Verify Permissions on SSH Server Public \*.pub Key Files   [\[ref\]](#xccdf_org.ssgproject.content_rule_file_permissions_sshd_pub_key)rule

To properly set the permissions of `/etc/ssh/*.pub`, run the command:

$ sudo chmod 0644 /etc/ssh/\*.pub

Rationale:

If a public host key file is modified by an unauthorized user, the SSH service may be compromised.

Severity:  medium

Identifiers:  CCE-27311-0

References:  [12](https://www.cisecurity.org/controls/), [13](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [18](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [APO01.06](https://www.isaca.org/resources/cobit), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS06.02](https://www.isaca.org/resources/cobit), [3.1.13](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [3.13.10](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-171.pdf), [CCI-000366](https://public.cyber.mil/stigs/cci/), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.10.1.1](https://www.iso.org/standard/54534.html), [A.11.1.4](https://www.iso.org/standard/54534.html), [A.11.1.5](https://www.iso.org/standard/54534.html), [A.11.2.1](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.1.3](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.13.2.3](https://www.iso.org/standard/54534.html), [A.13.2.4](https://www.iso.org/standard/54534.html), [A.14.1.2](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.6.1.2](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.7.1.2](https://www.iso.org/standard/54534.html), [A.7.3.1](https://www.iso.org/standard/54534.html), [A.8.2.2](https://www.iso.org/standard/54534.html), [A.8.2.3](https://www.iso.org/standard/54534.html), [A.9.1.1](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.4.1](https://www.iso.org/standard/54534.html), [A.9.4.4](https://www.iso.org/standard/54534.html), [A.9.4.5](https://www.iso.org/standard/54534.html), [CIP-003-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-003-3 R5.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-004-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R2.3](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.1](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [CIP-007-3 R5.1.2](https://www.nerc.com/pa/Stand/Standard%20Purpose%20Statement%20DL/US_Standard_One-Stop-Shop.xlsx), [AC-17(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [AC-6(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.DS-5](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040410](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204596r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [5.3.3](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    readarray -t files < <(find /etc/ssh/)
    for file in "${files[@]}"; do
        if basename $file | grep -q '^.*.pub$'; then
            chmod 0644 $file
        fi    
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Strategy:

configure

    - name: Find /etc/ssh/ file(s)
      find:
        paths: /etc/ssh/
        patterns: ^.*.pub$
        use_regex: true
      register: files_found
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27311-0
        - DISA-STIG-RHEL-07-040410
        - NIST-800-171-3.1.13
        - NIST-800-171-3.13.10
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - file_permissions_sshd_pub_key
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    
    - name: Set permissions for /etc/ssh/ file(s)
      file:
        path: '{{ item.path }}'
        mode: '0644'
      with_items:
        - '{{ files_found.files }}'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-27311-0
        - DISA-STIG-RHEL-07-040410
        - NIST-800-171-3.1.13
        - NIST-800-171-3.13.10
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-6(1)
        - NIST-800-53-CM-6(a)
        - configure_strategy
        - file_permissions_sshd_pub_key
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
    

Remediation Puppet snippet:   (show)  
  

    include ssh_public_key_perms
    
    class ssh_public_key_perms {
      exec { 'sshd_pub_key':
        command => "chmod 0644 /etc/ssh/*.pub",
        path    => '/bin:/usr/bin'
      }
    }
    

### System Security Services Daemon   [\[ref\]](#xccdf_org.ssgproject.content_group_sssd)group

The System Security Services Daemon (SSSD) is a system daemon that provides access to different identity and authentication providers such as Red Hat's IdM, Microsoft's AD, openLDAP, MIT Kerberos, etc. It uses a common framework that can provide caching and offline support to systems utilizing SSSD. SSSD using caching to reduce load on authentication servers permit offline authentication as well as store extended user data.  
  
For more information, see [https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/7/html/system-level\_authentication\_guide/sssd](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/sssd)

contains 5 rules

### System Security Services Daemon (SSSD) - LDAP   [\[ref\]](#xccdf_org.ssgproject.content_group_sssd-ldap)group

The System Security Services Daemon (SSSD) is a system daemon that provides access to different identity and authentication providers such as Red Hat's IdM, Microsoft's AD, openLDAP, MIT Kerberos, etc. It uses a common framework that can provide caching and offline support to systems utilizing SSSD. SSSD using caching to reduce load on authentication servers permit offline authentication as well as store extended user data.  
  
SSSD can support many backends including LDAP. The `sssd-ldap` backend allows SSSD to fetch identity information from an LDAP server.

contains 4 rules

#### Configure SSSD LDAP Backend Client CA Certificate   [\[ref\]](#xccdf_org.ssgproject.content_rule_sssd_ldap_configure_tls_ca)rule

Configure SSSD to implement cryptography to protect the integrity of LDAP remote access sessions. By setting the

ldap\_tls\_cacert

option in

/etc/sssd/sssd.conf

to point to the path for the X.509 certificates used for peer authentication.

ldap\_tls\_cacert /path/to/tls/ca.cert

Rationale:

Without cryptographic integrity protections, information can be altered by unauthorized users without detection.  
  
Cryptographic mechanisms used for protecting the integrity of information include, for example, signed hash functions using asymmetric cryptography enabling distribution of the public key to verify the hash information while maintaining the confidentiality of the key used to generate the hash.

Severity:  medium

Identifiers:  CCE-80516-8

References:  [CCI-001453](https://public.cyber.mil/stigs/cci/), [SC-12(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000250-GPOS-00093](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040200](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204583r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

#### Configure SSSD LDAP Backend Client CA Certificate Location   [\[ref\]](#xccdf_org.ssgproject.content_rule_sssd_ldap_configure_tls_ca_dir)rule

Configure SSSD to implement cryptography to protect the integrity of LDAP remote access sessions. By setting the

ldap\_tls\_cacertdir

option in

/etc/sssd/sssd.conf

to point to the path for the X.509 certificates used for peer authentication.

ldap\_tls\_cacertdir /path/to/tls/cacert

Rationale:

Without cryptographic integrity protections, information can be altered by unauthorized users without detection.  
  
Cryptographic mechanisms used for protecting the integrity of information include, for example, signed hash functions using asymmetric cryptography enabling distribution of the public key to verify the hash information while maintaining the confidentiality of the key used to generate the hash.

Severity:  medium

Identifiers:  CCE-80515-0

References:  [CCI-001453](https://public.cyber.mil/stigs/cci/), [SC-12(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000250-GPOS-00093](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040200](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204583r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    var_sssd_ldap_tls_ca_dir="/etc/openldap/cacerts"
    
    
    
    SSSD_CONF="/etc/sssd/sssd.conf"
    LDAP_REGEX='[[:space:]]*\[domain\/[^]]*]([^(\n)]*(\n)+)+?[[:space:]]*ldap_tls_cacertdir'
    AD_REGEX='[[:space:]]*\[domain\/[^]]*]([^(\n)]*(\n)+)+?[[:space:]]*id_provider[[:space:]]*=[[:space:]]*((?i)ad)[[:space:]]*$'
    DOMAIN_REGEX="[[:space:]]*\[domain\/[^]]*]"
    
    # Check if id_provider is not set to ad (Active Directory) which makes start_tls not applicable, note the -v option to invert the grep.
    # Try to find [domain/..] and ldap_tls_cacertdir in sssd.conf, if it exists, set to '$var_sssd_ldap_tls_ca_dir'
    # if ldap_tls_cacertdir isn't here, add it
    # if [domain/..] doesn't exist, add it here for default domain
    if grep -qvzosP $AD_REGEX $SSSD_CONF; then
            if grep -qzosP $LDAP_REGEX $SSSD_CONF; then
                    
                    sed -i "s#ldap_tls_cacertdir[^(\n)]*#ldap_tls_cacertdir = $var_sssd_ldap_tls_ca_dir#" $SSSD_CONF
            elif grep -qs $DOMAIN_REGEX $SSSD_CONF; then
                    sed -i "/$DOMAIN_REGEX/a ldap_tls_cacertdir = $var_sssd_ldap_tls_ca_dir" $SSSD_CONF
            else
                    if test -f "$SSSD_CONF"; then
                            echo -e "[domain/default]\nldap_tls_cacertdir = $var_sssd_ldap_tls_ca_dir" >> $SSSD_CONF
                    else
                            echo "Config file '$SSSD_CONF' doesnt exist, not remediating, assuming non-applicability." >&2
                    fi
            fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: XCCDF Value var_sssd_ldap_tls_ca_dir # promote to variable
      set_fact:
        var_sssd_ldap_tls_ca_dir: !!str /etc/openldap/cacerts
      tags:
        - always
    
    - name: Test for id_provider different than Active Directory (ad)
      command: grep -qzosP '[[:space:]]*\[domain\/[^]]*]([^(\n)]*(\n)+)+?[[:space:]]*id_provider[[:space:]]*=[[:space:]]*((?i)ad)[[:space:]]*$'
        /etc/sssd/sssd.conf
      register: test_id_provider
      ignore_errors: true
      changed_when: false
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80515-0
        - DISA-STIG-RHEL-07-040200
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12(3)
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_ldap_configure_tls_ca_dir
        - unknown_strategy
    
    - name: Test for domain group
      command: grep '\s*\[domain\/[^]]*]' /etc/sssd/sssd.conf
      register: test_grep_domain
      ignore_errors: true
      changed_when: false
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80515-0
        - DISA-STIG-RHEL-07-040200
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12(3)
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_ldap_configure_tls_ca_dir
        - unknown_strategy
    
    - name: Add default domain group and set ldap_tls_cacertdir in sssd configuration
        (if no domain there)
      ini_file:
        path: /etc/sssd/sssd.conf
        section: '{{ item.section }}'
        option: '{{ item.option }}'
        value: '{{ item.value }}'
      with_items:
        - section: sssd
          option: domains
          value: default
        - section: domain/default
          option: ldap_tls_cacertdir
          value: '{{ var_sssd_ldap_tls_ca_dir }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - test_grep_domain.stdout is defined
        - test_grep_domain.stdout | length < 1
        - test_id_provider.stdout is defined
        - test_id_provider.stdout | length < 1
      tags:
        - CCE-80515-0
        - DISA-STIG-RHEL-07-040200
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12(3)
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_ldap_configure_tls_ca_dir
        - unknown_strategy
    
    - name: Set ldap_tls_cacertdir in sssd configuration
      ini_file:
        path: /etc/sssd/sssd.conf
        section: '{{ test_grep_domain.stdout | regex_replace(''\[(.*)\]'',''\1'') }}'
        option: ldap_tls_cacertdir
        value: '{{ var_sssd_ldap_tls_ca_dir }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - test_grep_domain.stdout is defined
        - test_grep_domain.stdout | length > 0
        - test_id_provider.stdout is defined
        - test_id_provider.stdout | length < 1
      tags:
        - CCE-80515-0
        - DISA-STIG-RHEL-07-040200
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12(3)
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_ldap_configure_tls_ca_dir
        - unknown_strategy
    

#### Configure SSSD LDAP Backend Client to Demand a Valid Certificate from the Server   [\[ref\]](#xccdf_org.ssgproject.content_rule_sssd_ldap_configure_tls_reqcert)rule

Configure SSSD to demand a valid certificate from the server to protect the integrity of LDAP remote access sessions by setting the

ldap\_tls\_reqcert

option in

/etc/sssd/sssd.conf

to `demand`.

Rationale:

Without a valid certificate presented to the LDAP client backend, the identity of a server can be forged compromising LDAP remote access sessions.

Severity:  medium

Identifiers:  CCE-84061-1

References:  [CCI-001453](https://public.cyber.mil/stigs/cci/), [SC-12(3)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000250-GPOS-00093](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040190](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204582r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    
    SSSD_CONF="/etc/sssd/sssd.conf"
    LDAP_REGEX='[[:space:]]*\[domain\/[^]]*]([^(\n)]*(\n)+)+?[[:space:]]*ldap_tls_reqcert'
    AD_REGEX='[[:space:]]*\[domain\/[^]]*]([^(\n)]*(\n)+)+?[[:space:]]*id_provider[[:space:]]*=[[:space:]]*((?i)ad)[[:space:]]*$'
    DOMAIN_REGEX="[[:space:]]*\[domain\/[^]]*]"
    
    # Check if id_provider is not set to ad (Active Directory) which makes start_tls not applicable, note the -v option to invert the grep.
    # Try to find [domain/..] and ldap_tls_reqcert in sssd.conf, if it exists, set to 'demand'
    # if ldap_tls_reqcert isn't here, add it
    # if [domain/..] doesn't exist, add it here for default domain
    if grep -qvzosP $AD_REGEX $SSSD_CONF; then
            if grep -qzosP $LDAP_REGEX $SSSD_CONF; then
                    
                    sed -i "s#ldap_tls_reqcert[^(\n)]*#ldap_tls_reqcert = demand#" $SSSD_CONF
            elif grep -qs $DOMAIN_REGEX $SSSD_CONF; then
                    sed -i "/$DOMAIN_REGEX/a ldap_tls_reqcert = demand" $SSSD_CONF
            else
                    if test -f "$SSSD_CONF"; then
                            echo -e "[domain/default]\nldap_tls_reqcert = demand" >> $SSSD_CONF
                    else
                            echo "Config file '$SSSD_CONF' doesnt exist, not remediating, assuming non-applicability." >&2
                    fi
            fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Test for id_provider different than Active Directory (ad)
      command: grep -qzosP '[[:space:]]*\[domain\/[^]]*]([^(\n)]*(\n)+)+?[[:space:]]*id_provider[[:space:]]*=[[:space:]]*((?i)ad)[[:space:]]*$'
        /etc/sssd/sssd.conf
      register: test_id_provider
      ignore_errors: true
      changed_when: false
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-84061-1
        - DISA-STIG-RHEL-07-040190
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12(3)
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_ldap_configure_tls_reqcert
        - unknown_strategy
    
    - name: Test for domain group
      command: grep '\s*\[domain\/[^]]*]' /etc/sssd/sssd.conf
      register: test_grep_domain
      ignore_errors: true
      changed_when: false
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-84061-1
        - DISA-STIG-RHEL-07-040190
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12(3)
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_ldap_configure_tls_reqcert
        - unknown_strategy
    
    - name: Add default domain group and set ldap_tls_reqcert in sssd configuration (if
        no domain there)
      ini_file:
        path: /etc/sssd/sssd.conf
        section: '{{ item.section }}'
        option: '{{ item.option }}'
        value: '{{ item.value }}'
      with_items:
        - section: sssd
          option: domains
          value: default
        - section: domain/default
          option: ldap_tls_reqcert
          value: demand
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - test_grep_domain.stdout is defined
        - test_grep_domain.stdout | length < 1
        - test_id_provider.stdout is defined
        - test_id_provider.stdout | length < 1
      tags:
        - CCE-84061-1
        - DISA-STIG-RHEL-07-040190
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12(3)
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_ldap_configure_tls_reqcert
        - unknown_strategy
    
    - name: Set ldap_tls_reqcert in sssd configuration
      ini_file:
        path: /etc/sssd/sssd.conf
        section: '{{ test_grep_domain.stdout | regex_replace(''\[(.*)\]'',''\1'') }}'
        option: ldap_tls_reqcert
        value: demand
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - test_grep_domain.stdout is defined
        - test_grep_domain.stdout | length > 0
        - test_id_provider.stdout is defined
        - test_id_provider.stdout | length < 1
      tags:
        - CCE-84061-1
        - DISA-STIG-RHEL-07-040190
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12(3)
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_ldap_configure_tls_reqcert
        - unknown_strategy
    

#### Configure SSSD LDAP Backend to Use TLS For All Transactions   [\[ref\]](#xccdf_org.ssgproject.content_rule_sssd_ldap_start_tls)rule

The LDAP client should be configured to implement TLS for the integrity of all remote LDAP authentication sessions. If the `id_provider` is set to `ldap` or `ipa` in `/etc/sssd/sssd.conf` or any of the `/etc/sssd/sssd.conf.d` configuration files, `ldap_id_use_start_tls` must be set to `true`.  
  
To check if LDAP is configured to use TLS when `id_provider` is set to `ldap` or `ipa`, use the following command:

$ sudo grep -i ldap\_id\_use\_start\_tls /etc/sssd/sssd.conf

Rationale:

Without cryptographic integrity protections, information can be altered by unauthorized users without detection. The ssl directive specifies whether to use TLS or not. If not specified it will default to no. It should be set to start\_tls rather than doing LDAP over SSL.

Severity:  high

Identifiers:  CCE-80546-5

References:  [11](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [14](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [3](https://www.cisecurity.org/controls/), [8](https://www.cisecurity.org/controls/), [9](https://www.cisecurity.org/controls/), [APO13.01](https://www.isaca.org/resources/cobit), [BAI10.01](https://www.isaca.org/resources/cobit), [BAI10.02](https://www.isaca.org/resources/cobit), [BAI10.03](https://www.isaca.org/resources/cobit), [BAI10.05](https://www.isaca.org/resources/cobit), [DSS01.04](https://www.isaca.org/resources/cobit), [DSS05.02](https://www.isaca.org/resources/cobit), [DSS05.03](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS06.06](https://www.isaca.org/resources/cobit), [CCI-001453](https://public.cyber.mil/stigs/cci/), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.4.3.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.11](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.12](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.13](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 3.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 4.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 5.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 7.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.11.2.6](https://www.iso.org/standard/54534.html), [A.12.1.2](https://www.iso.org/standard/54534.html), [A.12.5.1](https://www.iso.org/standard/54534.html), [A.12.6.2](https://www.iso.org/standard/54534.html), [A.13.1.1](https://www.iso.org/standard/54534.html), [A.13.2.1](https://www.iso.org/standard/54534.html), [A.14.1.3](https://www.iso.org/standard/54534.html), [A.14.2.2](https://www.iso.org/standard/54534.html), [A.14.2.3](https://www.iso.org/standard/54534.html), [A.14.2.4](https://www.iso.org/standard/54534.html), [A.6.2.1](https://www.iso.org/standard/54534.html), [A.6.2.2](https://www.iso.org/standard/54534.html), [A.9.1.2](https://www.iso.org/standard/54534.html), [CM-7(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-7(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.IP-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-3](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.PT-4](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000250-GPOS-00093](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040180](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204581r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if [ ! -f /.dockerenv ] && [ ! -f /run/.containerenv ]; then
    
    
    
    SSSD_CONF="/etc/sssd/sssd.conf"
    LDAP_REGEX='[[:space:]]*\[domain\/[^]]*]([^(\n)]*(\n)+)+?[[:space:]]*ldap_id_use_start_tls'
    AD_REGEX='[[:space:]]*\[domain\/[^]]*]([^(\n)]*(\n)+)+?[[:space:]]*id_provider[[:space:]]*=[[:space:]]*((?i)ad)[[:space:]]*$'
    DOMAIN_REGEX="[[:space:]]*\[domain\/[^]]*]"
    
    # Check if id_provider is not set to ad (Active Directory) which makes start_tls not applicable, note the -v option to invert the grep.
    # Try to find [domain/..] and ldap_id_use_start_tls in sssd.conf, if it exists, set to 'true'
    # if ldap_id_use_start_tls isn't here, add it
    # if [domain/..] doesn't exist, add it here for default domain
    if grep -qvzosP $AD_REGEX $SSSD_CONF; then
            if grep -qzosP $LDAP_REGEX $SSSD_CONF; then
                    
                    sed -i "s#ldap_id_use_start_tls[^(\n)]*#ldap_id_use_start_tls = true#" $SSSD_CONF
            elif grep -qs $DOMAIN_REGEX $SSSD_CONF; then
                    sed -i "/$DOMAIN_REGEX/a ldap_id_use_start_tls = true" $SSSD_CONF
            else
                    if test -f "$SSSD_CONF"; then
                            echo -e "[domain/default]\nldap_id_use_start_tls = true" >> $SSSD_CONF
                    else
                            echo "Config file '$SSSD_CONF' doesnt exist, not remediating, assuming non-applicability." >&2
                    fi
            fi
    fi
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

medium

    - name: Test for id_provider different than Active Directory (ad)
      command: grep -qzosP '[[:space:]]*\[domain\/[^]]*]([^(\n)]*(\n)+)+?[[:space:]]*id_provider[[:space:]]*=[[:space:]]*((?i)ad)[[:space:]]*$'
        /etc/sssd/sssd.conf
      register: test_id_provider
      ignore_errors: true
      changed_when: false
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80546-5
        - DISA-STIG-RHEL-07-040180
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - sssd_ldap_start_tls
        - unknown_strategy
    
    - name: Test for domain group
      command: grep '\s*\[domain\/[^]]*]' /etc/sssd/sssd.conf
      register: test_grep_domain
      ignore_errors: true
      changed_when: false
      check_mode: false
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80546-5
        - DISA-STIG-RHEL-07-040180
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - sssd_ldap_start_tls
        - unknown_strategy
    
    - name: Add default domain group and set ldap_id_use_start_tls in sssd configuration
        (if no domain there)
      ini_file:
        path: /etc/sssd/sssd.conf
        section: '{{ item.section }}'
        option: '{{ item.option }}'
        value: '{{ item.value }}'
      with_items:
        - section: sssd
          option: domains
          value: default
        - section: domain/default
          option: ldap_id_use_start_tls
          value: 'true'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - test_grep_domain.stdout is defined
        - test_grep_domain.stdout | length < 1
        - test_id_provider.stdout is defined
        - test_id_provider.stdout | length < 1
      tags:
        - CCE-80546-5
        - DISA-STIG-RHEL-07-040180
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - sssd_ldap_start_tls
        - unknown_strategy
    
    - name: Set ldap_id_use_start_tls in sssd configuration
      ini_file:
        path: /etc/sssd/sssd.conf
        section: '{{ test_grep_domain.stdout | regex_replace(''\[(.*)\]'',''\1'') }}'
        option: ldap_id_use_start_tls
        value: 'true'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - test_grep_domain.stdout is defined
        - test_grep_domain.stdout | length > 0
        - test_id_provider.stdout is defined
        - test_id_provider.stdout | length < 1
      tags:
        - CCE-80546-5
        - DISA-STIG-RHEL-07-040180
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - sssd_ldap_start_tls
        - unknown_strategy
    

#### Configure PAM in SSSD Services   [\[ref\]](#xccdf_org.ssgproject.content_rule_sssd_enable_pam_services)rule

SSSD should be configured to run SSSD `pam` services. To configure SSSD to known SSH hosts, add `pam` to `services` under the `[sssd]` section in `/etc/sssd/sssd.conf`. For example:

\[sssd\]
services = sudo, autofs, pam

Rationale:

Using an authentication device, such as a CAC or token that is separate from the information system, ensures that even if the information system is compromised, that compromise will not affect credentials stored on the authentication device.

Severity:  medium

Identifiers:  CCE-80437-7

References:  [1](https://www.cisecurity.org/controls/), [12](https://www.cisecurity.org/controls/), [15](https://www.cisecurity.org/controls/), [16](https://www.cisecurity.org/controls/), [5](https://www.cisecurity.org/controls/), [DSS05.04](https://www.isaca.org/resources/cobit), [DSS05.05](https://www.isaca.org/resources/cobit), [DSS05.07](https://www.isaca.org/resources/cobit), [DSS05.10](https://www.isaca.org/resources/cobit), [DSS06.03](https://www.isaca.org/resources/cobit), [DSS06.10](https://www.isaca.org/resources/cobit), [CCI-001948](https://public.cyber.mil/stigs/cci/), [CCI-001953](https://public.cyber.mil/stigs/cci/), [CCI-001954](https://public.cyber.mil/stigs/cci/), [4.3.3.2.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.5.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.6](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.6.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [4.3.3.7.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116731), [SR 1.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.10](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.2](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.3](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.4](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.5](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.7](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.8](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 1.9](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [SR 2.1](https://www.isa.org/templates/one-column.aspx?pageid=111294&productId=116785), [A.18.1.4](https://www.iso.org/standard/54534.html), [A.7.1.1](https://www.iso.org/standard/54534.html), [A.9.2.1](https://www.iso.org/standard/54534.html), [A.9.2.2](https://www.iso.org/standard/54534.html), [A.9.2.3](https://www.iso.org/standard/54534.html), [A.9.2.4](https://www.iso.org/standard/54534.html), [A.9.2.6](https://www.iso.org/standard/54534.html), [A.9.3.1](https://www.iso.org/standard/54534.html), [A.9.4.2](https://www.iso.org/standard/54534.html), [A.9.4.3](https://www.iso.org/standard/54534.html), [IA-2(1)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [CM-6(a)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [PR.AC-1](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-6](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [PR.AC-7](https://nvlpubs.nist.gov/nistpubs/CSWP/NIST.CSWP.04162018.pdf), [SRG-OS-000375-GPOS-00160](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000376-GPOS-00161](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [SRG-OS-000377-GPOS-00162](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), SRG-OS-000107-VMM-000530, [RHEL-07-041002](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204632r603261\_rule](https://public.cyber.mil/stigs/srg-stig-tools/)

Remediation Shell script:   (show)  
  

    # Remediation is applicable only in certain platforms
    if rpm --quiet -q sssd-common; then
    
    
    
    SSSD_CONF="/etc/sssd/sssd.conf"
    SSSD_CONF_DIR="/etc/sssd/conf.d/*.conf"
    
    for f in $SSSD_CONF $SSSD_CONF_DIR; do
    	if [ ! -e "$f" ]; then
    		continue
    	fi
    	# finds all services entries under [sssd] configuration category, get a unique list so it doesn't add redundant fix
    	services_list=$( awk '/^\s*\[/{f=0} /^\s*\[sssd\]/{f=1}f' $f | grep -P '^services[ \t]*=' | uniq )
    
    	while IFS= read -r services; do
    		if [[ ! $services =~ "pam" ]]; then
    			sed -i "s/$services$/&, pam/" $f
    		fi
    	done <<< "$services_list"
    done
    
    else
        >&2 echo 'Remediation is not applicable, nothing was done'
    fi
    

### X Window System   [\[ref\]](#xccdf_org.ssgproject.content_group_xwindows)group

The X Window System implementation included with the system is called X.org.

contains 1 rule

### Disable X Windows   [\[ref\]](#xccdf_org.ssgproject.content_group_disabling_xwindows)group

Unless there is a mission-critical reason for the system to run a graphical user interface, ensure X is not set to start automatically at boot and remove the X Windows software packages. There is usually no reason to run X Windows on a dedicated server system, as it increases the system's attack surface and consumes system resources. Administrators of server systems should instead login via SSH or on the text console.

contains 1 rule

#### Disable graphical user interface   [\[ref\]](#xccdf_org.ssgproject.content_rule_xwindows_remove_packages)rule

By removing the following packages, the system no longer has X Windows installed. `xorg-x11-server-Xorg xorg-x11-server-common xorg-x11-server-utils` If X Windows is not installed then the system cannot boot into graphical user mode. This prevents the system from being accidentally or maliciously booted into a `graphical.target` mode. To do so, run the following command:

sudo yum remove xorg-x11-server-Xorg xorg-x11-server-common xorg-x11-server-utils

Additionally, setting the system's default target to `multi-user.target` will prevent automatic startup of the X server. To do so, run:

$ systemctl set-default multi-user.target

You should see the following output:

Removed symlink /etc/systemd/system/default.target.
Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/multi-user.target.

Warning:  The installation and use of a Graphical User Interface (GUI) increases your attack vector and decreases your overall security posture. Removing the package xorg-x11-server-common package will remove the graphical target which might bring your system to an inconsistent state requiring additional configuration to access the system again. If a GUI is an operational requirement, a tailored profile that removes this rule should used before continuing installation.

Rationale:

Unnecessary service packages must not be installed to decrease the attack surface of the system. X windows has a long history of security vulnerabilities and should not be installed unless approved and documented.

Severity:  medium

Identifiers:  CCE-83410-1

References:  [CCI-000366](https://public.cyber.mil/stigs/cci/), [CM-6(b)](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), [SRG-OS-000480-GPOS-00227](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cgeneral-purpose-os), [RHEL-07-040730](https://public.cyber.mil/stigs/downloads/?_dl_facet_stigs=operating-systems%2Cunix-linux), [SV-204624r646847\_rule](https://public.cyber.mil/stigs/srg-stig-tools/), [2.2.2](https://www.cisecurity.org/benchmark/red_hat_linux/)

Remediation Shell script:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    
    
    # remove packages
    if rpm -q --quiet "xorg-x11-server-Xorg" ; then
        yum remove -y "xorg-x11-server-Xorg"
    fi
    if rpm -q --quiet "xorg-x11-server-utils" ; then
        yum remove -y "xorg-x11-server-utils"
    fi
    if rpm -q --quiet "xorg-x11-server-common" ; then
        yum remove -y "xorg-x11-server-common"
    fi
    
    
    # configure run level
    systemctl set-default multi-user.target
    

Remediation Ansible snippet:   (show)  
  

Complexity:

low

Disruption:

low

Reboot:

true

Strategy:

restrict

    - name: Ensure xorg packages are removed
      package:
        name:
          - xorg-x11-server-Xorg
          - xorg-x11-server-common
          - xorg-x11-server-utils
        state: absent
      tags:
        - CCE-83410-1
        - DISA-STIG-RHEL-07-040730
        - NIST-800-53-CM-6(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
        - xwindows_remove_packages
    
    - name: Switch to multi-user runlevel
      file:
        src: /usr/lib/systemd/system/multi-user.target
        dest: /etc/systemd/system/default.target
        state: link
        force: true
      tags:
        - CCE-83410-1
        - DISA-STIG-RHEL-07-040730
        - NIST-800-53-CM-6(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - reboot_required
        - restrict_strategy
        - xwindows_remove_packages
    

Remediation Anaconda snippet:   (show)  
  

    
    package --remove=xorg-x11-server-Xorg --remove=xorg-x11-server-common --remove=xorg-x11-server-utils 
    

Red Hat and Red Hat Enterprise Linux are either registered trademarks or trademarks of Red Hat, Inc. in the United States and other countries. All other names are registered trademarks or trademarks of their respective companies.

Generated using [OpenSCAP](http://open-scap.org) 1.2.16